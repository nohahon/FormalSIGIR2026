,stacks tag,code,Len,Den,P205,P1648,name,reference,type,depth,parents,content,statement,proof,formal_proof,formal_statement,augmented_proof
0,09GK,"theorem cardinalMk_le_max : #L â‰¤ max #R â„µâ‚€ := by
  simpa only [lift_id] using lift_cardinalMk_le_max R L
",Formal Proof of Stacks Project Tag 09GK,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Algebraic/Cardinality.lean#L71-L72,Q27041,,9.8.9,lemma,3.0,"['09GB', '09FA', '0ELQ']","\n  Lemma 9.8.9. Let $E/F$ be an algebraic extension of fields. Then the cardinality $|E|$ of $E$ is at most $\\max (\\aleph _0, |F|)$. \n\n    \n      Proof.\n      Let $S$ be the set of nonconstant polynomials with coefficients in $F$. For every $P \\in S$ the set of roots $r(P, E) = \\{ \\alpha \\in E \\mid P(\\alpha ) = 0\\} $ is finite (details omitted). Moreover, the fact that $E$ is algebraic over $F$ implies that $E = \\bigcup _{P \\in S} r(P, E)$. It is clear that $S$ has cardinality bounded by $\\max (\\aleph _0, |F|)$ because it is a countable union of finite products of copies of $F$. Thus so does $E$. \n      $\\square$\n    \n","\n  Lemma 9.8.9. Let $E/F$ be an algebraic extension of fields. Then the cardinality $|E|$ of $E$ is at most $\\max (\\aleph _0, |F|)$. \n\n    \n","Proof.\n      Let $S$ be the set of nonconstant polynomials with coefficients in $F$. For every $P \\in S$ the set of roots $r(P, E) = \\{ \\alpha \\in E \\mid P(\\alpha ) = 0\\} $ is finite (details omitted). Moreover, the fact that $E$ is algebraic over $F$ implies that $E = \\bigcup _{P \\in S} r(P, E)$. It is clear that $S$ has cardinality bounded by $\\max (\\aleph _0, |F|)$ because it is a countable union of finite products of copies of $F$. Thus so does $E$. \n      $\\square$\n    \n"," by
  simpa only [lift_id] using lift_cardinalMk_le_max R L
",theorem cardinalMk_le_max : #L â‰¤ max #R â„µâ‚€ ,"Proof.\n      Let $S$ be the set of nonconstant polynomials with coefficients in $F$. For every $P \\in S$ the set of roots $r(P, E) = \\{ \\alpha \\in E \\mid P(\\alpha ) = 0\\} $ is finite (details omitted). Moreover, the fact that $E$ is algebraic over $F$ implies that $E = \\bigcup _{P \\in S} r(P, E)$. It is clear that $S$ has cardinality bounded by $\\max (\\aleph _0, |F|)$ because it is a countable union of finite products of copies of $F$. Thus so does $E$. \n      $\\square$\n    \n"
1,09FS,"instance charP (n : â„•) [NeZero n] : CharP (Fin n) n where cast_eq_zero_iff _ := natCast_eq_zero
",Formal Proof of Stacks Project Tag 09FS,First part. We don't require `p` to be a prime in mathlib.,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/Algebra/CharP/Basic.lean#L197-L197,Q27041,,9.5.2,example,3.0,"['09FQ', '09FA', '0ELQ']","\n  Example 9.5.2. The characteristic of $\\mathbf{F}_ p$ is $p$, and that of $\\mathbf{Q}$ is $0$. \n","\n  Example 9.5.2. The characteristic of $\\mathbf{F}_ p$ is $p$, and that of $\\mathbf{Q}$ is $0$. \n",," natCast_eq_zero
",instance charP (n : â„•) [NeZero n] : CharP (Fin n) n where cast_eq_zero_iff _ ,
2,09FD,"class Field (K : Type u) extends CommRing K, DivisionRing K
",Formal Proof of Stacks Project Tag 09FD,first part,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/Algebra/Field/Defs.lean#L180-L180,Q27041,,9.2.1,definition,3.0,"['09FC', '09FA', '0ELQ']",\n  Definition 9.2.1. A field is a nonzero ring where every nonzero element is invertible. Given a field a subfield is a subring that is itself a field. \n,\n  Definition 9.2.1. A field is a nonzero ring where every nonzero element is invertible. Given a field a subfield is a subring that is itself a field. \n,,,"class Field (K : Type u) extends CommRing K, DivisionRing K
",
3,09FD,"structure Subfield (K : Type u) [DivisionRing K] extends Subring K where
  /-- A subfield is closed under multiplicative inverses. -/
  inv_mem' : âˆ€ x âˆˆ carrier, xâ»Â¹ âˆˆ carrier
",Formal Proof of Stacks Project Tag 09FD,second part,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/Algebra/Field/Subfield/Defs.lean#L134-L136,Q27041,,9.2.1,definition,3.0,"['09FC', '09FA', '0ELQ']",\n  Definition 9.2.1. A field is a nonzero ring where every nonzero element is invertible. Given a field a subfield is a subring that is itself a field. \n,\n  Definition 9.2.1. A field is a nonzero ring where every nonzero element is invertible. Given a field a subfield is a subring that is itself a field. \n,,,"structure Subfield (K : Type u) [DivisionRing K] extends Subring K where
  /-- A subfield is closed under multiplicative inverses. -/
  inv_mem' : âˆ€ x âˆˆ carrier, xâ»Â¹ âˆˆ carrier
",
4,09FE,"class IsDomain (Î± : Type u) [Semiring Î±] : Prop extends IsCancelMulZero Î±, Nontrivial Î±
",Formal Proof of Stacks Project Tag 09FE,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/Algebra/Ring/Defs.lean#L427,Q27041,,9.2.2,definition,3.0,"['09FC', '09FA', '0ELQ']",\n  Definition 9.2.2. A domain or an integral domain is a nonzero ring where $0$ is the only zerodivisor. \n,\n  Definition 9.2.2. A domain or an integral domain is a nonzero ring where $0$ is the only zerodivisor. \n,,,"class IsDomain (Î± : Type u) [Semiring Î±] : Prop extends IsCancelMulZero Î±, Nontrivial Î±
",
5,09FS,"instance instCharZero : CharZero â„š where cast_injective a b hab := by simpa using congr_arg num hab
",Formal Proof of Stacks Project Tag 09FS,Second part.,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/Algebra/Ring/Rat.lean#L57-L57,Q27041,,9.5.2,example,3.0,"['09FQ', '09FA', '0ELQ']","\n  Example 9.5.2. The characteristic of $\\mathbf{F}_ p$ is $p$, and that of $\\mathbf{Q}$ is $0$. \n","\n  Example 9.5.2. The characteristic of $\\mathbf{F}_ p$ is $p$, and that of $\\mathbf{Q}$ is $0$. \n",," by simpa using congr_arg num hab
",instance instCharZero : CharZero â„š where cast_injective a b hab ,
6,01Z2,"lemma Scheme.nonempty_of_isLimit [IsCofilteredOrEmpty I]
    [âˆ€ {i j} (f : i âŸ¶ j), IsAffineHom (D.map f)] [âˆ€ i, Nonempty (D.obj i)]
    [âˆ€ i, CompactSpace (D.obj i)] :
    Nonempty c.pt := by
  classical
  cases isEmpty_or_nonempty I
  Â· have e := (isLimitEquivIsTerminalOfIsEmpty _ _ hc).uniqueUpToIso specULiftZIsTerminal
    exact Nonempty.map e.inv inferInstance
  Â· have i := Nonempty.some â€¹Nonempty Iâ€º
    have : IsCofiltered I := âŸ¨âŸ©
    let ð’° := (D.obj i).affineCover.finiteSubcover
    have (i' : _) : IsAffine (ð’°.X i') := inferInstanceAs (IsAffine (Spec _))
    obtain âŸ¨j, HâŸ© :
        âˆƒ j : ð’°.Iâ‚€, âˆ€ {i'} (f : i' âŸ¶ i), Nonempty ((ð’°.pullbackâ‚ (D.map f)).X j) := by
      by_contra! H
      choose i' f hf using H
      let g (j) := IsCofiltered.infTo (insert i (Finset.univ.image i'))
        (Finset.univ.image fun j : ð’°.Iâ‚€ â†¦ âŸ¨_, _, by simp, by simp, f jâŸ©) (X := j)
      have (j : ð’°.Iâ‚€) : IsEmpty ((ð’°.pullbackâ‚ (D.map (g i (by simp)))).X j) := by
        let F : (ð’°.pullbackâ‚ (D.map (g i (by simp)))).X j âŸ¶
            (ð’°.pullbackâ‚ (D.map (f j))).X j :=
          pullback.map _ _ _ _ (D.map (g _ (by simp))) (ðŸ™ _) (ðŸ™ _) (by
            rw [â† D.map_comp, IsCofiltered.infTo_commutes]
            Â· simp [g]
            Â· simp
            Â· exact Finset.mem_image_of_mem _ (Finset.mem_univ _)) (by simp)
        exact Function.isEmpty F
      obtain âŸ¨x, -âŸ© :=
        Cover.covers (ð’°.pullbackâ‚ (D.map (g i (by simp)))) (Nonempty.some inferInstance)
      exact (this _).elim x
    let F := Over.post D â‹™ Over.pullback (ð’°.f j) â‹™ Over.forget _
    have (i' : _) : IsAffine (F.obj i') :=
      have : IsAffineHom (pullback.snd (D.map i'.hom) (ð’°.f j)) :=
        MorphismProperty.pullback_snd _ _ inferInstance
      isAffine_of_isAffineHom (pullback.snd (D.map i'.hom) (ð’°.f j))
    have (i' : _) : Nonempty (F.obj i') := H i'.hom
    let e : F âŸ¶ (F â‹™ Scheme.Î“.rightOp) â‹™ Scheme.Spec := Functor.whiskerLeft F Î“Spec.adjunction.unit
    have (i : _) : IsIso (e.app i) := IsAffine.affine
    have : IsIso e := NatIso.isIso_of_isIso_app e
    let c' : LimitCone F := âŸ¨_, (IsLimit.postcomposeInvEquiv (asIso e) _).symm
      (isLimitOfPreserves Scheme.Spec (limit.isLimit (F â‹™ Scheme.Î“.rightOp)))âŸ©
    have : Nonempty c'.1.pt := by
      apply (config := { allowSynthFailures := true }) PrimeSpectrum.instNonemptyOfNontrivial
      have (i' : _) : Nontrivial ((F â‹™ Scheme.Î“.rightOp).leftOp.obj i') := by
        apply (config := { allowSynthFailures := true }) Scheme.component_nontrivial
        simp
      exact CommRingCat.FilteredColimits.nontrivial
        (isColimitCoconeLeftOpOfCone _ (limit.isLimit (F â‹™ Scheme.Î“.rightOp)))
    let Î± : F âŸ¶ Over.forget _ â‹™ D := Functor.whiskerRight
      (Functor.whiskerLeft (Over.post D) (Over.mapPullbackAdj (ð’°.f j)).counit) (Over.forget _)
    exact this.map (((Functor.Initial.isLimitWhiskerEquiv (Over.forget i) c).symm hc).lift
        ((Cones.postcompose Î±).obj c'.1))
",Formal Proof of Stacks Project Tag 01Z2,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/AffineTransitionLimit.lean#L45-L96,Q27041,,32.4.3,lemma,3.0,"['081A', '01YT', '0ELP']","\n  Lemma 32.4.3. Let $S = \\mathop{\\mathrm{lim}}\\nolimits S_ i$ be the limit of a directed inverse system of schemes with affine transition morphisms (Lemma 32.2.2). If all the schemes $S_ i$ are nonempty and quasi-compact, then the limit $S = \\mathop{\\mathrm{lim}}\\nolimits _ i S_ i$ is nonempty. \n\n    \n      Proof.\n      Choose $0 \\in I$. Note that $I$ is nonempty as the limit is directed. Choose an affine open covering $S_0 = \\bigcup _{j = 1, \\ldots , m} U_ j$. Since $I$ is directed there exists a $j \\in \\{ 1, \\ldots , m\\} $ such that $f_{i0}^{-1}(U_ j) \\not= \\emptyset $ for all $i \\geq 0$. Hence $\\mathop{\\mathrm{lim}}\\nolimits _{i \\geq 0} f_{i0}^{-1}(U_ j)$ is not empty since a directed colimit of nonzero rings is nonzero (because $1 \\not= 0$). As $\\mathop{\\mathrm{lim}}\\nolimits _{i \\geq 0} f_{i0}^{-1}(U_ j)$ is an open subscheme of the limit we win. \n      $\\square$\n    \n","\n  Lemma 32.4.3. Let $S = \\mathop{\\mathrm{lim}}\\nolimits S_ i$ be the limit of a directed inverse system of schemes with affine transition morphisms (Lemma 32.2.2). If all the schemes $S_ i$ are nonempty and quasi-compact, then the limit $S = \\mathop{\\mathrm{lim}}\\nolimits _ i S_ i$ is nonempty. \n\n    \n","Proof.\n      Choose $0 \\in I$. Note that $I$ is nonempty as the limit is directed. Choose an affine open covering $S_0 = \\bigcup _{j = 1, \\ldots , m} U_ j$. Since $I$ is directed there exists a $j \\in \\{ 1, \\ldots , m\\} $ such that $f_{i0}^{-1}(U_ j) \\not= \\emptyset $ for all $i \\geq 0$. Hence $\\mathop{\\mathrm{lim}}\\nolimits _{i \\geq 0} f_{i0}^{-1}(U_ j)$ is not empty since a directed colimit of nonzero rings is nonzero (because $1 \\not= 0$). As $\\mathop{\\mathrm{lim}}\\nolimits _{i \\geq 0} f_{i0}^{-1}(U_ j)$ is an open subscheme of the limit we win. \n      $\\square$\n    \n"," by
  classical
  cases isEmpty_or_nonempty I
  Â· have e := (isLimitEquivIsTerminalOfIsEmpty _ _ hc).uniqueUpToIso specULiftZIsTerminal
    exact Nonempty.map e.inv inferInstance
  Â· have i := Nonempty.some â€¹Nonempty Iâ€º
    have : IsCofiltered I := âŸ¨âŸ©
    let ð’° := (D.obj i).affineCover.finiteSubcover
    have (i' : _) : IsAffine (ð’°.X i') := inferInstanceAs (IsAffine (Spec _))
    obtain âŸ¨j, HâŸ© :
        âˆƒ j : ð’°.Iâ‚€, âˆ€ {i'} (f : i' âŸ¶ i), Nonempty ((ð’°.pullbackâ‚ (D.map f)).X j) := by
      by_contra! H
      choose i' f hf using H
      let g (j) := IsCofiltered.infTo (insert i (Finset.univ.image i'))
        (Finset.univ.image fun j : ð’°.Iâ‚€ â†¦ âŸ¨_, _, by simp, by simp, f jâŸ©) (X := j)
      have (j : ð’°.Iâ‚€) : IsEmpty ((ð’°.pullbackâ‚ (D.map (g i (by simp)))).X j) := by
        let F : (ð’°.pullbackâ‚ (D.map (g i (by simp)))).X j âŸ¶
            (ð’°.pullbackâ‚ (D.map (f j))).X j :=
          pullback.map _ _ _ _ (D.map (g _ (by simp))) (ðŸ™ _) (ðŸ™ _) (by
            rw [â† D.map_comp, IsCofiltered.infTo_commutes]
            Â· simp [g]
            Â· simp
            Â· exact Finset.mem_image_of_mem _ (Finset.mem_univ _)) (by simp)
        exact Function.isEmpty F
      obtain âŸ¨x, -âŸ© :=
        Cover.covers (ð’°.pullbackâ‚ (D.map (g i (by simp)))) (Nonempty.some inferInstance)
      exact (this _).elim x
    let F := Over.post D â‹™ Over.pullback (ð’°.f j) â‹™ Over.forget _
    have (i' : _) : IsAffine (F.obj i') :=
      have : IsAffineHom (pullback.snd (D.map i'.hom) (ð’°.f j)) :=
        MorphismProperty.pullback_snd _ _ inferInstance
      isAffine_of_isAffineHom (pullback.snd (D.map i'.hom) (ð’°.f j))
    have (i' : _) : Nonempty (F.obj i') := H i'.hom
    let e : F âŸ¶ (F â‹™ Scheme.Î“.rightOp) â‹™ Scheme.Spec := Functor.whiskerLeft F Î“Spec.adjunction.unit
    have (i : _) : IsIso (e.app i) := IsAffine.affine
    have : IsIso e := NatIso.isIso_of_isIso_app e
    let c' : LimitCone F := âŸ¨_, (IsLimit.postcomposeInvEquiv (asIso e) _).symm
      (isLimitOfPreserves Scheme.Spec (limit.isLimit (F â‹™ Scheme.Î“.rightOp)))âŸ©
    have : Nonempty c'.1.pt := by
      apply (config := { allowSynthFailures := true }) PrimeSpectrum.instNonemptyOfNontrivial
      have (i' : _) : Nontrivial ((F â‹™ Scheme.Î“.rightOp).leftOp.obj i') := by
        apply (config := { allowSynthFailures := true }) Scheme.component_nontrivial
        simp
      exact CommRingCat.FilteredColimits.nontrivial
        (isColimitCoconeLeftOpOfCone _ (limit.isLimit (F â‹™ Scheme.Î“.rightOp)))
    let Î± : F âŸ¶ Over.forget _ â‹™ D := Functor.whiskerRight
      (Functor.whiskerLeft (Over.post D) (Over.mapPullbackAdj (ð’°.f j)).counit) (Over.forget _)
    exact this.map (((Functor.Initial.isLimitWhiskerEquiv (Over.forget i) c).symm hc).lift
        ((Cones.postcompose Î±).obj c'.1))
","lemma Scheme.nonempty_of_isLimit [IsCofilteredOrEmpty I]
    [âˆ€ {i j} (f : i âŸ¶ j), IsAffineHom (D.map f)] [âˆ€ i, Nonempty (D.obj i)]
    [âˆ€ i, CompactSpace (D.obj i)] :
    Nonempty c.pt ","Proof.\n      Choose $0 \\in I$. Note that $I$ is nonempty as the limit is directed. Choose an affine open covering $S_0 = \\bigcup _{j = 1, \\ldots , m} U_ j$. Since $I$ is directed there exists a $j \\in \\{ 1, \\ldots , m\\} $ such that $f_{i0}^{-1}(U_ j) \\not= \\emptyset $ for all $i \\geq 0$. Hence $\\mathop{\\mathrm{lim}}\\nolimits _{i \\geq 0} f_{i0}^{-1}(U_ j)$ is not empty since a directed colimit of nonzero rings is nonzero (because $1 \\not= 0$). As $\\mathop{\\mathrm{lim}}\\nolimits _{i \\geq 0} f_{i0}^{-1}(U_ j)$ is an open subscheme of the limit we win. \n      $\\square$\n    \n"
7,01Z3,"lemma exists_mem_of_isClosed_of_nonempty'
    [IsCofilteredOrEmpty I]
    [âˆ€ {i j} (f : i âŸ¶ j), IsAffineHom (D.map f)]
    {j : I}
    (Z : âˆ€ (i : I), (i âŸ¶ j) â†’ Set (D.obj i))
    (hZc : âˆ€ i hij, IsClosed (Z i hij))
    (hZne : âˆ€ i hij, (Z i hij).Nonempty)
    (hZcpt : âˆ€ i hij, IsCompact (Z i hij))
    (hstab : âˆ€ (i i' : I) (hi'i : i' âŸ¶ i) (hij : i âŸ¶ j),
      Set.MapsTo (D.map hi'i) (Z i' (hi'i â‰« hij)) (Z i hij)) :
    âˆƒ (s : c.pt), âˆ€ i hij, c.Ï€.app i s âˆˆ Z i hij := by
  have {iâ‚ iâ‚‚ : Over j} (f : iâ‚ âŸ¶ iâ‚‚) : IsAffineHom ((Over.forget j â‹™ D).map f) := by
    dsimp; infer_instance
  simpa [Over.forall_iff] using exists_mem_of_isClosed_of_nonempty (Over.forget j â‹™ D) _
    ((Functor.Initial.isLimitWhiskerEquiv (Over.forget j) c).symm hc)
    (fun i â†¦ Z i.left i.hom) (fun _ â†¦ hZc _ _) (fun _ â†¦ hZne _ _) (fun _ â†¦ hZcpt _ _)
    (fun {iâ‚ iâ‚‚} f â†¦ by dsimp; rw [â† Over.w f]; exact hstab ..)
",Formal Proof of Stacks Project Tag 01Z3,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/AffineTransitionLimit.lean#L153-L169,Q27041,,32.4.8,lemma,3.0,"['081A', '01YT', '0ELP']","\n  Lemma 32.4.8. In Situation 32.4.5. Suppose for each $i$ we are given a nonempty closed subset $Z_ i \\subset S_ i$ with $f_{i\'i}(Z_{i\'}) \\subset Z_ i$ for all $i\' \\geq i$. Then there exists a point $s \\in S$ with $f_ i(s) \\in Z_ i$ for all $i$. \n\n    \n      Proof.\n      Let $Z_ i \\subset S_ i$ also denote the reduced closed subscheme associated to $Z_ i$, see Schemes, Definition 26.12.5. A closed immersion is affine, and a composition of affine morphisms is affine (see Morphisms, Lemmas 29.11.10 and 29.11.8), and hence $Z_{i\'} \\to S_ i$ is affine when $i\' \\geq i$. We conclude that the morphism $f_{i\'i} : Z_{i\'} \\to Z_ i$ is affine by Morphisms, Lemma 29.11.12. Each of the schemes $Z_ i$ is quasi-compact as a closed subscheme of a quasi-compact scheme. Hence we may apply Lemma 32.4.3 to see that $Z = \\mathop{\\mathrm{lim}}\\nolimits _ i Z_ i$ is nonempty. Since there is a canonical morphism $Z \\to S$ we win. \n      $\\square$\n    \n",\n  Lemma 32.4.8. In Situation 32.4.5. Suppose for each $i$ we are given a nonempty closed subset $Z_ i \\subset S_ i$ with $f_{i\'i}(Z_{i\'}) \\subset Z_ i$ for all $i\' \\geq i$. Then there exists a point $s \\in S$ with $f_ i(s) \\in Z_ i$ for all $i$. \n\n    \n,"Proof.\n      Let $Z_ i \\subset S_ i$ also denote the reduced closed subscheme associated to $Z_ i$, see Schemes, Definition 26.12.5. A closed immersion is affine, and a composition of affine morphisms is affine (see Morphisms, Lemmas 29.11.10 and 29.11.8), and hence $Z_{i\'} \\to S_ i$ is affine when $i\' \\geq i$. We conclude that the morphism $f_{i\'i} : Z_{i\'} \\to Z_ i$ is affine by Morphisms, Lemma 29.11.12. Each of the schemes $Z_ i$ is quasi-compact as a closed subscheme of a quasi-compact scheme. Hence we may apply Lemma 32.4.3 to see that $Z = \\mathop{\\mathrm{lim}}\\nolimits _ i Z_ i$ is nonempty. Since there is a canonical morphism $Z \\to S$ we win. \n      $\\square$\n    \n"," by
  have {iâ‚ iâ‚‚ : Over j} (f : iâ‚ âŸ¶ iâ‚‚) : IsAffineHom ((Over.forget j â‹™ D).map f) := by
    dsimp; infer_instance
  simpa [Over.forall_iff] using exists_mem_of_isClosed_of_nonempty (Over.forget j â‹™ D) _
    ((Functor.Initial.isLimitWhiskerEquiv (Over.forget j) c).symm hc)
    (fun i â†¦ Z i.left i.hom) (fun _ â†¦ hZc _ _) (fun _ â†¦ hZne _ _) (fun _ â†¦ hZcpt _ _)
    (fun {iâ‚ iâ‚‚} f â†¦ by dsimp; rw [â† Over.w f]; exact hstab ..)
","lemma exists_mem_of_isClosed_of_nonempty'
    [IsCofilteredOrEmpty I]
    [âˆ€ {i j} (f : i âŸ¶ j), IsAffineHom (D.map f)]
    {j : I}
    (Z : âˆ€ (i : I), (i âŸ¶ j) â†’ Set (D.obj i))
    (hZc : âˆ€ i hij, IsClosed (Z i hij))
    (hZne : âˆ€ i hij, (Z i hij).Nonempty)
    (hZcpt : âˆ€ i hij, IsCompact (Z i hij))
    (hstab : âˆ€ (i i' : I) (hi'i : i' âŸ¶ i) (hij : i âŸ¶ j),
      Set.MapsTo (D.map hi'i) (Z i' (hi'i â‰« hij)) (Z i hij)) :
    âˆƒ (s : c.pt), âˆ€ i hij, c.Ï€.app i s âˆˆ Z i hij ","Proof.\n      Let $Z_ i \\subset S_ i$ also denote the reduced closed subscheme associated to $Z_ i$, see Schemes, Definition 26.12.5 [[\n  Definition 26.12.5. Let $X$ be a scheme. Let $Z \\subset X$ be a closed subset. A scheme structure on $Z$ is given by a closed subscheme $Z\'$ of $X$ whose underlying set is equal to $Z$. We often say \xe2\x80\x9clet $(Z, \\mathcal{O}_ Z)$ be a scheme structure on $Z$\xe2\x80\x9d to indicate this. The reduced induced scheme structure on $Z$ is the one constructed in Lemma 26.12.4. The reduction $X_{red}$ of $X$ is the reduced induced scheme structure on $X$ itself. \n]]. A closed immersion is affine, and a composition of affine morphisms is affine (see Morphisms, Lemmas 29.11.10 [[\n  Lemma 29.11.10. A closed immersion is affine. \n\n    \n]] and 29.11.8 [[\n  Lemma 29.11.8. The composition of affine morphisms is affine. \n\n    \n]]), and hence $Z_{i\'} \\to S_ i$ is affine when $i\' \\geq i$. We conclude that the morphism $f_{i\'i} : Z_{i\'} \\to Z_ i$ is affine by Morphisms, Lemma 29.11.12 [[\n  Lemma 29.11.12. Suppose $g : X \\to Y$ is a morphism of schemes over $S$. \n  \n  \nIf $X$ is affine over $S$ and $\\Delta : Y \\to Y \\times _ S Y$ is affine, then $g$ is affine. \n\n\nIf $X$ is affine over $S$ and $Y$ is separated over $S$, then $g$ is affine. \n\n\nA morphism from an affine scheme to a scheme with affine diagonal is affine. \n\n\nA morphism from an affine scheme to a separated scheme is affine. \n\n\n\n\n    \n]]. Each of the schemes $Z_ i$ is quasi-compact as a closed subscheme of a quasi-compact scheme. Hence we may apply Lemma 32.4.3 [[\n  Lemma 32.4.3. Let $S = \\mathop{\\mathrm{lim}}\\nolimits S_ i$ be the limit of a directed inverse system of schemes with affine transition morphisms (Lemma 32.2.2). If all the schemes $S_ i$ are nonempty and quasi-compact, then the limit $S = \\mathop{\\mathrm{lim}}\\nolimits _ i S_ i$ is nonempty. \n\n    \n]] to see that $Z = \\mathop{\\mathrm{lim}}\\nolimits _ i Z_ i$ is nonempty. Since there is a canonical morphism $Z \\to S$ we win. \n      $\\square$\n    \n"
8,01Z4,"lemma exists_map_preimage_eq_map_preimage
    [IsCofiltered I]
    [âˆ€ {i j} (f : i âŸ¶ j), IsAffineHom (D.map f)]
    {i : I} {U V : (D.obj i).Opens} (hU : IsCompact (U : Set (D.obj i)))
    (hV : IsCompact (V : Set (D.obj i))) (H : c.Ï€.app i â»Â¹áµ U = c.Ï€.app i â»Â¹áµ V) :
    âˆƒ (j : I) (fji : j âŸ¶ i), D.map fji â»Â¹áµ U = D.map fji â»Â¹áµ V := by
  obtain âŸ¨jâ‚, fjâ‚i, eâ‚âŸ© := exists_map_preimage_le_map_preimage D c hc hU H.le
  obtain âŸ¨jâ‚‚, fjâ‚‚i, eâ‚‚âŸ© := exists_map_preimage_le_map_preimage D c hc hV H.ge
  obtain âŸ¨k, fkjâ‚, fkjâ‚‚, eâŸ© := IsCofiltered.cospan fjâ‚i fjâ‚‚i
  refine âŸ¨k, fkjâ‚ â‰« fjâ‚i, le_antisymm ?_ ?_âŸ©
  Â· simpa only [Scheme.Hom.comp_preimage, Functor.map_comp] using Scheme.Hom.preimage_mono _ eâ‚
  Â· rw [e]
    simpa only [Scheme.Hom.comp_preimage, Functor.map_comp] using Scheme.Hom.preimage_mono _ eâ‚‚
",Formal Proof of Stacks Project Tag 01Z4,(2),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/AffineTransitionLimit.lean#L278-L290,Q27041,,32.4.11,lemma,3.0,"['081A', '01YT', '0ELP']","\n  Lemma 32.4.11. In Situation 32.4.5 we have the following: \n  \n  \nGiven any quasi-compact open $V \\subset S = \\mathop{\\mathrm{lim}}\\nolimits _ i S_ i$ there exists an $i \\in I$ and a quasi-compact open $V_ i \\subset S_ i$ such that $f_ i^{-1}(V_ i) = V$. \n\n\nGiven $V_ i \\subset S_ i$ and $V_{i\'} \\subset S_{i\'}$ quasi-compact opens such that $f_ i^{-1}(V_ i) = f_{i\'}^{-1}(V_{i\'})$ there exists an index $i\'\' \\geq i, i\'$ such that $f_{i\'\'i}^{-1}(V_ i) = f_{i\'\'i\'}^{-1}(V_{i\'})$. \n\n\nIf $V_{1, i}, \\ldots , V_{n, i} \\subset S_ i$ are quasi-compact opens and $S = f_ i^{-1}(V_{1, i}) \\cup \\ldots \\cup f_ i^{-1}(V_{n, i})$ then $S_{i\'} = f_{i\'i}^{-1}(V_{1, i}) \\cup \\ldots \\cup f_{i\'i}^{-1}(V_{n, i})$ for some $i\' \\geq i$. \n\n\n\n\n    \n      Proof.\n      Choose $i_0 \\in I$. Note that $I$ is nonempty as the limit is directed. For convenience we write $S_0 = S_{i_0}$ and $i_0 = 0$. Choose an affine open covering $S_0 = U_{1, 0} \\cup \\ldots \\cup U_{m, 0}$. Denote $U_{j, i} \\subset S_ i$ the inverse image of $U_{j, 0}$ under the transition morphism for $i \\geq 0$. Denote $U_ j$ the inverse image of $U_{j, 0}$ in $S$. Note that $U_ j = \\mathop{\\mathrm{lim}}\\nolimits _ i U_{j, i}$ is a limit of affine schemes. \n    \n      We first prove the uniqueness statement: Let $V_ i \\subset S_ i$ and $V_{i\'} \\subset S_{i\'}$ quasi-compact opens such that $f_ i^{-1}(V_ i) = f_{i\'}^{-1}(V_{i\'})$. It suffices to show that $f_{i\'\'i}^{-1}(V_ i \\cap U_{j, i\'\'})$ and $f_{i\'\'i\'}^{-1}(V_{i\'} \\cap U_{j, i\'\'})$ become equal for $i\'\'$ large enough. Hence we reduce to the case of a limit of affine schemes. In this case write $S = \\mathop{\\mathrm{Spec}}(R)$ and $S_ i = \\mathop{\\mathrm{Spec}}(R_ i)$ for all $i \\in I$. We may write $V_ i = S_ i \\setminus V(h_1, \\ldots , h_ m)$ and $V_{i\'} = S_{i\'} \\setminus V(g_1, \\ldots , g_ n)$. The assumption means that the ideals $\\sum g_ jR$ and $\\sum h_ jR$ have the same radical in $R$. This means that $g_ j^ N = \\sum a_{jj\'}h_{j\'}$ and $h_ j^ N = \\sum b_{jj\'} g_{j\'}$ for some $N \\gg 0$ and $a_{jj\'}$ and $b_{jj\'}$ in $R$. Since $R = \\mathop{\\mathrm{colim}}\\nolimits _ i R_ i$ we can chose an index $i\'\' \\geq i$ such that the equations $g_ j^ N = \\sum a_{jj\'}h_{j\'}$ and $h_ j^ N = \\sum b_{jj\'} g_{j\'}$ hold in $R_{i\'\'}$ for some $a_{jj\'}$ and $b_{jj\'}$ in $R_{i\'\'}$. This implies that the ideals $\\sum g_ jR_{i\'\'}$ and $\\sum h_ jR_{i\'\'}$ have the same radical in $R_{i\'\'}$ as desired. \n    \n      We prove existence: If $S_0$ is affine, then $S_ i = \\mathop{\\mathrm{Spec}}(R_ i)$ for all $i \\geq 0$ and $S = \\mathop{\\mathrm{Spec}}(R)$ with $R = \\mathop{\\mathrm{colim}}\\nolimits R_ i$. Then $V = S \\setminus V(g_1, \\ldots , g_ n)$ for some $g_1, \\ldots , g_ n \\in R$. Choose any $i$ large enough so that each of the $g_ j$ comes from an element $g_{j, i} \\in R_ i$ and take $V_ i = S_ i \\setminus V(g_{1, i}, \\ldots , g_{n, i})$. If $S_0$ is general, then the opens $V \\cap U_ j$ are quasi-compact because $S$ is quasi-separated. Hence by the affine case we see that for each $j = 1, \\ldots , m$ there exists an $i_ j \\in I$ and a quasi-compact open $V_{i_ j} \\subset U_{j, i_ j}$ whose inverse image in $U_ j$ is $V \\cap U_ j$. Set $i = \\max (i_1, \\ldots , i_ m)$ and let $V_ i = \\bigcup f_{ii_ j}^{-1}(V_{i_ j})$. \n    \n      The statement on coverings follows from the uniqueness statement for the opens $V_{1, i} \\cup \\ldots \\cup V_{n, i}$ and $S_ i$ of $S_ i$. \n      $\\square$\n    \n","\n  Lemma 32.4.11. In Situation 32.4.5 we have the following: \n  \n  \nGiven any quasi-compact open $V \\subset S = \\mathop{\\mathrm{lim}}\\nolimits _ i S_ i$ there exists an $i \\in I$ and a quasi-compact open $V_ i \\subset S_ i$ such that $f_ i^{-1}(V_ i) = V$. \n\n\nGiven $V_ i \\subset S_ i$ and $V_{i\'} \\subset S_{i\'}$ quasi-compact opens such that $f_ i^{-1}(V_ i) = f_{i\'}^{-1}(V_{i\'})$ there exists an index $i\'\' \\geq i, i\'$ such that $f_{i\'\'i}^{-1}(V_ i) = f_{i\'\'i\'}^{-1}(V_{i\'})$. \n\n\nIf $V_{1, i}, \\ldots , V_{n, i} \\subset S_ i$ are quasi-compact opens and $S = f_ i^{-1}(V_{1, i}) \\cup \\ldots \\cup f_ i^{-1}(V_{n, i})$ then $S_{i\'} = f_{i\'i}^{-1}(V_{1, i}) \\cup \\ldots \\cup f_{i\'i}^{-1}(V_{n, i})$ for some $i\' \\geq i$. \n\n\n\n\n    \n","Proof.\n      Choose $i_0 \\in I$. Note that $I$ is nonempty as the limit is directed. For convenience we write $S_0 = S_{i_0}$ and $i_0 = 0$. Choose an affine open covering $S_0 = U_{1, 0} \\cup \\ldots \\cup U_{m, 0}$. Denote $U_{j, i} \\subset S_ i$ the inverse image of $U_{j, 0}$ under the transition morphism for $i \\geq 0$. Denote $U_ j$ the inverse image of $U_{j, 0}$ in $S$. Note that $U_ j = \\mathop{\\mathrm{lim}}\\nolimits _ i U_{j, i}$ is a limit of affine schemes. \n    \n      We first prove the uniqueness statement: Let $V_ i \\subset S_ i$ and $V_{i\'} \\subset S_{i\'}$ quasi-compact opens such that $f_ i^{-1}(V_ i) = f_{i\'}^{-1}(V_{i\'})$. It suffices to show that $f_{i\'\'i}^{-1}(V_ i \\cap U_{j, i\'\'})$ and $f_{i\'\'i\'}^{-1}(V_{i\'} \\cap U_{j, i\'\'})$ become equal for $i\'\'$ large enough. Hence we reduce to the case of a limit of affine schemes. In this case write $S = \\mathop{\\mathrm{Spec}}(R)$ and $S_ i = \\mathop{\\mathrm{Spec}}(R_ i)$ for all $i \\in I$. We may write $V_ i = S_ i \\setminus V(h_1, \\ldots , h_ m)$ and $V_{i\'} = S_{i\'} \\setminus V(g_1, \\ldots , g_ n)$. The assumption means that the ideals $\\sum g_ jR$ and $\\sum h_ jR$ have the same radical in $R$. This means that $g_ j^ N = \\sum a_{jj\'}h_{j\'}$ and $h_ j^ N = \\sum b_{jj\'} g_{j\'}$ for some $N \\gg 0$ and $a_{jj\'}$ and $b_{jj\'}$ in $R$. Since $R = \\mathop{\\mathrm{colim}}\\nolimits _ i R_ i$ we can chose an index $i\'\' \\geq i$ such that the equations $g_ j^ N = \\sum a_{jj\'}h_{j\'}$ and $h_ j^ N = \\sum b_{jj\'} g_{j\'}$ hold in $R_{i\'\'}$ for some $a_{jj\'}$ and $b_{jj\'}$ in $R_{i\'\'}$. This implies that the ideals $\\sum g_ jR_{i\'\'}$ and $\\sum h_ jR_{i\'\'}$ have the same radical in $R_{i\'\'}$ as desired. \n    \n      We prove existence: If $S_0$ is affine, then $S_ i = \\mathop{\\mathrm{Spec}}(R_ i)$ for all $i \\geq 0$ and $S = \\mathop{\\mathrm{Spec}}(R)$ with $R = \\mathop{\\mathrm{colim}}\\nolimits R_ i$. Then $V = S \\setminus V(g_1, \\ldots , g_ n)$ for some $g_1, \\ldots , g_ n \\in R$. Choose any $i$ large enough so that each of the $g_ j$ comes from an element $g_{j, i} \\in R_ i$ and take $V_ i = S_ i \\setminus V(g_{1, i}, \\ldots , g_{n, i})$. If $S_0$ is general, then the opens $V \\cap U_ j$ are quasi-compact because $S$ is quasi-separated. Hence by the affine case we see that for each $j = 1, \\ldots , m$ there exists an $i_ j \\in I$ and a quasi-compact open $V_{i_ j} \\subset U_{j, i_ j}$ whose inverse image in $U_ j$ is $V \\cap U_ j$. Set $i = \\max (i_1, \\ldots , i_ m)$ and let $V_ i = \\bigcup f_{ii_ j}^{-1}(V_{i_ j})$. \n    \n      The statement on coverings follows from the uniqueness statement for the opens $V_{1, i} \\cup \\ldots \\cup V_{n, i}$ and $S_ i$ of $S_ i$. \n      $\\square$\n    \n"," by
  obtain âŸ¨jâ‚, fjâ‚i, eâ‚âŸ© := exists_map_preimage_le_map_preimage D c hc hU H.le
  obtain âŸ¨jâ‚‚, fjâ‚‚i, eâ‚‚âŸ© := exists_map_preimage_le_map_preimage D c hc hV H.ge
  obtain âŸ¨k, fkjâ‚, fkjâ‚‚, eâŸ© := IsCofiltered.cospan fjâ‚i fjâ‚‚i
  refine âŸ¨k, fkjâ‚ â‰« fjâ‚i, le_antisymm ?_ ?_âŸ©
  Â· simpa only [Scheme.Hom.comp_preimage, Functor.map_comp] using Scheme.Hom.preimage_mono _ eâ‚
  Â· rw [e]
    simpa only [Scheme.Hom.comp_preimage, Functor.map_comp] using Scheme.Hom.preimage_mono _ eâ‚‚
","lemma exists_map_preimage_eq_map_preimage
    [IsCofiltered I]
    [âˆ€ {i j} (f : i âŸ¶ j), IsAffineHom (D.map f)]
    {i : I} {U V : (D.obj i).Opens} (hU : IsCompact (U : Set (D.obj i)))
    (hV : IsCompact (V : Set (D.obj i))) (H : c.Ï€.app i â»Â¹áµ U = c.Ï€.app i â»Â¹áµ V) :
    âˆƒ (j : I) (fji : j âŸ¶ i), D.map fji â»Â¹áµ U = D.map fji â»Â¹áµ V ","Proof.\n      Choose $i_0 \\in I$. Note that $I$ is nonempty as the limit is directed. For convenience we write $S_0 = S_{i_0}$ and $i_0 = 0$. Choose an affine open covering $S_0 = U_{1, 0} \\cup \\ldots \\cup U_{m, 0}$. Denote $U_{j, i} \\subset S_ i$ the inverse image of $U_{j, 0}$ under the transition morphism for $i \\geq 0$. Denote $U_ j$ the inverse image of $U_{j, 0}$ in $S$. Note that $U_ j = \\mathop{\\mathrm{lim}}\\nolimits _ i U_{j, i}$ is a limit of affine schemes. \n    \n      We first prove the uniqueness statement: Let $V_ i \\subset S_ i$ and $V_{i\'} \\subset S_{i\'}$ quasi-compact opens such that $f_ i^{-1}(V_ i) = f_{i\'}^{-1}(V_{i\'})$. It suffices to show that $f_{i\'\'i}^{-1}(V_ i \\cap U_{j, i\'\'})$ and $f_{i\'\'i\'}^{-1}(V_{i\'} \\cap U_{j, i\'\'})$ become equal for $i\'\'$ large enough. Hence we reduce to the case of a limit of affine schemes. In this case write $S = \\mathop{\\mathrm{Spec}}(R)$ and $S_ i = \\mathop{\\mathrm{Spec}}(R_ i)$ for all $i \\in I$. We may write $V_ i = S_ i \\setminus V(h_1, \\ldots , h_ m)$ and $V_{i\'} = S_{i\'} \\setminus V(g_1, \\ldots , g_ n)$. The assumption means that the ideals $\\sum g_ jR$ and $\\sum h_ jR$ have the same radical in $R$. This means that $g_ j^ N = \\sum a_{jj\'}h_{j\'}$ and $h_ j^ N = \\sum b_{jj\'} g_{j\'}$ for some $N \\gg 0$ and $a_{jj\'}$ and $b_{jj\'}$ in $R$. Since $R = \\mathop{\\mathrm{colim}}\\nolimits _ i R_ i$ we can chose an index $i\'\' \\geq i$ such that the equations $g_ j^ N = \\sum a_{jj\'}h_{j\'}$ and $h_ j^ N = \\sum b_{jj\'} g_{j\'}$ hold in $R_{i\'\'}$ for some $a_{jj\'}$ and $b_{jj\'}$ in $R_{i\'\'}$. This implies that the ideals $\\sum g_ jR_{i\'\'}$ and $\\sum h_ jR_{i\'\'}$ have the same radical in $R_{i\'\'}$ as desired. \n    \n      We prove existence: If $S_0$ is affine, then $S_ i = \\mathop{\\mathrm{Spec}}(R_ i)$ for all $i \\geq 0$ and $S = \\mathop{\\mathrm{Spec}}(R)$ with $R = \\mathop{\\mathrm{colim}}\\nolimits R_ i$. Then $V = S \\setminus V(g_1, \\ldots , g_ n)$ for some $g_1, \\ldots , g_ n \\in R$. Choose any $i$ large enough so that each of the $g_ j$ comes from an element $g_{j, i} \\in R_ i$ and take $V_ i = S_ i \\setminus V(g_{1, i}, \\ldots , g_{n, i})$. If $S_0$ is general, then the opens $V \\cap U_ j$ are quasi-compact because $S$ is quasi-separated. Hence by the affine case we see that for each $j = 1, \\ldots , m$ there exists an $i_ j \\in I$ and a quasi-compact open $V_{i_ j} \\subset U_{j, i_ j}$ whose inverse image in $U_ j$ is $V \\cap U_ j$. Set $i = \\max (i_1, \\ldots , i_ m)$ and let $V_ i = \\bigcup f_{ii_ j}^{-1}(V_{i_ j})$. \n    \n      The statement on coverings follows from the uniqueness statement for the opens $V_{1, i} \\cup \\ldots \\cup V_{n, i}$ and $S_ i$ of $S_ i$. \n      $\\square$\n    \n"
9,01Z4,"lemma exists_isAffineOpen_preimage_eq
    [IsCofiltered I] [âˆ€ {i j} (f : i âŸ¶ j), IsAffineHom (D.map f)]
    [âˆ€ i, QuasiSeparatedSpace (D.obj i)]
    (U : c.pt.Opens) (hU : IsAffineOpen U) :
    âˆƒ (i : I) (V : (D.obj i).Opens), IsAffineOpen V âˆ§ c.Ï€.app i â»Â¹áµ V = U := by
  classical
  obtain âŸ¨i, U, hU', rflâŸ© := exists_preimage_eq D c hc U hU.isCompact
  have (j : Over i) : CompactSpace ((opensDiagram D i U).obj j) :=
    isCompact_iff_compactSpace.mp (QuasiCompact.isCompact_preimage _ U.2 hU')
  have (j : Over i) : QuasiSeparatedSpace ((opensDiagram D i U).obj j) :=
    (isQuasiSeparated_iff_quasiSeparatedSpace _ (D.map _ â»Â¹áµ _).2).mp (.of_quasiSeparatedSpace _)
  have : IsAffine (opensCone D c i U).pt := hU
  obtain âŸ¨j, hjâŸ© := Scheme.exists_isAffine_of_isLimit _ _ (isLimitOpensCone D c hc i U)
  refine âŸ¨_, _, hj, ?_âŸ©
  rw [â† Scheme.Hom.comp_preimage, c.w]
  simp
",Formal Proof of Stacks Project Tag 01Z4,(1),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/AffineTransitionLimit.lean#L1010-L1025,Q27041,,32.4.11,lemma,3.0,"['081A', '01YT', '0ELP']","\n  Lemma 32.4.11. In Situation 32.4.5 we have the following: \n  \n  \nGiven any quasi-compact open $V \\subset S = \\mathop{\\mathrm{lim}}\\nolimits _ i S_ i$ there exists an $i \\in I$ and a quasi-compact open $V_ i \\subset S_ i$ such that $f_ i^{-1}(V_ i) = V$. \n\n\nGiven $V_ i \\subset S_ i$ and $V_{i\'} \\subset S_{i\'}$ quasi-compact opens such that $f_ i^{-1}(V_ i) = f_{i\'}^{-1}(V_{i\'})$ there exists an index $i\'\' \\geq i, i\'$ such that $f_{i\'\'i}^{-1}(V_ i) = f_{i\'\'i\'}^{-1}(V_{i\'})$. \n\n\nIf $V_{1, i}, \\ldots , V_{n, i} \\subset S_ i$ are quasi-compact opens and $S = f_ i^{-1}(V_{1, i}) \\cup \\ldots \\cup f_ i^{-1}(V_{n, i})$ then $S_{i\'} = f_{i\'i}^{-1}(V_{1, i}) \\cup \\ldots \\cup f_{i\'i}^{-1}(V_{n, i})$ for some $i\' \\geq i$. \n\n\n\n\n    \n      Proof.\n      Choose $i_0 \\in I$. Note that $I$ is nonempty as the limit is directed. For convenience we write $S_0 = S_{i_0}$ and $i_0 = 0$. Choose an affine open covering $S_0 = U_{1, 0} \\cup \\ldots \\cup U_{m, 0}$. Denote $U_{j, i} \\subset S_ i$ the inverse image of $U_{j, 0}$ under the transition morphism for $i \\geq 0$. Denote $U_ j$ the inverse image of $U_{j, 0}$ in $S$. Note that $U_ j = \\mathop{\\mathrm{lim}}\\nolimits _ i U_{j, i}$ is a limit of affine schemes. \n    \n      We first prove the uniqueness statement: Let $V_ i \\subset S_ i$ and $V_{i\'} \\subset S_{i\'}$ quasi-compact opens such that $f_ i^{-1}(V_ i) = f_{i\'}^{-1}(V_{i\'})$. It suffices to show that $f_{i\'\'i}^{-1}(V_ i \\cap U_{j, i\'\'})$ and $f_{i\'\'i\'}^{-1}(V_{i\'} \\cap U_{j, i\'\'})$ become equal for $i\'\'$ large enough. Hence we reduce to the case of a limit of affine schemes. In this case write $S = \\mathop{\\mathrm{Spec}}(R)$ and $S_ i = \\mathop{\\mathrm{Spec}}(R_ i)$ for all $i \\in I$. We may write $V_ i = S_ i \\setminus V(h_1, \\ldots , h_ m)$ and $V_{i\'} = S_{i\'} \\setminus V(g_1, \\ldots , g_ n)$. The assumption means that the ideals $\\sum g_ jR$ and $\\sum h_ jR$ have the same radical in $R$. This means that $g_ j^ N = \\sum a_{jj\'}h_{j\'}$ and $h_ j^ N = \\sum b_{jj\'} g_{j\'}$ for some $N \\gg 0$ and $a_{jj\'}$ and $b_{jj\'}$ in $R$. Since $R = \\mathop{\\mathrm{colim}}\\nolimits _ i R_ i$ we can chose an index $i\'\' \\geq i$ such that the equations $g_ j^ N = \\sum a_{jj\'}h_{j\'}$ and $h_ j^ N = \\sum b_{jj\'} g_{j\'}$ hold in $R_{i\'\'}$ for some $a_{jj\'}$ and $b_{jj\'}$ in $R_{i\'\'}$. This implies that the ideals $\\sum g_ jR_{i\'\'}$ and $\\sum h_ jR_{i\'\'}$ have the same radical in $R_{i\'\'}$ as desired. \n    \n      We prove existence: If $S_0$ is affine, then $S_ i = \\mathop{\\mathrm{Spec}}(R_ i)$ for all $i \\geq 0$ and $S = \\mathop{\\mathrm{Spec}}(R)$ with $R = \\mathop{\\mathrm{colim}}\\nolimits R_ i$. Then $V = S \\setminus V(g_1, \\ldots , g_ n)$ for some $g_1, \\ldots , g_ n \\in R$. Choose any $i$ large enough so that each of the $g_ j$ comes from an element $g_{j, i} \\in R_ i$ and take $V_ i = S_ i \\setminus V(g_{1, i}, \\ldots , g_{n, i})$. If $S_0$ is general, then the opens $V \\cap U_ j$ are quasi-compact because $S$ is quasi-separated. Hence by the affine case we see that for each $j = 1, \\ldots , m$ there exists an $i_ j \\in I$ and a quasi-compact open $V_{i_ j} \\subset U_{j, i_ j}$ whose inverse image in $U_ j$ is $V \\cap U_ j$. Set $i = \\max (i_1, \\ldots , i_ m)$ and let $V_ i = \\bigcup f_{ii_ j}^{-1}(V_{i_ j})$. \n    \n      The statement on coverings follows from the uniqueness statement for the opens $V_{1, i} \\cup \\ldots \\cup V_{n, i}$ and $S_ i$ of $S_ i$. \n      $\\square$\n    \n","\n  Lemma 32.4.11. In Situation 32.4.5 we have the following: \n  \n  \nGiven any quasi-compact open $V \\subset S = \\mathop{\\mathrm{lim}}\\nolimits _ i S_ i$ there exists an $i \\in I$ and a quasi-compact open $V_ i \\subset S_ i$ such that $f_ i^{-1}(V_ i) = V$. \n\n\nGiven $V_ i \\subset S_ i$ and $V_{i\'} \\subset S_{i\'}$ quasi-compact opens such that $f_ i^{-1}(V_ i) = f_{i\'}^{-1}(V_{i\'})$ there exists an index $i\'\' \\geq i, i\'$ such that $f_{i\'\'i}^{-1}(V_ i) = f_{i\'\'i\'}^{-1}(V_{i\'})$. \n\n\nIf $V_{1, i}, \\ldots , V_{n, i} \\subset S_ i$ are quasi-compact opens and $S = f_ i^{-1}(V_{1, i}) \\cup \\ldots \\cup f_ i^{-1}(V_{n, i})$ then $S_{i\'} = f_{i\'i}^{-1}(V_{1, i}) \\cup \\ldots \\cup f_{i\'i}^{-1}(V_{n, i})$ for some $i\' \\geq i$. \n\n\n\n\n    \n","Proof.\n      Choose $i_0 \\in I$. Note that $I$ is nonempty as the limit is directed. For convenience we write $S_0 = S_{i_0}$ and $i_0 = 0$. Choose an affine open covering $S_0 = U_{1, 0} \\cup \\ldots \\cup U_{m, 0}$. Denote $U_{j, i} \\subset S_ i$ the inverse image of $U_{j, 0}$ under the transition morphism for $i \\geq 0$. Denote $U_ j$ the inverse image of $U_{j, 0}$ in $S$. Note that $U_ j = \\mathop{\\mathrm{lim}}\\nolimits _ i U_{j, i}$ is a limit of affine schemes. \n    \n      We first prove the uniqueness statement: Let $V_ i \\subset S_ i$ and $V_{i\'} \\subset S_{i\'}$ quasi-compact opens such that $f_ i^{-1}(V_ i) = f_{i\'}^{-1}(V_{i\'})$. It suffices to show that $f_{i\'\'i}^{-1}(V_ i \\cap U_{j, i\'\'})$ and $f_{i\'\'i\'}^{-1}(V_{i\'} \\cap U_{j, i\'\'})$ become equal for $i\'\'$ large enough. Hence we reduce to the case of a limit of affine schemes. In this case write $S = \\mathop{\\mathrm{Spec}}(R)$ and $S_ i = \\mathop{\\mathrm{Spec}}(R_ i)$ for all $i \\in I$. We may write $V_ i = S_ i \\setminus V(h_1, \\ldots , h_ m)$ and $V_{i\'} = S_{i\'} \\setminus V(g_1, \\ldots , g_ n)$. The assumption means that the ideals $\\sum g_ jR$ and $\\sum h_ jR$ have the same radical in $R$. This means that $g_ j^ N = \\sum a_{jj\'}h_{j\'}$ and $h_ j^ N = \\sum b_{jj\'} g_{j\'}$ for some $N \\gg 0$ and $a_{jj\'}$ and $b_{jj\'}$ in $R$. Since $R = \\mathop{\\mathrm{colim}}\\nolimits _ i R_ i$ we can chose an index $i\'\' \\geq i$ such that the equations $g_ j^ N = \\sum a_{jj\'}h_{j\'}$ and $h_ j^ N = \\sum b_{jj\'} g_{j\'}$ hold in $R_{i\'\'}$ for some $a_{jj\'}$ and $b_{jj\'}$ in $R_{i\'\'}$. This implies that the ideals $\\sum g_ jR_{i\'\'}$ and $\\sum h_ jR_{i\'\'}$ have the same radical in $R_{i\'\'}$ as desired. \n    \n      We prove existence: If $S_0$ is affine, then $S_ i = \\mathop{\\mathrm{Spec}}(R_ i)$ for all $i \\geq 0$ and $S = \\mathop{\\mathrm{Spec}}(R)$ with $R = \\mathop{\\mathrm{colim}}\\nolimits R_ i$. Then $V = S \\setminus V(g_1, \\ldots , g_ n)$ for some $g_1, \\ldots , g_ n \\in R$. Choose any $i$ large enough so that each of the $g_ j$ comes from an element $g_{j, i} \\in R_ i$ and take $V_ i = S_ i \\setminus V(g_{1, i}, \\ldots , g_{n, i})$. If $S_0$ is general, then the opens $V \\cap U_ j$ are quasi-compact because $S$ is quasi-separated. Hence by the affine case we see that for each $j = 1, \\ldots , m$ there exists an $i_ j \\in I$ and a quasi-compact open $V_{i_ j} \\subset U_{j, i_ j}$ whose inverse image in $U_ j$ is $V \\cap U_ j$. Set $i = \\max (i_1, \\ldots , i_ m)$ and let $V_ i = \\bigcup f_{ii_ j}^{-1}(V_{i_ j})$. \n    \n      The statement on coverings follows from the uniqueness statement for the opens $V_{1, i} \\cup \\ldots \\cup V_{n, i}$ and $S_ i$ of $S_ i$. \n      $\\square$\n    \n"," by
  classical
  obtain âŸ¨i, U, hU', rflâŸ© := exists_preimage_eq D c hc U hU.isCompact
  have (j : Over i) : CompactSpace ((opensDiagram D i U).obj j) :=
    isCompact_iff_compactSpace.mp (QuasiCompact.isCompact_preimage _ U.2 hU')
  have (j : Over i) : QuasiSeparatedSpace ((opensDiagram D i U).obj j) :=
    (isQuasiSeparated_iff_quasiSeparatedSpace _ (D.map _ â»Â¹áµ _).2).mp (.of_quasiSeparatedSpace _)
  have : IsAffine (opensCone D c i U).pt := hU
  obtain âŸ¨j, hjâŸ© := Scheme.exists_isAffine_of_isLimit _ _ (isLimitOpensCone D c hc i U)
  refine âŸ¨_, _, hj, ?_âŸ©
  rw [â† Scheme.Hom.comp_preimage, c.w]
  simp
","lemma exists_isAffineOpen_preimage_eq
    [IsCofiltered I] [âˆ€ {i j} (f : i âŸ¶ j), IsAffineHom (D.map f)]
    [âˆ€ i, QuasiSeparatedSpace (D.obj i)]
    (U : c.pt.Opens) (hU : IsAffineOpen U) :
    âˆƒ (i : I) (V : (D.obj i).Opens), IsAffineOpen V âˆ§ c.Ï€.app i â»Â¹áµ V = U ","Proof.\n      Choose $i_0 \\in I$. Note that $I$ is nonempty as the limit is directed. For convenience we write $S_0 = S_{i_0}$ and $i_0 = 0$. Choose an affine open covering $S_0 = U_{1, 0} \\cup \\ldots \\cup U_{m, 0}$. Denote $U_{j, i} \\subset S_ i$ the inverse image of $U_{j, 0}$ under the transition morphism for $i \\geq 0$. Denote $U_ j$ the inverse image of $U_{j, 0}$ in $S$. Note that $U_ j = \\mathop{\\mathrm{lim}}\\nolimits _ i U_{j, i}$ is a limit of affine schemes. \n    \n      We first prove the uniqueness statement: Let $V_ i \\subset S_ i$ and $V_{i\'} \\subset S_{i\'}$ quasi-compact opens such that $f_ i^{-1}(V_ i) = f_{i\'}^{-1}(V_{i\'})$. It suffices to show that $f_{i\'\'i}^{-1}(V_ i \\cap U_{j, i\'\'})$ and $f_{i\'\'i\'}^{-1}(V_{i\'} \\cap U_{j, i\'\'})$ become equal for $i\'\'$ large enough. Hence we reduce to the case of a limit of affine schemes. In this case write $S = \\mathop{\\mathrm{Spec}}(R)$ and $S_ i = \\mathop{\\mathrm{Spec}}(R_ i)$ for all $i \\in I$. We may write $V_ i = S_ i \\setminus V(h_1, \\ldots , h_ m)$ and $V_{i\'} = S_{i\'} \\setminus V(g_1, \\ldots , g_ n)$. The assumption means that the ideals $\\sum g_ jR$ and $\\sum h_ jR$ have the same radical in $R$. This means that $g_ j^ N = \\sum a_{jj\'}h_{j\'}$ and $h_ j^ N = \\sum b_{jj\'} g_{j\'}$ for some $N \\gg 0$ and $a_{jj\'}$ and $b_{jj\'}$ in $R$. Since $R = \\mathop{\\mathrm{colim}}\\nolimits _ i R_ i$ we can chose an index $i\'\' \\geq i$ such that the equations $g_ j^ N = \\sum a_{jj\'}h_{j\'}$ and $h_ j^ N = \\sum b_{jj\'} g_{j\'}$ hold in $R_{i\'\'}$ for some $a_{jj\'}$ and $b_{jj\'}$ in $R_{i\'\'}$. This implies that the ideals $\\sum g_ jR_{i\'\'}$ and $\\sum h_ jR_{i\'\'}$ have the same radical in $R_{i\'\'}$ as desired. \n    \n      We prove existence: If $S_0$ is affine, then $S_ i = \\mathop{\\mathrm{Spec}}(R_ i)$ for all $i \\geq 0$ and $S = \\mathop{\\mathrm{Spec}}(R)$ with $R = \\mathop{\\mathrm{colim}}\\nolimits R_ i$. Then $V = S \\setminus V(g_1, \\ldots , g_ n)$ for some $g_1, \\ldots , g_ n \\in R$. Choose any $i$ large enough so that each of the $g_ j$ comes from an element $g_{j, i} \\in R_ i$ and take $V_ i = S_ i \\setminus V(g_{1, i}, \\ldots , g_{n, i})$. If $S_0$ is general, then the opens $V \\cap U_ j$ are quasi-compact because $S$ is quasi-separated. Hence by the affine case we see that for each $j = 1, \\ldots , m$ there exists an $i_ j \\in I$ and a quasi-compact open $V_{i_ j} \\subset U_{j, i_ j}$ whose inverse image in $U_ j$ is $V \\cap U_ j$. Set $i = \\max (i_1, \\ldots , i_ m)$ and let $V_ i = \\bigcup f_{ii_ j}^{-1}(V_{i_ j})$. \n    \n      The statement on coverings follows from the uniqueness statement for the opens $V_{1, i} \\cup \\ldots \\cup V_{n, i}$ and $S_ i$ of $S_ i$. \n      $\\square$\n    \n"
10,01ZC,"lemma Scheme.exists_hom_hom_comp_eq_comp_of_locallyOfFiniteType
    {i : I} (a : D.obj i âŸ¶ X) (ha : t.app i = a â‰« f)
    {j : I} (b : D.obj j âŸ¶ X) (hb : t.app j = b â‰« f)
    (hab : c.Ï€.app i â‰« a = c.Ï€.app j â‰« b) :
    âˆƒ (k : I) (hik : k âŸ¶ i) (hjk : k âŸ¶ j),
      D.map hik â‰« a = D.map hjk â‰« b := by
  let o := IsCofiltered.min i j
  obtain âŸ¨k, hik, heqâŸ© := Scheme.exists_hom_comp_eq_comp_of_locallyOfFiniteType D t f c hc
    (D.map (IsCofiltered.minToLeft i j) â‰« a) (D.map (IsCofiltered.minToRight i j) â‰« b)
    (by simp [â† ha])
    (by simp [â† hb]) (by simpa)
  use k, hik â‰« IsCofiltered.minToLeft i j, hik â‰« IsCofiltered.minToRight i j
  simpa using heq
",Formal Proof of Stacks Project Tag 01ZC,Injective part of (1) => (3),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/AffineTransitionLimit.lean#L656-L668,Q27041,,32.6.1,proposition,3.0,"['01ZB', '01YT', '0ELP']","\n       \n      \n  Proposition 32.6.1. Let $f : X \\to S$ be a morphism of schemes. The following are equivalent: \n  \n  \nThe morphism $f$ is locally of finite presentation. \n\n\nFor any directed set $I$, and any inverse system $(T_ i, f_{ii\'})$ of $S$-schemes over $I$ with each $T_ i$ affine, we have \n\n\n  \\[  \\mathop{\\mathrm{Mor}}\\nolimits _ S(\\mathop{\\mathrm{lim}}\\nolimits _ i T_ i, X) = \\mathop{\\mathrm{colim}}\\nolimits _ i \\mathop{\\mathrm{Mor}}\\nolimits _ S(T_ i, X)  \\]\n\n\nFor any directed set $I$, and any inverse system $(T_ i, f_{ii\'})$ of $S$-schemes over $I$ with each $f_{ii\'}$ affine and every $T_ i$ quasi-compact and quasi-separated as a scheme, we have \n\n\n  \\[  \\mathop{\\mathrm{Mor}}\\nolimits _ S(\\mathop{\\mathrm{lim}}\\nolimits _ i T_ i, X) = \\mathop{\\mathrm{colim}}\\nolimits _ i \\mathop{\\mathrm{Mor}}\\nolimits _ S(T_ i, X)  \\]\n\n\n\n\n    \n      Proof.\n      It is clear that (3) implies (2). \n    \n      Let us prove that (2) implies (1). Assume (2). Choose any affine opens $U \\subset X$ and $V \\subset S$ such that $f(U) \\subset V$. We have to show that $\\mathcal{O}_ S(V) \\to \\mathcal{O}_ X(U)$ is of finite presentation. Let $(A_ i, \\varphi _{ii\'})$ be a directed system of $\\mathcal{O}_ S(V)$-algebras. Set $A = \\mathop{\\mathrm{colim}}\\nolimits _ i A_ i$. According to Algebra, Lemma 10.127.3 we have to show that \n    \n      \n  \\[  \\mathop{\\mathrm{Hom}}\\nolimits _{\\mathcal{O}_ S(V)}(\\mathcal{O}_ X(U), A) = \\mathop{\\mathrm{colim}}\\nolimits _ i \\mathop{\\mathrm{Hom}}\\nolimits _{\\mathcal{O}_ S(V)}(\\mathcal{O}_ X(U), A_ i)  \\]\n\n    \n       Consider the schemes $T_ i = \\mathop{\\mathrm{Spec}}(A_ i)$. They form an inverse system of $V$-schemes over $I$ with transition morphisms $f_{ii\'} : T_ i \\to T_{i\'}$ induced by the $\\mathcal{O}_ S(V)$-algebra maps $\\varphi _{i\'i}$. Set $T := \\mathop{\\mathrm{Spec}}(A) = \\mathop{\\mathrm{lim}}\\nolimits _ i T_ i$. The formula above becomes in terms of morphism sets of schemes \n    \n      \n  \\[  \\mathop{\\mathrm{Mor}}\\nolimits _ V(\\mathop{\\mathrm{lim}}\\nolimits _ i T_ i, U) = \\mathop{\\mathrm{colim}}\\nolimits _ i \\mathop{\\mathrm{Mor}}\\nolimits _ V(T_ i, U).  \\]\n\n    \n       We first observe that $\\mathop{\\mathrm{Mor}}\\nolimits _ V(T_ i, U) = \\mathop{\\mathrm{Mor}}\\nolimits _ S(T_ i, U)$ and $\\mathop{\\mathrm{Mor}}\\nolimits _ V(T, U) = \\mathop{\\mathrm{Mor}}\\nolimits _ S(T, U)$. Hence we have to show that \n    \n      \n  \\[  \\mathop{\\mathrm{Mor}}\\nolimits _ S(\\mathop{\\mathrm{lim}}\\nolimits _ i T_ i, U) = \\mathop{\\mathrm{colim}}\\nolimits _ i \\mathop{\\mathrm{Mor}}\\nolimits _ S(T_ i, U)  \\]\n\n    \n       and we are given that \n    \n      \n  \\[  \\mathop{\\mathrm{Mor}}\\nolimits _ S(\\mathop{\\mathrm{lim}}\\nolimits _ i T_ i, X) = \\mathop{\\mathrm{colim}}\\nolimits _ i \\mathop{\\mathrm{Mor}}\\nolimits _ S(T_ i, X).  \\]\n\n    \n       Hence it suffices to prove that given a morphism $g_ i : T_ i \\to X$ over $S$ such that the composition $T \\to T_ i \\to X$ ends up in $U$ there exists some $i\' \\geq i$ such that the composition $g_{i\'} : T_{i\'} \\to T_ i \\to X$ ends up in $U$. Denote $Z_{i\'} = g_{i\'}^{-1}(X \\setminus U)$. Assume each $Z_{i\'}$ is nonempty to get a contradiction. By Lemma 32.4.8 there exists a point $t$ of $T$ which is mapped into $Z_{i\'}$ for all $i\' \\geq i$. Such a point is not mapped into $U$. A contradiction. \n    \n      Finally, let us prove that (1) implies (3). Assume (1). Let an inverse directed system $(T_ i, f_{ii\'})$ of $S$-schemes be given. Assume the morphisms $f_{ii\'}$ are affine and each $T_ i$ is quasi-compact and quasi-separated as a scheme. Let $T = \\mathop{\\mathrm{lim}}\\nolimits _ i T_ i$. Denote $f_ i : T \\to T_ i$ the projection morphisms. We have to show: \n    \n      \n  \nGiven morphisms $g_ i, g\'_ i : T_ i \\to X$ over $S$ such that $g_ i \\circ f_ i = g\'_ i \\circ f_ i$, then there exists an $i\' \\geq i$ such that $g_ i \\circ f_{i\'i} = g\'_ i \\circ f_{i\'i}$. \n\n\nGiven any morphism $g : T \\to X$ over $S$ there exists an $i \\in I$ and a morphism $g_ i : T_ i \\to X$ such that $g = f_ i \\circ g_ i$. \n\n\n\n    \n      First let us prove the uniqueness part (a). Let $g_ i, g\'_ i : T_ i \\to X$ be morphisms such that $g_ i \\circ f_ i = g\'_ i \\circ f_ i$. For any $i\' \\geq i$ we set $g_{i\'} = g_ i \\circ f_{i\'i}$ and $g\'_{i\'} = g\'_ i \\circ f_{i\'i}$. We also set $g = g_ i \\circ f_ i = g\'_ i \\circ f_ i$. Consider the morphism $(g_ i, g\'_ i) : T_ i \\to X \\times _ S X$. Set \n    \n      \n  \\[  W = \\bigcup \\nolimits _{U \\subset X\\text{ affine open}, V \\subset S\\text{ affine open}, f(U) \\subset V} U \\times _ V U.  \\]\n\n    \n       This is an open in $X \\times _ S X$, with the property that the morphism $\\Delta _{X/S}$ factors through a closed immersion into $W$, see the proof of Schemes, Lemma 26.21.2. Note that the composition $(g_ i, g\'_ i) \\circ f_ i : T \\to X \\times _ S X$ is a morphism into $W$ because it factors through the diagonal by assumption. Set $Z_{i\'} = (g_{i\'}, g\'_{i\'})^{-1}(X \\times _ S X \\setminus W)$. If each $Z_{i\'}$ is nonempty, then by Lemma 32.4.8 there exists a point $t \\in T$ which maps to $Z_{i\'}$ for all $i\' \\geq i$. This is a contradiction with the fact that $T$ maps into $W$. Hence we may increase $i$ and assume that $(g_ i, g\'_ i) : T_ i \\to X \\times _ S X$ is a morphism into $W$. By construction of $W$, and since $T_ i$ is quasi-compact we can find a finite affine open covering $T_ i = T_{1, i} \\cup \\ldots \\cup T_{n, i}$ such that $(g_ i, g\'_ i)|_{T_{j, i}}$ is a morphism into $U \\times _ V U$ for some pair $(U, V)$ as in the definition of $W$ above. Since it suffices to prove that $g_{i\'}$ and $g\'_{i\'}$ agree on each of the $f_{i\'i}^{-1}(T_{j, i})$ this reduces us to the affine case. The affine case follows from Algebra, Lemma 10.127.3 and the fact that the ring map $\\mathcal{O}_ S(V) \\to \\mathcal{O}_ X(U)$ is of finite presentation (see Morphisms, Lemma 29.21.2). \n    \n      Finally, we prove the existence part (b). Let $g : T \\to X$ be a morphism of schemes over $S$. We can find a finite affine open covering $T = W_1 \\cup \\ldots \\cup W_ n$ such that for each $j \\in \\{ 1, \\ldots , n\\} $ there exist affine opens $U_ j \\subset X$ and $V_ j \\subset S$ with $f(U_ j) \\subset V_ j$ and $g(W_ j) \\subset U_ j$. By Lemmas 32.4.11 and 32.4.13 (after possibly shrinking $I$) we may assume that there exist affine open coverings $T_ i = W_{1, i} \\cup \\ldots \\cup W_{n, i}$ compatible with transition maps such that $W_ j = \\mathop{\\mathrm{lim}}\\nolimits _ i W_{j, i}$. We apply Algebra, Lemma 10.127.3 to the rings corresponding to the affine schemes $U_ j$, $V_ j$, $W_{j, i}$ and $W_ j$ using that $\\mathcal{O}_ S(V_ j) \\to \\mathcal{O}_ X(U_ j)$ is of finite presentation (see Morphisms, Lemma 29.21.2). Thus we can find for each $j$ an index $i_ j \\in I$ and a morphism $g_{j, i_ j} : W_{j, i_ j} \\to X$ such that $g_{j, i_ j} \\circ f_ i|_{W_ j} : W_ j \\to W_{j, i} \\to X$ equals $g|_{W_ j}$. By part (a) proved above, using the quasi-compactness of $W_{j_1, i} \\cap W_{j_2, i}$ which follows as $T_ i$ is quasi-separated, we can find an index $i\' \\in I$ larger than all $i_ j$ such that \n    \n      \n  \\[  g_{j_1, i_{j_1}} \\circ f_{i\'i_{j_1}}|_{W_{j_1, i\'} \\cap W_{j_2, i\'}} = g_{j_2, i_{j_2}} \\circ f_{i\'i_{j_2}}|_{W_{j_1, i\'} \\cap W_{j_2, i\'}}  \\]\n\n    \n       for all $j_1, j_2 \\in \\{ 1, \\ldots , n\\} $. Hence the morphisms $g_{j, i_ j} \\circ f_{i\'i_ j}|_{W_{j, i\'}}$ glue to given the desired morphism $T_{i\'} \\to X$. \n      $\\square$\n    \n","\n       \n      \n  Proposition 32.6.1. Let $f : X \\to S$ be a morphism of schemes. The following are equivalent: \n  \n  \nThe morphism $f$ is locally of finite presentation. \n\n\nFor any directed set $I$, and any inverse system $(T_ i, f_{ii\'})$ of $S$-schemes over $I$ with each $T_ i$ affine, we have \n\n\n  \\[  \\mathop{\\mathrm{Mor}}\\nolimits _ S(\\mathop{\\mathrm{lim}}\\nolimits _ i T_ i, X) = \\mathop{\\mathrm{colim}}\\nolimits _ i \\mathop{\\mathrm{Mor}}\\nolimits _ S(T_ i, X)  \\]\n\n\nFor any directed set $I$, and any inverse system $(T_ i, f_{ii\'})$ of $S$-schemes over $I$ with each $f_{ii\'}$ affine and every $T_ i$ quasi-compact and quasi-separated as a scheme, we have \n\n\n  \\[  \\mathop{\\mathrm{Mor}}\\nolimits _ S(\\mathop{\\mathrm{lim}}\\nolimits _ i T_ i, X) = \\mathop{\\mathrm{colim}}\\nolimits _ i \\mathop{\\mathrm{Mor}}\\nolimits _ S(T_ i, X)  \\]\n\n\n\n\n    \n","Proof.\n      It is clear that (3) implies (2). \n    \n      Let us prove that (2) implies (1). Assume (2). Choose any affine opens $U \\subset X$ and $V \\subset S$ such that $f(U) \\subset V$. We have to show that $\\mathcal{O}_ S(V) \\to \\mathcal{O}_ X(U)$ is of finite presentation. Let $(A_ i, \\varphi _{ii\'})$ be a directed system of $\\mathcal{O}_ S(V)$-algebras. Set $A = \\mathop{\\mathrm{colim}}\\nolimits _ i A_ i$. According to Algebra, Lemma 10.127.3 we have to show that \n    \n      \n  \\[  \\mathop{\\mathrm{Hom}}\\nolimits _{\\mathcal{O}_ S(V)}(\\mathcal{O}_ X(U), A) = \\mathop{\\mathrm{colim}}\\nolimits _ i \\mathop{\\mathrm{Hom}}\\nolimits _{\\mathcal{O}_ S(V)}(\\mathcal{O}_ X(U), A_ i)  \\]\n\n    \n       Consider the schemes $T_ i = \\mathop{\\mathrm{Spec}}(A_ i)$. They form an inverse system of $V$-schemes over $I$ with transition morphisms $f_{ii\'} : T_ i \\to T_{i\'}$ induced by the $\\mathcal{O}_ S(V)$-algebra maps $\\varphi _{i\'i}$. Set $T := \\mathop{\\mathrm{Spec}}(A) = \\mathop{\\mathrm{lim}}\\nolimits _ i T_ i$. The formula above becomes in terms of morphism sets of schemes \n    \n      \n  \\[  \\mathop{\\mathrm{Mor}}\\nolimits _ V(\\mathop{\\mathrm{lim}}\\nolimits _ i T_ i, U) = \\mathop{\\mathrm{colim}}\\nolimits _ i \\mathop{\\mathrm{Mor}}\\nolimits _ V(T_ i, U).  \\]\n\n    \n       We first observe that $\\mathop{\\mathrm{Mor}}\\nolimits _ V(T_ i, U) = \\mathop{\\mathrm{Mor}}\\nolimits _ S(T_ i, U)$ and $\\mathop{\\mathrm{Mor}}\\nolimits _ V(T, U) = \\mathop{\\mathrm{Mor}}\\nolimits _ S(T, U)$. Hence we have to show that \n    \n      \n  \\[  \\mathop{\\mathrm{Mor}}\\nolimits _ S(\\mathop{\\mathrm{lim}}\\nolimits _ i T_ i, U) = \\mathop{\\mathrm{colim}}\\nolimits _ i \\mathop{\\mathrm{Mor}}\\nolimits _ S(T_ i, U)  \\]\n\n    \n       and we are given that \n    \n      \n  \\[  \\mathop{\\mathrm{Mor}}\\nolimits _ S(\\mathop{\\mathrm{lim}}\\nolimits _ i T_ i, X) = \\mathop{\\mathrm{colim}}\\nolimits _ i \\mathop{\\mathrm{Mor}}\\nolimits _ S(T_ i, X).  \\]\n\n    \n       Hence it suffices to prove that given a morphism $g_ i : T_ i \\to X$ over $S$ such that the composition $T \\to T_ i \\to X$ ends up in $U$ there exists some $i\' \\geq i$ such that the composition $g_{i\'} : T_{i\'} \\to T_ i \\to X$ ends up in $U$. Denote $Z_{i\'} = g_{i\'}^{-1}(X \\setminus U)$. Assume each $Z_{i\'}$ is nonempty to get a contradiction. By Lemma 32.4.8 there exists a point $t$ of $T$ which is mapped into $Z_{i\'}$ for all $i\' \\geq i$. Such a point is not mapped into $U$. A contradiction. \n    \n      Finally, let us prove that (1) implies (3). Assume (1). Let an inverse directed system $(T_ i, f_{ii\'})$ of $S$-schemes be given. Assume the morphisms $f_{ii\'}$ are affine and each $T_ i$ is quasi-compact and quasi-separated as a scheme. Let $T = \\mathop{\\mathrm{lim}}\\nolimits _ i T_ i$. Denote $f_ i : T \\to T_ i$ the projection morphisms. We have to show: \n    \n      \n  \nGiven morphisms $g_ i, g\'_ i : T_ i \\to X$ over $S$ such that $g_ i \\circ f_ i = g\'_ i \\circ f_ i$, then there exists an $i\' \\geq i$ such that $g_ i \\circ f_{i\'i} = g\'_ i \\circ f_{i\'i}$. \n\n\nGiven any morphism $g : T \\to X$ over $S$ there exists an $i \\in I$ and a morphism $g_ i : T_ i \\to X$ such that $g = f_ i \\circ g_ i$. \n\n\n\n    \n      First let us prove the uniqueness part (a). Let $g_ i, g\'_ i : T_ i \\to X$ be morphisms such that $g_ i \\circ f_ i = g\'_ i \\circ f_ i$. For any $i\' \\geq i$ we set $g_{i\'} = g_ i \\circ f_{i\'i}$ and $g\'_{i\'} = g\'_ i \\circ f_{i\'i}$. We also set $g = g_ i \\circ f_ i = g\'_ i \\circ f_ i$. Consider the morphism $(g_ i, g\'_ i) : T_ i \\to X \\times _ S X$. Set \n    \n      \n  \\[  W = \\bigcup \\nolimits _{U \\subset X\\text{ affine open}, V \\subset S\\text{ affine open}, f(U) \\subset V} U \\times _ V U.  \\]\n\n    \n       This is an open in $X \\times _ S X$, with the property that the morphism $\\Delta _{X/S}$ factors through a closed immersion into $W$, see the proof of Schemes, Lemma 26.21.2. Note that the composition $(g_ i, g\'_ i) \\circ f_ i : T \\to X \\times _ S X$ is a morphism into $W$ because it factors through the diagonal by assumption. Set $Z_{i\'} = (g_{i\'}, g\'_{i\'})^{-1}(X \\times _ S X \\setminus W)$. If each $Z_{i\'}$ is nonempty, then by Lemma 32.4.8 there exists a point $t \\in T$ which maps to $Z_{i\'}$ for all $i\' \\geq i$. This is a contradiction with the fact that $T$ maps into $W$. Hence we may increase $i$ and assume that $(g_ i, g\'_ i) : T_ i \\to X \\times _ S X$ is a morphism into $W$. By construction of $W$, and since $T_ i$ is quasi-compact we can find a finite affine open covering $T_ i = T_{1, i} \\cup \\ldots \\cup T_{n, i}$ such that $(g_ i, g\'_ i)|_{T_{j, i}}$ is a morphism into $U \\times _ V U$ for some pair $(U, V)$ as in the definition of $W$ above. Since it suffices to prove that $g_{i\'}$ and $g\'_{i\'}$ agree on each of the $f_{i\'i}^{-1}(T_{j, i})$ this reduces us to the affine case. The affine case follows from Algebra, Lemma 10.127.3 and the fact that the ring map $\\mathcal{O}_ S(V) \\to \\mathcal{O}_ X(U)$ is of finite presentation (see Morphisms, Lemma 29.21.2). \n    \n      Finally, we prove the existence part (b). Let $g : T \\to X$ be a morphism of schemes over $S$. We can find a finite affine open covering $T = W_1 \\cup \\ldots \\cup W_ n$ such that for each $j \\in \\{ 1, \\ldots , n\\} $ there exist affine opens $U_ j \\subset X$ and $V_ j \\subset S$ with $f(U_ j) \\subset V_ j$ and $g(W_ j) \\subset U_ j$. By Lemmas 32.4.11 and 32.4.13 (after possibly shrinking $I$) we may assume that there exist affine open coverings $T_ i = W_{1, i} \\cup \\ldots \\cup W_{n, i}$ compatible with transition maps such that $W_ j = \\mathop{\\mathrm{lim}}\\nolimits _ i W_{j, i}$. We apply Algebra, Lemma 10.127.3 to the rings corresponding to the affine schemes $U_ j$, $V_ j$, $W_{j, i}$ and $W_ j$ using that $\\mathcal{O}_ S(V_ j) \\to \\mathcal{O}_ X(U_ j)$ is of finite presentation (see Morphisms, Lemma 29.21.2). Thus we can find for each $j$ an index $i_ j \\in I$ and a morphism $g_{j, i_ j} : W_{j, i_ j} \\to X$ such that $g_{j, i_ j} \\circ f_ i|_{W_ j} : W_ j \\to W_{j, i} \\to X$ equals $g|_{W_ j}$. By part (a) proved above, using the quasi-compactness of $W_{j_1, i} \\cap W_{j_2, i}$ which follows as $T_ i$ is quasi-separated, we can find an index $i\' \\in I$ larger than all $i_ j$ such that \n    \n      \n  \\[  g_{j_1, i_{j_1}} \\circ f_{i\'i_{j_1}}|_{W_{j_1, i\'} \\cap W_{j_2, i\'}} = g_{j_2, i_{j_2}} \\circ f_{i\'i_{j_2}}|_{W_{j_1, i\'} \\cap W_{j_2, i\'}}  \\]\n\n    \n       for all $j_1, j_2 \\in \\{ 1, \\ldots , n\\} $. Hence the morphisms $g_{j, i_ j} \\circ f_{i\'i_ j}|_{W_{j, i\'}}$ glue to given the desired morphism $T_{i\'} \\to X$. \n      $\\square$\n    \n"," by
  let o := IsCofiltered.min i j
  obtain âŸ¨k, hik, heqâŸ© := Scheme.exists_hom_comp_eq_comp_of_locallyOfFiniteType D t f c hc
    (D.map (IsCofiltered.minToLeft i j) â‰« a) (D.map (IsCofiltered.minToRight i j) â‰« b)
    (by simp [â† ha])
    (by simp [â† hb]) (by simpa)
  use k, hik â‰« IsCofiltered.minToLeft i j, hik â‰« IsCofiltered.minToRight i j
  simpa using heq
","lemma Scheme.exists_hom_hom_comp_eq_comp_of_locallyOfFiniteType
    {i : I} (a : D.obj i âŸ¶ X) (ha : t.app i = a â‰« f)
    {j : I} (b : D.obj j âŸ¶ X) (hb : t.app j = b â‰« f)
    (hab : c.Ï€.app i â‰« a = c.Ï€.app j â‰« b) :
    âˆƒ (k : I) (hik : k âŸ¶ i) (hjk : k âŸ¶ j),
      D.map hik â‰« a = D.map hjk â‰« b ","Proof.\n      It is clear that (3) implies (2). \n    \n      Let us prove that (2) implies (1). Assume (2). Choose any affine opens $U \\subset X$ and $V \\subset S$ such that $f(U) \\subset V$. We have to show that $\\mathcal{O}_ S(V) \\to \\mathcal{O}_ X(U)$ is of finite presentation. Let $(A_ i, \\varphi _{ii\'})$ be a directed system of $\\mathcal{O}_ S(V)$-algebras. Set $A = \\mathop{\\mathrm{colim}}\\nolimits _ i A_ i$. According to Algebra, Lemma 10.127.3 [[\n  Lemma 10.127.3. Let $\\varphi : R \\to S$ be a ring map. The following are equivalent \n  \n  \n$\\varphi $ is of finite presentation, \n\n\nfor every directed system $A_\\lambda $ of $R$-algebras the map \n\n\n  \\[  \\mathop{\\mathrm{colim}}\\nolimits _\\lambda \\mathop{\\mathrm{Hom}}\\nolimits _ R(S, A_\\lambda ) \\longrightarrow \\mathop{\\mathrm{Hom}}\\nolimits _ R(S, \\mathop{\\mathrm{colim}}\\nolimits _\\lambda A_\\lambda )  \\]\n\n\n is bijective, and \n\n\nfor every directed system $A_\\lambda $ of $R$-algebras the map \n\n\n  \\[  \\mathop{\\mathrm{colim}}\\nolimits _\\lambda \\mathop{\\mathrm{Hom}}\\nolimits _ R(S, A_\\lambda ) \\longrightarrow \\mathop{\\mathrm{Hom}}\\nolimits _ R(S, \\mathop{\\mathrm{colim}}\\nolimits _\\lambda A_\\lambda )  \\]\n\n\n is surjective. \n\n\n\n\n    \n]] we have to show that \n    \n      \n  \\[  \\mathop{\\mathrm{Hom}}\\nolimits _{\\mathcal{O}_ S(V)}(\\mathcal{O}_ X(U), A) = \\mathop{\\mathrm{colim}}\\nolimits _ i \\mathop{\\mathrm{Hom}}\\nolimits _{\\mathcal{O}_ S(V)}(\\mathcal{O}_ X(U), A_ i)  \\]\n\n    \n       Consider the schemes $T_ i = \\mathop{\\mathrm{Spec}}(A_ i)$. They form an inverse system of $V$-schemes over $I$ with transition morphisms $f_{ii\'} : T_ i \\to T_{i\'}$ induced by the $\\mathcal{O}_ S(V)$-algebra maps $\\varphi _{i\'i}$. Set $T := \\mathop{\\mathrm{Spec}}(A) = \\mathop{\\mathrm{lim}}\\nolimits _ i T_ i$. The formula above becomes in terms of morphism sets of schemes \n    \n      \n  \\[  \\mathop{\\mathrm{Mor}}\\nolimits _ V(\\mathop{\\mathrm{lim}}\\nolimits _ i T_ i, U) = \\mathop{\\mathrm{colim}}\\nolimits _ i \\mathop{\\mathrm{Mor}}\\nolimits _ V(T_ i, U).  \\]\n\n    \n       We first observe that $\\mathop{\\mathrm{Mor}}\\nolimits _ V(T_ i, U) = \\mathop{\\mathrm{Mor}}\\nolimits _ S(T_ i, U)$ and $\\mathop{\\mathrm{Mor}}\\nolimits _ V(T, U) = \\mathop{\\mathrm{Mor}}\\nolimits _ S(T, U)$. Hence we have to show that \n    \n      \n  \\[  \\mathop{\\mathrm{Mor}}\\nolimits _ S(\\mathop{\\mathrm{lim}}\\nolimits _ i T_ i, U) = \\mathop{\\mathrm{colim}}\\nolimits _ i \\mathop{\\mathrm{Mor}}\\nolimits _ S(T_ i, U)  \\]\n\n    \n       and we are given that \n    \n      \n  \\[  \\mathop{\\mathrm{Mor}}\\nolimits _ S(\\mathop{\\mathrm{lim}}\\nolimits _ i T_ i, X) = \\mathop{\\mathrm{colim}}\\nolimits _ i \\mathop{\\mathrm{Mor}}\\nolimits _ S(T_ i, X).  \\]\n\n    \n       Hence it suffices to prove that given a morphism $g_ i : T_ i \\to X$ over $S$ such that the composition $T \\to T_ i \\to X$ ends up in $U$ there exists some $i\' \\geq i$ such that the composition $g_{i\'} : T_{i\'} \\to T_ i \\to X$ ends up in $U$. Denote $Z_{i\'} = g_{i\'}^{-1}(X \\setminus U)$. Assume each $Z_{i\'}$ is nonempty to get a contradiction. By Lemma 32.4.8 [[\n  Lemma 32.4.8. In Situation 32.4.5. Suppose for each $i$ we are given a nonempty closed subset $Z_ i \\subset S_ i$ with $f_{i\'i}(Z_{i\'}) \\subset Z_ i$ for all $i\' \\geq i$. Then there exists a point $s \\in S$ with $f_ i(s) \\in Z_ i$ for all $i$. \n\n    \n]] there exists a point $t$ of $T$ which is mapped into $Z_{i\'}$ for all $i\' \\geq i$. Such a point is not mapped into $U$. A contradiction. \n    \n      Finally, let us prove that (1) implies (3). Assume (1). Let an inverse directed system $(T_ i, f_{ii\'})$ of $S$-schemes be given. Assume the morphisms $f_{ii\'}$ are affine and each $T_ i$ is quasi-compact and quasi-separated as a scheme. Let $T = \\mathop{\\mathrm{lim}}\\nolimits _ i T_ i$. Denote $f_ i : T \\to T_ i$ the projection morphisms. We have to show: \n    \n      \n  \nGiven morphisms $g_ i, g\'_ i : T_ i \\to X$ over $S$ such that $g_ i \\circ f_ i = g\'_ i \\circ f_ i$, then there exists an $i\' \\geq i$ such that $g_ i \\circ f_{i\'i} = g\'_ i \\circ f_{i\'i}$. \n\n\nGiven any morphism $g : T \\to X$ over $S$ there exists an $i \\in I$ and a morphism $g_ i : T_ i \\to X$ such that $g = f_ i \\circ g_ i$. \n\n\n\n    \n      First let us prove the uniqueness part (a). Let $g_ i, g\'_ i : T_ i \\to X$ be morphisms such that $g_ i \\circ f_ i = g\'_ i \\circ f_ i$. For any $i\' \\geq i$ we set $g_{i\'} = g_ i \\circ f_{i\'i}$ and $g\'_{i\'} = g\'_ i \\circ f_{i\'i}$. We also set $g = g_ i \\circ f_ i = g\'_ i \\circ f_ i$. Consider the morphism $(g_ i, g\'_ i) : T_ i \\to X \\times _ S X$. Set \n    \n      \n  \\[  W = \\bigcup \\nolimits _{U \\subset X\\text{ affine open}, V \\subset S\\text{ affine open}, f(U) \\subset V} U \\times _ V U.  \\]\n\n    \n       This is an open in $X \\times _ S X$, with the property that the morphism $\\Delta _{X/S}$ factors through a closed immersion into $W$, see the proof of Schemes, Lemma 26.21.2 [[\n       \n      \n  Lemma 26.21.2. Let $X$ be a scheme over $S$. The diagonal morphism $\\Delta _{X/S}$ is an immersion. \n\n    \n]]. Note that the composition $(g_ i, g\'_ i) \\circ f_ i : T \\to X \\times _ S X$ is a morphism into $W$ because it factors through the diagonal by assumption. Set $Z_{i\'} = (g_{i\'}, g\'_{i\'})^{-1}(X \\times _ S X \\setminus W)$. If each $Z_{i\'}$ is nonempty, then by Lemma 32.4.8 [[\n  Lemma 32.4.8. In Situation 32.4.5. Suppose for each $i$ we are given a nonempty closed subset $Z_ i \\subset S_ i$ with $f_{i\'i}(Z_{i\'}) \\subset Z_ i$ for all $i\' \\geq i$. Then there exists a point $s \\in S$ with $f_ i(s) \\in Z_ i$ for all $i$. \n\n    \n]] there exists a point $t \\in T$ which maps to $Z_{i\'}$ for all $i\' \\geq i$. This is a contradiction with the fact that $T$ maps into $W$. Hence we may increase $i$ and assume that $(g_ i, g\'_ i) : T_ i \\to X \\times _ S X$ is a morphism into $W$. By construction of $W$, and since $T_ i$ is quasi-compact we can find a finite affine open covering $T_ i = T_{1, i} \\cup \\ldots \\cup T_{n, i}$ such that $(g_ i, g\'_ i)|_{T_{j, i}}$ is a morphism into $U \\times _ V U$ for some pair $(U, V)$ as in the definition of $W$ above. Since it suffices to prove that $g_{i\'}$ and $g\'_{i\'}$ agree on each of the $f_{i\'i}^{-1}(T_{j, i})$ this reduces us to the affine case. The affine case follows from Algebra, Lemma 10.127.3 [[\n  Lemma 10.127.3. Let $\\varphi : R \\to S$ be a ring map. The following are equivalent \n  \n  \n$\\varphi $ is of finite presentation, \n\n\nfor every directed system $A_\\lambda $ of $R$-algebras the map \n\n\n  \\[  \\mathop{\\mathrm{colim}}\\nolimits _\\lambda \\mathop{\\mathrm{Hom}}\\nolimits _ R(S, A_\\lambda ) \\longrightarrow \\mathop{\\mathrm{Hom}}\\nolimits _ R(S, \\mathop{\\mathrm{colim}}\\nolimits _\\lambda A_\\lambda )  \\]\n\n\n is bijective, and \n\n\nfor every directed system $A_\\lambda $ of $R$-algebras the map \n\n\n  \\[  \\mathop{\\mathrm{colim}}\\nolimits _\\lambda \\mathop{\\mathrm{Hom}}\\nolimits _ R(S, A_\\lambda ) \\longrightarrow \\mathop{\\mathrm{Hom}}\\nolimits _ R(S, \\mathop{\\mathrm{colim}}\\nolimits _\\lambda A_\\lambda )  \\]\n\n\n is surjective. \n\n\n\n\n    \n]] and the fact that the ring map $\\mathcal{O}_ S(V) \\to \\mathcal{O}_ X(U)$ is of finite presentation (see Morphisms, Lemma 29.21.2 [[\n  Lemma 29.21.2. Let $f : X \\to S$ be a morphism of schemes. The following are equivalent \n  \n  \nThe morphism $f$ is locally of finite presentation. \n\n\nFor every affine opens $U \\subset X$, $V \\subset S$ with $f(U) \\subset V$ the ring map $\\mathcal{O}_ S(V) \\to \\mathcal{O}_ X(U)$ is of finite presentation. \n\n\nThere exist an open covering $S = \\bigcup _{j \\in J} V_ j$ and open coverings $f^{-1}(V_ j) = \\bigcup _{i \\in I_ j} U_ i$ such that each of the morphisms $U_ i \\to V_ j$, $j\\in J, i\\in I_ j$ is locally of finite presentation. \n\n\nThere exist an affine open covering $S = \\bigcup _{j \\in J} V_ j$ and affine open coverings $f^{-1}(V_ j) = \\bigcup _{i \\in I_ j} U_ i$ such that the ring map $\\mathcal{O}_ S(V_ j) \\to \\mathcal{O}_ X(U_ i)$ is of finite presentation, for all $j\\in J, i\\in I_ j$. \n\n\n\n   Moreover, if $f$ is locally of finite presentation then for any open subschemes $U \\subset X$, $V \\subset S$ with $f(U) \\subset V$ the restriction $f|_ U : U \\to V$ is locally of finite presentation. \n\n    \n]]). \n    \n      Finally, we prove the existence part (b). Let $g : T \\to X$ be a morphism of schemes over $S$. We can find a finite affine open covering $T = W_1 \\cup \\ldots \\cup W_ n$ such that for each $j \\in \\{ 1, \\ldots , n\\} $ there exist affine opens $U_ j \\subset X$ and $V_ j \\subset S$ with $f(U_ j) \\subset V_ j$ and $g(W_ j) \\subset U_ j$. By Lemmas 32.4.11 [[\n  Lemma 32.4.11. In Situation 32.4.5 we have the following: \n  \n  \nGiven any quasi-compact open $V \\subset S = \\mathop{\\mathrm{lim}}\\nolimits _ i S_ i$ there exists an $i \\in I$ and a quasi-compact open $V_ i \\subset S_ i$ such that $f_ i^{-1}(V_ i) = V$. \n\n\nGiven $V_ i \\subset S_ i$ and $V_{i\'} \\subset S_{i\'}$ quasi-compact opens such that $f_ i^{-1}(V_ i) = f_{i\'}^{-1}(V_{i\'})$ there exists an index $i\'\' \\geq i, i\'$ such that $f_{i\'\'i}^{-1}(V_ i) = f_{i\'\'i\'}^{-1}(V_{i\'})$. \n\n\nIf $V_{1, i}, \\ldots , V_{n, i} \\subset S_ i$ are quasi-compact opens and $S = f_ i^{-1}(V_{1, i}) \\cup \\ldots \\cup f_ i^{-1}(V_{n, i})$ then $S_{i\'} = f_{i\'i}^{-1}(V_{1, i}) \\cup \\ldots \\cup f_{i\'i}^{-1}(V_{n, i})$ for some $i\' \\geq i$. \n\n\n\n\n    \n]] and 32.4.13 [[\n  Lemma 32.4.13. In Situation 32.4.5 if $S$ is affine, then for some $i_0 \\in I$ the schemes $S_ i$ for $i \\geq i_0$ are affine. \n\n    \n]] (after possibly shrinking $I$) we may assume that there exist affine open coverings $T_ i = W_{1, i} \\cup \\ldots \\cup W_{n, i}$ compatible with transition maps such that $W_ j = \\mathop{\\mathrm{lim}}\\nolimits _ i W_{j, i}$. We apply Algebra, Lemma 10.127.3 [[\n  Lemma 10.127.3. Let $\\varphi : R \\to S$ be a ring map. The following are equivalent \n  \n  \n$\\varphi $ is of finite presentation, \n\n\nfor every directed system $A_\\lambda $ of $R$-algebras the map \n\n\n  \\[  \\mathop{\\mathrm{colim}}\\nolimits _\\lambda \\mathop{\\mathrm{Hom}}\\nolimits _ R(S, A_\\lambda ) \\longrightarrow \\mathop{\\mathrm{Hom}}\\nolimits _ R(S, \\mathop{\\mathrm{colim}}\\nolimits _\\lambda A_\\lambda )  \\]\n\n\n is bijective, and \n\n\nfor every directed system $A_\\lambda $ of $R$-algebras the map \n\n\n  \\[  \\mathop{\\mathrm{colim}}\\nolimits _\\lambda \\mathop{\\mathrm{Hom}}\\nolimits _ R(S, A_\\lambda ) \\longrightarrow \\mathop{\\mathrm{Hom}}\\nolimits _ R(S, \\mathop{\\mathrm{colim}}\\nolimits _\\lambda A_\\lambda )  \\]\n\n\n is surjective. \n\n\n\n\n    \n]] to the rings corresponding to the affine schemes $U_ j$, $V_ j$, $W_{j, i}$ and $W_ j$ using that $\\mathcal{O}_ S(V_ j) \\to \\mathcal{O}_ X(U_ j)$ is of finite presentation (see Morphisms, Lemma 29.21.2 [[\n  Lemma 29.21.2. Let $f : X \\to S$ be a morphism of schemes. The following are equivalent \n  \n  \nThe morphism $f$ is locally of finite presentation. \n\n\nFor every affine opens $U \\subset X$, $V \\subset S$ with $f(U) \\subset V$ the ring map $\\mathcal{O}_ S(V) \\to \\mathcal{O}_ X(U)$ is of finite presentation. \n\n\nThere exist an open covering $S = \\bigcup _{j \\in J} V_ j$ and open coverings $f^{-1}(V_ j) = \\bigcup _{i \\in I_ j} U_ i$ such that each of the morphisms $U_ i \\to V_ j$, $j\\in J, i\\in I_ j$ is locally of finite presentation. \n\n\nThere exist an affine open covering $S = \\bigcup _{j \\in J} V_ j$ and affine open coverings $f^{-1}(V_ j) = \\bigcup _{i \\in I_ j} U_ i$ such that the ring map $\\mathcal{O}_ S(V_ j) \\to \\mathcal{O}_ X(U_ i)$ is of finite presentation, for all $j\\in J, i\\in I_ j$. \n\n\n\n   Moreover, if $f$ is locally of finite presentation then for any open subschemes $U \\subset X$, $V \\subset S$ with $f(U) \\subset V$ the restriction $f|_ U : U \\to V$ is locally of finite presentation. \n\n    \n]]). Thus we can find for each $j$ an index $i_ j \\in I$ and a morphism $g_{j, i_ j} : W_{j, i_ j} \\to X$ such that $g_{j, i_ j} \\circ f_ i|_{W_ j} : W_ j \\to W_{j, i} \\to X$ equals $g|_{W_ j}$. By part (a) proved above, using the quasi-compactness of $W_{j_1, i} \\cap W_{j_2, i}$ which follows as $T_ i$ is quasi-separated, we can find an index $i\' \\in I$ larger than all $i_ j$ such that \n    \n      \n  \\[  g_{j_1, i_{j_1}} \\circ f_{i\'i_{j_1}}|_{W_{j_1, i\'} \\cap W_{j_2, i\'}} = g_{j_2, i_{j_2}} \\circ f_{i\'i_{j_2}}|_{W_{j_1, i\'} \\cap W_{j_2, i\'}}  \\]\n\n    \n       for all $j_1, j_2 \\in \\{ 1, \\ldots , n\\} $. Hence the morphisms $g_{j, i_ j} \\circ f_{i\'i_ j}|_{W_{j, i\'}}$ glue to given the desired morphism $T_{i\'} \\to X$. \n      $\\square$\n    \n"
11,01Z5,"lemma Scheme.exists_isQuasiAffine_of_isLimit [IsCofiltered I]
    [âˆ€ {i j} (f : i âŸ¶ j), IsAffineHom (D.map f)]
    [âˆ€ (i : I), CompactSpace (D.obj i)]
    [âˆ€ (i : I), QuasiSeparatedSpace (D.obj i)]
    [IsQuasiAffine c.pt] :
    âˆƒ i, IsQuasiAffine (D.obj i) := by
  classical
  have (x : c.pt) : âˆƒ (i : I) (f : Î“(D.obj i, âŠ¤)),
      IsAffineOpen (Scheme.basicOpen _ f) âˆ§ c.Ï€.app i x âˆˆ (Scheme.basicOpen _ f) := by
    obtain âŸ¨iâŸ© := IsCofiltered.nonempty (C := I)
    obtain âŸ¨_, âŸ¨U, hU, rflâŸ©, hxU, -âŸ© := (D.obj i).isBasis_affineOpens.exists_subset_of_mem_open
      (Set.mem_univ (c.Ï€.app i x)) isOpen_univ
    obtain âŸ¨_, âŸ¨_, âŸ¨r, hr, rflâŸ©, rflâŸ©, hxr, hrUâŸ© :=
      (IsQuasiAffine.isBasis_basicOpen c.pt).exists_subset_of_mem_open hxU (c.Ï€.app i â»Â¹áµ U).isOpen
    obtain âŸ¨j, r, rflâŸ© := exists_appTop_Ï€_eq_of_isLimit D c hc r
    obtain âŸ¨k, fki, fkj, -âŸ© := IsCofilteredOrEmpty.cone_objs i j
    obtain âŸ¨l, flk, hlâŸ© := exists_map_preimage_le_map_preimage D c hc (isCompact_basicOpen _
      isCompact_univ ((D.map fkj).appTop r)) (V := D.map fki â»Â¹áµ U) (by
        rwa [â† preimage_basicOpen_top, â† Hom.comp_preimage, â† Hom.comp_preimage,
          c.w, c.w, preimage_basicOpen_top])
    refine âŸ¨l, (D.map (flk â‰« fkj)).appTop r, ?_, ?_âŸ©
    Â· convert (hU.preimage (D.map (flk â‰« fki))).basicOpen
        ((D.obj _).presheaf.map (homOfLE le_top).op ((D.map (flk â‰« fkj)).appTop r)) using 1
      rwa [Scheme.basicOpen_res, eq_comm, inf_eq_right, Functor.map_comp,
        elementwise_of% Scheme.Hom.comp_appTop, â† Scheme.preimage_basicOpen_top, Functor.map_comp,
        Scheme.Hom.comp_preimage]
    Â· change x âˆˆ c.Ï€.app l â»Â¹áµ (D.obj l).basicOpen _
      rwa [Scheme.preimage_basicOpen_top, â† elementwise_of% Scheme.Hom.comp_appTop, Cone.w]
  choose i f hf hi using this
  obtain âŸ¨Ïƒ, hÏƒâŸ© := CompactSpace.elim_nhds_subcover
    (fun x â†¦ (((c.Ï€.app (i x)) â»Â¹áµ (D.obj (i x)).basicOpen (f x)).1))
    (fun x â†¦ ((c.Ï€.app (i x)) â»Â¹áµ (D.obj (i x)).basicOpen (f x)).2.mem_nhds (by exact hi x))
  choose Ïƒi hÏƒiÏƒ hÏƒi using fun x â†¦ Set.mem_iUnionâ‚‚.mp (hÏƒ.ge (Set.mem_univ x))
  obtain âŸ¨j, fjâŸ© := IsCofiltered.inf_objs_exists (Ïƒ.image i)
  replace fj := fun i h â†¦ (@fj i h).some
  obtain âŸ¨k, fkj, hkâŸ© := exists_map_eq_top D c hc
    (â¨† k, D.map (fj _ (Finset.mem_image_of_mem i (hÏƒiÏƒ k))) â»Â¹áµ (D.obj (i _)).basicOpen (f _)) (by
      refine top_le_iff.mp fun x _ â†¦ TopologicalSpace.Opens.mem_iSup.mpr âŸ¨x, ?_âŸ©
      change (c.Ï€.app j â‰« D.map _).base x âˆˆ (D.obj (i (Ïƒi x))).basicOpen (f (Ïƒi x))
      rw [Cone.w]
      exact hÏƒi _)
  refine âŸ¨k, .of_forall_exists_mem_basicOpen _ fun x â†¦ ?_âŸ©
  obtain âŸ¨y, hyâŸ© := TopologicalSpace.Opens.mem_iSup.mp (hk.ge (Set.mem_univ x))
  use (D.map fkj).appTop ((D.map (fj _ (Finset.mem_image_of_mem i (hÏƒiÏƒ y)))).appTop (f _))
  rw [â† Scheme.preimage_basicOpen_top, â† Scheme.preimage_basicOpen_top]
  exact âŸ¨((hf _).preimage _).preimage _, hyâŸ©
",Formal Proof of Stacks Project Tag 01Z5,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/AffineTransitionLimit.lean#L938-L983,Q27041,,32.4.12,lemma,3.0,"['081A', '01YT', '0ELP']","\n  Lemma 32.4.12. In Situation 32.4.5 if $S$ is quasi-affine, then for some $i_0 \\in I$ the schemes $S_ i$ for $i \\geq i_0$ are quasi-affine. \n\n    \n      Proof.\n      Choose $i_0 \\in I$. Note that $I$ is nonempty as the limit is directed. For convenience we write $S_0 = S_{i_0}$ and $i_0 = 0$. Let $s \\in S$. We may choose an affine open $U_0 \\subset S_0$ containing $f_0(s)$. Since $S$ is quasi-affine we may choose an element $a \\in \\Gamma (S, \\mathcal{O}_ S)$ such that $s \\in D(a) \\subset f_0^{-1}(U_0)$, and such that $D(a)$ is affine. By Lemma 32.4.7 there exists an $i \\geq 0$ such that $a$ comes from an element $a_ i \\in \\Gamma (S_ i, \\mathcal{O}_{S_ i})$. For any index $j \\geq i$ we denote $a_ j$ the image of $a_ i$ in the global sections of the structure sheaf of $S_ j$. Consider the opens $D(a_ j) \\subset S_ j$ and $U_ j = f_{j0}^{-1}(U_0)$. Note that $U_ j$ is affine and $D(a_ j)$ is a quasi-compact open of $S_ j$, see Properties, Lemma 28.26.4 for example. Hence we may apply Lemma 32.4.11 to the opens $U_ j$ and $U_ j \\cup D(a_ j)$ to conclude that $D(a_ j) \\subset U_ j$ for some $j \\geq i$. For such an index $j$ we see that $D(a_ j) \\subset S_ j$ is an affine open (because $D(a_ j)$ is a standard affine open of the affine open $U_ j$) containing the image $f_ j(s)$. \n    \n      We conclude that for every $s \\in S$ there exist an index $i \\in I$, and a global section $a \\in \\Gamma (S_ i, \\mathcal{O}_{S_ i})$ such that $D(a) \\subset S_ i$ is an affine open containing $f_ i(s)$. Because $S$ is quasi-compact we may choose a single index $i \\in I$ and global sections $a_1, \\ldots , a_ m \\in \\Gamma (S_ i, \\mathcal{O}_{S_ i})$ such that each $D(a_ j) \\subset S_ i$ is affine open and such that $f_ i : S \\to S_ i$ has image contained in the union $W_ i = \\bigcup _{j = 1, \\ldots , m} D(a_ j)$. For $i\' \\geq i$ set $W_{i\'} = f_{i\'i}^{-1}(W_ i)$. Since $f_ i^{-1}(W_ i)$ is all of $S$ we see (by Lemma 32.4.11 again) that for a suitable $i\' \\geq i$ we have $S_{i\'} = W_{i\'}$. Thus we may replace $i$ by $i\'$ and assume that $S_ i = \\bigcup _{j = 1, \\ldots , m} D(a_ j)$. This implies that $\\mathcal{O}_{S_ i}$ is an ample invertible sheaf on $S_ i$ (see Properties, Definition 28.26.1) and hence that $S_ i$ is quasi-affine, see Properties, Lemma 28.27.1. Hence we win. \n      $\\square$\n    \n","\n  Lemma 32.4.12. In Situation 32.4.5 if $S$ is quasi-affine, then for some $i_0 \\in I$ the schemes $S_ i$ for $i \\geq i_0$ are quasi-affine. \n\n    \n","Proof.\n      Choose $i_0 \\in I$. Note that $I$ is nonempty as the limit is directed. For convenience we write $S_0 = S_{i_0}$ and $i_0 = 0$. Let $s \\in S$. We may choose an affine open $U_0 \\subset S_0$ containing $f_0(s)$. Since $S$ is quasi-affine we may choose an element $a \\in \\Gamma (S, \\mathcal{O}_ S)$ such that $s \\in D(a) \\subset f_0^{-1}(U_0)$, and such that $D(a)$ is affine. By Lemma 32.4.7 there exists an $i \\geq 0$ such that $a$ comes from an element $a_ i \\in \\Gamma (S_ i, \\mathcal{O}_{S_ i})$. For any index $j \\geq i$ we denote $a_ j$ the image of $a_ i$ in the global sections of the structure sheaf of $S_ j$. Consider the opens $D(a_ j) \\subset S_ j$ and $U_ j = f_{j0}^{-1}(U_0)$. Note that $U_ j$ is affine and $D(a_ j)$ is a quasi-compact open of $S_ j$, see Properties, Lemma 28.26.4 for example. Hence we may apply Lemma 32.4.11 to the opens $U_ j$ and $U_ j \\cup D(a_ j)$ to conclude that $D(a_ j) \\subset U_ j$ for some $j \\geq i$. For such an index $j$ we see that $D(a_ j) \\subset S_ j$ is an affine open (because $D(a_ j)$ is a standard affine open of the affine open $U_ j$) containing the image $f_ j(s)$. \n    \n      We conclude that for every $s \\in S$ there exist an index $i \\in I$, and a global section $a \\in \\Gamma (S_ i, \\mathcal{O}_{S_ i})$ such that $D(a) \\subset S_ i$ is an affine open containing $f_ i(s)$. Because $S$ is quasi-compact we may choose a single index $i \\in I$ and global sections $a_1, \\ldots , a_ m \\in \\Gamma (S_ i, \\mathcal{O}_{S_ i})$ such that each $D(a_ j) \\subset S_ i$ is affine open and such that $f_ i : S \\to S_ i$ has image contained in the union $W_ i = \\bigcup _{j = 1, \\ldots , m} D(a_ j)$. For $i\' \\geq i$ set $W_{i\'} = f_{i\'i}^{-1}(W_ i)$. Since $f_ i^{-1}(W_ i)$ is all of $S$ we see (by Lemma 32.4.11 again) that for a suitable $i\' \\geq i$ we have $S_{i\'} = W_{i\'}$. Thus we may replace $i$ by $i\'$ and assume that $S_ i = \\bigcup _{j = 1, \\ldots , m} D(a_ j)$. This implies that $\\mathcal{O}_{S_ i}$ is an ample invertible sheaf on $S_ i$ (see Properties, Definition 28.26.1) and hence that $S_ i$ is quasi-affine, see Properties, Lemma 28.27.1. Hence we win. \n      $\\square$\n    \n"," by
  classical
  have (x : c.pt) : âˆƒ (i : I) (f : Î“(D.obj i, âŠ¤)),
      IsAffineOpen (Scheme.basicOpen _ f) âˆ§ c.Ï€.app i x âˆˆ (Scheme.basicOpen _ f) := by
    obtain âŸ¨iâŸ© := IsCofiltered.nonempty (C := I)
    obtain âŸ¨_, âŸ¨U, hU, rflâŸ©, hxU, -âŸ© := (D.obj i).isBasis_affineOpens.exists_subset_of_mem_open
      (Set.mem_univ (c.Ï€.app i x)) isOpen_univ
    obtain âŸ¨_, âŸ¨_, âŸ¨r, hr, rflâŸ©, rflâŸ©, hxr, hrUâŸ© :=
      (IsQuasiAffine.isBasis_basicOpen c.pt).exists_subset_of_mem_open hxU (c.Ï€.app i â»Â¹áµ U).isOpen
    obtain âŸ¨j, r, rflâŸ© := exists_appTop_Ï€_eq_of_isLimit D c hc r
    obtain âŸ¨k, fki, fkj, -âŸ© := IsCofilteredOrEmpty.cone_objs i j
    obtain âŸ¨l, flk, hlâŸ© := exists_map_preimage_le_map_preimage D c hc (isCompact_basicOpen _
      isCompact_univ ((D.map fkj).appTop r)) (V := D.map fki â»Â¹áµ U) (by
        rwa [â† preimage_basicOpen_top, â† Hom.comp_preimage, â† Hom.comp_preimage,
          c.w, c.w, preimage_basicOpen_top])
    refine âŸ¨l, (D.map (flk â‰« fkj)).appTop r, ?_, ?_âŸ©
    Â· convert (hU.preimage (D.map (flk â‰« fki))).basicOpen
        ((D.obj _).presheaf.map (homOfLE le_top).op ((D.map (flk â‰« fkj)).appTop r)) using 1
      rwa [Scheme.basicOpen_res, eq_comm, inf_eq_right, Functor.map_comp,
        elementwise_of% Scheme.Hom.comp_appTop, â† Scheme.preimage_basicOpen_top, Functor.map_comp,
        Scheme.Hom.comp_preimage]
    Â· change x âˆˆ c.Ï€.app l â»Â¹áµ (D.obj l).basicOpen _
      rwa [Scheme.preimage_basicOpen_top, â† elementwise_of% Scheme.Hom.comp_appTop, Cone.w]
  choose i f hf hi using this
  obtain âŸ¨Ïƒ, hÏƒâŸ© := CompactSpace.elim_nhds_subcover
    (fun x â†¦ (((c.Ï€.app (i x)) â»Â¹áµ (D.obj (i x)).basicOpen (f x)).1))
    (fun x â†¦ ((c.Ï€.app (i x)) â»Â¹áµ (D.obj (i x)).basicOpen (f x)).2.mem_nhds (by exact hi x))
  choose Ïƒi hÏƒiÏƒ hÏƒi using fun x â†¦ Set.mem_iUnionâ‚‚.mp (hÏƒ.ge (Set.mem_univ x))
  obtain âŸ¨j, fjâŸ© := IsCofiltered.inf_objs_exists (Ïƒ.image i)
  replace fj := fun i h â†¦ (@fj i h).some
  obtain âŸ¨k, fkj, hkâŸ© := exists_map_eq_top D c hc
    (â¨† k, D.map (fj _ (Finset.mem_image_of_mem i (hÏƒiÏƒ k))) â»Â¹áµ (D.obj (i _)).basicOpen (f _)) (by
      refine top_le_iff.mp fun x _ â†¦ TopologicalSpace.Opens.mem_iSup.mpr âŸ¨x, ?_âŸ©
      change (c.Ï€.app j â‰« D.map _).base x âˆˆ (D.obj (i (Ïƒi x))).basicOpen (f (Ïƒi x))
      rw [Cone.w]
      exact hÏƒi _)
  refine âŸ¨k, .of_forall_exists_mem_basicOpen _ fun x â†¦ ?_âŸ©
  obtain âŸ¨y, hyâŸ© := TopologicalSpace.Opens.mem_iSup.mp (hk.ge (Set.mem_univ x))
  use (D.map fkj).appTop ((D.map (fj _ (Finset.mem_image_of_mem i (hÏƒiÏƒ y)))).appTop (f _))
  rw [â† Scheme.preimage_basicOpen_top, â† Scheme.preimage_basicOpen_top]
  exact âŸ¨((hf _).preimage _).preimage _, hyâŸ©
","lemma Scheme.exists_isQuasiAffine_of_isLimit [IsCofiltered I]
    [âˆ€ {i j} (f : i âŸ¶ j), IsAffineHom (D.map f)]
    [âˆ€ (i : I), CompactSpace (D.obj i)]
    [âˆ€ (i : I), QuasiSeparatedSpace (D.obj i)]
    [IsQuasiAffine c.pt] :
    âˆƒ i, IsQuasiAffine (D.obj i) ","Proof.\n      Choose $i_0 \\in I$. Note that $I$ is nonempty as the limit is directed. For convenience we write $S_0 = S_{i_0}$ and $i_0 = 0$. Let $s \\in S$. We may choose an affine open $U_0 \\subset S_0$ containing $f_0(s)$. Since $S$ is quasi-affine we may choose an element $a \\in \\Gamma (S, \\mathcal{O}_ S)$ such that $s \\in D(a) \\subset f_0^{-1}(U_0)$, and such that $D(a)$ is affine. By Lemma 32.4.7 [[\n  Lemma 32.4.7. In Situation 32.4.5. Suppose that $\\mathcal{F}_0$ is a quasi-coherent sheaf on $S_0$. Set $\\mathcal{F}_ i = f_{i0}^*\\mathcal{F}_0$ for $i \\geq 0$ and set $\\mathcal{F} = f_0^*\\mathcal{F}_0$. Then \n  \n  \\[  \\Gamma (S, \\mathcal{F}) = \\mathop{\\mathrm{colim}}\\nolimits _{i \\geq 0} \\Gamma (S_ i, \\mathcal{F}_ i)  \\]\n\n\n    \n]] there exists an $i \\geq 0$ such that $a$ comes from an element $a_ i \\in \\Gamma (S_ i, \\mathcal{O}_{S_ i})$. For any index $j \\geq i$ we denote $a_ j$ the image of $a_ i$ in the global sections of the structure sheaf of $S_ j$. Consider the opens $D(a_ j) \\subset S_ j$ and $U_ j = f_{j0}^{-1}(U_0)$. Note that $U_ j$ is affine and $D(a_ j)$ is a quasi-compact open of $S_ j$, see Properties, Lemma 28.26.4 [[\n  Lemma 28.26.4. Let $X$ be a scheme. Let $\\mathcal{L}$ be an invertible $\\mathcal{O}_ X$-module. Let $s \\in \\Gamma (X, \\mathcal{L})$. For any affine $U \\subset X$ the intersection $U \\cap X_ s$ is affine. \n\n    \n]] for example. Hence we may apply Lemma 32.4.11 [[\n  Lemma 32.4.11. In Situation 32.4.5 we have the following: \n  \n  \nGiven any quasi-compact open $V \\subset S = \\mathop{\\mathrm{lim}}\\nolimits _ i S_ i$ there exists an $i \\in I$ and a quasi-compact open $V_ i \\subset S_ i$ such that $f_ i^{-1}(V_ i) = V$. \n\n\nGiven $V_ i \\subset S_ i$ and $V_{i\'} \\subset S_{i\'}$ quasi-compact opens such that $f_ i^{-1}(V_ i) = f_{i\'}^{-1}(V_{i\'})$ there exists an index $i\'\' \\geq i, i\'$ such that $f_{i\'\'i}^{-1}(V_ i) = f_{i\'\'i\'}^{-1}(V_{i\'})$. \n\n\nIf $V_{1, i}, \\ldots , V_{n, i} \\subset S_ i$ are quasi-compact opens and $S = f_ i^{-1}(V_{1, i}) \\cup \\ldots \\cup f_ i^{-1}(V_{n, i})$ then $S_{i\'} = f_{i\'i}^{-1}(V_{1, i}) \\cup \\ldots \\cup f_{i\'i}^{-1}(V_{n, i})$ for some $i\' \\geq i$. \n\n\n\n\n    \n]] to the opens $U_ j$ and $U_ j \\cup D(a_ j)$ to conclude that $D(a_ j) \\subset U_ j$ for some $j \\geq i$. For such an index $j$ we see that $D(a_ j) \\subset S_ j$ is an affine open (because $D(a_ j)$ is a standard affine open of the affine open $U_ j$) containing the image $f_ j(s)$. \n    \n      We conclude that for every $s \\in S$ there exist an index $i \\in I$, and a global section $a \\in \\Gamma (S_ i, \\mathcal{O}_{S_ i})$ such that $D(a) \\subset S_ i$ is an affine open containing $f_ i(s)$. Because $S$ is quasi-compact we may choose a single index $i \\in I$ and global sections $a_1, \\ldots , a_ m \\in \\Gamma (S_ i, \\mathcal{O}_{S_ i})$ such that each $D(a_ j) \\subset S_ i$ is affine open and such that $f_ i : S \\to S_ i$ has image contained in the union $W_ i = \\bigcup _{j = 1, \\ldots , m} D(a_ j)$. For $i\' \\geq i$ set $W_{i\'} = f_{i\'i}^{-1}(W_ i)$. Since $f_ i^{-1}(W_ i)$ is all of $S$ we see (by Lemma 32.4.11 [[\n  Lemma 32.4.11. In Situation 32.4.5 we have the following: \n  \n  \nGiven any quasi-compact open $V \\subset S = \\mathop{\\mathrm{lim}}\\nolimits _ i S_ i$ there exists an $i \\in I$ and a quasi-compact open $V_ i \\subset S_ i$ such that $f_ i^{-1}(V_ i) = V$. \n\n\nGiven $V_ i \\subset S_ i$ and $V_{i\'} \\subset S_{i\'}$ quasi-compact opens such that $f_ i^{-1}(V_ i) = f_{i\'}^{-1}(V_{i\'})$ there exists an index $i\'\' \\geq i, i\'$ such that $f_{i\'\'i}^{-1}(V_ i) = f_{i\'\'i\'}^{-1}(V_{i\'})$. \n\n\nIf $V_{1, i}, \\ldots , V_{n, i} \\subset S_ i$ are quasi-compact opens and $S = f_ i^{-1}(V_{1, i}) \\cup \\ldots \\cup f_ i^{-1}(V_{n, i})$ then $S_{i\'} = f_{i\'i}^{-1}(V_{1, i}) \\cup \\ldots \\cup f_{i\'i}^{-1}(V_{n, i})$ for some $i\' \\geq i$. \n\n\n\n\n    \n]] again) that for a suitable $i\' \\geq i$ we have $S_{i\'} = W_{i\'}$. Thus we may replace $i$ by $i\'$ and assume that $S_ i = \\bigcup _{j = 1, \\ldots , m} D(a_ j)$. This implies that $\\mathcal{O}_{S_ i}$ is an ample invertible sheaf on $S_ i$ (see Properties, Definition 28.26.1 [[\n       \n      \n  Definition 28.26.1. Let $X$ be a scheme. Let $\\mathcal{L}$ be an invertible $\\mathcal{O}_ X$-module. We say $\\mathcal{L}$ is ample if \n  \n  \n$X$ is quasi-compact, and \n\n\nfor every $x \\in X$ there exists an $n \\geq 1$ and $s \\in \\Gamma (X, \\mathcal{L}^{\\otimes n})$ such that $x \\in X_ s$ and $X_ s$ is affine. \n\n\n\n]]) and hence that $S_ i$ is quasi-affine, see Properties, Lemma 28.27.1 [[\n  Lemma 28.27.1. Let $X$ be a scheme. Then $X$ is quasi-affine if and only if $\\mathcal{O}_ X$ is ample. \n\n    \n]]. Hence we win. \n      $\\square$\n    \n"
12,01Z6,"lemma Scheme.exists_isAffine_of_isLimit [IsCofiltered I]
    [âˆ€ {i j} (f : i âŸ¶ j), IsAffineHom (D.map f)]
    [âˆ€ (i : I), CompactSpace (D.obj i)]
    [âˆ€ (i : I), QuasiSeparatedSpace (D.obj i)]
    [IsAffine c.pt] :
    âˆƒ i, IsAffine (D.obj i) := by
  have := isAffineHom_Ï€_app _ _ hc
  obtain âŸ¨i, hiâŸ© := Scheme.exists_isQuasiAffine_of_isLimit D c hc
  have : âˆ€ {i j : I} (f : i âŸ¶ j), IsAffineHom ((D â‹™ Î“.rightOp â‹™ Scheme.Spec).map f) := by
    dsimp; infer_instance
  have (j : _) : CompactSpace ((D â‹™ Î“.rightOp â‹™ Scheme.Spec).obj j) := by dsimp; infer_instance
  obtain âŸ¨j, fij, hjâŸ© := exists_map_eq_top _ _
    (isLimitOfPreserves (Scheme.Î“.rightOp â‹™ Scheme.Spec) hc) (D.obj i).toSpecÎ“.opensRange
    ((preimage_opensRange_toSpecÎ“ (X := c.pt) (c.Ï€.app i)).trans
      (by simp [Hom.opensRange_of_isIso]))
  have := IsQuasiAffine.of_isAffineHom (D.map fij)
  exact âŸ¨j, âŸ¨isIso_of_isOpenImmersion_of_opensRange_eq_top _
    ((preimage_opensRange_toSpecÎ“ (D.map fij)).symm.trans hj)âŸ©âŸ©
",Formal Proof of Stacks Project Tag 01Z6,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/AffineTransitionLimit.lean#L989-L1006,Q27041,,32.4.13,lemma,3.0,"['081A', '01YT', '0ELP']","\n  Lemma 32.4.13. In Situation 32.4.5 if $S$ is affine, then for some $i_0 \\in I$ the schemes $S_ i$ for $i \\geq i_0$ are affine. \n\n    \n      Proof.\n      By Lemma 32.4.12 we may assume that $S_0$ is quasi-affine for some $0 \\in I$. Set $R_0 = \\Gamma (S_0, \\mathcal{O}_{S_0})$. Then $S_0$ is a quasi-compact open of $T_0 = \\mathop{\\mathrm{Spec}}(R_0)$. Denote $j_0 : S_0 \\to T_0$ the corresponding quasi-compact open immersion. For $i \\geq 0$ set $\\mathcal{A}_ i = f_{i0, *}\\mathcal{O}_{S_ i}$. Since $f_{i0}$ is affine we see that $S_ i = \\underline{\\mathop{\\mathrm{Spec}}}_{S_0}(\\mathcal{A}_ i)$. Set $T_ i = \\underline{\\mathop{\\mathrm{Spec}}}_{T_0}(j_{0, *}\\mathcal{A}_ i)$. Then $T_ i \\to T_0$ is affine, hence $T_ i$ is affine. Thus $T_ i$ is the spectrum of \n    \n      \n  \\[  R_ i = \\Gamma (T_0, j_{0, *}\\mathcal{A}_ i) = \\Gamma (S_0, \\mathcal{A}_ i) = \\Gamma (S_ i, \\mathcal{O}_{S_ i}).  \\]\n\n    \n       Write $S = \\mathop{\\mathrm{Spec}}(R)$. We have $R = \\mathop{\\mathrm{colim}}\\nolimits _ i R_ i$ by Lemma 32.4.7. Hence also $S = \\mathop{\\mathrm{lim}}\\nolimits _ i T_ i$. As formation of the relative spectrum commutes with base change, the inverse image of the open $S_0 \\subset T_0$ in $T_ i$ is $S_ i$. Let $Z_0 = T_0 \\setminus S_0$ and let $Z_ i \\subset T_ i$ be the inverse image of $Z_0$. As $S_ i = T_ i \\setminus Z_ i$, it suffices to show that $Z_ i$ is empty for some $i$. Assume $Z_ i$ is nonempty for all $i$ to get a contradiction. By Lemma 32.4.8 there exists a point $s$ of $S = \\mathop{\\mathrm{lim}}\\nolimits T_ i$ which maps to a point of $Z_ i$ for every $i$. But $S = \\mathop{\\mathrm{lim}}\\nolimits _ i S_ i$, and hence we arrive at a contradiction by Lemma 32.4.6. \n      $\\square$\n    \n","\n  Lemma 32.4.13. In Situation 32.4.5 if $S$ is affine, then for some $i_0 \\in I$ the schemes $S_ i$ for $i \\geq i_0$ are affine. \n\n    \n","Proof.\n      By Lemma 32.4.12 we may assume that $S_0$ is quasi-affine for some $0 \\in I$. Set $R_0 = \\Gamma (S_0, \\mathcal{O}_{S_0})$. Then $S_0$ is a quasi-compact open of $T_0 = \\mathop{\\mathrm{Spec}}(R_0)$. Denote $j_0 : S_0 \\to T_0$ the corresponding quasi-compact open immersion. For $i \\geq 0$ set $\\mathcal{A}_ i = f_{i0, *}\\mathcal{O}_{S_ i}$. Since $f_{i0}$ is affine we see that $S_ i = \\underline{\\mathop{\\mathrm{Spec}}}_{S_0}(\\mathcal{A}_ i)$. Set $T_ i = \\underline{\\mathop{\\mathrm{Spec}}}_{T_0}(j_{0, *}\\mathcal{A}_ i)$. Then $T_ i \\to T_0$ is affine, hence $T_ i$ is affine. Thus $T_ i$ is the spectrum of \n    \n      \n  \\[  R_ i = \\Gamma (T_0, j_{0, *}\\mathcal{A}_ i) = \\Gamma (S_0, \\mathcal{A}_ i) = \\Gamma (S_ i, \\mathcal{O}_{S_ i}).  \\]\n\n    \n       Write $S = \\mathop{\\mathrm{Spec}}(R)$. We have $R = \\mathop{\\mathrm{colim}}\\nolimits _ i R_ i$ by Lemma 32.4.7. Hence also $S = \\mathop{\\mathrm{lim}}\\nolimits _ i T_ i$. As formation of the relative spectrum commutes with base change, the inverse image of the open $S_0 \\subset T_0$ in $T_ i$ is $S_ i$. Let $Z_0 = T_0 \\setminus S_0$ and let $Z_ i \\subset T_ i$ be the inverse image of $Z_0$. As $S_ i = T_ i \\setminus Z_ i$, it suffices to show that $Z_ i$ is empty for some $i$. Assume $Z_ i$ is nonempty for all $i$ to get a contradiction. By Lemma 32.4.8 there exists a point $s$ of $S = \\mathop{\\mathrm{lim}}\\nolimits T_ i$ which maps to a point of $Z_ i$ for every $i$. But $S = \\mathop{\\mathrm{lim}}\\nolimits _ i S_ i$, and hence we arrive at a contradiction by Lemma 32.4.6. \n      $\\square$\n    \n"," by
  have := isAffineHom_Ï€_app _ _ hc
  obtain âŸ¨i, hiâŸ© := Scheme.exists_isQuasiAffine_of_isLimit D c hc
  have : âˆ€ {i j : I} (f : i âŸ¶ j), IsAffineHom ((D â‹™ Î“.rightOp â‹™ Scheme.Spec).map f) := by
    dsimp; infer_instance
  have (j : _) : CompactSpace ((D â‹™ Î“.rightOp â‹™ Scheme.Spec).obj j) := by dsimp; infer_instance
  obtain âŸ¨j, fij, hjâŸ© := exists_map_eq_top _ _
    (isLimitOfPreserves (Scheme.Î“.rightOp â‹™ Scheme.Spec) hc) (D.obj i).toSpecÎ“.opensRange
    ((preimage_opensRange_toSpecÎ“ (X := c.pt) (c.Ï€.app i)).trans
      (by simp [Hom.opensRange_of_isIso]))
  have := IsQuasiAffine.of_isAffineHom (D.map fij)
  exact âŸ¨j, âŸ¨isIso_of_isOpenImmersion_of_opensRange_eq_top _
    ((preimage_opensRange_toSpecÎ“ (D.map fij)).symm.trans hj)âŸ©âŸ©
","lemma Scheme.exists_isAffine_of_isLimit [IsCofiltered I]
    [âˆ€ {i j} (f : i âŸ¶ j), IsAffineHom (D.map f)]
    [âˆ€ (i : I), CompactSpace (D.obj i)]
    [âˆ€ (i : I), QuasiSeparatedSpace (D.obj i)]
    [IsAffine c.pt] :
    âˆƒ i, IsAffine (D.obj i) ","Proof.\n      By Lemma 32.4.12 [[\n  Lemma 32.4.12. In Situation 32.4.5 if $S$ is quasi-affine, then for some $i_0 \\in I$ the schemes $S_ i$ for $i \\geq i_0$ are quasi-affine. \n\n    \n]] we may assume that $S_0$ is quasi-affine for some $0 \\in I$. Set $R_0 = \\Gamma (S_0, \\mathcal{O}_{S_0})$. Then $S_0$ is a quasi-compact open of $T_0 = \\mathop{\\mathrm{Spec}}(R_0)$. Denote $j_0 : S_0 \\to T_0$ the corresponding quasi-compact open immersion. For $i \\geq 0$ set $\\mathcal{A}_ i = f_{i0, *}\\mathcal{O}_{S_ i}$. Since $f_{i0}$ is affine we see that $S_ i = \\underline{\\mathop{\\mathrm{Spec}}}_{S_0}(\\mathcal{A}_ i)$. Set $T_ i = \\underline{\\mathop{\\mathrm{Spec}}}_{T_0}(j_{0, *}\\mathcal{A}_ i)$. Then $T_ i \\to T_0$ is affine, hence $T_ i$ is affine. Thus $T_ i$ is the spectrum of \n    \n      \n  \\[  R_ i = \\Gamma (T_0, j_{0, *}\\mathcal{A}_ i) = \\Gamma (S_0, \\mathcal{A}_ i) = \\Gamma (S_ i, \\mathcal{O}_{S_ i}).  \\]\n\n    \n       Write $S = \\mathop{\\mathrm{Spec}}(R)$. We have $R = \\mathop{\\mathrm{colim}}\\nolimits _ i R_ i$ by Lemma 32.4.7 [[\n  Lemma 32.4.7. In Situation 32.4.5. Suppose that $\\mathcal{F}_0$ is a quasi-coherent sheaf on $S_0$. Set $\\mathcal{F}_ i = f_{i0}^*\\mathcal{F}_0$ for $i \\geq 0$ and set $\\mathcal{F} = f_0^*\\mathcal{F}_0$. Then \n  \n  \\[  \\Gamma (S, \\mathcal{F}) = \\mathop{\\mathrm{colim}}\\nolimits _{i \\geq 0} \\Gamma (S_ i, \\mathcal{F}_ i)  \\]\n\n\n    \n]]. Hence also $S = \\mathop{\\mathrm{lim}}\\nolimits _ i T_ i$. As formation of the relative spectrum commutes with base change, the inverse image of the open $S_0 \\subset T_0$ in $T_ i$ is $S_ i$. Let $Z_0 = T_0 \\setminus S_0$ and let $Z_ i \\subset T_ i$ be the inverse image of $Z_0$. As $S_ i = T_ i \\setminus Z_ i$, it suffices to show that $Z_ i$ is empty for some $i$. Assume $Z_ i$ is nonempty for all $i$ to get a contradiction. By Lemma 32.4.8 [[\n  Lemma 32.4.8. In Situation 32.4.5. Suppose for each $i$ we are given a nonempty closed subset $Z_ i \\subset S_ i$ with $f_{i\'i}(Z_{i\'}) \\subset Z_ i$ for all $i\' \\geq i$. Then there exists a point $s \\in S$ with $f_ i(s) \\in Z_ i$ for all $i$. \n\n    \n]] there exists a point $s$ of $S = \\mathop{\\mathrm{lim}}\\nolimits T_ i$ which maps to a point of $Z_ i$ for every $i$. But $S = \\mathop{\\mathrm{lim}}\\nolimits _ i S_ i$, and hence we arrive at a contradiction by Lemma 32.4.6 [[\n  Lemma 32.4.6. In Situation 32.4.5. \n  \n  \nWe have $S_{set} = \\mathop{\\mathrm{lim}}\\nolimits _ i S_{i, set}$ where $S_{set}$ indicates the underlying set of the scheme $S$. \n\n\nWe have $S_{top} = \\mathop{\\mathrm{lim}}\\nolimits _ i S_{i, top}$ where $S_{top}$ indicates the underlying topological space of the scheme $S$. \n\n\nIf $s, s\' \\in S$ and $s\'$ is not a specialization of $s$ then for some $i \\in I$ the image $s\'_ i \\in S_ i$ of $s\'$ is not a specialization of the image $s_ i \\in S_ i$ of $s$. \n\n\nAdd more easy facts on topology of $S$ here. (Requirement: whatever is added should be easy in the affine case.) \n\n\n\n\n    \n]]. \n      $\\square$\n    \n"
13,01OX,"instance (priority := 100) {Z : Scheme} [IsLocallyNoetherian X]
    {f : Z âŸ¶ X} [IsOpenImmersion f] : QuasiCompact f := by
  apply quasiCompact_iff_forall_isAffineOpen.mpr
  intro U hU
  rw [Opens.map_coe, â† Set.preimage_inter_range]
  apply f.isOpenEmbedding.isInducing.isCompact_preimage'
  Â· apply (noetherianSpace_set_iff _).mp
    Â· convert noetherianSpace_of_isAffineOpen U hU
      apply IsLocallyNoetherian.component_noetherian âŸ¨U, hUâŸ©
    Â· exact Set.inter_subset_left
  Â· exact Set.inter_subset_right
",Formal Proof of Stacks Project Tag 01OX,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/Noetherian.lean#L205-L215,Q27041,,28.5.3,lemma,3.0,"['01OU', '01OH', '0ELP']","\n  Lemma 28.5.3. Any immersion $Z \\to X$ with $X$ locally Noetherian is quasi-compact. \n\n    \n      Proof.\n      A closed immersion is clearly quasi-compact. A composition of quasi-compact morphisms is quasi-compact, see Topology, Lemma 5.12.2. Hence it suffices to show that an open immersion into a locally Noetherian scheme is quasi-compact. Using Schemes, Lemma 26.19.2 we reduce to the case where $X$ is affine. Any open subset of the spectrum of a Noetherian ring is quasi-compact (for example combine Algebra, Lemma 10.31.5 and Topology, Lemmas 5.9.2 and 5.12.13). \n      $\\square$\n    \n",\n  Lemma 28.5.3. Any immersion $Z \\to X$ with $X$ locally Noetherian is quasi-compact. \n\n    \n,"Proof.\n      A closed immersion is clearly quasi-compact. A composition of quasi-compact morphisms is quasi-compact, see Topology, Lemma 5.12.2. Hence it suffices to show that an open immersion into a locally Noetherian scheme is quasi-compact. Using Schemes, Lemma 26.19.2 we reduce to the case where $X$ is affine. Any open subset of the spectrum of a Noetherian ring is quasi-compact (for example combine Algebra, Lemma 10.31.5 and Topology, Lemmas 5.9.2 and 5.12.13). \n      $\\square$\n    \n"," 100) {Z : Scheme} [IsLocallyNoetherian X]
    {f : Z âŸ¶ X} [IsOpenImmersion f] : QuasiCompact f := by
  apply quasiCompact_iff_forall_isAffineOpen.mpr
  intro U hU
  rw [Opens.map_coe, â† Set.preimage_inter_range]
  apply f.isOpenEmbedding.isInducing.isCompact_preimage'
  Â· apply (noetherianSpace_set_iff _).mp
    Â· convert noetherianSpace_of_isAffineOpen U hU
      apply IsLocallyNoetherian.component_noetherian âŸ¨U, hUâŸ©
    Â· exact Set.inter_subset_left
  Â· exact Set.inter_subset_right
",instance (priority ,"Proof.\n      A closed immersion is clearly quasi-compact. A composition of quasi-compact morphisms is quasi-compact, see Topology, Lemma 5.12.2 [[\n  Lemma 5.12.2. A composition of quasi-compact maps is quasi-compact. \n\n    \n]]. Hence it suffices to show that an open immersion into a locally Noetherian scheme is quasi-compact. Using Schemes, Lemma 26.19.2 [[\n  Lemma 26.19.2. Let $f : X \\to S$ be a morphism of schemes. The following are equivalent \n  \n  \n$f : X \\to S$ is quasi-compact, \n\n\nthe inverse image of every affine open is quasi-compact, and \n\n\nthere exists some affine open covering $S = \\bigcup _{i \\in I} U_ i$ such that $f^{-1}(U_ i)$ is quasi-compact for all $i$. \n\n\n\n\n    \n]] we reduce to the case where $X$ is affine. Any open subset of the spectrum of a Noetherian ring is quasi-compact (for example combine Algebra, Lemma 10.31.5 [[\n  Lemma 10.31.5. If $R$ is a Noetherian ring then $\\mathop{\\mathrm{Spec}}(R)$ is a Noetherian topological space, see Topology, Definition 5.9.1. \n\n    \n]] and Topology, Lemmas 5.9.2 [[\n  Lemma 5.9.2. Let $X$ be a Noetherian topological space. \n  \n  \nAny subset of $X$ with the induced topology is Noetherian. \n\n\nThe space $X$ has finitely many irreducible components. \n\n\nEach irreducible component of $X$ contains a nonempty open of $X$. \n\n\n\n\n    \n]] and 5.12.13 [[\n  Lemma 5.12.13. Let $X$ be a Noetherian topological space. \n  \n  \nThe space $X$ is quasi-compact. \n\n\nAny subset of $X$ is retrocompact. \n\n\n\n\n    \n]]). \n      $\\square$\n    \n"
14,01OY,"instance (priority := 100) IsLocallyNoetherian.quasiSeparatedSpace [IsLocallyNoetherian X] :
    QuasiSeparatedSpace X := by
  apply quasiSeparatedSpace_iff_forall_affineOpens.mpr
  intro U V
  have hInd := U.2.fromSpec.isOpenEmbedding.isInducing
  apply (hInd.isCompact_preimage_iff ?_).mp
  Â· rw [â† Set.preimage_inter_range, IsAffineOpen.range_fromSpec, Set.inter_comm]
    apply hInd.isCompact_preimage'
    Â· apply (noetherianSpace_set_iff _).mp
      Â· convert noetherianSpace_of_isAffineOpen U.1 U.2
        apply IsLocallyNoetherian.component_noetherian
      Â· exact Set.inter_subset_left
    Â· rw [IsAffineOpen.range_fromSpec]
      exact Set.inter_subset_left
  Â· rw [IsAffineOpen.range_fromSpec]
    exact Set.inter_subset_left
",Formal Proof of Stacks Project Tag 01OY,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/Noetherian.lean#L219-L234,Q27041,,28.5.4,lemma,3.0,"['01OU', '01OH', '0ELP']","\n  Lemma 28.5.4. A locally Noetherian scheme is quasi-separated. \n\n    \n      Proof.\n      By Schemes, Lemma 26.21.6 we have to show that the intersection $U \\cap V$ of two affine opens of $X$ is quasi-compact. This follows from Lemma 28.5.3 above on considering the open immersion $U \\cap V \\to U$ for example. (But really it is just because any open of the spectrum of a Noetherian ring is quasi-compact.) \n      $\\square$\n    \n",\n  Lemma 28.5.4. A locally Noetherian scheme is quasi-separated. \n\n    \n,"Proof.\n      By Schemes, Lemma 26.21.6 we have to show that the intersection $U \\cap V$ of two affine opens of $X$ is quasi-compact. This follows from Lemma 28.5.3 above on considering the open immersion $U \\cap V \\to U$ for example. (But really it is just because any open of the spectrum of a Noetherian ring is quasi-compact.) \n      $\\square$\n    \n"," 100) IsLocallyNoetherian.quasiSeparatedSpace [IsLocallyNoetherian X] :
    QuasiSeparatedSpace X := by
  apply quasiSeparatedSpace_iff_forall_affineOpens.mpr
  intro U V
  have hInd := U.2.fromSpec.isOpenEmbedding.isInducing
  apply (hInd.isCompact_preimage_iff ?_).mp
  Â· rw [â† Set.preimage_inter_range, IsAffineOpen.range_fromSpec, Set.inter_comm]
    apply hInd.isCompact_preimage'
    Â· apply (noetherianSpace_set_iff _).mp
      Â· convert noetherianSpace_of_isAffineOpen U.1 U.2
        apply IsLocallyNoetherian.component_noetherian
      Â· exact Set.inter_subset_left
    Â· rw [IsAffineOpen.range_fromSpec]
      exact Set.inter_subset_left
  Â· rw [IsAffineOpen.range_fromSpec]
    exact Set.inter_subset_left
",instance (priority ,"Proof.\n      By Schemes, Lemma 26.21.6 [[\n  Lemma 26.21.6. Let $f : X \\to S$ be a morphism of schemes. The following are equivalent: \n  \n  \nThe morphism $f$ is quasi-separated. \n\n\nFor every pair of affine opens $U, V \\subset X$ which map into a common affine open of $S$ the intersection $U \\cap V$ is a finite union of affine opens of $X$. \n\n\nThere exists an affine open covering $S = \\bigcup _{i \\in I} U_ i$ and for each $i$ an affine open covering $f^{-1}U_ i = \\bigcup _{j \\in I_ i} V_ j$ such that for each $i$ and each pair $j, j\' \\in I_ i$ the intersection $V_ j \\cap V_{j\'}$ is a finite union of affine opens of $X$. \n\n\n\n\n    \n]] we have to show that the intersection $U \\cap V$ of two affine opens of $X$ is quasi-compact. This follows from Lemma 28.5.3 [[\n  Lemma 28.5.3. Any immersion $Z \\to X$ with $X$ locally Noetherian is quasi-compact. \n\n    \n]] above on considering the open immersion $U \\cap V \\to U$ for example. (But really it is just because any open of the spectrum of a Noetherian ring is quasi-compact.) \n      $\\square$\n    \n"
15,01OZ,"instance (priority := 100) IsNoetherian.noetherianSpace [IsNoetherian X] :
    NoetherianSpace X := by
  apply TopologicalSpace.noetherian_univ_iff.mp
  let ð’° := X.affineCover.finiteSubcover
  rw [â† ð’°.iUnion_range]
  suffices âˆ€ i : ð’°.Iâ‚€, NoetherianSpace (Set.range <| (ð’°.f i)) by
    apply NoetherianSpace.iUnion
  intro i
  have : IsAffine (ð’°.X i) := by
    rw [X.affineCover.finiteSubcover_X]
    apply Scheme.isAffine_affineCover
  let U : X.affineOpens := âŸ¨Scheme.Hom.opensRange (ð’°.f i), isAffineOpen_opensRange _âŸ©
  convert noetherianSpace_of_isAffineOpen U.1 U.2
  apply IsLocallyNoetherian.component_noetherian
",Formal Proof of Stacks Project Tag 01OZ,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/Noetherian.lean#L294-L307,Q27041,,28.5.5,lemma,3.0,"['01OU', '01OH', '0ELP']","\n  Lemma 28.5.5. A (locally) Noetherian scheme has a (locally) Noetherian underlying topological space, see Topology, Definition 5.9.1. \n\n    \n      Proof.\n      This is because a Noetherian scheme is a finite union of spectra of Noetherian rings and Algebra, Lemma 10.31.5 and Topology, Lemma 5.9.4. \n      $\\square$\n    \n","\n  Lemma 28.5.5. A (locally) Noetherian scheme has a (locally) Noetherian underlying topological space, see Topology, Definition 5.9.1. \n\n    \n","Proof.\n      This is because a Noetherian scheme is a finite union of spectra of Noetherian rings and Algebra, Lemma 10.31.5 and Topology, Lemma 5.9.4. \n      $\\square$\n    \n"," 100) IsNoetherian.noetherianSpace [IsNoetherian X] :
    NoetherianSpace X := by
  apply TopologicalSpace.noetherian_univ_iff.mp
  let ð’° := X.affineCover.finiteSubcover
  rw [â† ð’°.iUnion_range]
  suffices âˆ€ i : ð’°.Iâ‚€, NoetherianSpace (Set.range <| (ð’°.f i)) by
    apply NoetherianSpace.iUnion
  intro i
  have : IsAffine (ð’°.X i) := by
    rw [X.affineCover.finiteSubcover_X]
    apply Scheme.isAffine_affineCover
  let U : X.affineOpens := âŸ¨Scheme.Hom.opensRange (ð’°.f i), isAffineOpen_opensRange _âŸ©
  convert noetherianSpace_of_isAffineOpen U.1 U.2
  apply IsLocallyNoetherian.component_noetherian
",instance (priority ,"Proof.\n      This is because a Noetherian scheme is a finite union of spectra of Noetherian rings and Algebra, Lemma 10.31.5 [[\n  Lemma 10.31.5. If $R$ is a Noetherian ring then $\\mathop{\\mathrm{Spec}}(R)$ is a Noetherian topological space, see Topology, Definition 5.9.1. \n\n    \n]] and Topology, Lemma 5.9.4 [[\n  Lemma 5.9.4. Let $X$ be a topological space. Let $X_ i \\subset X$, $i = 1, \\ldots , n$ be a finite collection of subsets. If each $X_ i$ is Noetherian (with the induced topology), then $\\bigcup _{i = 1, \\ldots , n} X_ i$ is Noetherian (with the induced topology). \n\n    \n]]. \n      $\\square$\n    \n"
16,01P0,"instance (priority := 100) quasiCompact_of_noetherianSpace_source {X Y : Scheme}
    [NoetherianSpace X] (f : X âŸ¶ Y) : QuasiCompact f :=
  âŸ¨fun _ _ _ => NoetherianSpace.isCompact _âŸ©
",Formal Proof of Stacks Project Tag 01P0,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/Noetherian.lean#L311-L313,Q27041,,28.5.8,lemma,3.0,"['01OU', '01OH', '0ELP']","\n  Lemma 28.5.8. Any morphism of schemes $f : X \\to Y$ with $X$ Noetherian is quasi-compact. \n\n    \n      Proof.\n      Use Lemma 28.5.5 and use that any subset of a Noetherian topological space is quasi-compact (see Topology, Lemmas 5.9.2 and 5.12.13). \n      $\\square$\n    \n",\n  Lemma 28.5.8. Any morphism of schemes $f : X \\to Y$ with $X$ Noetherian is quasi-compact. \n\n    \n,"Proof.\n      Use Lemma 28.5.5 and use that any subset of a Noetherian topological space is quasi-compact (see Topology, Lemmas 5.9.2 and 5.12.13). \n      $\\square$\n    \n"," 100) quasiCompact_of_noetherianSpace_source {X Y : Scheme}
    [NoetherianSpace X] (f : X âŸ¶ Y) : QuasiCompact f :=
  âŸ¨fun _ _ _ => NoetherianSpace.isCompact _âŸ©
",instance (priority ,"Proof.\n      Use Lemma 28.5.5 [[\n  Lemma 28.5.5. A (locally) Noetherian scheme has a (locally) Noetherian underlying topological space, see Topology, Definition 5.9.1. \n\n    \n]] and use that any subset of a Noetherian topological space is quasi-compact (see Topology, Lemmas 5.9.2 [[\n  Lemma 5.9.2. Let $X$ be a Noetherian topological space. \n  \n  \nAny subset of $X$ with the induced topology is Noetherian. \n\n\nThe space $X$ has finitely many irreducible components. \n\n\nEach irreducible component of $X$ contains a nonempty open of $X$. \n\n\n\n\n    \n]] and 5.12.13 [[\n  Lemma 5.12.13. Let $X$ be a Noetherian topological space. \n  \n  \nThe space $X$ is quasi-compact. \n\n\nAny subset of $X$ is retrocompact. \n\n\n\n\n    \n]]). \n      $\\square$\n    \n"
17,0BA8,"theorem finite_irreducibleComponents_of_isNoetherian [IsNoetherian X] :
    (irreducibleComponents X).Finite := NoetherianSpace.finite_irreducibleComponents
",Formal Proof of Stacks Project Tag 0BA8,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/Noetherian.lean#L338-L339,Q27041,,28.5.7,lemma,3.0,"['01OU', '01OH', '0ELP']","\n  Lemma 28.5.7. A Noetherian scheme has a finite number of irreducible components. \n\n    \n      Proof.\n      The underlying topological space of a Noetherian scheme is Noetherian (Lemma 28.5.5) and we conclude because a Noetherian topological space has only finitely many irreducible components (Topology, Lemma 5.9.2). \n      $\\square$\n    \n",\n  Lemma 28.5.7. A Noetherian scheme has a finite number of irreducible components. \n\n    \n,"Proof.\n      The underlying topological space of a Noetherian scheme is Noetherian (Lemma 28.5.5) and we conclude because a Noetherian topological space has only finitely many irreducible components (Topology, Lemma 5.9.2). \n      $\\square$\n    \n"," NoetherianSpace.finite_irreducibleComponents
","theorem finite_irreducibleComponents_of_isNoetherian [IsNoetherian X] :
    (irreducibleComponents X).Finite ","Proof.\n      The underlying topological space of a Noetherian scheme is Noetherian (Lemma 28.5.5 [[\n  Lemma 28.5.5. A (locally) Noetherian scheme has a (locally) Noetherian underlying topological space, see Topology, Definition 5.9.1. \n\n    \n]]) and we conclude because a Noetherian topological space has only finitely many irreducible components (Topology, Lemma 5.9.2 [[\n  Lemma 5.9.2. Let $X$ be a Noetherian topological space. \n  \n  \nAny subset of $X$ with the induced topology is Noetherian. \n\n\nThe space $X$ has finitely many irreducible components. \n\n\nEach irreducible component of $X$ contains a nonempty open of $X$. \n\n\n\n\n    \n]]). \n      $\\square$\n    \n"
18,035H,"def normalization : Scheme :=
  colimit (((toOpensFunctor Y).op â‹™ f.normalizationDiagram).rightOp â‹™ Scheme.Spec)
",Formal Proof of Stacks Project Tag 035H,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/Normalization.lean#L121-L122,Q27041,,29.53.3,definition,3.0,"['0BAK', '01QL', '0ELP']",\n  Definition 29.53.3. Let $f : Y \\to X$ be a quasi-compact and quasi-separated morphism of schemes. Let $\\mathcal{O}\'$ be the integral closure of $\\mathcal{O}_ X$ in $f_*\\mathcal{O}_ Y$. The normalization of $X$ in $Y$ is the scheme1 \n  \n  \\[  \\nu : X\' = \\underline{\\mathop{\\mathrm{Spec}}}_ X(\\mathcal{O}\') \\to X  \\]\n\n   over $X$. It comes equipped with a natural factorization \n  \n  \\[  Y \\xrightarrow {f\'} X\' \\xrightarrow {\\nu } X  \\]\n\n   of the initial morphism $f$. \n,\n  Definition 29.53.3. Let $f : Y \\to X$ be a quasi-compact and quasi-separated morphism of schemes. Let $\\mathcal{O}\'$ be the integral closure of $\\mathcal{O}_ X$ in $f_*\\mathcal{O}_ Y$. The normalization of $X$ in $Y$ is the scheme1 \n  \n  \\[  \\nu : X\' = \\underline{\\mathop{\\mathrm{Spec}}}_ X(\\mathcal{O}\') \\to X  \\]\n\n   over $X$. It comes equipped with a natural factorization \n  \n  \\[  Y \\xrightarrow {f\'} X\' \\xrightarrow {\\nu } X  \\]\n\n   of the initial morphism $f$. \n,,"
  colimit (((toOpensFunctor Y).op â‹™ f.normalizationDiagram).rightOp â‹™ Scheme.Spec)
",def normalization : Scheme ,
19,03GP,"instance [IsIntegralHom f] : IsIso f.toNormalization := by
  refine (IsZariskiLocalAtTarget.iff_of_openCover (P := .isomorphisms _)
    f.normalizationOpenCover).mpr fun U â†¦ ?_
  let e := IsOpenImmersion.isoOfRangeEq (pullback.fst f.toNormalization
    (f.normalizationOpenCover.f U)) (f â»Â¹áµ U.1).Î¹ (by simp [â† Hom.coe_opensRange,
      Hom.opensRange_pullbackFst, â† f.fromNormalization_preimage, â† Scheme.Hom.comp_preimage])
  rw [â† MorphismProperty.cancel_left_of_respectsIso (.isomorphisms _)
    (e â‰ªâ‰« (U.2.preimage f).isoSpec).inv]
  letI := (f.app U.1).hom.toAlgebra
  convert_to IsIso (Spec.map (CommRingCat.ofHom
      (integralClosure Î“(Y, U.1) Î“(X, f â»Â¹áµ U.1)).val.toRingHom))
  Â· rw [â† cancel_mono (f.normalizationOpenCover.f U), â† cancel_epi (U.2.preimage f).isoSpec.hom]
    simp [e, -Iso.cancel_iso_hom_left, IsAffineOpen.isoSpec_hom,
      Hom.Î¹_toNormalization]
  have : integralClosure Î“(Y, U.1) Î“(X, f â»Â¹áµ U.1) = âŠ¤ := by
    rw [integralClosure_eq_top_iff, â† algebraMap_isIntegral_iff, RingHom.algebraMap_toAlgebra]
    exact IsIntegralHom.isIntegral_app _ _ U.2
  rw [this]
  exact inferInstanceAs (IsIso (Scheme.Spec.mapIso (Subalgebra.topEquiv
    (R := Î“(Y, U.1)) (A := â†‘Î“(X, f â»Â¹áµ U.1))).toCommRingCatIso.op).hom)
",Formal Proof of Stacks Project Tag 03GP,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/Normalization.lean#L232-L251,Q27041,,29.53.12,lemma,3.0,"['0BAK', '01QL', '0ELP']",\n  Lemma 29.53.12. Let $f : Y \\to X$ be an integral morphism. Then the normalization of $X$ in $Y$ is equal to $Y$. \n\n    \n      Proof.\n      By Lemma 29.44.7 this is a special case of Lemma 29.53.11. \n      $\\square$\n    \n,\n  Lemma 29.53.12. Let $f : Y \\to X$ be an integral morphism. Then the normalization of $X$ in $Y$ is equal to $Y$. \n\n    \n,Proof.\n      By Lemma 29.44.7 this is a special case of Lemma 29.53.11. \n      $\\square$\n    \n," by
  refine (IsZariskiLocalAtTarget.iff_of_openCover (P := .isomorphisms _)
    f.normalizationOpenCover).mpr fun U â†¦ ?_
  let e := IsOpenImmersion.isoOfRangeEq (pullback.fst f.toNormalization
    (f.normalizationOpenCover.f U)) (f â»Â¹áµ U.1).Î¹ (by simp [â† Hom.coe_opensRange,
      Hom.opensRange_pullbackFst, â† f.fromNormalization_preimage, â† Scheme.Hom.comp_preimage])
  rw [â† MorphismProperty.cancel_left_of_respectsIso (.isomorphisms _)
    (e â‰ªâ‰« (U.2.preimage f).isoSpec).inv]
  letI := (f.app U.1).hom.toAlgebra
  convert_to IsIso (Spec.map (CommRingCat.ofHom
      (integralClosure Î“(Y, U.1) Î“(X, f â»Â¹áµ U.1)).val.toRingHom))
  Â· rw [â† cancel_mono (f.normalizationOpenCover.f U), â† cancel_epi (U.2.preimage f).isoSpec.hom]
    simp [e, -Iso.cancel_iso_hom_left, IsAffineOpen.isoSpec_hom,
      Hom.Î¹_toNormalization]
  have : integralClosure Î“(Y, U.1) Î“(X, f â»Â¹áµ U.1) = âŠ¤ := by
    rw [integralClosure_eq_top_iff, â† algebraMap_isIntegral_iff, RingHom.algebraMap_toAlgebra]
    exact IsIntegralHom.isIntegral_app _ _ U.2
  rw [this]
  exact inferInstanceAs (IsIso (Scheme.Spec.mapIso (Subalgebra.topEquiv
    (R := Î“(Y, U.1)) (A := â†‘Î“(X, f â»Â¹áµ U.1))).toCommRingCatIso.op).hom)
",instance [IsIntegralHom f] : IsIso f.toNormalization ,"Proof.\n      By Lemma 29.44.7 [[\n       \n      \n  Lemma 29.44.7. Let $f : X \\to S$ be a morphism of schemes. The following are equivalent \n  \n  \n$f$ is integral, and \n\n\n$f$ is affine and universally closed. \n\n\n\n\n    \n]] this is a special case of Lemma 29.53.11 [[\n  Lemma 29.53.11. Let $f : X \\to S$ be a quasi-compact, quasi-separated and universally closed morphisms of schemes. Then $f_*\\mathcal{O}_ X$ is integral over $\\mathcal{O}_ S$. In other words, the normalization of $S$ in $X$ is equal to the factorization \n  \n  \\[  X \\longrightarrow \\underline{\\mathop{\\mathrm{Spec}}}_ S(f_*\\mathcal{O}_ X) \\longrightarrow S  \\]\n\n   of Constructions, Lemma 27.4.7. \n\n    \n]]. \n      $\\square$\n    \n"
20,0AXN,"instance [IsReduced X] : IsReduced f.normalization :=
  have (i : _) : IsReduced ((normalizationOpenCover f).X i) := by
    have : _root_.IsReduced ((normalizationDiagram f).obj (.op i.1)) :=
      let := (f.app i.1).hom.toAlgebra
      isReduced_of_injective (Subalgebra.val _) Subtype.val_injective
    dsimp [normalizationOpenCover]
    infer_instance
  .of_openCover _ f.normalizationOpenCover
",Formal Proof of Stacks Project Tag 0AXN,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/Normalization.lean#L292-L299,Q27041,,29.53.8,lemma,3.0,"['0BAK', '01QL', '0ELP']","\n  Lemma 29.53.8. Let $f : Y \\to X$ be a quasi-compact and quasi-separated morphism of schemes. Let $X\' \\to X$ be the normalization of $X$ in $Y$. If $Y$ is reduced, so is $X\'$. \n\n    \n      Proof.\n      This follows from the fact that a subring of a reduced ring is reduced. Some details omitted. \n      $\\square$\n    \n","\n  Lemma 29.53.8. Let $f : Y \\to X$ be a quasi-compact and quasi-separated morphism of schemes. Let $X\' \\to X$ be the normalization of $X$ in $Y$. If $Y$ is reduced, so is $X\'$. \n\n    \n",Proof.\n      This follows from the fact that a subring of a reduced ring is reduced. Some details omitted. \n      $\\square$\n    \n,"
  have (i : _) : IsReduced ((normalizationOpenCover f).X i) := by
    have : _root_.IsReduced ((normalizationDiagram f).obj (.op i.1)) :=
      let := (f.app i.1).hom.toAlgebra
      isReduced_of_injective (Subalgebra.val _) Subtype.val_injective
    dsimp [normalizationOpenCover]
    infer_instance
  .of_openCover _ f.normalizationOpenCover
",instance [IsReduced X] : IsReduced f.normalization ,Proof.\n      This follows from the fact that a subring of a reduced ring is reduced. Some details omitted. \n      $\\square$\n    \n
21,01P6,"class IsQuasiAffine (X : Scheme.{u}) : Prop extends
  CompactSpace X, IsImmersion X.toSpecÎ“
",Formal Proof of Stacks Project Tag 01P6,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/QuasiAffine.lean#L34-L35,Q27041,,28.18.1,definition,3.0,"['01P5', '01OH', '0ELP']",\n  Definition 28.18.1. A scheme $X$ is called quasi-affine if it is quasi-compact and isomorphic to an open subscheme of an affine scheme. \n,\n  Definition 28.18.1. A scheme $X$ is called quasi-affine if it is quasi-compact and isomorphic to an open subscheme of an affine scheme. \n,,,"class IsQuasiAffine (X : Scheme.{u}) : Prop extends
  CompactSpace X, IsImmersion X.toSpecÎ“
",
22,0BCK,"lemma IsQuasiAffine.of_isImmersion
    [Y.IsQuasiAffine] [IsImmersion f] [CompactSpace X] : X.IsQuasiAffine := by
  have : IsImmersion (X.toSpecÎ“ â‰« Spec.map f.appTop) := by rw [â† toSpecÎ“_naturality]; infer_instance
  have : IsImmersion X.toSpecÎ“ := .of_comp _ (Spec.map f.appTop)
  constructor
",Formal Proof of Stacks Project Tag 0BCK,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/QuasiAffine.lean#L53-L57,Q27041,,28.27.2,lemma,3.0,"['01QD', '01OH', '0ELP']","\n  Lemma 28.27.2. Let $X$ be a quasi-affine scheme. For any quasi-compact immersion $i : X\' \\to X$ the scheme $X\'$ is quasi-affine. \n\n    \n      Proof.\n      This can be proved directly without making use of the material on ample invertible sheaves; we urge the reader to do this on a napkin. Since $X$ is quasi-affine, we have that $\\mathcal{O}_ X$ is ample by Lemma 28.27.1. Then $\\mathcal{O}_{X\'}$ is ample by Lemma 28.26.14. Then $X\'$ is quasi-affine by Lemma 28.27.1. \n      $\\square$\n    \n",\n  Lemma 28.27.2. Let $X$ be a quasi-affine scheme. For any quasi-compact immersion $i : X\' \\to X$ the scheme $X\'$ is quasi-affine. \n\n    \n,"Proof.\n      This can be proved directly without making use of the material on ample invertible sheaves; we urge the reader to do this on a napkin. Since $X$ is quasi-affine, we have that $\\mathcal{O}_ X$ is ample by Lemma 28.27.1. Then $\\mathcal{O}_{X\'}$ is ample by Lemma 28.26.14. Then $X\'$ is quasi-affine by Lemma 28.27.1. \n      $\\square$\n    \n"," by
  have : IsImmersion (X.toSpecÎ“ â‰« Spec.map f.appTop) := by rw [â† toSpecÎ“_naturality]; infer_instance
  have : IsImmersion X.toSpecÎ“ := .of_comp _ (Spec.map f.appTop)
  constructor
","lemma IsQuasiAffine.of_isImmersion
    [Y.IsQuasiAffine] [IsImmersion f] [CompactSpace X] : X.IsQuasiAffine ","Proof.\n      This can be proved directly without making use of the material on ample invertible sheaves; we urge the reader to do this on a napkin. Since $X$ is quasi-affine, we have that $\\mathcal{O}_ X$ is ample by Lemma 28.27.1 [[\n  Lemma 28.27.1. Let $X$ be a scheme. Then $X$ is quasi-affine if and only if $\\mathcal{O}_ X$ is ample. \n\n    \n]]. Then $\\mathcal{O}_{X\'}$ is ample by Lemma 28.26.14 [[\n  Lemma 28.26.14. Let $X$ be a scheme. Let $\\mathcal{L}$ be an ample invertible $\\mathcal{O}_ X$-module. Let $i : X\' \\to X$ be a morphism of schemes. Assume at least one of the following conditions holds \n  \n  \n$i$ is a quasi-compact immersion, \n\n\n$X\'$ is quasi-compact and $i$ is an immersion, \n\n\n$i$ is quasi-compact and induces a homeomorphism between $X\'$ and $i(X\')$, \n\n\n$X\'$ is quasi-compact and $i$ induces a homeomorphism between $X\'$ and $i(X\')$. \n\n\n\n   Then $i^*\\mathcal{L}$ is ample on $X\'$. \n\n    \n]]. Then $X\'$ is quasi-affine by Lemma 28.27.1 [[\n  Lemma 28.27.1. Let $X$ be a scheme. Then $X$ is quasi-affine if and only if $\\mathcal{O}_ X$ is ample. \n\n    \n]]. \n      $\\square$\n    \n"
23,01LH,"noncomputable abbrev glued : Scheme.{u} :=
  colimit d.functor
",Formal Proof of Stacks Project Tag 01LH,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/RelativeGluing.lean#L97-L98,Q27041,,27.2.1,lemma,3.0,"['01LG', '01LE', '0ELP']","\n  Lemma 27.2.1. Let $S$ be a scheme. Let $\\mathcal{B}$ be a basis for the topology of $S$. Suppose given the following data: \n  \n  \nFor every $U \\in \\mathcal{B}$ a scheme $f_ U : X_ U \\to U$ over $U$. \n\n\nFor $U, V \\in \\mathcal{B}$ with $V \\subset U$ a morphism $\\rho ^ U_ V : X_ V \\to X_ U$ over $U$. \n\n\n\n   Assume that \n  \n  \neach $\\rho ^ U_ V$ induces an isomorphism $X_ V \\to f_ U^{-1}(V)$ of schemes over $V$, \n\n\nwhenever $W, V, U \\in \\mathcal{B}$, with $W \\subset V \\subset U$ we have $\\rho ^ U_ W = \\rho ^ U_ V \\circ \\rho ^ V_ W$. \n\n\n\n   Then there exists a morphism $f : X \\to S$ of schemes and isomorphisms $i_ U : f^{-1}(U) \\to X_ U$ over $U \\in \\mathcal{B}$ such that for $V, U \\in \\mathcal{B}$ with $V \\subset U$ the composition \n  \n  \\[  \\xymatrix{ X_ V \\ar[r]^{i_ V^{-1}} &  f^{-1}(V) \\ar[rr]^{inclusion} &  &  f^{-1}(U) \\ar[r]^{i_ U} &  X_ U }  \\]\n\n   is the morphism $\\rho ^ U_ V$. Moreover $X$ is unique up to unique isomorphism over $S$. \n\n    \n      Proof.\n      To prove this we will use Schemes, Lemma 26.15.4. First we define a contravariant functor $F$ from the category of schemes to the category of sets. Namely, for a scheme $T$ we set \n    \n      \n  \\[  F(T) = \\left\\{  \\begin{matrix}  (g, \\{ h_ U\\} _{U \\in \\mathcal{B}}), \\  g : T \\to S, \\  h_ U : g^{-1}(U) \\to X_ U, \n\n\\\\  f_ U \\circ h_ U = g|_{g^{-1}(U)}, \\  h_ U|_{g^{-1}(V)} = \\rho ^ U_ V \\circ h_ V \\  \\forall \\  V, U \\in \\mathcal{B}, V \\subset U \n\n\\end{matrix} \\right\\} .  \\]\n\n    \n       The restriction mapping $F(T) \\to F(T\')$ given a morphism $T\' \\to T$ is just gotten by composition. For any $W \\in \\mathcal{B}$ we consider the subfunctor $F_ W \\subset F$ consisting of those systems $(g, \\{ h_ U\\} )$ such that $g(T) \\subset W$. \n    \n      First we show $F$ satisfies the sheaf property for the Zariski topology. Suppose that $T$ is a scheme, $T = \\bigcup V_ i$ is an open covering, and $\\xi _ i \\in F(V_ i)$ is an element such that $\\xi _ i|_{V_ i \\cap V_ j} = \\xi _ j|_{V_ i \\cap V_ j}$. Say $\\xi _ i = (g_ i, \\{ h_{i, U}\\} )$. Then we immediately see that the morphisms $g_ i$ glue to a unique global morphism $g : T \\to S$. Moreover, it is clear that $g^{-1}(U) = \\bigcup g_ i^{-1}(U)$. Hence the morphisms $h_{i, U} : g_ i^{-1}(U) \\to X_ U$ glue to a unique morphism $h_ U : g^{-1}(U) \\to X_ U$. It is easy to verify that the system $(g, \\{ h_ U\\} )$ is an element of $F(T)$. Hence $F$ satisfies the sheaf property for the Zariski topology. \n    \n      Next we verify that each $F_ W$, $W \\in \\mathcal{B}$ is representable. Namely, we claim that the transformation of functors \n    \n      \n  \\[  F_ W \\longrightarrow \\mathop{\\mathrm{Mor}}\\nolimits (-, X_ W), \\  (g, \\{ h_ U\\} ) \\longmapsto h_ W  \\]\n\n    \n       is an isomorphism. To see this suppose that $T$ is a scheme and $\\alpha : T \\to X_ W$ is a morphism. Set $g = f_ W \\circ \\alpha $. For any $U \\in \\mathcal{B}$ such that $U \\subset W$ we can define $h_ U : g^{-1}(U) \\to X_ U$ be the composition $(\\rho ^ W_ U)^{-1} \\circ \\alpha |_{g^{-1}(U)}$. This works because the image $\\alpha (g^{-1}(U))$ is contained in $f_ W^{-1}(U)$ and condition (a) of the lemma. It is clear that $f_ U \\circ h_ U = g|_{g^{-1}(U)}$ for such a $U$. Moreover, if also $V \\in \\mathcal{B}$ and $V \\subset U \\subset W$, then $\\rho ^ U_ V \\circ h_ V = h_ U|_{g^{-1}(V)}$ by property (b) of the lemma. We still have to define $h_ U$ for an arbitrary element $U \\in \\mathcal{B}$. Since $\\mathcal{B}$ is a basis for the topology on $S$ we can find an open covering $U \\cap W = \\bigcup U_ i$ with $U_ i \\in \\mathcal{B}$. Since $g$ maps into $W$ we have $g^{-1}(U) = g^{-1}(U \\cap W) = \\bigcup g^{-1}(U_ i)$. Consider the morphisms $h_ i = \\rho ^ U_{U_ i} \\circ h_{U_ i} : g^{-1}(U_ i) \\to X_ U$. It is a simple matter to use condition (b) of the lemma to prove that $h_ i|_{g^{-1}(U_ i) \\cap g^{-1}(U_ j)} = h_ j|_{g^{-1}(U_ i) \\cap g^{-1}(U_ j)}$. Hence these morphisms glue to give the desired morphism $h_ U : g^{-1}(U) \\to X_ U$. We omit the (easy) verification that the system $(g, \\{ h_ U\\} )$ is an element of $F_ W(T)$ which maps to $\\alpha $ under the displayed arrow above. \n    \n      Next, we verify each $F_ W \\subset F$ is representable by open immersions. This is clear from the definitions. \n    \n      Finally we have to verify the collection $(F_ W)_{W \\in \\mathcal{B}}$ covers $F$. This is clear by construction and the fact that $\\mathcal{B}$ is a basis for the topology of $S$. \n    \n      Let $X$ be a scheme representing the functor $F$. Let $(f, \\{ i_ U\\} ) \\in F(X)$ be a \xe2\x80\x9cuniversal family\xe2\x80\x9d. Since each $F_ W$ is representable by $X_ W$ (via the morphism of functors displayed above) we see that $i_ W : f^{-1}(W) \\to X_ W$ is an isomorphism as desired. The lemma is proved. \n      $\\square$\n    \n","\n  Lemma 27.2.1. Let $S$ be a scheme. Let $\\mathcal{B}$ be a basis for the topology of $S$. Suppose given the following data: \n  \n  \nFor every $U \\in \\mathcal{B}$ a scheme $f_ U : X_ U \\to U$ over $U$. \n\n\nFor $U, V \\in \\mathcal{B}$ with $V \\subset U$ a morphism $\\rho ^ U_ V : X_ V \\to X_ U$ over $U$. \n\n\n\n   Assume that \n  \n  \neach $\\rho ^ U_ V$ induces an isomorphism $X_ V \\to f_ U^{-1}(V)$ of schemes over $V$, \n\n\nwhenever $W, V, U \\in \\mathcal{B}$, with $W \\subset V \\subset U$ we have $\\rho ^ U_ W = \\rho ^ U_ V \\circ \\rho ^ V_ W$. \n\n\n\n   Then there exists a morphism $f : X \\to S$ of schemes and isomorphisms $i_ U : f^{-1}(U) \\to X_ U$ over $U \\in \\mathcal{B}$ such that for $V, U \\in \\mathcal{B}$ with $V \\subset U$ the composition \n  \n  \\[  \\xymatrix{ X_ V \\ar[r]^{i_ V^{-1}} &  f^{-1}(V) \\ar[rr]^{inclusion} &  &  f^{-1}(U) \\ar[r]^{i_ U} &  X_ U }  \\]\n\n   is the morphism $\\rho ^ U_ V$. Moreover $X$ is unique up to unique isomorphism over $S$. \n\n    \n","Proof.\n      To prove this we will use Schemes, Lemma 26.15.4. First we define a contravariant functor $F$ from the category of schemes to the category of sets. Namely, for a scheme $T$ we set \n    \n      \n  \\[  F(T) = \\left\\{  \\begin{matrix}  (g, \\{ h_ U\\} _{U \\in \\mathcal{B}}), \\  g : T \\to S, \\  h_ U : g^{-1}(U) \\to X_ U, \n\n\\\\  f_ U \\circ h_ U = g|_{g^{-1}(U)}, \\  h_ U|_{g^{-1}(V)} = \\rho ^ U_ V \\circ h_ V \\  \\forall \\  V, U \\in \\mathcal{B}, V \\subset U \n\n\\end{matrix} \\right\\} .  \\]\n\n    \n       The restriction mapping $F(T) \\to F(T\')$ given a morphism $T\' \\to T$ is just gotten by composition. For any $W \\in \\mathcal{B}$ we consider the subfunctor $F_ W \\subset F$ consisting of those systems $(g, \\{ h_ U\\} )$ such that $g(T) \\subset W$. \n    \n      First we show $F$ satisfies the sheaf property for the Zariski topology. Suppose that $T$ is a scheme, $T = \\bigcup V_ i$ is an open covering, and $\\xi _ i \\in F(V_ i)$ is an element such that $\\xi _ i|_{V_ i \\cap V_ j} = \\xi _ j|_{V_ i \\cap V_ j}$. Say $\\xi _ i = (g_ i, \\{ h_{i, U}\\} )$. Then we immediately see that the morphisms $g_ i$ glue to a unique global morphism $g : T \\to S$. Moreover, it is clear that $g^{-1}(U) = \\bigcup g_ i^{-1}(U)$. Hence the morphisms $h_{i, U} : g_ i^{-1}(U) \\to X_ U$ glue to a unique morphism $h_ U : g^{-1}(U) \\to X_ U$. It is easy to verify that the system $(g, \\{ h_ U\\} )$ is an element of $F(T)$. Hence $F$ satisfies the sheaf property for the Zariski topology. \n    \n      Next we verify that each $F_ W$, $W \\in \\mathcal{B}$ is representable. Namely, we claim that the transformation of functors \n    \n      \n  \\[  F_ W \\longrightarrow \\mathop{\\mathrm{Mor}}\\nolimits (-, X_ W), \\  (g, \\{ h_ U\\} ) \\longmapsto h_ W  \\]\n\n    \n       is an isomorphism. To see this suppose that $T$ is a scheme and $\\alpha : T \\to X_ W$ is a morphism. Set $g = f_ W \\circ \\alpha $. For any $U \\in \\mathcal{B}$ such that $U \\subset W$ we can define $h_ U : g^{-1}(U) \\to X_ U$ be the composition $(\\rho ^ W_ U)^{-1} \\circ \\alpha |_{g^{-1}(U)}$. This works because the image $\\alpha (g^{-1}(U))$ is contained in $f_ W^{-1}(U)$ and condition (a) of the lemma. It is clear that $f_ U \\circ h_ U = g|_{g^{-1}(U)}$ for such a $U$. Moreover, if also $V \\in \\mathcal{B}$ and $V \\subset U \\subset W$, then $\\rho ^ U_ V \\circ h_ V = h_ U|_{g^{-1}(V)}$ by property (b) of the lemma. We still have to define $h_ U$ for an arbitrary element $U \\in \\mathcal{B}$. Since $\\mathcal{B}$ is a basis for the topology on $S$ we can find an open covering $U \\cap W = \\bigcup U_ i$ with $U_ i \\in \\mathcal{B}$. Since $g$ maps into $W$ we have $g^{-1}(U) = g^{-1}(U \\cap W) = \\bigcup g^{-1}(U_ i)$. Consider the morphisms $h_ i = \\rho ^ U_{U_ i} \\circ h_{U_ i} : g^{-1}(U_ i) \\to X_ U$. It is a simple matter to use condition (b) of the lemma to prove that $h_ i|_{g^{-1}(U_ i) \\cap g^{-1}(U_ j)} = h_ j|_{g^{-1}(U_ i) \\cap g^{-1}(U_ j)}$. Hence these morphisms glue to give the desired morphism $h_ U : g^{-1}(U) \\to X_ U$. We omit the (easy) verification that the system $(g, \\{ h_ U\\} )$ is an element of $F_ W(T)$ which maps to $\\alpha $ under the displayed arrow above. \n    \n      Next, we verify each $F_ W \\subset F$ is representable by open immersions. This is clear from the definitions. \n    \n      Finally we have to verify the collection $(F_ W)_{W \\in \\mathcal{B}}$ covers $F$. This is clear by construction and the fact that $\\mathcal{B}$ is a basis for the topology of $S$. \n    \n      Let $X$ be a scheme representing the functor $F$. Let $(f, \\{ i_ U\\} ) \\in F(X)$ be a \xe2\x80\x9cuniversal family\xe2\x80\x9d. Since each $F_ W$ is representable by $X_ W$ (via the morphism of functors displayed above) we see that $i_ W : f^{-1}(W) \\to X_ W$ is an isomorphism as desired. The lemma is proved. \n      $\\square$\n    \n","
  colimit d.functor
",noncomputable abbrev glued : Scheme.{u} ,"Proof.\n      To prove this we will use Schemes, Lemma 26.15.4 [[\n  Lemma 26.15.4. Let $F$ be a contravariant functor on the category of schemes with values in the category of sets. Suppose that \n  \n  \n$F$ satisfies the sheaf property for the Zariski topology, \n\n\nthere exists a set $I$ and a collection of subfunctors $F_ i \\subset F$ such that \n\n\n  \neach $F_ i$ is representable, \n\n\neach $F_ i \\subset F$ is representable by open immersions, and \n\n\nthe collection $(F_ i)_{i \\in I}$ covers $F$. \n\n\n\n\n\n   Then $F$ is representable. \n\n    \n]]. First we define a contravariant functor $F$ from the category of schemes to the category of sets. Namely, for a scheme $T$ we set \n    \n      \n  \\[  F(T) = \\left\\{  \\begin{matrix}  (g, \\{ h_ U\\} _{U \\in \\mathcal{B}}), \\  g : T \\to S, \\  h_ U : g^{-1}(U) \\to X_ U, \n\n\\\\  f_ U \\circ h_ U = g|_{g^{-1}(U)}, \\  h_ U|_{g^{-1}(V)} = \\rho ^ U_ V \\circ h_ V \\  \\forall \\  V, U \\in \\mathcal{B}, V \\subset U \n\n\\end{matrix} \\right\\} .  \\]\n\n    \n       The restriction mapping $F(T) \\to F(T\')$ given a morphism $T\' \\to T$ is just gotten by composition. For any $W \\in \\mathcal{B}$ we consider the subfunctor $F_ W \\subset F$ consisting of those systems $(g, \\{ h_ U\\} )$ such that $g(T) \\subset W$. \n    \n      First we show $F$ satisfies the sheaf property for the Zariski topology. Suppose that $T$ is a scheme, $T = \\bigcup V_ i$ is an open covering, and $\\xi _ i \\in F(V_ i)$ is an element such that $\\xi _ i|_{V_ i \\cap V_ j} = \\xi _ j|_{V_ i \\cap V_ j}$. Say $\\xi _ i = (g_ i, \\{ h_{i, U}\\} )$. Then we immediately see that the morphisms $g_ i$ glue to a unique global morphism $g : T \\to S$. Moreover, it is clear that $g^{-1}(U) = \\bigcup g_ i^{-1}(U)$. Hence the morphisms $h_{i, U} : g_ i^{-1}(U) \\to X_ U$ glue to a unique morphism $h_ U : g^{-1}(U) \\to X_ U$. It is easy to verify that the system $(g, \\{ h_ U\\} )$ is an element of $F(T)$. Hence $F$ satisfies the sheaf property for the Zariski topology. \n    \n      Next we verify that each $F_ W$, $W \\in \\mathcal{B}$ is representable. Namely, we claim that the transformation of functors \n    \n      \n  \\[  F_ W \\longrightarrow \\mathop{\\mathrm{Mor}}\\nolimits (-, X_ W), \\  (g, \\{ h_ U\\} ) \\longmapsto h_ W  \\]\n\n    \n       is an isomorphism. To see this suppose that $T$ is a scheme and $\\alpha : T \\to X_ W$ is a morphism. Set $g = f_ W \\circ \\alpha $. For any $U \\in \\mathcal{B}$ such that $U \\subset W$ we can define $h_ U : g^{-1}(U) \\to X_ U$ be the composition $(\\rho ^ W_ U)^{-1} \\circ \\alpha |_{g^{-1}(U)}$. This works because the image $\\alpha (g^{-1}(U))$ is contained in $f_ W^{-1}(U)$ and condition (a) of the lemma. It is clear that $f_ U \\circ h_ U = g|_{g^{-1}(U)}$ for such a $U$. Moreover, if also $V \\in \\mathcal{B}$ and $V \\subset U \\subset W$, then $\\rho ^ U_ V \\circ h_ V = h_ U|_{g^{-1}(V)}$ by property (b) of the lemma. We still have to define $h_ U$ for an arbitrary element $U \\in \\mathcal{B}$. Since $\\mathcal{B}$ is a basis for the topology on $S$ we can find an open covering $U \\cap W = \\bigcup U_ i$ with $U_ i \\in \\mathcal{B}$. Since $g$ maps into $W$ we have $g^{-1}(U) = g^{-1}(U \\cap W) = \\bigcup g^{-1}(U_ i)$. Consider the morphisms $h_ i = \\rho ^ U_{U_ i} \\circ h_{U_ i} : g^{-1}(U_ i) \\to X_ U$. It is a simple matter to use condition (b) of the lemma to prove that $h_ i|_{g^{-1}(U_ i) \\cap g^{-1}(U_ j)} = h_ j|_{g^{-1}(U_ i) \\cap g^{-1}(U_ j)}$. Hence these morphisms glue to give the desired morphism $h_ U : g^{-1}(U) \\to X_ U$. We omit the (easy) verification that the system $(g, \\{ h_ U\\} )$ is an element of $F_ W(T)$ which maps to $\\alpha $ under the displayed arrow above. \n    \n      Next, we verify each $F_ W \\subset F$ is representable by open immersions. This is clear from the definitions. \n    \n      Finally we have to verify the collection $(F_ W)_{W \\in \\mathcal{B}}$ covers $F$. This is clear by construction and the fact that $\\mathcal{B}$ is a basis for the topology of $S$. \n    \n      Let $X$ be a scheme representing the functor $F$. Let $(f, \\{ i_ U\\} ) \\in F(X)$ be a \xe2\x80\x9cuniversal family\xe2\x80\x9d. Since each $F_ W$ is representable by $X_ W$ (via the morphism of functors displayed above) we see that $i_ W : f^{-1}(W) \\to X_ W$ is an isomorphism as desired. The lemma is proved. \n      $\\square$\n    \n"
24,0BX6,"lemma spread_out_of_isGermInjective [LocallyOfFiniteType sY] {x : X} [X.IsGermInjectiveAt x] {y : Y}
    (e : sX x = sY y) (Ï† : Y.presheaf.stalk y âŸ¶ X.presheaf.stalk x)
    (h : sY.stalkMap y â‰« Ï† =
      S.presheaf.stalkSpecializes (Inseparable.of_eq e).specializes â‰« sX.stalkMap x) :
    âˆƒ (U : X.Opens) (hxU : x âˆˆ U) (f : U.toScheme âŸ¶ Y),
      Spec.map Ï† â‰« Y.fromSpecStalk y = U.fromSpecStalkOfMem x hxU â‰« f âˆ§
      f â‰« sY = U.Î¹ â‰« sX := by
  obtain âŸ¨_, âŸ¨U, hU, rflâŸ©, hxU, -âŸ© :=
    S.isBasis_affineOpens.exists_subset_of_mem_open (Set.mem_univ (sX x)) isOpen_univ
  have hyU : sY y âˆˆ U := e â–¸ hxU
  obtain âŸ¨_, âŸ¨V : Y.Opens, hV, rflâŸ©, hyV, iVUâŸ© :=
    Y.isBasis_affineOpens.exists_subset_of_mem_open hyU (sY â»Â¹áµ U).2
  have : sY.appLE U V iVU â‰« Y.presheaf.germ V y hyV â‰« Ï† =
      sX.app U â‰« X.presheaf.germ (sX â»Â¹áµ U) x hxU := by
    rw [Scheme.Hom.appLE, Category.assoc, Y.presheaf.germ_res_assoc,
      â† Scheme.Hom.germ_stalkMap_assoc, h]
    simp
  obtain âŸ¨W, hxW, Ï†', i, hW, hâ‚, hâ‚‚âŸ© :=
    exists_lift_of_germInjective (R := Î“(S, U)) (A := Î“(Y, V)) (U := sX â»Â¹áµ U) (x := x) hxU
    (Y.presheaf.germ _ y hyV â‰« Ï†) (sY.appLE U V iVU) (sX.app U)
    (sY.finiteType_appLE hU hV _) this
  refine âŸ¨W, hxW, W.toSpecÎ“ â‰« Spec.map Ï†' â‰« hV.fromSpec, ?_, ?_âŸ©
  Â· rw [W.fromSpecStalkOfMem_toSpecÎ“_assoc x hxW, â† Spec.map_comp_assoc, â† hâ‚,
      Spec.map_comp, Category.assoc, â† IsAffineOpen.fromSpecStalk,
      IsAffineOpen.fromSpecStalk_eq_fromSpecStalk]
  Â· simp only [Category.assoc]
    rw [â† IsAffineOpen.SpecMap_appLE_fromSpec sY hU hV iVU, â† Spec.map_comp_assoc, â† hâ‚‚,
      â† Scheme.Hom.appLE, â† hW.isoSpec_hom, IsAffineOpen.SpecMap_appLE_fromSpec sX hU hW i,
      â† Iso.eq_inv_comp, IsAffineOpen.isoSpec_inv_Î¹_assoc]
",Formal Proof of Stacks Project Tag 0BX6,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/SpreadingOut.lean#L328-L356,Q27041,,29.42.4,lemma,3.0,"['0BX4', '01QL', '0ELP']","\n  Lemma 29.42.4. Let $S$ be a scheme. Let $X$, $Y$ be schemes over $S$. Let $s \\in S$ and $x \\in X$, $y \\in Y$ points over $s$. \n  \n  \nLet $f, g : X \\to Y$ be morphisms over $S$ such that $f(x) = g(x) = y$ and $f^\\sharp _ x = g^\\sharp _ x : \\mathcal{O}_{Y, y} \\to \\mathcal{O}_{X, x}$. Then there is an open neighbourhood $U \\subset X$ with $f|_ U = g|_ U$ in the following cases \n\n\n  \n$Y$ is locally of finite type over $S$, \n\n\n$X$ is integral, \n\n\n$X$ is locally Noetherian, or \n\n\n$X$ is reduced with finitely many irreducible components. \n\n\n\n\nLet $\\varphi : \\mathcal{O}_{Y, y} \\to \\mathcal{O}_{X, x}$ be a local $\\mathcal{O}_{S, s}$-algebra map. Then there exists an open neighbourhood $U \\subset X$ of $x$ and a morphism $f : U \\to Y$ mapping $x$ to $y$ with $f^\\sharp _ x = \\varphi $ in the following cases \n\n\n  \n$Y$ is locally of finite presentation over $S$, \n\n\n$Y$ is locally of finite type and $X$ is integral, \n\n\n$Y$ is locally of finite type and $X$ is locally Noetherian, or \n\n\n$Y$ is locally of finite type and $X$ is reduced with finitely many irreducible components. \n\n\n\n\n\n\n    \n      Proof.\n      Proof of (1). We may replace $X$, $Y$, $S$ by suitable affine open neighbourhoods of $x$, $y$, $s$ and reduce to the following algebra problem: given a ring $R$, two $R$-algebra maps $\\varphi , \\psi : B \\to A$ such that \n    \n      \n  \n$R \\to B$ is of finite type, or $A$ is a domain, or $A$ is Noetherian, or $A$ is reduced and has finitely many minimal primes, \n\n\nthe two maps $B \\to A_\\mathfrak p$ are the same for some prime $\\mathfrak p \\subset A$, \n\n\n\n    \n       show that $\\varphi , \\psi $ define the same map $B \\to A_ g$ for a suitable $g \\in A$, $g \\not\\in \\mathfrak p$. If $R \\to B$ is of finite type, let $t_1, \\ldots , t_ m \\in B$ be generators of $B$ as an $R$-algebra. For each $j$ we can find $g_ j \\in A$, $g_ j \\not\\in \\mathfrak p$ such that $\\varphi (t_ j)$ and $\\psi (t_ j)$ have the same image in $A_{g_ j}$. Then we set $g = \\prod g_ j$. In the other cases (if $A$ is a domain, Noetherian, or reduced with finitely many minimal primes), we can find a $g \\in A$, $g \\not\\in \\mathfrak p$ such that $A_ g \\subset A_\\mathfrak p$. See Algebra, Lemma 10.31.9. Thus the maps $B \\to A_ g$ are equal as desired. \n    \n      Proof of (2). To do this we may replace $X$, $Y$, and $S$ by suitable affine opens. Say $X = \\mathop{\\mathrm{Spec}}(A)$, $Y = \\mathop{\\mathrm{Spec}}(B)$, and $S = \\mathop{\\mathrm{Spec}}(R)$. Let $\\mathfrak p \\subset A$ be the prime ideal corresponding to $x$. Let $\\mathfrak q \\subset B$ be the prime corresponding to $y$. Then $\\varphi $ is a local $R$-algebra map $\\varphi : B_\\mathfrak q \\to A_\\mathfrak p$. If $R \\to B$ is a ring map of finite presentation, then there exists a $g \\in A \\setminus \\mathfrak p$ and an $R$-algebra map $B \\to A_ g$ such that \n    \n      \n  \\[  \\xymatrix{ B_\\mathfrak q \\ar[r]_\\varphi &  A_\\mathfrak p \\\\  B \\ar[u] \\ar[r] &  A_ g \\ar[u] }  \\]\n\n    \n       commutes, see Algebra, Lemmas 10.127.3 and 10.9.9. The induced morphism $\\mathop{\\mathrm{Spec}}(A_ g) \\to \\mathop{\\mathrm{Spec}}(B)$ works. If $B$ is of finite type over $R$, let $t_1, \\ldots , t_ m \\in B$ be generators of $B$ as an $R$-algebra. Then we can choose $g_ j \\in A$, $g_ j \\not\\in \\mathfrak p$ such that $\\varphi (t_ j) \\in \\mathop{\\mathrm{Im}}(A_{g_ j} \\to A_\\mathfrak p)$. Thus after replacing $A$ by $A[1/\\prod g_ j]$ we may assume that $B$ maps into the image of $A \\to A_\\mathfrak p$. If we can find a $g \\in A$, $g \\not\\in \\mathfrak p$ such that $A_ g \\to A_\\mathfrak p$ is injective, then we\'ll get the desired $R$-algebra map $B \\to A_ g$. Thus the proof is finished by another application of See Algebra, Lemma 10.31.9. \n      $\\square$\n    \n","\n  Lemma 29.42.4. Let $S$ be a scheme. Let $X$, $Y$ be schemes over $S$. Let $s \\in S$ and $x \\in X$, $y \\in Y$ points over $s$. \n  \n  \nLet $f, g : X \\to Y$ be morphisms over $S$ such that $f(x) = g(x) = y$ and $f^\\sharp _ x = g^\\sharp _ x : \\mathcal{O}_{Y, y} \\to \\mathcal{O}_{X, x}$. Then there is an open neighbourhood $U \\subset X$ with $f|_ U = g|_ U$ in the following cases \n\n\n  \n$Y$ is locally of finite type over $S$, \n\n\n$X$ is integral, \n\n\n$X$ is locally Noetherian, or \n\n\n$X$ is reduced with finitely many irreducible components. \n\n\n\n\nLet $\\varphi : \\mathcal{O}_{Y, y} \\to \\mathcal{O}_{X, x}$ be a local $\\mathcal{O}_{S, s}$-algebra map. Then there exists an open neighbourhood $U \\subset X$ of $x$ and a morphism $f : U \\to Y$ mapping $x$ to $y$ with $f^\\sharp _ x = \\varphi $ in the following cases \n\n\n  \n$Y$ is locally of finite presentation over $S$, \n\n\n$Y$ is locally of finite type and $X$ is integral, \n\n\n$Y$ is locally of finite type and $X$ is locally Noetherian, or \n\n\n$Y$ is locally of finite type and $X$ is reduced with finitely many irreducible components. \n\n\n\n\n\n\n    \n","Proof.\n      Proof of (1). We may replace $X$, $Y$, $S$ by suitable affine open neighbourhoods of $x$, $y$, $s$ and reduce to the following algebra problem: given a ring $R$, two $R$-algebra maps $\\varphi , \\psi : B \\to A$ such that \n    \n      \n  \n$R \\to B$ is of finite type, or $A$ is a domain, or $A$ is Noetherian, or $A$ is reduced and has finitely many minimal primes, \n\n\nthe two maps $B \\to A_\\mathfrak p$ are the same for some prime $\\mathfrak p \\subset A$, \n\n\n\n    \n       show that $\\varphi , \\psi $ define the same map $B \\to A_ g$ for a suitable $g \\in A$, $g \\not\\in \\mathfrak p$. If $R \\to B$ is of finite type, let $t_1, \\ldots , t_ m \\in B$ be generators of $B$ as an $R$-algebra. For each $j$ we can find $g_ j \\in A$, $g_ j \\not\\in \\mathfrak p$ such that $\\varphi (t_ j)$ and $\\psi (t_ j)$ have the same image in $A_{g_ j}$. Then we set $g = \\prod g_ j$. In the other cases (if $A$ is a domain, Noetherian, or reduced with finitely many minimal primes), we can find a $g \\in A$, $g \\not\\in \\mathfrak p$ such that $A_ g \\subset A_\\mathfrak p$. See Algebra, Lemma 10.31.9. Thus the maps $B \\to A_ g$ are equal as desired. \n    \n      Proof of (2). To do this we may replace $X$, $Y$, and $S$ by suitable affine opens. Say $X = \\mathop{\\mathrm{Spec}}(A)$, $Y = \\mathop{\\mathrm{Spec}}(B)$, and $S = \\mathop{\\mathrm{Spec}}(R)$. Let $\\mathfrak p \\subset A$ be the prime ideal corresponding to $x$. Let $\\mathfrak q \\subset B$ be the prime corresponding to $y$. Then $\\varphi $ is a local $R$-algebra map $\\varphi : B_\\mathfrak q \\to A_\\mathfrak p$. If $R \\to B$ is a ring map of finite presentation, then there exists a $g \\in A \\setminus \\mathfrak p$ and an $R$-algebra map $B \\to A_ g$ such that \n    \n      \n  \\[  \\xymatrix{ B_\\mathfrak q \\ar[r]_\\varphi &  A_\\mathfrak p \\\\  B \\ar[u] \\ar[r] &  A_ g \\ar[u] }  \\]\n\n    \n       commutes, see Algebra, Lemmas 10.127.3 and 10.9.9. The induced morphism $\\mathop{\\mathrm{Spec}}(A_ g) \\to \\mathop{\\mathrm{Spec}}(B)$ works. If $B$ is of finite type over $R$, let $t_1, \\ldots , t_ m \\in B$ be generators of $B$ as an $R$-algebra. Then we can choose $g_ j \\in A$, $g_ j \\not\\in \\mathfrak p$ such that $\\varphi (t_ j) \\in \\mathop{\\mathrm{Im}}(A_{g_ j} \\to A_\\mathfrak p)$. Thus after replacing $A$ by $A[1/\\prod g_ j]$ we may assume that $B$ maps into the image of $A \\to A_\\mathfrak p$. If we can find a $g \\in A$, $g \\not\\in \\mathfrak p$ such that $A_ g \\to A_\\mathfrak p$ is injective, then we\'ll get the desired $R$-algebra map $B \\to A_ g$. Thus the proof is finished by another application of See Algebra, Lemma 10.31.9. \n      $\\square$\n    \n"," by
  obtain âŸ¨_, âŸ¨U, hU, rflâŸ©, hxU, -âŸ© :=
    S.isBasis_affineOpens.exists_subset_of_mem_open (Set.mem_univ (sX x)) isOpen_univ
  have hyU : sY y âˆˆ U := e â–¸ hxU
  obtain âŸ¨_, âŸ¨V : Y.Opens, hV, rflâŸ©, hyV, iVUâŸ© :=
    Y.isBasis_affineOpens.exists_subset_of_mem_open hyU (sY â»Â¹áµ U).2
  have : sY.appLE U V iVU â‰« Y.presheaf.germ V y hyV â‰« Ï† =
      sX.app U â‰« X.presheaf.germ (sX â»Â¹áµ U) x hxU := by
    rw [Scheme.Hom.appLE, Category.assoc, Y.presheaf.germ_res_assoc,
      â† Scheme.Hom.germ_stalkMap_assoc, h]
    simp
  obtain âŸ¨W, hxW, Ï†', i, hW, hâ‚, hâ‚‚âŸ© :=
    exists_lift_of_germInjective (R := Î“(S, U)) (A := Î“(Y, V)) (U := sX â»Â¹áµ U) (x := x) hxU
    (Y.presheaf.germ _ y hyV â‰« Ï†) (sY.appLE U V iVU) (sX.app U)
    (sY.finiteType_appLE hU hV _) this
  refine âŸ¨W, hxW, W.toSpecÎ“ â‰« Spec.map Ï†' â‰« hV.fromSpec, ?_, ?_âŸ©
  Â· rw [W.fromSpecStalkOfMem_toSpecÎ“_assoc x hxW, â† Spec.map_comp_assoc, â† hâ‚,
      Spec.map_comp, Category.assoc, â† IsAffineOpen.fromSpecStalk,
      IsAffineOpen.fromSpecStalk_eq_fromSpecStalk]
  Â· simp only [Category.assoc]
    rw [â† IsAffineOpen.SpecMap_appLE_fromSpec sY hU hV iVU, â† Spec.map_comp_assoc, â† hâ‚‚,
      â† Scheme.Hom.appLE, â† hW.isoSpec_hom, IsAffineOpen.SpecMap_appLE_fromSpec sX hU hW i,
      â† Iso.eq_inv_comp, IsAffineOpen.isoSpec_inv_Î¹_assoc]
","lemma spread_out_of_isGermInjective [LocallyOfFiniteType sY] {x : X} [X.IsGermInjectiveAt x] {y : Y}
    (e : sX x = sY y) (Ï† : Y.presheaf.stalk y âŸ¶ X.presheaf.stalk x)
    (h : sY.stalkMap y â‰« Ï† =
      S.presheaf.stalkSpecializes (Inseparable.of_eq e).specializes â‰« sX.stalkMap x) :
    âˆƒ (U : X.Opens) (hxU : x âˆˆ U) (f : U.toScheme âŸ¶ Y),
      Spec.map Ï† â‰« Y.fromSpecStalk y = U.fromSpecStalkOfMem x hxU â‰« f âˆ§
      f â‰« sY = U.Î¹ â‰« sX ","Proof.\n      Proof of (1). We may replace $X$, $Y$, $S$ by suitable affine open neighbourhoods of $x$, $y$, $s$ and reduce to the following algebra problem: given a ring $R$, two $R$-algebra maps $\\varphi , \\psi : B \\to A$ such that \n    \n      \n  \n$R \\to B$ is of finite type, or $A$ is a domain, or $A$ is Noetherian, or $A$ is reduced and has finitely many minimal primes, \n\n\nthe two maps $B \\to A_\\mathfrak p$ are the same for some prime $\\mathfrak p \\subset A$, \n\n\n\n    \n       show that $\\varphi , \\psi $ define the same map $B \\to A_ g$ for a suitable $g \\in A$, $g \\not\\in \\mathfrak p$. If $R \\to B$ is of finite type, let $t_1, \\ldots , t_ m \\in B$ be generators of $B$ as an $R$-algebra. For each $j$ we can find $g_ j \\in A$, $g_ j \\not\\in \\mathfrak p$ such that $\\varphi (t_ j)$ and $\\psi (t_ j)$ have the same image in $A_{g_ j}$. Then we set $g = \\prod g_ j$. In the other cases (if $A$ is a domain, Noetherian, or reduced with finitely many minimal primes), we can find a $g \\in A$, $g \\not\\in \\mathfrak p$ such that $A_ g \\subset A_\\mathfrak p$. See Algebra, Lemma 10.31.9 [[\n  Lemma 10.31.9. Let $R$ be a ring and $\\mathfrak p \\subset R$ be a prime. There exists an $f \\in R$, $f \\not\\in \\mathfrak p$ such that $R_ f \\to R_\\mathfrak p$ is injective in each of the following cases \n  \n  \n$R$ is a domain, \n\n\n$R$ is Noetherian, or \n\n\n$R$ is reduced and has finitely many minimal primes. \n\n\n\n\n    \n]]. Thus the maps $B \\to A_ g$ are equal as desired. \n    \n      Proof of (2). To do this we may replace $X$, $Y$, and $S$ by suitable affine opens. Say $X = \\mathop{\\mathrm{Spec}}(A)$, $Y = \\mathop{\\mathrm{Spec}}(B)$, and $S = \\mathop{\\mathrm{Spec}}(R)$. Let $\\mathfrak p \\subset A$ be the prime ideal corresponding to $x$. Let $\\mathfrak q \\subset B$ be the prime corresponding to $y$. Then $\\varphi $ is a local $R$-algebra map $\\varphi : B_\\mathfrak q \\to A_\\mathfrak p$. If $R \\to B$ is a ring map of finite presentation, then there exists a $g \\in A \\setminus \\mathfrak p$ and an $R$-algebra map $B \\to A_ g$ such that \n    \n      \n  \\[  \\xymatrix{ B_\\mathfrak q \\ar[r]_\\varphi &  A_\\mathfrak p \\\\  B \\ar[u] \\ar[r] &  A_ g \\ar[u] }  \\]\n\n    \n       commutes, see Algebra, Lemmas 10.127.3 [[\n  Lemma 10.127.3. Let $\\varphi : R \\to S$ be a ring map. The following are equivalent \n  \n  \n$\\varphi $ is of finite presentation, \n\n\nfor every directed system $A_\\lambda $ of $R$-algebras the map \n\n\n  \\[  \\mathop{\\mathrm{colim}}\\nolimits _\\lambda \\mathop{\\mathrm{Hom}}\\nolimits _ R(S, A_\\lambda ) \\longrightarrow \\mathop{\\mathrm{Hom}}\\nolimits _ R(S, \\mathop{\\mathrm{colim}}\\nolimits _\\lambda A_\\lambda )  \\]\n\n\n is bijective, and \n\n\nfor every directed system $A_\\lambda $ of $R$-algebras the map \n\n\n  \\[  \\mathop{\\mathrm{colim}}\\nolimits _\\lambda \\mathop{\\mathrm{Hom}}\\nolimits _ R(S, A_\\lambda ) \\longrightarrow \\mathop{\\mathrm{Hom}}\\nolimits _ R(S, \\mathop{\\mathrm{colim}}\\nolimits _\\lambda A_\\lambda )  \\]\n\n\n is surjective. \n\n\n\n\n    \n]] and 10.9.9 [[\n  Lemma 10.9.9. Let $R$ be a ring. Let $S \\subset R$ be a multiplicative subset. Let $M$ be an $R$-module. Then \n  \n  \\[  S^{-1}M = \\mathop{\\mathrm{colim}}\\nolimits _{f \\in S} M_ f  \\]\n\n   where the preorder on $S$ is given by $f \\geq f\' \\Leftrightarrow f = f\'f\'\'$ for some $f\'\' \\in R$ in which case the map $M_{f\'} \\to M_ f$ is given by $m/(f\')^ e \\mapsto m(f\'\')^ e/f^ e$. \n\n    \n]]. The induced morphism $\\mathop{\\mathrm{Spec}}(A_ g) \\to \\mathop{\\mathrm{Spec}}(B)$ works. If $B$ is of finite type over $R$, let $t_1, \\ldots , t_ m \\in B$ be generators of $B$ as an $R$-algebra. Then we can choose $g_ j \\in A$, $g_ j \\not\\in \\mathfrak p$ such that $\\varphi (t_ j) \\in \\mathop{\\mathrm{Im}}(A_{g_ j} \\to A_\\mathfrak p)$. Thus after replacing $A$ by $A[1/\\prod g_ j]$ we may assume that $B$ maps into the image of $A \\to A_\\mathfrak p$. If we can find a $g \\in A$, $g \\not\\in \\mathfrak p$ such that $A_ g \\to A_\\mathfrak p$ is injective, then we\'ll get the desired $R$-algebra map $B \\to A_ g$. Thus the proof is finished by another application of See Algebra, Lemma 10.31.9 [[\n  Lemma 10.31.9. Let $R$ be a ring and $\\mathfrak p \\subset R$ be a prime. There exists an $f \\in R$, $f \\not\\in \\mathfrak p$ such that $R_ f \\to R_\\mathfrak p$ is injective in each of the following cases \n  \n  \n$R$ is a domain, \n\n\n$R$ is Noetherian, or \n\n\n$R$ is reduced and has finitely many minimal primes. \n\n\n\n\n    \n]]. \n      $\\square$\n    \n"
25,01J7,"lemma range_fromSpecStalk {x : X} :
    Set.range (X.fromSpecStalk x) = { y | y â¤³ x } := by
  ext y
  constructor
  Â· rintro âŸ¨y, rflâŸ©
    exact ((IsLocalRing.specializes_closedPoint y).map (X.fromSpecStalk x).continuous).trans
      (specializes_of_eq fromSpecStalk_closedPoint)
  Â· rintro (hy : y â¤³ x)
    have := fromSpecStalk_closedPoint (x := y)
    rw [â† SpecMap_stalkSpecializes_fromSpecStalk hy] at this
    exact âŸ¨_, thisâŸ©
",Formal Proof of Stacks Project Tag 01J7,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/Stalk.lean#L178-L188,Q27041,,26.13.2,lemma,3.0,"['01J5', '01H8', '0ELP']","\n  Lemma 26.13.2. Let $X$ be a scheme. Let $x, x\' \\in X$ be points of $X$. Then $x\' \\in X$ is a generalization of $x$ if and only if $x\'$ is in the image of the canonical morphism $\\mathop{\\mathrm{Spec}}(\\mathcal{O}_{X, x}) \\to X$. \n\n    \n      Proof.\n      A continuous map preserves the relation of specialization/generalization. Since every point of $\\mathop{\\mathrm{Spec}}(\\mathcal{O}_{X, x})$ is a generalization of the closed point we see every point in the image of $\\mathop{\\mathrm{Spec}}(\\mathcal{O}_{X, x}) \\to X$ is a generalization of $x$. Conversely, suppose that $x\'$ is a generalization of $x$. Choose an affine open neighbourhood $U = \\mathop{\\mathrm{Spec}}(R)$ of $x$. Then $x\' \\in U$. Say $\\mathfrak p \\subset R$ and $\\mathfrak p\' \\subset R$ are the primes corresponding to $x$ and $x\'$. Since $x\'$ is a generalization of $x$ we see that $\\mathfrak p\' \\subset \\mathfrak p$. This means that $\\mathfrak p\'$ is in the image of the morphism $\\mathop{\\mathrm{Spec}}(\\mathcal{O}_{X, x}) = \\mathop{\\mathrm{Spec}}(R_{\\mathfrak p}) \\to \\mathop{\\mathrm{Spec}}(R) = U \\subset X$ as desired. \n      $\\square$\n    \n","\n  Lemma 26.13.2. Let $X$ be a scheme. Let $x, x\' \\in X$ be points of $X$. Then $x\' \\in X$ is a generalization of $x$ if and only if $x\'$ is in the image of the canonical morphism $\\mathop{\\mathrm{Spec}}(\\mathcal{O}_{X, x}) \\to X$. \n\n    \n","Proof.\n      A continuous map preserves the relation of specialization/generalization. Since every point of $\\mathop{\\mathrm{Spec}}(\\mathcal{O}_{X, x})$ is a generalization of the closed point we see every point in the image of $\\mathop{\\mathrm{Spec}}(\\mathcal{O}_{X, x}) \\to X$ is a generalization of $x$. Conversely, suppose that $x\'$ is a generalization of $x$. Choose an affine open neighbourhood $U = \\mathop{\\mathrm{Spec}}(R)$ of $x$. Then $x\' \\in U$. Say $\\mathfrak p \\subset R$ and $\\mathfrak p\' \\subset R$ are the primes corresponding to $x$ and $x\'$. Since $x\'$ is a generalization of $x$ we see that $\\mathfrak p\' \\subset \\mathfrak p$. This means that $\\mathfrak p\'$ is in the image of the morphism $\\mathop{\\mathrm{Spec}}(\\mathcal{O}_{X, x}) = \\mathop{\\mathrm{Spec}}(R_{\\mathfrak p}) \\to \\mathop{\\mathrm{Spec}}(R) = U \\subset X$ as desired. \n      $\\square$\n    \n"," by
  ext y
  constructor
  Â· rintro âŸ¨y, rflâŸ©
    exact ((IsLocalRing.specializes_closedPoint y).map (X.fromSpecStalk x).continuous).trans
      (specializes_of_eq fromSpecStalk_closedPoint)
  Â· rintro (hy : y â¤³ x)
    have := fromSpecStalk_closedPoint (x := y)
    rw [â† SpecMap_stalkSpecializes_fromSpecStalk hy] at this
    exact âŸ¨_, thisâŸ©
","lemma range_fromSpecStalk {x : X} :
    Set.range (X.fromSpecStalk x) = { y | y â¤³ x } ","Proof.\n      A continuous map preserves the relation of specialization/generalization. Since every point of $\\mathop{\\mathrm{Spec}}(\\mathcal{O}_{X, x})$ is a generalization of the closed point we see every point in the image of $\\mathop{\\mathrm{Spec}}(\\mathcal{O}_{X, x}) \\to X$ is a generalization of $x$. Conversely, suppose that $x\'$ is a generalization of $x$. Choose an affine open neighbourhood $U = \\mathop{\\mathrm{Spec}}(R)$ of $x$. Then $x\' \\in U$. Say $\\mathfrak p \\subset R$ and $\\mathfrak p\' \\subset R$ are the primes corresponding to $x$ and $x\'$. Since $x\'$ is a generalization of $x$ we see that $\\mathfrak p\' \\subset \\mathfrak p$. This means that $\\mathfrak p\'$ is in the image of the morphism $\\mathop{\\mathrm{Spec}}(\\mathcal{O}_{X, x}) = \\mathop{\\mathrm{Spec}}(R_{\\mathfrak p}) \\to \\mathop{\\mathrm{Spec}}(R) = U \\subset X$ as desired. \n      $\\square$\n    \n"
26,01KE,"protected lemma eq :
    ValuativeCriterion.Existence = (topologically @SpecializingMap).universally := by
  ext
  constructor
  Â· intro _
    apply MorphismProperty.universally_mono
    Â· apply specializingMap
    Â· rwa [MorphismProperty.IsStableUnderBaseChange.universally_eq]
  Â· apply of_specializingMap
",Formal Proof of Stacks Project Tag 01KE,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/ValuativeCriterion.lean#L215-L223,Q27041,,26.20.5,lemma,3.0,"['01KA', '01H8', '0ELP']","\n  Lemma 26.20.5. Let $f : X \\to S$ be a morphism of schemes. The following are equivalent \n  \n  \nSpecializations lift along any base change of $f$ \n\n\nThe morphism $f$ satisfies the existence part of the valuative criterion. \n\n\n\n\n    \n      Proof.\n      Assume (1) holds. Let a solid diagram as in Definition 26.20.3 be given. In order to find the dotted arrow we may replace $X \\to S$ by $X_{\\mathop{\\mathrm{Spec}}(A)} \\to \\mathop{\\mathrm{Spec}}(A)$ since after all the assumption is stable under base change. Thus we may assume $S = \\mathop{\\mathrm{Spec}}(A)$. Let $x\' \\in X$ be the image of $\\mathop{\\mathrm{Spec}}(K) \\to X$, so that we have $\\kappa (x\') \\subset K$, see Lemma 26.13.3. By assumption there exists a specialization $x\' \\leadsto x$ in $X$ such that $x$ maps to the closed point of $S = \\mathop{\\mathrm{Spec}}(A)$. We get a local ring map $A \\to \\mathcal{O}_{X, x}$ and a ring map $\\mathcal{O}_{X, x} \\to \\kappa (x\')$, see Lemma 26.13.2 and the discussion following Lemma 26.13.3. The composition $A \\to \\mathcal{O}_{X, x} \\to \\kappa (x\') \\to K$ is the given injection $A \\to K$. Since $A \\to \\mathcal{O}_{X, x}$ is local, the image of $\\mathcal{O}_{X, x} \\to K$ dominates $A$ and hence is equal to $A$, by Algebra, Definition 10.50.1. Thus we obtain a ring map $\\mathcal{O}_{X, x} \\to A$ and hence a morphism $\\mathop{\\mathrm{Spec}}(A) \\to X$ (see Lemma 26.13.1 and discussion following it). This proves (2). \n    \n      Conversely, assume (2) holds. It is immediate that the existence part of the valuative criterion holds for any base change $X_{S\'} \\to S\'$ of $f$ by considering the following commutative diagram \n    \n      \n  \\[  \\xymatrix{ \\mathop{\\mathrm{Spec}}(K) \\ar[r] \\ar[d] &  X_{S\'} \\ar[r] \\ar[d] &  X \\ar[d] \\\\  \\mathop{\\mathrm{Spec}}(A) \\ar[r] \\ar@{-->}[ru] \\ar@{-->}[rru] &  S\' \\ar[r] &  S }  \\]\n\n    \n       Namely, the more horizontal dotted arrow will lead to the other one by definition of the fibre product. OK, so it clearly suffices to show that specializations lift along $f$. Let $s\' \\leadsto s$ be a specialization in $S$, and let $x\' \\in X$ be a point lying over $s\'$. Apply Lemma 26.20.4 to $s\' \\leadsto s$ and the extension of fields $K = \\kappa (x\')/\\kappa (s\')$. We get a commutative diagram \n    \n      \n  \\[  \\xymatrix{ \\mathop{\\mathrm{Spec}}(K) \\ar[rr] \\ar[d] &  &  X \\ar[d] \\\\  \\mathop{\\mathrm{Spec}}(A) \\ar[r] \\ar@{-->}[rru] &  \\mathop{\\mathrm{Spec}}(\\mathcal{O}_{S, s}) \\ar[r] &  S }  \\]\n\n    \n       and by condition (2) we get the dotted arrow. The image $x$ of the closed point of $\\mathop{\\mathrm{Spec}}(A)$ in $X$ will be a solution to our problem, i.e., $x$ is a specialization of $x\'$ and maps to $s$. \n      $\\square$\n    \n",\n  Lemma 26.20.5. Let $f : X \\to S$ be a morphism of schemes. The following are equivalent \n  \n  \nSpecializations lift along any base change of $f$ \n\n\nThe morphism $f$ satisfies the existence part of the valuative criterion. \n\n\n\n\n    \n,"Proof.\n      Assume (1) holds. Let a solid diagram as in Definition 26.20.3 be given. In order to find the dotted arrow we may replace $X \\to S$ by $X_{\\mathop{\\mathrm{Spec}}(A)} \\to \\mathop{\\mathrm{Spec}}(A)$ since after all the assumption is stable under base change. Thus we may assume $S = \\mathop{\\mathrm{Spec}}(A)$. Let $x\' \\in X$ be the image of $\\mathop{\\mathrm{Spec}}(K) \\to X$, so that we have $\\kappa (x\') \\subset K$, see Lemma 26.13.3. By assumption there exists a specialization $x\' \\leadsto x$ in $X$ such that $x$ maps to the closed point of $S = \\mathop{\\mathrm{Spec}}(A)$. We get a local ring map $A \\to \\mathcal{O}_{X, x}$ and a ring map $\\mathcal{O}_{X, x} \\to \\kappa (x\')$, see Lemma 26.13.2 and the discussion following Lemma 26.13.3. The composition $A \\to \\mathcal{O}_{X, x} \\to \\kappa (x\') \\to K$ is the given injection $A \\to K$. Since $A \\to \\mathcal{O}_{X, x}$ is local, the image of $\\mathcal{O}_{X, x} \\to K$ dominates $A$ and hence is equal to $A$, by Algebra, Definition 10.50.1. Thus we obtain a ring map $\\mathcal{O}_{X, x} \\to A$ and hence a morphism $\\mathop{\\mathrm{Spec}}(A) \\to X$ (see Lemma 26.13.1 and discussion following it). This proves (2). \n    \n      Conversely, assume (2) holds. It is immediate that the existence part of the valuative criterion holds for any base change $X_{S\'} \\to S\'$ of $f$ by considering the following commutative diagram \n    \n      \n  \\[  \\xymatrix{ \\mathop{\\mathrm{Spec}}(K) \\ar[r] \\ar[d] &  X_{S\'} \\ar[r] \\ar[d] &  X \\ar[d] \\\\  \\mathop{\\mathrm{Spec}}(A) \\ar[r] \\ar@{-->}[ru] \\ar@{-->}[rru] &  S\' \\ar[r] &  S }  \\]\n\n    \n       Namely, the more horizontal dotted arrow will lead to the other one by definition of the fibre product. OK, so it clearly suffices to show that specializations lift along $f$. Let $s\' \\leadsto s$ be a specialization in $S$, and let $x\' \\in X$ be a point lying over $s\'$. Apply Lemma 26.20.4 to $s\' \\leadsto s$ and the extension of fields $K = \\kappa (x\')/\\kappa (s\')$. We get a commutative diagram \n    \n      \n  \\[  \\xymatrix{ \\mathop{\\mathrm{Spec}}(K) \\ar[rr] \\ar[d] &  &  X \\ar[d] \\\\  \\mathop{\\mathrm{Spec}}(A) \\ar[r] \\ar@{-->}[rru] &  \\mathop{\\mathrm{Spec}}(\\mathcal{O}_{S, s}) \\ar[r] &  S }  \\]\n\n    \n       and by condition (2) we get the dotted arrow. The image $x$ of the closed point of $\\mathop{\\mathrm{Spec}}(A)$ in $X$ will be a solution to our problem, i.e., $x$ is a specialization of $x\'$ and maps to $s$. \n      $\\square$\n    \n"," by
  ext
  constructor
  Â· intro _
    apply MorphismProperty.universally_mono
    Â· apply specializingMap
    Â· rwa [MorphismProperty.IsStableUnderBaseChange.universally_eq]
  Â· apply of_specializingMap
","protected lemma eq :
    ValuativeCriterion.Existence = (topologically @SpecializingMap).universally ","Proof.\n      Assume (1) holds. Let a solid diagram as in Definition 26.20.3 [[\n  Definition 26.20.3. Let $f : X \\to S$ be a morphism of schemes. We say $f$ satisfies the existence part of the valuative criterion if given any commutative solid diagram \n  \n  \\[  \\xymatrix{ \\mathop{\\mathrm{Spec}}(K) \\ar[r] \\ar[d] &  X \\ar[d] \\\\  \\mathop{\\mathrm{Spec}}(A) \\ar[r] \\ar@{-->}[ru] &  S }  \\]\n\n   where $A$ is a valuation ring with field of fractions $K$, the dotted arrow exists. We say $f$ satisfies the uniqueness part of the valuative criterion if there is at most one dotted arrow given any diagram as above (without requiring existence of course). \n]] be given. In order to find the dotted arrow we may replace $X \\to S$ by $X_{\\mathop{\\mathrm{Spec}}(A)} \\to \\mathop{\\mathrm{Spec}}(A)$ since after all the assumption is stable under base change. Thus we may assume $S = \\mathop{\\mathrm{Spec}}(A)$. Let $x\' \\in X$ be the image of $\\mathop{\\mathrm{Spec}}(K) \\to X$, so that we have $\\kappa (x\') \\subset K$, see Lemma 26.13.3 [[\n  Lemma 26.13.3. Let $X$ be a scheme. Points of $X$ correspond bijectively to equivalence classes of morphisms from spectra of fields into $X$. Moreover, each equivalence class contains a (unique up to unique isomorphism) smallest element $\\mathop{\\mathrm{Spec}}(\\kappa (x)) \\to X$. \n\n    \n]]. By assumption there exists a specialization $x\' \\leadsto x$ in $X$ such that $x$ maps to the closed point of $S = \\mathop{\\mathrm{Spec}}(A)$. We get a local ring map $A \\to \\mathcal{O}_{X, x}$ and a ring map $\\mathcal{O}_{X, x} \\to \\kappa (x\')$, see Lemma 26.13.2 [[\n  Lemma 26.13.2. Let $X$ be a scheme. Let $x, x\' \\in X$ be points of $X$. Then $x\' \\in X$ is a generalization of $x$ if and only if $x\'$ is in the image of the canonical morphism $\\mathop{\\mathrm{Spec}}(\\mathcal{O}_{X, x}) \\to X$. \n\n    \n]] and the discussion following Lemma 26.13.3 [[\n  Lemma 26.13.3. Let $X$ be a scheme. Points of $X$ correspond bijectively to equivalence classes of morphisms from spectra of fields into $X$. Moreover, each equivalence class contains a (unique up to unique isomorphism) smallest element $\\mathop{\\mathrm{Spec}}(\\kappa (x)) \\to X$. \n\n    \n]]. The composition $A \\to \\mathcal{O}_{X, x} \\to \\kappa (x\') \\to K$ is the given injection $A \\to K$. Since $A \\to \\mathcal{O}_{X, x}$ is local, the image of $\\mathcal{O}_{X, x} \\to K$ dominates $A$ and hence is equal to $A$, by Algebra, Definition 10.50.1 [[\n  Definition 10.50.1. Valuation rings. \n  \n  \nLet $K$ be a field. Let $A$, $B$ be local rings contained in $K$. We say that $B$ dominates $A$ if $A \\subset B$ and $\\mathfrak m_ A = A \\cap \\mathfrak m_ B$. \n\n\nLet $A$ be a ring. We say $A$ is a valuation ring if $A$ is a local domain and if $A$ is maximal for the relation of domination among local rings contained in the fraction field of $A$. \n\n\nLet $A$ be a valuation ring with fraction field $K$. If $R \\subset K$ is a subring of $K$, then we say $A$ is centered on $R$ if $R \\subset A$. \n\n\n\n]]. Thus we obtain a ring map $\\mathcal{O}_{X, x} \\to A$ and hence a morphism $\\mathop{\\mathrm{Spec}}(A) \\to X$ (see Lemma 26.13.1 [[\n  Lemma 26.13.1. Let $X$ be a scheme. Let $R$ be a local ring. The construction above gives a bijective correspondence between morphisms $\\mathop{\\mathrm{Spec}}(R) \\to X$ and pairs $(x, \\varphi )$ consisting of a point $x \\in X$ and a local homomorphism of local rings $\\varphi : \\mathcal{O}_{X, x} \\to R$. \n\n    \n]] and discussion following it). This proves (2). \n    \n      Conversely, assume (2) holds. It is immediate that the existence part of the valuative criterion holds for any base change $X_{S\'} \\to S\'$ of $f$ by considering the following commutative diagram \n    \n      \n  \\[  \\xymatrix{ \\mathop{\\mathrm{Spec}}(K) \\ar[r] \\ar[d] &  X_{S\'} \\ar[r] \\ar[d] &  X \\ar[d] \\\\  \\mathop{\\mathrm{Spec}}(A) \\ar[r] \\ar@{-->}[ru] \\ar@{-->}[rru] &  S\' \\ar[r] &  S }  \\]\n\n    \n       Namely, the more horizontal dotted arrow will lead to the other one by definition of the fibre product. OK, so it clearly suffices to show that specializations lift along $f$. Let $s\' \\leadsto s$ be a specialization in $S$, and let $x\' \\in X$ be a point lying over $s\'$. Apply Lemma 26.20.4 [[\n       \n      \n  Lemma 26.20.4. Let $S$ be a scheme. Let $s\' \\leadsto s$ be a specialization of points of $S$. Then \n  \n  \nthere exists a valuation ring $A$ and a morphism $f : \\mathop{\\mathrm{Spec}}(A) \\to S$ such that the generic point $\\eta $ of $\\mathop{\\mathrm{Spec}}(A)$ maps to $s\'$ and the special point maps to $s$, and \n\n\ngiven a field extension $K/\\kappa (s\')$ we may arrange it so that the extension $\\kappa (\\eta )/\\kappa (s\')$ induced by $f$ is isomorphic to the given extension. \n\n\n\n\n    \n]] to $s\' \\leadsto s$ and the extension of fields $K = \\kappa (x\')/\\kappa (s\')$. We get a commutative diagram \n    \n      \n  \\[  \\xymatrix{ \\mathop{\\mathrm{Spec}}(K) \\ar[rr] \\ar[d] &  &  X \\ar[d] \\\\  \\mathop{\\mathrm{Spec}}(A) \\ar[r] \\ar@{-->}[rru] &  \\mathop{\\mathrm{Spec}}(\\mathcal{O}_{S, s}) \\ar[r] &  S }  \\]\n\n    \n       and by condition (2) we get the dotted arrow. The image $x$ of the closed point of $\\mathop{\\mathrm{Spec}}(A)$ in $X$ will be a solution to our problem, i.e., $x$ is a specialization of $x\'$ and maps to $s$. \n      $\\square$\n    \n"
27,01KF,"lemma UniversallyClosed.of_valuativeCriterion [QuasiCompact f]
    (hf : ValuativeCriterion.Existence f) : UniversallyClosed f := by
  rw [eq_valuativeCriterion]
  exact âŸ¨hf, â€¹_â€ºâŸ©
",Formal Proof of Stacks Project Tag 01KF,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/ValuativeCriterion.lean#L235-L238,Q27041,Valuative criterion of universal closedness,26.20.6,proposition,3.0,"['01KA', '01H8', '0ELP']",\n  Proposition 26.20.6 (Valuative criterion of universal closedness).  Let $f$ be a quasi-compact morphism of schemes. Then $f$ is universally closed if and only if $f$ satisfies the existence part of the valuative criterion. \n\n    \n      Proof.\n      This is a formal consequence of Lemmas 26.20.2 and 26.20.5 above. \n      $\\square$\n    \n,\n  Proposition 26.20.6 (Valuative criterion of universal closedness).  Let $f$ be a quasi-compact morphism of schemes. Then $f$ is universally closed if and only if $f$ satisfies the existence part of the valuative criterion. \n\n    \n,Proof.\n      This is a formal consequence of Lemmas 26.20.2 and 26.20.5 above. \n      $\\square$\n    \n," by
  rw [eq_valuativeCriterion]
  exact âŸ¨hf, â€¹_â€ºâŸ©
","lemma UniversallyClosed.of_valuativeCriterion [QuasiCompact f]
    (hf : ValuativeCriterion.Existence f) : UniversallyClosed f ","Proof.\n      This is a formal consequence of Lemmas 26.20.2 [[\n  Lemma 26.20.2. Let $f : X \\to S$ be a morphism of schemes. \n  \n  \nIf $f$ is universally closed then specializations lift along any base change of $f$, see Topology, Definition 5.19.4. \n\n\nIf $f$ is quasi-compact and specializations lift along any base change of $f$, then $f$ is universally closed. \n\n\n\n\n    \n]] and 26.20.5 [[\n  Lemma 26.20.5. Let $f : X \\to S$ be a morphism of schemes. The following are equivalent \n  \n  \nSpecializations lift along any base change of $f$ \n\n\nThe morphism $f$ satisfies the existence part of the valuative criterion. \n\n\n\n\n    \n]] above. \n      $\\square$\n    \n"
28,01L0,"lemma IsSeparated.of_valuativeCriterion [QuasiSeparated f]
    (hf : ValuativeCriterion.Uniqueness f) : IsSeparated f where
  isClosedImmersion_diagonal := by
    suffices h : ValuativeCriterion.Existence (pullback.diagonal f) by
      have := UniversallyClosed.of_valuativeCriterion (pullback.diagonal f) h
      exact .of_isPreimmersion _ (pullback.diagonal f).isClosedMap.isClosed_range
    intro S
    have hc : CommSq S.iâ‚ (Spec.map (CommRingCat.ofHom (algebraMap S.R S.K)))
        f (S.iâ‚‚ â‰« pullback.fst f f â‰« f) := âŸ¨by simp [â† S.commSq.w_assoc]âŸ©
    let S' : ValuativeCommSq f := âŸ¨S.R, S.K, S.iâ‚, S.iâ‚‚ â‰« pullback.fst f f â‰« f, hcâŸ©
    have : Subsingleton S'.commSq.LiftStruct := hf S'
    let S'lâ‚ : S'.commSq.LiftStruct := âŸ¨S.iâ‚‚ â‰« pullback.fst f f,
      by simp [S', â† S.commSq.w_assoc], by simp [S']âŸ©
    let S'lâ‚‚ : S'.commSq.LiftStruct := âŸ¨S.iâ‚‚ â‰« pullback.snd f f,
      by simp [S', â† S.commSq.w_assoc], by simp [S', pullback.condition]âŸ©
    have hâ‚â‚‚ : S'lâ‚ = S'lâ‚‚ := Subsingleton.elim _ _
    constructor
    constructor
    refine âŸ¨S.iâ‚‚ â‰« pullback.fst _ _, ?_, ?_âŸ©
    Â· simp [â† S.commSq.w_assoc]
    Â· simp only [Category.assoc]
      apply IsPullback.hom_ext (IsPullback.of_hasPullback _ _)
      Â· simp
      Â· simp only [Category.assoc, pullback.diagonal_snd, Category.comp_id]
        exact congrArg CommSq.LiftStruct.l hâ‚â‚‚
",Formal Proof of Stacks Project Tag 01L0,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/ValuativeCriterion.lean#L244-L268,Q27041,Valuative criterion separatedness,26.22.2,lemma,3.0,"['01KY', '01H8', '0ELP']","\n        \n      \n  Lemma 26.22.2 (Valuative criterion separatedness). Let $f : X \\to S$ be a morphism. Assume \n  \n  \nthe morphism $f$ is quasi-separated, and \n\n\nthe morphism $f$ satisfies the uniqueness part of the valuative criterion. \n\n\n\n   Then $f$ is separated. \n\n    \n      Proof.\n      By assumption (1), Proposition 26.20.6, and Lemmas 26.21.2 and 26.10.4 we see that it suffices to prove the morphism $\\Delta _{X/S} : X \\to X \\times _ S X$ satisfies the existence part of the valuative criterion. Let a solid commutative diagram \n    \n      \n  \\[  \\xymatrix{ \\mathop{\\mathrm{Spec}}(K) \\ar[r] \\ar[d] &  X \\ar[d] \\\\  \\mathop{\\mathrm{Spec}}(A) \\ar[r] \\ar@{-->}[ru] &  X \\times _ S X }  \\]\n\n    \n       be given. The lower right arrow corresponds to a pair of morphisms $a, b : \\mathop{\\mathrm{Spec}}(A) \\to X$ over $S$. By (2) we see that $a = b$. Hence using $a$ as the dotted arrow works. \n      $\\square$\n    \n","\n        \n      \n  Lemma 26.22.2 (Valuative criterion separatedness). Let $f : X \\to S$ be a morphism. Assume \n  \n  \nthe morphism $f$ is quasi-separated, and \n\n\nthe morphism $f$ satisfies the uniqueness part of the valuative criterion. \n\n\n\n   Then $f$ is separated. \n\n    \n","Proof.\n      By assumption (1), Proposition 26.20.6, and Lemmas 26.21.2 and 26.10.4 we see that it suffices to prove the morphism $\\Delta _{X/S} : X \\to X \\times _ S X$ satisfies the existence part of the valuative criterion. Let a solid commutative diagram \n    \n      \n  \\[  \\xymatrix{ \\mathop{\\mathrm{Spec}}(K) \\ar[r] \\ar[d] &  X \\ar[d] \\\\  \\mathop{\\mathrm{Spec}}(A) \\ar[r] \\ar@{-->}[ru] &  X \\times _ S X }  \\]\n\n    \n       be given. The lower right arrow corresponds to a pair of morphisms $a, b : \\mathop{\\mathrm{Spec}}(A) \\to X$ over $S$. By (2) we see that $a = b$. Hence using $a$ as the dotted arrow works. \n      $\\square$\n    \n"," by
    suffices h : ValuativeCriterion.Existence (pullback.diagonal f) by
      have := UniversallyClosed.of_valuativeCriterion (pullback.diagonal f) h
      exact .of_isPreimmersion _ (pullback.diagonal f).isClosedMap.isClosed_range
    intro S
    have hc : CommSq S.iâ‚ (Spec.map (CommRingCat.ofHom (algebraMap S.R S.K)))
        f (S.iâ‚‚ â‰« pullback.fst f f â‰« f) := âŸ¨by simp [â† S.commSq.w_assoc]âŸ©
    let S' : ValuativeCommSq f := âŸ¨S.R, S.K, S.iâ‚, S.iâ‚‚ â‰« pullback.fst f f â‰« f, hcâŸ©
    have : Subsingleton S'.commSq.LiftStruct := hf S'
    let S'lâ‚ : S'.commSq.LiftStruct := âŸ¨S.iâ‚‚ â‰« pullback.fst f f,
      by simp [S', â† S.commSq.w_assoc], by simp [S']âŸ©
    let S'lâ‚‚ : S'.commSq.LiftStruct := âŸ¨S.iâ‚‚ â‰« pullback.snd f f,
      by simp [S', â† S.commSq.w_assoc], by simp [S', pullback.condition]âŸ©
    have hâ‚â‚‚ : S'lâ‚ = S'lâ‚‚ := Subsingleton.elim _ _
    constructor
    constructor
    refine âŸ¨S.iâ‚‚ â‰« pullback.fst _ _, ?_, ?_âŸ©
    Â· simp [â† S.commSq.w_assoc]
    Â· simp only [Category.assoc]
      apply IsPullback.hom_ext (IsPullback.of_hasPullback _ _)
      Â· simp
      Â· simp only [Category.assoc, pullback.diagonal_snd, Category.comp_id]
        exact congrArg CommSq.LiftStruct.l hâ‚â‚‚
","lemma IsSeparated.of_valuativeCriterion [QuasiSeparated f]
    (hf : ValuativeCriterion.Uniqueness f) : IsSeparated f where
  isClosedImmersion_diagonal ","Proof.\n      By assumption (1), Proposition 26.20.6 [[\n  Proposition 26.20.6 (Valuative criterion of universal closedness).  Let $f$ be a quasi-compact morphism of schemes. Then $f$ is universally closed if and only if $f$ satisfies the existence part of the valuative criterion. \n\n    \n]], and Lemmas 26.21.2 [[\n       \n      \n  Lemma 26.21.2. Let $X$ be a scheme over $S$. The diagonal morphism $\\Delta _{X/S}$ is an immersion. \n\n    \n]] and 26.10.4 [[\n  Lemma 26.10.4. Let $f : Y \\to X$ be an immersion of schemes. Then $f$ is a closed immersion if and only if $f(Y) \\subset X$ is a closed subset. \n\n    \n]] we see that it suffices to prove the morphism $\\Delta _{X/S} : X \\to X \\times _ S X$ satisfies the existence part of the valuative criterion. Let a solid commutative diagram \n    \n      \n  \\[  \\xymatrix{ \\mathop{\\mathrm{Spec}}(K) \\ar[r] \\ar[d] &  X \\ar[d] \\\\  \\mathop{\\mathrm{Spec}}(A) \\ar[r] \\ar@{-->}[ru] &  X \\times _ S X }  \\]\n\n    \n       be given. The lower right arrow corresponds to a pair of morphisms $a, b : \\mathop{\\mathrm{Spec}}(A) \\to X$ over $S$. By (2) we see that $a = b$. Hence using $a$ as the dotted arrow works. \n      $\\square$\n    \n"
29,01KZ,"lemma IsSeparated.valuativeCriterion [IsSeparated f] : ValuativeCriterion.Uniqueness f := by
  intro S
  constructor
  rintro âŸ¨lâ‚, hlâ‚, hlâ‚'âŸ© âŸ¨lâ‚‚, hlâ‚‚, hlâ‚‚'âŸ©
  ext : 1
  dsimp at *
  have h := hlâ‚'.trans hlâ‚‚'.symm
  let Z := pullback (pullback.diagonal f) (pullback.lift lâ‚ lâ‚‚ h)
  let g : Z âŸ¶ Spec (.of S.R) := pullback.snd _ _
  have : IsClosedImmersion g := MorphismProperty.pullback_snd _ _ inferInstance
  have hZ : IsAffine Z := by
    rw [@HasAffineProperty.iff_of_isAffine @IsClosedImmersion] at this
    exact this.left
  suffices IsIso g by
    rw [â† cancel_epi g]
    conv_lhs => rw [â† pullback.lift_fst lâ‚ lâ‚‚ h, â† pullback.condition_assoc]
    conv_rhs => rw [â† pullback.lift_snd lâ‚ lâ‚‚ h, â† pullback.condition_assoc]
    simp
  suffices h : Function.Bijective (g.appTop) by
    refine (HasAffineProperty.iff_of_isAffine (P := MorphismProperty.isomorphisms Scheme)).mpr ?_
    exact âŸ¨hZ, (ConcreteCategory.isIso_iff_bijective _).mpr hâŸ©
  constructor
  Â· let l : Spec (.of S.K) âŸ¶ Z :=
      pullback.lift S.iâ‚ (Spec.map (CommRingCat.ofHom (algebraMap S.R S.K))) (by
        apply IsPullback.hom_ext (IsPullback.of_hasPullback _ _)
        Â· simpa using hlâ‚.symm
        Â· simpa using hlâ‚‚.symm)
    have hg : l â‰« g = Spec.map (CommRingCat.ofHom (algebraMap S.R S.K)) :=
      pullback.lift_snd _ _ _
    have : Function.Injective ((l â‰« g).appTop) := by
      rw [hg]
      let e := arrowIsoÎ“SpecOfIsAffine (CommRingCat.ofHom <| algebraMap S.R S.K)
      let P : MorphismProperty CommRingCat :=
        RingHom.toMorphismProperty <| fun f â†¦ Function.Injective f
      have : (RingHom.toMorphismProperty <| fun f â†¦ Function.Injective f).RespectsIso :=
        RingHom.toMorphismProperty_respectsIso_iff.mp RingHom.injective_respectsIso
      change P _
      rw [â† MorphismProperty.arrow_mk_iso_iff (P := P) e]
      exact FaithfulSMul.algebraMap_injective S.R S.K
    rw [Scheme.Hom.comp_appTop] at this
    exact Function.Injective.of_comp this
  Â· rw [@HasAffineProperty.iff_of_isAffine @IsClosedImmersion] at this
    exact this.right
",Formal Proof of Stacks Project Tag 01KZ,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/ValuativeCriterion.lean#L271-L313,Q27041,,26.22.1,lemma,3.0,"['01KY', '01H8', '0ELP']","\n  Lemma 26.22.1. Let $f : X \\to S$ be a morphism of schemes. If $f$ is separated, then $f$ satisfies the uniqueness part of the valuative criterion. \n\n    \n      Proof.\n      Let a diagram as in Definition 26.20.3 be given. Suppose there are two morphisms $a, b : \\mathop{\\mathrm{Spec}}(A) \\to X$ fitting into the diagram. Let $Z \\subset \\mathop{\\mathrm{Spec}}(A)$ be the equalizer of $a$ and $b$. By Lemma 26.21.5 this is a closed subscheme of $\\mathop{\\mathrm{Spec}}(A)$. By assumption it contains the generic point of $\\mathop{\\mathrm{Spec}}(A)$. Since $A$ is a domain this implies $Z = \\mathop{\\mathrm{Spec}}(A)$. Hence $a = b$ as desired. \n      $\\square$\n    \n","\n  Lemma 26.22.1. Let $f : X \\to S$ be a morphism of schemes. If $f$ is separated, then $f$ satisfies the uniqueness part of the valuative criterion. \n\n    \n","Proof.\n      Let a diagram as in Definition 26.20.3 be given. Suppose there are two morphisms $a, b : \\mathop{\\mathrm{Spec}}(A) \\to X$ fitting into the diagram. Let $Z \\subset \\mathop{\\mathrm{Spec}}(A)$ be the equalizer of $a$ and $b$. By Lemma 26.21.5 this is a closed subscheme of $\\mathop{\\mathrm{Spec}}(A)$. By assumption it contains the generic point of $\\mathop{\\mathrm{Spec}}(A)$. Since $A$ is a domain this implies $Z = \\mathop{\\mathrm{Spec}}(A)$. Hence $a = b$ as desired. \n      $\\square$\n    \n"," by
  intro S
  constructor
  rintro âŸ¨lâ‚, hlâ‚, hlâ‚'âŸ© âŸ¨lâ‚‚, hlâ‚‚, hlâ‚‚'âŸ©
  ext : 1
  dsimp at *
  have h := hlâ‚'.trans hlâ‚‚'.symm
  let Z := pullback (pullback.diagonal f) (pullback.lift lâ‚ lâ‚‚ h)
  let g : Z âŸ¶ Spec (.of S.R) := pullback.snd _ _
  have : IsClosedImmersion g := MorphismProperty.pullback_snd _ _ inferInstance
  have hZ : IsAffine Z := by
    rw [@HasAffineProperty.iff_of_isAffine @IsClosedImmersion] at this
    exact this.left
  suffices IsIso g by
    rw [â† cancel_epi g]
    conv_lhs => rw [â† pullback.lift_fst lâ‚ lâ‚‚ h, â† pullback.condition_assoc]
    conv_rhs => rw [â† pullback.lift_snd lâ‚ lâ‚‚ h, â† pullback.condition_assoc]
    simp
  suffices h : Function.Bijective (g.appTop) by
    refine (HasAffineProperty.iff_of_isAffine (P := MorphismProperty.isomorphisms Scheme)).mpr ?_
    exact âŸ¨hZ, (ConcreteCategory.isIso_iff_bijective _).mpr hâŸ©
  constructor
  Â· let l : Spec (.of S.K) âŸ¶ Z :=
      pullback.lift S.iâ‚ (Spec.map (CommRingCat.ofHom (algebraMap S.R S.K))) (by
        apply IsPullback.hom_ext (IsPullback.of_hasPullback _ _)
        Â· simpa using hlâ‚.symm
        Â· simpa using hlâ‚‚.symm)
    have hg : l â‰« g = Spec.map (CommRingCat.ofHom (algebraMap S.R S.K)) :=
      pullback.lift_snd _ _ _
    have : Function.Injective ((l â‰« g).appTop) := by
      rw [hg]
      let e := arrowIsoÎ“SpecOfIsAffine (CommRingCat.ofHom <| algebraMap S.R S.K)
      let P : MorphismProperty CommRingCat :=
        RingHom.toMorphismProperty <| fun f â†¦ Function.Injective f
      have : (RingHom.toMorphismProperty <| fun f â†¦ Function.Injective f).RespectsIso :=
        RingHom.toMorphismProperty_respectsIso_iff.mp RingHom.injective_respectsIso
      change P _
      rw [â† MorphismProperty.arrow_mk_iso_iff (P := P) e]
      exact FaithfulSMul.algebraMap_injective S.R S.K
    rw [Scheme.Hom.comp_appTop] at this
    exact Function.Injective.of_comp this
  Â· rw [@HasAffineProperty.iff_of_isAffine @IsClosedImmersion] at this
    exact this.right
",lemma IsSeparated.valuativeCriterion [IsSeparated f] : ValuativeCriterion.Uniqueness f ,"Proof.\n      Let a diagram as in Definition 26.20.3 [[\n  Definition 26.20.3. Let $f : X \\to S$ be a morphism of schemes. We say $f$ satisfies the existence part of the valuative criterion if given any commutative solid diagram \n  \n  \\[  \\xymatrix{ \\mathop{\\mathrm{Spec}}(K) \\ar[r] \\ar[d] &  X \\ar[d] \\\\  \\mathop{\\mathrm{Spec}}(A) \\ar[r] \\ar@{-->}[ru] &  S }  \\]\n\n   where $A$ is a valuation ring with field of fractions $K$, the dotted arrow exists. We say $f$ satisfies the uniqueness part of the valuative criterion if there is at most one dotted arrow given any diagram as above (without requiring existence of course). \n]] be given. Suppose there are two morphisms $a, b : \\mathop{\\mathrm{Spec}}(A) \\to X$ fitting into the diagram. Let $Z \\subset \\mathop{\\mathrm{Spec}}(A)$ be the equalizer of $a$ and $b$. By Lemma 26.21.5 [[\n  Lemma 26.21.5. Let $X$, $Y$ be schemes over $S$. Let $a, b : X \\to Y$ be morphisms of schemes over $S$. There exists a largest locally closed subscheme $Z \\subset X$ such that $a|_ Z = b|_ Z$. In fact $Z$ is the equalizer of $(a, b)$. Moreover, if $Y$ is separated over $S$, then $Z$ is a closed subscheme. \n\n    \n]] this is a closed subscheme of $\\mathop{\\mathrm{Spec}}(A)$. By assumption it contains the generic point of $\\mathop{\\mathrm{Spec}}(A)$. Since $A$ is a domain this implies $Z = \\mathop{\\mathrm{Spec}}(A)$. Hence $a = b$ as desired. \n      $\\square$\n    \n"
30,0BX5,"lemma IsProper.of_valuativeCriterion [QuasiCompact f] [QuasiSeparated f] [LocallyOfFiniteType f]
    (H : ValuativeCriterion f) : IsProper f := by
  rw [eq_valuativeCriterion]
  exact âŸ¨âŸ¨âŸ¨â€¹_â€º, â€¹_â€ºâŸ©, â€¹_â€ºâŸ©, â€¹_â€ºâŸ©
",Formal Proof of Stacks Project Tag 0BX5,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/ValuativeCriterion.lean#L337-L340,Q27041,Valuative criterion for properness,29.42.1,lemma,3.0,"['0BX4', '01QL', '0ELP']","\n        \n      \n  Lemma 29.42.1 (Valuative criterion for properness). Let $S$ be a scheme. Let $f : X \\to Y$ be a morphism of schemes over $S$. Assume $f$ is of finite type and quasi-separated. Then the following are equivalent \n  \n  \n$f$ is proper, \n\n\n$f$ satisfies the valuative criterion (Schemes, Definition 26.20.3), \n\n\ngiven any commutative solid diagram \n\n\n  \\[  \\xymatrix{ \\mathop{\\mathrm{Spec}}(K) \\ar[r] \\ar[d] &  X \\ar[d] \\\\  \\mathop{\\mathrm{Spec}}(A) \\ar[r] \\ar@{-->}[ru] &  Y }  \\]\n\n\n where $A$ is a valuation ring with field of fractions $K$, there exists a unique dotted arrow making the diagram commute. \n\n\n\n\n    \n      Proof.\n      Part (3) is a reformulation of (2). Thus the lemma is a formal consequence of Schemes, Proposition 26.20.6 and Lemma 26.22.2 and the definitions. \n      $\\square$\n    \n","\n        \n      \n  Lemma 29.42.1 (Valuative criterion for properness). Let $S$ be a scheme. Let $f : X \\to Y$ be a morphism of schemes over $S$. Assume $f$ is of finite type and quasi-separated. Then the following are equivalent \n  \n  \n$f$ is proper, \n\n\n$f$ satisfies the valuative criterion (Schemes, Definition 26.20.3), \n\n\ngiven any commutative solid diagram \n\n\n  \\[  \\xymatrix{ \\mathop{\\mathrm{Spec}}(K) \\ar[r] \\ar[d] &  X \\ar[d] \\\\  \\mathop{\\mathrm{Spec}}(A) \\ar[r] \\ar@{-->}[ru] &  Y }  \\]\n\n\n where $A$ is a valuation ring with field of fractions $K$, there exists a unique dotted arrow making the diagram commute. \n\n\n\n\n    \n","Proof.\n      Part (3) is a reformulation of (2). Thus the lemma is a formal consequence of Schemes, Proposition 26.20.6 and Lemma 26.22.2 and the definitions. \n      $\\square$\n    \n"," by
  rw [eq_valuativeCriterion]
  exact âŸ¨âŸ¨âŸ¨â€¹_â€º, â€¹_â€ºâŸ©, â€¹_â€ºâŸ©, â€¹_â€ºâŸ©
","lemma IsProper.of_valuativeCriterion [QuasiCompact f] [QuasiSeparated f] [LocallyOfFiniteType f]
    (H : ValuativeCriterion f) : IsProper f ","Proof.\n      Part (3) is a reformulation of (2). Thus the lemma is a formal consequence of Schemes, Proposition 26.20.6 [[\n  Proposition 26.20.6 (Valuative criterion of universal closedness).  Let $f$ be a quasi-compact morphism of schemes. Then $f$ is universally closed if and only if $f$ satisfies the existence part of the valuative criterion. \n\n    \n]] and Lemma 26.22.2 [[\n        \n      \n  Lemma 26.22.2 (Valuative criterion separatedness). Let $f : X \\to S$ be a morphism. Assume \n  \n  \nthe morphism $f$ is quasi-separated, and \n\n\nthe morphism $f$ satisfies the uniqueness part of the valuative criterion. \n\n\n\n   Then $f$ is separated. \n\n    \n]] and the definitions. \n      $\\square$\n    \n"
31,022B,"class QuasiCompactCover (ð’° : PreZeroHypercover.{v} S) : Prop where
  isCompactOpenCovered_of_isAffineOpen {U : S.Opens} (hU : IsAffineOpen U) :
    IsCompactOpenCovered (ð’°.f Â·) (U : Set S)
",Formal Proof of Stacks Project Tag 022B, mk_iff,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/Cover/QuasiCompact.lean#L38-L40,Q27041,,34.9.1,definition,3.0,"['022A', '020K', '0ELP']","\n  Definition 34.9.1. Let $T$ be a scheme. An fpqc covering of $T$ is a family of morphisms $\\{ f_ i : T_ i \\to T\\} _{i \\in I}$ of schemes such that each $f_ i$ is flat and such that for every affine open $U \\subset T$ there exists $n \\geq 0$, a map $a : \\{ 1, \\ldots , n\\}  \\to I$ and affine opens $V_ j \\subset T_{a(j)}$, $j = 1, \\ldots , n$ with $\\bigcup _{j = 1}^ n f_{a(j)}(V_ j) = U$. \n","\n  Definition 34.9.1. Let $T$ be a scheme. An fpqc covering of $T$ is a family of morphisms $\\{ f_ i : T_ i \\to T\\} _{i \\in I}$ of schemes such that each $f_ i$ is flat and such that for every affine open $U \\subset T$ there exists $n \\geq 0$, a map $a : \\{ 1, \\ldots , n\\}  \\to I$ and affine opens $V_ j \\subset T_{a(j)}$, $j = 1, \\ldots , n$ with $\\bigcup _{j = 1}^ n f_{a(j)}(V_ j) = U$. \n",,,"class QuasiCompactCover (ð’° : PreZeroHypercover.{v} S) : Prop where
  isCompactOpenCovered_of_isAffineOpen {U : S.Opens} (hU : IsAffineOpen U) :
    IsCompactOpenCovered (ð’°.f Â·) (U : Set S)
",
32,022C,"lemma of_isOpenMap {ð’° : S.Cover K} [Scheme.JointlySurjective K] (h : âˆ€ i, IsOpenMap (ð’°.f i)) :
    QuasiCompactCover ð’°.toPreZeroHypercover where
  isCompactOpenCovered_of_isAffineOpen {U} hU := .of_isOpenMap
    (fun i â†¦ (ð’°.f i).continuous) h (fun x _ â†¦ âŸ¨ð’°.idx x, ð’°.covers xâŸ©) U.2 hU.isCompact
",Formal Proof of Stacks Project Tag 022C,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/Cover/QuasiCompact.lean#L73-L76,Q27041,,34.9.7,lemma,3.0,"['022A', '020K', '0ELP']","\n  Lemma 34.9.7. Any fppf covering is an fpqc covering, and a fortiori, any syntomic, smooth, \xc3\xa9tale or Zariski covering is an fpqc covering. \n\n    \n      Proof.\n      We will show that an fppf covering is an fpqc covering, and then the rest follows from Lemma 34.7.2. Let $\\{ f_ i : U_ i \\to U\\} _{i \\in I}$ be an fppf covering. By definition this means that the $f_ i$ are flat which checks the first condition of Definition 34.9.1. To check the second, let $V \\subset U$ be an affine open subset. Write $f_ i^{-1}(V) = \\bigcup _{j \\in J_ i} V_{ij}$ for some affine opens $V_{ij} \\subset U_ i$. Since each $f_ i$ is open (Morphisms, Lemma 29.25.10), we see that $V = \\bigcup _{i\\in I} \\bigcup _{j \\in J_ i} f_ i(V_{ij})$ is an open covering of $V$. Since $V$ is quasi-compact, this covering has a finite refinement. This finishes the proof. \n      $\\square$\n    \n","\n  Lemma 34.9.7. Any fppf covering is an fpqc covering, and a fortiori, any syntomic, smooth, \xc3\xa9tale or Zariski covering is an fpqc covering. \n\n    \n","Proof.\n      We will show that an fppf covering is an fpqc covering, and then the rest follows from Lemma 34.7.2. Let $\\{ f_ i : U_ i \\to U\\} _{i \\in I}$ be an fppf covering. By definition this means that the $f_ i$ are flat which checks the first condition of Definition 34.9.1. To check the second, let $V \\subset U$ be an affine open subset. Write $f_ i^{-1}(V) = \\bigcup _{j \\in J_ i} V_{ij}$ for some affine opens $V_{ij} \\subset U_ i$. Since each $f_ i$ is open (Morphisms, Lemma 29.25.10), we see that $V = \\bigcup _{i\\in I} \\bigcup _{j \\in J_ i} f_ i(V_{ij})$ is an open covering of $V$. Since $V$ is quasi-compact, this covering has a finite refinement. This finishes the proof. \n      $\\square$\n    \n"," .of_isOpenMap
    (fun i â†¦ (ð’°.f i).continuous) h (fun x _ â†¦ âŸ¨ð’°.idx x, ð’°.covers xâŸ©) U.2 hU.isCompact
","lemma of_isOpenMap {ð’° : S.Cover K} [Scheme.JointlySurjective K] (h : âˆ€ i, IsOpenMap (ð’°.f i)) :
    QuasiCompactCover ð’°.toPreZeroHypercover where
  isCompactOpenCovered_of_isAffineOpen {U} hU ","Proof.\n      We will show that an fppf covering is an fpqc covering, and then the rest follows from Lemma 34.7.2 [[\n  Lemma 34.7.2. Any syntomic covering is an fppf covering, and a fortiori, any smooth, \xc3\xa9tale, or Zariski covering is an fppf covering. \n\n    \n]]. Let $\\{ f_ i : U_ i \\to U\\} _{i \\in I}$ be an fppf covering. By definition this means that the $f_ i$ are flat which checks the first condition of Definition 34.9.1 [[\n  Definition 34.9.1. Let $T$ be a scheme. An fpqc covering of $T$ is a family of morphisms $\\{ f_ i : T_ i \\to T\\} _{i \\in I}$ of schemes such that each $f_ i$ is flat and such that for every affine open $U \\subset T$ there exists $n \\geq 0$, a map $a : \\{ 1, \\ldots , n\\}  \\to I$ and affine opens $V_ j \\subset T_{a(j)}$, $j = 1, \\ldots , n$ with $\\bigcup _{j = 1}^ n f_{a(j)}(V_ j) = U$. \n]]. To check the second, let $V \\subset U$ be an affine open subset. Write $f_ i^{-1}(V) = \\bigcup _{j \\in J_ i} V_{ij}$ for some affine opens $V_{ij} \\subset U_ i$. Since each $f_ i$ is open (Morphisms, Lemma 29.25.10 [[\n  Lemma 29.25.10. A flat morphism locally of finite presentation is universally open. \n\n    \n]]), we see that $V = \\bigcup _{i\\in I} \\bigcup _{j \\in J_ i} f_ i(V_{ij})$ is an open covering of $V$. Since $V$ is quasi-compact, this covering has a finite refinement. This finishes the proof. \n      $\\square$\n    \n"
33,03L8,"lemma of_hom {ð’± : PreZeroHypercover.{w'} S} (f : ð’±.Hom ð’°) [QuasiCompactCover ð’±] :
    QuasiCompactCover ð’° := by
  refine âŸ¨fun {U} hU â†¦ ?_âŸ©
  exact .of_comp (a := f.sâ‚€) (ð’±.f Â·) (f.hâ‚€ Â·)
    (fun _ â†¦ Scheme.Hom.continuous _) (fun i â†¦ funext <| by simp [â† Scheme.Hom.comp_apply])
    (fun _ â†¦ Scheme.Hom.continuous _) U.2 (hU.isCompactOpenCovered ð’±)
",Formal Proof of Stacks Project Tag 03L8,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/Cover/QuasiCompact.lean#L84-L89,Q27041,,34.9.5,lemma,3.0,"['022A', '020K', '0ELP']","\n  Lemma 34.9.5. Let $T$ be a scheme. Let $\\{ f_ i : T_ i \\to T\\} _{i \\in I}$ be a family of morphisms of schemes with target $T$. Assume that \n  \n  \neach $f_ i$ is flat, and \n\n\nthe family $\\{ f_ i : T_ i \\to T\\} _{i \\in I}$ can be refined by an fpqc covering of $T$. \n\n\n\n   Then $\\{ f_ i : T_ i \\to T\\} _{i \\in I}$ is an fpqc covering of $T$. \n\n    \n      Proof.\n      Let $\\{ g_ j : X_ j \\to T\\} _{j \\in J}$ be an fpqc covering refining $\\{ f_ i : T_ i \\to T\\} $. Suppose that $U \\subset T$ is affine open. Choose $j_1, \\ldots , j_ m \\in J$ and $V_ k \\subset X_{j_ k}$ affine open such that $U = \\bigcup g_{j_ k}(V_ k)$. For each $j$ pick $i_ j \\in I$ and a morphism $h_ j : X_ j \\to T_{i_ j}$ such that $g_ j = f_{i_ j} \\circ h_ j$. Since $h_{j_ k}(V_ k)$ is quasi-compact we can find a quasi-compact open $h_{j_ k}(V_ k) \\subset U_ k \\subset f_{i_{j_ k}}^{-1}(U)$. Then $U = \\bigcup f_{i_{j_ k}}(U_ k)$. We conclude that $\\{ f_ i : T_ i \\to T\\} _{i \\in I}$ is an fpqc covering by Lemma 34.9.2. \n      $\\square$\n    \n","\n  Lemma 34.9.5. Let $T$ be a scheme. Let $\\{ f_ i : T_ i \\to T\\} _{i \\in I}$ be a family of morphisms of schemes with target $T$. Assume that \n  \n  \neach $f_ i$ is flat, and \n\n\nthe family $\\{ f_ i : T_ i \\to T\\} _{i \\in I}$ can be refined by an fpqc covering of $T$. \n\n\n\n   Then $\\{ f_ i : T_ i \\to T\\} _{i \\in I}$ is an fpqc covering of $T$. \n\n    \n","Proof.\n      Let $\\{ g_ j : X_ j \\to T\\} _{j \\in J}$ be an fpqc covering refining $\\{ f_ i : T_ i \\to T\\} $. Suppose that $U \\subset T$ is affine open. Choose $j_1, \\ldots , j_ m \\in J$ and $V_ k \\subset X_{j_ k}$ affine open such that $U = \\bigcup g_{j_ k}(V_ k)$. For each $j$ pick $i_ j \\in I$ and a morphism $h_ j : X_ j \\to T_{i_ j}$ such that $g_ j = f_{i_ j} \\circ h_ j$. Since $h_{j_ k}(V_ k)$ is quasi-compact we can find a quasi-compact open $h_{j_ k}(V_ k) \\subset U_ k \\subset f_{i_{j_ k}}^{-1}(U)$. Then $U = \\bigcup f_{i_{j_ k}}(U_ k)$. We conclude that $\\{ f_ i : T_ i \\to T\\} _{i \\in I}$ is an fpqc covering by Lemma 34.9.2. \n      $\\square$\n    \n"," by
  refine âŸ¨fun {U} hU â†¦ ?_âŸ©
  exact .of_comp (a := f.sâ‚€) (ð’±.f Â·) (f.hâ‚€ Â·)
    (fun _ â†¦ Scheme.Hom.continuous _) (fun i â†¦ funext <| by simp [â† Scheme.Hom.comp_apply])
    (fun _ â†¦ Scheme.Hom.continuous _) U.2 (hU.isCompactOpenCovered ð’±)
","lemma of_hom {ð’± : PreZeroHypercover.{w'} S} (f : ð’±.Hom ð’°) [QuasiCompactCover ð’±] :
    QuasiCompactCover ð’° ","Proof.\n      Let $\\{ g_ j : X_ j \\to T\\} _{j \\in J}$ be an fpqc covering refining $\\{ f_ i : T_ i \\to T\\} $. Suppose that $U \\subset T$ is affine open. Choose $j_1, \\ldots , j_ m \\in J$ and $V_ k \\subset X_{j_ k}$ affine open such that $U = \\bigcup g_{j_ k}(V_ k)$. For each $j$ pick $i_ j \\in I$ and a morphism $h_ j : X_ j \\to T_{i_ j}$ such that $g_ j = f_{i_ j} \\circ h_ j$. Since $h_{j_ k}(V_ k)$ is quasi-compact we can find a quasi-compact open $h_{j_ k}(V_ k) \\subset U_ k \\subset f_{i_{j_ k}}^{-1}(U)$. Then $U = \\bigcup f_{i_{j_ k}}(U_ k)$. We conclude that $\\{ f_ i : T_ i \\to T\\} _{i \\in I}$ is an fpqc covering by Lemma 34.9.2 [[\n  Lemma 34.9.2. Let $T$ be a scheme. Let $\\{ f_ i : T_ i \\to T\\} _{i \\in I}$ be a family of morphisms of schemes with target $T$. The following are equivalent \n  \n  \n$\\{ f_ i : T_ i \\to T\\} _{i \\in I}$ is an fpqc covering, \n\n\neach $f_ i$ is flat and for every affine open $U \\subset T$ there exist quasi-compact opens $U_ i \\subset T_ i$ which are almost all empty, such that $U = \\bigcup f_ i(U_ i)$, \n\n\neach $f_ i$ is flat and there exists an affine open covering $T = \\bigcup _{\\alpha \\in A} U_\\alpha $ and for each $\\alpha \\in A$ there exist $i_{\\alpha , 1}, \\ldots , i_{\\alpha , n(\\alpha )} \\in I$ and quasi-compact opens $U_{\\alpha , j} \\subset T_{i_{\\alpha , j}}$ such that $U_\\alpha = \\bigcup _{j = 1, \\ldots , n(\\alpha )} f_{i_{\\alpha , j}}(U_{\\alpha , j})$. \n\n\n\n   If $T$ is quasi-separated, these are also equivalent to \n  \n  \neach $f_ i$ is flat, and for every $t \\in T$ there exist $i_1, \\ldots , i_ n \\in I$ and quasi-compact opens $U_ j \\subset T_{i_ j}$ such that $\\bigcup _{j = 1, \\ldots , n} f_{i_ j}(U_ j)$ is a (not necessarily open) neighbourhood of $t$ in $T$. \n\n\n\n\n    \n]]. \n      $\\square$\n    \n"
34,022D,"instance [QuasiCompactCover ð’°] {T : Scheme.{u}} (f : T âŸ¶ S) :
    QuasiCompactCover (ð’°.pullbackâ‚ f) := by
  refine âŸ¨fun {U'} hU' â†¦ ?_âŸ©
  wlog h : âˆƒ (U : S.Opens), IsAffineOpen U âˆ§ f '' U' âŠ† U generalizing U'
  Â· refine .of_isCompact_of_forall_exists_isCompactOpenCovered hU'.isCompact fun x hxU â†¦ ?_
    obtain âŸ¨W, hW, hx, _âŸ© := isBasis_iff_nbhd.mp S.isBasis_affineOpens (mem_top (f x))
    obtain âŸ¨W', hW', hx', hleâŸ© := isBasis_iff_nbhd.mp T.isBasis_affineOpens
      (show x âˆˆ f â»Â¹áµ W âŠ“ U' from âŸ¨hx, hxUâŸ©)
    exact âŸ¨W', le_trans hle inf_le_right, by simpa [hx], W'.2,
      this hW' âŸ¨W, hW, by simpa using le_trans hle inf_le_leftâŸ©âŸ©
  obtain âŸ¨U, hU, hsubâŸ© := h
  obtain âŸ¨s, hf, V, hc, (heq : _ = (U : Set S))âŸ© := hU.isCompactOpenCovered ð’°
  refine âŸ¨s, hf, fun i hi â†¦ pullback.fst f (ð’°.f i) â»Â¹áµ U' âŠ“ pullback.snd f (ð’°.f i) â»Â¹áµ (V i hi),
      fun i hi â†¦ ?_, ?_âŸ©
  Â· exact hU'.isCompact_pullback_inf (hc _ _) hU (by simpa using hsub) <| show _ âŠ† _ by
      simpa [â† heq, Set.range_comp] using Set.subset_iUnion_of_subset i
        (Set.subset_iUnion_of_subset hi (Set.subset_preimage_image _ _))
  Â· refine subset_antisymm (by simp) (fun x hx â†¦ ?_)
    have : f x âˆˆ (U : Set S) := hsub âŸ¨x, hx, rflâŸ©
    simp_rw [â† heq, Set.mem_iUnion] at this
    obtain âŸ¨i, hi, y, hy, heqâŸ© := this
    simp_rw [Set.mem_iUnion]
    obtain âŸ¨z, hzl, hzrâŸ© := Scheme.Pullback.exists_preimage_pullback x y heq.symm
    exact âŸ¨i, hi, z, âŸ¨by simpa [hzl], by simpa [hzr]âŸ©, hzlâŸ©
",Formal Proof of Stacks Project Tag 022D,(3),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/Cover/QuasiCompact.lean#L93-L116,Q27041,,34.9.8,lemma,3.0,"['022A', '020K', '0ELP']","\n  Lemma 34.9.8. Let $T$ be a scheme. \n  \n  \nIf $T\' \\to T$ is an isomorphism then $\\{ T\' \\to T\\} $ is an fpqc covering of $T$. \n\n\nIf $\\{ T_ i \\to T\\} _{i\\in I}$ is an fpqc covering and for each $i$ we have an fpqc covering $\\{ T_{ij} \\to T_ i\\} _{j\\in J_ i}$, then $\\{ T_{ij} \\to T\\} _{i \\in I, j\\in J_ i}$ is an fpqc covering. \n\n\nIf $\\{ T_ i \\to T\\} _{i\\in I}$ is an fpqc covering and $T\' \\to T$ is a morphism of schemes then $\\{ T\' \\times _ T T_ i \\to T\'\\} _{i\\in I}$ is an fpqc covering. \n\n\n\n\n    \n      Proof.\n      Part (1) is immediate. Recall that the composition of flat morphisms is flat and that the base change of a flat morphism is flat (Morphisms, Lemmas 29.25.8 and 29.25.6). Thus we can apply Lemma 34.9.2 in each case to check that our families of morphisms are fpqc coverings. \n    \n      Proof of (2). Assume $\\{ T_ i \\to T\\} _{i\\in I}$ is an fpqc covering and for each $i$ we have an fpqc covering $\\{ f_{ij} : T_{ij} \\to T_ i\\} _{j\\in J_ i}$. Let $U \\subset T$ be an affine open. We can find quasi-compact opens $U_ i \\subset T_ i$ for $i \\in I$, almost all empty, such that $U = \\bigcup f_ i(U_ i)$. Then for each $i$ we can choose quasi-compact opens $U_{ij} \\subset T_{ij}$ for $j \\in J_ i$, almost all empty, with $U_ i = \\bigcup _ j f_{ij}(U_{ij})$. Thus $\\{ T_{ij} \\to T\\} $ is an fpqc covering. \n    \n      Proof of (3). Assume $\\{ T_ i \\to T\\} _{i\\in I}$ is an fpqc covering and $T\' \\to T$ is a morphism of schemes. Let $U\' \\subset T\'$ be an affine open which maps into the affine open $U \\subset T$. Choose quasi-compact opens $U_ i \\subset T_ i$, almost all empty, such that $U = \\bigcup f_ i(U_ i)$. Then $U\' \\times _ U U_ i$ is a quasi-compact open of $T\' \\times _ T T_ i$ and $U\' = \\bigcup \\text{pr}_1(U\' \\times _ U U_ i)$. Since $T\'$ can be covered by such affine opens $U\' \\subset T\'$ we see that $\\{ T\' \\times _ T T_ i \\to T\'\\} _{i\\in I}$ is an fpqc covering by Lemma 34.9.2. \n      $\\square$\n    \n","\n  Lemma 34.9.8. Let $T$ be a scheme. \n  \n  \nIf $T\' \\to T$ is an isomorphism then $\\{ T\' \\to T\\} $ is an fpqc covering of $T$. \n\n\nIf $\\{ T_ i \\to T\\} _{i\\in I}$ is an fpqc covering and for each $i$ we have an fpqc covering $\\{ T_{ij} \\to T_ i\\} _{j\\in J_ i}$, then $\\{ T_{ij} \\to T\\} _{i \\in I, j\\in J_ i}$ is an fpqc covering. \n\n\nIf $\\{ T_ i \\to T\\} _{i\\in I}$ is an fpqc covering and $T\' \\to T$ is a morphism of schemes then $\\{ T\' \\times _ T T_ i \\to T\'\\} _{i\\in I}$ is an fpqc covering. \n\n\n\n\n    \n","Proof.\n      Part (1) is immediate. Recall that the composition of flat morphisms is flat and that the base change of a flat morphism is flat (Morphisms, Lemmas 29.25.8 and 29.25.6). Thus we can apply Lemma 34.9.2 in each case to check that our families of morphisms are fpqc coverings. \n    \n      Proof of (2). Assume $\\{ T_ i \\to T\\} _{i\\in I}$ is an fpqc covering and for each $i$ we have an fpqc covering $\\{ f_{ij} : T_{ij} \\to T_ i\\} _{j\\in J_ i}$. Let $U \\subset T$ be an affine open. We can find quasi-compact opens $U_ i \\subset T_ i$ for $i \\in I$, almost all empty, such that $U = \\bigcup f_ i(U_ i)$. Then for each $i$ we can choose quasi-compact opens $U_{ij} \\subset T_{ij}$ for $j \\in J_ i$, almost all empty, with $U_ i = \\bigcup _ j f_{ij}(U_{ij})$. Thus $\\{ T_{ij} \\to T\\} $ is an fpqc covering. \n    \n      Proof of (3). Assume $\\{ T_ i \\to T\\} _{i\\in I}$ is an fpqc covering and $T\' \\to T$ is a morphism of schemes. Let $U\' \\subset T\'$ be an affine open which maps into the affine open $U \\subset T$. Choose quasi-compact opens $U_ i \\subset T_ i$, almost all empty, such that $U = \\bigcup f_ i(U_ i)$. Then $U\' \\times _ U U_ i$ is a quasi-compact open of $T\' \\times _ T T_ i$ and $U\' = \\bigcup \\text{pr}_1(U\' \\times _ U U_ i)$. Since $T\'$ can be covered by such affine opens $U\' \\subset T\'$ we see that $\\{ T\' \\times _ T T_ i \\to T\'\\} _{i\\in I}$ is an fpqc covering by Lemma 34.9.2. \n      $\\square$\n    \n"," by
  refine âŸ¨fun {U'} hU' â†¦ ?_âŸ©
  wlog h : âˆƒ (U : S.Opens), IsAffineOpen U âˆ§ f '' U' âŠ† U generalizing U'
  Â· refine .of_isCompact_of_forall_exists_isCompactOpenCovered hU'.isCompact fun x hxU â†¦ ?_
    obtain âŸ¨W, hW, hx, _âŸ© := isBasis_iff_nbhd.mp S.isBasis_affineOpens (mem_top (f x))
    obtain âŸ¨W', hW', hx', hleâŸ© := isBasis_iff_nbhd.mp T.isBasis_affineOpens
      (show x âˆˆ f â»Â¹áµ W âŠ“ U' from âŸ¨hx, hxUâŸ©)
    exact âŸ¨W', le_trans hle inf_le_right, by simpa [hx], W'.2,
      this hW' âŸ¨W, hW, by simpa using le_trans hle inf_le_leftâŸ©âŸ©
  obtain âŸ¨U, hU, hsubâŸ© := h
  obtain âŸ¨s, hf, V, hc, (heq : _ = (U : Set S))âŸ© := hU.isCompactOpenCovered ð’°
  refine âŸ¨s, hf, fun i hi â†¦ pullback.fst f (ð’°.f i) â»Â¹áµ U' âŠ“ pullback.snd f (ð’°.f i) â»Â¹áµ (V i hi),
      fun i hi â†¦ ?_, ?_âŸ©
  Â· exact hU'.isCompact_pullback_inf (hc _ _) hU (by simpa using hsub) <| show _ âŠ† _ by
      simpa [â† heq, Set.range_comp] using Set.subset_iUnion_of_subset i
        (Set.subset_iUnion_of_subset hi (Set.subset_preimage_image _ _))
  Â· refine subset_antisymm (by simp) (fun x hx â†¦ ?_)
    have : f x âˆˆ (U : Set S) := hsub âŸ¨x, hx, rflâŸ©
    simp_rw [â† heq, Set.mem_iUnion] at this
    obtain âŸ¨i, hi, y, hy, heqâŸ© := this
    simp_rw [Set.mem_iUnion]
    obtain âŸ¨z, hzl, hzrâŸ© := Scheme.Pullback.exists_preimage_pullback x y heq.symm
    exact âŸ¨i, hi, z, âŸ¨by simpa [hzl], by simpa [hzr]âŸ©, hzlâŸ©
","instance [QuasiCompactCover ð’°] {T : Scheme.{u}} (f : T âŸ¶ S) :
    QuasiCompactCover (ð’°.pullbackâ‚ f) ","Proof.\n      Part (1) is immediate. Recall that the composition of flat morphisms is flat and that the base change of a flat morphism is flat (Morphisms, Lemmas 29.25.8 [[\n  Lemma 29.25.8. The base change of a flat morphism is flat. \n\n    \n]] and 29.25.6 [[\n  Lemma 29.25.6. The composition of flat morphisms is flat. \n\n    \n]]). Thus we can apply Lemma 34.9.2 [[\n  Lemma 34.9.2. Let $T$ be a scheme. Let $\\{ f_ i : T_ i \\to T\\} _{i \\in I}$ be a family of morphisms of schemes with target $T$. The following are equivalent \n  \n  \n$\\{ f_ i : T_ i \\to T\\} _{i \\in I}$ is an fpqc covering, \n\n\neach $f_ i$ is flat and for every affine open $U \\subset T$ there exist quasi-compact opens $U_ i \\subset T_ i$ which are almost all empty, such that $U = \\bigcup f_ i(U_ i)$, \n\n\neach $f_ i$ is flat and there exists an affine open covering $T = \\bigcup _{\\alpha \\in A} U_\\alpha $ and for each $\\alpha \\in A$ there exist $i_{\\alpha , 1}, \\ldots , i_{\\alpha , n(\\alpha )} \\in I$ and quasi-compact opens $U_{\\alpha , j} \\subset T_{i_{\\alpha , j}}$ such that $U_\\alpha = \\bigcup _{j = 1, \\ldots , n(\\alpha )} f_{i_{\\alpha , j}}(U_{\\alpha , j})$. \n\n\n\n   If $T$ is quasi-separated, these are also equivalent to \n  \n  \neach $f_ i$ is flat, and for every $t \\in T$ there exist $i_1, \\ldots , i_ n \\in I$ and quasi-compact opens $U_ j \\subset T_{i_ j}$ such that $\\bigcup _{j = 1, \\ldots , n} f_{i_ j}(U_ j)$ is a (not necessarily open) neighbourhood of $t$ in $T$. \n\n\n\n\n    \n]] in each case to check that our families of morphisms are fpqc coverings. \n    \n      Proof of (2). Assume $\\{ T_ i \\to T\\} _{i\\in I}$ is an fpqc covering and for each $i$ we have an fpqc covering $\\{ f_{ij} : T_{ij} \\to T_ i\\} _{j\\in J_ i}$. Let $U \\subset T$ be an affine open. We can find quasi-compact opens $U_ i \\subset T_ i$ for $i \\in I$, almost all empty, such that $U = \\bigcup f_ i(U_ i)$. Then for each $i$ we can choose quasi-compact opens $U_{ij} \\subset T_{ij}$ for $j \\in J_ i$, almost all empty, with $U_ i = \\bigcup _ j f_{ij}(U_{ij})$. Thus $\\{ T_{ij} \\to T\\} $ is an fpqc covering. \n    \n      Proof of (3). Assume $\\{ T_ i \\to T\\} _{i\\in I}$ is an fpqc covering and $T\' \\to T$ is a morphism of schemes. Let $U\' \\subset T\'$ be an affine open which maps into the affine open $U \\subset T$. Choose quasi-compact opens $U_ i \\subset T_ i$, almost all empty, such that $U = \\bigcup f_ i(U_ i)$. Then $U\' \\times _ U U_ i$ is a quasi-compact open of $T\' \\times _ T T_ i$ and $U\' = \\bigcup \\text{pr}_1(U\' \\times _ U U_ i)$. Since $T\'$ can be covered by such affine opens $U\' \\subset T\'$ we see that $\\{ T\' \\times _ T T_ i \\to T\'\\} _{i\\in I}$ is an fpqc covering by Lemma 34.9.2 [[\n  Lemma 34.9.2. Let $T$ be a scheme. Let $\\{ f_ i : T_ i \\to T\\} _{i \\in I}$ be a family of morphisms of schemes with target $T$. The following are equivalent \n  \n  \n$\\{ f_ i : T_ i \\to T\\} _{i \\in I}$ is an fpqc covering, \n\n\neach $f_ i$ is flat and for every affine open $U \\subset T$ there exist quasi-compact opens $U_ i \\subset T_ i$ which are almost all empty, such that $U = \\bigcup f_ i(U_ i)$, \n\n\neach $f_ i$ is flat and there exists an affine open covering $T = \\bigcup _{\\alpha \\in A} U_\\alpha $ and for each $\\alpha \\in A$ there exist $i_{\\alpha , 1}, \\ldots , i_{\\alpha , n(\\alpha )} \\in I$ and quasi-compact opens $U_{\\alpha , j} \\subset T_{i_{\\alpha , j}}$ such that $U_\\alpha = \\bigcup _{j = 1, \\ldots , n(\\alpha )} f_{i_{\\alpha , j}}(U_{\\alpha , j})$. \n\n\n\n   If $T$ is quasi-separated, these are also equivalent to \n  \n  \neach $f_ i$ is flat, and for every $t \\in T$ there exist $i_1, \\ldots , i_ n \\in I$ and quasi-compact opens $U_ j \\subset T_{i_ j}$ such that $\\bigcup _{j = 1, \\ldots , n} f_{i_ j}(U_ j)$ is a (not necessarily open) neighbourhood of $t$ in $T$. \n\n\n\n\n    \n]]. \n      $\\square$\n    \n"
35,022D,"instance {X : Scheme.{u}} (ð’° : PreZeroHypercover.{w} X) [QuasiCompactCover ð’°]
    (f : âˆ€ (x : ð’°.Iâ‚€), PreZeroHypercover.{w} (ð’°.X x)) [âˆ€ x, QuasiCompactCover (f x)] :
    QuasiCompactCover (ð’°.bind f) where
  isCompactOpenCovered_of_isAffineOpen {U} hU := by
    obtain âŸ¨s, hs, V, hcV, hUâŸ© := hU.isCompactOpenCovered ð’°
    have (i) (hi) : IsCompactOpenCovered ((f i).f Â·) (V i hi) :=
      isCompactOpenCovered_of_isCompact (f i) (hcV i hi)
    choose t ht W hcW hV using this
    have : Finite s := hs
    have (i) (hi) : Finite (t i hi) := ht i hi
    refine .of_finite (Îº := Î£ (i : s), t i.1 i.2) (fun p â†¦ âŸ¨p.1, p.2âŸ©) (fun p â†¦ W _ p.1.2 _ p.2.2)
      (fun p â†¦ hcW ..) ?_
    simpa [â† hV, Set.iUnion_sigma, Set.iUnion_subtype, Set.image_iUnion, Set.image_image] using hU
",Formal Proof of Stacks Project Tag 022D,(2),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/Cover/QuasiCompact.lean#L124-L136,Q27041,,34.9.8,lemma,3.0,"['022A', '020K', '0ELP']","\n  Lemma 34.9.8. Let $T$ be a scheme. \n  \n  \nIf $T\' \\to T$ is an isomorphism then $\\{ T\' \\to T\\} $ is an fpqc covering of $T$. \n\n\nIf $\\{ T_ i \\to T\\} _{i\\in I}$ is an fpqc covering and for each $i$ we have an fpqc covering $\\{ T_{ij} \\to T_ i\\} _{j\\in J_ i}$, then $\\{ T_{ij} \\to T\\} _{i \\in I, j\\in J_ i}$ is an fpqc covering. \n\n\nIf $\\{ T_ i \\to T\\} _{i\\in I}$ is an fpqc covering and $T\' \\to T$ is a morphism of schemes then $\\{ T\' \\times _ T T_ i \\to T\'\\} _{i\\in I}$ is an fpqc covering. \n\n\n\n\n    \n      Proof.\n      Part (1) is immediate. Recall that the composition of flat morphisms is flat and that the base change of a flat morphism is flat (Morphisms, Lemmas 29.25.8 and 29.25.6). Thus we can apply Lemma 34.9.2 in each case to check that our families of morphisms are fpqc coverings. \n    \n      Proof of (2). Assume $\\{ T_ i \\to T\\} _{i\\in I}$ is an fpqc covering and for each $i$ we have an fpqc covering $\\{ f_{ij} : T_{ij} \\to T_ i\\} _{j\\in J_ i}$. Let $U \\subset T$ be an affine open. We can find quasi-compact opens $U_ i \\subset T_ i$ for $i \\in I$, almost all empty, such that $U = \\bigcup f_ i(U_ i)$. Then for each $i$ we can choose quasi-compact opens $U_{ij} \\subset T_{ij}$ for $j \\in J_ i$, almost all empty, with $U_ i = \\bigcup _ j f_{ij}(U_{ij})$. Thus $\\{ T_{ij} \\to T\\} $ is an fpqc covering. \n    \n      Proof of (3). Assume $\\{ T_ i \\to T\\} _{i\\in I}$ is an fpqc covering and $T\' \\to T$ is a morphism of schemes. Let $U\' \\subset T\'$ be an affine open which maps into the affine open $U \\subset T$. Choose quasi-compact opens $U_ i \\subset T_ i$, almost all empty, such that $U = \\bigcup f_ i(U_ i)$. Then $U\' \\times _ U U_ i$ is a quasi-compact open of $T\' \\times _ T T_ i$ and $U\' = \\bigcup \\text{pr}_1(U\' \\times _ U U_ i)$. Since $T\'$ can be covered by such affine opens $U\' \\subset T\'$ we see that $\\{ T\' \\times _ T T_ i \\to T\'\\} _{i\\in I}$ is an fpqc covering by Lemma 34.9.2. \n      $\\square$\n    \n","\n  Lemma 34.9.8. Let $T$ be a scheme. \n  \n  \nIf $T\' \\to T$ is an isomorphism then $\\{ T\' \\to T\\} $ is an fpqc covering of $T$. \n\n\nIf $\\{ T_ i \\to T\\} _{i\\in I}$ is an fpqc covering and for each $i$ we have an fpqc covering $\\{ T_{ij} \\to T_ i\\} _{j\\in J_ i}$, then $\\{ T_{ij} \\to T\\} _{i \\in I, j\\in J_ i}$ is an fpqc covering. \n\n\nIf $\\{ T_ i \\to T\\} _{i\\in I}$ is an fpqc covering and $T\' \\to T$ is a morphism of schemes then $\\{ T\' \\times _ T T_ i \\to T\'\\} _{i\\in I}$ is an fpqc covering. \n\n\n\n\n    \n","Proof.\n      Part (1) is immediate. Recall that the composition of flat morphisms is flat and that the base change of a flat morphism is flat (Morphisms, Lemmas 29.25.8 and 29.25.6). Thus we can apply Lemma 34.9.2 in each case to check that our families of morphisms are fpqc coverings. \n    \n      Proof of (2). Assume $\\{ T_ i \\to T\\} _{i\\in I}$ is an fpqc covering and for each $i$ we have an fpqc covering $\\{ f_{ij} : T_{ij} \\to T_ i\\} _{j\\in J_ i}$. Let $U \\subset T$ be an affine open. We can find quasi-compact opens $U_ i \\subset T_ i$ for $i \\in I$, almost all empty, such that $U = \\bigcup f_ i(U_ i)$. Then for each $i$ we can choose quasi-compact opens $U_{ij} \\subset T_{ij}$ for $j \\in J_ i$, almost all empty, with $U_ i = \\bigcup _ j f_{ij}(U_{ij})$. Thus $\\{ T_{ij} \\to T\\} $ is an fpqc covering. \n    \n      Proof of (3). Assume $\\{ T_ i \\to T\\} _{i\\in I}$ is an fpqc covering and $T\' \\to T$ is a morphism of schemes. Let $U\' \\subset T\'$ be an affine open which maps into the affine open $U \\subset T$. Choose quasi-compact opens $U_ i \\subset T_ i$, almost all empty, such that $U = \\bigcup f_ i(U_ i)$. Then $U\' \\times _ U U_ i$ is a quasi-compact open of $T\' \\times _ T T_ i$ and $U\' = \\bigcup \\text{pr}_1(U\' \\times _ U U_ i)$. Since $T\'$ can be covered by such affine opens $U\' \\subset T\'$ we see that $\\{ T\' \\times _ T T_ i \\to T\'\\} _{i\\in I}$ is an fpqc covering by Lemma 34.9.2. \n      $\\square$\n    \n"," by
    obtain âŸ¨s, hs, V, hcV, hUâŸ© := hU.isCompactOpenCovered ð’°
    have (i) (hi) : IsCompactOpenCovered ((f i).f Â·) (V i hi) :=
      isCompactOpenCovered_of_isCompact (f i) (hcV i hi)
    choose t ht W hcW hV using this
    have : Finite s := hs
    have (i) (hi) : Finite (t i hi) := ht i hi
    refine .of_finite (Îº := Î£ (i : s), t i.1 i.2) (fun p â†¦ âŸ¨p.1, p.2âŸ©) (fun p â†¦ W _ p.1.2 _ p.2.2)
      (fun p â†¦ hcW ..) ?_
    simpa [â† hV, Set.iUnion_sigma, Set.iUnion_subtype, Set.image_iUnion, Set.image_image] using hU
","instance {X : Scheme.{u}} (ð’° : PreZeroHypercover.{w} X) [QuasiCompactCover ð’°]
    (f : âˆ€ (x : ð’°.Iâ‚€), PreZeroHypercover.{w} (ð’°.X x)) [âˆ€ x, QuasiCompactCover (f x)] :
    QuasiCompactCover (ð’°.bind f) where
  isCompactOpenCovered_of_isAffineOpen {U} hU ","Proof.\n      Part (1) is immediate. Recall that the composition of flat morphisms is flat and that the base change of a flat morphism is flat (Morphisms, Lemmas 29.25.8 [[\n  Lemma 29.25.8. The base change of a flat morphism is flat. \n\n    \n]] and 29.25.6 [[\n  Lemma 29.25.6. The composition of flat morphisms is flat. \n\n    \n]]). Thus we can apply Lemma 34.9.2 [[\n  Lemma 34.9.2. Let $T$ be a scheme. Let $\\{ f_ i : T_ i \\to T\\} _{i \\in I}$ be a family of morphisms of schemes with target $T$. The following are equivalent \n  \n  \n$\\{ f_ i : T_ i \\to T\\} _{i \\in I}$ is an fpqc covering, \n\n\neach $f_ i$ is flat and for every affine open $U \\subset T$ there exist quasi-compact opens $U_ i \\subset T_ i$ which are almost all empty, such that $U = \\bigcup f_ i(U_ i)$, \n\n\neach $f_ i$ is flat and there exists an affine open covering $T = \\bigcup _{\\alpha \\in A} U_\\alpha $ and for each $\\alpha \\in A$ there exist $i_{\\alpha , 1}, \\ldots , i_{\\alpha , n(\\alpha )} \\in I$ and quasi-compact opens $U_{\\alpha , j} \\subset T_{i_{\\alpha , j}}$ such that $U_\\alpha = \\bigcup _{j = 1, \\ldots , n(\\alpha )} f_{i_{\\alpha , j}}(U_{\\alpha , j})$. \n\n\n\n   If $T$ is quasi-separated, these are also equivalent to \n  \n  \neach $f_ i$ is flat, and for every $t \\in T$ there exist $i_1, \\ldots , i_ n \\in I$ and quasi-compact opens $U_ j \\subset T_{i_ j}$ such that $\\bigcup _{j = 1, \\ldots , n} f_{i_ j}(U_ j)$ is a (not necessarily open) neighbourhood of $t$ in $T$. \n\n\n\n\n    \n]] in each case to check that our families of morphisms are fpqc coverings. \n    \n      Proof of (2). Assume $\\{ T_ i \\to T\\} _{i\\in I}$ is an fpqc covering and for each $i$ we have an fpqc covering $\\{ f_{ij} : T_{ij} \\to T_ i\\} _{j\\in J_ i}$. Let $U \\subset T$ be an affine open. We can find quasi-compact opens $U_ i \\subset T_ i$ for $i \\in I$, almost all empty, such that $U = \\bigcup f_ i(U_ i)$. Then for each $i$ we can choose quasi-compact opens $U_{ij} \\subset T_{ij}$ for $j \\in J_ i$, almost all empty, with $U_ i = \\bigcup _ j f_{ij}(U_{ij})$. Thus $\\{ T_{ij} \\to T\\} $ is an fpqc covering. \n    \n      Proof of (3). Assume $\\{ T_ i \\to T\\} _{i\\in I}$ is an fpqc covering and $T\' \\to T$ is a morphism of schemes. Let $U\' \\subset T\'$ be an affine open which maps into the affine open $U \\subset T$. Choose quasi-compact opens $U_ i \\subset T_ i$, almost all empty, such that $U = \\bigcup f_ i(U_ i)$. Then $U\' \\times _ U U_ i$ is a quasi-compact open of $T\' \\times _ T T_ i$ and $U\' = \\bigcup \\text{pr}_1(U\' \\times _ U U_ i)$. Since $T\'$ can be covered by such affine opens $U\' \\subset T\'$ we see that $\\{ T\' \\times _ T T_ i \\to T\'\\} _{i\\in I}$ is an fpqc covering by Lemma 34.9.2 [[\n  Lemma 34.9.2. Let $T$ be a scheme. Let $\\{ f_ i : T_ i \\to T\\} _{i \\in I}$ be a family of morphisms of schemes with target $T$. The following are equivalent \n  \n  \n$\\{ f_ i : T_ i \\to T\\} _{i \\in I}$ is an fpqc covering, \n\n\neach $f_ i$ is flat and for every affine open $U \\subset T$ there exist quasi-compact opens $U_ i \\subset T_ i$ which are almost all empty, such that $U = \\bigcup f_ i(U_ i)$, \n\n\neach $f_ i$ is flat and there exists an affine open covering $T = \\bigcup _{\\alpha \\in A} U_\\alpha $ and for each $\\alpha \\in A$ there exist $i_{\\alpha , 1}, \\ldots , i_{\\alpha , n(\\alpha )} \\in I$ and quasi-compact opens $U_{\\alpha , j} \\subset T_{i_{\\alpha , j}}$ such that $U_\\alpha = \\bigcup _{j = 1, \\ldots , n(\\alpha )} f_{i_{\\alpha , j}}(U_{\\alpha , j})$. \n\n\n\n   If $T$ is quasi-separated, these are also equivalent to \n  \n  \neach $f_ i$ is flat, and for every $t \\in T$ there exist $i_1, \\ldots , i_ n \\in I$ and quasi-compact opens $U_ j \\subset T_{i_ j}$ such that $\\bigcup _{j = 1, \\ldots , n} f_{i_ j}(U_ j)$ is a (not necessarily open) neighbourhood of $t$ in $T$. \n\n\n\n\n    \n]]. \n      $\\square$\n    \n"
36,022D,"instance {P : MorphismProperty Scheme.{u}} [P.ContainsIdentities] [P.RespectsIso]
    {X Y : Scheme.{u}} {f : X âŸ¶ Y} [IsIso f] :
    QuasiCompactCover (Scheme.coverOfIsIso (P := P) f).toPreZeroHypercover :=
  of_isOpenMap (fun _ â†¦ f.homeomorph.isOpenMap)
",Formal Proof of Stacks Project Tag 022D,(1),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/Cover/QuasiCompact.lean#L158-L161,Q27041,,34.9.8,lemma,3.0,"['022A', '020K', '0ELP']","\n  Lemma 34.9.8. Let $T$ be a scheme. \n  \n  \nIf $T\' \\to T$ is an isomorphism then $\\{ T\' \\to T\\} $ is an fpqc covering of $T$. \n\n\nIf $\\{ T_ i \\to T\\} _{i\\in I}$ is an fpqc covering and for each $i$ we have an fpqc covering $\\{ T_{ij} \\to T_ i\\} _{j\\in J_ i}$, then $\\{ T_{ij} \\to T\\} _{i \\in I, j\\in J_ i}$ is an fpqc covering. \n\n\nIf $\\{ T_ i \\to T\\} _{i\\in I}$ is an fpqc covering and $T\' \\to T$ is a morphism of schemes then $\\{ T\' \\times _ T T_ i \\to T\'\\} _{i\\in I}$ is an fpqc covering. \n\n\n\n\n    \n      Proof.\n      Part (1) is immediate. Recall that the composition of flat morphisms is flat and that the base change of a flat morphism is flat (Morphisms, Lemmas 29.25.8 and 29.25.6). Thus we can apply Lemma 34.9.2 in each case to check that our families of morphisms are fpqc coverings. \n    \n      Proof of (2). Assume $\\{ T_ i \\to T\\} _{i\\in I}$ is an fpqc covering and for each $i$ we have an fpqc covering $\\{ f_{ij} : T_{ij} \\to T_ i\\} _{j\\in J_ i}$. Let $U \\subset T$ be an affine open. We can find quasi-compact opens $U_ i \\subset T_ i$ for $i \\in I$, almost all empty, such that $U = \\bigcup f_ i(U_ i)$. Then for each $i$ we can choose quasi-compact opens $U_{ij} \\subset T_{ij}$ for $j \\in J_ i$, almost all empty, with $U_ i = \\bigcup _ j f_{ij}(U_{ij})$. Thus $\\{ T_{ij} \\to T\\} $ is an fpqc covering. \n    \n      Proof of (3). Assume $\\{ T_ i \\to T\\} _{i\\in I}$ is an fpqc covering and $T\' \\to T$ is a morphism of schemes. Let $U\' \\subset T\'$ be an affine open which maps into the affine open $U \\subset T$. Choose quasi-compact opens $U_ i \\subset T_ i$, almost all empty, such that $U = \\bigcup f_ i(U_ i)$. Then $U\' \\times _ U U_ i$ is a quasi-compact open of $T\' \\times _ T T_ i$ and $U\' = \\bigcup \\text{pr}_1(U\' \\times _ U U_ i)$. Since $T\'$ can be covered by such affine opens $U\' \\subset T\'$ we see that $\\{ T\' \\times _ T T_ i \\to T\'\\} _{i\\in I}$ is an fpqc covering by Lemma 34.9.2. \n      $\\square$\n    \n","\n  Lemma 34.9.8. Let $T$ be a scheme. \n  \n  \nIf $T\' \\to T$ is an isomorphism then $\\{ T\' \\to T\\} $ is an fpqc covering of $T$. \n\n\nIf $\\{ T_ i \\to T\\} _{i\\in I}$ is an fpqc covering and for each $i$ we have an fpqc covering $\\{ T_{ij} \\to T_ i\\} _{j\\in J_ i}$, then $\\{ T_{ij} \\to T\\} _{i \\in I, j\\in J_ i}$ is an fpqc covering. \n\n\nIf $\\{ T_ i \\to T\\} _{i\\in I}$ is an fpqc covering and $T\' \\to T$ is a morphism of schemes then $\\{ T\' \\times _ T T_ i \\to T\'\\} _{i\\in I}$ is an fpqc covering. \n\n\n\n\n    \n","Proof.\n      Part (1) is immediate. Recall that the composition of flat morphisms is flat and that the base change of a flat morphism is flat (Morphisms, Lemmas 29.25.8 and 29.25.6). Thus we can apply Lemma 34.9.2 in each case to check that our families of morphisms are fpqc coverings. \n    \n      Proof of (2). Assume $\\{ T_ i \\to T\\} _{i\\in I}$ is an fpqc covering and for each $i$ we have an fpqc covering $\\{ f_{ij} : T_{ij} \\to T_ i\\} _{j\\in J_ i}$. Let $U \\subset T$ be an affine open. We can find quasi-compact opens $U_ i \\subset T_ i$ for $i \\in I$, almost all empty, such that $U = \\bigcup f_ i(U_ i)$. Then for each $i$ we can choose quasi-compact opens $U_{ij} \\subset T_{ij}$ for $j \\in J_ i$, almost all empty, with $U_ i = \\bigcup _ j f_{ij}(U_{ij})$. Thus $\\{ T_{ij} \\to T\\} $ is an fpqc covering. \n    \n      Proof of (3). Assume $\\{ T_ i \\to T\\} _{i\\in I}$ is an fpqc covering and $T\' \\to T$ is a morphism of schemes. Let $U\' \\subset T\'$ be an affine open which maps into the affine open $U \\subset T$. Choose quasi-compact opens $U_ i \\subset T_ i$, almost all empty, such that $U = \\bigcup f_ i(U_ i)$. Then $U\' \\times _ U U_ i$ is a quasi-compact open of $T\' \\times _ T T_ i$ and $U\' = \\bigcup \\text{pr}_1(U\' \\times _ U U_ i)$. Since $T\'$ can be covered by such affine opens $U\' \\subset T\'$ we see that $\\{ T\' \\times _ T T_ i \\to T\'\\} _{i\\in I}$ is an fpqc covering by Lemma 34.9.2. \n      $\\square$\n    \n"," P) f).toPreZeroHypercover :=
  of_isOpenMap (fun _ â†¦ f.homeomorph.isOpenMap)
","instance {P : MorphismProperty Scheme.{u}} [P.ContainsIdentities] [P.RespectsIso]
    {X Y : Scheme.{u}} {f : X âŸ¶ Y} [IsIso f] :
    QuasiCompactCover (Scheme.coverOfIsIso (P ","Proof.\n      Part (1) is immediate. Recall that the composition of flat morphisms is flat and that the base change of a flat morphism is flat (Morphisms, Lemmas 29.25.8 [[\n  Lemma 29.25.8. The base change of a flat morphism is flat. \n\n    \n]] and 29.25.6 [[\n  Lemma 29.25.6. The composition of flat morphisms is flat. \n\n    \n]]). Thus we can apply Lemma 34.9.2 [[\n  Lemma 34.9.2. Let $T$ be a scheme. Let $\\{ f_ i : T_ i \\to T\\} _{i \\in I}$ be a family of morphisms of schemes with target $T$. The following are equivalent \n  \n  \n$\\{ f_ i : T_ i \\to T\\} _{i \\in I}$ is an fpqc covering, \n\n\neach $f_ i$ is flat and for every affine open $U \\subset T$ there exist quasi-compact opens $U_ i \\subset T_ i$ which are almost all empty, such that $U = \\bigcup f_ i(U_ i)$, \n\n\neach $f_ i$ is flat and there exists an affine open covering $T = \\bigcup _{\\alpha \\in A} U_\\alpha $ and for each $\\alpha \\in A$ there exist $i_{\\alpha , 1}, \\ldots , i_{\\alpha , n(\\alpha )} \\in I$ and quasi-compact opens $U_{\\alpha , j} \\subset T_{i_{\\alpha , j}}$ such that $U_\\alpha = \\bigcup _{j = 1, \\ldots , n(\\alpha )} f_{i_{\\alpha , j}}(U_{\\alpha , j})$. \n\n\n\n   If $T$ is quasi-separated, these are also equivalent to \n  \n  \neach $f_ i$ is flat, and for every $t \\in T$ there exist $i_1, \\ldots , i_ n \\in I$ and quasi-compact opens $U_ j \\subset T_{i_ j}$ such that $\\bigcup _{j = 1, \\ldots , n} f_{i_ j}(U_ j)$ is a (not necessarily open) neighbourhood of $t$ in $T$. \n\n\n\n\n    \n]] in each case to check that our families of morphisms are fpqc coverings. \n    \n      Proof of (2). Assume $\\{ T_ i \\to T\\} _{i\\in I}$ is an fpqc covering and for each $i$ we have an fpqc covering $\\{ f_{ij} : T_{ij} \\to T_ i\\} _{j\\in J_ i}$. Let $U \\subset T$ be an affine open. We can find quasi-compact opens $U_ i \\subset T_ i$ for $i \\in I$, almost all empty, such that $U = \\bigcup f_ i(U_ i)$. Then for each $i$ we can choose quasi-compact opens $U_{ij} \\subset T_{ij}$ for $j \\in J_ i$, almost all empty, with $U_ i = \\bigcup _ j f_{ij}(U_{ij})$. Thus $\\{ T_{ij} \\to T\\} $ is an fpqc covering. \n    \n      Proof of (3). Assume $\\{ T_ i \\to T\\} _{i\\in I}$ is an fpqc covering and $T\' \\to T$ is a morphism of schemes. Let $U\' \\subset T\'$ be an affine open which maps into the affine open $U \\subset T$. Choose quasi-compact opens $U_ i \\subset T_ i$, almost all empty, such that $U = \\bigcup f_ i(U_ i)$. Then $U\' \\times _ U U_ i$ is a quasi-compact open of $T\' \\times _ T T_ i$ and $U\' = \\bigcup \\text{pr}_1(U\' \\times _ U U_ i)$. Since $T\'$ can be covered by such affine opens $U\' \\subset T\'$ we see that $\\{ T\' \\times _ T T_ i \\to T\'\\} _{i\\in I}$ is an fpqc covering by Lemma 34.9.2 [[\n  Lemma 34.9.2. Let $T$ be a scheme. Let $\\{ f_ i : T_ i \\to T\\} _{i \\in I}$ be a family of morphisms of schemes with target $T$. The following are equivalent \n  \n  \n$\\{ f_ i : T_ i \\to T\\} _{i \\in I}$ is an fpqc covering, \n\n\neach $f_ i$ is flat and for every affine open $U \\subset T$ there exist quasi-compact opens $U_ i \\subset T_ i$ which are almost all empty, such that $U = \\bigcup f_ i(U_ i)$, \n\n\neach $f_ i$ is flat and there exists an affine open covering $T = \\bigcup _{\\alpha \\in A} U_\\alpha $ and for each $\\alpha \\in A$ there exist $i_{\\alpha , 1}, \\ldots , i_{\\alpha , n(\\alpha )} \\in I$ and quasi-compact opens $U_{\\alpha , j} \\subset T_{i_{\\alpha , j}}$ such that $U_\\alpha = \\bigcup _{j = 1, \\ldots , n(\\alpha )} f_{i_{\\alpha , j}}(U_{\\alpha , j})$. \n\n\n\n   If $T$ is quasi-separated, these are also equivalent to \n  \n  \neach $f_ i$ is flat, and for every $t \\in T$ there exist $i_1, \\ldots , i_ n \\in I$ and quasi-compact opens $U_ j \\subset T_{i_ j}$ such that $\\bigcup _{j = 1, \\ldots , n} f_{i_ j}(U_ j)$ is a (not necessarily open) neighbourhood of $t$ in $T$. \n\n\n\n\n    \n]]. \n      $\\square$\n    \n"
37,01QF,"lemma isAffine_of_isAffineOpen_basicOpen (s : Set Î“(X, âŠ¤))
    (hs : Ideal.span s = âŠ¤) (hsâ‚‚ : âˆ€ i âˆˆ s, IsAffineOpen (X.basicOpen i)) :
    IsAffine X := by
  have : QuasiSeparatedSpace X := isAffine_of_isAffineOpen_basicOpen_aux s hs hsâ‚‚
  have : CompactSpace X := by
    obtain âŸ¨s', hs', eâŸ© := (Ideal.span_eq_top_iff_finite _).mp hs
    rw [â† isCompact_univ_iff, â† Opens.coe_top, â† iSup_basicOpen_of_span_eq_top _ _ e]
    simp only [Finset.mem_coe, Opens.iSup_mk, Opens.carrier_eq_coe, Opens.coe_mk]
    apply s'.isCompact_biUnion
    exact fun i hi â†¦ (hsâ‚‚ _ (hs' hi)).isCompact
  constructor
  refine HasAffineProperty.of_iSup_eq_top (P := MorphismProperty.isomorphisms Scheme)
    (fun i : s â†¦ âŸ¨PrimeSpectrum.basicOpen i.1, ?_âŸ©) ?_ (fun i â†¦ âŸ¨?_, ?_âŸ©)
  Â· change IsAffineOpen _
    simp only [â† basicOpen_eq_of_affine]
    exact (isAffineOpen_top (Scheme.Spec.obj (op _))).basicOpen _
  Â· rw [PrimeSpectrum.iSup_basicOpen_eq_top_iff, Subtype.range_coe_subtype, Set.setOf_mem_eq, hs]
  Â· rw [Scheme.toSpecÎ“_preimage_basicOpen]
    exact hsâ‚‚ _ i.2
  Â· simp only [Opens.map_top, morphismRestrict_app]
    refine IsIso.comp_isIso' ?_ inferInstance
    convert isIso_Î“Spec_adjunction_unit_app_basicOpen i.1 using 0
    exact congr(IsIso ((Î“Spec.adjunction.unit.app X).app $(by simp)))
",Formal Proof of Stacks Project Tag 01QF,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/Morphisms/Affine.lean#L109-L131,Q27041,,28.27.3,lemma,3.0,"['01QD', '01OH', '0ELP']","\n  Lemma 28.27.3. Let $X$ be a scheme. Suppose that there exist finitely many elements $f_1, \\ldots , f_ n \\in \\Gamma (X, \\mathcal{O}_ X)$ such that \n  \n  \neach $X_{f_ i}$ is an affine open of $X$, and \n\n\nthe ideal generated by $f_1, \\ldots , f_ n$ in $\\Gamma (X, \\mathcal{O}_ X)$ is equal to the unit ideal. \n\n\n\n   Then $X$ is affine. \n\n    \n      Proof.\n      Assume we have $f_1, \\ldots , f_ n$ as in the lemma. We may write $1 = \\sum g_ i f_ i$ for some $g_ j \\in \\Gamma (X, \\mathcal{O}_ X)$ and hence it is clear that $X = \\bigcup X_{f_ i}$. (The $f_ i$\'s cannot all vanish at a point.) Since each $X_{f_ i}$ is quasi-compact (being affine) it follows that $X$ is quasi-compact. Hence we see that $X$ is quasi-affine by Lemma 28.27.1 above. Consider the open immersion \n    \n      \n  \\[  j : X \\to \\mathop{\\mathrm{Spec}}(\\Gamma (X, \\mathcal{O}_ X)),  \\]\n\n    \n       see Lemma 28.18.4. The inverse image of the standard open $D(f_ i)$ on the right hand side is equal to $X_{f_ i}$ on the left hand side and the morphism $j$ induces an isomorphism $X_{f_ i} \\cong D(f_ i)$, see Lemma 28.18.3. Since the $f_ i$ generate the unit ideal we see that $\\mathop{\\mathrm{Spec}}(\\Gamma (X, \\mathcal{O}_ X)) = \\bigcup _{i = 1, \\ldots , n} D(f_ i)$. Thus $j$ is an isomorphism. \n      $\\square$\n    \n","\n  Lemma 28.27.3. Let $X$ be a scheme. Suppose that there exist finitely many elements $f_1, \\ldots , f_ n \\in \\Gamma (X, \\mathcal{O}_ X)$ such that \n  \n  \neach $X_{f_ i}$ is an affine open of $X$, and \n\n\nthe ideal generated by $f_1, \\ldots , f_ n$ in $\\Gamma (X, \\mathcal{O}_ X)$ is equal to the unit ideal. \n\n\n\n   Then $X$ is affine. \n\n    \n","Proof.\n      Assume we have $f_1, \\ldots , f_ n$ as in the lemma. We may write $1 = \\sum g_ i f_ i$ for some $g_ j \\in \\Gamma (X, \\mathcal{O}_ X)$ and hence it is clear that $X = \\bigcup X_{f_ i}$. (The $f_ i$\'s cannot all vanish at a point.) Since each $X_{f_ i}$ is quasi-compact (being affine) it follows that $X$ is quasi-compact. Hence we see that $X$ is quasi-affine by Lemma 28.27.1 above. Consider the open immersion \n    \n      \n  \\[  j : X \\to \\mathop{\\mathrm{Spec}}(\\Gamma (X, \\mathcal{O}_ X)),  \\]\n\n    \n       see Lemma 28.18.4. The inverse image of the standard open $D(f_ i)$ on the right hand side is equal to $X_{f_ i}$ on the left hand side and the morphism $j$ induces an isomorphism $X_{f_ i} \\cong D(f_ i)$, see Lemma 28.18.3. Since the $f_ i$ generate the unit ideal we see that $\\mathop{\\mathrm{Spec}}(\\Gamma (X, \\mathcal{O}_ X)) = \\bigcup _{i = 1, \\ldots , n} D(f_ i)$. Thus $j$ is an isomorphism. \n      $\\square$\n    \n"," by
  have : QuasiSeparatedSpace X := isAffine_of_isAffineOpen_basicOpen_aux s hs hsâ‚‚
  have : CompactSpace X := by
    obtain âŸ¨s', hs', eâŸ© := (Ideal.span_eq_top_iff_finite _).mp hs
    rw [â† isCompact_univ_iff, â† Opens.coe_top, â† iSup_basicOpen_of_span_eq_top _ _ e]
    simp only [Finset.mem_coe, Opens.iSup_mk, Opens.carrier_eq_coe, Opens.coe_mk]
    apply s'.isCompact_biUnion
    exact fun i hi â†¦ (hsâ‚‚ _ (hs' hi)).isCompact
  constructor
  refine HasAffineProperty.of_iSup_eq_top (P := MorphismProperty.isomorphisms Scheme)
    (fun i : s â†¦ âŸ¨PrimeSpectrum.basicOpen i.1, ?_âŸ©) ?_ (fun i â†¦ âŸ¨?_, ?_âŸ©)
  Â· change IsAffineOpen _
    simp only [â† basicOpen_eq_of_affine]
    exact (isAffineOpen_top (Scheme.Spec.obj (op _))).basicOpen _
  Â· rw [PrimeSpectrum.iSup_basicOpen_eq_top_iff, Subtype.range_coe_subtype, Set.setOf_mem_eq, hs]
  Â· rw [Scheme.toSpecÎ“_preimage_basicOpen]
    exact hsâ‚‚ _ i.2
  Â· simp only [Opens.map_top, morphismRestrict_app]
    refine IsIso.comp_isIso' ?_ inferInstance
    convert isIso_Î“Spec_adjunction_unit_app_basicOpen i.1 using 0
    exact congr(IsIso ((Î“Spec.adjunction.unit.app X).app $(by simp)))
","lemma isAffine_of_isAffineOpen_basicOpen (s : Set Î“(X, âŠ¤))
    (hs : Ideal.span s = âŠ¤) (hsâ‚‚ : âˆ€ i âˆˆ s, IsAffineOpen (X.basicOpen i)) :
    IsAffine X ","Proof.\n      Assume we have $f_1, \\ldots , f_ n$ as in the lemma. We may write $1 = \\sum g_ i f_ i$ for some $g_ j \\in \\Gamma (X, \\mathcal{O}_ X)$ and hence it is clear that $X = \\bigcup X_{f_ i}$. (The $f_ i$\'s cannot all vanish at a point.) Since each $X_{f_ i}$ is quasi-compact (being affine) it follows that $X$ is quasi-compact. Hence we see that $X$ is quasi-affine by Lemma 28.27.1 [[\n  Lemma 28.27.1. Let $X$ be a scheme. Then $X$ is quasi-affine if and only if $\\mathcal{O}_ X$ is ample. \n\n    \n]] above. Consider the open immersion \n    \n      \n  \\[  j : X \\to \\mathop{\\mathrm{Spec}}(\\Gamma (X, \\mathcal{O}_ X)),  \\]\n\n    \n       see Lemma 28.18.4 [[\n  Lemma 28.18.4. Let $X$ be a scheme. Then $X$ is quasi-affine if and only if the canonical morphism \n  \n  \\[  X \\longrightarrow \\mathop{\\mathrm{Spec}}(\\Gamma (X, \\mathcal{O}_ X))  \\]\n\n   from Schemes, Lemma 26.6.4 is a quasi-compact open immersion. \n\n    \n]]. The inverse image of the standard open $D(f_ i)$ on the right hand side is equal to $X_{f_ i}$ on the left hand side and the morphism $j$ induces an isomorphism $X_{f_ i} \\cong D(f_ i)$, see Lemma 28.18.3 [[\n  Lemma 28.18.3. Let $X$ be a scheme. Let $f \\in \\Gamma (X, \\mathcal{O}_ X)$. Assume $X$ is quasi-compact and quasi-separated and assume that $X_ f$ is affine. Then the canonical morphism \n  \n  \\[  j : X \\longrightarrow \\mathop{\\mathrm{Spec}}(\\Gamma (X, \\mathcal{O}_ X))  \\]\n\n   from Schemes, Lemma 26.6.4 induces an isomorphism of $X_ f = j^{-1}(D(f))$ onto the standard affine open $D(f) \\subset \\mathop{\\mathrm{Spec}}(\\Gamma (X, \\mathcal{O}_ X))$. \n\n    \n]]. Since the $f_ i$ generate the unit ideal we see that $\\mathop{\\mathrm{Spec}}(\\Gamma (X, \\mathcal{O}_ X)) = \\bigcup _{i = 1, \\ldots , n} D(f_ i)$. Thus $j$ is an isomorphism. \n      $\\square$\n    \n"
38,04DE,"lemma isAffineHom_of_isInducing
    (hfâ‚ : Topology.IsInducing f)
    (hfâ‚‚ : IsClosed (Set.range f)) :
    IsAffineHom f := by
  apply isAffineHom_of_forall_exists_isAffineOpen
  intro y
  by_cases hy : y âˆˆ Set.range f
  Â· obtain âŸ¨x, rflâŸ© := hy
    obtain âŸ¨_, âŸ¨U, hU, rflâŸ©, hxU, -âŸ© :=
      Y.isBasis_affineOpens.exists_subset_of_mem_open (Set.mem_univ (f x)) isOpen_univ
    obtain âŸ¨_, âŸ¨V, hV, rflâŸ©, hxV, hVUâŸ© :=
      X.isBasis_affineOpens.exists_subset_of_mem_open hxU (f â»Â¹áµ U).isOpen
    obtain âŸ¨U', hU'U, rflâŸ© : âˆƒ U' : Y.Opens, U' â‰¤ U âˆ§ f â»Â¹áµ U' = V := by
      obtain âŸ¨U', hU', eâŸ© := hfâ‚.isOpen_iff.mp V.2
      exact âŸ¨âŸ¨U', hU'âŸ© âŠ“ U, inf_le_right, Opens.ext (by simpa [e] using hVU)âŸ©
    obtain âŸ¨r, hrU', hxrâŸ© := hU.exists_basicOpen_le âŸ¨f x, hxVâŸ© hxU
    refine âŸ¨_, hxr, hU.basicOpen r, ?_âŸ©
    convert hV.basicOpen (f.app _ (Y.presheaf.map (homOfLE hU'U).op r)) using 1
    simp only [Scheme.preimage_basicOpen, â† CommRingCat.comp_apply, f.naturality]
    simpa using ((Opens.map f.base).map (homOfLE hrU')).le
  Â· obtain âŸ¨_, âŸ¨U, hU, rflâŸ©, hyU, hU'âŸ© :=
      Y.isBasis_affineOpens.exists_subset_of_mem_open hy hfâ‚‚.isOpen_compl
    rw [Set.subset_compl_iff_disjoint_right, â† Set.preimage_eq_empty_iff] at hU'
    refine âŸ¨U, hyU, hU, ?_âŸ©
    convert isAffineOpen_bot _
    exact Opens.ext hU'
",Formal Proof of Stacks Project Tag 04DE,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/Morphisms/Affine.lean#L224-L249,Q27041,,29.45.4,lemma,3.0,"['04DC', '01QL', '0ELP']","\n  Lemma 29.45.4. Let $f : X \\to Y$ be a morphism of schemes. If $f$ is a homeomorphism onto a closed subset of $Y$ then $f$ is affine. \n\n    \n      Proof.\n      Let $y \\in Y$ be a point. If $y \\not\\in f(X)$, then there exists an affine neighbourhood of $y$ which is disjoint from $f(X)$. If $y \\in f(X)$, let $x \\in X$ be the unique point of $X$ mapping to $y$. Let $y \\in V$ be an affine open neighbourhood. Let $U \\subset X$ be an affine open neighbourhood of $x$ which maps into $V$. Since $f(U) \\subset V \\cap f(X)$ is open in the induced topology by our assumption on $f$ we may choose a $h \\in \\Gamma (V, \\mathcal{O}_ Y)$ such that $y \\in D(h)$ and $D(h) \\cap f(X) \\subset f(U)$. Denote $h\' \\in \\Gamma (U, \\mathcal{O}_ X)$ the restriction of $f^\\sharp (h)$ to $U$. Then we see that $D(h\') \\subset U$ is equal to $f^{-1}(D(h))$. In other words, every point of $Y$ has an open neighbourhood whose inverse image is affine. Thus $f$ is affine, see Lemma 29.11.3. \n      $\\square$\n    \n",\n  Lemma 29.45.4. Let $f : X \\to Y$ be a morphism of schemes. If $f$ is a homeomorphism onto a closed subset of $Y$ then $f$ is affine. \n\n    \n,"Proof.\n      Let $y \\in Y$ be a point. If $y \\not\\in f(X)$, then there exists an affine neighbourhood of $y$ which is disjoint from $f(X)$. If $y \\in f(X)$, let $x \\in X$ be the unique point of $X$ mapping to $y$. Let $y \\in V$ be an affine open neighbourhood. Let $U \\subset X$ be an affine open neighbourhood of $x$ which maps into $V$. Since $f(U) \\subset V \\cap f(X)$ is open in the induced topology by our assumption on $f$ we may choose a $h \\in \\Gamma (V, \\mathcal{O}_ Y)$ such that $y \\in D(h)$ and $D(h) \\cap f(X) \\subset f(U)$. Denote $h\' \\in \\Gamma (U, \\mathcal{O}_ X)$ the restriction of $f^\\sharp (h)$ to $U$. Then we see that $D(h\') \\subset U$ is equal to $f^{-1}(D(h))$. In other words, every point of $Y$ has an open neighbourhood whose inverse image is affine. Thus $f$ is affine, see Lemma 29.11.3. \n      $\\square$\n    \n"," by
  apply isAffineHom_of_forall_exists_isAffineOpen
  intro y
  by_cases hy : y âˆˆ Set.range f
  Â· obtain âŸ¨x, rflâŸ© := hy
    obtain âŸ¨_, âŸ¨U, hU, rflâŸ©, hxU, -âŸ© :=
      Y.isBasis_affineOpens.exists_subset_of_mem_open (Set.mem_univ (f x)) isOpen_univ
    obtain âŸ¨_, âŸ¨V, hV, rflâŸ©, hxV, hVUâŸ© :=
      X.isBasis_affineOpens.exists_subset_of_mem_open hxU (f â»Â¹áµ U).isOpen
    obtain âŸ¨U', hU'U, rflâŸ© : âˆƒ U' : Y.Opens, U' â‰¤ U âˆ§ f â»Â¹áµ U' = V := by
      obtain âŸ¨U', hU', eâŸ© := hfâ‚.isOpen_iff.mp V.2
      exact âŸ¨âŸ¨U', hU'âŸ© âŠ“ U, inf_le_right, Opens.ext (by simpa [e] using hVU)âŸ©
    obtain âŸ¨r, hrU', hxrâŸ© := hU.exists_basicOpen_le âŸ¨f x, hxVâŸ© hxU
    refine âŸ¨_, hxr, hU.basicOpen r, ?_âŸ©
    convert hV.basicOpen (f.app _ (Y.presheaf.map (homOfLE hU'U).op r)) using 1
    simp only [Scheme.preimage_basicOpen, â† CommRingCat.comp_apply, f.naturality]
    simpa using ((Opens.map f.base).map (homOfLE hrU')).le
  Â· obtain âŸ¨_, âŸ¨U, hU, rflâŸ©, hyU, hU'âŸ© :=
      Y.isBasis_affineOpens.exists_subset_of_mem_open hy hfâ‚‚.isOpen_compl
    rw [Set.subset_compl_iff_disjoint_right, â† Set.preimage_eq_empty_iff] at hU'
    refine âŸ¨U, hyU, hU, ?_âŸ©
    convert isAffineOpen_bot _
    exact Opens.ext hU'
","lemma isAffineHom_of_isInducing
    (hfâ‚ : Topology.IsInducing f)
    (hfâ‚‚ : IsClosed (Set.range f)) :
    IsAffineHom f ","Proof.\n      Let $y \\in Y$ be a point. If $y \\not\\in f(X)$, then there exists an affine neighbourhood of $y$ which is disjoint from $f(X)$. If $y \\in f(X)$, let $x \\in X$ be the unique point of $X$ mapping to $y$. Let $y \\in V$ be an affine open neighbourhood. Let $U \\subset X$ be an affine open neighbourhood of $x$ which maps into $V$. Since $f(U) \\subset V \\cap f(X)$ is open in the induced topology by our assumption on $f$ we may choose a $h \\in \\Gamma (V, \\mathcal{O}_ Y)$ such that $y \\in D(h)$ and $D(h) \\cap f(X) \\subset f(U)$. Denote $h\' \\in \\Gamma (U, \\mathcal{O}_ X)$ the restriction of $f^\\sharp (h)$ to $U$. Then we see that $D(h\') \\subset U$ is equal to $f^{-1}(D(h))$. In other words, every point of $Y$ has an open neighbourhood whose inverse image is affine. Thus $f$ is affine, see Lemma 29.11.3 [[\n       \n      \n  Lemma 29.11.3. Let $f : X \\to S$ be a morphism of schemes. The following are equivalent \n  \n  \nThe morphism $f$ is affine. \n\n\nThere exists an affine open covering $S = \\bigcup W_ j$ such that each $f^{-1}(W_ j)$ is affine. \n\n\nThere exists a quasi-coherent sheaf of $\\mathcal{O}_ S$-algebras $\\mathcal{A}$ and an isomorphism $X \\cong \\underline{\\mathop{\\mathrm{Spec}}}_ S(\\mathcal{A})$ of schemes over $S$. See Constructions, Section 27.4 for notation. \n\n\n\n   Moreover, in this case $X = \\underline{\\mathop{\\mathrm{Spec}}}_ S(f_*\\mathcal{O}_ X)$. \n\n    \n]]. \n      $\\square$\n    \n"
39,01TB,"lemma Scheme.Hom.closePoints_subset_preimage_closedPoints
    {X Y : Scheme.{u}} (f : X âŸ¶ Y) [JacobsonSpace Y] [LocallyOfFiniteType f] :
    closedPoints X âŠ† f â»Â¹' closedPoints Y := by
  intro x hx
  have := isClosed_singleton_iff_isClosedImmersion.mp hx
  have := (isFinite_iff_locallyOfFiniteType_of_jacobsonSpace
    (f := X.fromSpecResidueField x â‰« f)).mpr inferInstance
  simpa [Set.range_comp, Scheme.range_fromSpecResidueField] using
    (X.fromSpecResidueField x â‰« f).isClosedMap.isClosed_range
",Formal Proof of Stacks Project Tag 01TB,(1) => (3),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/Morphisms/Finite.lean#L190-L198,Q27041,,29.16.8,lemma,3.0,"['01T9', '01QL', '0ELP']","\n  Lemma 29.16.8. Let $S$ be a scheme. The following are equivalent: \n  \n  \nthe scheme $S$ is Jacobson, \n\n\n$S_{\\text{ft-pts}}$ is the set of closed points of $S$, \n\n\nfor all $T \\to S$ locally of finite type closed points map to closed points, and \n\n\nfor all $T \\to S$ locally of finite type closed points $t \\in T$ map to closed points $s \\in S$ with $\\kappa (s) \\subset \\kappa (t)$ finite. \n\n\n\n\n    \n      Proof.\n      We have trivially (4) $\\Rightarrow $ (3) $\\Rightarrow $ (2). Lemma 29.16.7 shows that (2) implies (1). Hence it suffices to show that (1) implies (4). Suppose that $T \\to S$ is locally of finite type. Choose $t \\in T$ closed and let $s \\in S$ be the image. Choose affine open neighbourhoods $\\mathop{\\mathrm{Spec}}(R) = U \\subset S$ of $s$ and $\\mathop{\\mathrm{Spec}}(A) = V \\subset T$ of $t$ with $V$ mapping into $U$. The induced ring map $R \\to A$ is of finite type (see Lemma 29.15.2) and $R$ is Jacobson by Properties, Lemma 28.6.3. Thus the result follows from Algebra, Proposition 10.35.19. \n      $\\square$\n    \n","\n  Lemma 29.16.8. Let $S$ be a scheme. The following are equivalent: \n  \n  \nthe scheme $S$ is Jacobson, \n\n\n$S_{\\text{ft-pts}}$ is the set of closed points of $S$, \n\n\nfor all $T \\to S$ locally of finite type closed points map to closed points, and \n\n\nfor all $T \\to S$ locally of finite type closed points $t \\in T$ map to closed points $s \\in S$ with $\\kappa (s) \\subset \\kappa (t)$ finite. \n\n\n\n\n    \n","Proof.\n      We have trivially (4) $\\Rightarrow $ (3) $\\Rightarrow $ (2). Lemma 29.16.7 shows that (2) implies (1). Hence it suffices to show that (1) implies (4). Suppose that $T \\to S$ is locally of finite type. Choose $t \\in T$ closed and let $s \\in S$ be the image. Choose affine open neighbourhoods $\\mathop{\\mathrm{Spec}}(R) = U \\subset S$ of $s$ and $\\mathop{\\mathrm{Spec}}(A) = V \\subset T$ of $t$ with $V$ mapping into $U$. The induced ring map $R \\to A$ is of finite type (see Lemma 29.15.2) and $R$ is Jacobson by Properties, Lemma 28.6.3. Thus the result follows from Algebra, Proposition 10.35.19. \n      $\\square$\n    \n"," by
  intro x hx
  have := isClosed_singleton_iff_isClosedImmersion.mp hx
  have := (isFinite_iff_locallyOfFiniteType_of_jacobsonSpace
    (f := X.fromSpecResidueField x â‰« f)).mpr inferInstance
  simpa [Set.range_comp, Scheme.range_fromSpecResidueField] using
    (X.fromSpecResidueField x â‰« f).isClosedMap.isClosed_range
","lemma Scheme.Hom.closePoints_subset_preimage_closedPoints
    {X Y : Scheme.{u}} (f : X âŸ¶ Y) [JacobsonSpace Y] [LocallyOfFiniteType f] :
    closedPoints X âŠ† f â»Â¹' closedPoints Y ","Proof.\n      We have trivially (4) $\\Rightarrow $ (3) $\\Rightarrow $ (2). Lemma 29.16.7 [[\n  Lemma 29.16.7. Let $S$ be a scheme. For any locally closed subset $T \\subset S$ we have \n  \n  \\[  T \\not= \\emptyset \\Rightarrow T \\cap S_{\\text{ft-pts}} \\not= \\emptyset .  \\]\n\n   In particular, for any closed subset $T \\subset S$ we see that $T \\cap S_{\\text{ft-pts}}$ is dense in $T$. \n\n    \n]] shows that (2) implies (1). Hence it suffices to show that (1) implies (4). Suppose that $T \\to S$ is locally of finite type. Choose $t \\in T$ closed and let $s \\in S$ be the image. Choose affine open neighbourhoods $\\mathop{\\mathrm{Spec}}(R) = U \\subset S$ of $s$ and $\\mathop{\\mathrm{Spec}}(A) = V \\subset T$ of $t$ with $V$ mapping into $U$. The induced ring map $R \\to A$ is of finite type (see Lemma 29.15.2 [[\n  Lemma 29.15.2. Let $f : X \\to S$ be a morphism of schemes. The following are equivalent \n  \n  \nThe morphism $f$ is locally of finite type. \n\n\nFor all affine opens $U \\subset X$, $V \\subset S$ with $f(U) \\subset V$ the ring map $\\mathcal{O}_ S(V) \\to \\mathcal{O}_ X(U)$ is of finite type. \n\n\nThere exist an open covering $S = \\bigcup _{j \\in J} V_ j$ and open coverings $f^{-1}(V_ j) = \\bigcup _{i \\in I_ j} U_ i$ such that each of the morphisms $U_ i \\to V_ j$, $j\\in J, i\\in I_ j$ is locally of finite type. \n\n\nThere exist an affine open covering $S = \\bigcup _{j \\in J} V_ j$ and affine open coverings $f^{-1}(V_ j) = \\bigcup _{i \\in I_ j} U_ i$ such that the ring map $\\mathcal{O}_ S(V_ j) \\to \\mathcal{O}_ X(U_ i)$ is of finite type, for all $j\\in J, i\\in I_ j$. \n\n\n\n   Moreover, if $f$ is locally of finite type then for any open subschemes $U \\subset X$, $V \\subset S$ with $f(U) \\subset V$ the restriction $f|_ U : U \\to V$ is locally of finite type. \n\n    \n]]) and $R$ is Jacobson by Properties, Lemma 28.6.3 [[\n  Lemma 28.6.3. Let $X$ be a scheme. The following are equivalent: \n  \n  \nThe scheme $X$ is Jacobson. \n\n\nThe scheme $X$ is \xe2\x80\x9clocally Jacobson\xe2\x80\x9d in the sense of Definition 28.4.2. \n\n\nFor every affine open $U \\subset X$ the ring $\\mathcal{O}_ X(U)$ is Jacobson. \n\n\nThere exists an affine open covering $X = \\bigcup U_ i$ such that each $\\mathcal{O}_ X(U_ i)$ is Jacobson. \n\n\nThere exists an open covering $X = \\bigcup X_ j$ such that each open subscheme $X_ j$ is Jacobson. \n\n\n\n   Moreover, if $X$ is Jacobson then every open subscheme is Jacobson. \n\n    \n]]. Thus the result follows from Algebra, Proposition 10.35.19 [[\n  Proposition 10.35.19. Let $R$ be a Jacobson ring. Let $R \\to S$ be a ring map of finite type. Then \n  \n  \nThe ring $S$ is Jacobson. \n\n\nThe map $\\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R)$ transforms closed points to closed points. \n\n\nFor $\\mathfrak m\' \\subset S$ maximal lying over $\\mathfrak m \\subset R$ the field extension $\\kappa (\\mathfrak m\')/\\kappa (\\mathfrak m)$ is finite. \n\n\n\n\n    \n]]. \n      $\\square$\n    \n"
40,01TB,"lemma isClosed_singleton_iff_locallyOfFiniteType {X : Scheme.{u}} [JacobsonSpace X] {x : X} :
    IsClosed {x} â†” LocallyOfFiniteType (X.fromSpecResidueField x) := by
  constructor
  Â· exact fun H â†¦ have := isClosed_singleton_iff_isClosedImmersion.mp H; inferInstance
  Â· intro H
    simpa using (X.fromSpecResidueField x).closePoints_subset_preimage_closedPoints
      (IsLocalRing.isClosed_singleton_closedPoint _)
",Formal Proof of Stacks Project Tag 01TB,(1) => (2),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/Morphisms/Finite.lean#L201-L207,Q27041,,29.16.8,lemma,3.0,"['01T9', '01QL', '0ELP']","\n  Lemma 29.16.8. Let $S$ be a scheme. The following are equivalent: \n  \n  \nthe scheme $S$ is Jacobson, \n\n\n$S_{\\text{ft-pts}}$ is the set of closed points of $S$, \n\n\nfor all $T \\to S$ locally of finite type closed points map to closed points, and \n\n\nfor all $T \\to S$ locally of finite type closed points $t \\in T$ map to closed points $s \\in S$ with $\\kappa (s) \\subset \\kappa (t)$ finite. \n\n\n\n\n    \n      Proof.\n      We have trivially (4) $\\Rightarrow $ (3) $\\Rightarrow $ (2). Lemma 29.16.7 shows that (2) implies (1). Hence it suffices to show that (1) implies (4). Suppose that $T \\to S$ is locally of finite type. Choose $t \\in T$ closed and let $s \\in S$ be the image. Choose affine open neighbourhoods $\\mathop{\\mathrm{Spec}}(R) = U \\subset S$ of $s$ and $\\mathop{\\mathrm{Spec}}(A) = V \\subset T$ of $t$ with $V$ mapping into $U$. The induced ring map $R \\to A$ is of finite type (see Lemma 29.15.2) and $R$ is Jacobson by Properties, Lemma 28.6.3. Thus the result follows from Algebra, Proposition 10.35.19. \n      $\\square$\n    \n","\n  Lemma 29.16.8. Let $S$ be a scheme. The following are equivalent: \n  \n  \nthe scheme $S$ is Jacobson, \n\n\n$S_{\\text{ft-pts}}$ is the set of closed points of $S$, \n\n\nfor all $T \\to S$ locally of finite type closed points map to closed points, and \n\n\nfor all $T \\to S$ locally of finite type closed points $t \\in T$ map to closed points $s \\in S$ with $\\kappa (s) \\subset \\kappa (t)$ finite. \n\n\n\n\n    \n","Proof.\n      We have trivially (4) $\\Rightarrow $ (3) $\\Rightarrow $ (2). Lemma 29.16.7 shows that (2) implies (1). Hence it suffices to show that (1) implies (4). Suppose that $T \\to S$ is locally of finite type. Choose $t \\in T$ closed and let $s \\in S$ be the image. Choose affine open neighbourhoods $\\mathop{\\mathrm{Spec}}(R) = U \\subset S$ of $s$ and $\\mathop{\\mathrm{Spec}}(A) = V \\subset T$ of $t$ with $V$ mapping into $U$. The induced ring map $R \\to A$ is of finite type (see Lemma 29.15.2) and $R$ is Jacobson by Properties, Lemma 28.6.3. Thus the result follows from Algebra, Proposition 10.35.19. \n      $\\square$\n    \n"," by
  constructor
  Â· exact fun H â†¦ have := isClosed_singleton_iff_isClosedImmersion.mp H; inferInstance
  Â· intro H
    simpa using (X.fromSpecResidueField x).closePoints_subset_preimage_closedPoints
      (IsLocalRing.isClosed_singleton_closedPoint _)
","lemma isClosed_singleton_iff_locallyOfFiniteType {X : Scheme.{u}} [JacobsonSpace X] {x : X} :
    IsClosed {x} â†” LocallyOfFiniteType (X.fromSpecResidueField x) ","Proof.\n      We have trivially (4) $\\Rightarrow $ (3) $\\Rightarrow $ (2). Lemma 29.16.7 [[\n  Lemma 29.16.7. Let $S$ be a scheme. For any locally closed subset $T \\subset S$ we have \n  \n  \\[  T \\not= \\emptyset \\Rightarrow T \\cap S_{\\text{ft-pts}} \\not= \\emptyset .  \\]\n\n   In particular, for any closed subset $T \\subset S$ we see that $T \\cap S_{\\text{ft-pts}}$ is dense in $T$. \n\n    \n]] shows that (2) implies (1). Hence it suffices to show that (1) implies (4). Suppose that $T \\to S$ is locally of finite type. Choose $t \\in T$ closed and let $s \\in S$ be the image. Choose affine open neighbourhoods $\\mathop{\\mathrm{Spec}}(R) = U \\subset S$ of $s$ and $\\mathop{\\mathrm{Spec}}(A) = V \\subset T$ of $t$ with $V$ mapping into $U$. The induced ring map $R \\to A$ is of finite type (see Lemma 29.15.2 [[\n  Lemma 29.15.2. Let $f : X \\to S$ be a morphism of schemes. The following are equivalent \n  \n  \nThe morphism $f$ is locally of finite type. \n\n\nFor all affine opens $U \\subset X$, $V \\subset S$ with $f(U) \\subset V$ the ring map $\\mathcal{O}_ S(V) \\to \\mathcal{O}_ X(U)$ is of finite type. \n\n\nThere exist an open covering $S = \\bigcup _{j \\in J} V_ j$ and open coverings $f^{-1}(V_ j) = \\bigcup _{i \\in I_ j} U_ i$ such that each of the morphisms $U_ i \\to V_ j$, $j\\in J, i\\in I_ j$ is locally of finite type. \n\n\nThere exist an affine open covering $S = \\bigcup _{j \\in J} V_ j$ and affine open coverings $f^{-1}(V_ j) = \\bigcup _{i \\in I_ j} U_ i$ such that the ring map $\\mathcal{O}_ S(V_ j) \\to \\mathcal{O}_ X(U_ i)$ is of finite type, for all $j\\in J, i\\in I_ j$. \n\n\n\n   Moreover, if $f$ is locally of finite type then for any open subschemes $U \\subset X$, $V \\subset S$ with $f(U) \\subset V$ the restriction $f|_ U : U \\to V$ is locally of finite type. \n\n    \n]]) and $R$ is Jacobson by Properties, Lemma 28.6.3 [[\n  Lemma 28.6.3. Let $X$ be a scheme. The following are equivalent: \n  \n  \nThe scheme $X$ is Jacobson. \n\n\nThe scheme $X$ is \xe2\x80\x9clocally Jacobson\xe2\x80\x9d in the sense of Definition 28.4.2. \n\n\nFor every affine open $U \\subset X$ the ring $\\mathcal{O}_ X(U)$ is Jacobson. \n\n\nThere exists an affine open covering $X = \\bigcup U_ i$ such that each $\\mathcal{O}_ X(U_ i)$ is Jacobson. \n\n\nThere exists an open covering $X = \\bigcup X_ j$ such that each open subscheme $X_ j$ is Jacobson. \n\n\n\n   Moreover, if $X$ is Jacobson then every open subscheme is Jacobson. \n\n    \n]]. Thus the result follows from Algebra, Proposition 10.35.19 [[\n  Proposition 10.35.19. Let $R$ be a Jacobson ring. Let $R \\to S$ be a ring map of finite type. Then \n  \n  \nThe ring $S$ is Jacobson. \n\n\nThe map $\\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R)$ transforms closed points to closed points. \n\n\nFor $\\mathfrak m\' \\subset S$ maximal lying over $\\mathfrak m \\subset R$ the field extension $\\kappa (\\mathfrak m\')/\\kappa (\\mathfrak m)$ is finite. \n\n\n\n\n    \n]]. \n      $\\square$\n    \n"
41,054K,"-- `nonrec` is needed for `wlog`
nonrec lemma Scheme.Hom.isLocallyConstructible_image (f : X âŸ¶ Y)
    [hf : LocallyOfFinitePresentation f] [QuasiCompact f]
    {s : Set X} (hs : IsLocallyConstructible s) :
    IsLocallyConstructible (f '' s) := by
  wlog hY : âˆƒ R, Y = Spec R
  Â· refine .of_isOpenCover Y.affineCover.isOpenCover_opensRange fun i â†¦ ?_
    have inst : LocallyOfFinitePresentation (Y.affineCover.pullbackHom f i) :=
      MorphismProperty.pullback_snd _ _ inferInstance
    have inst : QuasiCompact (Y.affineCover.pullbackHom f i) :=
      MorphismProperty.pullback_snd _ _ inferInstance
    convert (this (Y.affineCover.pullbackHom f i) (hs.preimage_of_isOpenEmbedding
      ((Y.affineCover.pullbackâ‚ f).f i).isOpenEmbedding)
      âŸ¨_, rflâŸ©).preimage_of_isOpenEmbedding (Y.affineCover.f i).isoOpensRange.inv.isOpenEmbedding
    refine .trans ?_
      ((Scheme.homeoOfIso (Y.affineCover.f i).isoOpensRange).image_eq_preimage_symm _)
    apply Set.image_injective.mpr Subtype.val_injective
    rw [Set.image_preimage_eq_inter_range, â† Set.image_comp, â† Set.image_comp,
      Subtype.range_coe_subtype, Set.setOf_mem_eq]
    change _ = (Y.affineCover.pullbackHom f i â‰«
      (Y.affineCover.f i).isoOpensRange.hom â‰« Opens.Î¹ _).base.hom '' _
    rw [Scheme.Hom.isoOpensRange_hom_Î¹, Cover.pullbackHom_map, Scheme.Hom.comp_base,
      TopCat.hom_comp, ContinuousMap.coe_comp, Set.image_comp, Set.image_preimage_eq_inter_range]
    simp [IsOpenImmersion.range_pullbackFst, Set.image_inter_preimage]
  obtain âŸ¨R, rflâŸ© := hY
  wlog hX : âˆƒ S, X = Spec S
  Â· have inst : CompactSpace X := HasAffineProperty.iff_of_isAffine.mp â€¹QuasiCompact fâ€º
    let ð’° := X.affineCover.finiteSubcover
    rw [â† ð’°.isOpenCover_opensRange.iUnion_inter s, Set.image_iUnion]
    refine .iUnion fun i â†¦ ?_
    have inst : QuasiCompact (ð’°.f i â‰« f) :=
      HasAffineProperty.iff_of_isAffine.mpr (inferInstanceAs (CompactSpace (Spec _)))
    convert this (hs.preimage_of_isOpenEmbedding (ð’°.f i).isOpenEmbedding) _
      (ð’°.f i â‰« f) âŸ¨_, rflâŸ©
    rw [Scheme.Hom.comp_base, â† TopCat.Hom.hom, â† TopCat.Hom.hom, TopCat.hom_comp,
      ContinuousMap.coe_comp, Set.image_comp, Set.image_preimage_eq_inter_range, coe_opensRange]
  obtain âŸ¨S, rflâŸ© := hX
  obtain âŸ¨Ï†, rflâŸ© := Spec.map_surjective f
  rw [HasRingHomProperty.Spec_iff (P := @LocallyOfFinitePresentation)] at hf
  exact (PrimeSpectrum.isConstructible_comap_image hf hs.isConstructible).isLocallyConstructible
",Formal Proof of Stacks Project Tag 054K,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/Morphisms/FinitePresentation.lean#L105-L144,Q27041,Chevalley's Theorem,29.22.3,theorem,3.0,"['054H', '01QL', '0ELP']","\n        \n      \n  Theorem 29.22.3 (Chevalley\'s Theorem). Let $f : X \\to Y$ be a morphism of schemes. Assume $f$ is quasi-compact and locally of finite presentation. Then the image of every locally constructible subset is locally constructible. \n\n    \n      Proof.\n      Let $E \\subset X$ be locally constructible. We have to show that $f(E)$ is locally constructible too. We will show that $f(E) \\cap V$ is constructible for any affine open $V \\subset Y$. Thus we reduce to the case where $Y$ is affine. In this case $X$ is quasi-compact. Hence we can write $X = U_1 \\cup \\ldots \\cup U_ n$ with each $U_ i$ affine open in $X$. If $E \\subset X$ is locally constructible, then each $E \\cap U_ i$ is constructible, see Properties, Lemma 28.2.1. Hence, since $f(E) = \\bigcup f(E \\cap U_ i)$ and since finite unions of constructible sets are constructible, this reduces us to the case where $X$ is affine. In this case the result is Algebra, Theorem 10.29.10. \n      $\\square$\n    \n",\n        \n      \n  Theorem 29.22.3 (Chevalley\'s Theorem). Let $f : X \\to Y$ be a morphism of schemes. Assume $f$ is quasi-compact and locally of finite presentation. Then the image of every locally constructible subset is locally constructible. \n\n    \n,"Proof.\n      Let $E \\subset X$ be locally constructible. We have to show that $f(E)$ is locally constructible too. We will show that $f(E) \\cap V$ is constructible for any affine open $V \\subset Y$. Thus we reduce to the case where $Y$ is affine. In this case $X$ is quasi-compact. Hence we can write $X = U_1 \\cup \\ldots \\cup U_ n$ with each $U_ i$ affine open in $X$. If $E \\subset X$ is locally constructible, then each $E \\cap U_ i$ is constructible, see Properties, Lemma 28.2.1. Hence, since $f(E) = \\bigcup f(E \\cap U_ i)$ and since finite unions of constructible sets are constructible, this reduces us to the case where $X$ is affine. In this case the result is Algebra, Theorem 10.29.10. \n      $\\square$\n    \n"," by
  wlog hY : âˆƒ R, Y = Spec R
  Â· refine .of_isOpenCover Y.affineCover.isOpenCover_opensRange fun i â†¦ ?_
    have inst : LocallyOfFinitePresentation (Y.affineCover.pullbackHom f i) :=
      MorphismProperty.pullback_snd _ _ inferInstance
    have inst : QuasiCompact (Y.affineCover.pullbackHom f i) :=
      MorphismProperty.pullback_snd _ _ inferInstance
    convert (this (Y.affineCover.pullbackHom f i) (hs.preimage_of_isOpenEmbedding
      ((Y.affineCover.pullbackâ‚ f).f i).isOpenEmbedding)
      âŸ¨_, rflâŸ©).preimage_of_isOpenEmbedding (Y.affineCover.f i).isoOpensRange.inv.isOpenEmbedding
    refine .trans ?_
      ((Scheme.homeoOfIso (Y.affineCover.f i).isoOpensRange).image_eq_preimage_symm _)
    apply Set.image_injective.mpr Subtype.val_injective
    rw [Set.image_preimage_eq_inter_range, â† Set.image_comp, â† Set.image_comp,
      Subtype.range_coe_subtype, Set.setOf_mem_eq]
    change _ = (Y.affineCover.pullbackHom f i â‰«
      (Y.affineCover.f i).isoOpensRange.hom â‰« Opens.Î¹ _).base.hom '' _
    rw [Scheme.Hom.isoOpensRange_hom_Î¹, Cover.pullbackHom_map, Scheme.Hom.comp_base,
      TopCat.hom_comp, ContinuousMap.coe_comp, Set.image_comp, Set.image_preimage_eq_inter_range]
    simp [IsOpenImmersion.range_pullbackFst, Set.image_inter_preimage]
  obtain âŸ¨R, rflâŸ© := hY
  wlog hX : âˆƒ S, X = Spec S
  Â· have inst : CompactSpace X := HasAffineProperty.iff_of_isAffine.mp â€¹QuasiCompact fâ€º
    let ð’° := X.affineCover.finiteSubcover
    rw [â† ð’°.isOpenCover_opensRange.iUnion_inter s, Set.image_iUnion]
    refine .iUnion fun i â†¦ ?_
    have inst : QuasiCompact (ð’°.f i â‰« f) :=
      HasAffineProperty.iff_of_isAffine.mpr (inferInstanceAs (CompactSpace (Spec _)))
    convert this (hs.preimage_of_isOpenEmbedding (ð’°.f i).isOpenEmbedding) _
      (ð’°.f i â‰« f) âŸ¨_, rflâŸ©
    rw [Scheme.Hom.comp_base, â† TopCat.Hom.hom, â† TopCat.Hom.hom, TopCat.hom_comp,
      ContinuousMap.coe_comp, Set.image_comp, Set.image_preimage_eq_inter_range, coe_opensRange]
  obtain âŸ¨S, rflâŸ© := hX
  obtain âŸ¨Ï†, rflâŸ© := Spec.map_surjective f
  rw [HasRingHomProperty.Spec_iff (P := @LocallyOfFinitePresentation)] at hf
  exact (PrimeSpectrum.isConstructible_comap_image hf hs.isConstructible).isLocallyConstructible
","-- `nonrec` is needed for `wlog`
nonrec lemma Scheme.Hom.isLocallyConstructible_image (f : X âŸ¶ Y)
    [hf : LocallyOfFinitePresentation f] [QuasiCompact f]
    {s : Set X} (hs : IsLocallyConstructible s) :
    IsLocallyConstructible (f '' s) ","Proof.\n      Let $E \\subset X$ be locally constructible. We have to show that $f(E)$ is locally constructible too. We will show that $f(E) \\cap V$ is constructible for any affine open $V \\subset Y$. Thus we reduce to the case where $Y$ is affine. In this case $X$ is quasi-compact. Hence we can write $X = U_1 \\cup \\ldots \\cup U_ n$ with each $U_ i$ affine open in $X$. If $E \\subset X$ is locally constructible, then each $E \\cap U_ i$ is constructible, see Properties, Lemma 28.2.1 [[\n  Lemma 28.2.1. Let $X$ be a scheme. A subset $E$ of $X$ is locally constructible in $X$ if and only if $E \\cap U$ is constructible in $U$ for every affine open $U$ of $X$. \n\n    \n]]. Hence, since $f(E) = \\bigcup f(E \\cap U_ i)$ and since finite unions of constructible sets are constructible, this reduces us to the case where $X$ is affine. In this case the result is Algebra, Theorem 10.29.10 [[\n  Theorem 10.29.10 (Chevalley\'s Theorem).  Suppose that $R \\to S$ is of finite presentation. The image of a constructible subset of $\\mathop{\\mathrm{Spec}}(S)$ in $\\mathop{\\mathrm{Spec}}(R)$ is constructible. \n\n    \n]]. \n      $\\square$\n    \n"
42,054J,"lemma Scheme.Hom.isConstructible_image (f : X âŸ¶ Y)
    [LocallyOfFinitePresentation f] [QuasiCompact f] [CompactSpace Y] [QuasiSeparatedSpace Y]
    {s : Set X} (hs : IsConstructible s) :
    IsConstructible (f '' s) :=
  (f.isLocallyConstructible_image hs.isLocallyConstructible).isConstructible
",Formal Proof of Stacks Project Tag 054J,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/Morphisms/FinitePresentation.lean#L149-L153,Q27041,,29.22.2,lemma,3.0,"['054H', '01QL', '0ELP']","\n  Lemma 29.22.2. Let $f : X \\to Y$ be a morphism of schemes. Assume \n  \n  \n$f$ is quasi-compact and locally of finite presentation, and \n\n\n$Y$ is quasi-compact and quasi-separated. \n\n\n\n   Then the image of every constructible subset of $X$ is constructible in $Y$. \n\n    \n      Proof.\n      By Properties, Lemma 28.2.5 it suffices to prove this lemma in case $Y$ is affine. In this case $X$ is quasi-compact. Hence we can write $X = U_1 \\cup \\ldots \\cup U_ n$ with each $U_ i$ affine open in $X$. If $E \\subset X$ is constructible, then each $E \\cap U_ i$ is constructible too, see Topology, Lemma 5.15.4. Hence, since $f(E) = \\bigcup f(E \\cap U_ i)$ and since finite unions of constructible sets are constructible, this reduces us to the case where $X$ is affine. In this case the result is Algebra, Theorem 10.29.10. \n      $\\square$\n    \n","\n  Lemma 29.22.2. Let $f : X \\to Y$ be a morphism of schemes. Assume \n  \n  \n$f$ is quasi-compact and locally of finite presentation, and \n\n\n$Y$ is quasi-compact and quasi-separated. \n\n\n\n   Then the image of every constructible subset of $X$ is constructible in $Y$. \n\n    \n","Proof.\n      By Properties, Lemma 28.2.5 it suffices to prove this lemma in case $Y$ is affine. In this case $X$ is quasi-compact. Hence we can write $X = U_1 \\cup \\ldots \\cup U_ n$ with each $U_ i$ affine open in $X$. If $E \\subset X$ is constructible, then each $E \\cap U_ i$ is constructible too, see Topology, Lemma 5.15.4. Hence, since $f(E) = \\bigcup f(E \\cap U_ i)$ and since finite unions of constructible sets are constructible, this reduces us to the case where $X$ is affine. In this case the result is Algebra, Theorem 10.29.10. \n      $\\square$\n    \n","
  (f.isLocallyConstructible_image hs.isLocallyConstructible).isConstructible
","lemma Scheme.Hom.isConstructible_image (f : X âŸ¶ Y)
    [LocallyOfFinitePresentation f] [QuasiCompact f] [CompactSpace Y] [QuasiSeparatedSpace Y]
    {s : Set X} (hs : IsConstructible s) :
    IsConstructible (f '' s) ","Proof.\n      By Properties, Lemma 28.2.5 [[\n  Lemma 28.2.5. Let $X$ be a quasi-compact and quasi-separated scheme. Any locally constructible subset of $X$ is constructible. \n\n    \n]] it suffices to prove this lemma in case $Y$ is affine. In this case $X$ is quasi-compact. Hence we can write $X = U_1 \\cup \\ldots \\cup U_ n$ with each $U_ i$ affine open in $X$. If $E \\subset X$ is constructible, then each $E \\cap U_ i$ is constructible too, see Topology, Lemma 5.15.4 [[\n  Lemma 5.15.4. Let $U \\subset X$ be open. For a constructible set $E \\subset X$ the intersection $E \\cap U$ is constructible in $U$. \n\n    \n]]. Hence, since $f(E) = \\bigcup f(E \\cap U_ i)$ and since finite unions of constructible sets are constructible, this reduces us to the case where $X$ is affine. In this case the result is Algebra, Theorem 10.29.10 [[\n  Theorem 10.29.10 (Chevalley\'s Theorem).  Suppose that $R \\to S$ is of finite presentation. The image of a constructible subset of $\\mathop{\\mathrm{Spec}}(S)$ in $\\mathop{\\mathrm{Spec}}(R)$ is constructible. \n\n    \n]]. \n      $\\square$\n    \n"
43,054I,"lemma Scheme.Hom.isConstructible_preimage (f : X âŸ¶ Y) {s : Set Y} (hs : IsConstructible s) :
    IsConstructible (f â»Â¹' s) :=
  hs.preimage f.continuous fun t ht ht' â†¦ IsRetrocompact_iff_isSpectralMap_subtypeVal.mpr
    (quasiCompact_iff_isSpectralMap.mp
    (MorphismProperty.of_isPullback (P := @QuasiCompact)
    (isPullback_morphismRestrict f âŸ¨t, htâŸ©)
    (quasiCompact_iff_isSpectralMap.mpr (IsRetrocompact_iff_isSpectralMap_subtypeVal.mp ht'))))
",Formal Proof of Stacks Project Tag 054I,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/Morphisms/FinitePresentation.lean#L156-L162,Q27041,,29.22.1,lemma,3.0,"['054H', '01QL', '0ELP']","\n  Lemma 29.22.1. Let $f : X \\to Y$ be a morphism of schemes. Let $E \\subset Y$ be a subset. If $E$ is (locally) constructible in $Y$, then $f^{-1}(E)$ is (locally) constructible in $X$. \n\n    \n      Proof.\n      To show that the inverse image of every constructible subset is constructible it suffices to show that the inverse image of every retrocompact open $V$ of $Y$ is retrocompact in $X$, see Topology, Lemma 5.15.3. The significance of $V$ being retrocompact in $Y$ is just that the open immersion $V \\to Y$ is quasi-compact. Hence the base change $f^{-1}(V) = X \\times _ Y V \\to X$ is quasi-compact too, see Schemes, Lemma 26.19.3. Hence we see $f^{-1}(V)$ is retrocompact in $X$. Suppose $E$ is locally constructible in $Y$. Choose $x \\in X$. Choose an affine neighbourhood $V$ of $f(x)$ and an affine neighbourhood $U \\subset X$ of $x$ such that $f(U) \\subset V$. Thus we think of $f|_ U : U \\to V$ as a morphism into $V$. By Properties, Lemma 28.2.1 we see that $E \\cap V$ is constructible in $V$. By the constructible case we see that $(f|_ U)^{-1}(E \\cap V)$ is constructible in $U$. Since $(f|_ U)^{-1}(E \\cap V) = f^{-1}(E) \\cap U$ we win. \n      $\\square$\n    \n","\n  Lemma 29.22.1. Let $f : X \\to Y$ be a morphism of schemes. Let $E \\subset Y$ be a subset. If $E$ is (locally) constructible in $Y$, then $f^{-1}(E)$ is (locally) constructible in $X$. \n\n    \n","Proof.\n      To show that the inverse image of every constructible subset is constructible it suffices to show that the inverse image of every retrocompact open $V$ of $Y$ is retrocompact in $X$, see Topology, Lemma 5.15.3. The significance of $V$ being retrocompact in $Y$ is just that the open immersion $V \\to Y$ is quasi-compact. Hence the base change $f^{-1}(V) = X \\times _ Y V \\to X$ is quasi-compact too, see Schemes, Lemma 26.19.3. Hence we see $f^{-1}(V)$ is retrocompact in $X$. Suppose $E$ is locally constructible in $Y$. Choose $x \\in X$. Choose an affine neighbourhood $V$ of $f(x)$ and an affine neighbourhood $U \\subset X$ of $x$ such that $f(U) \\subset V$. Thus we think of $f|_ U : U \\to V$ as a morphism into $V$. By Properties, Lemma 28.2.1 we see that $E \\cap V$ is constructible in $V$. By the constructible case we see that $(f|_ U)^{-1}(E \\cap V)$ is constructible in $U$. Since $(f|_ U)^{-1}(E \\cap V) = f^{-1}(E) \\cap U$ we win. \n      $\\square$\n    \n","
  hs.preimage f.continuous fun t ht ht' â†¦ IsRetrocompact_iff_isSpectralMap_subtypeVal.mpr
    (quasiCompact_iff_isSpectralMap.mp
    (MorphismProperty.of_isPullback (P := @QuasiCompact)
    (isPullback_morphismRestrict f âŸ¨t, htâŸ©)
    (quasiCompact_iff_isSpectralMap.mpr (IsRetrocompact_iff_isSpectralMap_subtypeVal.mp ht'))))
","lemma Scheme.Hom.isConstructible_preimage (f : X âŸ¶ Y) {s : Set Y} (hs : IsConstructible s) :
    IsConstructible (f â»Â¹' s) ","Proof.\n      To show that the inverse image of every constructible subset is constructible it suffices to show that the inverse image of every retrocompact open $V$ of $Y$ is retrocompact in $X$, see Topology, Lemma 5.15.3 [[\n  Lemma 5.15.3. Let $f : X \\to Y$ be a continuous map of topological spaces. If the inverse image of every retrocompact open subset of $Y$ is retrocompact in $X$, then inverse images of constructible sets are constructible. \n\n    \n]]. The significance of $V$ being retrocompact in $Y$ is just that the open immersion $V \\to Y$ is quasi-compact. Hence the base change $f^{-1}(V) = X \\times _ Y V \\to X$ is quasi-compact too, see Schemes, Lemma 26.19.3 [[\n  Lemma 26.19.3. Being quasi-compact is a property of morphisms of schemes over a base which is preserved under arbitrary base change. \n\n    \n]]. Hence we see $f^{-1}(V)$ is retrocompact in $X$. Suppose $E$ is locally constructible in $Y$. Choose $x \\in X$. Choose an affine neighbourhood $V$ of $f(x)$ and an affine neighbourhood $U \\subset X$ of $x$ such that $f(U) \\subset V$. Thus we think of $f|_ U : U \\to V$ as a morphism into $V$. By Properties, Lemma 28.2.1 [[\n  Lemma 28.2.1. Let $X$ be a scheme. A subset $E$ of $X$ is locally constructible in $X$ if and only if $E \\cap U$ is constructible in $U$ for every affine open $U$ of $X$. \n\n    \n]] we see that $E \\cap V$ is constructible in $V$. By the constructible case we see that $(f|_ U)^{-1}(E \\cap V)$ is constructible in $U$. Since $(f|_ U)^{-1}(E \\cap V) = f^{-1}(E) \\cap U$ we win. \n      $\\square$\n    \n"
44,02JY,"lemma isQuotientMap_of_surjective {X Y : Scheme.{u}} (f : X âŸ¶ Y) [Flat f] [QuasiCompact f]
    [Surjective f] : Topology.IsQuotientMap f := by
  rw [Topology.isQuotientMap_iff]
  refine âŸ¨f.surjective, fun s â†¦ âŸ¨fun hs â†¦ hs.preimage f.continuous, fun hs â†¦ ?_âŸ©âŸ©
  wlog hY : âˆƒ R, Y = Spec R
  Â· let ð’° := Y.affineCover
    rw [ð’°.isOpenCover_opensRange.isOpen_iff_inter]
    intro i
    rw [Scheme.Hom.coe_opensRange, â† Set.image_preimage_eq_inter_range]
    apply (ð’°.f i).isOpenEmbedding.isOpenMap
    refine this (f := pullback.fst (ð’°.f i) f) _ ?_ âŸ¨_, rflâŸ©
    rw [â† Set.preimage_comp, â† TopCat.coe_comp, â† Scheme.Hom.comp_base, pullback.condition,
      Scheme.Hom.comp_base, TopCat.coe_comp, Set.preimage_comp]
    exact hs.preimage (Scheme.Hom.continuous _)
  obtain âŸ¨R, rflâŸ© := hY
  wlog hX : âˆƒ S, X = Spec S
  Â· have _ : CompactSpace X := QuasiCompact.compactSpace_of_compactSpace f
    let ð’° := X.affineCover.finiteSubcover
    let p : âˆ (fun i : ð’°.Iâ‚€ â†¦ ð’°.X i) âŸ¶ X := Sigma.desc (fun i â†¦ ð’°.f i)
    refine this (f := (âˆ (fun i : ð’°.Iâ‚€ â†¦ ð’°.X i)).isoSpec.inv â‰« p â‰« f) _ _ ?_ âŸ¨_, rflâŸ©
    rw [â† Category.assoc, Scheme.Hom.comp_base, TopCat.coe_comp, Set.preimage_comp]
    exact hs.preimage (_ â‰« p).continuous
  obtain âŸ¨S, rflâŸ© := hX
  obtain âŸ¨Ï†, rflâŸ© := Spec.map_surjective f
  refine ((PrimeSpectrum.isQuotientMap_of_generalizingMap ?_ ?_).isOpen_preimage).mp hs
  Â· exact (surjective_iff (Spec.map Ï†)).mp inferInstance
  Â· apply RingHom.Flat.generalizingMap_comap
    rwa [â† HasRingHomProperty.Spec_iff (P := @Flat)]
",Formal Proof of Stacks Project Tag 02JY,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/Morphisms/Flat.lean#L102-L129,Q27041,,29.25.12,lemma,3.0,"['01U2', '01QL', '0ELP']","\n       \n      \n  Lemma 29.25.12. Let $f : X \\to Y$ be a quasi-compact, surjective, flat morphism. A subset $T \\subset Y$ is open (resp. closed) if and only $f^{-1}(T)$ is open (resp. closed). In other words, $f$ is a submersive morphism. \n\n    \n      Proof.\n      The question is local on $Y$, hence we may assume that $Y$ is affine. In this case $X$ is quasi-compact as $f$ is quasi-compact. Write $X = X_1 \\cup \\ldots \\cup X_ n$ as a finite union of affine opens. Then $f\' : X\' = X_1 \\amalg \\ldots \\amalg X_ n \\to Y$ is a surjective flat morphism of affine schemes. Note that for $T \\subset Y$ we have $(f\')^{-1}(T) = f^{-1}(T) \\cap X_1 \\amalg \\ldots \\amalg f^{-1}(T) \\cap X_ n$. Hence, $f^{-1}(T)$ is open if and only if $(f\')^{-1}(T)$ is open. Thus we may assume both $X$ and $Y$ are affine. \n    \n      Let $f : \\mathop{\\mathrm{Spec}}(B) \\to \\mathop{\\mathrm{Spec}}(A)$ be a surjective morphism of affine schemes corresponding to a flat ring map $A \\to B$. Suppose that $f^{-1}(T)$ is closed, say $f^{-1}(T) = V(J)$ for $J \\subset B$ an ideal. Then $T = f(f^{-1}(T)) = f(V(J))$ is the image of $\\mathop{\\mathrm{Spec}}(B/J) \\to \\mathop{\\mathrm{Spec}}(A)$ (here we use that $f$ is surjective). On the other hand, generalizations lift along $f$ (Lemma 29.25.9). Hence by Topology, Lemma 5.19.6 we see that $Y \\setminus T = f(X \\setminus f^{-1}(T))$ is stable under generalization. Hence $T$ is stable under specialization (Topology, Lemma 5.19.2). Thus $T$ is closed by Algebra, Lemma 10.41.5. \n      $\\square$\n    \n","\n       \n      \n  Lemma 29.25.12. Let $f : X \\to Y$ be a quasi-compact, surjective, flat morphism. A subset $T \\subset Y$ is open (resp. closed) if and only $f^{-1}(T)$ is open (resp. closed). In other words, $f$ is a submersive morphism. \n\n    \n","Proof.\n      The question is local on $Y$, hence we may assume that $Y$ is affine. In this case $X$ is quasi-compact as $f$ is quasi-compact. Write $X = X_1 \\cup \\ldots \\cup X_ n$ as a finite union of affine opens. Then $f\' : X\' = X_1 \\amalg \\ldots \\amalg X_ n \\to Y$ is a surjective flat morphism of affine schemes. Note that for $T \\subset Y$ we have $(f\')^{-1}(T) = f^{-1}(T) \\cap X_1 \\amalg \\ldots \\amalg f^{-1}(T) \\cap X_ n$. Hence, $f^{-1}(T)$ is open if and only if $(f\')^{-1}(T)$ is open. Thus we may assume both $X$ and $Y$ are affine. \n    \n      Let $f : \\mathop{\\mathrm{Spec}}(B) \\to \\mathop{\\mathrm{Spec}}(A)$ be a surjective morphism of affine schemes corresponding to a flat ring map $A \\to B$. Suppose that $f^{-1}(T)$ is closed, say $f^{-1}(T) = V(J)$ for $J \\subset B$ an ideal. Then $T = f(f^{-1}(T)) = f(V(J))$ is the image of $\\mathop{\\mathrm{Spec}}(B/J) \\to \\mathop{\\mathrm{Spec}}(A)$ (here we use that $f$ is surjective). On the other hand, generalizations lift along $f$ (Lemma 29.25.9). Hence by Topology, Lemma 5.19.6 we see that $Y \\setminus T = f(X \\setminus f^{-1}(T))$ is stable under generalization. Hence $T$ is stable under specialization (Topology, Lemma 5.19.2). Thus $T$ is closed by Algebra, Lemma 10.41.5. \n      $\\square$\n    \n"," by
  rw [Topology.isQuotientMap_iff]
  refine âŸ¨f.surjective, fun s â†¦ âŸ¨fun hs â†¦ hs.preimage f.continuous, fun hs â†¦ ?_âŸ©âŸ©
  wlog hY : âˆƒ R, Y = Spec R
  Â· let ð’° := Y.affineCover
    rw [ð’°.isOpenCover_opensRange.isOpen_iff_inter]
    intro i
    rw [Scheme.Hom.coe_opensRange, â† Set.image_preimage_eq_inter_range]
    apply (ð’°.f i).isOpenEmbedding.isOpenMap
    refine this (f := pullback.fst (ð’°.f i) f) _ ?_ âŸ¨_, rflâŸ©
    rw [â† Set.preimage_comp, â† TopCat.coe_comp, â† Scheme.Hom.comp_base, pullback.condition,
      Scheme.Hom.comp_base, TopCat.coe_comp, Set.preimage_comp]
    exact hs.preimage (Scheme.Hom.continuous _)
  obtain âŸ¨R, rflâŸ© := hY
  wlog hX : âˆƒ S, X = Spec S
  Â· have _ : CompactSpace X := QuasiCompact.compactSpace_of_compactSpace f
    let ð’° := X.affineCover.finiteSubcover
    let p : âˆ (fun i : ð’°.Iâ‚€ â†¦ ð’°.X i) âŸ¶ X := Sigma.desc (fun i â†¦ ð’°.f i)
    refine this (f := (âˆ (fun i : ð’°.Iâ‚€ â†¦ ð’°.X i)).isoSpec.inv â‰« p â‰« f) _ _ ?_ âŸ¨_, rflâŸ©
    rw [â† Category.assoc, Scheme.Hom.comp_base, TopCat.coe_comp, Set.preimage_comp]
    exact hs.preimage (_ â‰« p).continuous
  obtain âŸ¨S, rflâŸ© := hX
  obtain âŸ¨Ï†, rflâŸ© := Spec.map_surjective f
  refine ((PrimeSpectrum.isQuotientMap_of_generalizingMap ?_ ?_).isOpen_preimage).mp hs
  Â· exact (surjective_iff (Spec.map Ï†)).mp inferInstance
  Â· apply RingHom.Flat.generalizingMap_comap
    rwa [â† HasRingHomProperty.Spec_iff (P := @Flat)]
","lemma isQuotientMap_of_surjective {X Y : Scheme.{u}} (f : X âŸ¶ Y) [Flat f] [QuasiCompact f]
    [Surjective f] : Topology.IsQuotientMap f ","Proof.\n      The question is local on $Y$, hence we may assume that $Y$ is affine. In this case $X$ is quasi-compact as $f$ is quasi-compact. Write $X = X_1 \\cup \\ldots \\cup X_ n$ as a finite union of affine opens. Then $f\' : X\' = X_1 \\amalg \\ldots \\amalg X_ n \\to Y$ is a surjective flat morphism of affine schemes. Note that for $T \\subset Y$ we have $(f\')^{-1}(T) = f^{-1}(T) \\cap X_1 \\amalg \\ldots \\amalg f^{-1}(T) \\cap X_ n$. Hence, $f^{-1}(T)$ is open if and only if $(f\')^{-1}(T)$ is open. Thus we may assume both $X$ and $Y$ are affine. \n    \n      Let $f : \\mathop{\\mathrm{Spec}}(B) \\to \\mathop{\\mathrm{Spec}}(A)$ be a surjective morphism of affine schemes corresponding to a flat ring map $A \\to B$. Suppose that $f^{-1}(T)$ is closed, say $f^{-1}(T) = V(J)$ for $J \\subset B$ an ideal. Then $T = f(f^{-1}(T)) = f(V(J))$ is the image of $\\mathop{\\mathrm{Spec}}(B/J) \\to \\mathop{\\mathrm{Spec}}(A)$ (here we use that $f$ is surjective). On the other hand, generalizations lift along $f$ (Lemma 29.25.9 [[\n  Lemma 29.25.9. Let $f : X \\to S$ be a flat morphism of schemes. Then generalizations lift along $f$, see Topology, Definition 5.19.4. \n\n    \n]]). Hence by Topology, Lemma 5.19.6 [[\n  Lemma 5.19.6. Let $f : X \\to Y$ be a continuous map of topological spaces. \n  \n  \nIf specializations lift along $f$, and if $T \\subset X$ is stable under specialization, then $f(T) \\subset Y$ is stable under specialization. \n\n\nIf generalizations lift along $f$, and if $T \\subset X$ is stable under generalization, then $f(T) \\subset Y$ is stable under generalization. \n\n\n\n\n    \n]] we see that $Y \\setminus T = f(X \\setminus f^{-1}(T))$ is stable under generalization. Hence $T$ is stable under specialization (Topology, Lemma 5.19.2 [[\n  Lemma 5.19.2. Let $X$ be a topological space. \n  \n  \nAny closed subset of $X$ is stable under specialization. \n\n\nAny open subset of $X$ is stable under generalization. \n\n\nA subset $T \\subset X$ is stable under specialization if and only if the complement $T^ c$ is stable under generalization. \n\n\n\n\n    \n]]). Thus $T$ is closed by Algebra, Lemma 10.41.5 [[\n  Lemma 10.41.5. Let $R \\to S$ be a ring map. Let $T \\subset \\mathop{\\mathrm{Spec}}(R)$ be the image of $\\mathop{\\mathrm{Spec}}(S)$. If $T$ is stable under specialization, then $T$ is closed. \n\n    \n]]. \n      $\\square$\n    \n"
45,02VW,"lemma epi_of_flat_of_surjective (f : X âŸ¶ Y) [Flat f] [Surjective f] : Epi f := by
  apply CategoryTheory.Functor.epi_of_epi_map (Scheme.forgetToLocallyRingedSpace)
  apply CategoryTheory.Functor.epi_of_epi_map (LocallyRingedSpace.forgetToSheafedSpace)
  apply SheafedSpace.epi_of_base_surjective_of_stalk_mono _ â€¹Surjective fâ€º.surj
  intro x
  apply ConcreteCategory.mono_of_injective
  algebraize [(f.stalkMap x).hom]
  have : Module.FaithfullyFlat (Y.presheaf.stalk (f x)) (X.presheaf.stalk x) :=
    @Module.FaithfullyFlat.of_flat_of_isLocalHom _ _ _ _ _ _ _
      (Flat.stalkMap f x) (f.toLRSHom.prop x)
  exact â€¹RingHom.FaithfullyFlat _â€º.injective
",Formal Proof of Stacks Project Tag 02VW,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/Morphisms/Flat.lean#L133-L143,Q27041,,35.35.1,lemma,3.0,"['02VV', '0238', '0ELP']","\n  Lemma 35.35.1. A surjective and flat morphism is an epimorphism in the category of schemes. \n\n    \n      Proof.\n      Suppose we have $h : X\' \\to X$ surjective and flat and $a, b : X \\to Y$ morphisms such that $a \\circ h = b \\circ h$. As $h$ is surjective we see that $a$ and $b$ agree on underlying topological spaces. Pick $x\' \\in X\'$ and set $x = h(x\')$ and $y = a(x) = b(x)$. Consider the local ring maps \n    \n      \n  \\[  a^\\sharp _ x, b^\\sharp _ x : \\mathcal{O}_{Y, y} \\to \\mathcal{O}_{X, x}  \\]\n\n    \n       These become equal when composed with the flat local homomorphism $h^\\sharp _{x\'} : \\mathcal{O}_{X, x} \\to \\mathcal{O}_{X\', x\'}$. Since a flat local homomorphism is faithfully flat (Algebra, Lemma 10.39.17) we conclude that $h^\\sharp _{x\'}$ is injective. Hence $a^\\sharp _ x = b^\\sharp _ x$ which implies $a = b$ as desired. \n      $\\square$\n    \n",\n  Lemma 35.35.1. A surjective and flat morphism is an epimorphism in the category of schemes. \n\n    \n,"Proof.\n      Suppose we have $h : X\' \\to X$ surjective and flat and $a, b : X \\to Y$ morphisms such that $a \\circ h = b \\circ h$. As $h$ is surjective we see that $a$ and $b$ agree on underlying topological spaces. Pick $x\' \\in X\'$ and set $x = h(x\')$ and $y = a(x) = b(x)$. Consider the local ring maps \n    \n      \n  \\[  a^\\sharp _ x, b^\\sharp _ x : \\mathcal{O}_{Y, y} \\to \\mathcal{O}_{X, x}  \\]\n\n    \n       These become equal when composed with the flat local homomorphism $h^\\sharp _{x\'} : \\mathcal{O}_{X, x} \\to \\mathcal{O}_{X\', x\'}$. Since a flat local homomorphism is faithfully flat (Algebra, Lemma 10.39.17) we conclude that $h^\\sharp _{x\'}$ is injective. Hence $a^\\sharp _ x = b^\\sharp _ x$ which implies $a = b$ as desired. \n      $\\square$\n    \n"," by
  apply CategoryTheory.Functor.epi_of_epi_map (Scheme.forgetToLocallyRingedSpace)
  apply CategoryTheory.Functor.epi_of_epi_map (LocallyRingedSpace.forgetToSheafedSpace)
  apply SheafedSpace.epi_of_base_surjective_of_stalk_mono _ â€¹Surjective fâ€º.surj
  intro x
  apply ConcreteCategory.mono_of_injective
  algebraize [(f.stalkMap x).hom]
  have : Module.FaithfullyFlat (Y.presheaf.stalk (f x)) (X.presheaf.stalk x) :=
    @Module.FaithfullyFlat.of_flat_of_isLocalHom _ _ _ _ _ _ _
      (Flat.stalkMap f x) (f.toLRSHom.prop x)
  exact â€¹RingHom.FaithfullyFlat _â€º.injective
",lemma epi_of_flat_of_surjective (f : X âŸ¶ Y) [Flat f] [Surjective f] : Epi f ,"Proof.\n      Suppose we have $h : X\' \\to X$ surjective and flat and $a, b : X \\to Y$ morphisms such that $a \\circ h = b \\circ h$. As $h$ is surjective we see that $a$ and $b$ agree on underlying topological spaces. Pick $x\' \\in X\'$ and set $x = h(x\')$ and $y = a(x) = b(x)$. Consider the local ring maps \n    \n      \n  \\[  a^\\sharp _ x, b^\\sharp _ x : \\mathcal{O}_{Y, y} \\to \\mathcal{O}_{X, x}  \\]\n\n    \n       These become equal when composed with the flat local homomorphism $h^\\sharp _{x\'} : \\mathcal{O}_{X, x} \\to \\mathcal{O}_{X\', x\'}$. Since a flat local homomorphism is faithfully flat (Algebra, Lemma 10.39.17 [[\n  Lemma 10.39.17. A flat local ring homomorphism of local rings is faithfully flat. \n\n    \n]]) we conclude that $h^\\sharp _{x\'}$ is injective. Hence $a^\\sharp _ x = b^\\sharp _ x$ which implies $a = b$ as desired. \n      $\\square$\n    \n"
46,02KS,"instance descendsAlong_universallyClosed_surjective_inf_flat_inf_quasicompact :
    DescendsAlong @UniversallyClosed (@Surjective âŠ“ @Flat âŠ“ @QuasiCompact) := by
  refine IsZariskiLocalAtTarget.descendsAlong_inf_quasiCompact _ _ ?_ ?_
  Â· rw [inf_comm]
    exact inf_le_inf le_rfl (IsLocalIso.le_of_isZariskiLocalAtSource _)
  refine fun {R} S Y Ï† g âŸ¨_, _âŸ© hfst â†¦ âŸ¨universally_mk' _ _ fun {T} f _ s hs â†¦ ?_âŸ©
  let p := pullback.fst (pullback.fst (Spec.map Ï†) f) (pullback.fst (Spec.map Ï†) g)
  let r : pullback (pullback.fst (Spec.map Ï†) f) (pullback.fst (Spec.map Ï†) g) âŸ¶ pullback f g :=
    pullback.map _ _ _ _ (pullback.snd _ _) (pullback.snd _ _) (Spec.map Ï†) (pullback.condition ..)
      (pullback.condition ..)
  have : IsClosed ((pullback.snd (Spec.map Ï†) f).base â»Â¹' ((pullback.fst f g).base '' s)) := by
    rw [â† Scheme.image_preimage_eq_of_isPullback (isPullback_map_snd_snd ..)]
    exact p.isClosedMap _ (hs.preimage r.continuous)
  rwa [(Flat.isQuotientMap_of_surjective _).isClosed_preimage] at this
",Formal Proof of Stacks Project Tag 02KS,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/Morphisms/FlatDescent.lean#L46-L59,Q27041,,35.23.3,lemma,3.0,"['02YJ', '0238', '0ELP']","\n  Lemma 35.23.3. The property $\\mathcal{P}(f) =$\xe2\x80\x9c$f$ is universally closed\xe2\x80\x9d is fpqc local on the base. \n\n    \n      Proof.\n      A base change of a universally closed morphism is universally closed by definition. Being universally closed is Zariski local on the base (from the definition or by Morphisms, Lemma 29.41.2). Finally, let $S\' \\to S$ be a flat surjective morphism of affine schemes, and let $f : X \\to S$ be a morphism. Assume that the base change $f\' : X\' \\to S\'$ is universally closed. Let $T \\to S$ be any morphism. Consider the diagram \n    \n      \n  \\[  \\xymatrix{ X\' \\ar[d] &  S\' \\times _ S T \\times _ S X \\ar[d] \\ar[r] \\ar[l] &  T \\times _ S X \\ar[d] \\\\  S\' &  S\' \\times _ S T \\ar[r] \\ar[l] &  T }  \\]\n\n    \n       in which both squares are cartesian. Thus the assumption implies that the middle vertical arrow is closed. The right horizontal arrows are flat, quasi-compact and surjective (as base changes of $S\' \\to S$). Hence a subset of $T$ is closed if and only if its inverse image in $S\' \\times _ S T$ is closed, see Morphisms, Lemma 29.25.12. An easy diagram chase shows that the right vertical arrow is closed too, and we conclude $X \\to S$ is universally closed. Therefore Lemma 35.22.4 applies and we win. \n      $\\square$\n    \n",\n  Lemma 35.23.3. The property $\\mathcal{P}(f) =$\xe2\x80\x9c$f$ is universally closed\xe2\x80\x9d is fpqc local on the base. \n\n    \n,"Proof.\n      A base change of a universally closed morphism is universally closed by definition. Being universally closed is Zariski local on the base (from the definition or by Morphisms, Lemma 29.41.2). Finally, let $S\' \\to S$ be a flat surjective morphism of affine schemes, and let $f : X \\to S$ be a morphism. Assume that the base change $f\' : X\' \\to S\'$ is universally closed. Let $T \\to S$ be any morphism. Consider the diagram \n    \n      \n  \\[  \\xymatrix{ X\' \\ar[d] &  S\' \\times _ S T \\times _ S X \\ar[d] \\ar[r] \\ar[l] &  T \\times _ S X \\ar[d] \\\\  S\' &  S\' \\times _ S T \\ar[r] \\ar[l] &  T }  \\]\n\n    \n       in which both squares are cartesian. Thus the assumption implies that the middle vertical arrow is closed. The right horizontal arrows are flat, quasi-compact and surjective (as base changes of $S\' \\to S$). Hence a subset of $T$ is closed if and only if its inverse image in $S\' \\times _ S T$ is closed, see Morphisms, Lemma 29.25.12. An easy diagram chase shows that the right vertical arrow is closed too, and we conclude $X \\to S$ is universally closed. Therefore Lemma 35.22.4 applies and we win. \n      $\\square$\n    \n"," by
  refine IsZariskiLocalAtTarget.descendsAlong_inf_quasiCompact _ _ ?_ ?_
  Â· rw [inf_comm]
    exact inf_le_inf le_rfl (IsLocalIso.le_of_isZariskiLocalAtSource _)
  refine fun {R} S Y Ï† g âŸ¨_, _âŸ© hfst â†¦ âŸ¨universally_mk' _ _ fun {T} f _ s hs â†¦ ?_âŸ©
  let p := pullback.fst (pullback.fst (Spec.map Ï†) f) (pullback.fst (Spec.map Ï†) g)
  let r : pullback (pullback.fst (Spec.map Ï†) f) (pullback.fst (Spec.map Ï†) g) âŸ¶ pullback f g :=
    pullback.map _ _ _ _ (pullback.snd _ _) (pullback.snd _ _) (Spec.map Ï†) (pullback.condition ..)
      (pullback.condition ..)
  have : IsClosed ((pullback.snd (Spec.map Ï†) f).base â»Â¹' ((pullback.fst f g).base '' s)) := by
    rw [â† Scheme.image_preimage_eq_of_isPullback (isPullback_map_snd_snd ..)]
    exact p.isClosedMap _ (hs.preimage r.continuous)
  rwa [(Flat.isQuotientMap_of_surjective _).isClosed_preimage] at this
","instance descendsAlong_universallyClosed_surjective_inf_flat_inf_quasicompact :
    DescendsAlong @UniversallyClosed (@Surjective âŠ“ @Flat âŠ“ @QuasiCompact) ","Proof.\n      A base change of a universally closed morphism is universally closed by definition. Being universally closed is Zariski local on the base (from the definition or by Morphisms, Lemma 29.41.2 [[\n  Lemma 29.41.2. Let $f : X \\to S$ be a morphism of schemes. The following are equivalent: \n  \n  \nThe morphism $f$ is universally closed. \n\n\nThere exists an open covering $S = \\bigcup V_ j$ such that $f^{-1}(V_ j) \\to V_ j$ is universally closed for all indices $j$. \n\n\n\n\n    \n]]). Finally, let $S\' \\to S$ be a flat surjective morphism of affine schemes, and let $f : X \\to S$ be a morphism. Assume that the base change $f\' : X\' \\to S\'$ is universally closed. Let $T \\to S$ be any morphism. Consider the diagram \n    \n      \n  \\[  \\xymatrix{ X\' \\ar[d] &  S\' \\times _ S T \\times _ S X \\ar[d] \\ar[r] \\ar[l] &  T \\times _ S X \\ar[d] \\\\  S\' &  S\' \\times _ S T \\ar[r] \\ar[l] &  T }  \\]\n\n    \n       in which both squares are cartesian. Thus the assumption implies that the middle vertical arrow is closed. The right horizontal arrows are flat, quasi-compact and surjective (as base changes of $S\' \\to S$). Hence a subset of $T$ is closed if and only if its inverse image in $S\' \\times _ S T$ is closed, see Morphisms, Lemma 29.25.12 [[\n       \n      \n  Lemma 29.25.12. Let $f : X \\to Y$ be a quasi-compact, surjective, flat morphism. A subset $T \\subset Y$ is open (resp. closed) if and only $f^{-1}(T)$ is open (resp. closed). In other words, $f$ is a submersive morphism. \n\n    \n]]. An easy diagram chase shows that the right vertical arrow is closed too, and we conclude $X \\to S$ is universally closed. Therefore Lemma 35.22.4 [[\n  Lemma 35.22.4. Let $\\mathcal{P}$ be a property of morphisms of schemes over a base. Let $\\tau \\in \\{ fpqc, fppf, {\\acute{e}tale}, smooth, syntomic\\} $. Assume that \n  \n  \nthe property is preserved under flat, flat and locally of finite presentation, \xc3\xa9tale, smooth, or syntomic base change depending on whether $\\tau $ is fpqc, fppf, \xc3\xa9tale, smooth, or syntomic (compare with Schemes, Definition 26.18.3), \n\n\nthe property is Zariski local on the base. \n\n\nfor any surjective morphism of affine schemes $S\' \\to S$ which is flat, flat of finite presentation, \xc3\xa9tale, smooth or syntomic depending on whether $\\tau $ is fpqc, fppf, \xc3\xa9tale, smooth, or syntomic, and any morphism of schemes $f : X \\to S$ property $\\mathcal{P}$ holds for $f$ if property $\\mathcal{P}$ holds for the base change $f\' : X\' = S\' \\times _ S X \\to S\'$. \n\n\n\n   Then $\\mathcal{P}$ is $\\tau $ local on the base. \n\n    \n]] applies and we win. \n      $\\square$\n    \n"
47,02KT,"instance descendsAlong_universallyOpen_surjective_inf_flat_inf_quasicompact :
    DescendsAlong @UniversallyOpen
      (@Surjective âŠ“ @Flat âŠ“ @QuasiCompact) := by
  refine IsZariskiLocalAtTarget.descendsAlong_inf_quasiCompact _ _ ?_ ?_
  Â· rw [inf_comm]
    exact inf_le_inf le_rfl (IsLocalIso.le_of_isZariskiLocalAtSource _)
  refine fun {R} S Y Ï† g âŸ¨_, _âŸ© hfst â†¦ âŸ¨universally_mk' _ _ fun {T} f _ s hs â†¦ ?_âŸ©
  let p := pullback.fst (pullback.fst (Spec.map Ï†) f) (pullback.fst (Spec.map Ï†) g)
  let r : pullback (pullback.fst (Spec.map Ï†) f) (pullback.fst (Spec.map Ï†) g) âŸ¶ pullback f g :=
    pullback.map _ _ _ _ (pullback.snd _ _) (pullback.snd _ _) (Spec.map Ï†) (pullback.condition ..)
      (pullback.condition ..)
  have : IsOpen ((pullback.snd (Spec.map Ï†) f).base â»Â¹' ((pullback.fst f g).base '' s)) := by
    rw [â† Scheme.image_preimage_eq_of_isPullback (isPullback_map_snd_snd ..)]
    exact p.isOpenMap _ (hs.preimage r.continuous)
  rwa [(Flat.isQuotientMap_of_surjective _).isOpen_preimage] at this
",Formal Proof of Stacks Project Tag 02KT,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/Morphisms/FlatDescent.lean#L63-L77,Q27041,,35.23.4,lemma,3.0,"['02YJ', '0238', '0ELP']",\n  Lemma 35.23.4. The property $\\mathcal{P}(f) =$\xe2\x80\x9c$f$ is universally open\xe2\x80\x9d is fpqc local on the base. \n\n    \n      Proof.\n      The proof is the same as the proof of Lemma 35.23.3. \n      $\\square$\n    \n,\n  Lemma 35.23.4. The property $\\mathcal{P}(f) =$\xe2\x80\x9c$f$ is universally open\xe2\x80\x9d is fpqc local on the base. \n\n    \n,Proof.\n      The proof is the same as the proof of Lemma 35.23.3. \n      $\\square$\n    \n," by
  refine IsZariskiLocalAtTarget.descendsAlong_inf_quasiCompact _ _ ?_ ?_
  Â· rw [inf_comm]
    exact inf_le_inf le_rfl (IsLocalIso.le_of_isZariskiLocalAtSource _)
  refine fun {R} S Y Ï† g âŸ¨_, _âŸ© hfst â†¦ âŸ¨universally_mk' _ _ fun {T} f _ s hs â†¦ ?_âŸ©
  let p := pullback.fst (pullback.fst (Spec.map Ï†) f) (pullback.fst (Spec.map Ï†) g)
  let r : pullback (pullback.fst (Spec.map Ï†) f) (pullback.fst (Spec.map Ï†) g) âŸ¶ pullback f g :=
    pullback.map _ _ _ _ (pullback.snd _ _) (pullback.snd _ _) (Spec.map Ï†) (pullback.condition ..)
      (pullback.condition ..)
  have : IsOpen ((pullback.snd (Spec.map Ï†) f).base â»Â¹' ((pullback.fst f g).base '' s)) := by
    rw [â† Scheme.image_preimage_eq_of_isPullback (isPullback_map_snd_snd ..)]
    exact p.isOpenMap _ (hs.preimage r.continuous)
  rwa [(Flat.isQuotientMap_of_surjective _).isOpen_preimage] at this
","instance descendsAlong_universallyOpen_surjective_inf_flat_inf_quasicompact :
    DescendsAlong @UniversallyOpen
      (@Surjective âŠ“ @Flat âŠ“ @QuasiCompact) ",Proof.\n      The proof is the same as the proof of Lemma 35.23.3 [[\n  Lemma 35.23.3. The property $\\mathcal{P}(f) =$\xe2\x80\x9c$f$ is universally closed\xe2\x80\x9d is fpqc local on the base. \n\n    \n]]. \n      $\\square$\n    \n
48,02KW,"instance descendsAlong_universallyInjective_surjective_inf_flat_inf_quasicompact :
    DescendsAlong @UniversallyInjective (@Surjective âŠ“ @Flat âŠ“ @QuasiCompact) := by
  rw [universallyInjective_eq_diagonal]
  infer_instance
",Formal Proof of Stacks Project Tag 02KW,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/Morphisms/FlatDescent.lean#L81-L84,Q27041,,35.23.10,lemma,3.0,"['02YJ', '0238', '0ELP']","\n  Lemma 35.23.10. The property $\\mathcal{P}(f) =$\xe2\x80\x9c$f$ is universally injective\xe2\x80\x9d is fpqc local on the base. \n\n    \n      Proof.\n      A base change of a universally injective morphism is universally injective (this is formal). Being universally injective is Zariski local on the base; this is clear from the definition. Finally, let $S\' \\to S$ be a flat surjective morphism of affine schemes, and let $f : X \\to S$ be a morphism. Assume that the base change $f\' : X\' \\to S\'$ is universally injective. Let $K$ be a field, and let $a, b : \\mathop{\\mathrm{Spec}}(K) \\to X$ be two morphisms such that $f \\circ a = f \\circ b$. As $S\' \\to S$ is surjective and by the discussion in Schemes, Section 26.13 there exists a field extension $K\'/K$ and a morphism $\\mathop{\\mathrm{Spec}}(K\') \\to S\'$ such that the following solid diagram commutes \n    \n      \n  \\[  \\xymatrix{ \\mathop{\\mathrm{Spec}}(K\') \\ar[rrd] \\ar@{-->}[rd]_{a\', b\'} \\ar[dd] \\\\  &  X\' \\ar[r] \\ar[d] &  S\' \\ar[d] \\\\  \\mathop{\\mathrm{Spec}}(K) \\ar[r]^{a, b} &  X \\ar[r] &  S }  \\]\n\n    \n       As the square is cartesian we get the two dotted arrows $a\'$, $b\'$ making the diagram commute. Since $X\' \\to S\'$ is universally injective we get $a\' = b\'$, by Morphisms, Lemma 29.10.2. Clearly this forces $a = b$ (by the discussion in Schemes, Section 26.13). Therefore Lemma 35.22.4 applies and we win. \n    \n      An alternative proof would be to use the characterization of a universally injective morphism as one whose diagonal is surjective, see Morphisms, Lemma 29.10.2. The lemma then follows from the fact that the property of being surjective is fpqc local on the base, see Lemma 35.23.7. (Hint: use that the base change of the diagonal is the diagonal of the base change.) \n      $\\square$\n    \n",\n  Lemma 35.23.10. The property $\\mathcal{P}(f) =$\xe2\x80\x9c$f$ is universally injective\xe2\x80\x9d is fpqc local on the base. \n\n    \n,"Proof.\n      A base change of a universally injective morphism is universally injective (this is formal). Being universally injective is Zariski local on the base; this is clear from the definition. Finally, let $S\' \\to S$ be a flat surjective morphism of affine schemes, and let $f : X \\to S$ be a morphism. Assume that the base change $f\' : X\' \\to S\'$ is universally injective. Let $K$ be a field, and let $a, b : \\mathop{\\mathrm{Spec}}(K) \\to X$ be two morphisms such that $f \\circ a = f \\circ b$. As $S\' \\to S$ is surjective and by the discussion in Schemes, Section 26.13 there exists a field extension $K\'/K$ and a morphism $\\mathop{\\mathrm{Spec}}(K\') \\to S\'$ such that the following solid diagram commutes \n    \n      \n  \\[  \\xymatrix{ \\mathop{\\mathrm{Spec}}(K\') \\ar[rrd] \\ar@{-->}[rd]_{a\', b\'} \\ar[dd] \\\\  &  X\' \\ar[r] \\ar[d] &  S\' \\ar[d] \\\\  \\mathop{\\mathrm{Spec}}(K) \\ar[r]^{a, b} &  X \\ar[r] &  S }  \\]\n\n    \n       As the square is cartesian we get the two dotted arrows $a\'$, $b\'$ making the diagram commute. Since $X\' \\to S\'$ is universally injective we get $a\' = b\'$, by Morphisms, Lemma 29.10.2. Clearly this forces $a = b$ (by the discussion in Schemes, Section 26.13). Therefore Lemma 35.22.4 applies and we win. \n    \n      An alternative proof would be to use the characterization of a universally injective morphism as one whose diagonal is surjective, see Morphisms, Lemma 29.10.2. The lemma then follows from the fact that the property of being surjective is fpqc local on the base, see Lemma 35.23.7. (Hint: use that the base change of the diagonal is the diagonal of the base change.) \n      $\\square$\n    \n"," by
  rw [universallyInjective_eq_diagonal]
  infer_instance
","instance descendsAlong_universallyInjective_surjective_inf_flat_inf_quasicompact :
    DescendsAlong @UniversallyInjective (@Surjective âŠ“ @Flat âŠ“ @QuasiCompact) ","Proof.\n      A base change of a universally injective morphism is universally injective (this is formal). Being universally injective is Zariski local on the base; this is clear from the definition. Finally, let $S\' \\to S$ be a flat surjective morphism of affine schemes, and let $f : X \\to S$ be a morphism. Assume that the base change $f\' : X\' \\to S\'$ is universally injective. Let $K$ be a field, and let $a, b : \\mathop{\\mathrm{Spec}}(K) \\to X$ be two morphisms such that $f \\circ a = f \\circ b$. As $S\' \\to S$ is surjective and by the discussion in Schemes, Section 26.13 [[26.13 Points of schemes\n\n\nGiven a scheme $X$ we can define a functor \n\n\n  \\[  h_ X : \\mathit{Sch}^{opp} \\longrightarrow \\textit{Sets}, \\quad T \\longmapsto \\mathop{\\mathrm{Mor}}\\nolimits (T, X).  \\]\n\n\n See Categories, Example 4.3.4. This is called the functor of points of $X$. A fun part of scheme theory is to find descriptions of the internal geometry of $X$ in terms of this functor $h_ X$. In this section we find a simple way to describe points of $X$. \n\n\nLet $X$ be a scheme. Let $R$ be a local ring with maximal ideal $\\mathfrak m \\subset R$. Suppose that $f : \\mathop{\\mathrm{Spec}}(R) \\to X$ is a morphism of schemes. Let $x \\in X$ be the image of the closed point $\\mathfrak m \\in \\mathop{\\mathrm{Spec}}(R)$. Then we obtain a local homomorphism of local rings \n\n\n  \\[  f^\\sharp : \\mathcal{O}_{X, x} \\longrightarrow \\mathcal{O}_{\\mathop{\\mathrm{Spec}}(R), \\mathfrak m} = R.  \\]\n\n\n\n  Lemma 26.13.1. Let $X$ be a scheme. Let $R$ be a local ring. The construction above gives a bijective correspondence between morphisms $\\mathop{\\mathrm{Spec}}(R) \\to X$ and pairs $(x, \\varphi )$ consisting of a point $x \\in X$ and a local homomorphism of local rings $\\varphi : \\mathcal{O}_{X, x} \\to R$. \n \n\n\n    \n]] there exists a field extension $K\'/K$ and a morphism $\\mathop{\\mathrm{Spec}}(K\') \\to S\'$ such that the following solid diagram commutes \n    \n      \n  \\[  \\xymatrix{ \\mathop{\\mathrm{Spec}}(K\') \\ar[rrd] \\ar@{-->}[rd]_{a\', b\'} \\ar[dd] \\\\  &  X\' \\ar[r] \\ar[d] &  S\' \\ar[d] \\\\  \\mathop{\\mathrm{Spec}}(K) \\ar[r]^{a, b} &  X \\ar[r] &  S }  \\]\n\n    \n       As the square is cartesian we get the two dotted arrows $a\'$, $b\'$ making the diagram commute. Since $X\' \\to S\'$ is universally injective we get $a\' = b\'$, by Morphisms, Lemma 29.10.2 [[\n  Lemma 29.10.2. Let $f : X \\to S$ be a morphism of schemes. The following are equivalent: \n  \n  \nFor every field $K$ the induced map $\\mathop{\\mathrm{Mor}}\\nolimits (\\mathop{\\mathrm{Spec}}(K), X) \\to \\mathop{\\mathrm{Mor}}\\nolimits (\\mathop{\\mathrm{Spec}}(K), S)$ is injective. \n\n\nThe morphism $f$ is universally injective. \n\n\nThe morphism $f$ is radicial. \n\n\nThe diagonal morphism $\\Delta _{X/S} : X \\longrightarrow X \\times _ S X$ is surjective. \n\n\n\n\n    \n]]. Clearly this forces $a = b$ (by the discussion in Schemes, Section 26.13 [[26.13 Points of schemes\n\n\nGiven a scheme $X$ we can define a functor \n\n\n  \\[  h_ X : \\mathit{Sch}^{opp} \\longrightarrow \\textit{Sets}, \\quad T \\longmapsto \\mathop{\\mathrm{Mor}}\\nolimits (T, X).  \\]\n\n\n See Categories, Example 4.3.4. This is called the functor of points of $X$. A fun part of scheme theory is to find descriptions of the internal geometry of $X$ in terms of this functor $h_ X$. In this section we find a simple way to describe points of $X$. \n\n\nLet $X$ be a scheme. Let $R$ be a local ring with maximal ideal $\\mathfrak m \\subset R$. Suppose that $f : \\mathop{\\mathrm{Spec}}(R) \\to X$ is a morphism of schemes. Let $x \\in X$ be the image of the closed point $\\mathfrak m \\in \\mathop{\\mathrm{Spec}}(R)$. Then we obtain a local homomorphism of local rings \n\n\n  \\[  f^\\sharp : \\mathcal{O}_{X, x} \\longrightarrow \\mathcal{O}_{\\mathop{\\mathrm{Spec}}(R), \\mathfrak m} = R.  \\]\n\n\n\n  Lemma 26.13.1. Let $X$ be a scheme. Let $R$ be a local ring. The construction above gives a bijective correspondence between morphisms $\\mathop{\\mathrm{Spec}}(R) \\to X$ and pairs $(x, \\varphi )$ consisting of a point $x \\in X$ and a local homomorphism of local rings $\\varphi : \\mathcal{O}_{X, x} \\to R$. \n \n\n\n    \n]]). Therefore Lemma 35.22.4 [[\n  Lemma 35.22.4. Let $\\mathcal{P}$ be a property of morphisms of schemes over a base. Let $\\tau \\in \\{ fpqc, fppf, {\\acute{e}tale}, smooth, syntomic\\} $. Assume that \n  \n  \nthe property is preserved under flat, flat and locally of finite presentation, \xc3\xa9tale, smooth, or syntomic base change depending on whether $\\tau $ is fpqc, fppf, \xc3\xa9tale, smooth, or syntomic (compare with Schemes, Definition 26.18.3), \n\n\nthe property is Zariski local on the base. \n\n\nfor any surjective morphism of affine schemes $S\' \\to S$ which is flat, flat of finite presentation, \xc3\xa9tale, smooth or syntomic depending on whether $\\tau $ is fpqc, fppf, \xc3\xa9tale, smooth, or syntomic, and any morphism of schemes $f : X \\to S$ property $\\mathcal{P}$ holds for $f$ if property $\\mathcal{P}$ holds for the base change $f\' : X\' = S\' \\times _ S X \\to S\'$. \n\n\n\n   Then $\\mathcal{P}$ is $\\tau $ local on the base. \n\n    \n]] applies and we win. \n    \n      An alternative proof would be to use the characterization of a universally injective morphism as one whose diagonal is surjective, see Morphisms, Lemma 29.10.2 [[\n  Lemma 29.10.2. Let $f : X \\to S$ be a morphism of schemes. The following are equivalent: \n  \n  \nFor every field $K$ the induced map $\\mathop{\\mathrm{Mor}}\\nolimits (\\mathop{\\mathrm{Spec}}(K), X) \\to \\mathop{\\mathrm{Mor}}\\nolimits (\\mathop{\\mathrm{Spec}}(K), S)$ is injective. \n\n\nThe morphism $f$ is universally injective. \n\n\nThe morphism $f$ is radicial. \n\n\nThe diagonal morphism $\\Delta _{X/S} : X \\longrightarrow X \\times _ S X$ is surjective. \n\n\n\n\n    \n]]. The lemma then follows from the fact that the property of being surjective is fpqc local on the base, see Lemma 35.23.7 [[\n  Lemma 35.23.7. The property $\\mathcal{P}(f) =$\xe2\x80\x9c$f$ is surjective\xe2\x80\x9d is fpqc local on the base. \n\n    \n]]. (Hint: use that the base change of the diagonal is the diagonal of the base change.) \n      $\\square$\n    \n"
49,02L4,"instance descendsAlong_isomorphisms_surjective_inf_flat_inf_quasicompact :
    (isomorphisms Scheme.{u}).DescendsAlong (@Surjective âŠ“ @Flat âŠ“ @QuasiCompact) := by
  apply IsZariskiLocalAtTarget.descendsAlong_inf_quasiCompact
  Â· rw [inf_comm]
    exact inf_le_inf le_rfl (IsLocalIso.le_of_isZariskiLocalAtSource _)
  intro R S Y Ï† g h (hfst : IsIso _)
  have : IsAffine Y :=
    have : UniversallyInjective g :=
      of_pullback_fst_of_descendsAlong (P := @UniversallyInjective) (f := Spec.map Ï†)
        (Q := @Surjective âŠ“ @Flat âŠ“ @QuasiCompact) âŸ¨h, inferInstanceâŸ© inferInstance
    have : Surjective g :=
      of_pullback_fst_of_descendsAlong (P := @Surjective) (f := Spec.map Ï†)
        (Q := @Surjective âŠ“ @Flat âŠ“ @QuasiCompact) âŸ¨h, inferInstanceâŸ© inferInstance
    have hopen' : UniversallyOpen g :=
      of_pullback_fst_of_descendsAlong (P := @UniversallyOpen) (f := Spec.map Ï†)
        (Q := @Surjective âŠ“ @Flat âŠ“ @QuasiCompact) âŸ¨h, inferInstanceâŸ© inferInstance
    have : IsHomeomorph g.base := âŸ¨g.continuous, g.isOpenMap, g.injective, g.surjectiveâŸ©
    have : IsAffineHom g :=
      isAffineHom_of_isInducing g this.isInducing this.isClosedEmbedding.isClosed_range
    isAffine_of_isAffineHom g
  wlog hY : âˆƒ T, Y = Spec T generalizing Y
  Â· rw [â† (isomorphisms Scheme).cancel_left_of_respectsIso Y.isoSpec.inv]
    have heq : pullback.fst (Spec.map Ï†) (Y.isoSpec.inv â‰« g) =
      pullback.map _ _ _ _ (ðŸ™ _) (Y.isoSpec.inv) (ðŸ™ _) (by simp) (by simp) â‰«
        pullback.fst (Spec.map Ï†) g := (pullback.lift_fst _ _ _).symm
    refine this _ ?_ inferInstance âŸ¨_, rflâŸ©
    change isomorphisms Scheme _
    rwa [heq, (isomorphisms Scheme).cancel_left_of_respectsIso]
  obtain âŸ¨T, rflâŸ© := hY
  obtain âŸ¨Ïˆ, rflâŸ© := Spec.map_surjective g
  refine of_pullback_fst_Spec_of_codescendsAlong (P := isomorphisms Scheme.{u})
      (Q' := RingHom.FaithfullyFlat) (Q := fun f â†¦ Function.Bijective f) (P' := @Surjective âŠ“ @Flat)
      RingHom.FaithfullyFlat.codescendsAlong_bijective ?_ ?_ h hfst
  Â· intro _ _ f hf
    rwa [â† flat_and_surjective_SpecMap_iff, and_comm]
  Â· simp_rw [â† isIso_SpecMap_iff, isomorphisms.iff, implies_true]
",Formal Proof of Stacks Project Tag 02L4,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/Morphisms/FlatDescent.lean#L88-L123,Q27041,,35.23.19,lemma,3.0,"['02YJ', '0238', '0ELP']",\n  Lemma 35.23.19. The property $\\mathcal{P}(f) =$\xe2\x80\x9c$f$ is an isomorphism\xe2\x80\x9d is fpqc local on the base. \n\n    \n      Proof.\n      Combine Lemmas 35.23.7 and 35.23.18. \n      $\\square$\n    \n,\n  Lemma 35.23.19. The property $\\mathcal{P}(f) =$\xe2\x80\x9c$f$ is an isomorphism\xe2\x80\x9d is fpqc local on the base. \n\n    \n,Proof.\n      Combine Lemmas 35.23.7 and 35.23.18. \n      $\\square$\n    \n," by
  apply IsZariskiLocalAtTarget.descendsAlong_inf_quasiCompact
  Â· rw [inf_comm]
    exact inf_le_inf le_rfl (IsLocalIso.le_of_isZariskiLocalAtSource _)
  intro R S Y Ï† g h (hfst : IsIso _)
  have : IsAffine Y :=
    have : UniversallyInjective g :=
      of_pullback_fst_of_descendsAlong (P := @UniversallyInjective) (f := Spec.map Ï†)
        (Q := @Surjective âŠ“ @Flat âŠ“ @QuasiCompact) âŸ¨h, inferInstanceâŸ© inferInstance
    have : Surjective g :=
      of_pullback_fst_of_descendsAlong (P := @Surjective) (f := Spec.map Ï†)
        (Q := @Surjective âŠ“ @Flat âŠ“ @QuasiCompact) âŸ¨h, inferInstanceâŸ© inferInstance
    have hopen' : UniversallyOpen g :=
      of_pullback_fst_of_descendsAlong (P := @UniversallyOpen) (f := Spec.map Ï†)
        (Q := @Surjective âŠ“ @Flat âŠ“ @QuasiCompact) âŸ¨h, inferInstanceâŸ© inferInstance
    have : IsHomeomorph g.base := âŸ¨g.continuous, g.isOpenMap, g.injective, g.surjectiveâŸ©
    have : IsAffineHom g :=
      isAffineHom_of_isInducing g this.isInducing this.isClosedEmbedding.isClosed_range
    isAffine_of_isAffineHom g
  wlog hY : âˆƒ T, Y = Spec T generalizing Y
  Â· rw [â† (isomorphisms Scheme).cancel_left_of_respectsIso Y.isoSpec.inv]
    have heq : pullback.fst (Spec.map Ï†) (Y.isoSpec.inv â‰« g) =
      pullback.map _ _ _ _ (ðŸ™ _) (Y.isoSpec.inv) (ðŸ™ _) (by simp) (by simp) â‰«
        pullback.fst (Spec.map Ï†) g := (pullback.lift_fst _ _ _).symm
    refine this _ ?_ inferInstance âŸ¨_, rflâŸ©
    change isomorphisms Scheme _
    rwa [heq, (isomorphisms Scheme).cancel_left_of_respectsIso]
  obtain âŸ¨T, rflâŸ© := hY
  obtain âŸ¨Ïˆ, rflâŸ© := Spec.map_surjective g
  refine of_pullback_fst_Spec_of_codescendsAlong (P := isomorphisms Scheme.{u})
      (Q' := RingHom.FaithfullyFlat) (Q := fun f â†¦ Function.Bijective f) (P' := @Surjective âŠ“ @Flat)
      RingHom.FaithfullyFlat.codescendsAlong_bijective ?_ ?_ h hfst
  Â· intro _ _ f hf
    rwa [â† flat_and_surjective_SpecMap_iff, and_comm]
  Â· simp_rw [â† isIso_SpecMap_iff, isomorphisms.iff, implies_true]
","instance descendsAlong_isomorphisms_surjective_inf_flat_inf_quasicompact :
    (isomorphisms Scheme.{u}).DescendsAlong (@Surjective âŠ“ @Flat âŠ“ @QuasiCompact) ",Proof.\n      Combine Lemmas 35.23.7 [[\n  Lemma 35.23.7. The property $\\mathcal{P}(f) =$\xe2\x80\x9c$f$ is surjective\xe2\x80\x9d is fpqc local on the base. \n\n    \n]] and 35.23.18 [[\n  Lemma 35.23.18. The property $\\mathcal{P}(f) =$\xe2\x80\x9c$f$ is an open immersion\xe2\x80\x9d is fpqc local on the base. \n\n    \n]]. \n      $\\square$\n    \n
50,02L3,"instance descendsAlong_isOpenImmersion_surjective_inf_flat_inf_quasicompact' :
    IsOpenImmersion.DescendsAlong (@Surjective âŠ“ @Flat âŠ“ @QuasiCompact) := by
  apply DescendsAlong.mk'
  intro X Y Z f g _ hf hg
  have : UniversallyOpen g :=
    MorphismProperty.of_pullback_fst_of_descendsAlong
      (P := @UniversallyOpen) (Q := @Surjective âŠ“ @Flat âŠ“ @QuasiCompact) (f := f)
      hf inferInstance
  let U : Z.Opens := âŸ¨Set.range g.base, g.isOpenMap.isOpen_rangeâŸ©
  let f' := pullback.snd f U.Î¹
  let g' : Y âŸ¶ U := IsOpenImmersion.lift U.Î¹ g (by simp [U])
  have : Surjective g' := âŸ¨fun âŸ¨x, âŸ¨y, hyâŸ©âŸ© â†¦
    âŸ¨y, by apply U.Î¹.injective; simp [â† Scheme.Hom.comp_apply, g', hy]âŸ©âŸ©
  have : IsIso (pullback.fst f' g') := by
    rw [isIso_iff_isOpenImmersion_and_surjective]
    refine âŸ¨?_, inferInstanceâŸ©
    have : IsOpenImmersion (pullback.fst f (g' â‰« U.Î¹)) := by
      rwa [AlgebraicGeometry.IsOpenImmersion.lift_fac]
    have : IsOpenImmersion (pullback.fst f' g' â‰« pullback.fst f U.Î¹) := by
      rw [â† pullbackLeftPullbackSndIso_hom_fst]
      infer_instance
    exact .of_comp _ (pullback.fst _ _)
  have : IsIso g' := by
    apply MorphismProperty.of_pullback_fst_of_descendsAlong
      (P := isomorphisms Scheme) (Q := @Surjective âŠ“ @Flat âŠ“ @QuasiCompact) (f := f') ?_ this
    exact MorphismProperty.pullback_snd _ _ hf
  rw [â† IsOpenImmersion.lift_fac U.Î¹ g (by simp [U])]
  infer_instance
",Formal Proof of Stacks Project Tag 02L3,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/Morphisms/FlatDescent.lean#L127-L154,Q27041,,35.23.18,lemma,3.0,"['02YJ', '0238', '0ELP']","\n  Lemma 35.23.18. The property $\\mathcal{P}(f) =$\xe2\x80\x9c$f$ is an open immersion\xe2\x80\x9d is fpqc local on the base. \n\n    \n      Proof.\n      The property of being an open immersion is stable under base change, see Schemes, Lemma 26.18.2. The property of being an open immersion is Zariski local on the base (this is obvious). \n    \n      Let $S\' \\to S$ be a flat surjective morphism of affine schemes, and let $f : X \\to S$ be a morphism. Assume that the base change $f\' : X\' \\to S\'$ is an open immersion. We claim that $f$ is an open immersion. Then $f\'$ is universally open, and universally injective. Hence we conclude that $f$ is universally open by Lemma 35.23.4, and universally injective by Lemma 35.23.10. In particular $f(X) \\subset S$ is open. If for every affine open $U \\subset f(X)$ we can prove that $f^{-1}(U) \\to U$ is an isomorphism, then $f$ is an open immersion and we\'re done. If $U\' \\subset S\'$ denotes the inverse image of $U$, then $U\' \\to U$ is a faithfully flat morphism of affines and $(f\')^{-1}(U\') \\to U\'$ is an isomorphism (as $f\'(X\')$ contains $U\'$ by our choice of $U$). Thus we reduce to the case discussed in the next paragraph. \n    \n      Let $S\' \\to S$ be a flat surjective morphism of affine schemes, let $f : X \\to S$ be a morphism, and assume that the base change $f\' : X\' \\to S\'$ is an isomorphism. We have to show that $f$ is an isomorphism also. It is clear that $f$ is surjective, universally injective, and universally open (see arguments above for the last two). Hence $f$ is bijective, i.e., $f$ is a homeomorphism. Thus $f$ is affine by Morphisms, Lemma 29.45.4. Since \n    \n      \n  \\[  \\mathcal{O}(S\') \\to \\mathcal{O}(X\') = \\mathcal{O}(S\') \\otimes _{\\mathcal{O}(S)} \\mathcal{O}(X)  \\]\n\n    \n       is an isomorphism and since $\\mathcal{O}(S) \\to \\mathcal{O}(S\')$ is faithfully flat this implies that $\\mathcal{O}(S) \\to \\mathcal{O}(X)$ is an isomorphism. Thus $f$ is an isomorphism. This finishes the proof of the claim above. Therefore Lemma 35.22.4 applies and we win. \n      $\\square$\n    \n",\n  Lemma 35.23.18. The property $\\mathcal{P}(f) =$\xe2\x80\x9c$f$ is an open immersion\xe2\x80\x9d is fpqc local on the base. \n\n    \n,"Proof.\n      The property of being an open immersion is stable under base change, see Schemes, Lemma 26.18.2. The property of being an open immersion is Zariski local on the base (this is obvious). \n    \n      Let $S\' \\to S$ be a flat surjective morphism of affine schemes, and let $f : X \\to S$ be a morphism. Assume that the base change $f\' : X\' \\to S\'$ is an open immersion. We claim that $f$ is an open immersion. Then $f\'$ is universally open, and universally injective. Hence we conclude that $f$ is universally open by Lemma 35.23.4, and universally injective by Lemma 35.23.10. In particular $f(X) \\subset S$ is open. If for every affine open $U \\subset f(X)$ we can prove that $f^{-1}(U) \\to U$ is an isomorphism, then $f$ is an open immersion and we\'re done. If $U\' \\subset S\'$ denotes the inverse image of $U$, then $U\' \\to U$ is a faithfully flat morphism of affines and $(f\')^{-1}(U\') \\to U\'$ is an isomorphism (as $f\'(X\')$ contains $U\'$ by our choice of $U$). Thus we reduce to the case discussed in the next paragraph. \n    \n      Let $S\' \\to S$ be a flat surjective morphism of affine schemes, let $f : X \\to S$ be a morphism, and assume that the base change $f\' : X\' \\to S\'$ is an isomorphism. We have to show that $f$ is an isomorphism also. It is clear that $f$ is surjective, universally injective, and universally open (see arguments above for the last two). Hence $f$ is bijective, i.e., $f$ is a homeomorphism. Thus $f$ is affine by Morphisms, Lemma 29.45.4. Since \n    \n      \n  \\[  \\mathcal{O}(S\') \\to \\mathcal{O}(X\') = \\mathcal{O}(S\') \\otimes _{\\mathcal{O}(S)} \\mathcal{O}(X)  \\]\n\n    \n       is an isomorphism and since $\\mathcal{O}(S) \\to \\mathcal{O}(S\')$ is faithfully flat this implies that $\\mathcal{O}(S) \\to \\mathcal{O}(X)$ is an isomorphism. Thus $f$ is an isomorphism. This finishes the proof of the claim above. Therefore Lemma 35.22.4 applies and we win. \n      $\\square$\n    \n"," by
  apply DescendsAlong.mk'
  intro X Y Z f g _ hf hg
  have : UniversallyOpen g :=
    MorphismProperty.of_pullback_fst_of_descendsAlong
      (P := @UniversallyOpen) (Q := @Surjective âŠ“ @Flat âŠ“ @QuasiCompact) (f := f)
      hf inferInstance
  let U : Z.Opens := âŸ¨Set.range g.base, g.isOpenMap.isOpen_rangeâŸ©
  let f' := pullback.snd f U.Î¹
  let g' : Y âŸ¶ U := IsOpenImmersion.lift U.Î¹ g (by simp [U])
  have : Surjective g' := âŸ¨fun âŸ¨x, âŸ¨y, hyâŸ©âŸ© â†¦
    âŸ¨y, by apply U.Î¹.injective; simp [â† Scheme.Hom.comp_apply, g', hy]âŸ©âŸ©
  have : IsIso (pullback.fst f' g') := by
    rw [isIso_iff_isOpenImmersion_and_surjective]
    refine âŸ¨?_, inferInstanceâŸ©
    have : IsOpenImmersion (pullback.fst f (g' â‰« U.Î¹)) := by
      rwa [AlgebraicGeometry.IsOpenImmersion.lift_fac]
    have : IsOpenImmersion (pullback.fst f' g' â‰« pullback.fst f U.Î¹) := by
      rw [â† pullbackLeftPullbackSndIso_hom_fst]
      infer_instance
    exact .of_comp _ (pullback.fst _ _)
  have : IsIso g' := by
    apply MorphismProperty.of_pullback_fst_of_descendsAlong
      (P := isomorphisms Scheme) (Q := @Surjective âŠ“ @Flat âŠ“ @QuasiCompact) (f := f') ?_ this
    exact MorphismProperty.pullback_snd _ _ hf
  rw [â† IsOpenImmersion.lift_fac U.Î¹ g (by simp [U])]
  infer_instance
","instance descendsAlong_isOpenImmersion_surjective_inf_flat_inf_quasicompact' :
    IsOpenImmersion.DescendsAlong (@Surjective âŠ“ @Flat âŠ“ @QuasiCompact) ","Proof.\n      The property of being an open immersion is stable under base change, see Schemes, Lemma 26.18.2 [[\n  Lemma 26.18.2. Let $S$ be a scheme. Let $f : X \\to Y$ be an immersion (resp. closed immersion, resp. open immersion) of schemes over $S$. Then any base change of $f$ is an immersion (resp. closed immersion, resp. open immersion). \n\n    \n]]. The property of being an open immersion is Zariski local on the base (this is obvious). \n    \n      Let $S\' \\to S$ be a flat surjective morphism of affine schemes, and let $f : X \\to S$ be a morphism. Assume that the base change $f\' : X\' \\to S\'$ is an open immersion. We claim that $f$ is an open immersion. Then $f\'$ is universally open, and universally injective. Hence we conclude that $f$ is universally open by Lemma 35.23.4 [[\n  Lemma 35.23.4. The property $\\mathcal{P}(f) =$\xe2\x80\x9c$f$ is universally open\xe2\x80\x9d is fpqc local on the base. \n\n    \n]], and universally injective by Lemma 35.23.10 [[\n  Lemma 35.23.10. The property $\\mathcal{P}(f) =$\xe2\x80\x9c$f$ is universally injective\xe2\x80\x9d is fpqc local on the base. \n\n    \n]]. In particular $f(X) \\subset S$ is open. If for every affine open $U \\subset f(X)$ we can prove that $f^{-1}(U) \\to U$ is an isomorphism, then $f$ is an open immersion and we\'re done. If $U\' \\subset S\'$ denotes the inverse image of $U$, then $U\' \\to U$ is a faithfully flat morphism of affines and $(f\')^{-1}(U\') \\to U\'$ is an isomorphism (as $f\'(X\')$ contains $U\'$ by our choice of $U$). Thus we reduce to the case discussed in the next paragraph. \n    \n      Let $S\' \\to S$ be a flat surjective morphism of affine schemes, let $f : X \\to S$ be a morphism, and assume that the base change $f\' : X\' \\to S\'$ is an isomorphism. We have to show that $f$ is an isomorphism also. It is clear that $f$ is surjective, universally injective, and universally open (see arguments above for the last two). Hence $f$ is bijective, i.e., $f$ is a homeomorphism. Thus $f$ is affine by Morphisms, Lemma 29.45.4 [[\n  Lemma 29.45.4. Let $f : X \\to Y$ be a morphism of schemes. If $f$ is a homeomorphism onto a closed subset of $Y$ then $f$ is affine. \n\n    \n]]. Since \n    \n      \n  \\[  \\mathcal{O}(S\') \\to \\mathcal{O}(X\') = \\mathcal{O}(S\') \\otimes _{\\mathcal{O}(S)} \\mathcal{O}(X)  \\]\n\n    \n       is an isomorphism and since $\\mathcal{O}(S) \\to \\mathcal{O}(S\')$ is faithfully flat this implies that $\\mathcal{O}(S) \\to \\mathcal{O}(X)$ is an isomorphism. Thus $f$ is an isomorphism. This finishes the proof of the claim above. Therefore Lemma 35.22.4 [[\n  Lemma 35.22.4. Let $\\mathcal{P}$ be a property of morphisms of schemes over a base. Let $\\tau \\in \\{ fpqc, fppf, {\\acute{e}tale}, smooth, syntomic\\} $. Assume that \n  \n  \nthe property is preserved under flat, flat and locally of finite presentation, \xc3\xa9tale, smooth, or syntomic base change depending on whether $\\tau $ is fpqc, fppf, \xc3\xa9tale, smooth, or syntomic (compare with Schemes, Definition 26.18.3), \n\n\nthe property is Zariski local on the base. \n\n\nfor any surjective morphism of affine schemes $S\' \\to S$ which is flat, flat of finite presentation, \xc3\xa9tale, smooth or syntomic depending on whether $\\tau $ is fpqc, fppf, \xc3\xa9tale, smooth, or syntomic, and any morphism of schemes $f : X \\to S$ property $\\mathcal{P}$ holds for $f$ if property $\\mathcal{P}$ holds for the base change $f\' : X\' = S\' \\times _ S X \\to S\'$. \n\n\n\n   Then $\\mathcal{P}$ is $\\tau $ local on the base. \n\n    \n]] applies and we win. \n      $\\square$\n    \n"
51,06NC,"lemma Flat.isIso_of_surjective_of_mono {X Y : Scheme.{u}} (f : X âŸ¶ Y) [Flat f]
    [QuasiCompact f] [Surjective f] [Mono f] : IsIso f := by
  apply MorphismProperty.of_pullback_fst_of_descendsAlong
    (P := isomorphisms Scheme.{u}) (Q := @Surjective âŠ“ @Flat âŠ“ @QuasiCompact) (f := f) (g := f)
  Â· tauto
  Â· exact inferInstanceAs <| IsIso (pullback.fst f f)
",Formal Proof of Stacks Project Tag 06NC,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/Morphisms/FlatMono.lean#L25-L30,Q27041,,35.25.1,lemma,3.0,"['02LB', '0238', '0ELP']","\n  Lemma 35.25.1. Let $f : X \\to Y$ be a flat, quasi-compact, surjective monomorphism. Then f is an isomorphism. \n\n    \n      Proof.\n      As $f$ is a flat, quasi-compact, surjective morphism we see $\\{ X \\to Y\\} $ is an fpqc covering of $Y$. The diagonal $\\Delta : X \\to X \\times _ Y X$ is an isomorphism (Schemes, Lemma 26.23.2). This implies that the base change of $f$ by $f$ is an isomorphism. Hence we see $f$ is an isomorphism by Lemma 35.23.19. \n      $\\square$\n    \n","\n  Lemma 35.25.1. Let $f : X \\to Y$ be a flat, quasi-compact, surjective monomorphism. Then f is an isomorphism. \n\n    \n","Proof.\n      As $f$ is a flat, quasi-compact, surjective morphism we see $\\{ X \\to Y\\} $ is an fpqc covering of $Y$. The diagonal $\\Delta : X \\to X \\times _ Y X$ is an isomorphism (Schemes, Lemma 26.23.2). This implies that the base change of $f$ by $f$ is an isomorphism. Hence we see $f$ is an isomorphism by Lemma 35.23.19. \n      $\\square$\n    \n"," by
  apply MorphismProperty.of_pullback_fst_of_descendsAlong
    (P := isomorphisms Scheme.{u}) (Q := @Surjective âŠ“ @Flat âŠ“ @QuasiCompact) (f := f) (g := f)
  Â· tauto
  Â· exact inferInstanceAs <| IsIso (pullback.fst f f)
","lemma Flat.isIso_of_surjective_of_mono {X Y : Scheme.{u}} (f : X âŸ¶ Y) [Flat f]
    [QuasiCompact f] [Surjective f] [Mono f] : IsIso f ","Proof.\n      As $f$ is a flat, quasi-compact, surjective morphism we see $\\{ X \\to Y\\} $ is an fpqc covering of $Y$. The diagonal $\\Delta : X \\to X \\times _ Y X$ is an isomorphism (Schemes, Lemma 26.23.2 [[\n       \n      \n  Lemma 26.23.2. Let $j : X \\to Y$ be a morphism of schemes. Then $j$ is a monomorphism if and only if the diagonal morphism $\\Delta _{X/Y} : X \\to X \\times _ Y X$ is an isomorphism. \n\n    \n]]). This implies that the base change of $f$ by $f$ is an isomorphism. Hence we see $f$ is an isomorphism by Lemma 35.23.19 [[\n  Lemma 35.23.19. The property $\\mathcal{P}(f) =$\xe2\x80\x9c$f$ is an isomorphism\xe2\x80\x9d is fpqc local on the base. \n\n    \n]]. \n      $\\square$\n    \n"
52,01KJ,"instance : IsImmersion (pullback.diagonal f) := by
  let ð’° := Y.affineCover
  let ð’± (i) := (pullback f (ð’°.f i)).affineCover
  have H : pullback.diagonal f â»Â¹áµ diagonalCoverDiagonalRange f ð’° ð’± = âŠ¤ :=
    top_le_iff.mp fun _ _ â†¦ range_diagonal_subset_diagonalCoverDiagonalRange _ _ _ âŸ¨_, rflâŸ©
  have := isClosedImmersion_diagonal_restrict_diagonalCoverDiagonalRange f ð’° ð’±
  have : IsImmersion ((pullback.diagonal f âˆ£_
    diagonalCoverDiagonalRange f ð’° ð’±) â‰« Scheme.Opens.Î¹ _) := inferInstance
  rwa [morphismRestrict_Î¹, H, â† Scheme.topIso_hom,
    MorphismProperty.cancel_left_of_respectsIso (P := @IsImmersion)] at this
",Formal Proof of Stacks Project Tag 01KJ,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/Morphisms/Immersion.lean#L190-L199,Q27041,,26.21.2,lemma,3.0,"['01KH', '01H8', '0ELP']","\n       \n      \n  Lemma 26.21.2. Let $X$ be a scheme over $S$. The diagonal morphism $\\Delta _{X/S}$ is an immersion. \n\n    \n      Proof.\n      Recall that if $V \\subset X$ is affine open and maps into $U \\subset S$ affine open, then $V \\times _ U V$ is affine open in $X \\times _ S X$, see Lemmas 26.17.2 and 26.17.3. Consider the open subscheme $W$ of $X \\times _ S X$ which is the union of these affine opens $V \\times _ U V$. By Lemma 26.4.2 it is enough to show that each morphism $\\Delta _{X/S}^{-1}(V \\times _ U V) \\to V \\times _ U V$ is a closed immersion. Since $V = \\Delta _{X/S}^{-1}(V \\times _ U V)$ we are just checking that $\\Delta _{V/U}$ is a closed immersion, which is Lemma 26.21.1. \n      $\\square$\n    \n",\n       \n      \n  Lemma 26.21.2. Let $X$ be a scheme over $S$. The diagonal morphism $\\Delta _{X/S}$ is an immersion. \n\n    \n,"Proof.\n      Recall that if $V \\subset X$ is affine open and maps into $U \\subset S$ affine open, then $V \\times _ U V$ is affine open in $X \\times _ S X$, see Lemmas 26.17.2 and 26.17.3. Consider the open subscheme $W$ of $X \\times _ S X$ which is the union of these affine opens $V \\times _ U V$. By Lemma 26.4.2 it is enough to show that each morphism $\\Delta _{X/S}^{-1}(V \\times _ U V) \\to V \\times _ U V$ is a closed immersion. Since $V = \\Delta _{X/S}^{-1}(V \\times _ U V)$ we are just checking that $\\Delta _{V/U}$ is a closed immersion, which is Lemma 26.21.1. \n      $\\square$\n    \n"," by
  let ð’° := Y.affineCover
  let ð’± (i) := (pullback f (ð’°.f i)).affineCover
  have H : pullback.diagonal f â»Â¹áµ diagonalCoverDiagonalRange f ð’° ð’± = âŠ¤ :=
    top_le_iff.mp fun _ _ â†¦ range_diagonal_subset_diagonalCoverDiagonalRange _ _ _ âŸ¨_, rflâŸ©
  have := isClosedImmersion_diagonal_restrict_diagonalCoverDiagonalRange f ð’° ð’±
  have : IsImmersion ((pullback.diagonal f âˆ£_
    diagonalCoverDiagonalRange f ð’° ð’±) â‰« Scheme.Opens.Î¹ _) := inferInstance
  rwa [morphismRestrict_Î¹, H, â† Scheme.topIso_hom,
    MorphismProperty.cancel_left_of_respectsIso (P := @IsImmersion)] at this
",instance : IsImmersion (pullback.diagonal f) ,"Proof.\n      Recall that if $V \\subset X$ is affine open and maps into $U \\subset S$ affine open, then $V \\times _ U V$ is affine open in $X \\times _ S X$, see Lemmas 26.17.2 [[\n  Lemma 26.17.2. Let $f : X \\to S$ and $g : Y \\to S$ be morphisms of schemes with the same target. If $X, Y, S$ are all affine then $X \\times _ S Y$ is affine. \n\n    \n]] and 26.17.3 [[\n  Lemma 26.17.3. Let $f : X \\to S$ and $g : Y \\to S$ be morphisms of schemes with the same target. Let $X \\times _ S Y$, $p$, $q$ be the fibre product. Suppose that $U \\subset S$, $V \\subset X$, $W \\subset Y$ are open subschemes such that $f(V) \\subset U$ and $g(W) \\subset U$. Then the canonical morphism $V \\times _ U W \\to X \\times _ S Y$ is an open immersion which identifies $V \\times _ U W$ with $p^{-1}(V) \\cap q^{-1}(W)$. \n\n    \n]]. Consider the open subscheme $W$ of $X \\times _ S X$ which is the union of these affine opens $V \\times _ U V$. By Lemma 26.4.2 [[\n  Lemma 26.4.2. Let $f : Z \\to X$ be a morphism of locally ringed spaces. In order for $f$ to be a closed immersion it suffices that there exists an open covering $X = \\bigcup U_ i$ such that each $f : f^{-1}U_ i \\to U_ i$ is a closed immersion. \n\n    \n]] it is enough to show that each morphism $\\Delta _{X/S}^{-1}(V \\times _ U V) \\to V \\times _ U V$ is a closed immersion. Since $V = \\Delta _{X/S}^{-1}(V \\times _ U V)$ we are just checking that $\\Delta _{V/U}$ is a closed immersion, which is Lemma 26.21.1 [[\n  Lemma 26.21.1. The diagonal morphism of a morphism between affines is closed. \n\n    \n]]. \n      $\\square$\n    \n"
53,01W6,"lemma UniversallyClosed.of_comp_of_isSeparated [UniversallyClosed (f â‰« g)] [IsSeparated g] :
    UniversallyClosed f :=
  MorphismProperty.of_postcomp _ _ g â€¹_â€º â€¹_â€º
",Formal Proof of Stacks Project Tag 01W6,(1),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/Morphisms/Proper.lean#L105-L107,Q27041,,29.41.7,lemma,3.0,"['01W0', '01QL', '0ELP']","\n  Lemma 29.41.7. Suppose given a commutative diagram of schemes \n  \n  \\[  \\xymatrix{ X \\ar[rr] \\ar[rd] &  &  Y \\ar[ld] \\\\  &  S &  }  \\]\n\n   with $Y$ separated over $S$. \n  \n  \nIf $X \\to S$ is universally closed, then the morphism $X \\to Y$ is universally closed. \n\n\nIf $X$ is proper over $S$, then the morphism $X \\to Y$ is proper. \n\n\n\n   In particular, in both cases the image of $X$ in $Y$ is closed. \n\n    \n      Proof.\n      Assume that $X \\to S$ is universally closed (resp. proper). We factor the morphism as $X \\to X \\times _ S Y \\to Y$. The first morphism is a closed immersion, see Schemes, Lemma 26.21.10. Hence the first morphism is proper (Lemma 29.41.6). The projection $X \\times _ S Y \\to Y$ is the base change of a universally closed (resp. proper) morphism and hence universally closed (resp. proper), see Lemma 29.41.5. Thus $X \\to Y$ is universally closed (resp. proper) as the composition of universally closed (resp. proper) morphisms (Lemma 29.41.4). \n      $\\square$\n    \n","\n  Lemma 29.41.7. Suppose given a commutative diagram of schemes \n  \n  \\[  \\xymatrix{ X \\ar[rr] \\ar[rd] &  &  Y \\ar[ld] \\\\  &  S &  }  \\]\n\n   with $Y$ separated over $S$. \n  \n  \nIf $X \\to S$ is universally closed, then the morphism $X \\to Y$ is universally closed. \n\n\nIf $X$ is proper over $S$, then the morphism $X \\to Y$ is proper. \n\n\n\n   In particular, in both cases the image of $X$ in $Y$ is closed. \n\n    \n","Proof.\n      Assume that $X \\to S$ is universally closed (resp. proper). We factor the morphism as $X \\to X \\times _ S Y \\to Y$. The first morphism is a closed immersion, see Schemes, Lemma 26.21.10. Hence the first morphism is proper (Lemma 29.41.6). The projection $X \\times _ S Y \\to Y$ is the base change of a universally closed (resp. proper) morphism and hence universally closed (resp. proper), see Lemma 29.41.5. Thus $X \\to Y$ is universally closed (resp. proper) as the composition of universally closed (resp. proper) morphisms (Lemma 29.41.4). \n      $\\square$\n    \n","
  MorphismProperty.of_postcomp _ _ g â€¹_â€º â€¹_â€º
","lemma UniversallyClosed.of_comp_of_isSeparated [UniversallyClosed (f â‰« g)] [IsSeparated g] :
    UniversallyClosed f ","Proof.\n      Assume that $X \\to S$ is universally closed (resp. proper). We factor the morphism as $X \\to X \\times _ S Y \\to Y$. The first morphism is a closed immersion, see Schemes, Lemma 26.21.10 [[\n  Lemma 26.21.10. Let $g : X \\to Y$ be a morphism of schemes over $S$. The morphism $i : X \\to X \\times _ S Y$ is an immersion. If $Y$ is separated over $S$ it is a closed immersion. If $Y$ is quasi-separated over $S$ it is quasi-compact. \n\n    \n]]. Hence the first morphism is proper (Lemma 29.41.6 [[\n  Lemma 29.41.6. A closed immersion is proper, hence a fortiori universally closed. \n\n    \n]]). The projection $X \\times _ S Y \\to Y$ is the base change of a universally closed (resp. proper) morphism and hence universally closed (resp. proper), see Lemma 29.41.5 [[\n  Lemma 29.41.5. The base change of a proper morphism is proper. The same is true for universally closed morphisms. \n\n    \n]]. Thus $X \\to Y$ is universally closed (resp. proper) as the composition of universally closed (resp. proper) morphisms (Lemma 29.41.4 [[\n  Lemma 29.41.4. The composition of proper morphisms is proper. The same is true for universally closed morphisms. \n\n    \n]]). \n      $\\square$\n    \n"
54,01W6,"lemma IsProper.of_comp [IsProper (f â‰« g)] [IsSeparated g] : IsProper f :=
  MorphismProperty.of_postcomp _ _ g â€¹_â€º â€¹_â€º
",Formal Proof of Stacks Project Tag 01W6,(2),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/Morphisms/Proper.lean#L114-L115,Q27041,,29.41.7,lemma,3.0,"['01W0', '01QL', '0ELP']","\n  Lemma 29.41.7. Suppose given a commutative diagram of schemes \n  \n  \\[  \\xymatrix{ X \\ar[rr] \\ar[rd] &  &  Y \\ar[ld] \\\\  &  S &  }  \\]\n\n   with $Y$ separated over $S$. \n  \n  \nIf $X \\to S$ is universally closed, then the morphism $X \\to Y$ is universally closed. \n\n\nIf $X$ is proper over $S$, then the morphism $X \\to Y$ is proper. \n\n\n\n   In particular, in both cases the image of $X$ in $Y$ is closed. \n\n    \n      Proof.\n      Assume that $X \\to S$ is universally closed (resp. proper). We factor the morphism as $X \\to X \\times _ S Y \\to Y$. The first morphism is a closed immersion, see Schemes, Lemma 26.21.10. Hence the first morphism is proper (Lemma 29.41.6). The projection $X \\times _ S Y \\to Y$ is the base change of a universally closed (resp. proper) morphism and hence universally closed (resp. proper), see Lemma 29.41.5. Thus $X \\to Y$ is universally closed (resp. proper) as the composition of universally closed (resp. proper) morphisms (Lemma 29.41.4). \n      $\\square$\n    \n","\n  Lemma 29.41.7. Suppose given a commutative diagram of schemes \n  \n  \\[  \\xymatrix{ X \\ar[rr] \\ar[rd] &  &  Y \\ar[ld] \\\\  &  S &  }  \\]\n\n   with $Y$ separated over $S$. \n  \n  \nIf $X \\to S$ is universally closed, then the morphism $X \\to Y$ is universally closed. \n\n\nIf $X$ is proper over $S$, then the morphism $X \\to Y$ is proper. \n\n\n\n   In particular, in both cases the image of $X$ in $Y$ is closed. \n\n    \n","Proof.\n      Assume that $X \\to S$ is universally closed (resp. proper). We factor the morphism as $X \\to X \\times _ S Y \\to Y$. The first morphism is a closed immersion, see Schemes, Lemma 26.21.10. Hence the first morphism is proper (Lemma 29.41.6). The projection $X \\times _ S Y \\to Y$ is the base change of a universally closed (resp. proper) morphism and hence universally closed (resp. proper), see Lemma 29.41.5. Thus $X \\to Y$ is universally closed (resp. proper) as the composition of universally closed (resp. proper) morphisms (Lemma 29.41.4). \n      $\\square$\n    \n","
  MorphismProperty.of_postcomp _ _ g â€¹_â€º â€¹_â€º
",lemma IsProper.of_comp [IsProper (f â‰« g)] [IsSeparated g] : IsProper f ,"Proof.\n      Assume that $X \\to S$ is universally closed (resp. proper). We factor the morphism as $X \\to X \\times _ S Y \\to Y$. The first morphism is a closed immersion, see Schemes, Lemma 26.21.10 [[\n  Lemma 26.21.10. Let $g : X \\to Y$ be a morphism of schemes over $S$. The morphism $i : X \\to X \\times _ S Y$ is an immersion. If $Y$ is separated over $S$ it is a closed immersion. If $Y$ is quasi-separated over $S$ it is quasi-compact. \n\n    \n]]. Hence the first morphism is proper (Lemma 29.41.6 [[\n  Lemma 29.41.6. A closed immersion is proper, hence a fortiori universally closed. \n\n    \n]]). The projection $X \\times _ S Y \\to Y$ is the base change of a universally closed (resp. proper) morphism and hence universally closed (resp. proper), see Lemma 29.41.5 [[\n  Lemma 29.41.5. The base change of a proper morphism is proper. The same is true for universally closed morphisms. \n\n    \n]]. Thus $X \\to Y$ is universally closed (resp. proper) as the composition of universally closed (resp. proper) morphisms (Lemma 29.41.4 [[\n  Lemma 29.41.4. The composition of proper morphisms is proper. The same is true for universally closed morphisms. \n\n    \n]]). \n      $\\square$\n    \n"
55,01K9,"lemma isClosedMap_iff_specializingMap (f : X âŸ¶ Y) [QuasiCompact f] :
    IsClosedMap f â†” SpecializingMap f := by
  refine âŸ¨fun h â†¦ h.specializingMap, fun H â†¦ ?_âŸ©
  wlog hY : âˆƒ R, Y = Spec R
  Â· change topologically @IsClosedMap f
    rw [IsZariskiLocalAtTarget.iff_of_openCover (P := topologically @IsClosedMap) Y.affineCover]
    intro i
    have _ : QuasiCompact (Y.affineCover.pullbackHom f i) := MorphismProperty.pullback_snd _ _ â€¹_â€º
    refine this (Y.affineCover.pullbackHom f i) ?_ âŸ¨_, rflâŸ©
    exact IsZariskiLocalAtTarget.of_isPullback
      (P := topologically @SpecializingMap) (.of_hasPullback _ _) H
  obtain âŸ¨S, rflâŸ© := hY
  clear * - H
  intro Z hZ
  replace H := hZ.stableUnderSpecialization.image H
  wlog hX : âˆƒ R, X = Spec R
  Â· obtain âŸ¨R, g, hgâŸ© := compactSpace_iff_exists.mp (QuasiCompact.compactSpace_of_compactSpace f)
    have inst : QuasiCompact (g â‰« f) := HasAffineProperty.iff_of_isAffine.mpr (by infer_instance)
    have := this _ (g â‰« f) (g â»Â¹' Z) (hZ.preimage g.continuous)
    simp_rw [Scheme.Hom.comp_base, TopCat.comp_app, â† Set.image_image,
      Set.image_preimage_eq _ hg] at this
    exact this H âŸ¨_, rflâŸ©
  obtain âŸ¨R, rflâŸ© := hX
  obtain âŸ¨Ï†, rflâŸ© := Spec.homEquiv.symm.surjective f
  exact PrimeSpectrum.isClosed_image_of_stableUnderSpecialization Ï†.hom Z hZ H
",Formal Proof of Stacks Project Tag 01K9,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/Morphisms/QuasiCompact.lean#L225-L249,Q27041,,26.19.8,lemma,3.0,"['01K2', '01H8', '0ELP']","\n  Lemma 26.19.8. Let $f : X \\to S$ be a quasi-compact morphism of schemes. Then $f$ is closed if and only if specializations lift along $f$, see Topology, Definition 5.19.4. \n\n    \n      Proof.\n      According to Topology, Lemma 5.19.7 if $f$ is closed then specializations lift along $f$. Conversely, suppose that specializations lift along $f$. Let $Z \\subset X$ be a closed subset. We may think of $Z$ as a scheme with the reduced induced scheme structure, see Definition 26.12.5. Since $Z \\subset X$ is closed the restriction of $f$ to $Z$ is still quasi-compact. Moreover specializations lift along $Z \\to S$ as well, see Topology, Lemma 5.19.5. Hence it suffices to prove $f(X)$ is closed if specializations lift along $f$. In particular $f(X)$ is stable under specializations, see Topology, Lemma 5.19.6. Thus $f(X)$ is closed by Lemma 26.19.7. \n      $\\square$\n    \n","\n  Lemma 26.19.8. Let $f : X \\to S$ be a quasi-compact morphism of schemes. Then $f$ is closed if and only if specializations lift along $f$, see Topology, Definition 5.19.4. \n\n    \n","Proof.\n      According to Topology, Lemma 5.19.7 if $f$ is closed then specializations lift along $f$. Conversely, suppose that specializations lift along $f$. Let $Z \\subset X$ be a closed subset. We may think of $Z$ as a scheme with the reduced induced scheme structure, see Definition 26.12.5. Since $Z \\subset X$ is closed the restriction of $f$ to $Z$ is still quasi-compact. Moreover specializations lift along $Z \\to S$ as well, see Topology, Lemma 5.19.5. Hence it suffices to prove $f(X)$ is closed if specializations lift along $f$. In particular $f(X)$ is stable under specializations, see Topology, Lemma 5.19.6. Thus $f(X)$ is closed by Lemma 26.19.7. \n      $\\square$\n    \n"," by
  refine âŸ¨fun h â†¦ h.specializingMap, fun H â†¦ ?_âŸ©
  wlog hY : âˆƒ R, Y = Spec R
  Â· change topologically @IsClosedMap f
    rw [IsZariskiLocalAtTarget.iff_of_openCover (P := topologically @IsClosedMap) Y.affineCover]
    intro i
    have _ : QuasiCompact (Y.affineCover.pullbackHom f i) := MorphismProperty.pullback_snd _ _ â€¹_â€º
    refine this (Y.affineCover.pullbackHom f i) ?_ âŸ¨_, rflâŸ©
    exact IsZariskiLocalAtTarget.of_isPullback
      (P := topologically @SpecializingMap) (.of_hasPullback _ _) H
  obtain âŸ¨S, rflâŸ© := hY
  clear * - H
  intro Z hZ
  replace H := hZ.stableUnderSpecialization.image H
  wlog hX : âˆƒ R, X = Spec R
  Â· obtain âŸ¨R, g, hgâŸ© := compactSpace_iff_exists.mp (QuasiCompact.compactSpace_of_compactSpace f)
    have inst : QuasiCompact (g â‰« f) := HasAffineProperty.iff_of_isAffine.mpr (by infer_instance)
    have := this _ (g â‰« f) (g â»Â¹' Z) (hZ.preimage g.continuous)
    simp_rw [Scheme.Hom.comp_base, TopCat.comp_app, â† Set.image_image,
      Set.image_preimage_eq _ hg] at this
    exact this H âŸ¨_, rflâŸ©
  obtain âŸ¨R, rflâŸ© := hX
  obtain âŸ¨Ï†, rflâŸ© := Spec.homEquiv.symm.surjective f
  exact PrimeSpectrum.isClosed_image_of_stableUnderSpecialization Ï†.hom Z hZ H
","lemma isClosedMap_iff_specializingMap (f : X âŸ¶ Y) [QuasiCompact f] :
    IsClosedMap f â†” SpecializingMap f ","Proof.\n      According to Topology, Lemma 5.19.7 [[\n  Lemma 5.19.7. Let $f : X \\to Y$ be a continuous map of topological spaces. \n  \n  \nIf $f$ is closed then specializations lift along $f$. \n\n\nIf $f$ is open, $X$ is a Noetherian topological space, each irreducible closed subset of $X$ has a generic point, and $Y$ is Kolmogorov then generalizations lift along $f$. \n\n\n\n\n    \n]] if $f$ is closed then specializations lift along $f$. Conversely, suppose that specializations lift along $f$. Let $Z \\subset X$ be a closed subset. We may think of $Z$ as a scheme with the reduced induced scheme structure, see Definition 26.12.5 [[\n  Definition 26.12.5. Let $X$ be a scheme. Let $Z \\subset X$ be a closed subset. A scheme structure on $Z$ is given by a closed subscheme $Z\'$ of $X$ whose underlying set is equal to $Z$. We often say \xe2\x80\x9clet $(Z, \\mathcal{O}_ Z)$ be a scheme structure on $Z$\xe2\x80\x9d to indicate this. The reduced induced scheme structure on $Z$ is the one constructed in Lemma 26.12.4. The reduction $X_{red}$ of $X$ is the reduced induced scheme structure on $X$ itself. \n]]. Since $Z \\subset X$ is closed the restriction of $f$ to $Z$ is still quasi-compact. Moreover specializations lift along $Z \\to S$ as well, see Topology, Lemma 5.19.5 [[\n  Lemma 5.19.5. Suppose $f : X \\to Y$ and $g : Y \\to Z$ are continuous maps of topological spaces. If specializations lift along both $f$ and $g$ then specializations lift along $g \\circ f$. Similarly for \xe2\x80\x9cgeneralizations lift along\xe2\x80\x9d. \n\n    \n]]. Hence it suffices to prove $f(X)$ is closed if specializations lift along $f$. In particular $f(X)$ is stable under specializations, see Topology, Lemma 5.19.6 [[\n  Lemma 5.19.6. Let $f : X \\to Y$ be a continuous map of topological spaces. \n  \n  \nIf specializations lift along $f$, and if $T \\subset X$ is stable under specialization, then $f(T) \\subset Y$ is stable under specialization. \n\n\nIf generalizations lift along $f$, and if $T \\subset X$ is stable under generalization, then $f(T) \\subset Y$ is stable under generalization. \n\n\n\n\n    \n]]. Thus $f(X)$ is closed by Lemma 26.19.7 [[\n  Lemma 26.19.7. Let $f : X \\to S$ be a quasi-compact morphism of schemes. The following are equivalent \n  \n  \n$f(X) \\subset S$ is closed, and \n\n\n$f(X) \\subset S$ is stable under specialization. \n\n\n\n\n    \n]]. \n      $\\square$\n    \n"
56,0DVA,"lemma isSeparated_of_injective (hf : Function.Injective f) :
    IsSeparated f := by
  constructor
  let ð’° := Y.affineCover
  let ð’± (i) := (pullback f (ð’°.f i)).affineCover
  refine IsZariskiLocalAtTarget.of_iSup_eq_top (fun i : PUnit.{0} â†¦ âŠ¤) (by simp) fun _ â†¦ ?_
  rw [â† diagonalCoverDiagonalRange_eq_top_of_injective f ð’° ð’± hf]
  exact isClosedImmersion_diagonal_restrict_diagonalCoverDiagonalRange f ð’° ð’±
",Formal Proof of Stacks Project Tag 0DVA,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/Morphisms/Separated.lean#L214-L221,Q27041,,26.23.6,lemma,3.0,"['01L1', '01H8', '0ELP']","\n  Lemma 26.23.6. Let $j : X \\to Y$ be a morphism of schemes. If $j$ is injective on points, then $j$ is separated. \n\n    \n      Proof.\n      Let $z$ be a point of $X \\times _ Y X$. Then $x = \\text{pr}_1(z)$ and $\\text{pr}_2(z)$ are the same because $j$ maps these points to the same point $y$ of $Y$. Then we can choose an affine open neighbourhood $V \\subset Y$ of $y$ and an affine open neighbourhood $U \\subset X$ of $x$ with $j(U) \\subset V$. Then $z \\in U \\times _ V U \\subset X \\times _ Y X$. Hence $X \\times _ Y X$ is the union of the affine opens $U \\times _ V U$. Since $\\Delta _{X/Y}^{-1}(U \\times _ V U) = U$ and since $U \\to U \\times _ V U$ is a closed immersion, we conclude that $\\Delta _{X/Y}$ is a closed immersion (see argument in the proof of Lemma 26.21.2). \n      $\\square$\n    \n","\n  Lemma 26.23.6. Let $j : X \\to Y$ be a morphism of schemes. If $j$ is injective on points, then $j$ is separated. \n\n    \n","Proof.\n      Let $z$ be a point of $X \\times _ Y X$. Then $x = \\text{pr}_1(z)$ and $\\text{pr}_2(z)$ are the same because $j$ maps these points to the same point $y$ of $Y$. Then we can choose an affine open neighbourhood $V \\subset Y$ of $y$ and an affine open neighbourhood $U \\subset X$ of $x$ with $j(U) \\subset V$. Then $z \\in U \\times _ V U \\subset X \\times _ Y X$. Hence $X \\times _ Y X$ is the union of the affine opens $U \\times _ V U$. Since $\\Delta _{X/Y}^{-1}(U \\times _ V U) = U$ and since $U \\to U \\times _ V U$ is a closed immersion, we conclude that $\\Delta _{X/Y}$ is a closed immersion (see argument in the proof of Lemma 26.21.2). \n      $\\square$\n    \n"," by
  constructor
  let ð’° := Y.affineCover
  let ð’± (i) := (pullback f (ð’°.f i)).affineCover
  refine IsZariskiLocalAtTarget.of_iSup_eq_top (fun i : PUnit.{0} â†¦ âŠ¤) (by simp) fun _ â†¦ ?_
  rw [â† diagonalCoverDiagonalRange_eq_top_of_injective f ð’° ð’± hf]
  exact isClosedImmersion_diagonal_restrict_diagonalCoverDiagonalRange f ð’° ð’±
","lemma isSeparated_of_injective (hf : Function.Injective f) :
    IsSeparated f ","Proof.\n      Let $z$ be a point of $X \\times _ Y X$. Then $x = \\text{pr}_1(z)$ and $\\text{pr}_2(z)$ are the same because $j$ maps these points to the same point $y$ of $Y$. Then we can choose an affine open neighbourhood $V \\subset Y$ of $y$ and an affine open neighbourhood $U \\subset X$ of $x$ with $j(U) \\subset V$. Then $z \\in U \\times _ V U \\subset X \\times _ Y X$. Hence $X \\times _ Y X$ is the union of the affine opens $U \\times _ V U$. Since $\\Delta _{X/Y}^{-1}(U \\times _ V U) = U$ and since $U \\to U \\times _ V U$ is a closed immersion, we conclude that $\\Delta _{X/Y}$ is a closed immersion (see argument in the proof of Lemma 26.21.2 [[\n       \n      \n  Lemma 26.21.2. Let $X$ be a scheme over $S$. The diagonal morphism $\\Delta _{X/S}$ is an immersion. \n\n    \n]]). \n      $\\square$\n    \n"
57,01KM,"instance isClosedImmersion_equalizer_Î¹_left {S : Scheme} {X Y : Over S} [IsSeparated Y.hom]
    (f g : X âŸ¶ Y) : IsClosedImmersion (equalizer.Î¹ f g).left := by
  refine MorphismProperty.of_isPullback
    ((Limits.isPullback_equalizer_prod f g).map (Over.forget _)).flip ?_
  rw [â† MorphismProperty.cancel_right_of_respectsIso @IsClosedImmersion _
    (Over.prodLeftIsoPullback Y Y).hom]
  convert (inferInstanceAs (IsClosedImmersion (pullback.diagonal Y.hom)))
  ext1 <;> simp [â† Over.comp_left]
",Formal Proof of Stacks Project Tag 01KM,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/Morphisms/Separated.lean#L267-L274,Q27041,,26.21.5,lemma,3.0,"['01KH', '01H8', '0ELP']","\n  Lemma 26.21.5. Let $X$, $Y$ be schemes over $S$. Let $a, b : X \\to Y$ be morphisms of schemes over $S$. There exists a largest locally closed subscheme $Z \\subset X$ such that $a|_ Z = b|_ Z$. In fact $Z$ is the equalizer of $(a, b)$. Moreover, if $Y$ is separated over $S$, then $Z$ is a closed subscheme. \n\n    \n      Proof.\n      The equalizer of $(a, b)$ is for categorical reasons the fibre product $Z$ in the following diagram \n    \n      \n  \\[  \\xymatrix{ Z = Y \\times _{(Y \\times _ S Y)} X \\ar[r] \\ar[d] &  X \\ar[d]^{(a , b)} \\\\  Y \\ar[r]^-{\\Delta _{Y/S}} &  Y \\times _ S Y }  \\]\n\n    \n       Thus the lemma follows from Lemmas 26.18.2, 26.21.2 and Definition 26.21.3. \n      $\\square$\n    \n","\n  Lemma 26.21.5. Let $X$, $Y$ be schemes over $S$. Let $a, b : X \\to Y$ be morphisms of schemes over $S$. There exists a largest locally closed subscheme $Z \\subset X$ such that $a|_ Z = b|_ Z$. In fact $Z$ is the equalizer of $(a, b)$. Moreover, if $Y$ is separated over $S$, then $Z$ is a closed subscheme. \n\n    \n","Proof.\n      The equalizer of $(a, b)$ is for categorical reasons the fibre product $Z$ in the following diagram \n    \n      \n  \\[  \\xymatrix{ Z = Y \\times _{(Y \\times _ S Y)} X \\ar[r] \\ar[d] &  X \\ar[d]^{(a , b)} \\\\  Y \\ar[r]^-{\\Delta _{Y/S}} &  Y \\times _ S Y }  \\]\n\n    \n       Thus the lemma follows from Lemmas 26.18.2, 26.21.2 and Definition 26.21.3. \n      $\\square$\n    \n"," by
  refine MorphismProperty.of_isPullback
    ((Limits.isPullback_equalizer_prod f g).map (Over.forget _)).flip ?_
  rw [â† MorphismProperty.cancel_right_of_respectsIso @IsClosedImmersion _
    (Over.prodLeftIsoPullback Y Y).hom]
  convert (inferInstanceAs (IsClosedImmersion (pullback.diagonal Y.hom)))
  ext1 <;> simp [â† Over.comp_left]
","instance isClosedImmersion_equalizer_Î¹_left {S : Scheme} {X Y : Over S} [IsSeparated Y.hom]
    (f g : X âŸ¶ Y) : IsClosedImmersion (equalizer.Î¹ f g).left ","Proof.\n      The equalizer of $(a, b)$ is for categorical reasons the fibre product $Z$ in the following diagram \n    \n      \n  \\[  \\xymatrix{ Z = Y \\times _{(Y \\times _ S Y)} X \\ar[r] \\ar[d] &  X \\ar[d]^{(a , b)} \\\\  Y \\ar[r]^-{\\Delta _{Y/S}} &  Y \\times _ S Y }  \\]\n\n    \n       Thus the lemma follows from Lemmas 26.18.2 [[\n  Lemma 26.18.2. Let $S$ be a scheme. Let $f : X \\to Y$ be an immersion (resp. closed immersion, resp. open immersion) of schemes over $S$. Then any base change of $f$ is an immersion (resp. closed immersion, resp. open immersion). \n\n    \n]], 26.21.2 [[\n       \n      \n  Lemma 26.21.2. Let $X$ be a scheme over $S$. The diagonal morphism $\\Delta _{X/S}$ is an immersion. \n\n    \n]] and Definition 26.21.3 [[\n  Definition 26.21.3. Let $f : X \\to S$ be a morphism of schemes. \n  \n  \nWe say $f$ is separated if the diagonal morphism $\\Delta _{X/S}$ is a closed immersion. \n\n\nWe say $f$ is quasi-separated if the diagonal morphism $\\Delta _{X/S}$ is a quasi-compact morphism. \n\n\nWe say a scheme $Y$ is separated if the morphism $Y \\to \\mathop{\\mathrm{Spec}}(\\mathbf{Z})$ is separated. \n\n\nWe say a scheme $Y$ is quasi-separated if the morphism $Y \\to \\mathop{\\mathrm{Spec}}(\\mathbf{Z})$ is quasi-separated. \n\n\n\n]]. \n      $\\square$\n    \n"
58,04XU,"lemma Scheme.Hom.isProperMap (f : X âŸ¶ Y) [UniversallyClosed f] : IsProperMap f := by
  rw [isProperMap_iff_isClosedMap_and_compact_fibers]
  refine âŸ¨f.continuous, f.isClosedMap, fun y â†¦ ?_âŸ©
  have := compactSpace_of_universallyClosed (pullback.snd f (Y.fromSpecResidueField y))
  rw [â† Scheme.range_fromSpecResidueField, â† Scheme.Pullback.range_fst]
  exact isCompact_range (Scheme.Hom.continuous _)
",Formal Proof of Stacks Project Tag 04XU,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/Morphisms/UniversallyClosed.lean#L156-L161,Q27041,,29.41.8,lemma,3.0,"['01W0', '01QL', '0ELP']","\n       \n      \n  Lemma 29.41.8. A universally closed morphism of schemes is quasi-compact. \n\n    \n      Proof.\n      Let $f : X \\to S$ be a morphism. Assume that $f$ is not quasi-compact. Our goal is to show that $f$ is not universally closed. By Schemes, Lemma 26.19.2 there exists an affine open $V \\subset S$ such that $f^{-1}(V)$ is not quasi-compact. To achieve our goal it suffices to show that $f^{-1}(V) \\to V$ is not universally closed, hence we may assume that $S = \\mathop{\\mathrm{Spec}}(A)$ for some ring $A$. \n    \n      Write $X = \\bigcup _{i \\in I} X_ i$ where the $X_ i$ are affine open subschemes of $X$. Let $T = \\mathop{\\mathrm{Spec}}(A[y_ i ; i \\in I])$. Let $T_ i = D(y_ i) \\subset T$. Let $Z$ be the closed set $(X \\times _ S T) - \\bigcup _{i \\in I} (X_ i \\times _ S T_ i)$. It suffices to prove that the image $f_ T(Z)$ of $Z$ under $f_ T : X \\times _ S T \\to T$ is not closed. \n    \n      There exists a point $s \\in S$ such that there is no neighborhood $U$ of $s$ in $S$ such that $X_ U$ is quasi-compact. Otherwise we could cover $S$ with finitely many such $U$ and Schemes, Lemma 26.19.2 would imply $f$ quasi-compact. Fix such an $s \\in S$. \n    \n      First we check that $f_ T(Z_ s) \\ne T_ s$. Let $t \\in T$ be the point lying over $s$ with $\\kappa (t) = \\kappa (s)$ such that $y_ i = 1$ in $\\kappa (t)$ for all $i$. Then $t \\in T_ i$ for all $i$, and the fiber of $Z_ s \\to T_ s$ above $t$ is isomorphic to $(X - \\bigcup _{i \\in I} X_ i)_ s$, which is empty. Thus $t \\in T_ s - f_ T(Z_ s)$. \n    \n      Assume $f_ T(Z)$ is closed in $T$. Then there exists an element $g \\in A[y_ i; i \\in I]$ with $f_ T(Z) \\subset V(g)$ but $t \\not\\in V(g)$. Hence the image of $g$ in $\\kappa (t)$ is nonzero. In particular some coefficient of $g$ has nonzero image in $\\kappa (s)$. Hence this coefficient is invertible on some neighborhood $U$ of $s$. Let $J$ be the finite set of $j \\in I$ such that $y_ j$ appears in $g$. Since $X_ U$ is not quasi-compact, we may choose a point $x \\in X - \\bigcup _{j \\in J} X_ j$ lying above some $u \\in U$. Since $g$ has a coefficient that is invertible on $U$, we can find a point $t\' \\in T$ lying above $u$ such that $t\' \\not\\in V(g)$ and $t\' \\in V(y_ i)$ for all $i \\notin J$. This is true because $V(y_ i; i \\in I, i \\not\\in J) = \\mathop{\\mathrm{Spec}}(A[t_ j; j\\in J])$ and the set of points of this scheme lying over $u$ is bijective with $\\mathop{\\mathrm{Spec}}(\\kappa (u)[t_ j; j \\in J])$. In other words $t\' \\notin T_ i$ for each $i \\notin J$. By Schemes, Lemma 26.17.5 we can find a point $z$ of $X \\times _ S T$ mapping to $x \\in X$ and to $t\' \\in T$. Since $x \\not\\in X_ j$ for $j \\in J$ and $t\' \\not\\in T_ i$ for $i \\in I \\setminus J$ we see that $z \\in Z$. On the other hand $f_ T(z) = t\' \\not\\in V(g)$ which contradicts $f_ T(Z) \\subset V(g)$. Thus the assumption \xe2\x80\x9c$f_ T(Z)$ closed\xe2\x80\x9d is wrong and we conclude indeed that $f_ T$ is not closed, as desired. \n      $\\square$\n    \n",\n       \n      \n  Lemma 29.41.8. A universally closed morphism of schemes is quasi-compact. \n\n    \n,"Proof.\n      Let $f : X \\to S$ be a morphism. Assume that $f$ is not quasi-compact. Our goal is to show that $f$ is not universally closed. By Schemes, Lemma 26.19.2 there exists an affine open $V \\subset S$ such that $f^{-1}(V)$ is not quasi-compact. To achieve our goal it suffices to show that $f^{-1}(V) \\to V$ is not universally closed, hence we may assume that $S = \\mathop{\\mathrm{Spec}}(A)$ for some ring $A$. \n    \n      Write $X = \\bigcup _{i \\in I} X_ i$ where the $X_ i$ are affine open subschemes of $X$. Let $T = \\mathop{\\mathrm{Spec}}(A[y_ i ; i \\in I])$. Let $T_ i = D(y_ i) \\subset T$. Let $Z$ be the closed set $(X \\times _ S T) - \\bigcup _{i \\in I} (X_ i \\times _ S T_ i)$. It suffices to prove that the image $f_ T(Z)$ of $Z$ under $f_ T : X \\times _ S T \\to T$ is not closed. \n    \n      There exists a point $s \\in S$ such that there is no neighborhood $U$ of $s$ in $S$ such that $X_ U$ is quasi-compact. Otherwise we could cover $S$ with finitely many such $U$ and Schemes, Lemma 26.19.2 would imply $f$ quasi-compact. Fix such an $s \\in S$. \n    \n      First we check that $f_ T(Z_ s) \\ne T_ s$. Let $t \\in T$ be the point lying over $s$ with $\\kappa (t) = \\kappa (s)$ such that $y_ i = 1$ in $\\kappa (t)$ for all $i$. Then $t \\in T_ i$ for all $i$, and the fiber of $Z_ s \\to T_ s$ above $t$ is isomorphic to $(X - \\bigcup _{i \\in I} X_ i)_ s$, which is empty. Thus $t \\in T_ s - f_ T(Z_ s)$. \n    \n      Assume $f_ T(Z)$ is closed in $T$. Then there exists an element $g \\in A[y_ i; i \\in I]$ with $f_ T(Z) \\subset V(g)$ but $t \\not\\in V(g)$. Hence the image of $g$ in $\\kappa (t)$ is nonzero. In particular some coefficient of $g$ has nonzero image in $\\kappa (s)$. Hence this coefficient is invertible on some neighborhood $U$ of $s$. Let $J$ be the finite set of $j \\in I$ such that $y_ j$ appears in $g$. Since $X_ U$ is not quasi-compact, we may choose a point $x \\in X - \\bigcup _{j \\in J} X_ j$ lying above some $u \\in U$. Since $g$ has a coefficient that is invertible on $U$, we can find a point $t\' \\in T$ lying above $u$ such that $t\' \\not\\in V(g)$ and $t\' \\in V(y_ i)$ for all $i \\notin J$. This is true because $V(y_ i; i \\in I, i \\not\\in J) = \\mathop{\\mathrm{Spec}}(A[t_ j; j\\in J])$ and the set of points of this scheme lying over $u$ is bijective with $\\mathop{\\mathrm{Spec}}(\\kappa (u)[t_ j; j \\in J])$. In other words $t\' \\notin T_ i$ for each $i \\notin J$. By Schemes, Lemma 26.17.5 we can find a point $z$ of $X \\times _ S T$ mapping to $x \\in X$ and to $t\' \\in T$. Since $x \\not\\in X_ j$ for $j \\in J$ and $t\' \\not\\in T_ i$ for $i \\in I \\setminus J$ we see that $z \\in Z$. On the other hand $f_ T(z) = t\' \\not\\in V(g)$ which contradicts $f_ T(Z) \\subset V(g)$. Thus the assumption \xe2\x80\x9c$f_ T(Z)$ closed\xe2\x80\x9d is wrong and we conclude indeed that $f_ T$ is not closed, as desired. \n      $\\square$\n    \n"," by
  rw [isProperMap_iff_isClosedMap_and_compact_fibers]
  refine âŸ¨f.continuous, f.isClosedMap, fun y â†¦ ?_âŸ©
  have := compactSpace_of_universallyClosed (pullback.snd f (Y.fromSpecResidueField y))
  rw [â† Scheme.range_fromSpecResidueField, â† Scheme.Pullback.range_fst]
  exact isCompact_range (Scheme.Hom.continuous _)
",lemma Scheme.Hom.isProperMap (f : X âŸ¶ Y) [UniversallyClosed f] : IsProperMap f ,"Proof.\n      Let $f : X \\to S$ be a morphism. Assume that $f$ is not quasi-compact. Our goal is to show that $f$ is not universally closed. By Schemes, Lemma 26.19.2 [[\n  Lemma 26.19.2. Let $f : X \\to S$ be a morphism of schemes. The following are equivalent \n  \n  \n$f : X \\to S$ is quasi-compact, \n\n\nthe inverse image of every affine open is quasi-compact, and \n\n\nthere exists some affine open covering $S = \\bigcup _{i \\in I} U_ i$ such that $f^{-1}(U_ i)$ is quasi-compact for all $i$. \n\n\n\n\n    \n]] there exists an affine open $V \\subset S$ such that $f^{-1}(V)$ is not quasi-compact. To achieve our goal it suffices to show that $f^{-1}(V) \\to V$ is not universally closed, hence we may assume that $S = \\mathop{\\mathrm{Spec}}(A)$ for some ring $A$. \n    \n      Write $X = \\bigcup _{i \\in I} X_ i$ where the $X_ i$ are affine open subschemes of $X$. Let $T = \\mathop{\\mathrm{Spec}}(A[y_ i ; i \\in I])$. Let $T_ i = D(y_ i) \\subset T$. Let $Z$ be the closed set $(X \\times _ S T) - \\bigcup _{i \\in I} (X_ i \\times _ S T_ i)$. It suffices to prove that the image $f_ T(Z)$ of $Z$ under $f_ T : X \\times _ S T \\to T$ is not closed. \n    \n      There exists a point $s \\in S$ such that there is no neighborhood $U$ of $s$ in $S$ such that $X_ U$ is quasi-compact. Otherwise we could cover $S$ with finitely many such $U$ and Schemes, Lemma 26.19.2 [[\n  Lemma 26.19.2. Let $f : X \\to S$ be a morphism of schemes. The following are equivalent \n  \n  \n$f : X \\to S$ is quasi-compact, \n\n\nthe inverse image of every affine open is quasi-compact, and \n\n\nthere exists some affine open covering $S = \\bigcup _{i \\in I} U_ i$ such that $f^{-1}(U_ i)$ is quasi-compact for all $i$. \n\n\n\n\n    \n]] would imply $f$ quasi-compact. Fix such an $s \\in S$. \n    \n      First we check that $f_ T(Z_ s) \\ne T_ s$. Let $t \\in T$ be the point lying over $s$ with $\\kappa (t) = \\kappa (s)$ such that $y_ i = 1$ in $\\kappa (t)$ for all $i$. Then $t \\in T_ i$ for all $i$, and the fiber of $Z_ s \\to T_ s$ above $t$ is isomorphic to $(X - \\bigcup _{i \\in I} X_ i)_ s$, which is empty. Thus $t \\in T_ s - f_ T(Z_ s)$. \n    \n      Assume $f_ T(Z)$ is closed in $T$. Then there exists an element $g \\in A[y_ i; i \\in I]$ with $f_ T(Z) \\subset V(g)$ but $t \\not\\in V(g)$. Hence the image of $g$ in $\\kappa (t)$ is nonzero. In particular some coefficient of $g$ has nonzero image in $\\kappa (s)$. Hence this coefficient is invertible on some neighborhood $U$ of $s$. Let $J$ be the finite set of $j \\in I$ such that $y_ j$ appears in $g$. Since $X_ U$ is not quasi-compact, we may choose a point $x \\in X - \\bigcup _{j \\in J} X_ j$ lying above some $u \\in U$. Since $g$ has a coefficient that is invertible on $U$, we can find a point $t\' \\in T$ lying above $u$ such that $t\' \\not\\in V(g)$ and $t\' \\in V(y_ i)$ for all $i \\notin J$. This is true because $V(y_ i; i \\in I, i \\not\\in J) = \\mathop{\\mathrm{Spec}}(A[t_ j; j\\in J])$ and the set of points of this scheme lying over $u$ is bijective with $\\mathop{\\mathrm{Spec}}(\\kappa (u)[t_ j; j \\in J])$. In other words $t\' \\notin T_ i$ for each $i \\notin J$. By Schemes, Lemma 26.17.5 [[\n  Lemma 26.17.5. Let $f : X \\to S$ and $g : Y \\to S$ be morphisms of schemes with the same target. Points $z$ of $X \\times _ S Y$ are in bijective correspondence to quadruples \n  \n  \\[  (x, y, s, \\mathfrak p)  \\]\n\n   where $x \\in X$, $y \\in Y$, $s \\in S$ are points with $f(x) = s$, $g(y) = s$ and $\\mathfrak p$ is a prime ideal of the ring $\\kappa (x) \\otimes _{\\kappa (s)} \\kappa (y)$. The residue field of $z$ corresponds to the residue field of the prime $\\mathfrak p$. \n\n    \n]] we can find a point $z$ of $X \\times _ S T$ mapping to $x \\in X$ and to $t\' \\in T$. Since $x \\not\\in X_ j$ for $j \\in J$ and $t\' \\not\\in T_ i$ for $i \\in I \\setminus J$ we see that $z \\in Z$. On the other hand $f_ T(z) = t\' \\not\\in V(g)$ which contradicts $f_ T(Z) \\subset V(g)$. Thus the assumption \xe2\x80\x9c$f_ T(Z)$ closed\xe2\x80\x9d is wrong and we conclude indeed that $f_ T$ is not closed, as desired. \n      $\\square$\n    \n"
59,01U1,"lemma isOpenMap_of_generalizingMap [LocallyOfFinitePresentation f]
    (hf : GeneralizingMap f) : IsOpenMap f := by
  change topologically IsOpenMap f
  wlog hY : âˆƒ R, Y = Spec R
  Â· rw [IsZariskiLocalAtTarget.iff_of_openCover (P := topologically IsOpenMap) Y.affineCover]
    intro i
    dsimp only [Scheme.Cover.pullbackHom]
    refine this _ ?_ âŸ¨_, rflâŸ©
    exact IsZariskiLocalAtTarget.of_isPullback (P := topologically GeneralizingMap)
      (iY := Y.affineCover.f i) (IsPullback.of_hasPullback ..) hf
  obtain âŸ¨R, rflâŸ© := hY
  wlog hX : âˆƒ S, X = Spec S
  Â· rw [IsZariskiLocalAtSource.iff_of_openCover (P := topologically IsOpenMap) X.affineCover]
    intro i
    refine this f _ _ ?_ âŸ¨_, rflâŸ©
    exact IsZariskiLocalAtSource.comp (P := topologically GeneralizingMap) hf _
  obtain âŸ¨S, rflâŸ© := hX
  obtain âŸ¨Ï†, rflâŸ© := Spec.map_surjective f
  algebraize [Ï†.hom]
  convert PrimeSpectrum.isOpenMap_comap_of_hasGoingDown_of_finitePresentation
  Â· rwa [Algebra.HasGoingDown.iff_generalizingMap_primeSpectrumComap]
  Â· apply (HasRingHomProperty.Spec_iff (P := @LocallyOfFinitePresentation)).mp inferInstance
",Formal Proof of Stacks Project Tag 01U1,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/Morphisms/UniversallyOpen.lean#L107-L128,Q27041,,29.23.2,lemma,3.0,"['01TZ', '01QL', '0ELP']","\n  Lemma 29.23.2. Let $f : X \\to S$ be a morphism. \n  \n  \nIf $f$ is locally of finite presentation and generalizations lift along $f$, then $f$ is open. \n\n\nIf $f$ is locally of finite presentation and generalizations lift along every base change of $f$, then $f$ is universally open. \n\n\n\n\n    \n      Proof.\n      It suffices to prove the first assertion. This reduces to the case where both $X$ and $S$ are affine. In this case the result follows from Algebra, Lemma 10.41.3 and Proposition 10.41.8. \n      $\\square$\n    \n","\n  Lemma 29.23.2. Let $f : X \\to S$ be a morphism. \n  \n  \nIf $f$ is locally of finite presentation and generalizations lift along $f$, then $f$ is open. \n\n\nIf $f$ is locally of finite presentation and generalizations lift along every base change of $f$, then $f$ is universally open. \n\n\n\n\n    \n","Proof.\n      It suffices to prove the first assertion. This reduces to the case where both $X$ and $S$ are affine. In this case the result follows from Algebra, Lemma 10.41.3 and Proposition 10.41.8. \n      $\\square$\n    \n"," by
  change topologically IsOpenMap f
  wlog hY : âˆƒ R, Y = Spec R
  Â· rw [IsZariskiLocalAtTarget.iff_of_openCover (P := topologically IsOpenMap) Y.affineCover]
    intro i
    dsimp only [Scheme.Cover.pullbackHom]
    refine this _ ?_ âŸ¨_, rflâŸ©
    exact IsZariskiLocalAtTarget.of_isPullback (P := topologically GeneralizingMap)
      (iY := Y.affineCover.f i) (IsPullback.of_hasPullback ..) hf
  obtain âŸ¨R, rflâŸ© := hY
  wlog hX : âˆƒ S, X = Spec S
  Â· rw [IsZariskiLocalAtSource.iff_of_openCover (P := topologically IsOpenMap) X.affineCover]
    intro i
    refine this f _ _ ?_ âŸ¨_, rflâŸ©
    exact IsZariskiLocalAtSource.comp (P := topologically GeneralizingMap) hf _
  obtain âŸ¨S, rflâŸ© := hX
  obtain âŸ¨Ï†, rflâŸ© := Spec.map_surjective f
  algebraize [Ï†.hom]
  convert PrimeSpectrum.isOpenMap_comap_of_hasGoingDown_of_finitePresentation
  Â· rwa [Algebra.HasGoingDown.iff_generalizingMap_primeSpectrumComap]
  Â· apply (HasRingHomProperty.Spec_iff (P := @LocallyOfFinitePresentation)).mp inferInstance
","lemma isOpenMap_of_generalizingMap [LocallyOfFinitePresentation f]
    (hf : GeneralizingMap f) : IsOpenMap f ","Proof.\n      It suffices to prove the first assertion. This reduces to the case where both $X$ and $S$ are affine. In this case the result follows from Algebra, Lemma 10.41.3 [[\n  Lemma 10.41.3. Let $R \\to S$ be a ring map. \n  \n  \n$R \\to S$ satisfies going down if and only if generalizations lift along the map $\\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R)$, see Topology, Definition 5.19.4. \n\n\n$R \\to S$ satisfies going up if and only if specializations lift along the map $\\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R)$, see Topology, Definition 5.19.4. \n\n\n\n\n    \n]] and Proposition 10.41.8 [[\n  Proposition 10.41.8. Let $R \\to S$ be flat and of finite presentation. Then $\\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R)$ is open. More generally this holds for any ring map $R \\to S$ of finite presentation which satisfies going down. \n\n    \n]]. \n      $\\square$\n    \n"
60,01UA,"instance (priority := low) UniversallyOpen.of_flat [Flat f] [LocallyOfFinitePresentation f] :
    UniversallyOpen f :=
  âŸ¨universally_mk' _ _ fun _ _ â†¦ isOpenMap_of_generalizingMap _ (Flat.generalizingMap _)âŸ©
",Formal Proof of Stacks Project Tag 01UA,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/Morphisms/UniversallyOpen.lean#L144-L146,Q27041,,29.25.10,lemma,3.0,"['01U2', '01QL', '0ELP']","\n  Lemma 29.25.10. A flat morphism locally of finite presentation is universally open. \n\n    \n      Proof.\n      This follows from Lemmas 29.25.9 and Lemma 29.23.2 above. We can also argue directly as follows. \n    \n      Let $f : X \\to S$ be flat and locally of finite presentation. By Lemmas 29.25.8 and 29.21.4 any base change of $f$ is flat and locally of finite presentation. Hence it suffices to show $f$ is open. To show $f$ is open it suffices to show that we may cover $X$ by open affines $X = \\bigcup U_ i$ such that $U_ i \\to S$ is open. We may cover $X$ by affine opens $U_ i \\subset X$ such that each $U_ i$ maps into an affine open $V_ i \\subset S$ and such that the induced ring map $\\mathcal{O}_ S(V_ i) \\to \\mathcal{O}_ X(U_ i)$ is flat and of finite presentation (Lemmas 29.25.3 and 29.21.2). Then $U_ i \\to V_ i$ is open by Algebra, Proposition 10.41.8 and the proof is complete. \n      $\\square$\n    \n",\n  Lemma 29.25.10. A flat morphism locally of finite presentation is universally open. \n\n    \n,"Proof.\n      This follows from Lemmas 29.25.9 and Lemma 29.23.2 above. We can also argue directly as follows. \n    \n      Let $f : X \\to S$ be flat and locally of finite presentation. By Lemmas 29.25.8 and 29.21.4 any base change of $f$ is flat and locally of finite presentation. Hence it suffices to show $f$ is open. To show $f$ is open it suffices to show that we may cover $X$ by open affines $X = \\bigcup U_ i$ such that $U_ i \\to S$ is open. We may cover $X$ by affine opens $U_ i \\subset X$ such that each $U_ i$ maps into an affine open $V_ i \\subset S$ and such that the induced ring map $\\mathcal{O}_ S(V_ i) \\to \\mathcal{O}_ X(U_ i)$ is flat and of finite presentation (Lemmas 29.25.3 and 29.21.2). Then $U_ i \\to V_ i$ is open by Algebra, Proposition 10.41.8 and the proof is complete. \n      $\\square$\n    \n"," low) UniversallyOpen.of_flat [Flat f] [LocallyOfFinitePresentation f] :
    UniversallyOpen f :=
  âŸ¨universally_mk' _ _ fun _ _ â†¦ isOpenMap_of_generalizingMap _ (Flat.generalizingMap _)âŸ©
",instance (priority ,"Proof.\n      This follows from Lemmas 29.25.9 [[\n  Lemma 29.25.9. Let $f : X \\to S$ be a flat morphism of schemes. Then generalizations lift along $f$, see Topology, Definition 5.19.4. \n\n    \n]] and Lemma 29.23.2 [[\n  Lemma 29.23.2. Let $f : X \\to S$ be a morphism. \n  \n  \nIf $f$ is locally of finite presentation and generalizations lift along $f$, then $f$ is open. \n\n\nIf $f$ is locally of finite presentation and generalizations lift along every base change of $f$, then $f$ is universally open. \n\n\n\n\n    \n]] above. We can also argue directly as follows. \n    \n      Let $f : X \\to S$ be flat and locally of finite presentation. By Lemmas 29.25.8 [[\n  Lemma 29.25.8. The base change of a flat morphism is flat. \n\n    \n]] and 29.21.4 [[\n  Lemma 29.21.4. The base change of a morphism which is locally of finite presentation is locally of finite presentation. The same is true for morphisms of finite presentation. \n\n    \n]] any base change of $f$ is flat and locally of finite presentation. Hence it suffices to show $f$ is open. To show $f$ is open it suffices to show that we may cover $X$ by open affines $X = \\bigcup U_ i$ such that $U_ i \\to S$ is open. We may cover $X$ by affine opens $U_ i \\subset X$ such that each $U_ i$ maps into an affine open $V_ i \\subset S$ and such that the induced ring map $\\mathcal{O}_ S(V_ i) \\to \\mathcal{O}_ X(U_ i)$ is flat and of finite presentation (Lemmas 29.25.3 [[\n  Lemma 29.25.3. Let $f : X \\to S$ be a morphism of schemes. The following are equivalent \n  \n  \nThe morphism $f$ is flat. \n\n\nFor every affine opens $U \\subset X$, $V \\subset S$ with $f(U) \\subset V$ the ring map $\\mathcal{O}_ S(V) \\to \\mathcal{O}_ X(U)$ is flat. \n\n\nThere exists an open covering $S = \\bigcup _{j \\in J} V_ j$ and open coverings $f^{-1}(V_ j) = \\bigcup _{i \\in I_ j} U_ i$ such that each of the morphisms $U_ i \\to V_ j$, $j\\in J, i\\in I_ j$ is flat. \n\n\nThere exists an affine open covering $S = \\bigcup _{j \\in J} V_ j$ and affine open coverings $f^{-1}(V_ j) = \\bigcup _{i \\in I_ j} U_ i$ such that $\\mathcal{O}_ S(V_ j) \\to \\mathcal{O}_ X(U_ i)$ is flat, for all $j\\in J, i\\in I_ j$. \n\n\n\n   Moreover, if $f$ is flat then for any open subschemes $U \\subset X$, $V \\subset S$ with $f(U) \\subset V$ the restriction $f|_ U : U \\to V$ is flat. \n\n    \n]] and 29.21.2 [[\n  Lemma 29.21.2. Let $f : X \\to S$ be a morphism of schemes. The following are equivalent \n  \n  \nThe morphism $f$ is locally of finite presentation. \n\n\nFor every affine opens $U \\subset X$, $V \\subset S$ with $f(U) \\subset V$ the ring map $\\mathcal{O}_ S(V) \\to \\mathcal{O}_ X(U)$ is of finite presentation. \n\n\nThere exist an open covering $S = \\bigcup _{j \\in J} V_ j$ and open coverings $f^{-1}(V_ j) = \\bigcup _{i \\in I_ j} U_ i$ such that each of the morphisms $U_ i \\to V_ j$, $j\\in J, i\\in I_ j$ is locally of finite presentation. \n\n\nThere exist an affine open covering $S = \\bigcup _{j \\in J} V_ j$ and affine open coverings $f^{-1}(V_ j) = \\bigcup _{i \\in I_ j} U_ i$ such that the ring map $\\mathcal{O}_ S(V_ j) \\to \\mathcal{O}_ X(U_ i)$ is of finite presentation, for all $j\\in J, i\\in I_ j$. \n\n\n\n   Moreover, if $f$ is locally of finite presentation then for any open subschemes $U \\subset X$, $V \\subset S$ with $f(U) \\subset V$ the restriction $f|_ U : U \\to V$ is locally of finite presentation. \n\n    \n]]). Then $U_ i \\to V_ i$ is open by Algebra, Proposition 10.41.8 [[\n  Proposition 10.41.8. Let $R \\to S$ be flat and of finite presentation. Then $\\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R)$ is open. More generally this holds for any ring map $R \\to S$ of finite presentation which satisfies going down. \n\n    \n]] and the proof is complete. \n      $\\square$\n    \n"
61,01MC,"instance : Scheme.IsSeparated (Proj ð’œ) :=
  (HasAffineProperty.iff_of_isAffine (P := @IsSeparated)).mp (isSeparated ð’œ)
",Formal Proof of Stacks Project Tag 01MC,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/ProjectiveSpectrum/Proper.lean#L127-L128,Q27041,,27.8.8,lemma,3.0,"['01M3', '01LE', '0ELP']","\n  Lemma 27.8.8. Let $S$ be a graded ring. The scheme $\\text{Proj}(S)$ is separated. \n\n    \n      Proof.\n      We have to show that the canonical morphism $\\text{Proj}(S) \\to \\mathop{\\mathrm{Spec}}(\\mathbf{Z})$ is separated. We will use Schemes, Lemma 26.21.7. Thus it suffices to show given any pair of standard opens $D_{+}(f)$ and $D_{+}(g)$ that $D_{+}(f) \\cap D_{+}(g) = D_{+}(fg)$ is affine (clear) and that the ring map \n    \n      \n  \\[  S_{(f)} \\otimes _{\\mathbf{Z}} S_{(g)} \\longrightarrow S_{(fg)}  \\]\n\n    \n       is surjective. Any element $s$ in $S_{(fg)}$ is of the form $s = h/(f^ ng^ m)$ with $h \\in S$ homogeneous of degree $n\\deg (f) + m\\deg (g)$. We may multiply $h$ by a suitable monomial $f^ ig^ j$ and assume that $n = n\' \\deg (g)$, and $m = m\' \\deg (f)$. Then we can rewrite $s$ as $s = h/f^{(n\' + m\')\\deg (g)} \\cdot f^{m\'\\deg (g)}/g^{m\'\\deg (f)}$. So $s$ is indeed in the image of the displayed arrow. \n      $\\square$\n    \n",\n  Lemma 27.8.8. Let $S$ be a graded ring. The scheme $\\text{Proj}(S)$ is separated. \n\n    \n,"Proof.\n      We have to show that the canonical morphism $\\text{Proj}(S) \\to \\mathop{\\mathrm{Spec}}(\\mathbf{Z})$ is separated. We will use Schemes, Lemma 26.21.7. Thus it suffices to show given any pair of standard opens $D_{+}(f)$ and $D_{+}(g)$ that $D_{+}(f) \\cap D_{+}(g) = D_{+}(fg)$ is affine (clear) and that the ring map \n    \n      \n  \\[  S_{(f)} \\otimes _{\\mathbf{Z}} S_{(g)} \\longrightarrow S_{(fg)}  \\]\n\n    \n       is surjective. Any element $s$ in $S_{(fg)}$ is of the form $s = h/(f^ ng^ m)$ with $h \\in S$ homogeneous of degree $n\\deg (f) + m\\deg (g)$. We may multiply $h$ by a suitable monomial $f^ ig^ j$ and assume that $n = n\' \\deg (g)$, and $m = m\' \\deg (f)$. Then we can rewrite $s$ as $s = h/f^{(n\' + m\')\\deg (g)} \\cdot f^{m\'\\deg (g)}/g^{m\'\\deg (f)}$. So $s$ is indeed in the image of the displayed arrow. \n      $\\square$\n    \n","
  (HasAffineProperty.iff_of_isAffine (P := @IsSeparated)).mp (isSeparated ð’œ)
",instance : Scheme.IsSeparated (Proj ð’œ) ,"Proof.\n      We have to show that the canonical morphism $\\text{Proj}(S) \\to \\mathop{\\mathrm{Spec}}(\\mathbf{Z})$ is separated. We will use Schemes, Lemma 26.21.7 [[\n  Lemma 26.21.7. Let $f : X \\to S$ be a morphism of schemes. \n  \n  \nIf $f$ is separated then for every pair of affine opens $(U, V)$ of $X$ which map into a common affine open of $S$ we have \n\n\n  \nthe intersection $U \\cap V$ is affine. \n\n\nthe ring map $\\mathcal{O}_ X(U) \\otimes _{\\mathbf{Z}} \\mathcal{O}_ X(V) \\to \\mathcal{O}_ X(U \\cap V)$ is surjective. \n\n\n\n\nIf any pair of points $x_1, x_2 \\in X$ lying over a common point $s \\in S$ are contained in affine opens $x_1 \\in U$, $x_2 \\in V$ which map into a common affine open of $S$ such that (a), (b) hold, then $f$ is separated. \n\n\n\n\n    \n]]. Thus it suffices to show given any pair of standard opens $D_{+}(f)$ and $D_{+}(g)$ that $D_{+}(f) \\cap D_{+}(g) = D_{+}(fg)$ is affine (clear) and that the ring map \n    \n      \n  \\[  S_{(f)} \\otimes _{\\mathbf{Z}} S_{(g)} \\longrightarrow S_{(fg)}  \\]\n\n    \n       is surjective. Any element $s$ in $S_{(fg)}$ is of the form $s = h/(f^ ng^ m)$ with $h \\in S$ homogeneous of degree $n\\deg (f) + m\\deg (g)$. We may multiply $h$ by a suitable monomial $f^ ig^ j$ and assume that $n = n\' \\deg (g)$, and $m = m\' \\deg (f)$. Then we can rewrite $s$ as $s = h/f^{(n\' + m\')\\deg (g)} \\cdot f^{m\'\\deg (g)}/g^{m\'\\deg (f)}$. So $s$ is indeed in the image of the displayed arrow. \n      $\\square$\n    \n"
62,01MF,"theorem valuativeCriterion_existence_aux
    {O : Type*} [CommRing O] [IsDomain O] [ValuationRing O]
    {K : Type*} [Field K] [Algebra O K] [IsFractionRing O K]
    (Ï†â‚€ : (ð’œ 0) â†’+* O)
    (Î¹ : Type*) [Finite Î¹] (x : Î¹ â†’ A) (h2 : Algebra.adjoin (ð’œ 0) (Set.range x) = âŠ¤)
    (j : Î¹) (Ï† : Away ð’œ (x j) â†’+* K)
    (hcomm : (algebraMap O K).comp Ï†â‚€ = Ï†.comp (fromZeroRingHom ð’œ _))
    (d : Î¹ â†’ â„•) (hdi : âˆ€ i, 0 < d i) (hxdi : âˆ€ i, x i âˆˆ ð’œ (d i)) :
    âˆƒ (jâ‚€ : Î¹) (Ï†' : Away ð’œ (x j * x jâ‚€) â†’+* K), Ï†'.comp (awayMap ð’œ (hxdi jâ‚€) rfl) = Ï† âˆ§
      (Ï†'.comp (awayMap ð’œ (hxdi j) (mul_comm (x j) (x jâ‚€)))).range â‰¤ (algebraMap O K).range := by
  classical
  cases nonempty_fintype Î¹
  let Ïˆ (i : Î¹) : ValueGroup O K :=
    valuation O K ((Ï† (Away.isLocalizationElem (hxdi j) (hxdi i))) ^ âˆ k âˆˆ Finset.univ.erase i, d k)
  have : Nonempty Î¹ := âŸ¨jâŸ©
  let Kmax := (Finset.univ.image Ïˆ).max' (by simp)
  have âŸ¨iâ‚€, hi1âŸ© : âˆƒ a, Ïˆ a = Kmax := by simpa using Finset.max'_mem (Finset.univ.image Ïˆ)
  have hiâ‚€ (j) : Ïˆ j â‰¤ Ïˆ iâ‚€ := hi1 â–¸ (Finset.univ.image Ïˆ).le_max' (Ïˆ j) (by simp)
  have hKmax : 0 < Kmax := by
    refine zero_lt_iff.mpr fun hKmax â†¦ ?_
    have (i : _) : Ïˆ i = 0 := le_zero_iff.mp (hKmax â–¸ Finset.le_max' _ _ (by simp))
    simp only [Ïˆ, map_pow, pow_eq_zero_iff', map_eq_zero, ne_eq] at this
    have : Ï† 1 = 0 := by convert (this j).1; ext; simp
    simp only [map_one, one_ne_zero] at this
  letI := (awayMap ð’œ (f := x j) (hxdi iâ‚€) rfl).toAlgebra
  have := Away.isLocalization_mul (hxdi j) (hxdi iâ‚€) rfl (hdi _).ne'
  have hunit : IsUnit (Ï† (Away.isLocalizationElem (hxdi j) (hxdi iâ‚€))) := isUnit_iff_ne_zero.mpr
    fun rid â†¦ hKmax.ne' (.symm (by simpa [Ïˆ, rid, Finset.prod_eq_zero_iff, (hdi _).ne'] using hi1))
  let Ï†' := IsLocalization.Away.lift (S := Away ð’œ (x j * x iâ‚€)) _ hunit
  have hÏ†'1 (s) : Ï†' (awayMap ð’œ (hxdi iâ‚€) rfl s) = Ï† s := IsLocalization.Away.lift_eq _ hunit s
  use iâ‚€, Ï†', IsLocalization.Away.lift_comp ..
  rintro _ âŸ¨sx, rflâŸ©
  rw [RingHom.mem_range, â† ValuationRing.mem_integer_iff, Valuation.mem_integer_iff]
  have := (Away.span_mk_prod_pow_eq_top (hxdi iâ‚€) x h2 d hxdi).ge (Submodule.mem_top (x := sx))
  induction this using Submodule.span_induction with
  | zero => simp
  | add x y hx hy hhx hhy =>
    simp only [RingHom.coe_comp, Function.comp_apply, map_add, ge_iff_le]
    exact ((valuation O K).map_add _ _).trans <| sup_le_iff.mpr âŸ¨hhx, hhyâŸ©
  | smul a xâ‚€ hx hx1 =>
    simp only [Algebra.smul_def, RingHom.coe_comp, Function.comp_apply, map_mul, ge_iff_le]
    refine mul_le_one' ?_ hx1
    rw [RingHom.algebraMap_toAlgebra, awayMap_fromZeroRingHom ð’œ (hxdi j) (mul_comm (x j) (x iâ‚€)),
      â† awayMap_fromZeroRingHom ð’œ (hxdi iâ‚€) rfl a, hÏ†'1]
    change valuation O K (Ï†.comp (fromZeroRingHom ð’œ (.powers (x j))) a) â‰¤ 1
    simp only [â† hcomm, RingHom.coe_comp, Function.comp_apply, â† Valuation.mem_integer_iff,
      IsFractionRing.coe_inj, exists_eq, mem_integer_iff]
  | mem x1 h =>
    obtain âŸ¨a, ai, hai, rflâŸ© := h
    simp only [smul_eq_mul] at hai
    have H : (âˆ i, x i ^ ai i) * x iâ‚€ ^ (a * (d j - 1)) âˆˆ ð’œ ((a * d iâ‚€) â€¢ d j) := by
      convert SetLike.mul_mem_graded (SetLike.prod_pow_mem_graded ð’œ d x ai fun _ _ â†¦ hxdi _)
        (SetLike.pow_mem_graded (a * (d j - 1)) (hxdi iâ‚€)) using 2
      simp only [smul_eq_mul, hai]
      cases h : d j
      Â· cases (hdi j).ne' h
      Â· simp only [add_tsub_cancel_right]; ring
    suffices valuation O K (Ï† (Away.mk ð’œ (hxdi j) _ _ H) /
          Ï† (Away.isLocalizationElem (hxdi j) (hxdi iâ‚€)) ^ a) â‰¤ 1 by
      convert this
      rw [eq_div_iff (pow_ne_zero _ hunit.ne_zero), â† hÏ†'1, â† hÏ†'1, RingHom.comp_apply,
        â† map_pow, â† map_mul]
      congr
      ext
      simp only [awayMap_mk, Away.val_mk, val_pow, Localization.mk_pow, Localization.mk_mul,
        Localization.mk_eq_mk_iff, Localization.r_iff_exists, val_mul]
      use 1
      simp only [OneMemClass.coe_one, one_mul, Submonoid.coe_mul, SubmonoidClass.coe_pow]
      cases h : d j
      Â· cases (hdi j).ne' h
      Â· rw [Nat.add_sub_cancel]; ring
    rw [map_divâ‚€, div_le_iffâ‚€ ((pow_pos ((Valuation.pos_iff _).mpr hunit.ne_zero) _).trans_eq
      (Valuation.map_pow _ _ _).symm), one_mul, â† pow_le_pow_iff_leftâ‚€ zero_le' zero_le'
        (mul_pos (hdi j) (Finset.prod_pos fun i _ => hdi i)).ne.symm]
    calc
      _ = (âˆ i, Ïˆ i ^ (d i * ai i)) * Ïˆ iâ‚€ ^ (d iâ‚€ * a * (d j - 1)) := by
          simp only [Ïˆ, â† map_pow, â† map_prod, â† map_mul]
          congr 2
          apply (show Function.Injective (algebraMap (Away ð’œ (x j)) (Localization.Away (x j)))
            from val_injective _)
          simp only [map_pow, map_prod, map_mul]
          simp only [HomogeneousLocalization.algebraMap_apply, Away.val_mk, Localization.mk_pow,
            Localization.mk_prod, Localization.mk_mul]
          rw [Localization.mk_eq_mk_iff, Localization.r_iff_exists]
          use 1
          simp only [OneMemClass.coe_one, â† pow_mul, Submonoid.coe_mul,
            SubmonoidClass.coe_finset_prod, one_mul]
          simp_rw [â† mul_assoc, Finset.prod_erase_mul _ d (h := Finset.mem_univ _), mul_assoc,
            â† mul_assoc (Finset.prod ..), Finset.prod_erase_mul _ d (h := Finset.mem_univ _),
            SubmonoidClass.coe_pow, â† pow_mul, Finset.prod_pow_eq_pow_sum,
            â† pow_add, mul_pow, â† Finset.prod_pow, â† pow_mul]
          congr 3
          Â· simp only [mul_comm _ (âˆ i, d i), mul_assoc, mul_left_comm _ (âˆ i, d i),
              mul_comm (d _) (ai _), â† Finset.mul_sum, hai]
            cases h : d j
            Â· cases (hdi j).ne' h
            Â· simp; ring
          Â· ext i; congr 1; ring
          Â· ring
      _ â‰¤ (âˆ i : Î¹, Ïˆ iâ‚€ ^ (d i * ai i)) * Ïˆ iâ‚€ ^ (d iâ‚€ * a * (d j - 1)) := by
          gcongr with i; exacts [fun i _ â†¦ zero_le', zero_le', hiâ‚€ i]
      _ = Ïˆ iâ‚€ ^ (d iâ‚€ * a * d j) := by
          rw [Finset.prod_pow_eq_pow_sum, â† pow_add]
          simp_rw [mul_comm (d _) (ai _), hai]
          cases h : d j
          Â· cases (hdi j).ne' h
          Â· simp; ring_nf
      _ = valuation O K ((Ï† _) ^ a) ^ (d j * âˆ i, d i) := by
          Â· simp only [Ïˆ, â† map_pow]
            congr 2
            rw [â† pow_mul, â† pow_mul, â† mul_assoc, â† mul_assoc, â† mul_assoc,
              Finset.univ.prod_erase_mul d (h := Finset.mem_univ _),
              mul_comm _ a, mul_right_comm]
",Formal Proof of Stacks Project Tag 01MF,algebraic part,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/ProjectiveSpectrum/Proper.lean#L195-L307,Q27041,,27.8.11,lemma,3.0,"['01M3', '01LE', '0ELP']","\n  Lemma 27.8.11. Let $S$ be a graded ring. If $S$ is finitely generated as an algebra over $S_0$, then the morphism $\\text{Proj}(S) \\to \\mathop{\\mathrm{Spec}}(S_0)$ satisfies the existence and uniqueness parts of the valuative criterion, see Schemes, Definition 26.20.3. \n\n    \n      Proof.\n      The uniqueness part follows from the fact that $\\text{Proj}(S)$ is separated (Lemma 27.8.8 and Schemes, Lemma 26.22.1). Choose $x_ i \\in S_{+}$ homogeneous, $i = 1, \\ldots , n$ which generate $S$ over $S_0$. Let $d_ i = \\deg (x_ i)$ and set $d = \\text{lcm}\\{ d_ i\\} $. Suppose we are given a diagram \n    \n      \n  \\[  \\xymatrix{ \\mathop{\\mathrm{Spec}}(K) \\ar[r] \\ar[d] &  \\text{Proj}(S) \\ar[d] \\\\  \\mathop{\\mathrm{Spec}}(A) \\ar[r] &  \\mathop{\\mathrm{Spec}}(S_0) }  \\]\n\n    \n       as in Schemes, Definition 26.20.3. Denote $v : K^* \\to \\Gamma $ the valuation of $A$, see Algebra, Definition 10.50.13. We may choose an $f \\in S_{+}$ homogeneous such that $\\mathop{\\mathrm{Spec}}(K)$ maps into $D_{+}(f)$. Then we get a commutative diagram of ring maps \n    \n      \n  \\[  \\xymatrix{ K &  S_{(f)} \\ar[l]^{\\varphi } \\\\  A \\ar[u] &  S_0 \\ar[l] \\ar[u] }  \\]\n\n    \n       After renumbering we may assume that $\\varphi (x_ i^{\\deg (f)}/f^{d_ i})$ is nonzero for $i = 1, \\ldots , r$ and zero for $i = r + 1, \\ldots , n$. Since the open sets $D_{+}(x_ i)$ cover $\\text{Proj}(S)$ we see that $r \\geq 1$. Let $i_0 \\in \\{ 1, \\ldots , r\\} $ be an index minimizing $\\gamma _ i = (d/d_ i)v(\\varphi (x_ i^{\\deg (f)}/f^{d_ i}))$ in $\\Gamma $. For convenience set $x_0 = x_{i_0}$ and $d_0 = d_{i_0}$. The ring map $\\varphi $ factors though a map $\\varphi \' : S_{(fx_0)} \\to K$ which gives a ring map $S_{(x_0)} \\to S_{(fx_0)} \\to K$. The algebra $S_{(x_0)}$ is generated over $S_0$ by the elements $x_1^{e_1} \\ldots x_ n^{e_ n}/x_0^{e_0}$, where $\\sum e_ i d_ i = e_0 d_0$. If $e_ i > 0$ for some $i > r$, then $\\varphi \'(x_1^{e_1} \\ldots x_ n^{e_ n}/x_0^{e_0}) = 0$. If $e_ i = 0$ for $i > r$, then we have \n    \n      \n  \\begin{align*}  d \\deg (f) v(\\varphi \'(x_1^{e_1} \\ldots x_ r^{e_ r}/x_0^{e_0})) &  = d v(\\varphi \'(x_1^{e_1 \\deg (f)} \\ldots x_ r^{e_ r \\deg (f)}/x_0^{e_0 \\deg (f)})) \\\\ &  = d \\sum e_ i v(\\varphi \'(x_ i^{\\deg (f)}/f^{d_ i})) - e_0 v(\\varphi \'(x_0^{\\deg (f)}/f^{d_0})) \\\\ &  = \\sum e_ i d_ i \\gamma _ i - e_0 d_0 \\gamma _0 \\\\ &  \\geq \\sum e_ i d_ i \\gamma _0 - e_0 d_0 \\gamma _0 = 0 \\end{align*}\n\n    \n       because $\\gamma _0$ is minimal among the $\\gamma _ i$. This implies that $S_{(x_0)}$ maps into $A$ via $\\varphi \'$. The corresponding morphism of schemes $\\mathop{\\mathrm{Spec}}(A) \\to \\mathop{\\mathrm{Spec}}(S_{(x_0)}) = D_{+}(x_0) \\subset \\text{Proj}(S)$ provides the morphism fitting into the first commutative diagram of this proof. \n      $\\square$\n    \n","\n  Lemma 27.8.11. Let $S$ be a graded ring. If $S$ is finitely generated as an algebra over $S_0$, then the morphism $\\text{Proj}(S) \\to \\mathop{\\mathrm{Spec}}(S_0)$ satisfies the existence and uniqueness parts of the valuative criterion, see Schemes, Definition 26.20.3. \n\n    \n","Proof.\n      The uniqueness part follows from the fact that $\\text{Proj}(S)$ is separated (Lemma 27.8.8 and Schemes, Lemma 26.22.1). Choose $x_ i \\in S_{+}$ homogeneous, $i = 1, \\ldots , n$ which generate $S$ over $S_0$. Let $d_ i = \\deg (x_ i)$ and set $d = \\text{lcm}\\{ d_ i\\} $. Suppose we are given a diagram \n    \n      \n  \\[  \\xymatrix{ \\mathop{\\mathrm{Spec}}(K) \\ar[r] \\ar[d] &  \\text{Proj}(S) \\ar[d] \\\\  \\mathop{\\mathrm{Spec}}(A) \\ar[r] &  \\mathop{\\mathrm{Spec}}(S_0) }  \\]\n\n    \n       as in Schemes, Definition 26.20.3. Denote $v : K^* \\to \\Gamma $ the valuation of $A$, see Algebra, Definition 10.50.13. We may choose an $f \\in S_{+}$ homogeneous such that $\\mathop{\\mathrm{Spec}}(K)$ maps into $D_{+}(f)$. Then we get a commutative diagram of ring maps \n    \n      \n  \\[  \\xymatrix{ K &  S_{(f)} \\ar[l]^{\\varphi } \\\\  A \\ar[u] &  S_0 \\ar[l] \\ar[u] }  \\]\n\n    \n       After renumbering we may assume that $\\varphi (x_ i^{\\deg (f)}/f^{d_ i})$ is nonzero for $i = 1, \\ldots , r$ and zero for $i = r + 1, \\ldots , n$. Since the open sets $D_{+}(x_ i)$ cover $\\text{Proj}(S)$ we see that $r \\geq 1$. Let $i_0 \\in \\{ 1, \\ldots , r\\} $ be an index minimizing $\\gamma _ i = (d/d_ i)v(\\varphi (x_ i^{\\deg (f)}/f^{d_ i}))$ in $\\Gamma $. For convenience set $x_0 = x_{i_0}$ and $d_0 = d_{i_0}$. The ring map $\\varphi $ factors though a map $\\varphi \' : S_{(fx_0)} \\to K$ which gives a ring map $S_{(x_0)} \\to S_{(fx_0)} \\to K$. The algebra $S_{(x_0)}$ is generated over $S_0$ by the elements $x_1^{e_1} \\ldots x_ n^{e_ n}/x_0^{e_0}$, where $\\sum e_ i d_ i = e_0 d_0$. If $e_ i > 0$ for some $i > r$, then $\\varphi \'(x_1^{e_1} \\ldots x_ n^{e_ n}/x_0^{e_0}) = 0$. If $e_ i = 0$ for $i > r$, then we have \n    \n      \n  \\begin{align*}  d \\deg (f) v(\\varphi \'(x_1^{e_1} \\ldots x_ r^{e_ r}/x_0^{e_0})) &  = d v(\\varphi \'(x_1^{e_1 \\deg (f)} \\ldots x_ r^{e_ r \\deg (f)}/x_0^{e_0 \\deg (f)})) \\\\ &  = d \\sum e_ i v(\\varphi \'(x_ i^{\\deg (f)}/f^{d_ i})) - e_0 v(\\varphi \'(x_0^{\\deg (f)}/f^{d_0})) \\\\ &  = \\sum e_ i d_ i \\gamma _ i - e_0 d_0 \\gamma _0 \\\\ &  \\geq \\sum e_ i d_ i \\gamma _0 - e_0 d_0 \\gamma _0 = 0 \\end{align*}\n\n    \n       because $\\gamma _0$ is minimal among the $\\gamma _ i$. This implies that $S_{(x_0)}$ maps into $A$ via $\\varphi \'$. The corresponding morphism of schemes $\\mathop{\\mathrm{Spec}}(A) \\to \\mathop{\\mathrm{Spec}}(S_{(x_0)}) = D_{+}(x_0) \\subset \\text{Proj}(S)$ provides the morphism fitting into the first commutative diagram of this proof. \n      $\\square$\n    \n"," by
  classical
  cases nonempty_fintype Î¹
  let Ïˆ (i : Î¹) : ValueGroup O K :=
    valuation O K ((Ï† (Away.isLocalizationElem (hxdi j) (hxdi i))) ^ âˆ k âˆˆ Finset.univ.erase i, d k)
  have : Nonempty Î¹ := âŸ¨jâŸ©
  let Kmax := (Finset.univ.image Ïˆ).max' (by simp)
  have âŸ¨iâ‚€, hi1âŸ© : âˆƒ a, Ïˆ a = Kmax := by simpa using Finset.max'_mem (Finset.univ.image Ïˆ)
  have hiâ‚€ (j) : Ïˆ j â‰¤ Ïˆ iâ‚€ := hi1 â–¸ (Finset.univ.image Ïˆ).le_max' (Ïˆ j) (by simp)
  have hKmax : 0 < Kmax := by
    refine zero_lt_iff.mpr fun hKmax â†¦ ?_
    have (i : _) : Ïˆ i = 0 := le_zero_iff.mp (hKmax â–¸ Finset.le_max' _ _ (by simp))
    simp only [Ïˆ, map_pow, pow_eq_zero_iff', map_eq_zero, ne_eq] at this
    have : Ï† 1 = 0 := by convert (this j).1; ext; simp
    simp only [map_one, one_ne_zero] at this
  letI := (awayMap ð’œ (f := x j) (hxdi iâ‚€) rfl).toAlgebra
  have := Away.isLocalization_mul (hxdi j) (hxdi iâ‚€) rfl (hdi _).ne'
  have hunit : IsUnit (Ï† (Away.isLocalizationElem (hxdi j) (hxdi iâ‚€))) := isUnit_iff_ne_zero.mpr
    fun rid â†¦ hKmax.ne' (.symm (by simpa [Ïˆ, rid, Finset.prod_eq_zero_iff, (hdi _).ne'] using hi1))
  let Ï†' := IsLocalization.Away.lift (S := Away ð’œ (x j * x iâ‚€)) _ hunit
  have hÏ†'1 (s) : Ï†' (awayMap ð’œ (hxdi iâ‚€) rfl s) = Ï† s := IsLocalization.Away.lift_eq _ hunit s
  use iâ‚€, Ï†', IsLocalization.Away.lift_comp ..
  rintro _ âŸ¨sx, rflâŸ©
  rw [RingHom.mem_range, â† ValuationRing.mem_integer_iff, Valuation.mem_integer_iff]
  have := (Away.span_mk_prod_pow_eq_top (hxdi iâ‚€) x h2 d hxdi).ge (Submodule.mem_top (x := sx))
  induction this using Submodule.span_induction with
  | zero => simp
  | add x y hx hy hhx hhy =>
    simp only [RingHom.coe_comp, Function.comp_apply, map_add, ge_iff_le]
    exact ((valuation O K).map_add _ _).trans <| sup_le_iff.mpr âŸ¨hhx, hhyâŸ©
  | smul a xâ‚€ hx hx1 =>
    simp only [Algebra.smul_def, RingHom.coe_comp, Function.comp_apply, map_mul, ge_iff_le]
    refine mul_le_one' ?_ hx1
    rw [RingHom.algebraMap_toAlgebra, awayMap_fromZeroRingHom ð’œ (hxdi j) (mul_comm (x j) (x iâ‚€)),
      â† awayMap_fromZeroRingHom ð’œ (hxdi iâ‚€) rfl a, hÏ†'1]
    change valuation O K (Ï†.comp (fromZeroRingHom ð’œ (.powers (x j))) a) â‰¤ 1
    simp only [â† hcomm, RingHom.coe_comp, Function.comp_apply, â† Valuation.mem_integer_iff,
      IsFractionRing.coe_inj, exists_eq, mem_integer_iff]
  | mem x1 h =>
    obtain âŸ¨a, ai, hai, rflâŸ© := h
    simp only [smul_eq_mul] at hai
    have H : (âˆ i, x i ^ ai i) * x iâ‚€ ^ (a * (d j - 1)) âˆˆ ð’œ ((a * d iâ‚€) â€¢ d j) := by
      convert SetLike.mul_mem_graded (SetLike.prod_pow_mem_graded ð’œ d x ai fun _ _ â†¦ hxdi _)
        (SetLike.pow_mem_graded (a * (d j - 1)) (hxdi iâ‚€)) using 2
      simp only [smul_eq_mul, hai]
      cases h : d j
      Â· cases (hdi j).ne' h
      Â· simp only [add_tsub_cancel_right]; ring
    suffices valuation O K (Ï† (Away.mk ð’œ (hxdi j) _ _ H) /
          Ï† (Away.isLocalizationElem (hxdi j) (hxdi iâ‚€)) ^ a) â‰¤ 1 by
      convert this
      rw [eq_div_iff (pow_ne_zero _ hunit.ne_zero), â† hÏ†'1, â† hÏ†'1, RingHom.comp_apply,
        â† map_pow, â† map_mul]
      congr
      ext
      simp only [awayMap_mk, Away.val_mk, val_pow, Localization.mk_pow, Localization.mk_mul,
        Localization.mk_eq_mk_iff, Localization.r_iff_exists, val_mul]
      use 1
      simp only [OneMemClass.coe_one, one_mul, Submonoid.coe_mul, SubmonoidClass.coe_pow]
      cases h : d j
      Â· cases (hdi j).ne' h
      Â· rw [Nat.add_sub_cancel]; ring
    rw [map_divâ‚€, div_le_iffâ‚€ ((pow_pos ((Valuation.pos_iff _).mpr hunit.ne_zero) _).trans_eq
      (Valuation.map_pow _ _ _).symm), one_mul, â† pow_le_pow_iff_leftâ‚€ zero_le' zero_le'
        (mul_pos (hdi j) (Finset.prod_pos fun i _ => hdi i)).ne.symm]
    calc
      _ = (âˆ i, Ïˆ i ^ (d i * ai i)) * Ïˆ iâ‚€ ^ (d iâ‚€ * a * (d j - 1)) := by
          simp only [Ïˆ, â† map_pow, â† map_prod, â† map_mul]
          congr 2
          apply (show Function.Injective (algebraMap (Away ð’œ (x j)) (Localization.Away (x j)))
            from val_injective _)
          simp only [map_pow, map_prod, map_mul]
          simp only [HomogeneousLocalization.algebraMap_apply, Away.val_mk, Localization.mk_pow,
            Localization.mk_prod, Localization.mk_mul]
          rw [Localization.mk_eq_mk_iff, Localization.r_iff_exists]
          use 1
          simp only [OneMemClass.coe_one, â† pow_mul, Submonoid.coe_mul,
            SubmonoidClass.coe_finset_prod, one_mul]
          simp_rw [â† mul_assoc, Finset.prod_erase_mul _ d (h := Finset.mem_univ _), mul_assoc,
            â† mul_assoc (Finset.prod ..), Finset.prod_erase_mul _ d (h := Finset.mem_univ _),
            SubmonoidClass.coe_pow, â† pow_mul, Finset.prod_pow_eq_pow_sum,
            â† pow_add, mul_pow, â† Finset.prod_pow, â† pow_mul]
          congr 3
          Â· simp only [mul_comm _ (âˆ i, d i), mul_assoc, mul_left_comm _ (âˆ i, d i),
              mul_comm (d _) (ai _), â† Finset.mul_sum, hai]
            cases h : d j
            Â· cases (hdi j).ne' h
            Â· simp; ring
          Â· ext i; congr 1; ring
          Â· ring
      _ â‰¤ (âˆ i : Î¹, Ïˆ iâ‚€ ^ (d i * ai i)) * Ïˆ iâ‚€ ^ (d iâ‚€ * a * (d j - 1)) := by
          gcongr with i; exacts [fun i _ â†¦ zero_le', zero_le', hiâ‚€ i]
      _ = Ïˆ iâ‚€ ^ (d iâ‚€ * a * d j) := by
          rw [Finset.prod_pow_eq_pow_sum, â† pow_add]
          simp_rw [mul_comm (d _) (ai _), hai]
          cases h : d j
          Â· cases (hdi j).ne' h
          Â· simp; ring_nf
      _ = valuation O K ((Ï† _) ^ a) ^ (d j * âˆ i, d i) := by
          Â· simp only [Ïˆ, â† map_pow]
            congr 2
            rw [â† pow_mul, â† pow_mul, â† mul_assoc, â† mul_assoc, â† mul_assoc,
              Finset.univ.prod_erase_mul d (h := Finset.mem_univ _),
              mul_comm _ a, mul_right_comm]
","theorem valuativeCriterion_existence_aux
    {O : Type*} [CommRing O] [IsDomain O] [ValuationRing O]
    {K : Type*} [Field K] [Algebra O K] [IsFractionRing O K]
    (Ï†â‚€ : (ð’œ 0) â†’+* O)
    (Î¹ : Type*) [Finite Î¹] (x : Î¹ â†’ A) (h2 : Algebra.adjoin (ð’œ 0) (Set.range x) = âŠ¤)
    (j : Î¹) (Ï† : Away ð’œ (x j) â†’+* K)
    (hcomm : (algebraMap O K).comp Ï†â‚€ = Ï†.comp (fromZeroRingHom ð’œ _))
    (d : Î¹ â†’ â„•) (hdi : âˆ€ i, 0 < d i) (hxdi : âˆ€ i, x i âˆˆ ð’œ (d i)) :
    âˆƒ (jâ‚€ : Î¹) (Ï†' : Away ð’œ (x j * x jâ‚€) â†’+* K), Ï†'.comp (awayMap ð’œ (hxdi jâ‚€) rfl) = Ï† âˆ§
      (Ï†'.comp (awayMap ð’œ (hxdi j) (mul_comm (x j) (x jâ‚€)))).range â‰¤ (algebraMap O K).range ","Proof.\n      The uniqueness part follows from the fact that $\\text{Proj}(S)$ is separated (Lemma 27.8.8 [[\n  Lemma 27.8.8. Let $S$ be a graded ring. The scheme $\\text{Proj}(S)$ is separated. \n\n    \n]] and Schemes, Lemma 26.22.1 [[\n  Lemma 26.22.1. Let $f : X \\to S$ be a morphism of schemes. If $f$ is separated, then $f$ satisfies the uniqueness part of the valuative criterion. \n\n    \n]]). Choose $x_ i \\in S_{+}$ homogeneous, $i = 1, \\ldots , n$ which generate $S$ over $S_0$. Let $d_ i = \\deg (x_ i)$ and set $d = \\text{lcm}\\{ d_ i\\} $. Suppose we are given a diagram \n    \n      \n  \\[  \\xymatrix{ \\mathop{\\mathrm{Spec}}(K) \\ar[r] \\ar[d] &  \\text{Proj}(S) \\ar[d] \\\\  \\mathop{\\mathrm{Spec}}(A) \\ar[r] &  \\mathop{\\mathrm{Spec}}(S_0) }  \\]\n\n    \n       as in Schemes, Definition 26.20.3 [[\n  Definition 26.20.3. Let $f : X \\to S$ be a morphism of schemes. We say $f$ satisfies the existence part of the valuative criterion if given any commutative solid diagram \n  \n  \\[  \\xymatrix{ \\mathop{\\mathrm{Spec}}(K) \\ar[r] \\ar[d] &  X \\ar[d] \\\\  \\mathop{\\mathrm{Spec}}(A) \\ar[r] \\ar@{-->}[ru] &  S }  \\]\n\n   where $A$ is a valuation ring with field of fractions $K$, the dotted arrow exists. We say $f$ satisfies the uniqueness part of the valuative criterion if there is at most one dotted arrow given any diagram as above (without requiring existence of course). \n]]. Denote $v : K^* \\to \\Gamma $ the valuation of $A$, see Algebra, Definition 10.50.13 [[\n  Definition 10.50.13. Let $A$ be a valuation ring. \n  \n  \nThe totally ordered abelian group $(\\Gamma , \\geq )$ of Lemma 10.50.12 is called the value group of the valuation ring $A$. \n\n\nThe map $v : A - \\{ 0\\}  \\to \\Gamma $ and also $v : K^* \\to \\Gamma $ is called the valuation associated to $A$. \n\n\nThe valuation ring $A$ is called a discrete valuation ring if $\\Gamma \\cong \\mathbf{Z}$. \n\n\n\n]]. We may choose an $f \\in S_{+}$ homogeneous such that $\\mathop{\\mathrm{Spec}}(K)$ maps into $D_{+}(f)$. Then we get a commutative diagram of ring maps \n    \n      \n  \\[  \\xymatrix{ K &  S_{(f)} \\ar[l]^{\\varphi } \\\\  A \\ar[u] &  S_0 \\ar[l] \\ar[u] }  \\]\n\n    \n       After renumbering we may assume that $\\varphi (x_ i^{\\deg (f)}/f^{d_ i})$ is nonzero for $i = 1, \\ldots , r$ and zero for $i = r + 1, \\ldots , n$. Since the open sets $D_{+}(x_ i)$ cover $\\text{Proj}(S)$ we see that $r \\geq 1$. Let $i_0 \\in \\{ 1, \\ldots , r\\} $ be an index minimizing $\\gamma _ i = (d/d_ i)v(\\varphi (x_ i^{\\deg (f)}/f^{d_ i}))$ in $\\Gamma $. For convenience set $x_0 = x_{i_0}$ and $d_0 = d_{i_0}$. The ring map $\\varphi $ factors though a map $\\varphi \' : S_{(fx_0)} \\to K$ which gives a ring map $S_{(x_0)} \\to S_{(fx_0)} \\to K$. The algebra $S_{(x_0)}$ is generated over $S_0$ by the elements $x_1^{e_1} \\ldots x_ n^{e_ n}/x_0^{e_0}$, where $\\sum e_ i d_ i = e_0 d_0$. If $e_ i > 0$ for some $i > r$, then $\\varphi \'(x_1^{e_1} \\ldots x_ n^{e_ n}/x_0^{e_0}) = 0$. If $e_ i = 0$ for $i > r$, then we have \n    \n      \n  \\begin{align*}  d \\deg (f) v(\\varphi \'(x_1^{e_1} \\ldots x_ r^{e_ r}/x_0^{e_0})) &  = d v(\\varphi \'(x_1^{e_1 \\deg (f)} \\ldots x_ r^{e_ r \\deg (f)}/x_0^{e_0 \\deg (f)})) \\\\ &  = d \\sum e_ i v(\\varphi \'(x_ i^{\\deg (f)}/f^{d_ i})) - e_0 v(\\varphi \'(x_0^{\\deg (f)}/f^{d_0})) \\\\ &  = \\sum e_ i d_ i \\gamma _ i - e_0 d_0 \\gamma _0 \\\\ &  \\geq \\sum e_ i d_ i \\gamma _0 - e_0 d_0 \\gamma _0 = 0 \\end{align*}\n\n    \n       because $\\gamma _0$ is minimal among the $\\gamma _ i$. This implies that $S_{(x_0)}$ maps into $A$ via $\\varphi \'$. The corresponding morphism of schemes $\\mathop{\\mathrm{Spec}}(A) \\to \\mathop{\\mathrm{Spec}}(S_{(x_0)}) = D_{+}(x_0) \\subset \\text{Proj}(S)$ provides the morphism fitting into the first commutative diagram of this proof. \n      $\\square$\n    \n"
63,01MF,"lemma valuativeCriterion_existence [Algebra.FiniteType (ð’œ 0) A] :
    ValuativeCriterion.Existence (Proj.toSpecZero ð’œ) := by
  rintro âŸ¨O, K, iâ‚, iâ‚‚, wâŸ©
  obtain âŸ¨x, hx, hx'âŸ© := GradedAlgebra.exists_finset_adjoin_eq_top_and_homogeneous_ne_zero ð’œ
  choose d hd hxd using hx'
  have : iâ‚ (IsLocalRing.closedPoint K) âˆˆ (âŠ¤ : (Proj ð’œ).Opens) := trivial
  rw [â† Proj.iSup_basicOpen_eq_top' ð’œ (Î¹ := x) (â†‘) (fun i â†¦ âŸ¨_, hxd _ i.2âŸ©) (by simpa using hx),
    TopologicalSpace.Opens.mem_iSup] at this
  obtain âŸ¨i, hiâŸ© := this
  have : Set.range iâ‚ âŠ† (Proj.awayÎ¹ ð’œ _ (hxd i i.2) (hd i i.2).bot_lt).opensRange := by
    rw [Proj.opensRange_awayÎ¹]
    rintro _ âŸ¨x, rflâŸ©
    obtain rfl := Subsingleton.elim x (IsLocalRing.closedPoint K)
    exact hi
  let Ï† : Spec (.of <| K) âŸ¶ _ := IsOpenImmersion.lift _ _ this
  have H : Spec.preimage iâ‚‚ â‰« CommRingCat.ofHom (algebraMap O K) =
      CommRingCat.ofHom (fromZeroRingHom ð’œ _) â‰« Spec.preimage Ï† := by
    apply Spec.map_injective
    simp only [Spec.map_comp, Spec.map_preimage, â† w.w]
    rw [â† Proj.awayÎ¹_toSpecZero _ _ (hxd i i.2), IsOpenImmersion.lift_fac_assoc]
    exact Nat.zero_lt_of_ne_zero (hd i i.2)
  obtain âŸ¨iâ‚€, Ï†', hÏ†, hÏ†'âŸ© :=
    valuativeCriterion_existence_aux ð’œ (Spec.preimage iâ‚‚).hom x (â†‘) (by simpa using hx) i
      (O := O) (K := K) (Spec.preimage Ï†).hom congr(($H).hom)
      (fun i â†¦ d _ i.2) (fun i â†¦ (hd _ i.2).bot_lt) (fun i â†¦ hxd _ i.2)
  let e : O â‰ƒ+* (algebraMap O K).range :=
    (AlgEquiv.ofInjective (Algebra.ofId O K) (IsFractionRing.injective _ _)).toRingEquiv
  let Ï†'' := e.symm.toRingHom.comp ((Subring.inclusion hÏ†').comp (RingHom.rangeRestrict _))
  have hÏ†'' : (algebraMap O K).comp Ï†'' = Ï†'.comp (awayMap ð’œ (hxd _ i.2) (mul_comm _ _)) := by
    ext x
    exact congr_arg Subtype.val (e.apply_symm_apply _)
  refine âŸ¨âŸ¨Spec.map (CommRingCat.ofHom Ï†'') â‰« Proj.awayÎ¹ ð’œ _ (hxd _ iâ‚€.2) (hd _ _).bot_lt, ?_, ?_âŸ©âŸ©
  Â· rw [â† Spec.map_comp_assoc]
    convert IsOpenImmersion.lift_fac _ _ this using 1
    change _ = Ï† â‰« _
    rw [â† Spec.map_preimage Ï†, â† CommRingCat.ofHom_hom (Spec.preimage Ï†), â† hÏ†,
      â† CommRingCat.ofHom_comp]
    simp [hÏ†'', SpecMap_awayMap_awayÎ¹, add_comm]
  Â· simp only [Category.assoc, Proj.awayÎ¹_toSpecZero, â† Spec.map_comp]
    conv_rhs => rw [â† Spec.map_preimage iâ‚‚]
    congr 1
    ext x
    apply IsFractionRing.injective O K
    refine (DFunLike.congr_fun hÏ†'' (fromZeroRingHom ð’œ _ _)).trans ?_
    simp only [RingHom.coe_comp, Function.comp_apply]
    rw [awayMap_fromZeroRingHom, â† awayMap_fromZeroRingHom ð’œ (hxd iâ‚€ iâ‚€.2) rfl,
      â† RingHom.comp_apply, hÏ†]
    exact congr($(H.symm) x)
",Formal Proof of Stacks Project Tag 01MF,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/ProjectiveSpectrum/Proper.lean#L310-L357,Q27041,,27.8.11,lemma,3.0,"['01M3', '01LE', '0ELP']","\n  Lemma 27.8.11. Let $S$ be a graded ring. If $S$ is finitely generated as an algebra over $S_0$, then the morphism $\\text{Proj}(S) \\to \\mathop{\\mathrm{Spec}}(S_0)$ satisfies the existence and uniqueness parts of the valuative criterion, see Schemes, Definition 26.20.3. \n\n    \n      Proof.\n      The uniqueness part follows from the fact that $\\text{Proj}(S)$ is separated (Lemma 27.8.8 and Schemes, Lemma 26.22.1). Choose $x_ i \\in S_{+}$ homogeneous, $i = 1, \\ldots , n$ which generate $S$ over $S_0$. Let $d_ i = \\deg (x_ i)$ and set $d = \\text{lcm}\\{ d_ i\\} $. Suppose we are given a diagram \n    \n      \n  \\[  \\xymatrix{ \\mathop{\\mathrm{Spec}}(K) \\ar[r] \\ar[d] &  \\text{Proj}(S) \\ar[d] \\\\  \\mathop{\\mathrm{Spec}}(A) \\ar[r] &  \\mathop{\\mathrm{Spec}}(S_0) }  \\]\n\n    \n       as in Schemes, Definition 26.20.3. Denote $v : K^* \\to \\Gamma $ the valuation of $A$, see Algebra, Definition 10.50.13. We may choose an $f \\in S_{+}$ homogeneous such that $\\mathop{\\mathrm{Spec}}(K)$ maps into $D_{+}(f)$. Then we get a commutative diagram of ring maps \n    \n      \n  \\[  \\xymatrix{ K &  S_{(f)} \\ar[l]^{\\varphi } \\\\  A \\ar[u] &  S_0 \\ar[l] \\ar[u] }  \\]\n\n    \n       After renumbering we may assume that $\\varphi (x_ i^{\\deg (f)}/f^{d_ i})$ is nonzero for $i = 1, \\ldots , r$ and zero for $i = r + 1, \\ldots , n$. Since the open sets $D_{+}(x_ i)$ cover $\\text{Proj}(S)$ we see that $r \\geq 1$. Let $i_0 \\in \\{ 1, \\ldots , r\\} $ be an index minimizing $\\gamma _ i = (d/d_ i)v(\\varphi (x_ i^{\\deg (f)}/f^{d_ i}))$ in $\\Gamma $. For convenience set $x_0 = x_{i_0}$ and $d_0 = d_{i_0}$. The ring map $\\varphi $ factors though a map $\\varphi \' : S_{(fx_0)} \\to K$ which gives a ring map $S_{(x_0)} \\to S_{(fx_0)} \\to K$. The algebra $S_{(x_0)}$ is generated over $S_0$ by the elements $x_1^{e_1} \\ldots x_ n^{e_ n}/x_0^{e_0}$, where $\\sum e_ i d_ i = e_0 d_0$. If $e_ i > 0$ for some $i > r$, then $\\varphi \'(x_1^{e_1} \\ldots x_ n^{e_ n}/x_0^{e_0}) = 0$. If $e_ i = 0$ for $i > r$, then we have \n    \n      \n  \\begin{align*}  d \\deg (f) v(\\varphi \'(x_1^{e_1} \\ldots x_ r^{e_ r}/x_0^{e_0})) &  = d v(\\varphi \'(x_1^{e_1 \\deg (f)} \\ldots x_ r^{e_ r \\deg (f)}/x_0^{e_0 \\deg (f)})) \\\\ &  = d \\sum e_ i v(\\varphi \'(x_ i^{\\deg (f)}/f^{d_ i})) - e_0 v(\\varphi \'(x_0^{\\deg (f)}/f^{d_0})) \\\\ &  = \\sum e_ i d_ i \\gamma _ i - e_0 d_0 \\gamma _0 \\\\ &  \\geq \\sum e_ i d_ i \\gamma _0 - e_0 d_0 \\gamma _0 = 0 \\end{align*}\n\n    \n       because $\\gamma _0$ is minimal among the $\\gamma _ i$. This implies that $S_{(x_0)}$ maps into $A$ via $\\varphi \'$. The corresponding morphism of schemes $\\mathop{\\mathrm{Spec}}(A) \\to \\mathop{\\mathrm{Spec}}(S_{(x_0)}) = D_{+}(x_0) \\subset \\text{Proj}(S)$ provides the morphism fitting into the first commutative diagram of this proof. \n      $\\square$\n    \n","\n  Lemma 27.8.11. Let $S$ be a graded ring. If $S$ is finitely generated as an algebra over $S_0$, then the morphism $\\text{Proj}(S) \\to \\mathop{\\mathrm{Spec}}(S_0)$ satisfies the existence and uniqueness parts of the valuative criterion, see Schemes, Definition 26.20.3. \n\n    \n","Proof.\n      The uniqueness part follows from the fact that $\\text{Proj}(S)$ is separated (Lemma 27.8.8 and Schemes, Lemma 26.22.1). Choose $x_ i \\in S_{+}$ homogeneous, $i = 1, \\ldots , n$ which generate $S$ over $S_0$. Let $d_ i = \\deg (x_ i)$ and set $d = \\text{lcm}\\{ d_ i\\} $. Suppose we are given a diagram \n    \n      \n  \\[  \\xymatrix{ \\mathop{\\mathrm{Spec}}(K) \\ar[r] \\ar[d] &  \\text{Proj}(S) \\ar[d] \\\\  \\mathop{\\mathrm{Spec}}(A) \\ar[r] &  \\mathop{\\mathrm{Spec}}(S_0) }  \\]\n\n    \n       as in Schemes, Definition 26.20.3. Denote $v : K^* \\to \\Gamma $ the valuation of $A$, see Algebra, Definition 10.50.13. We may choose an $f \\in S_{+}$ homogeneous such that $\\mathop{\\mathrm{Spec}}(K)$ maps into $D_{+}(f)$. Then we get a commutative diagram of ring maps \n    \n      \n  \\[  \\xymatrix{ K &  S_{(f)} \\ar[l]^{\\varphi } \\\\  A \\ar[u] &  S_0 \\ar[l] \\ar[u] }  \\]\n\n    \n       After renumbering we may assume that $\\varphi (x_ i^{\\deg (f)}/f^{d_ i})$ is nonzero for $i = 1, \\ldots , r$ and zero for $i = r + 1, \\ldots , n$. Since the open sets $D_{+}(x_ i)$ cover $\\text{Proj}(S)$ we see that $r \\geq 1$. Let $i_0 \\in \\{ 1, \\ldots , r\\} $ be an index minimizing $\\gamma _ i = (d/d_ i)v(\\varphi (x_ i^{\\deg (f)}/f^{d_ i}))$ in $\\Gamma $. For convenience set $x_0 = x_{i_0}$ and $d_0 = d_{i_0}$. The ring map $\\varphi $ factors though a map $\\varphi \' : S_{(fx_0)} \\to K$ which gives a ring map $S_{(x_0)} \\to S_{(fx_0)} \\to K$. The algebra $S_{(x_0)}$ is generated over $S_0$ by the elements $x_1^{e_1} \\ldots x_ n^{e_ n}/x_0^{e_0}$, where $\\sum e_ i d_ i = e_0 d_0$. If $e_ i > 0$ for some $i > r$, then $\\varphi \'(x_1^{e_1} \\ldots x_ n^{e_ n}/x_0^{e_0}) = 0$. If $e_ i = 0$ for $i > r$, then we have \n    \n      \n  \\begin{align*}  d \\deg (f) v(\\varphi \'(x_1^{e_1} \\ldots x_ r^{e_ r}/x_0^{e_0})) &  = d v(\\varphi \'(x_1^{e_1 \\deg (f)} \\ldots x_ r^{e_ r \\deg (f)}/x_0^{e_0 \\deg (f)})) \\\\ &  = d \\sum e_ i v(\\varphi \'(x_ i^{\\deg (f)}/f^{d_ i})) - e_0 v(\\varphi \'(x_0^{\\deg (f)}/f^{d_0})) \\\\ &  = \\sum e_ i d_ i \\gamma _ i - e_0 d_0 \\gamma _0 \\\\ &  \\geq \\sum e_ i d_ i \\gamma _0 - e_0 d_0 \\gamma _0 = 0 \\end{align*}\n\n    \n       because $\\gamma _0$ is minimal among the $\\gamma _ i$. This implies that $S_{(x_0)}$ maps into $A$ via $\\varphi \'$. The corresponding morphism of schemes $\\mathop{\\mathrm{Spec}}(A) \\to \\mathop{\\mathrm{Spec}}(S_{(x_0)}) = D_{+}(x_0) \\subset \\text{Proj}(S)$ provides the morphism fitting into the first commutative diagram of this proof. \n      $\\square$\n    \n"," by
  rintro âŸ¨O, K, iâ‚, iâ‚‚, wâŸ©
  obtain âŸ¨x, hx, hx'âŸ© := GradedAlgebra.exists_finset_adjoin_eq_top_and_homogeneous_ne_zero ð’œ
  choose d hd hxd using hx'
  have : iâ‚ (IsLocalRing.closedPoint K) âˆˆ (âŠ¤ : (Proj ð’œ).Opens) := trivial
  rw [â† Proj.iSup_basicOpen_eq_top' ð’œ (Î¹ := x) (â†‘) (fun i â†¦ âŸ¨_, hxd _ i.2âŸ©) (by simpa using hx),
    TopologicalSpace.Opens.mem_iSup] at this
  obtain âŸ¨i, hiâŸ© := this
  have : Set.range iâ‚ âŠ† (Proj.awayÎ¹ ð’œ _ (hxd i i.2) (hd i i.2).bot_lt).opensRange := by
    rw [Proj.opensRange_awayÎ¹]
    rintro _ âŸ¨x, rflâŸ©
    obtain rfl := Subsingleton.elim x (IsLocalRing.closedPoint K)
    exact hi
  let Ï† : Spec (.of <| K) âŸ¶ _ := IsOpenImmersion.lift _ _ this
  have H : Spec.preimage iâ‚‚ â‰« CommRingCat.ofHom (algebraMap O K) =
      CommRingCat.ofHom (fromZeroRingHom ð’œ _) â‰« Spec.preimage Ï† := by
    apply Spec.map_injective
    simp only [Spec.map_comp, Spec.map_preimage, â† w.w]
    rw [â† Proj.awayÎ¹_toSpecZero _ _ (hxd i i.2), IsOpenImmersion.lift_fac_assoc]
    exact Nat.zero_lt_of_ne_zero (hd i i.2)
  obtain âŸ¨iâ‚€, Ï†', hÏ†, hÏ†'âŸ© :=
    valuativeCriterion_existence_aux ð’œ (Spec.preimage iâ‚‚).hom x (â†‘) (by simpa using hx) i
      (O := O) (K := K) (Spec.preimage Ï†).hom congr(($H).hom)
      (fun i â†¦ d _ i.2) (fun i â†¦ (hd _ i.2).bot_lt) (fun i â†¦ hxd _ i.2)
  let e : O â‰ƒ+* (algebraMap O K).range :=
    (AlgEquiv.ofInjective (Algebra.ofId O K) (IsFractionRing.injective _ _)).toRingEquiv
  let Ï†'' := e.symm.toRingHom.comp ((Subring.inclusion hÏ†').comp (RingHom.rangeRestrict _))
  have hÏ†'' : (algebraMap O K).comp Ï†'' = Ï†'.comp (awayMap ð’œ (hxd _ i.2) (mul_comm _ _)) := by
    ext x
    exact congr_arg Subtype.val (e.apply_symm_apply _)
  refine âŸ¨âŸ¨Spec.map (CommRingCat.ofHom Ï†'') â‰« Proj.awayÎ¹ ð’œ _ (hxd _ iâ‚€.2) (hd _ _).bot_lt, ?_, ?_âŸ©âŸ©
  Â· rw [â† Spec.map_comp_assoc]
    convert IsOpenImmersion.lift_fac _ _ this using 1
    change _ = Ï† â‰« _
    rw [â† Spec.map_preimage Ï†, â† CommRingCat.ofHom_hom (Spec.preimage Ï†), â† hÏ†,
      â† CommRingCat.ofHom_comp]
    simp [hÏ†'', SpecMap_awayMap_awayÎ¹, add_comm]
  Â· simp only [Category.assoc, Proj.awayÎ¹_toSpecZero, â† Spec.map_comp]
    conv_rhs => rw [â† Spec.map_preimage iâ‚‚]
    congr 1
    ext x
    apply IsFractionRing.injective O K
    refine (DFunLike.congr_fun hÏ†'' (fromZeroRingHom ð’œ _ _)).trans ?_
    simp only [RingHom.coe_comp, Function.comp_apply]
    rw [awayMap_fromZeroRingHom, â† awayMap_fromZeroRingHom ð’œ (hxd iâ‚€ iâ‚€.2) rfl,
      â† RingHom.comp_apply, hÏ†]
    exact congr($(H.symm) x)
","lemma valuativeCriterion_existence [Algebra.FiniteType (ð’œ 0) A] :
    ValuativeCriterion.Existence (Proj.toSpecZero ð’œ) ","Proof.\n      The uniqueness part follows from the fact that $\\text{Proj}(S)$ is separated (Lemma 27.8.8 [[\n  Lemma 27.8.8. Let $S$ be a graded ring. The scheme $\\text{Proj}(S)$ is separated. \n\n    \n]] and Schemes, Lemma 26.22.1 [[\n  Lemma 26.22.1. Let $f : X \\to S$ be a morphism of schemes. If $f$ is separated, then $f$ satisfies the uniqueness part of the valuative criterion. \n\n    \n]]). Choose $x_ i \\in S_{+}$ homogeneous, $i = 1, \\ldots , n$ which generate $S$ over $S_0$. Let $d_ i = \\deg (x_ i)$ and set $d = \\text{lcm}\\{ d_ i\\} $. Suppose we are given a diagram \n    \n      \n  \\[  \\xymatrix{ \\mathop{\\mathrm{Spec}}(K) \\ar[r] \\ar[d] &  \\text{Proj}(S) \\ar[d] \\\\  \\mathop{\\mathrm{Spec}}(A) \\ar[r] &  \\mathop{\\mathrm{Spec}}(S_0) }  \\]\n\n    \n       as in Schemes, Definition 26.20.3 [[\n  Definition 26.20.3. Let $f : X \\to S$ be a morphism of schemes. We say $f$ satisfies the existence part of the valuative criterion if given any commutative solid diagram \n  \n  \\[  \\xymatrix{ \\mathop{\\mathrm{Spec}}(K) \\ar[r] \\ar[d] &  X \\ar[d] \\\\  \\mathop{\\mathrm{Spec}}(A) \\ar[r] \\ar@{-->}[ru] &  S }  \\]\n\n   where $A$ is a valuation ring with field of fractions $K$, the dotted arrow exists. We say $f$ satisfies the uniqueness part of the valuative criterion if there is at most one dotted arrow given any diagram as above (without requiring existence of course). \n]]. Denote $v : K^* \\to \\Gamma $ the valuation of $A$, see Algebra, Definition 10.50.13 [[\n  Definition 10.50.13. Let $A$ be a valuation ring. \n  \n  \nThe totally ordered abelian group $(\\Gamma , \\geq )$ of Lemma 10.50.12 is called the value group of the valuation ring $A$. \n\n\nThe map $v : A - \\{ 0\\}  \\to \\Gamma $ and also $v : K^* \\to \\Gamma $ is called the valuation associated to $A$. \n\n\nThe valuation ring $A$ is called a discrete valuation ring if $\\Gamma \\cong \\mathbf{Z}$. \n\n\n\n]]. We may choose an $f \\in S_{+}$ homogeneous such that $\\mathop{\\mathrm{Spec}}(K)$ maps into $D_{+}(f)$. Then we get a commutative diagram of ring maps \n    \n      \n  \\[  \\xymatrix{ K &  S_{(f)} \\ar[l]^{\\varphi } \\\\  A \\ar[u] &  S_0 \\ar[l] \\ar[u] }  \\]\n\n    \n       After renumbering we may assume that $\\varphi (x_ i^{\\deg (f)}/f^{d_ i})$ is nonzero for $i = 1, \\ldots , r$ and zero for $i = r + 1, \\ldots , n$. Since the open sets $D_{+}(x_ i)$ cover $\\text{Proj}(S)$ we see that $r \\geq 1$. Let $i_0 \\in \\{ 1, \\ldots , r\\} $ be an index minimizing $\\gamma _ i = (d/d_ i)v(\\varphi (x_ i^{\\deg (f)}/f^{d_ i}))$ in $\\Gamma $. For convenience set $x_0 = x_{i_0}$ and $d_0 = d_{i_0}$. The ring map $\\varphi $ factors though a map $\\varphi \' : S_{(fx_0)} \\to K$ which gives a ring map $S_{(x_0)} \\to S_{(fx_0)} \\to K$. The algebra $S_{(x_0)}$ is generated over $S_0$ by the elements $x_1^{e_1} \\ldots x_ n^{e_ n}/x_0^{e_0}$, where $\\sum e_ i d_ i = e_0 d_0$. If $e_ i > 0$ for some $i > r$, then $\\varphi \'(x_1^{e_1} \\ldots x_ n^{e_ n}/x_0^{e_0}) = 0$. If $e_ i = 0$ for $i > r$, then we have \n    \n      \n  \\begin{align*}  d \\deg (f) v(\\varphi \'(x_1^{e_1} \\ldots x_ r^{e_ r}/x_0^{e_0})) &  = d v(\\varphi \'(x_1^{e_1 \\deg (f)} \\ldots x_ r^{e_ r \\deg (f)}/x_0^{e_0 \\deg (f)})) \\\\ &  = d \\sum e_ i v(\\varphi \'(x_ i^{\\deg (f)}/f^{d_ i})) - e_0 v(\\varphi \'(x_0^{\\deg (f)}/f^{d_0})) \\\\ &  = \\sum e_ i d_ i \\gamma _ i - e_0 d_0 \\gamma _0 \\\\ &  \\geq \\sum e_ i d_ i \\gamma _0 - e_0 d_0 \\gamma _0 = 0 \\end{align*}\n\n    \n       because $\\gamma _0$ is minimal among the $\\gamma _ i$. This implies that $S_{(x_0)}$ maps into $A$ via $\\varphi \'$. The corresponding morphism of schemes $\\mathop{\\mathrm{Spec}}(A) \\to \\mathop{\\mathrm{Spec}}(S_{(x_0)}) = D_{+}(x_0) \\subset \\text{Proj}(S)$ provides the morphism fitting into the first commutative diagram of this proof. \n      $\\square$\n    \n"
64,01JJ,"theorem isRepresentable : F.1.IsRepresentable :=
  âŸ¨_, âŸ¨representableBy hfâŸ©âŸ©
",Formal Proof of Stacks Project Tag 01JJ,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/AlgebraicGeometry/Sites/Representability.lean#L200-L201,Q27041,,26.15.4,lemma,3.0,"['01JF', '01H8', '0ELP']","\n  Lemma 26.15.4. Let $F$ be a contravariant functor on the category of schemes with values in the category of sets. Suppose that \n  \n  \n$F$ satisfies the sheaf property for the Zariski topology, \n\n\nthere exists a set $I$ and a collection of subfunctors $F_ i \\subset F$ such that \n\n\n  \neach $F_ i$ is representable, \n\n\neach $F_ i \\subset F$ is representable by open immersions, and \n\n\nthe collection $(F_ i)_{i \\in I}$ covers $F$. \n\n\n\n\n\n   Then $F$ is representable. \n\n    \n      Proof.\n      Let $X_ i$ be a scheme representing $F_ i$ and let $\\xi _ i \\in F_ i(X_ i) \\subset F(X_ i)$ be the \xe2\x80\x9cuniversal family\xe2\x80\x9d. Because $F_ j \\subset F$ is representable by open immersions, there exists an open $U_{ij} \\subset X_ i$ such that $T \\to X_ i$ factors through $U_{ij}$ if and only if $\\xi _ i|_ T \\in F_ j(T)$. In particular $\\xi _ i|_{U_{ij}} \\in F_ j(U_{ij})$ and therefore we obtain a canonical morphism $\\varphi _{ij} : U_{ij} \\to X_ j$ such that $\\varphi _{ij}^*\\xi _ j = \\xi _ i|_{U_{ij}}$. By definition of $U_{ji}$ this implies that $\\varphi _{ij}$ factors through $U_{ji}$. Since $(\\varphi _{ij} \\circ \\varphi _{ji})^*\\xi _ j =\\varphi _{ji}^*(\\varphi _{ij}^*\\xi _ j) = \\varphi _{ji}^*\\xi _ i = \\xi _ j$ we conclude that $\\varphi _{ij} \\circ \\varphi _{ji} = \\text{id}_{U_{ji}}$ because the pair $(X_ j, \\xi _ j)$ represents $F_ j$. In particular the maps $\\varphi _{ij} : U_{ij} \\to U_{ji}$ are isomorphisms of schemes. Next we have to show that $\\varphi _{ij}^{-1}(U_{ji} \\cap U_{jk}) = U_{ij} \\cap U_{ik}$. This is true because (a) $U_{ji} \\cap U_{jk}$ is the largest open of $U_{ji}$ such that $\\xi _ j$ restricts to an element of $F_ k$, (b) $U_{ij} \\cap U_{ik}$ is the largest open of $U_{ij}$ such that $\\xi _ i$ restricts to an element of $F_ k$, and (c) $\\varphi _{ij}^*\\xi _ j = \\xi _ i$. Moreover, the cocycle condition in Section 26.14 follows because both $\\varphi _{jk}|_{U_{ji} \\cap U_{jk}} \\circ \\varphi _{ij}|_{U_{ij} \\cap U_{ik}}$ and $\\varphi _{ik}|_{U_{ij} \\cap U_{ik}}$ pullback $\\xi _ k$ to the element $\\xi _ i$. Thus we may apply Lemma 26.14.2 to obtain a scheme $X$ with an open covering $X = \\bigcup U_ i$ and isomorphisms $\\varphi _ i : X_ i \\to U_ i$ with properties as in Lemma 26.14.1. Let $\\xi _ i\' = (\\varphi _ i^{-1})^* \\xi _ i$. The conditions of Lemma 26.14.1 imply that $\\xi _ i\'|_{U_ i \\cap U_ j} = \\xi _ j\'|_{U_ i \\cap U_ j}$. Therefore, by the condition that $F$ satisfies the sheaf condition in the Zariski topology we see that there exists an element $\\xi \' \\in F(X)$ such that $\\xi _ i = \\varphi _ i^*\\xi \'|_{U_ i}$ for all $i$. Since $\\varphi _ i$ is an isomorphism we also get that $(U_ i, \\xi \'|_{U_ i})$ represents the functor $F_ i$. \n    \n      We claim that the pair $(X, \\xi \')$ represents the functor $F$. To show this, let $T$ be a scheme and let $\\xi \\in F(T)$. We will construct a unique morphism $g : T \\to X$ such that $g^*\\xi \' = \\xi $. Namely, by the condition that the subfunctors $F_ i$ cover $F$ there exists an open covering $T = \\bigcup V_ i$ such that for each $i$ the restriction $\\xi |_{V_ i} \\in F_ i(V_ i)$. Moreover, since each of the inclusions $F_ i \\subset F$ are representable by open immersions we may assume that each $V_ i \\subset T$ is maximal open with this property. Because, $(U_ i, \\xi \'|_{U_ i})$ represents the functor $F_ i$ we get a unique morphism $g_ i : V_ i \\to U_ i$ such that $g_ i^*\\xi \'|_{U_ i} = \\xi |_{V_ i}$. On the overlaps $V_ i \\cap V_ j$ the morphisms $g_ i$ and $g_ j$ agree, for example because they both pull back $\\xi \'|_{U_ i \\cap U_ j} \\in F_ i(U_ i \\cap U_ j)$ to the same element. Thus the morphisms $g_ i$ glue to a unique morphism from $T \\to X$ as desired. \n      $\\square$\n    \n","\n  Lemma 26.15.4. Let $F$ be a contravariant functor on the category of schemes with values in the category of sets. Suppose that \n  \n  \n$F$ satisfies the sheaf property for the Zariski topology, \n\n\nthere exists a set $I$ and a collection of subfunctors $F_ i \\subset F$ such that \n\n\n  \neach $F_ i$ is representable, \n\n\neach $F_ i \\subset F$ is representable by open immersions, and \n\n\nthe collection $(F_ i)_{i \\in I}$ covers $F$. \n\n\n\n\n\n   Then $F$ is representable. \n\n    \n","Proof.\n      Let $X_ i$ be a scheme representing $F_ i$ and let $\\xi _ i \\in F_ i(X_ i) \\subset F(X_ i)$ be the \xe2\x80\x9cuniversal family\xe2\x80\x9d. Because $F_ j \\subset F$ is representable by open immersions, there exists an open $U_{ij} \\subset X_ i$ such that $T \\to X_ i$ factors through $U_{ij}$ if and only if $\\xi _ i|_ T \\in F_ j(T)$. In particular $\\xi _ i|_{U_{ij}} \\in F_ j(U_{ij})$ and therefore we obtain a canonical morphism $\\varphi _{ij} : U_{ij} \\to X_ j$ such that $\\varphi _{ij}^*\\xi _ j = \\xi _ i|_{U_{ij}}$. By definition of $U_{ji}$ this implies that $\\varphi _{ij}$ factors through $U_{ji}$. Since $(\\varphi _{ij} \\circ \\varphi _{ji})^*\\xi _ j =\\varphi _{ji}^*(\\varphi _{ij}^*\\xi _ j) = \\varphi _{ji}^*\\xi _ i = \\xi _ j$ we conclude that $\\varphi _{ij} \\circ \\varphi _{ji} = \\text{id}_{U_{ji}}$ because the pair $(X_ j, \\xi _ j)$ represents $F_ j$. In particular the maps $\\varphi _{ij} : U_{ij} \\to U_{ji}$ are isomorphisms of schemes. Next we have to show that $\\varphi _{ij}^{-1}(U_{ji} \\cap U_{jk}) = U_{ij} \\cap U_{ik}$. This is true because (a) $U_{ji} \\cap U_{jk}$ is the largest open of $U_{ji}$ such that $\\xi _ j$ restricts to an element of $F_ k$, (b) $U_{ij} \\cap U_{ik}$ is the largest open of $U_{ij}$ such that $\\xi _ i$ restricts to an element of $F_ k$, and (c) $\\varphi _{ij}^*\\xi _ j = \\xi _ i$. Moreover, the cocycle condition in Section 26.14 follows because both $\\varphi _{jk}|_{U_{ji} \\cap U_{jk}} \\circ \\varphi _{ij}|_{U_{ij} \\cap U_{ik}}$ and $\\varphi _{ik}|_{U_{ij} \\cap U_{ik}}$ pullback $\\xi _ k$ to the element $\\xi _ i$. Thus we may apply Lemma 26.14.2 to obtain a scheme $X$ with an open covering $X = \\bigcup U_ i$ and isomorphisms $\\varphi _ i : X_ i \\to U_ i$ with properties as in Lemma 26.14.1. Let $\\xi _ i\' = (\\varphi _ i^{-1})^* \\xi _ i$. The conditions of Lemma 26.14.1 imply that $\\xi _ i\'|_{U_ i \\cap U_ j} = \\xi _ j\'|_{U_ i \\cap U_ j}$. Therefore, by the condition that $F$ satisfies the sheaf condition in the Zariski topology we see that there exists an element $\\xi \' \\in F(X)$ such that $\\xi _ i = \\varphi _ i^*\\xi \'|_{U_ i}$ for all $i$. Since $\\varphi _ i$ is an isomorphism we also get that $(U_ i, \\xi \'|_{U_ i})$ represents the functor $F_ i$. \n    \n      We claim that the pair $(X, \\xi \')$ represents the functor $F$. To show this, let $T$ be a scheme and let $\\xi \\in F(T)$. We will construct a unique morphism $g : T \\to X$ such that $g^*\\xi \' = \\xi $. Namely, by the condition that the subfunctors $F_ i$ cover $F$ there exists an open covering $T = \\bigcup V_ i$ such that for each $i$ the restriction $\\xi |_{V_ i} \\in F_ i(V_ i)$. Moreover, since each of the inclusions $F_ i \\subset F$ are representable by open immersions we may assume that each $V_ i \\subset T$ is maximal open with this property. Because, $(U_ i, \\xi \'|_{U_ i})$ represents the functor $F_ i$ we get a unique morphism $g_ i : V_ i \\to U_ i$ such that $g_ i^*\\xi \'|_{U_ i} = \\xi |_{V_ i}$. On the overlaps $V_ i \\cap V_ j$ the morphisms $g_ i$ and $g_ j$ agree, for example because they both pull back $\\xi \'|_{U_ i \\cap U_ j} \\in F_ i(U_ i \\cap U_ j)$ to the same element. Thus the morphisms $g_ i$ glue to a unique morphism from $T \\to X$ as desired. \n      $\\square$\n    \n","
  âŸ¨_, âŸ¨representableBy hfâŸ©âŸ©
",theorem isRepresentable : F.1.IsRepresentable ,"Proof.\n      Let $X_ i$ be a scheme representing $F_ i$ and let $\\xi _ i \\in F_ i(X_ i) \\subset F(X_ i)$ be the \xe2\x80\x9cuniversal family\xe2\x80\x9d. Because $F_ j \\subset F$ is representable by open immersions, there exists an open $U_{ij} \\subset X_ i$ such that $T \\to X_ i$ factors through $U_{ij}$ if and only if $\\xi _ i|_ T \\in F_ j(T)$. In particular $\\xi _ i|_{U_{ij}} \\in F_ j(U_{ij})$ and therefore we obtain a canonical morphism $\\varphi _{ij} : U_{ij} \\to X_ j$ such that $\\varphi _{ij}^*\\xi _ j = \\xi _ i|_{U_{ij}}$. By definition of $U_{ji}$ this implies that $\\varphi _{ij}$ factors through $U_{ji}$. Since $(\\varphi _{ij} \\circ \\varphi _{ji})^*\\xi _ j =\\varphi _{ji}^*(\\varphi _{ij}^*\\xi _ j) = \\varphi _{ji}^*\\xi _ i = \\xi _ j$ we conclude that $\\varphi _{ij} \\circ \\varphi _{ji} = \\text{id}_{U_{ji}}$ because the pair $(X_ j, \\xi _ j)$ represents $F_ j$. In particular the maps $\\varphi _{ij} : U_{ij} \\to U_{ji}$ are isomorphisms of schemes. Next we have to show that $\\varphi _{ij}^{-1}(U_{ji} \\cap U_{jk}) = U_{ij} \\cap U_{ik}$. This is true because (a) $U_{ji} \\cap U_{jk}$ is the largest open of $U_{ji}$ such that $\\xi _ j$ restricts to an element of $F_ k$, (b) $U_{ij} \\cap U_{ik}$ is the largest open of $U_{ij}$ such that $\\xi _ i$ restricts to an element of $F_ k$, and (c) $\\varphi _{ij}^*\\xi _ j = \\xi _ i$. Moreover, the cocycle condition in Section 26.14 [[26.14 Glueing schemes\n\n\nLet $I$ be a set. For each $i \\in I$ let $(X_ i, \\mathcal{O}_ i)$ be a locally ringed space. (Actually the construction that follows works equally well for ringed spaces.) For each pair $i, j \\in I$ let $U_{ij} \\subset X_ i$ be an open subspace. For each pair $i, j \\in I$, let \n\n\n  \\[  \\varphi _{ij} : U_{ij} \\to U_{ji}  \\]\n\n\n be an isomorphism of locally ringed spaces. For convenience we assume that $U_{ii} = X_ i$. For each triple $i, j, k \\in I$ assume that \n\n\n  \nwe have $\\varphi _{ij}^{-1}(U_{ji} \\cap U_{jk}) = U_{ij} \\cap U_{ik}$, and \n\n\nthe diagram \n\n\n  \\[  \\xymatrix{ U_{ij} \\cap U_{ik} \\ar[rr]_{\\varphi _{ik}} \\ar[rd]_{\\varphi _{ij}} &  &  U_{ki} \\cap U_{kj} \\\\  &  U_{ji} \\cap U_{jk} \\ar[ru]_{\\varphi _{jk}} }  \\]\n\n\n is commutative. \n\n\n\n\n (In particular, it follows that $\\varphi _{ii} = \\text{id}_{X_ i}$.) Let us call a collection $(I, (X_ i)_{i\\in I}, (U_{ij})_{i, j\\in I}, (\\varphi _{ij})_{i, j\\in I})$ satisfying the conditions above a glueing data. \n\n\n\n       \n      \n  Lemma 26.14.1. Given any glueing data of locally ringed spaces there exists a locally ringed space $X$ and open subspaces $U_ i \\subset X$ together with isomorphisms $\\varphi _ i : X_ i \\to U_ i$ of locally ringed spaces such that \n  \n  \n$X=\\bigcup _{i\\in I} U_ i$, \n\n\n$\\varphi _ i(U_{ij}) = U_ i \\cap U_ j$, and \n\n\n$\\varphi _{ij} = \\varphi _ j^{-1}|_{U_ i \\cap U_ j} \\circ \\varphi _ i|_{U_{ij}}$. \n\n\n\n   The locally ringed space $X$ is characterized by the following mapping properties: Given a locally ringed space $Y$ we have \n  \n  \\begin{eqnarray*}  \\mathop{\\mathrm{Mor}}\\nolimits (X, Y) &  = &  \\{  (f_ i)_{i\\in I} \\mid f_ i : X_ i \\to Y, \\  f_ j \\circ \\varphi _{ij} = f_ i|_{U_{ij}}\\}  \\\\  f &  \\mapsto &  (f|_{U_ i} \\circ \\varphi _ i)_{i \\in I} \\\\  \\mathop{\\mathrm{Mor}}\\nolimits (Y, X) &  = &  \\left\\{  \\begin{matrix}  \\text{open covering }Y = \\bigcup \\nolimits _{i \\in I} V_ i\\text{ and } (g_ i : V_ i \\to X_ i)_{i \\in I} \\text{ such that}\n\n\\\\  g_ i^{-1}(U_{ij}) = V_ i \\cap V_ j \\text{ and } g_ j|_{V_ i \\cap V_ j} = \\varphi _{ij} \\circ g_ i|_{V_ i \\cap V_ j} \n\n\\end{matrix} \\right\\}  \\\\  g &  \\mapsto &  V_ i = g^{-1}(U_ i), \\  g_ i = \\varphi _ i^{-1} \\circ g|_{V_ i} \\end{eqnarray*}\n\n \n\n\n    \n]] follows because both $\\varphi _{jk}|_{U_{ji} \\cap U_{jk}} \\circ \\varphi _{ij}|_{U_{ij} \\cap U_{ik}}$ and $\\varphi _{ik}|_{U_{ij} \\cap U_{ik}}$ pullback $\\xi _ k$ to the element $\\xi _ i$. Thus we may apply Lemma 26.14.2 [[\n       \n      \n  Lemma 26.14.2. In Lemma 26.14.1 above, assume that all $X_ i$ are schemes. Then the resulting locally ringed space $X$ is a scheme. \n\n    \n]] to obtain a scheme $X$ with an open covering $X = \\bigcup U_ i$ and isomorphisms $\\varphi _ i : X_ i \\to U_ i$ with properties as in Lemma 26.14.1 [[\n       \n      \n  Lemma 26.14.1. Given any glueing data of locally ringed spaces there exists a locally ringed space $X$ and open subspaces $U_ i \\subset X$ together with isomorphisms $\\varphi _ i : X_ i \\to U_ i$ of locally ringed spaces such that \n  \n  \n$X=\\bigcup _{i\\in I} U_ i$, \n\n\n$\\varphi _ i(U_{ij}) = U_ i \\cap U_ j$, and \n\n\n$\\varphi _{ij} = \\varphi _ j^{-1}|_{U_ i \\cap U_ j} \\circ \\varphi _ i|_{U_{ij}}$. \n\n\n\n   The locally ringed space $X$ is characterized by the following mapping properties: Given a locally ringed space $Y$ we have \n  \n  \\begin{eqnarray*}  \\mathop{\\mathrm{Mor}}\\nolimits (X, Y) &  = &  \\{  (f_ i)_{i\\in I} \\mid f_ i : X_ i \\to Y, \\  f_ j \\circ \\varphi _{ij} = f_ i|_{U_{ij}}\\}  \\\\  f &  \\mapsto &  (f|_{U_ i} \\circ \\varphi _ i)_{i \\in I} \\\\  \\mathop{\\mathrm{Mor}}\\nolimits (Y, X) &  = &  \\left\\{  \\begin{matrix}  \\text{open covering }Y = \\bigcup \\nolimits _{i \\in I} V_ i\\text{ and } (g_ i : V_ i \\to X_ i)_{i \\in I} \\text{ such that}\n\n\\\\  g_ i^{-1}(U_{ij}) = V_ i \\cap V_ j \\text{ and } g_ j|_{V_ i \\cap V_ j} = \\varphi _{ij} \\circ g_ i|_{V_ i \\cap V_ j} \n\n\\end{matrix} \\right\\}  \\\\  g &  \\mapsto &  V_ i = g^{-1}(U_ i), \\  g_ i = \\varphi _ i^{-1} \\circ g|_{V_ i} \\end{eqnarray*}\n\n\n    \n]]. Let $\\xi _ i\' = (\\varphi _ i^{-1})^* \\xi _ i$. The conditions of Lemma 26.14.1 [[\n       \n      \n  Lemma 26.14.1. Given any glueing data of locally ringed spaces there exists a locally ringed space $X$ and open subspaces $U_ i \\subset X$ together with isomorphisms $\\varphi _ i : X_ i \\to U_ i$ of locally ringed spaces such that \n  \n  \n$X=\\bigcup _{i\\in I} U_ i$, \n\n\n$\\varphi _ i(U_{ij}) = U_ i \\cap U_ j$, and \n\n\n$\\varphi _{ij} = \\varphi _ j^{-1}|_{U_ i \\cap U_ j} \\circ \\varphi _ i|_{U_{ij}}$. \n\n\n\n   The locally ringed space $X$ is characterized by the following mapping properties: Given a locally ringed space $Y$ we have \n  \n  \\begin{eqnarray*}  \\mathop{\\mathrm{Mor}}\\nolimits (X, Y) &  = &  \\{  (f_ i)_{i\\in I} \\mid f_ i : X_ i \\to Y, \\  f_ j \\circ \\varphi _{ij} = f_ i|_{U_{ij}}\\}  \\\\  f &  \\mapsto &  (f|_{U_ i} \\circ \\varphi _ i)_{i \\in I} \\\\  \\mathop{\\mathrm{Mor}}\\nolimits (Y, X) &  = &  \\left\\{  \\begin{matrix}  \\text{open covering }Y = \\bigcup \\nolimits _{i \\in I} V_ i\\text{ and } (g_ i : V_ i \\to X_ i)_{i \\in I} \\text{ such that}\n\n\\\\  g_ i^{-1}(U_{ij}) = V_ i \\cap V_ j \\text{ and } g_ j|_{V_ i \\cap V_ j} = \\varphi _{ij} \\circ g_ i|_{V_ i \\cap V_ j} \n\n\\end{matrix} \\right\\}  \\\\  g &  \\mapsto &  V_ i = g^{-1}(U_ i), \\  g_ i = \\varphi _ i^{-1} \\circ g|_{V_ i} \\end{eqnarray*}\n\n\n    \n]] imply that $\\xi _ i\'|_{U_ i \\cap U_ j} = \\xi _ j\'|_{U_ i \\cap U_ j}$. Therefore, by the condition that $F$ satisfies the sheaf condition in the Zariski topology we see that there exists an element $\\xi \' \\in F(X)$ such that $\\xi _ i = \\varphi _ i^*\\xi \'|_{U_ i}$ for all $i$. Since $\\varphi _ i$ is an isomorphism we also get that $(U_ i, \\xi \'|_{U_ i})$ represents the functor $F_ i$. \n    \n      We claim that the pair $(X, \\xi \')$ represents the functor $F$. To show this, let $T$ be a scheme and let $\\xi \\in F(T)$. We will construct a unique morphism $g : T \\to X$ such that $g^*\\xi \' = \\xi $. Namely, by the condition that the subfunctors $F_ i$ cover $F$ there exists an open covering $T = \\bigcup V_ i$ such that for each $i$ the restriction $\\xi |_{V_ i} \\in F_ i(V_ i)$. Moreover, since each of the inclusions $F_ i \\subset F$ are representable by open immersions we may assume that each $V_ i \\subset T$ is maximal open with this property. Because, $(U_ i, \\xi \'|_{U_ i})$ represents the functor $F_ i$ we get a unique morphism $g_ i : V_ i \\to U_ i$ such that $g_ i^*\\xi \'|_{U_ i} = \\xi |_{V_ i}$. On the overlaps $V_ i \\cap V_ j$ the morphisms $g_ i$ and $g_ j$ agree, for example because they both pull back $\\xi \'|_{U_ i \\cap U_ j} \\in F_ i(U_ i \\cap U_ j)$ to the same element. Thus the morphisms $g_ i$ glue to a unique morphism from $T \\to X$ as desired. \n      $\\square$\n    \n"
65,02C3,"instance full_functor (e : C â‰Œ E) : e.functor.Full :=
  e.fullyFaithfulFunctor.full
",Formal Proof of Stacks Project Tag 02C3,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Equivalence.lean#L559-L560,Q27041,,4.2.19,lemma,3.0,"['0013', '0011', '0ELQ']","\n  Lemma 4.2.19. A functor is an equivalence of categories if and only if it is both fully faithful and essentially surjective. \n\n    \n      Proof.\n      Let $F : \\mathcal{A} \\to \\mathcal{B}$ be essentially surjective and fully faithful. As by convention all categories are small and as $F$ is essentially surjective we can, using the axiom of choice, choose for every $X \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{B})$ an object $j(X)$ of $\\mathcal{A}$ and an isomorphism $i_ X : X \\to F(j(X))$. Then we apply Lemma 4.2.18 using that $F$ is fully faithful. \n      $\\square$\n    \n",\n  Lemma 4.2.19. A functor is an equivalence of categories if and only if it is both fully faithful and essentially surjective. \n\n    \n,"Proof.\n      Let $F : \\mathcal{A} \\to \\mathcal{B}$ be essentially surjective and fully faithful. As by convention all categories are small and as $F$ is essentially surjective we can, using the axiom of choice, choose for every $X \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{B})$ an object $j(X)$ of $\\mathcal{A}$ and an isomorphism $i_ X : X \\to F(j(X))$. Then we apply Lemma 4.2.18 using that $F$ is fully faithful. \n      $\\square$\n    \n","
  e.fullyFaithfulFunctor.full
",instance full_functor (e : C â‰Œ E) : e.functor.Full ,"Proof.\n      Let $F : \\mathcal{A} \\to \\mathcal{B}$ be essentially surjective and fully faithful. As by convention all categories are small and as $F$ is essentially surjective we can, using the axiom of choice, choose for every $X \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{B})$ an object $j(X)$ of $\\mathcal{A}$ and an isomorphism $i_ X : X \\to F(j(X))$. Then we apply Lemma 4.2.18 [[\n  Lemma 4.2.18. Let $F : \\mathcal{A} \\to \\mathcal{B}$ be a fully faithful functor. Suppose for every $X \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{B})$ we are given an object $j(X)$ of $\\mathcal{A}$ and an isomorphism $i_ X : X \\to F(j(X))$. Then there is a unique functor $j : \\mathcal{B} \\to \\mathcal{A}$ such that $j$ extends the rule on objects, and the isomorphisms $i_ X$ define an isomorphism of functors $\\text{id}_\\mathcal {B} \\to F \\circ j$. Moreover, $j$ and $F$ are quasi-inverse equivalences of categories. \n\n    \n]] using that $F$ is fully faithful. \n      $\\square$\n    \n"
66,001C,"class Faithful (F : C â¥¤ D) : Prop where
  /-- `F.map` is injective for each `X Y : C`. -/
  map_injective : âˆ€ {X Y : C}, Function.Injective (F.map : (X âŸ¶ Y) â†’ (F.obj X âŸ¶ F.obj Y)) := by
    cat_disch
",Formal Proof of Stacks Project Tag 001C,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Functor/FullyFaithful.lean#L50-L53,Q27041,,4.2.9,definition,3.0,"['0013', '0011', '0ELQ']","\n  Definition 4.2.9. Let $F : \\mathcal{A} \\to \\mathcal{B}$ be a functor. \n  \n  \nWe say $F$ is faithful if for any objects $x, y \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{A})$ the map \n\n\n  \\[  F : \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {A}(x, y) \\to \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {B}(F(x), F(y))  \\]\n\n\n is injective. \n\n\nIf these maps are all bijective then $F$ is called fully faithful. \n\n\nThe functor $F$ is called essentially surjective if for any object $y \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{B})$ there exists an object $x \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{A})$ such that $F(x)$ is isomorphic to $y$ in $\\mathcal{B}$. \n\n\n\n","\n  Definition 4.2.9. Let $F : \\mathcal{A} \\to \\mathcal{B}$ be a functor. \n  \n  \nWe say $F$ is faithful if for any objects $x, y \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{A})$ the map \n\n\n  \\[  F : \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {A}(x, y) \\to \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {B}(F(x), F(y))  \\]\n\n\n is injective. \n\n\nIf these maps are all bijective then $F$ is called fully faithful. \n\n\nThe functor $F$ is called essentially surjective if for any object $y \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{B})$ there exists an object $x \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{A})$ such that $F(x)$ is isomorphic to $y$ in $\\mathcal{B}$. \n\n\n\n",," by
    cat_disch
","class Faithful (F : C â¥¤ D) : Prop where
  /-- `F.map` is injective for each `X Y : C`. -/
  map_injective : âˆ€ {X Y : C}, Function.Injective (F.map : (X âŸ¶ Y) â†’ (F.obj X âŸ¶ F.obj Y)) ",
67,002S,"class IsConnected (J : Type uâ‚) [Category.{vâ‚} J] : Prop extends IsPreconnected J where
  [is_nonempty : Nonempty J]
",Formal Proof of Stacks Project Tag 002S,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/IsConnected.lean#L76-L77,Q27041,,4.16.1,definition,3.0,"['04AQ', '0011', '0ELQ']","\n  Definition 4.16.1. We say that a category $\\mathcal{I}$ is connected if the equivalence relation generated by $x \\sim y \\Leftrightarrow \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {I}(x, y) \\not= \\emptyset $ has exactly one equivalence class. \n","\n  Definition 4.16.1. We say that a category $\\mathcal{I}$ is connected if the equivalence relation generated by $x \\sim y \\Leftrightarrow \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {I}(x, y) \\not= \\emptyset $ has exactly one equivalence class. \n",,,"class IsConnected (J : Type uâ‚) [Category.{vâ‚} J] : Prop extends IsPreconnected J where
  [is_nonempty : Nonempty J]
",
68,0017,"structure Iso {C : Type u} [Category.{v} C] (X Y : C) where
  /-- The forward direction of an isomorphism. -/
  hom : X âŸ¶ Y
  /-- The backwards direction of an isomorphism. -/
  inv : Y âŸ¶ X
  /-- Composition of the two directions of an isomorphism is the identity on the source. -/
  hom_inv_id : hom â‰« inv = ðŸ™ X := by cat_disch
  /-- Composition of the two directions of an isomorphism in reverse order
  is the identity on the target. -/
  inv_hom_id : inv â‰« hom = ðŸ™ Y := by cat_disch
",Formal Proof of Stacks Project Tag 0017,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Iso.lean#L53-L62,Q27041,,4.2.4,definition,3.0,"['0013', '0011', '0ELQ']",\n  Definition 4.2.4. A morphism $\\phi : x \\to y$ is an isomorphism of the category $\\mathcal{C}$ if there exists a morphism $\\psi : y \\to x$ such that $\\phi \\circ \\psi = \\text{id}_ y$ and $\\psi \\circ \\phi = \\text{id}_ x$. \n,\n  Definition 4.2.4. A morphism $\\phi : x \\to y$ is an isomorphism of the category $\\mathcal{C}$ if there exists a morphism $\\psi : y \\to x$ such that $\\phi \\circ \\psi = \\text{id}_ y$ and $\\psi \\circ \\phi = \\text{id}_ x$. \n,," by cat_disch
  /-- Composition of the two directions of an isomorphism in reverse order
  is the identity on the target. -/
  inv_hom_id : inv â‰« hom = ðŸ™ Y := by cat_disch
","structure Iso {C : Type u} [Category.{v} C] (X Y : C) where
  /-- The forward direction of an isomorphism. -/
  hom : X âŸ¶ Y
  /-- The backwards direction of an isomorphism. -/
  inv : Y âŸ¶ X
  /-- Composition of the two directions of an isomorphism is the identity on the source. -/
  hom_inv_id : hom â‰« inv = ðŸ™ X ",
69,001M,"instance Category.opposite : Category.{vâ‚} Cáµ’áµ– where
  __ := CategoryStruct.opposite
  comp_id f := by rw [â† op_comp_unop, unop_id, id_comp, Quiver.Hom.op_unop]
  id_comp f := by rw [â† op_comp_unop, unop_id, comp_id, Quiver.Hom.op_unop]
  assoc f g h := by simp only [â† op_comp_unop, Quiver.Hom.unop_op, assoc]
",Formal Proof of Stacks Project Tag 001M,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Opposites.lean#L111-L115,Q27041,,4.3.1,definition,3.0,"['001L', '0011', '0ELQ']",\n  Definition 4.3.1. Given a category $\\mathcal{C}$ the opposite category $\\mathcal{C}^{opp}$ is the category with the same objects as $\\mathcal{C}$ but all morphisms reversed. \n,\n  Definition 4.3.1. Given a category $\\mathcal{C}$ the opposite category $\\mathcal{C}^{opp}$ is the category with the same objects as $\\mathcal{C}$ but all morphisms reversed. \n,," CategoryStruct.opposite
  comp_id f := by rw [â† op_comp_unop, unop_id, id_comp, Quiver.Hom.op_unop]
  id_comp f := by rw [â† op_comp_unop, unop_id, comp_id, Quiver.Hom.op_unop]
  assoc f g h := by simp only [â† op_comp_unop, Quiver.Hom.unop_op, assoc]
","instance Category.opposite : Category.{vâ‚} Cáµ’áµ– where
  __ ",
70,0019,"instance groupoid : Groupoid (SingleObj G) where
  inv x := xâ»Â¹
  inv_comp := mul_inv_cancel
  comp_inv := inv_mul_cancel
",Formal Proof of Stacks Project Tag 0019,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/SingleObj.lean#L84-L87,Q27041,,4.2.6,example,3.0,"['0013', '0011', '0ELQ']","\n  Example 4.2.6. A group $G$ gives rise to a groupoid with a single object $x$ and morphisms $\\mathop{\\mathrm{Mor}}\\nolimits (x, x) = G$, with the composition rule given by the group law in $G$. Every groupoid with a single object is of this form. \n","\n  Example 4.2.6. A group $G$ gives rise to a groupoid with a single object $x$ and morphisms $\\mathop{\\mathrm{Mor}}\\nolimits (x, x) = G$, with the composition rule given by the group law in $G$. Every groupoid with a single object is of this form. \n",," xâ»Â¹
  inv_comp := mul_inv_cancel
  comp_inv := inv_mul_cancel
","instance groupoid : Groupoid (SingleObj G) where
  inv x ",
71,001F,"def mapHom : (M â†’* N) â‰ƒ SingleObj M â¥¤ SingleObj N where
  toFun f :=
    { obj := id
      map := â‡‘f
      map_id := fun _ => f.map_one
      map_comp := fun x y => f.map_mul y x }
  invFun f :=
    { toFun := fun x => f.map ((toEnd M) x)
      map_one' := f.map_id _
      map_mul' := fun x y => f.map_comp y x }
  left_inv := by cat_disch
  right_inv := by cat_disch
",Formal Proof of Stacks Project Tag 001F,We do not characterize when the functor is full or faithful.,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/SingleObj.lean#L112-L123,Q27041,,4.2.12,example,3.0,"['0013', '0011', '0ELQ']",\n  Example 4.2.12. A homomorphism $p : G\\to H$ of groups gives rise to a functor between the associated groupoids in Example 4.2.6. It is faithful (resp. fully faithful) if and only if $p$ is injective (resp. an isomorphism). \n,\n  Example 4.2.12. A homomorphism $p : G\\to H$ of groups gives rise to a functor between the associated groupoids in Example 4.2.6. It is faithful (resp. fully faithful) if and only if $p$ is injective (resp. an isomorphism). \n,,"
    { obj := id
      map := â‡‘f
      map_id := fun _ => f.map_one
      map_comp := fun x y => f.map_mul y x }
  invFun f :=
    { toFun := fun x => f.map ((toEnd M) x)
      map_one' := f.map_id _
      map_mul' := fun x y => f.map_comp y x }
  left_inv := by cat_disch
  right_inv := by cat_disch
","def mapHom : (M â†’* N) â‰ƒ SingleObj M â¥¤ SingleObj N where
  toFun f ",
72,001P,"def coyonedaLemma : coyonedaPairing C â‰… coyonedaEvaluation C :=
  NatIso.ofComponents
    (fun _ â†¦ Equiv.toIso (coyonedaEquiv.trans Equiv.ulift.symm))
    (by intro (X, F) (Y, G) f
        ext (a : coyoneda.obj (op X) âŸ¶ F)
        apply ULift.ext
        dsimp [coyonedaEquiv, coyonedaEvaluation]
        simp [â† FunctorToTypes.naturality])
",Formal Proof of Stacks Project Tag 001P,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Yoneda.lean#L935-L942,Q27041,Yoneda lemma,4.3.5,lemma,3.0,"['001L', '0011', '0ELQ']","\n        \n      \n  Lemma 4.3.5 (Yoneda lemma). Let $U, V \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{C})$. Given any morphism of functors $s : h_ U \\to h_ V$ there is a unique morphism $\\phi : U \\to V$ such that $h(\\phi ) = s$. In other words the functor $h$ is fully faithful. More generally, given any contravariant functor $F$ and any object $U$ of $\\mathcal{C}$ we have a natural bijection \n  \n  \\[  \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(h_ U, F) \\longrightarrow F(U), \\quad s \\longmapsto s_ U(\\text{id}_ U).  \\]\n\n\n    \n      Proof.\n      For the first statement, just take $\\phi = s_ U(\\text{id}_ U) \\in \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {C}(U, V)$. For the second statement, given $\\xi \\in F(U)$ define $s$ by $s_ V : h_ U(V) \\to F(V)$ by sending the element $f : V \\to U$ of $h_ U(V) = \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {C}(V, U)$ to $F(f)(\\xi )$. \n      $\\square$\n    \n","\n        \n      \n  Lemma 4.3.5 (Yoneda lemma). Let $U, V \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{C})$. Given any morphism of functors $s : h_ U \\to h_ V$ there is a unique morphism $\\phi : U \\to V$ such that $h(\\phi ) = s$. In other words the functor $h$ is fully faithful. More generally, given any contravariant functor $F$ and any object $U$ of $\\mathcal{C}$ we have a natural bijection \n  \n  \\[  \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(h_ U, F) \\longrightarrow F(U), \\quad s \\longmapsto s_ U(\\text{id}_ U).  \\]\n\n\n    \n","Proof.\n      For the first statement, just take $\\phi = s_ U(\\text{id}_ U) \\in \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {C}(U, V)$. For the second statement, given $\\xi \\in F(U)$ define $s$ by $s_ V : h_ U(V) \\to F(V)$ by sending the element $f : V \\to U$ of $h_ U(V) = \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {C}(V, U)$ to $F(f)(\\xi )$. \n      $\\square$\n    \n","
  NatIso.ofComponents
    (fun _ â†¦ Equiv.toIso (coyonedaEquiv.trans Equiv.ulift.symm))
    (by intro (X, F) (Y, G) f
        ext (a : coyoneda.obj (op X) âŸ¶ F)
        apply ULift.ext
        dsimp [coyonedaEquiv, coyonedaEvaluation]
        simp [â† FunctorToTypes.naturality])
",def coyonedaLemma : coyonedaPairing C â‰… coyonedaEvaluation C ,"Proof.\n      For the first statement, just take $\\phi = s_ U(\\text{id}_ U) \\in \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {C}(U, V)$. For the second statement, given $\\xi \\in F(U)$ define $s$ by $s_ V : h_ U(V) \\to F(V)$ by sending the element $f : V \\to U$ of $h_ U(V) = \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {C}(V, U)$ to $F(f)(\\xi )$. \n      $\\square$\n    \n"
73,001Q,"class IsCorepresentable (F : C â¥¤ Type v) : Prop where
  has_corepresentation : âˆƒ (X : C), Nonempty (F.CorepresentableBy X)
",Formal Proof of Stacks Project Tag 001Q,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Yoneda.lean#L459-L460,Q27041,,4.3.6,definition,3.0,"['001L', '0011', '0ELQ']",\n  Definition 4.3.6. A contravariant functor $F : \\mathcal{C}\\to \\textit{Sets}$ is said to be representable if it is isomorphic to the functor of points $h_ U$ for some object $U$ of $\\mathcal{C}$. \n,\n  Definition 4.3.6. A contravariant functor $F : \\mathcal{C}\\to \\textit{Sets}$ is said to be representable if it is isomorphic to the functor of points $h_ U$ for some object $U$ of $\\mathcal{C}$. \n,,,"class IsCorepresentable (F : C â¥¤ Type v) : Prop where
  has_corepresentation : âˆƒ (X : C), Nonempty (F.CorepresentableBy X)
",
74,0109,"""The Stacks project uses this characterisation at the definition of an abelian category.""]
def ofCoimageImageComparisonIsIso : Abelian C where
",Formal Proof of Stacks Project Tag 0109,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Abelian/Basic.lean#L252-L253,Q27041,,12.5.1,definition,3.0,"['00ZX', '00ZU', '0ELQ']","\n  Definition 12.5.1. A category $\\mathcal{A}$ is abelian if it is additive, if all kernels and cokernels exist, and if the natural map $\\mathop{\\mathrm{Coim}}(f) \\to \\mathop{\\mathrm{Im}}(f)$ is an isomorphism for all morphisms $f$ of $\\mathcal{A}$. \n","\n  Definition 12.5.1. A category $\\mathcal{A}$ is abelian if it is additive, if all kernels and cokernels exist, and if the natural map $\\mathop{\\mathrm{Coim}}(f) \\to \\mathop{\\mathrm{Im}}(f)$ is an isomorphism for all morphisms $f$ of $\\mathcal{A}$. \n",,,"""The Stacks project uses this characterisation at the definition of an abelian category.""]
def ofCoimageImageComparisonIsIso : Abelian C where
",
75,05PP,"theorem freyd_mitchell (C : Type u) [Category.{v} C] [Abelian C] :
    âˆƒ (R : Type (max u v)) (_ : Ring R) (F : C â¥¤ ModuleCat.{max u v} R),
      F.Full âˆ§ F.Faithful âˆ§ PreservesFiniteLimits F âˆ§ PreservesFiniteColimits F :=
  âŸ¨_, _, FreydMitchell.functor C, inferInstance, inferInstance, inferInstance, inferInstanceâŸ©
",Formal Proof of Stacks Project Tag 05PP,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Abelian/FreydMitchell.lean#L167-L170,Q27041,,19.9.3,remark,3.0,"['05PL', '01D4', '0ELQ']","\n  Remark 19.9.3. The Freyd-Mitchell embedding theorem says there exists a fully faithful exact functor from any abelian category $\\mathcal{A}$ to the category of modules over a ring. Lemma 19.9.2 is not quite as strong. But the result is suitable for the Stacks project as we have to understand sheaves of abelian groups on sites in detail anyway. Moreover, \xe2\x80\x9cdiagram chasing\xe2\x80\x9d works in the category of abelian sheaves on $\\mathcal{C}$, for example by working with sections over objects, or by working on the level of stalks using that $\\mathcal{C}$ has enough points. To see how to deduce the Freyd-Mitchell embedding theorem from Lemma 19.9.2 see Remark 19.9.5. \n","\n  Remark 19.9.3. The Freyd-Mitchell embedding theorem says there exists a fully faithful exact functor from any abelian category $\\mathcal{A}$ to the category of modules over a ring. Lemma 19.9.2 is not quite as strong. But the result is suitable for the Stacks project as we have to understand sheaves of abelian groups on sites in detail anyway. Moreover, \xe2\x80\x9cdiagram chasing\xe2\x80\x9d works in the category of abelian sheaves on $\\mathcal{C}$, for example by working with sections over objects, or by working on the level of stalks using that $\\mathcal{C}$ has enough points. To see how to deduce the Freyd-Mitchell embedding theorem from Lemma 19.9.2 see Remark 19.9.5. \n",,"
  âŸ¨_, _, FreydMitchell.functor C, inferInstance, inferInstance, inferInstance, inferInstanceâŸ©
","theorem freyd_mitchell (C : Type u) [Category.{v} C] [Abelian C] :
    âˆƒ (R : Type (max u v)) (_ : Ring R) (F : C â¥¤ ModuleCat.{max u v} R),
      F.Full âˆ§ F.Faithful âˆ§ PreservesFiniteLimits F âˆ§ PreservesFiniteColimits F ",
76,0107,"def coimageImageComparison : Abelian.coimage f âŸ¶ Abelian.image f :=
  cokernel.desc (kernel.Î¹ f) (kernel.lift (cokernel.Ï€ f) f (by simp)) (by ext; simp)
",Formal Proof of Stacks Project Tag 0107,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Abelian/Images.lean#L102-L103,Q27041,,12.3.12,lemma,3.0,"['09SE', '00ZU', '0ELQ']","\n  Lemma 12.3.12. Let $f : x \\to y$ be a morphism in a preadditive category such that the kernel, cokernel, image and coimage all exist. Then $f$ can be factored uniquely as $x \\to \\mathop{\\mathrm{Coim}}(f) \\to \\mathop{\\mathrm{Im}}(f) \\to y$. \n\n    \n      Proof.\n      There is a canonical morphism $\\mathop{\\mathrm{Coim}}(f) \\to y$ because $\\mathop{\\mathrm{Ker}}(f) \\to x \\to y$ is zero. The composition $\\mathop{\\mathrm{Coim}}(f) \\to y \\to \\mathop{\\mathrm{Coker}}(f)$ is zero, because it is the unique morphism which gives rise to the morphism $x \\to y \\to \\mathop{\\mathrm{Coker}}(f)$ which is zero (the uniqueness follows from Lemma 12.3.11 (3)). Hence $\\mathop{\\mathrm{Coim}}(f) \\to y$ factors uniquely through $\\mathop{\\mathrm{Im}}(f) \\to y$, which gives us the desired map. \n      $\\square$\n    \n","\n  Lemma 12.3.12. Let $f : x \\to y$ be a morphism in a preadditive category such that the kernel, cokernel, image and coimage all exist. Then $f$ can be factored uniquely as $x \\to \\mathop{\\mathrm{Coim}}(f) \\to \\mathop{\\mathrm{Im}}(f) \\to y$. \n\n    \n","Proof.\n      There is a canonical morphism $\\mathop{\\mathrm{Coim}}(f) \\to y$ because $\\mathop{\\mathrm{Ker}}(f) \\to x \\to y$ is zero. The composition $\\mathop{\\mathrm{Coim}}(f) \\to y \\to \\mathop{\\mathrm{Coker}}(f)$ is zero, because it is the unique morphism which gives rise to the morphism $x \\to y \\to \\mathop{\\mathrm{Coker}}(f)$ which is zero (the uniqueness follows from Lemma 12.3.11 (3)). Hence $\\mathop{\\mathrm{Coim}}(f) \\to y$ factors uniquely through $\\mathop{\\mathrm{Im}}(f) \\to y$, which gives us the desired map. \n      $\\square$\n    \n","
  cokernel.desc (kernel.Î¹ f) (kernel.lift (cokernel.Ï€ f) f (by simp)) (by ext; simp)
",def coimageImageComparison : Abelian.coimage f âŸ¶ Abelian.image f ,"Proof.\n      There is a canonical morphism $\\mathop{\\mathrm{Coim}}(f) \\to y$ because $\\mathop{\\mathrm{Ker}}(f) \\to x \\to y$ is zero. The composition $\\mathop{\\mathrm{Coim}}(f) \\to y \\to \\mathop{\\mathrm{Coker}}(f)$ is zero, because it is the unique morphism which gives rise to the morphism $x \\to y \\to \\mathop{\\mathrm{Coker}}(f)$ which is zero (the uniqueness follows from Lemma 12.3.11 [[\n  Lemma 12.3.11. Let $\\mathcal{C}$ be a preadditive category. Let $f : x \\to y$ be a morphism in $\\mathcal{C}$. \n  \n  \nIf a kernel of $f$ exists, then this kernel is a monomorphism. \n\n\nIf a cokernel of $f$ exists, then this cokernel is an epimorphism. \n\n\nIf a kernel and coimage of $f$ exist, then the coimage is an epimorphism. \n\n\nIf a cokernel and image of $f$ exist, then the image is a monomorphism. \n\n\n\n\n    \n]] (3)). Hence $\\mathop{\\mathrm{Coim}}(f) \\to y$ factors uniquely through $\\mathop{\\mathrm{Im}}(f) \\to y$, which gives us the desired map. \n      $\\square$\n    \n"
77,03A3,"def abelianOfAdjunction {C : Type uâ‚} [Category.{vâ‚} C] [Preadditive C] [HasFiniteProducts C]
    {D : Type uâ‚‚} [Category.{vâ‚‚} D] [Abelian D] (F : C â¥¤ D)
    (G : D â¥¤ C) [Functor.PreservesZeroMorphisms G] [PreservesFiniteLimits G] (i : F â‹™ G â‰… ðŸ­ C)
    (adj : G âŠ£ F) : Abelian C := by
  haveI := hasKernels F G i
  haveI := hasCokernels F G i adj
  have : âˆ€ {X Y : C} (f : X âŸ¶ Y), IsIso (Abelian.coimageImageComparison f) := by
    intro X Y f
    let arrowIso : Arrow.mk (G.map (F.map f)) â‰… Arrow.mk f :=
      ((Functor.mapArrowFunctor _ _).mapIso i).app (Arrow.mk f)
    have : PreservesColimits G := adj.leftAdjoint_preservesColimits
    let iso : Arrow.mk (G.map (Abelian.coimageImageComparison (F.map f))) â‰…
        Arrow.mk (Abelian.coimageImageComparison f) :=
      Abelian.PreservesCoimageImageComparison.iso G (F.map f) â‰ªâ‰«
        Abelian.coimageImageComparisonFunctor.mapIso arrowIso
    rw [Arrow.isIso_iff_isIso_of_isIso iso.inv]
    infer_instance
  apply Abelian.ofCoimageImageComparisonIsIso
",Formal Proof of Stacks Project Tag 03A3,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Abelian/Transfer.lean#L86-L103,Q27041,,12.7.4,lemma,3.0,"['010M', '00ZU', '0ELQ']","\n  Lemma 12.7.4. Let $a : \\mathcal{A} \\to \\mathcal{B}$ and $b : \\mathcal{B} \\to \\mathcal{A}$ be functors. Assume that \n  \n  \n$\\mathcal{A}$, $\\mathcal{B}$ are additive categories, $a$, $b$ are additive functors, and $a$ is right adjoint to $b$, \n\n\n$\\mathcal{B}$ is abelian and $b$ is left exact, and \n\n\n$ba \\cong \\text{id}_\\mathcal {A}$. \n\n\n\n   Then $\\mathcal{A}$ is abelian. \n\n    \n      Proof.\n      As $\\mathcal{B}$ is abelian we see that all finite limits and colimits exist in $\\mathcal{B}$ by Lemma 12.5.5. Since $b$ is a left adjoint we see that $b$ is also right exact and hence exact, see Categories, Lemma 4.24.6. Let $\\varphi : B_1 \\to B_2$ be a morphism of $\\mathcal{B}$. In particular, if $K = \\mathop{\\mathrm{Ker}}(B_1 \\to B_2)$, then $K$ is the equalizer of $0$ and $\\varphi $ and hence $bK$ is the equalizer of $0$ and $b\\varphi $, hence $bK$ is the kernel of $b\\varphi $. Similarly, if $Q = \\mathop{\\mathrm{Coker}}(B_1 \\to B_2)$, then $Q$ is the coequalizer of $0$ and $\\varphi $ and hence $bQ$ is the coequalizer of $0$ and $b\\varphi $, hence $bQ$ is the cokernel of $b\\varphi $. Thus we see that every morphism of the form $b\\varphi $ in $\\mathcal{A}$ has a kernel and a cokernel. However, since $ba \\cong \\text{id}$ we see that every morphism of $\\mathcal{A}$ is of this form, and we conclude that kernels and cokernels exist in $\\mathcal{A}$. In fact, the argument shows that if $\\psi : A_1 \\to A_2$ is a morphism then \n    \n      \n  \\[  \\mathop{\\mathrm{Ker}}(\\psi ) = b\\mathop{\\mathrm{Ker}}(a\\psi ), \\quad \\text{and}\\quad \\mathop{\\mathrm{Coker}}(\\psi ) = b\\mathop{\\mathrm{Coker}}(a\\psi ).  \\]\n\n    \n       Now we still have to show that $\\mathop{\\mathrm{Coim}}(\\psi )= \\mathop{\\mathrm{Im}}(\\psi )$. We do this as follows. First note that since $\\mathcal{A}$ has kernels and cokernels it has all finite limits and colimits (see proof of Lemma 12.5.5). Hence we see by Categories, Lemma 4.24.6 that $a$ is left exact and hence transforms kernels (=equalizers) into kernels. \n    \n      \n  \\begin{align*}  \\mathop{\\mathrm{Coim}}(\\psi ) &  = \\mathop{\\mathrm{Coker}}(\\mathop{\\mathrm{Ker}}(\\psi ) \\to A_1) &  \\text{by definition} \\\\ &  = b\\mathop{\\mathrm{Coker}}(a(\\mathop{\\mathrm{Ker}}(\\psi ) \\to A_1)) &  \\text{by formula above} \\\\ &  = b\\mathop{\\mathrm{Coker}}(\\mathop{\\mathrm{Ker}}(a\\psi ) \\to aA_1)) &  a\\text{ preserves kernels} \\\\ &  = b\\mathop{\\mathrm{Coim}}(a\\psi ) &  \\text{by definition} \\\\ &  = b\\mathop{\\mathrm{Im}}(a\\psi ) &  \\mathcal{B}\\text{ is abelian} \\\\ &  = b\\mathop{\\mathrm{Ker}}(aA_2 \\to \\mathop{\\mathrm{Coker}}(a\\psi )) &  \\text{by definition} \\\\ &  = \\mathop{\\mathrm{Ker}}(baA_2 \\to b\\mathop{\\mathrm{Coker}}(a\\psi )) &  b\\text{ preserves kernels} \\\\ &  = \\mathop{\\mathrm{Ker}}(A_2 \\to b\\mathop{\\mathrm{Coker}}(a\\psi )) &  ba = \\text{id}_\\mathcal {A} \\\\ &  = \\mathop{\\mathrm{Ker}}(A_2 \\to \\mathop{\\mathrm{Coker}}(\\psi )) &  \\text{by formula above} \\\\ &  = \\mathop{\\mathrm{Im}}(\\psi ) &  \\text{by definition} \\end{align*}\n\n    \n       Thus the lemma holds. \n      $\\square$\n    \n","\n  Lemma 12.7.4. Let $a : \\mathcal{A} \\to \\mathcal{B}$ and $b : \\mathcal{B} \\to \\mathcal{A}$ be functors. Assume that \n  \n  \n$\\mathcal{A}$, $\\mathcal{B}$ are additive categories, $a$, $b$ are additive functors, and $a$ is right adjoint to $b$, \n\n\n$\\mathcal{B}$ is abelian and $b$ is left exact, and \n\n\n$ba \\cong \\text{id}_\\mathcal {A}$. \n\n\n\n   Then $\\mathcal{A}$ is abelian. \n\n    \n","Proof.\n      As $\\mathcal{B}$ is abelian we see that all finite limits and colimits exist in $\\mathcal{B}$ by Lemma 12.5.5. Since $b$ is a left adjoint we see that $b$ is also right exact and hence exact, see Categories, Lemma 4.24.6. Let $\\varphi : B_1 \\to B_2$ be a morphism of $\\mathcal{B}$. In particular, if $K = \\mathop{\\mathrm{Ker}}(B_1 \\to B_2)$, then $K$ is the equalizer of $0$ and $\\varphi $ and hence $bK$ is the equalizer of $0$ and $b\\varphi $, hence $bK$ is the kernel of $b\\varphi $. Similarly, if $Q = \\mathop{\\mathrm{Coker}}(B_1 \\to B_2)$, then $Q$ is the coequalizer of $0$ and $\\varphi $ and hence $bQ$ is the coequalizer of $0$ and $b\\varphi $, hence $bQ$ is the cokernel of $b\\varphi $. Thus we see that every morphism of the form $b\\varphi $ in $\\mathcal{A}$ has a kernel and a cokernel. However, since $ba \\cong \\text{id}$ we see that every morphism of $\\mathcal{A}$ is of this form, and we conclude that kernels and cokernels exist in $\\mathcal{A}$. In fact, the argument shows that if $\\psi : A_1 \\to A_2$ is a morphism then \n    \n      \n  \\[  \\mathop{\\mathrm{Ker}}(\\psi ) = b\\mathop{\\mathrm{Ker}}(a\\psi ), \\quad \\text{and}\\quad \\mathop{\\mathrm{Coker}}(\\psi ) = b\\mathop{\\mathrm{Coker}}(a\\psi ).  \\]\n\n    \n       Now we still have to show that $\\mathop{\\mathrm{Coim}}(\\psi )= \\mathop{\\mathrm{Im}}(\\psi )$. We do this as follows. First note that since $\\mathcal{A}$ has kernels and cokernels it has all finite limits and colimits (see proof of Lemma 12.5.5). Hence we see by Categories, Lemma 4.24.6 that $a$ is left exact and hence transforms kernels (=equalizers) into kernels. \n    \n      \n  \\begin{align*}  \\mathop{\\mathrm{Coim}}(\\psi ) &  = \\mathop{\\mathrm{Coker}}(\\mathop{\\mathrm{Ker}}(\\psi ) \\to A_1) &  \\text{by definition} \\\\ &  = b\\mathop{\\mathrm{Coker}}(a(\\mathop{\\mathrm{Ker}}(\\psi ) \\to A_1)) &  \\text{by formula above} \\\\ &  = b\\mathop{\\mathrm{Coker}}(\\mathop{\\mathrm{Ker}}(a\\psi ) \\to aA_1)) &  a\\text{ preserves kernels} \\\\ &  = b\\mathop{\\mathrm{Coim}}(a\\psi ) &  \\text{by definition} \\\\ &  = b\\mathop{\\mathrm{Im}}(a\\psi ) &  \\mathcal{B}\\text{ is abelian} \\\\ &  = b\\mathop{\\mathrm{Ker}}(aA_2 \\to \\mathop{\\mathrm{Coker}}(a\\psi )) &  \\text{by definition} \\\\ &  = \\mathop{\\mathrm{Ker}}(baA_2 \\to b\\mathop{\\mathrm{Coker}}(a\\psi )) &  b\\text{ preserves kernels} \\\\ &  = \\mathop{\\mathrm{Ker}}(A_2 \\to b\\mathop{\\mathrm{Coker}}(a\\psi )) &  ba = \\text{id}_\\mathcal {A} \\\\ &  = \\mathop{\\mathrm{Ker}}(A_2 \\to \\mathop{\\mathrm{Coker}}(\\psi )) &  \\text{by formula above} \\\\ &  = \\mathop{\\mathrm{Im}}(\\psi ) &  \\text{by definition} \\end{align*}\n\n    \n       Thus the lemma holds. \n      $\\square$\n    \n"," by
  haveI := hasKernels F G i
  haveI := hasCokernels F G i adj
  have : âˆ€ {X Y : C} (f : X âŸ¶ Y), IsIso (Abelian.coimageImageComparison f) := by
    intro X Y f
    let arrowIso : Arrow.mk (G.map (F.map f)) â‰… Arrow.mk f :=
      ((Functor.mapArrowFunctor _ _).mapIso i).app (Arrow.mk f)
    have : PreservesColimits G := adj.leftAdjoint_preservesColimits
    let iso : Arrow.mk (G.map (Abelian.coimageImageComparison (F.map f))) â‰…
        Arrow.mk (Abelian.coimageImageComparison f) :=
      Abelian.PreservesCoimageImageComparison.iso G (F.map f) â‰ªâ‰«
        Abelian.coimageImageComparisonFunctor.mapIso arrowIso
    rw [Arrow.isIso_iff_isIso_of_isIso iso.inv]
    infer_instance
  apply Abelian.ofCoimageImageComparisonIsIso
","def abelianOfAdjunction {C : Type uâ‚} [Category.{vâ‚} C] [Preadditive C] [HasFiniteProducts C]
    {D : Type uâ‚‚} [Category.{vâ‚‚} D] [Abelian D] (F : C â¥¤ D)
    (G : D â¥¤ C) [Functor.PreservesZeroMorphisms G] [PreservesFiniteLimits G] (i : F â‹™ G â‰… ðŸ­ C)
    (adj : G âŠ£ F) : Abelian C ","Proof.\n      As $\\mathcal{B}$ is abelian we see that all finite limits and colimits exist in $\\mathcal{B}$ by Lemma 12.5.5 [[\n  Lemma 12.5.5. Let $\\mathcal{A}$ be an abelian category. All finite limits and finite colimits exist in $\\mathcal{A}$. \n\n    \n]]. Since $b$ is a left adjoint we see that $b$ is also right exact and hence exact, see Categories, Lemma 4.24.6 [[\n  Lemma 4.24.6. Let $u$ be a left adjoint of $v$ as in Definition 4.24.1. \n  \n  \nIf $\\mathcal{C}$ has finite colimits, then $u$ is right exact. \n\n\nIf $\\mathcal{D}$ has finite limits, then $v$ is left exact. \n\n\n\n\n    \n]]. Let $\\varphi : B_1 \\to B_2$ be a morphism of $\\mathcal{B}$. In particular, if $K = \\mathop{\\mathrm{Ker}}(B_1 \\to B_2)$, then $K$ is the equalizer of $0$ and $\\varphi $ and hence $bK$ is the equalizer of $0$ and $b\\varphi $, hence $bK$ is the kernel of $b\\varphi $. Similarly, if $Q = \\mathop{\\mathrm{Coker}}(B_1 \\to B_2)$, then $Q$ is the coequalizer of $0$ and $\\varphi $ and hence $bQ$ is the coequalizer of $0$ and $b\\varphi $, hence $bQ$ is the cokernel of $b\\varphi $. Thus we see that every morphism of the form $b\\varphi $ in $\\mathcal{A}$ has a kernel and a cokernel. However, since $ba \\cong \\text{id}$ we see that every morphism of $\\mathcal{A}$ is of this form, and we conclude that kernels and cokernels exist in $\\mathcal{A}$. In fact, the argument shows that if $\\psi : A_1 \\to A_2$ is a morphism then \n    \n      \n  \\[  \\mathop{\\mathrm{Ker}}(\\psi ) = b\\mathop{\\mathrm{Ker}}(a\\psi ), \\quad \\text{and}\\quad \\mathop{\\mathrm{Coker}}(\\psi ) = b\\mathop{\\mathrm{Coker}}(a\\psi ).  \\]\n\n    \n       Now we still have to show that $\\mathop{\\mathrm{Coim}}(\\psi )= \\mathop{\\mathrm{Im}}(\\psi )$. We do this as follows. First note that since $\\mathcal{A}$ has kernels and cokernels it has all finite limits and colimits (see proof of Lemma 12.5.5 [[\n  Lemma 12.5.5. Let $\\mathcal{A}$ be an abelian category. All finite limits and finite colimits exist in $\\mathcal{A}$. \n\n    \n]]). Hence we see by Categories, Lemma 4.24.6 [[\n  Lemma 4.24.6. Let $u$ be a left adjoint of $v$ as in Definition 4.24.1. \n  \n  \nIf $\\mathcal{C}$ has finite colimits, then $u$ is right exact. \n\n\nIf $\\mathcal{D}$ has finite limits, then $v$ is left exact. \n\n\n\n\n    \n]] that $a$ is left exact and hence transforms kernels (=equalizers) into kernels. \n    \n      \n  \\begin{align*}  \\mathop{\\mathrm{Coim}}(\\psi ) &  = \\mathop{\\mathrm{Coker}}(\\mathop{\\mathrm{Ker}}(\\psi ) \\to A_1) &  \\text{by definition} \\\\ &  = b\\mathop{\\mathrm{Coker}}(a(\\mathop{\\mathrm{Ker}}(\\psi ) \\to A_1)) &  \\text{by formula above} \\\\ &  = b\\mathop{\\mathrm{Coker}}(\\mathop{\\mathrm{Ker}}(a\\psi ) \\to aA_1)) &  a\\text{ preserves kernels} \\\\ &  = b\\mathop{\\mathrm{Coim}}(a\\psi ) &  \\text{by definition} \\\\ &  = b\\mathop{\\mathrm{Im}}(a\\psi ) &  \\mathcal{B}\\text{ is abelian} \\\\ &  = b\\mathop{\\mathrm{Ker}}(aA_2 \\to \\mathop{\\mathrm{Coker}}(a\\psi )) &  \\text{by definition} \\\\ &  = \\mathop{\\mathrm{Ker}}(baA_2 \\to b\\mathop{\\mathrm{Coker}}(a\\psi )) &  b\\text{ preserves kernels} \\\\ &  = \\mathop{\\mathrm{Ker}}(A_2 \\to b\\mathop{\\mathrm{Coker}}(a\\psi )) &  ba = \\text{id}_\\mathcal {A} \\\\ &  = \\mathop{\\mathrm{Ker}}(A_2 \\to \\mathop{\\mathrm{Coker}}(\\psi )) &  \\text{by formula above} \\\\ &  = \\mathop{\\mathrm{Im}}(\\psi ) &  \\text{by definition} \\end{align*}\n\n    \n       Thus the lemma holds. \n      $\\square$\n    \n"
78,079B,"abbrev AB5 [HasFilteredColimits C] := AB5OfSize.{v, v} C
",Formal Proof of Stacks Project Tag 079B,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Abelian/GrothendieckAxioms/Basic.lean#L307-L307,Q27041,,19.10.1,definition,3.0,"['079A', '01D4', '0ELQ']","\n  Definition 19.10.1. Let $\\mathcal{A}$ be an abelian category. We name some conditions \n  \n  \n$\\mathcal{A}$ has direct sums, \n\n\n$\\mathcal{A}$ has AB3 and direct sums are exact, \n\n\n$\\mathcal{A}$ has AB3 and filtered colimits are exact. \n\n\n\n   Here are the dual notions \n  \n  \n$\\mathcal{A}$ has products, \n\n\n$\\mathcal{A}$ has AB3* and products are exact, \n\n\n$\\mathcal{A}$ has AB3* and cofiltered limits are exact. \n\n\n\n   We say an object $U$ of $\\mathcal{A}$ is a generator if for every $N \\subset M$, $N \\not= M$ in $\\mathcal{A}$ there exists a morphism $U \\to M$ which does not factor through $N$. We say $\\mathcal{A}$ is a Grothendieck abelian category if it has AB5 and a generator. \n","\n  Definition 19.10.1. Let $\\mathcal{A}$ be an abelian category. We name some conditions \n  \n  \n$\\mathcal{A}$ has direct sums, \n\n\n$\\mathcal{A}$ has AB3 and direct sums are exact, \n\n\n$\\mathcal{A}$ has AB3 and filtered colimits are exact. \n\n\n\n   Here are the dual notions \n  \n  \n$\\mathcal{A}$ has products, \n\n\n$\\mathcal{A}$ has AB3* and products are exact, \n\n\n$\\mathcal{A}$ has AB3* and cofiltered limits are exact. \n\n\n\n   We say an object $U$ of $\\mathcal{A}$ is a generator if for every $N \\subset M$, $N \\not= M$ in $\\mathcal{A}$ there exists a morphism $U \\to M$ which does not factor through $N$. We say $\\mathcal{A}$ is a Grothendieck abelian category if it has AB5 and a generator. \n",," AB5OfSize.{v, v} C
",abbrev AB5 [HasFilteredColimits C] ,
79,079B,"class IsGrothendieckAbelian [Abelian C] : Prop where
  locallySmall : LocallySmall.{w} C := by infer_instance
  hasFilteredColimitsOfSize : HasFilteredColimitsOfSize.{w, w} C := by infer_instance
  ab5OfSize : AB5OfSize.{w, w} C := by infer_instance
  hasSeparator : HasSeparator C := by infer_instance
",Formal Proof of Stacks Project Tag 079B, pp_with_univ,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Abelian/GrothendieckCategory/Basic.lean#L70-L74,Q27041,,19.10.1,definition,3.0,"['079A', '01D4', '0ELQ']","\n  Definition 19.10.1. Let $\\mathcal{A}$ be an abelian category. We name some conditions \n  \n  \n$\\mathcal{A}$ has direct sums, \n\n\n$\\mathcal{A}$ has AB3 and direct sums are exact, \n\n\n$\\mathcal{A}$ has AB3 and filtered colimits are exact. \n\n\n\n   Here are the dual notions \n  \n  \n$\\mathcal{A}$ has products, \n\n\n$\\mathcal{A}$ has AB3* and products are exact, \n\n\n$\\mathcal{A}$ has AB3* and cofiltered limits are exact. \n\n\n\n   We say an object $U$ of $\\mathcal{A}$ is a generator if for every $N \\subset M$, $N \\not= M$ in $\\mathcal{A}$ there exists a morphism $U \\to M$ which does not factor through $N$. We say $\\mathcal{A}$ is a Grothendieck abelian category if it has AB5 and a generator. \n","\n  Definition 19.10.1. Let $\\mathcal{A}$ be an abelian category. We name some conditions \n  \n  \n$\\mathcal{A}$ has direct sums, \n\n\n$\\mathcal{A}$ has AB3 and direct sums are exact, \n\n\n$\\mathcal{A}$ has AB3 and filtered colimits are exact. \n\n\n\n   Here are the dual notions \n  \n  \n$\\mathcal{A}$ has products, \n\n\n$\\mathcal{A}$ has AB3* and products are exact, \n\n\n$\\mathcal{A}$ has AB3* and cofiltered limits are exact. \n\n\n\n   We say an object $U$ of $\\mathcal{A}$ is a generator if for every $N \\subset M$, $N \\not= M$ in $\\mathcal{A}$ there exists a morphism $U \\to M$ which does not factor through $N$. We say $\\mathcal{A}$ is a Grothendieck abelian category if it has AB5 and a generator. \n",," by infer_instance
  hasFilteredColimitsOfSize : HasFilteredColimitsOfSize.{w, w} C := by infer_instance
  ab5OfSize : AB5OfSize.{w, w} C := by infer_instance
  hasSeparator : HasSeparator C := by infer_instance
","class IsGrothendieckAbelian [Abelian C] : Prop where
  locallySmall : LocallySmall.{w} C ",
80,079H,"instance enoughInjectives : EnoughInjectives C where
  presentation X := âŸ¨{ J := _, f := (monoMapFactorizationDataRlp (0 : X âŸ¶ 0)).i }âŸ©
",Formal Proof of Stacks Project Tag 079H,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Abelian/GrothendieckCategory/EnoughInjectives.lean#L372-L373,Q27041,,19.11.7,theorem,3.0,"['05AB', '01D4', '0ELQ']","\n  Theorem 19.11.7. Let $\\mathcal{A}$ be a Grothendieck abelian category. Then $\\mathcal{A}$ has functorial injective embeddings. \n\n    \n      Proof.\n      Please compare with the proof of Theorem 19.2.8. Choose a generator $U$ of $\\mathcal{A}$. For an object $M$ we define $\\mathbf{M}(M)$ by the following pushout diagram \n    \n      \n  \\[  \\xymatrix{ \\bigoplus _{N \\subset U} \\bigoplus _{\\varphi \\in \\mathop{\\mathrm{Hom}}\\nolimits (N, M)} N \\ar[r] \\ar[d] &  M \\ar[d] \\\\  \\bigoplus _{N \\subset U} \\bigoplus _{\\varphi \\in \\mathop{\\mathrm{Hom}}\\nolimits (N, M)} U \\ar[r] &  \\mathbf{M}(M). }  \\]\n\n    \n       Note that $M \\mapsto \\mathbf{M}(M)$ is a functor and that there exist functorial injective maps $M \\to \\mathbf{M}(M)$. By transfinite induction we define functors $\\mathbf{M}_\\alpha (M)$ for every ordinal $\\alpha $. Namely, set $\\mathbf{M}_0(M) = M$. Given $\\mathbf{M}_\\alpha (M)$ set $\\mathbf{M}_{\\alpha + 1}(M) = \\mathbf{M}(\\mathbf{M}_\\alpha (M))$. For a limit ordinal $\\beta $ set \n    \n      \n  \\[  \\mathbf{M}_\\beta (M) = \\mathop{\\mathrm{colim}}\\nolimits _{\\alpha < \\beta } \\mathbf{M}_\\alpha (M).  \\]\n\n    \n       Finally, pick any ordinal $\\alpha $ whose cofinality is greater than $|U|$. Such an ordinal exists by Sets, Proposition 3.7.2. We claim that $M \\to \\mathbf{M}_\\alpha (M)$ is the desired functorial injective embedding. Namely, if $N \\subset U$ is a subobject and $\\varphi : N \\to \\mathbf{M}_\\alpha (M)$ is a morphism, then we see that $\\varphi $ factors through $\\mathbf{M}_{\\alpha \'}(M)$ for some $\\alpha \' < \\alpha $ by Proposition 19.11.5. By construction of $\\mathbf{M}(-)$ we see that $\\varphi $ extends to a morphism from $U$ into $\\mathbf{M}_{\\alpha \' + 1}(M)$ and hence into $\\mathbf{M}_\\alpha (M)$. By Lemma 19.11.6 we conclude that $\\mathbf{M}_\\alpha (M)$ is injective. \n      $\\square$\n    \n",\n  Theorem 19.11.7. Let $\\mathcal{A}$ be a Grothendieck abelian category. Then $\\mathcal{A}$ has functorial injective embeddings. \n\n    \n,"Proof.\n      Please compare with the proof of Theorem 19.2.8. Choose a generator $U$ of $\\mathcal{A}$. For an object $M$ we define $\\mathbf{M}(M)$ by the following pushout diagram \n    \n      \n  \\[  \\xymatrix{ \\bigoplus _{N \\subset U} \\bigoplus _{\\varphi \\in \\mathop{\\mathrm{Hom}}\\nolimits (N, M)} N \\ar[r] \\ar[d] &  M \\ar[d] \\\\  \\bigoplus _{N \\subset U} \\bigoplus _{\\varphi \\in \\mathop{\\mathrm{Hom}}\\nolimits (N, M)} U \\ar[r] &  \\mathbf{M}(M). }  \\]\n\n    \n       Note that $M \\mapsto \\mathbf{M}(M)$ is a functor and that there exist functorial injective maps $M \\to \\mathbf{M}(M)$. By transfinite induction we define functors $\\mathbf{M}_\\alpha (M)$ for every ordinal $\\alpha $. Namely, set $\\mathbf{M}_0(M) = M$. Given $\\mathbf{M}_\\alpha (M)$ set $\\mathbf{M}_{\\alpha + 1}(M) = \\mathbf{M}(\\mathbf{M}_\\alpha (M))$. For a limit ordinal $\\beta $ set \n    \n      \n  \\[  \\mathbf{M}_\\beta (M) = \\mathop{\\mathrm{colim}}\\nolimits _{\\alpha < \\beta } \\mathbf{M}_\\alpha (M).  \\]\n\n    \n       Finally, pick any ordinal $\\alpha $ whose cofinality is greater than $|U|$. Such an ordinal exists by Sets, Proposition 3.7.2. We claim that $M \\to \\mathbf{M}_\\alpha (M)$ is the desired functorial injective embedding. Namely, if $N \\subset U$ is a subobject and $\\varphi : N \\to \\mathbf{M}_\\alpha (M)$ is a morphism, then we see that $\\varphi $ factors through $\\mathbf{M}_{\\alpha \'}(M)$ for some $\\alpha \' < \\alpha $ by Proposition 19.11.5. By construction of $\\mathbf{M}(-)$ we see that $\\varphi $ extends to a morphism from $U$ into $\\mathbf{M}_{\\alpha \' + 1}(M)$ and hence into $\\mathbf{M}_\\alpha (M)$. By Lemma 19.11.6 we conclude that $\\mathbf{M}_\\alpha (M)$ is injective. \n      $\\square$\n    \n"," âŸ¨{ J := _, f := (monoMapFactorizationDataRlp (0 : X âŸ¶ 0)).i }âŸ©
","instance enoughInjectives : EnoughInjectives C where
  presentation X ","Proof.\n      Please compare with the proof of Theorem 19.2.8 [[\n  Theorem 19.2.8. Let $\\kappa $ be the cardinality of the set of ideals in $R$, and let $\\alpha $ be an ordinal whose cofinality is greater than $\\kappa $. Then $\\mathbf{M}_\\alpha (N)$ is an injective $R$-module, and $N \\to \\mathbf{M}_\\alpha (N)$ is a functorial injective embedding. \n\n    \n]]. Choose a generator $U$ of $\\mathcal{A}$. For an object $M$ we define $\\mathbf{M}(M)$ by the following pushout diagram \n    \n      \n  \\[  \\xymatrix{ \\bigoplus _{N \\subset U} \\bigoplus _{\\varphi \\in \\mathop{\\mathrm{Hom}}\\nolimits (N, M)} N \\ar[r] \\ar[d] &  M \\ar[d] \\\\  \\bigoplus _{N \\subset U} \\bigoplus _{\\varphi \\in \\mathop{\\mathrm{Hom}}\\nolimits (N, M)} U \\ar[r] &  \\mathbf{M}(M). }  \\]\n\n    \n       Note that $M \\mapsto \\mathbf{M}(M)$ is a functor and that there exist functorial injective maps $M \\to \\mathbf{M}(M)$. By transfinite induction we define functors $\\mathbf{M}_\\alpha (M)$ for every ordinal $\\alpha $. Namely, set $\\mathbf{M}_0(M) = M$. Given $\\mathbf{M}_\\alpha (M)$ set $\\mathbf{M}_{\\alpha + 1}(M) = \\mathbf{M}(\\mathbf{M}_\\alpha (M))$. For a limit ordinal $\\beta $ set \n    \n      \n  \\[  \\mathbf{M}_\\beta (M) = \\mathop{\\mathrm{colim}}\\nolimits _{\\alpha < \\beta } \\mathbf{M}_\\alpha (M).  \\]\n\n    \n       Finally, pick any ordinal $\\alpha $ whose cofinality is greater than $|U|$. Such an ordinal exists by Sets, Proposition 3.7.2 [[\n  Proposition 3.7.2. Let $\\kappa $ be a cardinal. Then there exists an ordinal whose cofinality is bigger than $\\kappa $. \n\n    \n]]. We claim that $M \\to \\mathbf{M}_\\alpha (M)$ is the desired functorial injective embedding. Namely, if $N \\subset U$ is a subobject and $\\varphi : N \\to \\mathbf{M}_\\alpha (M)$ is a morphism, then we see that $\\varphi $ factors through $\\mathbf{M}_{\\alpha \'}(M)$ for some $\\alpha \' < \\alpha $ by Proposition 19.11.5 [[\n  Proposition 19.11.5. Let $\\mathcal{A}$ be a Grothendieck abelian category. Let $M$ be an object of $\\mathcal{A}$. Let $\\kappa = |M|$. If $\\alpha $ is an ordinal whose cofinality is bigger than $\\kappa $, then $M$ is $\\alpha $-small with respect to injections. \n\n    \n]]. By construction of $\\mathbf{M}(-)$ we see that $\\varphi $ extends to a morphism from $U$ into $\\mathbf{M}_{\\alpha \' + 1}(M)$ and hence into $\\mathbf{M}_\\alpha (M)$. By Lemma 19.11.6 [[\n       \n      \n  Lemma 19.11.6. Let $\\mathcal{A}$ be a Grothendieck abelian category with generator $U$. An object $I$ of $\\mathcal{A}$ is injective if and only if in every commutative diagram \n  \n  \\[  \\xymatrix{ M \\ar[d] \\ar[r] &  I \\\\  U \\ar@{-->}[ru] }  \\]\n\n   for $M \\subset U$ a subobject, the dotted arrow exists. \n\n    \n]] we conclude that $\\mathbf{M}_\\alpha (M)$ is injective. \n      $\\square$\n    \n"
81,0037,"structure Adjunction (F : C â¥¤ D) (G : D â¥¤ C) where
  /-- The unit of an adjunction -/
  unit : ðŸ­ C âŸ¶ F.comp G
  /-- The counit of an adjunction -/
  counit : G.comp F âŸ¶ ðŸ­ D
  /-- Equality of the composition of the unit and counit with the identity `F âŸ¶ FGF âŸ¶ F = ðŸ™` -/
  left_triangle_components (X : C) :
      F.map (unit.app X) â‰« counit.app (F.obj X) = ðŸ™ (F.obj X) := by cat_disch
  /-- Equality of the composition of the unit and counit with the identity `G âŸ¶ GFG âŸ¶ G = ðŸ™` -/
  right_triangle_components (Y : D) :
      unit.app (G.obj Y) â‰« G.map (counit.app Y) = ðŸ™ (G.obj Y) := by cat_disch
",Formal Proof of Stacks Project Tag 0037,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Adjunction/Basic.lean#L103-L113,Q27041,,4.24.1,definition,3.0,"['0036', '0011', '0ELQ']","\n  Definition 4.24.1. Let $\\mathcal{C}$, $\\mathcal{D}$ be categories. Let $u : \\mathcal{C} \\to \\mathcal{D}$ and $v : \\mathcal{D} \\to \\mathcal{C}$ be functors. We say that $u$ is a left adjoint of $v$, or that $v$ is a right adjoint to $u$ if there are bijections \n  \n  \\[  \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {D}(u(X), Y) \\longrightarrow \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {C}(X, v(Y))  \\]\n\n   functorial in $X \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{C})$, and $Y \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{D})$. \n","\n  Definition 4.24.1. Let $\\mathcal{C}$, $\\mathcal{D}$ be categories. Let $u : \\mathcal{C} \\to \\mathcal{D}$ and $v : \\mathcal{D} \\to \\mathcal{C}$ be functors. We say that $u$ is a left adjoint of $v$, or that $v$ is a right adjoint to $u$ if there are bijections \n  \n  \\[  \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {D}(u(X), Y) \\longrightarrow \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {C}(X, v(Y))  \\]\n\n   functorial in $X \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{C})$, and $Y \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{D})$. \n",," by cat_disch
  /-- Equality of the composition of the unit and counit with the identity `G âŸ¶ GFG âŸ¶ G = ðŸ™` -/
  right_triangle_components (Y : D) :
      unit.app (G.obj Y) â‰« G.map (counit.app Y) = ðŸ™ (G.obj Y) := by cat_disch
","structure Adjunction (F : C â¥¤ D) (G : D â¥¤ C) where
  /-- The unit of an adjunction -/
  unit : ðŸ­ C âŸ¶ F.comp G
  /-- The counit of an adjunction -/
  counit : G.comp F âŸ¶ ðŸ­ D
  /-- Equality of the composition of the unit and counit with the identity `F âŸ¶ FGF âŸ¶ F = ðŸ™` -/
  left_triangle_components (X : C) :
      F.map (unit.app X) â‰« counit.app (F.obj X) = ðŸ™ (F.obj X) ",
82,0038,"lemma rightAdjoint_preservesLimits : PreservesLimitsOfSize.{v, u} G where
  preservesLimitsOfShape :=
    { preservesLimit :=
        { preserves := fun hc =>
            âŸ¨IsLimit.isoUniqueConeMorphism.inv fun _ =>
              @Equiv.unique _ _ (IsLimit.isoUniqueConeMorphism.hom hc _)
                ((adj.functorialityAdjunction' _).homEquiv _ _).symmâŸ© } }
",Formal Proof of Stacks Project Tag 0038,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Adjunction/Limits.lean#L198-L204,Q27041,,4.24.5,lemma,3.0,"['0036', '0011', '0ELQ']","\n  Lemma 4.24.5. Let $u$ be a left adjoint to $v$ as in Definition 4.24.1. \n  \n  \nSuppose that $M : \\mathcal{I} \\to \\mathcal{C}$ is a diagram, and suppose that $\\mathop{\\mathrm{colim}}\\nolimits _\\mathcal {I} M$ exists in $\\mathcal{C}$. Then $u(\\mathop{\\mathrm{colim}}\\nolimits _\\mathcal {I} M) = \\mathop{\\mathrm{colim}}\\nolimits _\\mathcal {I} u \\circ M$. In other words, $u$ commutes with (representable) colimits. \n\n\nSuppose that $M : \\mathcal{I} \\to \\mathcal{D}$ is a diagram, and suppose that $\\mathop{\\mathrm{lim}}\\nolimits _\\mathcal {I} M$ exists in $\\mathcal{D}$. Then $v(\\mathop{\\mathrm{lim}}\\nolimits _\\mathcal {I} M) = \\mathop{\\mathrm{lim}}\\nolimits _\\mathcal {I} v \\circ M$. In other words $v$ commutes with representable limits. \n\n\n\n\n    \n      Proof.\n      A morphism from a colimit into an object is the same as a compatible system of morphisms from the constituents of the limit into the object, see Remark 4.14.4. So \n    \n      \n  \\[  \\begin{matrix}  \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {D}(u(\\mathop{\\mathrm{colim}}\\nolimits _{i \\in \\mathcal{I}} M_ i), Y) \n\n&  = \n\n&  \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {C}(\\mathop{\\mathrm{colim}}\\nolimits _{i \\in \\mathcal{I}} M_ i, v(Y)) \n\n\\\\ &  = \n\n&  \\mathop{\\mathrm{lim}}\\nolimits _{i \\in \\mathcal{I}^{opp}} \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {C}(M_ i, v(Y)) \n\n\\\\ &  = \n\n&  \\mathop{\\mathrm{lim}}\\nolimits _{i \\in \\mathcal{I}^{opp}} \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {D}(u(M_ i), Y) \n\n\\end{matrix}  \\]\n\n    \n       proves that $u(\\mathop{\\mathrm{colim}}\\nolimits _{i \\in \\mathcal{I}} M_ i)$ is the colimit we are looking for. A similar argument works for the other statement. \n      $\\square$\n    \n","\n  Lemma 4.24.5. Let $u$ be a left adjoint to $v$ as in Definition 4.24.1. \n  \n  \nSuppose that $M : \\mathcal{I} \\to \\mathcal{C}$ is a diagram, and suppose that $\\mathop{\\mathrm{colim}}\\nolimits _\\mathcal {I} M$ exists in $\\mathcal{C}$. Then $u(\\mathop{\\mathrm{colim}}\\nolimits _\\mathcal {I} M) = \\mathop{\\mathrm{colim}}\\nolimits _\\mathcal {I} u \\circ M$. In other words, $u$ commutes with (representable) colimits. \n\n\nSuppose that $M : \\mathcal{I} \\to \\mathcal{D}$ is a diagram, and suppose that $\\mathop{\\mathrm{lim}}\\nolimits _\\mathcal {I} M$ exists in $\\mathcal{D}$. Then $v(\\mathop{\\mathrm{lim}}\\nolimits _\\mathcal {I} M) = \\mathop{\\mathrm{lim}}\\nolimits _\\mathcal {I} v \\circ M$. In other words $v$ commutes with representable limits. \n\n\n\n\n    \n","Proof.\n      A morphism from a colimit into an object is the same as a compatible system of morphisms from the constituents of the limit into the object, see Remark 4.14.4. So \n    \n      \n  \\[  \\begin{matrix}  \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {D}(u(\\mathop{\\mathrm{colim}}\\nolimits _{i \\in \\mathcal{I}} M_ i), Y) \n\n&  = \n\n&  \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {C}(\\mathop{\\mathrm{colim}}\\nolimits _{i \\in \\mathcal{I}} M_ i, v(Y)) \n\n\\\\ &  = \n\n&  \\mathop{\\mathrm{lim}}\\nolimits _{i \\in \\mathcal{I}^{opp}} \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {C}(M_ i, v(Y)) \n\n\\\\ &  = \n\n&  \\mathop{\\mathrm{lim}}\\nolimits _{i \\in \\mathcal{I}^{opp}} \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {D}(u(M_ i), Y) \n\n\\end{matrix}  \\]\n\n    \n       proves that $u(\\mathop{\\mathrm{colim}}\\nolimits _{i \\in \\mathcal{I}} M_ i)$ is the colimit we are looking for. A similar argument works for the other statement. \n      $\\square$\n    \n","
    { preservesLimit :=
        { preserves := fun hc =>
            âŸ¨IsLimit.isoUniqueConeMorphism.inv fun _ =>
              @Equiv.unique _ _ (IsLimit.isoUniqueConeMorphism.hom hc _)
                ((adj.functorialityAdjunction' _).homEquiv _ _).symmâŸ© } }
","lemma rightAdjoint_preservesLimits : PreservesLimitsOfSize.{v, u} G where
  preservesLimitsOfShape ","Proof.\n      A morphism from a colimit into an object is the same as a compatible system of morphisms from the constituents of the limit into the object, see Remark 4.14.4 [[\n  Remark 4.14.4. We often write $\\mathop{\\mathrm{lim}}\\nolimits _ i M_ i$, $\\mathop{\\mathrm{colim}}\\nolimits _ i M_ i$, $\\mathop{\\mathrm{lim}}\\nolimits _{i\\in \\mathcal{I}} M_ i$, or $\\mathop{\\mathrm{colim}}\\nolimits _{i\\in \\mathcal{I}} M_ i$ instead of the versions indexed by $\\mathcal{I}$. Using this notation, and using the description of limits and colimits of sets in Section 4.15 below, we can say the following. Let $M : \\mathcal{I} \\to \\mathcal{C}$ be a diagram. \n  \n  \nThe object $\\mathop{\\mathrm{lim}}\\nolimits _ i M_ i$ if it exists satisfies the following property \n\n\n  \\[  \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {C}(W, \\mathop{\\mathrm{lim}}\\nolimits _ i M_ i) = \\mathop{\\mathrm{lim}}\\nolimits _ i \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {C}(W, M_ i)  \\]\n\n\n where the limit on the right takes place in the category of sets. \n\n\nThe object $\\mathop{\\mathrm{colim}}\\nolimits _ i M_ i$ if it exists satisfies the following property \n\n\n  \\[  \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {C}(\\mathop{\\mathrm{colim}}\\nolimits _ i M_ i, W) = \\mathop{\\mathrm{lim}}\\nolimits _{i \\in \\mathcal{I}^{opp}} \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {C}(M_ i, W)  \\]\n\n\n where on the right we have the limit over the opposite category with value in the category of sets. \n\n\n\n   By the Yoneda lemma (and its dual) this formula completely determines the limit, respectively the colimit. \n]]. So \n    \n      \n  \\[  \\begin{matrix}  \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {D}(u(\\mathop{\\mathrm{colim}}\\nolimits _{i \\in \\mathcal{I}} M_ i), Y) \n\n&  = \n\n&  \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {C}(\\mathop{\\mathrm{colim}}\\nolimits _{i \\in \\mathcal{I}} M_ i, v(Y)) \n\n\\\\ &  = \n\n&  \\mathop{\\mathrm{lim}}\\nolimits _{i \\in \\mathcal{I}^{opp}} \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {C}(M_ i, v(Y)) \n\n\\\\ &  = \n\n&  \\mathop{\\mathrm{lim}}\\nolimits _{i \\in \\mathcal{I}^{opp}} \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {D}(u(M_ i), Y) \n\n\\end{matrix}  \\]\n\n    \n       proves that $u(\\mathop{\\mathrm{colim}}\\nolimits _{i \\in \\mathcal{I}} M_ i)$ is the colimit we are looking for. A similar argument works for the other statement. \n      $\\square$\n    \n"
83,00D3,"instance (priority := 100) smallCategory (Î± : Type u) [Preorder Î±] : SmallCategory Î± where
  Hom U V := ULift (PLift (U â‰¤ V))
  id X := âŸ¨âŸ¨le_refl XâŸ©âŸ©
  comp f g := âŸ¨âŸ¨le_trans f.down.down g.down.downâŸ©âŸ©
",Formal Proof of Stacks Project Tag 00D3,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Category/Preorder.lean#L48-L51,Q27041,,4.21.1,definition,3.0,"['002Z', '0011', '0ELQ']","\n  Definition 4.21.1. Let $I$ be a set and let $\\leq $ be a binary relation on $I$. \n  \n  \nWe say $\\leq $ is a preorder if it is transitive (if $i \\leq j$ and $j \\leq k$ then $i \\leq k$) and reflexive ($i \\leq i$ for all $i \\in I$). \n\n\nA preordered set is a set endowed with a preorder. \n\n\nA directed set is a preordered set $(I, \\leq )$ such that $I$ is not empty and such that $\\forall i, j \\in I$, there exists $k \\in I$ with $i \\leq k, j \\leq k$. \n\n\nWe say $\\leq $ is a partial order if it is a preorder which is antisymmetric (if $i \\leq j$ and $j \\leq i$, then $i = j$). \n\n\nA partially ordered set is a set endowed with a partial order. \n\n\nA directed partially ordered set is a directed set whose ordering is a partial order. \n\n\n\n","\n  Definition 4.21.1. Let $I$ be a set and let $\\leq $ be a binary relation on $I$. \n  \n  \nWe say $\\leq $ is a preorder if it is transitive (if $i \\leq j$ and $j \\leq k$ then $i \\leq k$) and reflexive ($i \\leq i$ for all $i \\in I$). \n\n\nA preordered set is a set endowed with a preorder. \n\n\nA directed set is a preordered set $(I, \\leq )$ such that $I$ is not empty and such that $\\forall i, j \\in I$, there exists $k \\in I$ with $i \\leq k, j \\leq k$. \n\n\nWe say $\\leq $ is a partial order if it is a preorder which is antisymmetric (if $i \\leq j$ and $j \\leq i$, then $i = j$). \n\n\nA partially ordered set is a set endowed with a partial order. \n\n\nA directed partially ordered set is a directed set whose ordering is a partial order. \n\n\n\n",," 100) smallCategory (Î± : Type u) [Preorder Î±] : SmallCategory Î± where
  Hom U V := ULift (PLift (U â‰¤ V))
  id X := âŸ¨âŸ¨le_refl XâŸ©âŸ©
  comp f g := âŸ¨âŸ¨le_trans f.down.down g.down.downâŸ©âŸ©
",instance (priority ,
84,001G,"def map {Y : T} (f : X âŸ¶ Y) : Over X â¥¤ Over Y :=
  Comma.mapRight _ <| Discrete.natTrans fun _ => f
",Formal Proof of Stacks Project Tag 001G,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Comma/Over/Basic.lean#L170-L171,Q27041,,4.2.13,example,3.0,"['0013', '0011', '0ELQ']","\n  Example 4.2.13. Given a category $\\mathcal{C}$ and an object $X\\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{C})$ we define the category of objects over $X$, denoted $\\mathcal{C}/X$ as follows. The objects of $\\mathcal{C}/X$ are morphisms $Y\\to X$ for some $Y\\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{C})$. Morphisms between objects $Y\\to X$ and $Y\'\\to X$ are morphisms $Y\\to Y\'$ in $\\mathcal{C}$ that make the obvious diagram commute. Note that there is a functor $p_ X : \\mathcal{C}/X\\to \\mathcal{C}$ which simply forgets the morphism. Moreover given a morphism $f : X\'\\to X$ in $\\mathcal{C}$ there is an induced functor $F : \\mathcal{C}/X\' \\to \\mathcal{C}/X$ obtained by composition with $f$, and $p_ X\\circ F = p_{X\'}$. \n","\n  Example 4.2.13. Given a category $\\mathcal{C}$ and an object $X\\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{C})$ we define the category of objects over $X$, denoted $\\mathcal{C}/X$ as follows. The objects of $\\mathcal{C}/X$ are morphisms $Y\\to X$ for some $Y\\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{C})$. Morphisms between objects $Y\\to X$ and $Y\'\\to X$ are morphisms $Y\\to Y\'$ in $\\mathcal{C}$ that make the obvious diagram commute. Note that there is a functor $p_ X : \\mathcal{C}/X\\to \\mathcal{C}$ which simply forgets the morphism. Moreover given a morphism $f : X\'\\to X$ in $\\mathcal{C}$ there is an induced functor $F : \\mathcal{C}/X\' \\to \\mathcal{C}/X$ obtained by composition with $f$, and $p_ X\\circ F = p_{X\'}$. \n",,"
  Comma.mapRight _ <| Discrete.natTrans fun _ => f
",def map {Y : T} (f : X âŸ¶ Y) : Over X â¥¤ Over Y ,
85,001A,"instance discreteCategory (Î± : Type uâ‚) : SmallCategory (Discrete Î±) where
  Hom X Y := ULift (PLift (X.as = Y.as))
  id _ := ULift.up (PLift.up rfl)
  comp {X Y Z} g f := by
    cases X
    cases Y
    cases Z
    rcases f with âŸ¨âŸ¨âŸ¨âŸ©âŸ©âŸ©
    exact g
",Formal Proof of Stacks Project Tag 001A,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Discrete/Basic.lean#L75-L83,Q27041,,4.2.7,example,3.0,"['0013', '0011', '0ELQ']","\n  Example 4.2.7. A set $C$ gives rise to a groupoid $\\mathcal{C}$ defined as follows: As objects we take $\\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{C}) := C$ and for morphisms we take $\\mathop{\\mathrm{Mor}}\\nolimits (x, y)$ empty if $x\\neq y$ and equal to $\\{ \\text{id}_ x\\} $ if $x = y$. \n","\n  Example 4.2.7. A set $C$ gives rise to a groupoid $\\mathcal{C}$ defined as follows: As objects we take $\\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{C}) := C$ and for morphisms we take $\\mathop{\\mathrm{Mor}}\\nolimits (x, y)$ empty if $x\\neq y$ and equal to $\\{ \\text{id}_ x\\} $ if $x = y$. \n",," ULift (PLift (X.as = Y.as))
  id _ := ULift.up (PLift.up rfl)
  comp {X Y Z} g f := by
    cases X
    cases Y
    cases Z
    rcases f with âŸ¨âŸ¨âŸ¨âŸ©âŸ©âŸ©
    exact g
","instance discreteCategory (Î± : Type uâ‚) : SmallCategory (Discrete Î±) where
  Hom X Y ",
86,02XK,"class IsStronglyCocartesian : Prop where
  [toIsHomLift : IsHomLift p f Ï†]
  universal_property' {b' : ð’³} (g : S âŸ¶ p.obj b') (Ï†' : a âŸ¶ b') [IsHomLift p (f â‰« g) Ï†'] :
      âˆƒ! Ï‡ : b âŸ¶ b', IsHomLift p g Ï‡ âˆ§ Ï† â‰« Ï‡ = Ï†'
attribute [instance] IsStronglyCocartesian.toIsHomLift
",Formal Proof of Stacks Project Tag 02XK,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/FiberedCategory/Cocartesian.lean#L71-L75,Q27041,,4.33.1,definition,3.0,"['02XJ', '0011', '0ELQ']","\n  Definition 4.33.1. Let $\\mathcal{C}$ be a category. Let $p : \\mathcal{S} \\to \\mathcal{C}$ be a category over $\\mathcal{C}$. A strongly cartesian morphism, or more precisely a strongly $\\mathcal{C}$-cartesian morphism is a morphism $\\varphi : y \\to x$ of $\\mathcal{S}$ such that for every $z \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{S})$ the map \n  \n  \\[  \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {S}(z, y) \\longrightarrow \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {S}(z, x) \\times _{\\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {C}(p(z), p(x))} \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {C}(p(z), p(y)),  \\]\n\n   given by $\\psi \\longmapsto (\\varphi \\circ \\psi , p(\\psi ))$ is bijective. \n","\n  Definition 4.33.1. Let $\\mathcal{C}$ be a category. Let $p : \\mathcal{S} \\to \\mathcal{C}$ be a category over $\\mathcal{C}$. A strongly cartesian morphism, or more precisely a strongly $\\mathcal{C}$-cartesian morphism is a morphism $\\varphi : y \\to x$ of $\\mathcal{S}$ such that for every $z \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{S})$ the map \n  \n  \\[  \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {S}(z, y) \\longrightarrow \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {S}(z, x) \\times _{\\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {C}(p(z), p(x))} \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {C}(p(z), p(y)),  \\]\n\n   given by $\\psi \\longmapsto (\\varphi \\circ \\psi , p(\\psi ))$ is bijective. \n",,,"class IsStronglyCocartesian : Prop where
  [toIsHomLift : IsHomLift p f Ï†]
  universal_property' {b' : ð’³} (g : S âŸ¶ p.obj b') (Ï†' : a âŸ¶ b') [IsHomLift p (f â‰« g) Ï†'] :
      âˆƒ! Ï‡ : b âŸ¶ b', IsHomLift p g Ï‡ âˆ§ Ï† â‰« Ï‡ = Ï†'
attribute [instance] IsStronglyCocartesian.toIsHomLift
",
87,002V,"class IsFiltered : Prop extends IsFilteredOrEmpty C where
  /-- a filtered category must be non-empty -/
  -- This should be an instance but it causes significant slowdown
  [nonempty : Nonempty C]
",Formal Proof of Stacks Project Tag 002V,They also define a diagram being filtered.,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Filtered/Basic.lean#L93-L96,Q27041,,4.19.1,definition,3.0,"['04AX', '0011', '0ELQ']","\n  Definition 4.19.1. We say that a diagram $M : \\mathcal{I} \\to \\mathcal{C}$ is directed, or filtered if the following conditions hold: \n  \n  \nthe category $\\mathcal{I}$ has at least one object, \n\n\nfor every pair of objects $x, y$ of $\\mathcal{I}$ there exist an object $z$ and morphisms $x \\to z$, $y \\to z$, and \n\n\nfor every pair of objects $x, y$ of $\\mathcal{I}$ and every pair of morphisms $a, b : x \\to y$ of $\\mathcal{I}$ there exists a morphism $c : y \\to z$ of $\\mathcal{I}$ such that $M(c \\circ a) = M(c \\circ b)$ as morphisms in $\\mathcal{C}$. \n\n\n\n   We say that an index category $\\mathcal{I}$ is directed, or filtered if $\\text{id} : \\mathcal{I} \\to \\mathcal{I}$ is filtered (in other words you erase the $M$ in part (3) above). \n","\n  Definition 4.19.1. We say that a diagram $M : \\mathcal{I} \\to \\mathcal{C}$ is directed, or filtered if the following conditions hold: \n  \n  \nthe category $\\mathcal{I}$ has at least one object, \n\n\nfor every pair of objects $x, y$ of $\\mathcal{I}$ there exist an object $z$ and morphisms $x \\to z$, $y \\to z$, and \n\n\nfor every pair of objects $x, y$ of $\\mathcal{I}$ and every pair of morphisms $a, b : x \\to y$ of $\\mathcal{I}$ there exists a morphism $c : y \\to z$ of $\\mathcal{I}$ such that $M(c \\circ a) = M(c \\circ b)$ as morphisms in $\\mathcal{C}$. \n\n\n\n   We say that an index category $\\mathcal{I}$ is directed, or filtered if $\\text{id} : \\mathcal{I} \\to \\mathcal{I}$ is filtered (in other words you erase the $M$ in part (3) above). \n",,,"class IsFiltered : Prop extends IsFilteredOrEmpty C where
  /-- a filtered category must be non-empty -/
  -- This should be an instance but it causes significant slowdown
  [nonempty : Nonempty C]
",
88,04AZ,"class IsCofiltered : Prop extends IsCofilteredOrEmpty C where
  /-- a cofiltered category must be non-empty -/
  -- This should be an instance but it causes significant slowdown
  [nonempty : Nonempty C]
",Formal Proof of Stacks Project Tag 04AZ,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Filtered/Basic.lean#L509-L512,Q27041,,4.20.1,definition,3.0,"['04AY', '0011', '0ELQ']","\n  Definition 4.20.1. We say that a diagram $M : \\mathcal{I} \\to \\mathcal{C}$ is codirected or cofiltered if the following conditions hold: \n  \n  \nthe category $\\mathcal{I}$ has at least one object, \n\n\nfor every pair of objects $x, y$ of $\\mathcal{I}$ there exist an object $z$ and morphisms $z \\to x$, $z \\to y$, and \n\n\nfor every pair of objects $x, y$ of $\\mathcal{I}$ and every pair of morphisms $a, b : x \\to y$ of $\\mathcal{I}$ there exists a morphism $c : w \\to x$ of $\\mathcal{I}$ such that $M(a \\circ c) = M(b \\circ c)$ as morphisms in $\\mathcal{C}$. \n\n\n\n   We say that an index category $\\mathcal{I}$ is codirected, or cofiltered if $\\text{id} : \\mathcal{I} \\to \\mathcal{I}$ is cofiltered (in other words you erase the $M$ in part (3) above). \n","\n  Definition 4.20.1. We say that a diagram $M : \\mathcal{I} \\to \\mathcal{C}$ is codirected or cofiltered if the following conditions hold: \n  \n  \nthe category $\\mathcal{I}$ has at least one object, \n\n\nfor every pair of objects $x, y$ of $\\mathcal{I}$ there exist an object $z$ and morphisms $z \\to x$, $z \\to y$, and \n\n\nfor every pair of objects $x, y$ of $\\mathcal{I}$ and every pair of morphisms $a, b : x \\to y$ of $\\mathcal{I}$ there exists a morphism $c : w \\to x$ of $\\mathcal{I}$ such that $M(a \\circ c) = M(b \\circ c)$ as morphisms in $\\mathcal{C}$. \n\n\n\n   We say that an index category $\\mathcal{I}$ is codirected, or cofiltered if $\\text{id} : \\mathcal{I} \\to \\mathcal{I}$ is cofiltered (in other words you erase the $M$ in part (3) above). \n",,,"class IsCofiltered : Prop extends IsCofilteredOrEmpty C where
  /-- a cofiltered category must be non-empty -/
  -- This should be an instance but it causes significant slowdown
  [nonempty : Nonempty C]
",
89,001B,"structure Functor (C : Type uâ‚) [Category.{vâ‚} C] (D : Type uâ‚‚) [Category.{vâ‚‚} D] :
    Type max vâ‚ vâ‚‚ uâ‚ uâ‚‚ where
  /-- The action of a functor on objects. -/
  obj : C â†’ D
  /-- The action of a functor on morphisms. -/
  map : âˆ€ {X Y : C}, (X âŸ¶ Y) â†’ ((obj X) âŸ¶ (obj Y))
  /-- A functor preserves identity morphisms. -/
  map_id : âˆ€ X : C, map (ðŸ™ X) = ðŸ™ (obj X) := by cat_disch
  /-- A functor preserves composition. -/
  map_comp : âˆ€ {X Y Z : C} (f : X âŸ¶ Y) (g : Y âŸ¶ Z), map (f â‰« g) = map f â‰« map g := by cat_disch
",Formal Proof of Stacks Project Tag 001B,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Functor/Basic.lean#L40-L49,Q27041,,4.2.8,definition,3.0,"['0013', '0011', '0ELQ']","\n  Definition 4.2.8. A functor $F : \\mathcal{A} \\to \\mathcal{B}$ between two categories $\\mathcal{A}, \\mathcal{B}$ is given by the following data: \n  \n  \nA map $F : \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{A}) \\to \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{B})$. \n\n\nFor every $x, y \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{A})$ a map $F : \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {A}(x, y) \\to \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {B}(F(x), F(y))$, denoted $\\phi \\mapsto F(\\phi )$. \n\n\n\n   These data should be compatible with composition and identity morphisms in the following manner: $F(\\phi \\circ \\psi ) = F(\\phi ) \\circ F(\\psi )$ for a composable pair $(\\phi , \\psi )$ of morphisms of $\\mathcal{A}$ and $F(\\text{id}_ x) = \\text{id}_{F(x)}$. \n","\n  Definition 4.2.8. A functor $F : \\mathcal{A} \\to \\mathcal{B}$ between two categories $\\mathcal{A}, \\mathcal{B}$ is given by the following data: \n  \n  \nA map $F : \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{A}) \\to \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{B})$. \n\n\nFor every $x, y \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{A})$ a map $F : \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {A}(x, y) \\to \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {B}(F(x), F(y))$, denoted $\\phi \\mapsto F(\\phi )$. \n\n\n\n   These data should be compatible with composition and identity morphisms in the following manner: $F(\\phi \\circ \\psi ) = F(\\phi ) \\circ F(\\psi )$ for a composable pair $(\\phi , \\psi )$ of morphisms of $\\mathcal{A}$ and $F(\\text{id}_ x) = \\text{id}_{F(x)}$. \n",," by cat_disch
  /-- A functor preserves composition. -/
  map_comp : âˆ€ {X Y Z : C} (f : X âŸ¶ Y) (g : Y âŸ¶ Z), map (f â‰« g) = map f â‰« map g := by cat_disch
","structure Functor (C : Type uâ‚) [Category.{vâ‚} C] (D : Type uâ‚‚) [Category.{vâ‚‚} D] :
    Type max vâ‚ vâ‚‚ uâ‚ uâ‚‚ where
  /-- The action of a functor on objects. -/
  obj : C â†’ D
  /-- The action of a functor on morphisms. -/
  map : âˆ€ {X Y : C}, (X âŸ¶ Y) â†’ ((obj X) âŸ¶ (obj Y))
  /-- A functor preserves identity morphisms. -/
  map_id : âˆ€ X : C, map (ðŸ™ X) = ðŸ™ (obj X) ",
90,0BN4,"instance : (functorToContAction F).IsEquivalence where
",Formal Proof of Stacks Project Tag 0BN4,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Galois/Equivalence.lean#L88-L88,Q27041,,58.3.10,proposition,3.0,"['0BMQ', '0BQ6', '0ELV']","\n       \n      \n  Proposition 58.3.10. Let $(\\mathcal{C}, F)$ be a Galois category. Let $G = \\text{Aut}(F)$ be as in Example 58.3.5. The functor $F : \\mathcal{C} \\to \\textit{Finite-}G\\textit{-Sets}$ (58.3.5.1) an equivalence. \n\n    \n      Proof.\n      We will use the results of Lemma 58.3.7 without further mention. In particular we know the functor is faithful. By Lemma 58.3.9 we know that for any connected $X$ the action of $G$ on $F(X)$ is transitive. Hence for general $X$ the functor $F$ sends the connected components of $X$ (which exist by an axiom of a Galois category) to the $G$-orbits of $F(X)$. Let $X$ and $Y$ be objects and let $s : F(X) \\to F(Y)$ be a map. Then the graph $\\Gamma _ s \\subset F(X) \\times F(Y)$ of $s$ is a union of connected components. Hence there exists a union of connected components $Z$ of $X \\times Y$, which comes equipped with a monomorphism $Z \\to X \\times Y$, with $F(Z) = \\Gamma _ s$. Since $F(Z) \\to F(X)$ is bijective we see that $Z \\to X$ is an isomorphism and we conclude that $s = F(f)$ where $f : X \\cong Z \\to Y$ is the composition. Hence $F$ is fully faithful. \n    \n      To finish the proof we show that $F$ is essentially surjective. It suffices to show that $G/H$ is in the essential image for any open subgroup $H \\subset G$ of finite index. By definition of the topology on $G$ there exists a finite collection of objects $X_ i$ such that \n    \n      \n  \\[  \\mathop{\\mathrm{Ker}}(G \\longrightarrow \\prod \\nolimits _ i \\text{Aut}(F(X_ i)))  \\]\n\n    \n       is contained in $H$. We may assume $X_ i$ is connected for all $i$. We can choose a Galois object $Y$ mapping to a connected component of $\\prod X_ i$ using Lemma 58.3.8. Choose an isomorphism $F(Y) = G/U$ in $G\\textit{-sets}$ for some open subgroup $U \\subset G$. As $Y$ is Galois, the group $\\text{Aut}(Y) = \\text{Aut}_{G\\textit{-Sets}}(G/U)$ acts transitively on $F(Y) = G/U$. This implies that $U$ is normal. Since $F(Y)$ surjects onto $F(X_ i)$ for each $i$ we see that $U \\subset H$. Let $M \\subset \\text{Aut}(Y)$ be the finite subgroup corresponding to \n    \n      \n  \\[  (H/U)^{opp} \\subset (G/U)^{opp} = \\text{Aut}_{G\\textit{-Sets}}(G/U) = \\text{Aut}(Y).  \\]\n\n    \n       Set $X = Y/M$, i.e., $X$ is the coequalizer of the arrows $m : Y \\to Y$, $m \\in M$. Since $F$ is exact we see that $F(X) = G/H$ and the proof is complete. \n      $\\square$\n    \n","\n       \n      \n  Proposition 58.3.10. Let $(\\mathcal{C}, F)$ be a Galois category. Let $G = \\text{Aut}(F)$ be as in Example 58.3.5. The functor $F : \\mathcal{C} \\to \\textit{Finite-}G\\textit{-Sets}$ (58.3.5.1) an equivalence. \n\n    \n","Proof.\n      We will use the results of Lemma 58.3.7 without further mention. In particular we know the functor is faithful. By Lemma 58.3.9 we know that for any connected $X$ the action of $G$ on $F(X)$ is transitive. Hence for general $X$ the functor $F$ sends the connected components of $X$ (which exist by an axiom of a Galois category) to the $G$-orbits of $F(X)$. Let $X$ and $Y$ be objects and let $s : F(X) \\to F(Y)$ be a map. Then the graph $\\Gamma _ s \\subset F(X) \\times F(Y)$ of $s$ is a union of connected components. Hence there exists a union of connected components $Z$ of $X \\times Y$, which comes equipped with a monomorphism $Z \\to X \\times Y$, with $F(Z) = \\Gamma _ s$. Since $F(Z) \\to F(X)$ is bijective we see that $Z \\to X$ is an isomorphism and we conclude that $s = F(f)$ where $f : X \\cong Z \\to Y$ is the composition. Hence $F$ is fully faithful. \n    \n      To finish the proof we show that $F$ is essentially surjective. It suffices to show that $G/H$ is in the essential image for any open subgroup $H \\subset G$ of finite index. By definition of the topology on $G$ there exists a finite collection of objects $X_ i$ such that \n    \n      \n  \\[  \\mathop{\\mathrm{Ker}}(G \\longrightarrow \\prod \\nolimits _ i \\text{Aut}(F(X_ i)))  \\]\n\n    \n       is contained in $H$. We may assume $X_ i$ is connected for all $i$. We can choose a Galois object $Y$ mapping to a connected component of $\\prod X_ i$ using Lemma 58.3.8. Choose an isomorphism $F(Y) = G/U$ in $G\\textit{-sets}$ for some open subgroup $U \\subset G$. As $Y$ is Galois, the group $\\text{Aut}(Y) = \\text{Aut}_{G\\textit{-Sets}}(G/U)$ acts transitively on $F(Y) = G/U$. This implies that $U$ is normal. Since $F(Y)$ surjects onto $F(X_ i)$ for each $i$ we see that $U \\subset H$. Let $M \\subset \\text{Aut}(Y)$ be the finite subgroup corresponding to \n    \n      \n  \\[  (H/U)^{opp} \\subset (G/U)^{opp} = \\text{Aut}_{G\\textit{-Sets}}(G/U) = \\text{Aut}(Y).  \\]\n\n    \n       Set $X = Y/M$, i.e., $X$ is the coequalizer of the arrows $m : Y \\to Y$, $m \\in M$. Since $F$ is exact we see that $F(X) = G/H$ and the proof is complete. \n      $\\square$\n    \n",,"instance : (functorToContAction F).IsEquivalence where
","Proof.\n      We will use the results of Lemma 58.3.7 [[\n  Lemma 58.3.7. Let $(\\mathcal{C}, F)$ be a Galois category. Let $X \\to Y \\in \\text{Arrows}(\\mathcal{C})$. Then \n  \n  \n$F$ is faithful, \n\n\n$X \\to Y$ is a monomorphism $\\Leftrightarrow F(X) \\to F(Y)$ is injective, \n\n\n$X \\to Y$ is an epimorphism $\\Leftrightarrow F(X) \\to F(Y)$ is surjective, \n\n\nan object $A$ of $\\mathcal{C}$ is initial if and only if $F(A) = \\emptyset $, \n\n\nan object $Z$ of $\\mathcal{C}$ is final if and only if $F(Z)$ is a singleton, \n\n\nif $X$ and $Y$ are connected, then $X \\to Y$ is an epimorphism, \n\n\n if $X$ is connected and $a, b : X \\to Y$ are two morphisms then $a = b$ as soon as $F(a)$ and $F(b)$ agree on one element of $F(X)$, \n\n\nif $X = \\coprod _{i = 1, \\ldots , n} X_ i$ and $Y = \\coprod _{j = 1, \\ldots , m} Y_ j$ where $X_ i$, $Y_ j$ are connected, then there is map $\\alpha : \\{ 1, \\ldots , n\\}  \\to \\{ 1, \\ldots , m\\} $ such that $X \\to Y$ comes from a collection of morphisms $X_ i \\to Y_{\\alpha (i)}$. \n\n\n\n\n    \n]] without further mention. In particular we know the functor is faithful. By Lemma 58.3.9 [[\n       \n      \n  Lemma 58.3.9. Let $(\\mathcal{C}, F)$ be a Galois category. Let $G = \\text{Aut}(F)$ be as in Example 58.3.5. For any connected $X$ in $\\mathcal{C}$ the action of $G$ on $F(X)$ is transitive. \n\n    \n]] we know that for any connected $X$ the action of $G$ on $F(X)$ is transitive. Hence for general $X$ the functor $F$ sends the connected components of $X$ (which exist by an axiom of a Galois category) to the $G$-orbits of $F(X)$. Let $X$ and $Y$ be objects and let $s : F(X) \\to F(Y)$ be a map. Then the graph $\\Gamma _ s \\subset F(X) \\times F(Y)$ of $s$ is a union of connected components. Hence there exists a union of connected components $Z$ of $X \\times Y$, which comes equipped with a monomorphism $Z \\to X \\times Y$, with $F(Z) = \\Gamma _ s$. Since $F(Z) \\to F(X)$ is bijective we see that $Z \\to X$ is an isomorphism and we conclude that $s = F(f)$ where $f : X \\cong Z \\to Y$ is the composition. Hence $F$ is fully faithful. \n    \n      To finish the proof we show that $F$ is essentially surjective. It suffices to show that $G/H$ is in the essential image for any open subgroup $H \\subset G$ of finite index. By definition of the topology on $G$ there exists a finite collection of objects $X_ i$ such that \n    \n      \n  \\[  \\mathop{\\mathrm{Ker}}(G \\longrightarrow \\prod \\nolimits _ i \\text{Aut}(F(X_ i)))  \\]\n\n    \n       is contained in $H$. We may assume $X_ i$ is connected for all $i$. We can choose a Galois object $Y$ mapping to a connected component of $\\prod X_ i$ using Lemma 58.3.8 [[\n  Lemma 58.3.8. Let $(\\mathcal{C}, F)$ be a Galois category. For any connected object $X$ of $\\mathcal{C}$ there exists a Galois object $Y$ and a morphism $Y \\to X$. \n\n    \n]]. Choose an isomorphism $F(Y) = G/U$ in $G\\textit{-sets}$ for some open subgroup $U \\subset G$. As $Y$ is Galois, the group $\\text{Aut}(Y) = \\text{Aut}_{G\\textit{-Sets}}(G/U)$ acts transitively on $F(Y) = G/U$. This implies that $U$ is normal. Since $F(Y)$ surjects onto $F(X_ i)$ for each $i$ we see that $U \\subset H$. Let $M \\subset \\text{Aut}(Y)$ be the finite subgroup corresponding to \n    \n      \n  \\[  (H/U)^{opp} \\subset (G/U)^{opp} = \\text{Aut}_{G\\textit{-Sets}}(G/U) = \\text{Aut}(Y).  \\]\n\n    \n       Set $X = Y/M$, i.e., $X$ is the coequalizer of the arrows $m : Y \\to Y$, $m \\in M$. Since $F$ is exact we see that $F(X) = G/H$ and the proof is complete. \n      $\\square$\n    \n"
91,0BN4,"theorem exists_lift_of_continuous (X : Action FintypeCat (Aut F))
    [TopologicalSpace X.V] [DiscreteTopology X.V] [ContinuousSMul (Aut F) X.V] :
    âˆƒ A, Nonempty ((functorToAction F).obj A â‰… X) := by
  obtain âŸ¨Î¹, hfin, f, âŸ¨uâŸ©âŸ© := has_decomp_quotients X
  choose g gu using (fun i â†¦ exists_lift_of_quotient_openSubgroup (f i))
  exact âŸ¨âˆ g, âŸ¨PreservesCoproduct.iso (functorToAction F) g â‰ªâ‰«
    Sigma.mapIso (fun i â†¦ (gu i).some) â‰ªâ‰« uâŸ©âŸ©
",Formal Proof of Stacks Project Tag 0BN4,Essential surjectivity part,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Galois/EssSurj.lean#L264-L270,Q27041,,58.3.10,proposition,3.0,"['0BMQ', '0BQ6', '0ELV']","\n       \n      \n  Proposition 58.3.10. Let $(\\mathcal{C}, F)$ be a Galois category. Let $G = \\text{Aut}(F)$ be as in Example 58.3.5. The functor $F : \\mathcal{C} \\to \\textit{Finite-}G\\textit{-Sets}$ (58.3.5.1) an equivalence. \n\n    \n      Proof.\n      We will use the results of Lemma 58.3.7 without further mention. In particular we know the functor is faithful. By Lemma 58.3.9 we know that for any connected $X$ the action of $G$ on $F(X)$ is transitive. Hence for general $X$ the functor $F$ sends the connected components of $X$ (which exist by an axiom of a Galois category) to the $G$-orbits of $F(X)$. Let $X$ and $Y$ be objects and let $s : F(X) \\to F(Y)$ be a map. Then the graph $\\Gamma _ s \\subset F(X) \\times F(Y)$ of $s$ is a union of connected components. Hence there exists a union of connected components $Z$ of $X \\times Y$, which comes equipped with a monomorphism $Z \\to X \\times Y$, with $F(Z) = \\Gamma _ s$. Since $F(Z) \\to F(X)$ is bijective we see that $Z \\to X$ is an isomorphism and we conclude that $s = F(f)$ where $f : X \\cong Z \\to Y$ is the composition. Hence $F$ is fully faithful. \n    \n      To finish the proof we show that $F$ is essentially surjective. It suffices to show that $G/H$ is in the essential image for any open subgroup $H \\subset G$ of finite index. By definition of the topology on $G$ there exists a finite collection of objects $X_ i$ such that \n    \n      \n  \\[  \\mathop{\\mathrm{Ker}}(G \\longrightarrow \\prod \\nolimits _ i \\text{Aut}(F(X_ i)))  \\]\n\n    \n       is contained in $H$. We may assume $X_ i$ is connected for all $i$. We can choose a Galois object $Y$ mapping to a connected component of $\\prod X_ i$ using Lemma 58.3.8. Choose an isomorphism $F(Y) = G/U$ in $G\\textit{-sets}$ for some open subgroup $U \\subset G$. As $Y$ is Galois, the group $\\text{Aut}(Y) = \\text{Aut}_{G\\textit{-Sets}}(G/U)$ acts transitively on $F(Y) = G/U$. This implies that $U$ is normal. Since $F(Y)$ surjects onto $F(X_ i)$ for each $i$ we see that $U \\subset H$. Let $M \\subset \\text{Aut}(Y)$ be the finite subgroup corresponding to \n    \n      \n  \\[  (H/U)^{opp} \\subset (G/U)^{opp} = \\text{Aut}_{G\\textit{-Sets}}(G/U) = \\text{Aut}(Y).  \\]\n\n    \n       Set $X = Y/M$, i.e., $X$ is the coequalizer of the arrows $m : Y \\to Y$, $m \\in M$. Since $F$ is exact we see that $F(X) = G/H$ and the proof is complete. \n      $\\square$\n    \n","\n       \n      \n  Proposition 58.3.10. Let $(\\mathcal{C}, F)$ be a Galois category. Let $G = \\text{Aut}(F)$ be as in Example 58.3.5. The functor $F : \\mathcal{C} \\to \\textit{Finite-}G\\textit{-Sets}$ (58.3.5.1) an equivalence. \n\n    \n","Proof.\n      We will use the results of Lemma 58.3.7 without further mention. In particular we know the functor is faithful. By Lemma 58.3.9 we know that for any connected $X$ the action of $G$ on $F(X)$ is transitive. Hence for general $X$ the functor $F$ sends the connected components of $X$ (which exist by an axiom of a Galois category) to the $G$-orbits of $F(X)$. Let $X$ and $Y$ be objects and let $s : F(X) \\to F(Y)$ be a map. Then the graph $\\Gamma _ s \\subset F(X) \\times F(Y)$ of $s$ is a union of connected components. Hence there exists a union of connected components $Z$ of $X \\times Y$, which comes equipped with a monomorphism $Z \\to X \\times Y$, with $F(Z) = \\Gamma _ s$. Since $F(Z) \\to F(X)$ is bijective we see that $Z \\to X$ is an isomorphism and we conclude that $s = F(f)$ where $f : X \\cong Z \\to Y$ is the composition. Hence $F$ is fully faithful. \n    \n      To finish the proof we show that $F$ is essentially surjective. It suffices to show that $G/H$ is in the essential image for any open subgroup $H \\subset G$ of finite index. By definition of the topology on $G$ there exists a finite collection of objects $X_ i$ such that \n    \n      \n  \\[  \\mathop{\\mathrm{Ker}}(G \\longrightarrow \\prod \\nolimits _ i \\text{Aut}(F(X_ i)))  \\]\n\n    \n       is contained in $H$. We may assume $X_ i$ is connected for all $i$. We can choose a Galois object $Y$ mapping to a connected component of $\\prod X_ i$ using Lemma 58.3.8. Choose an isomorphism $F(Y) = G/U$ in $G\\textit{-sets}$ for some open subgroup $U \\subset G$. As $Y$ is Galois, the group $\\text{Aut}(Y) = \\text{Aut}_{G\\textit{-Sets}}(G/U)$ acts transitively on $F(Y) = G/U$. This implies that $U$ is normal. Since $F(Y)$ surjects onto $F(X_ i)$ for each $i$ we see that $U \\subset H$. Let $M \\subset \\text{Aut}(Y)$ be the finite subgroup corresponding to \n    \n      \n  \\[  (H/U)^{opp} \\subset (G/U)^{opp} = \\text{Aut}_{G\\textit{-Sets}}(G/U) = \\text{Aut}(Y).  \\]\n\n    \n       Set $X = Y/M$, i.e., $X$ is the coequalizer of the arrows $m : Y \\to Y$, $m \\in M$. Since $F$ is exact we see that $F(X) = G/H$ and the proof is complete. \n      $\\square$\n    \n"," by
  obtain âŸ¨Î¹, hfin, f, âŸ¨uâŸ©âŸ© := has_decomp_quotients X
  choose g gu using (fun i â†¦ exists_lift_of_quotient_openSubgroup (f i))
  exact âŸ¨âˆ g, âŸ¨PreservesCoproduct.iso (functorToAction F) g â‰ªâ‰«
    Sigma.mapIso (fun i â†¦ (gu i).some) â‰ªâ‰« uâŸ©âŸ©
","theorem exists_lift_of_continuous (X : Action FintypeCat (Aut F))
    [TopologicalSpace X.V] [DiscreteTopology X.V] [ContinuousSMul (Aut F) X.V] :
    âˆƒ A, Nonempty ((functorToAction F).obj A â‰… X) ","Proof.\n      We will use the results of Lemma 58.3.7 [[\n  Lemma 58.3.7. Let $(\\mathcal{C}, F)$ be a Galois category. Let $X \\to Y \\in \\text{Arrows}(\\mathcal{C})$. Then \n  \n  \n$F$ is faithful, \n\n\n$X \\to Y$ is a monomorphism $\\Leftrightarrow F(X) \\to F(Y)$ is injective, \n\n\n$X \\to Y$ is an epimorphism $\\Leftrightarrow F(X) \\to F(Y)$ is surjective, \n\n\nan object $A$ of $\\mathcal{C}$ is initial if and only if $F(A) = \\emptyset $, \n\n\nan object $Z$ of $\\mathcal{C}$ is final if and only if $F(Z)$ is a singleton, \n\n\nif $X$ and $Y$ are connected, then $X \\to Y$ is an epimorphism, \n\n\n if $X$ is connected and $a, b : X \\to Y$ are two morphisms then $a = b$ as soon as $F(a)$ and $F(b)$ agree on one element of $F(X)$, \n\n\nif $X = \\coprod _{i = 1, \\ldots , n} X_ i$ and $Y = \\coprod _{j = 1, \\ldots , m} Y_ j$ where $X_ i$, $Y_ j$ are connected, then there is map $\\alpha : \\{ 1, \\ldots , n\\}  \\to \\{ 1, \\ldots , m\\} $ such that $X \\to Y$ comes from a collection of morphisms $X_ i \\to Y_{\\alpha (i)}$. \n\n\n\n\n    \n]] without further mention. In particular we know the functor is faithful. By Lemma 58.3.9 [[\n       \n      \n  Lemma 58.3.9. Let $(\\mathcal{C}, F)$ be a Galois category. Let $G = \\text{Aut}(F)$ be as in Example 58.3.5. For any connected $X$ in $\\mathcal{C}$ the action of $G$ on $F(X)$ is transitive. \n\n    \n]] we know that for any connected $X$ the action of $G$ on $F(X)$ is transitive. Hence for general $X$ the functor $F$ sends the connected components of $X$ (which exist by an axiom of a Galois category) to the $G$-orbits of $F(X)$. Let $X$ and $Y$ be objects and let $s : F(X) \\to F(Y)$ be a map. Then the graph $\\Gamma _ s \\subset F(X) \\times F(Y)$ of $s$ is a union of connected components. Hence there exists a union of connected components $Z$ of $X \\times Y$, which comes equipped with a monomorphism $Z \\to X \\times Y$, with $F(Z) = \\Gamma _ s$. Since $F(Z) \\to F(X)$ is bijective we see that $Z \\to X$ is an isomorphism and we conclude that $s = F(f)$ where $f : X \\cong Z \\to Y$ is the composition. Hence $F$ is fully faithful. \n    \n      To finish the proof we show that $F$ is essentially surjective. It suffices to show that $G/H$ is in the essential image for any open subgroup $H \\subset G$ of finite index. By definition of the topology on $G$ there exists a finite collection of objects $X_ i$ such that \n    \n      \n  \\[  \\mathop{\\mathrm{Ker}}(G \\longrightarrow \\prod \\nolimits _ i \\text{Aut}(F(X_ i)))  \\]\n\n    \n       is contained in $H$. We may assume $X_ i$ is connected for all $i$. We can choose a Galois object $Y$ mapping to a connected component of $\\prod X_ i$ using Lemma 58.3.8 [[\n  Lemma 58.3.8. Let $(\\mathcal{C}, F)$ be a Galois category. For any connected object $X$ of $\\mathcal{C}$ there exists a Galois object $Y$ and a morphism $Y \\to X$. \n\n    \n]]. Choose an isomorphism $F(Y) = G/U$ in $G\\textit{-sets}$ for some open subgroup $U \\subset G$. As $Y$ is Galois, the group $\\text{Aut}(Y) = \\text{Aut}_{G\\textit{-Sets}}(G/U)$ acts transitively on $F(Y) = G/U$. This implies that $U$ is normal. Since $F(Y)$ surjects onto $F(X_ i)$ for each $i$ we see that $U \\subset H$. Let $M \\subset \\text{Aut}(Y)$ be the finite subgroup corresponding to \n    \n      \n  \\[  (H/U)^{opp} \\subset (G/U)^{opp} = \\text{Aut}_{G\\textit{-Sets}}(G/U) = \\text{Aut}(Y).  \\]\n\n    \n       Set $X = Y/M$, i.e., $X$ is the coequalizer of the arrows $m : Y \\to Y$, $m \\in M$. Since $F$ is exact we see that $F(X) = G/H$ and the proof is complete. \n      $\\square$\n    \n"
92,04E6,"class Final (F : C â¥¤ D) : Prop where
  out (d : D) : IsConnected (StructuredArrow d F)
",Formal Proof of Stacks Project Tag 04E6,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Limits/Final.lean#L96-L97,Q27041,,4.17.1,definition,3.0,"['09WN', '0011', '0ELQ']","\n  Definition 4.17.1. Let $H : \\mathcal{I} \\to \\mathcal{J}$ be a functor between categories. We say $\\mathcal{I}$ is cofinal in $\\mathcal{J}$ or that $H$ is cofinal if \n  \n  \nfor all $y \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{J})$ there exist an $x \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{I})$ and a morphism $y \\to H(x)$, and \n\n\ngiven $y \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{J})$, $x, x\' \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{I})$ and morphisms $y \\to H(x)$ and $y \\to H(x\')$ there exist a sequence of morphisms \n\n\n  \\[  x = x_0 \\leftarrow x_1 \\rightarrow x_2 \\leftarrow x_3 \\rightarrow \\ldots \\rightarrow x_{2n} = x\'  \\]\n\n\n in $\\mathcal{I}$ and morphisms $y \\to H(x_ i)$ in $\\mathcal{J}$ with $y \\to H(x_0)$ and $y \\to H(x_{2n})$ the given morphisms such that the diagrams \n\n\n  \\[  \\xymatrix{ &  y \\ar[ld] \\ar[d] \\ar[rd] \\\\  H(x_{2k}) &  H(x_{2k + 1}) \\ar[l] \\ar[r] &  H(x_{2k + 2}) }  \\]\n\n\n commute for $k = 0, \\ldots , n - 1$. \n\n\n\n   In other words, fixing an object $y$ of $\\mathcal{J}$ consider the set $S$ of pairs $(x, b)$ where $x$ is an object of $\\mathcal{I}$ and $b : y \\to H(x)$ is a morphism. Consider the equivalence relation on $S$ generated by $(x, b) \\sim (x\', b\')$ if there exists a morphism $a : x \\to x\'$ with $b\' = H(a) \\circ b$. Then $S$ should consist of exactly one equivalence class. \n","\n  Definition 4.17.1. Let $H : \\mathcal{I} \\to \\mathcal{J}$ be a functor between categories. We say $\\mathcal{I}$ is cofinal in $\\mathcal{J}$ or that $H$ is cofinal if \n  \n  \nfor all $y \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{J})$ there exist an $x \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{I})$ and a morphism $y \\to H(x)$, and \n\n\ngiven $y \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{J})$, $x, x\' \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{I})$ and morphisms $y \\to H(x)$ and $y \\to H(x\')$ there exist a sequence of morphisms \n\n\n  \\[  x = x_0 \\leftarrow x_1 \\rightarrow x_2 \\leftarrow x_3 \\rightarrow \\ldots \\rightarrow x_{2n} = x\'  \\]\n\n\n in $\\mathcal{I}$ and morphisms $y \\to H(x_ i)$ in $\\mathcal{J}$ with $y \\to H(x_0)$ and $y \\to H(x_{2n})$ the given morphisms such that the diagrams \n\n\n  \\[  \\xymatrix{ &  y \\ar[ld] \\ar[d] \\ar[rd] \\\\  H(x_{2k}) &  H(x_{2k + 1}) \\ar[l] \\ar[r] &  H(x_{2k + 2}) }  \\]\n\n\n commute for $k = 0, \\ldots , n - 1$. \n\n\n\n   In other words, fixing an object $y$ of $\\mathcal{J}$ consider the set $S$ of pairs $(x, b)$ where $x$ is an object of $\\mathcal{I}$ and $b : y \\to H(x)$ is a morphism. Consider the equivalence relation on $S$ generated by $(x, b) \\sim (x\', b\')$ if there exists a morphism $a : x \\to x\'$ with $b\' = H(a) \\circ b$. Then $S$ should consist of exactly one equivalence class. \n",,,"class Final (F : C â¥¤ D) : Prop where
  out (d : D) : IsConnected (StructuredArrow d F)
",
93,002E,"structure IsLimit (t : Cone F) where
  /-- There is a morphism from any cone point to `t.pt` -/
  lift : âˆ€ s : Cone F, s.pt âŸ¶ t.pt
  /-- The map makes the triangle with the two natural transformations commute -/
  fac : âˆ€ (s : Cone F) (j : J), lift s â‰« t.Ï€.app j = s.Ï€.app j := by cat_disch
  /-- It is the unique such map to do this -/
  uniq : âˆ€ (s : Cone F) (m : s.pt âŸ¶ t.pt) (_ : âˆ€ j : J, m â‰« t.Ï€.app j = s.Ï€.app j), m = lift s := by
    cat_disch
",Formal Proof of Stacks Project Tag 002E,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Limits/IsLimit.lean#L55-L62,Q27041,,4.14.1,definition,3.0,"['002D', '0011', '0ELQ']","\n  Definition 4.14.1. A limit of the $\\mathcal{I}$-diagram $M$ in the category $\\mathcal{C}$ is given by an object $\\mathop{\\mathrm{lim}}\\nolimits _\\mathcal {I} M$ in $\\mathcal{C}$ together with morphisms $p_ i : \\mathop{\\mathrm{lim}}\\nolimits _\\mathcal {I} M \\to M_ i$ such that \n  \n  \nfor $\\phi : i \\to i\'$ a morphism in $\\mathcal{I}$ we have $p_{i\'} = M(\\phi ) \\circ p_ i$, and \n\n\nfor any object $W$ in $\\mathcal{C}$ and any family of morphisms $q_ i : W \\to M_ i$ (indexed by $i \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{I})$) such that for all $\\phi : i \\to i\'$ in $\\mathcal{I}$ we have $q_{i\'} = M(\\phi ) \\circ q_ i$ there exists a unique morphism $q : W \\to \\mathop{\\mathrm{lim}}\\nolimits _\\mathcal {I} M$ such that $q_ i = p_ i \\circ q$ for every object $i$ of $\\mathcal{I}$. \n\n\n\n","\n  Definition 4.14.1. A limit of the $\\mathcal{I}$-diagram $M$ in the category $\\mathcal{C}$ is given by an object $\\mathop{\\mathrm{lim}}\\nolimits _\\mathcal {I} M$ in $\\mathcal{C}$ together with morphisms $p_ i : \\mathop{\\mathrm{lim}}\\nolimits _\\mathcal {I} M \\to M_ i$ such that \n  \n  \nfor $\\phi : i \\to i\'$ a morphism in $\\mathcal{I}$ we have $p_{i\'} = M(\\phi ) \\circ p_ i$, and \n\n\nfor any object $W$ in $\\mathcal{C}$ and any family of morphisms $q_ i : W \\to M_ i$ (indexed by $i \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{I})$) such that for all $\\phi : i \\to i\'$ in $\\mathcal{I}$ we have $q_{i\'} = M(\\phi ) \\circ q_ i$ there exists a unique morphism $q : W \\to \\mathop{\\mathrm{lim}}\\nolimits _\\mathcal {I} M$ such that $q_ i = p_ i \\circ q$ for every object $i$ of $\\mathcal{I}$. \n\n\n\n",," by cat_disch
  /-- It is the unique such map to do this -/
  uniq : âˆ€ (s : Cone F) (m : s.pt âŸ¶ t.pt) (_ : âˆ€ j : J, m â‰« t.Ï€.app j = s.Ï€.app j), m = lift s := by
    cat_disch
","structure IsLimit (t : Cone F) where
  /-- There is a morphism from any cone point to `t.pt` -/
  lift : âˆ€ s : Cone F, s.pt âŸ¶ t.pt
  /-- The map makes the triangle with the two natural transformations commute -/
  fac : âˆ€ (s : Cone F) (j : J), lift s â‰« t.Ï€.app j = s.Ï€.app j ",
94,002F,"structure IsColimit (t : Cocone F) where
  /-- `t.pt` maps to all other cocone covertices -/
  desc : âˆ€ s : Cocone F, t.pt âŸ¶ s.pt
  /-- The map `desc` makes the diagram with the natural transformations commute -/
  fac : âˆ€ (s : Cocone F) (j : J), t.Î¹.app j â‰« desc s = s.Î¹.app j := by cat_disch
  /-- `desc` is the unique such map -/
  uniq :
    âˆ€ (s : Cocone F) (m : t.pt âŸ¶ s.pt) (_ : âˆ€ j : J, t.Î¹.app j â‰« m = s.Î¹.app j), m = desc s := by
    cat_disch
",Formal Proof of Stacks Project Tag 002F,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Limits/IsLimit.lean#L520-L528,Q27041,,4.14.2,definition,3.0,"['002D', '0011', '0ELQ']","\n  Definition 4.14.2. A colimit of the $\\mathcal{I}$-diagram $M$ in the category $\\mathcal{C}$ is given by an object $\\mathop{\\mathrm{colim}}\\nolimits _\\mathcal {I} M$ in $\\mathcal{C}$ together with morphisms $s_ i : M_ i \\to \\mathop{\\mathrm{colim}}\\nolimits _\\mathcal {I} M$ such that \n  \n  \nfor $\\phi : i \\to i\'$ a morphism in $\\mathcal{I}$ we have $s_ i = s_{i\'} \\circ M(\\phi )$, and \n\n\nfor any object $W$ in $\\mathcal{C}$ and any family of morphisms $t_ i : M_ i \\to W$ (indexed by $i \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{I})$) such that for all $\\phi : i \\to i\'$ in $\\mathcal{I}$ we have $t_ i = t_{i\'} \\circ M(\\phi )$ there exists a unique morphism $t : \\mathop{\\mathrm{colim}}\\nolimits _\\mathcal {I} M \\to W$ such that $t_ i = t \\circ s_ i$ for every object $i$ of $\\mathcal{I}$. \n\n\n\n","\n  Definition 4.14.2. A colimit of the $\\mathcal{I}$-diagram $M$ in the category $\\mathcal{C}$ is given by an object $\\mathop{\\mathrm{colim}}\\nolimits _\\mathcal {I} M$ in $\\mathcal{C}$ together with morphisms $s_ i : M_ i \\to \\mathop{\\mathrm{colim}}\\nolimits _\\mathcal {I} M$ such that \n  \n  \nfor $\\phi : i \\to i\'$ a morphism in $\\mathcal{I}$ we have $s_ i = s_{i\'} \\circ M(\\phi )$, and \n\n\nfor any object $W$ in $\\mathcal{C}$ and any family of morphisms $t_ i : M_ i \\to W$ (indexed by $i \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{I})$) such that for all $\\phi : i \\to i\'$ in $\\mathcal{I}$ we have $t_ i = t_{i\'} \\circ M(\\phi )$ there exists a unique morphism $t : \\mathop{\\mathrm{colim}}\\nolimits _\\mathcal {I} M \\to W$ such that $t_ i = t \\circ s_ i$ for every object $i$ of $\\mathcal{I}$. \n\n\n\n",," by cat_disch
  /-- `desc` is the unique such map -/
  uniq :
    âˆ€ (s : Cocone F) (m : t.pt âŸ¶ s.pt) (_ : âˆ€ j : J, t.Î¹.app j â‰« m = s.Î¹.app j), m = desc s := by
    cat_disch
","structure IsColimit (t : Cocone F) where
  /-- `t.pt` maps to all other cocone covertices -/
  desc : âˆ€ s : Cocone F, t.pt âŸ¶ s.pt
  /-- The map `desc` makes the diagram with the natural transformations commute -/
  fac : âˆ€ (s : Cocone F) (j : J), t.Î¹.app j â‰« desc s = s.Î¹.app j ",
95,002N,"theorem has_limits_of_hasEqualizers_and_products [HasProducts.{w} C] [HasEqualizers C] :
    HasLimitsOfSize.{w, w} C :=
  { has_limits_of_shape :=
    fun _ _ => { has_limit := fun F => hasLimit_of_equalizer_and_product F } }
",Formal Proof of Stacks Project Tag 002N,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Limits/Constructions/LimitsOfProductsAndEqualizers.lean#L129-L132,Q27041,,4.14.11,lemma,3.0,"['002D', '0011', '0ELQ']","\n  Lemma 4.14.11. Let $M : \\mathcal{I} \\to \\mathcal{C}$ be a diagram. Write $I = \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{I})$ and $A = \\text{Arrows}(\\mathcal{I})$. Denote $s, t : A \\to I$ the source and target maps. Suppose that $\\prod _{i \\in I} M_ i$ and $\\prod _{a \\in A} M_{t(a)}$ exist. Suppose that the equalizer of \n  \n  \\[  \\xymatrix{ \\prod _{i \\in I} M_ i \\ar@<1ex>[r]^\\phi \\ar@<-1ex>[r]_\\psi &  \\prod _{a \\in A} M_{t(a)} }  \\]\n\n   exists, where the morphisms are determined by their components as follows: $p_ a \\circ \\psi = M(a) \\circ p_{s(a)}$ and $p_ a \\circ \\phi = p_{t(a)}$. Then this equalizer is the limit of the diagram. \n\n    \n      Proof.\n      Omitted. \n      $\\square$\n    \n","\n  Lemma 4.14.11. Let $M : \\mathcal{I} \\to \\mathcal{C}$ be a diagram. Write $I = \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{I})$ and $A = \\text{Arrows}(\\mathcal{I})$. Denote $s, t : A \\to I$ the source and target maps. Suppose that $\\prod _{i \\in I} M_ i$ and $\\prod _{a \\in A} M_{t(a)}$ exist. Suppose that the equalizer of \n  \n  \\[  \\xymatrix{ \\prod _{i \\in I} M_ i \\ar@<1ex>[r]^\\phi \\ar@<-1ex>[r]_\\psi &  \\prod _{a \\in A} M_{t(a)} }  \\]\n\n   exists, where the morphisms are determined by their components as follows: $p_ a \\circ \\psi = M(a) \\circ p_{s(a)}$ and $p_ a \\circ \\phi = p_{t(a)}$. Then this equalizer is the limit of the diagram. \n\n    \n",Proof.\n      Omitted. \n      $\\square$\n    \n,"
  { has_limits_of_shape :=
    fun _ _ => { has_limit := fun F => hasLimit_of_equalizer_and_product F } }
","theorem has_limits_of_hasEqualizers_and_products [HasProducts.{w} C] [HasEqualizers C] :
    HasLimitsOfSize.{w, w} C ",Proof.\n      Omitted. \n      $\\square$\n    \n
96,002O,"theorem hasFiniteLimits_of_hasEqualizers_and_finite_products [HasFiniteProducts C]
    [HasEqualizers C] : HasFiniteLimits C where
  out _ := { has_limit := fun F => hasLimit_of_equalizer_and_product F }
",Formal Proof of Stacks Project Tag 002O,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Limits/Constructions/LimitsOfProductsAndEqualizers.lean#L136-L138,Q27041,,4.18.4,lemma,3.0,"['04AS', '0011', '0ELQ']","\n  Lemma 4.18.4. Let $\\mathcal{C}$ be a category. The following are equivalent: \n  \n  \nFinite limits exist in $\\mathcal{C}$. \n\n\nFinite products and equalizers exist. \n\n\nThe category has a final object and fibre products exist. \n\n\n\n\n    \n      Proof.\n      Since finite products, fibre products, equalizers, and final objects are limits over finite index categories we see that (1) implies both (2) and (3). By Lemma 4.14.11 above we see that (2) implies (1). Assume (3). Note that the product $A \\times B$ is the fibre product over the final object. If $a, b : A \\to B$ are morphisms of $\\mathcal{C}$, then the equalizer of $a, b$ is \n    \n      \n  \\[  (A \\times _{a, B, b} A)\\times _{(\\text{pr}_1, \\text{pr}_2), A \\times A, \\Delta } A.  \\]\n\n    \n       Thus (3) implies (2) and the lemma is proved. \n      $\\square$\n    \n",\n  Lemma 4.18.4. Let $\\mathcal{C}$ be a category. The following are equivalent: \n  \n  \nFinite limits exist in $\\mathcal{C}$. \n\n\nFinite products and equalizers exist. \n\n\nThe category has a final object and fibre products exist. \n\n\n\n\n    \n,"Proof.\n      Since finite products, fibre products, equalizers, and final objects are limits over finite index categories we see that (1) implies both (2) and (3). By Lemma 4.14.11 above we see that (2) implies (1). Assume (3). Note that the product $A \\times B$ is the fibre product over the final object. If $a, b : A \\to B$ are morphisms of $\\mathcal{C}$, then the equalizer of $a, b$ is \n    \n      \n  \\[  (A \\times _{a, B, b} A)\\times _{(\\text{pr}_1, \\text{pr}_2), A \\times A, \\Delta } A.  \\]\n\n    \n       Thus (3) implies (2) and the lemma is proved. \n      $\\square$\n    \n"," { has_limit := fun F => hasLimit_of_equalizer_and_product F }
","theorem hasFiniteLimits_of_hasEqualizers_and_finite_products [HasFiniteProducts C]
    [HasEqualizers C] : HasFiniteLimits C where
  out _ ","Proof.\n      Since finite products, fibre products, equalizers, and final objects are limits over finite index categories we see that (1) implies both (2) and (3). By Lemma 4.14.11 [[\n  Lemma 4.14.11. Let $M : \\mathcal{I} \\to \\mathcal{C}$ be a diagram. Write $I = \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{I})$ and $A = \\text{Arrows}(\\mathcal{I})$. Denote $s, t : A \\to I$ the source and target maps. Suppose that $\\prod _{i \\in I} M_ i$ and $\\prod _{a \\in A} M_{t(a)}$ exist. Suppose that the equalizer of \n  \n  \\[  \\xymatrix{ \\prod _{i \\in I} M_ i \\ar@<1ex>[r]^\\phi \\ar@<-1ex>[r]_\\psi &  \\prod _{a \\in A} M_{t(a)} }  \\]\n\n   exists, where the morphisms are determined by their components as follows: $p_ a \\circ \\psi = M(a) \\circ p_{s(a)}$ and $p_ a \\circ \\phi = p_{t(a)}$. Then this equalizer is the limit of the diagram. \n\n    \n]] above we see that (2) implies (1). Assume (3). Note that the product $A \\times B$ is the fibre product over the final object. If $a, b : A \\to B$ are morphisms of $\\mathcal{C}$, then the equalizer of $a, b$ is \n    \n      \n  \\[  (A \\times _{a, B, b} A)\\times _{(\\text{pr}_1, \\text{pr}_2), A \\times A, \\Delta } A.  \\]\n\n    \n       Thus (3) implies (2) and the lemma is proved. \n      $\\square$\n    \n"
97,002P,"theorem has_colimits_of_hasCoequalizers_and_coproducts [HasCoproducts.{w} C] [HasCoequalizers C] :
    HasColimitsOfSize.{w, w} C where
  has_colimits_of_shape := fun _ _ =>
      { has_colimit := fun F => hasColimit_of_coequalizer_and_coproduct F }
",Formal Proof of Stacks Project Tag 002P,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Limits/Constructions/LimitsOfProductsAndEqualizers.lean#L394-L397,Q27041,,4.14.12,lemma,3.0,"['002D', '0011', '0ELQ']","\n       \n      \n  Lemma 4.14.12. Let $M : \\mathcal{I} \\to \\mathcal{C}$ be a diagram. Write $I = \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{I})$ and $A = \\text{Arrows}(\\mathcal{I})$. Denote $s, t : A \\to I$ the source and target maps. Suppose that $\\coprod _{i \\in I} M_ i$ and $\\coprod _{a \\in A} M_{s(a)}$ exist. Suppose that the coequalizer of \n  \n  \\[  \\xymatrix{ \\coprod _{a \\in A} M_{s(a)} \\ar@<1ex>[r]^\\phi \\ar@<-1ex>[r]_\\psi &  \\coprod _{i \\in I} M_ i }  \\]\n\n   exists, where the morphisms are determined by their components as follows: The component $M_{s(a)}$ maps via $\\psi $ to the component $M_{t(a)}$ via the morphism $M(a)$. The component $M_{s(a)}$ maps via $\\phi $ to the component $M_{s(a)}$ by the identity morphism. Then this coequalizer is the colimit of the diagram. \n\n    \n      Proof.\n      Omitted. \n      $\\square$\n    \n","\n       \n      \n  Lemma 4.14.12. Let $M : \\mathcal{I} \\to \\mathcal{C}$ be a diagram. Write $I = \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{I})$ and $A = \\text{Arrows}(\\mathcal{I})$. Denote $s, t : A \\to I$ the source and target maps. Suppose that $\\coprod _{i \\in I} M_ i$ and $\\coprod _{a \\in A} M_{s(a)}$ exist. Suppose that the coequalizer of \n  \n  \\[  \\xymatrix{ \\coprod _{a \\in A} M_{s(a)} \\ar@<1ex>[r]^\\phi \\ar@<-1ex>[r]_\\psi &  \\coprod _{i \\in I} M_ i }  \\]\n\n   exists, where the morphisms are determined by their components as follows: The component $M_{s(a)}$ maps via $\\psi $ to the component $M_{t(a)}$ via the morphism $M(a)$. The component $M_{s(a)}$ maps via $\\phi $ to the component $M_{s(a)}$ by the identity morphism. Then this coequalizer is the colimit of the diagram. \n\n    \n",Proof.\n      Omitted. \n      $\\square$\n    \n," fun _ _ =>
      { has_colimit := fun F => hasColimit_of_coequalizer_and_coproduct F }
","theorem has_colimits_of_hasCoequalizers_and_coproducts [HasCoproducts.{w} C] [HasCoequalizers C] :
    HasColimitsOfSize.{w, w} C where
  has_colimits_of_shape ",Proof.\n      Omitted. \n      $\\square$\n    \n
98,002Q,"theorem hasFiniteColimits_of_hasCoequalizers_and_finite_coproducts [HasFiniteCoproducts C]
    [HasCoequalizers C] : HasFiniteColimits C where
  out _ := { has_colimit := fun F => hasColimit_of_coequalizer_and_coproduct F }
",Formal Proof of Stacks Project Tag 002Q,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Limits/Constructions/LimitsOfProductsAndEqualizers.lean#L401-L403,Q27041,,4.18.7,lemma,3.0,"['04AS', '0011', '0ELQ']",\n  Lemma 4.18.7. Let $\\mathcal{C}$ be a category. The following are equivalent: \n  \n  \nFinite colimits exist in $\\mathcal{C}$. \n\n\nFinite coproducts and coequalizers exist in $\\mathcal{C}$. \n\n\nThe category has an initial object and pushouts exist. \n\n\n\n\n    \n      Proof.\n      Omitted. Hint: This is dual to Lemma 4.18.4. \n      $\\square$\n    \n,\n  Lemma 4.18.7. Let $\\mathcal{C}$ be a category. The following are equivalent: \n  \n  \nFinite colimits exist in $\\mathcal{C}$. \n\n\nFinite coproducts and coequalizers exist in $\\mathcal{C}$. \n\n\nThe category has an initial object and pushouts exist. \n\n\n\n\n    \n,Proof.\n      Omitted. Hint: This is dual to Lemma 4.18.4. \n      $\\square$\n    \n," { has_colimit := fun F => hasColimit_of_coequalizer_and_coproduct F }
","theorem hasFiniteColimits_of_hasCoequalizers_and_finite_coproducts [HasFiniteCoproducts C]
    [HasCoequalizers C] : HasFiniteColimits C where
  out _ ",Proof.\n      Omitted. Hint: This is dual to Lemma 4.18.4 [[\n  Lemma 4.18.4. Let $\\mathcal{C}$ be a category. The following are equivalent: \n  \n  \nFinite limits exist in $\\mathcal{C}$. \n\n\nFinite products and equalizers exist. \n\n\nThe category has a final object and fibre products exist. \n\n\n\n\n    \n]]. \n      $\\square$\n    \n
99,001T,"abbrev HasBinaryProducts :=
  HasLimitsOfShape (Discrete WalkingPair) C
",Formal Proof of Stacks Project Tag 001T,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Limits/Shapes/BinaryProducts.lean#L831-L832,Q27041,,4.4.2,definition,3.0,"['001R', '0011', '0ELQ']","\n  Definition 4.4.2. We say the category $\\mathcal{C}$ has products of pairs of objects if a product $x \\times y$ exists for any $x, y \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{C})$. \n","\n  Definition 4.4.2. We say the category $\\mathcal{C}$ has products of pairs of objects if a product $x \\times y$ exists for any $x, y \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{C})$. \n",,"
  HasLimitsOfShape (Discrete WalkingPair) C
",abbrev HasBinaryProducts ,
100,04AP,"abbrev HasBinaryCoproducts :=
  HasColimitsOfShape (Discrete WalkingPair) C
",Formal Proof of Stacks Project Tag 04AP,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Limits/Shapes/BinaryProducts.lean#L837-L838,Q27041,,4.5.2,definition,3.0,"['04AN', '0011', '0ELQ']","\n  Definition 4.5.2. We say the category $\\mathcal{C}$ has coproducts of pairs of objects if a coproduct $x \\amalg y$ exists for any $x, y \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{C})$. \n","\n  Definition 4.5.2. We say the category $\\mathcal{C}$ has coproducts of pairs of objects if a coproduct $x \\amalg y$ exists for any $x, y \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{C})$. \n",,"
  HasColimitsOfShape (Discrete WalkingPair) C
",abbrev HasBinaryCoproducts ,
101,0032,"lemma IsFiltered.exists_directed
    (J : Type w) [SmallCategory J] [IsFiltered J] :
    âˆƒ (Î± : Type w) (_ : PartialOrder Î±) (_ : IsDirected Î± (Â· â‰¤ Â·)) (_ : Nonempty Î±)
      (F : Î± â¥¤ J), F.Final := by
  have := (isCardinalFiltered_aleph0_iff.{w} J).2 inferInstance
  obtain âŸ¨Î±, _, _, F, _âŸ© := IsCardinalFiltered.exists_cardinal_directed J .aleph0
  have : IsFiltered Î± := by rwa [â† isCardinalFiltered_aleph0_iff.{w}]
  exact âŸ¨Î±, _, IsFiltered.isDirectedOrder _, nonempty, F, inferInstanceâŸ©
",Formal Proof of Stacks Project Tag 0032,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Presentable/Directed.lean#L545-L552,Q27041,,4.21.5,lemma,3.0,"['002Z', '0011', '0ELQ']","\n  Lemma 4.21.5. Let $\\mathcal{I}$ be a filtered index category. There exist a directed set $I$ and a system $(x_ i, \\varphi _{ii\'})$ over $I$ in $\\mathcal{I}$ with the following properties: \n  \n  \nFor every category $\\mathcal{C}$ and every diagram $M : \\mathcal{I} \\to \\mathcal{C}$ with values in $\\mathcal{C}$, denote $(M(x_ i), M(\\varphi _{ii\'}))$ the corresponding system over $I$. If $\\mathop{\\mathrm{colim}}\\nolimits _{i \\in I} M(x_ i)$ exists then so does $\\mathop{\\mathrm{colim}}\\nolimits _\\mathcal {I} M$ and the transformation \n\n\n  \\[  \\theta : \\mathop{\\mathrm{colim}}\\nolimits _{i \\in I} M(x_ i) \\longrightarrow \\mathop{\\mathrm{colim}}\\nolimits _\\mathcal {I} M  \\]\n\n\n of Lemma 4.14.8 is an isomorphism. \n\n\nFor every category $\\mathcal{C}$ and every diagram $M : \\mathcal{I}^{opp} \\to \\mathcal{C}$ in $\\mathcal{C}$, denote $(M(x_ i), M(\\varphi _{ii\'}))$ the corresponding inverse system over $I$. If $\\mathop{\\mathrm{lim}}\\nolimits _{i \\in I} M(x_ i)$ exists then so does $\\mathop{\\mathrm{lim}}\\nolimits _{\\mathcal{I}^{opp}} M$ and the transformation \n\n\n  \\[  \\theta : \\mathop{\\mathrm{lim}}\\nolimits _{\\mathcal{I}^{opp}} M \\longrightarrow \\mathop{\\mathrm{lim}}\\nolimits _{i \\in I} M(x_ i)  \\]\n\n\n of Lemma 4.14.9 is an isomorphism. \n\n\n\n\n    \n      Proof.\n      As explained in the text following Definition 4.21.2, we may view preordered sets as categories and systems as functors. Throughout the proof, we will freely shift between these two points of view. We prove the first statement by constructing a category $\\mathcal{I}_0$, corresponding to a directed set1, and a cofinal functor $M_0 : \\mathcal{I}_0 \\to \\mathcal{I}$. Then, by Lemma 4.17.2, the colimit of a diagram $M : \\mathcal{I} \\to \\mathcal{C}$ coincides with the colimit of the diagram $M \\circ M_0 : \\mathcal{I}_0 \\to \\mathcal{C}$, from which the statement follows. The second statement is dual to the first and may be proved by interpreting a limit in $\\mathcal{C}$ as a colimit in $\\mathcal{C}^{opp}$. We omit the details. \n    \n      A category $\\mathcal{F}$ is called finitely generated if there exists a finite set $F$ of arrows in $\\mathcal{F}$, such that each arrow in $\\mathcal{F}$ may be obtained by composing arrows from $F$. In particular, this implies that $\\mathcal{F}$ has finitely many objects. We start the proof by reducing to the case when $\\mathcal{I}$ has the property that every finitely generated subcategory of $\\mathcal{I}$ may be extended to a finitely generated subcategory with a unique final object. \n    \n      Let $\\omega $ denote the directed set of finite ordinals, which we view as a filtered category. It is easy to verify that the product category $\\mathcal{I}\\times \\omega $ is also filtered, and the projection $\\Pi : \\mathcal{I} \\times \\omega \\to \\mathcal{I}$ is cofinal. \n    \n      Now let $\\mathcal{F}$ be any finitely generated subcategory of $\\mathcal{I}\\times \\omega $. By using the axioms of a filtered category and a simple induction argument on a finite set of generators of $\\mathcal{F}$, we may construct a cocone $(\\{ f_ i\\} , i_\\infty )$ in $\\mathcal{I} \\times \\omega $ for the diagram $\\mathcal{F} \\to \\mathcal{I} \\times \\omega $. That is, a morphism $f_ i : i \\to i_\\infty $ for every object $i$ in $\\mathcal{F}$ such that for each arrow $f : i \\to i\'$ in $\\mathcal{F}$ we have $f_ i = f_{i\'} \\circ f$. We can also choose $i_\\infty $ such that there are no arrows from $i_\\infty $ to an object in $\\mathcal{F}$. This is possible since we may always post-compose the arrows $f_ i$ with an arrow which is the identity on the $\\mathcal{I}$-component and strictly increasing on the $\\omega $-component. Now let $\\mathcal{F}^+$ denote the category consisting of all objects and arrows in $\\mathcal{F}$ together with the object $i_\\infty $, the identity arrow $\\text{id}_{i_\\infty }$ and the arrows $f_ i$. Since there are no arrows from $i_\\infty $ in $\\mathcal{F}^+$ to any object of $\\mathcal{F}$, the arrow set in $\\mathcal{F}^+$ is closed under composition, so $\\mathcal{F}^+$ is indeed a category. By construction, it is a finitely generated subcategory of $\\mathcal{I}$ which has $i_\\infty $ as unique final object. Since, by Lemma 4.17.2, the colimit of any diagram $M : \\mathcal{I} \\to \\mathcal{C}$ coincides with the colimit of $M\\circ \\Pi $ , this gives the desired reduction. \n    \n      The set of all finitely generated subcategories of $\\mathcal{I}$ with a unique final object is naturally ordered by inclusion. We take $\\mathcal{I}_0$ to be the category corresponding to this set. We also have a functor $M_0 : \\mathcal{I}_0 \\to \\mathcal{I}$, which takes an arrow $\\mathcal{F} \\subset \\mathcal{F\'}$ in $\\mathcal{I}_0$ to the unique map from the final object of $\\mathcal{F}$ to the final object of $\\mathcal{F}\'$. Given any two finitely generated subcategories of $\\mathcal{I}$, the category generated by these two categories is also finitely generated. By our assumption on $\\mathcal{I}$, it is also contained in a finitely generated subcategory of $\\mathcal{I}$ with a unique final object. This shows that $\\mathcal{I}_0$ is directed. \n    \n      Finally, we verify that $M_0$ is cofinal. Since any object of $\\mathcal{I}$ is the final object in the subcategory consisting of only that object and its identity arrow, the functor $M_0$ is surjective on objects. In particular, Condition (1) of Definition 4.17.1 is satisfied. Given an object $i$ of $\\mathcal{I}$, objects $\\mathcal{F}_1, \\mathcal{F}_2$ in $\\mathcal{I}_0$ and maps $\\varphi _1 : i \\to M_0(\\mathcal{F}_1)$ and $\\varphi _2 : i \\to M_0(\\mathcal{F}_2)$ in $\\mathcal{I}$, we can take $\\mathcal{F}_{12}$ to be a finitely generated category with a unique final object containing $\\mathcal{F}_1$, $\\mathcal{F}_2$ and the morphisms $\\varphi _1, \\varphi _2$. The resulting diagram commutes \n    \n      \n  \\[  \\xymatrix{ &  M_0(\\mathcal{F}_{12}) &  \\\\  M_0(\\mathcal{F}_{1}) \\ar[ru] &  &  M_0(\\mathcal{F}_{2}) \\ar[lu] \\\\  &  i \\ar[lu] \\ar[ru] }  \\]\n\n    \n       since it lives in the category $\\mathcal{F}_{12}$ and $M_0(\\mathcal{F}_{12})$ is final in this category. Hence also Condition (2) is satisfied, which concludes the proof. \n      $\\square$\n    \n","\n  Lemma 4.21.5. Let $\\mathcal{I}$ be a filtered index category. There exist a directed set $I$ and a system $(x_ i, \\varphi _{ii\'})$ over $I$ in $\\mathcal{I}$ with the following properties: \n  \n  \nFor every category $\\mathcal{C}$ and every diagram $M : \\mathcal{I} \\to \\mathcal{C}$ with values in $\\mathcal{C}$, denote $(M(x_ i), M(\\varphi _{ii\'}))$ the corresponding system over $I$. If $\\mathop{\\mathrm{colim}}\\nolimits _{i \\in I} M(x_ i)$ exists then so does $\\mathop{\\mathrm{colim}}\\nolimits _\\mathcal {I} M$ and the transformation \n\n\n  \\[  \\theta : \\mathop{\\mathrm{colim}}\\nolimits _{i \\in I} M(x_ i) \\longrightarrow \\mathop{\\mathrm{colim}}\\nolimits _\\mathcal {I} M  \\]\n\n\n of Lemma 4.14.8 is an isomorphism. \n\n\nFor every category $\\mathcal{C}$ and every diagram $M : \\mathcal{I}^{opp} \\to \\mathcal{C}$ in $\\mathcal{C}$, denote $(M(x_ i), M(\\varphi _{ii\'}))$ the corresponding inverse system over $I$. If $\\mathop{\\mathrm{lim}}\\nolimits _{i \\in I} M(x_ i)$ exists then so does $\\mathop{\\mathrm{lim}}\\nolimits _{\\mathcal{I}^{opp}} M$ and the transformation \n\n\n  \\[  \\theta : \\mathop{\\mathrm{lim}}\\nolimits _{\\mathcal{I}^{opp}} M \\longrightarrow \\mathop{\\mathrm{lim}}\\nolimits _{i \\in I} M(x_ i)  \\]\n\n\n of Lemma 4.14.9 is an isomorphism. \n\n\n\n\n    \n","Proof.\n      As explained in the text following Definition 4.21.2, we may view preordered sets as categories and systems as functors. Throughout the proof, we will freely shift between these two points of view. We prove the first statement by constructing a category $\\mathcal{I}_0$, corresponding to a directed set1, and a cofinal functor $M_0 : \\mathcal{I}_0 \\to \\mathcal{I}$. Then, by Lemma 4.17.2, the colimit of a diagram $M : \\mathcal{I} \\to \\mathcal{C}$ coincides with the colimit of the diagram $M \\circ M_0 : \\mathcal{I}_0 \\to \\mathcal{C}$, from which the statement follows. The second statement is dual to the first and may be proved by interpreting a limit in $\\mathcal{C}$ as a colimit in $\\mathcal{C}^{opp}$. We omit the details. \n    \n      A category $\\mathcal{F}$ is called finitely generated if there exists a finite set $F$ of arrows in $\\mathcal{F}$, such that each arrow in $\\mathcal{F}$ may be obtained by composing arrows from $F$. In particular, this implies that $\\mathcal{F}$ has finitely many objects. We start the proof by reducing to the case when $\\mathcal{I}$ has the property that every finitely generated subcategory of $\\mathcal{I}$ may be extended to a finitely generated subcategory with a unique final object. \n    \n      Let $\\omega $ denote the directed set of finite ordinals, which we view as a filtered category. It is easy to verify that the product category $\\mathcal{I}\\times \\omega $ is also filtered, and the projection $\\Pi : \\mathcal{I} \\times \\omega \\to \\mathcal{I}$ is cofinal. \n    \n      Now let $\\mathcal{F}$ be any finitely generated subcategory of $\\mathcal{I}\\times \\omega $. By using the axioms of a filtered category and a simple induction argument on a finite set of generators of $\\mathcal{F}$, we may construct a cocone $(\\{ f_ i\\} , i_\\infty )$ in $\\mathcal{I} \\times \\omega $ for the diagram $\\mathcal{F} \\to \\mathcal{I} \\times \\omega $. That is, a morphism $f_ i : i \\to i_\\infty $ for every object $i$ in $\\mathcal{F}$ such that for each arrow $f : i \\to i\'$ in $\\mathcal{F}$ we have $f_ i = f_{i\'} \\circ f$. We can also choose $i_\\infty $ such that there are no arrows from $i_\\infty $ to an object in $\\mathcal{F}$. This is possible since we may always post-compose the arrows $f_ i$ with an arrow which is the identity on the $\\mathcal{I}$-component and strictly increasing on the $\\omega $-component. Now let $\\mathcal{F}^+$ denote the category consisting of all objects and arrows in $\\mathcal{F}$ together with the object $i_\\infty $, the identity arrow $\\text{id}_{i_\\infty }$ and the arrows $f_ i$. Since there are no arrows from $i_\\infty $ in $\\mathcal{F}^+$ to any object of $\\mathcal{F}$, the arrow set in $\\mathcal{F}^+$ is closed under composition, so $\\mathcal{F}^+$ is indeed a category. By construction, it is a finitely generated subcategory of $\\mathcal{I}$ which has $i_\\infty $ as unique final object. Since, by Lemma 4.17.2, the colimit of any diagram $M : \\mathcal{I} \\to \\mathcal{C}$ coincides with the colimit of $M\\circ \\Pi $ , this gives the desired reduction. \n    \n      The set of all finitely generated subcategories of $\\mathcal{I}$ with a unique final object is naturally ordered by inclusion. We take $\\mathcal{I}_0$ to be the category corresponding to this set. We also have a functor $M_0 : \\mathcal{I}_0 \\to \\mathcal{I}$, which takes an arrow $\\mathcal{F} \\subset \\mathcal{F\'}$ in $\\mathcal{I}_0$ to the unique map from the final object of $\\mathcal{F}$ to the final object of $\\mathcal{F}\'$. Given any two finitely generated subcategories of $\\mathcal{I}$, the category generated by these two categories is also finitely generated. By our assumption on $\\mathcal{I}$, it is also contained in a finitely generated subcategory of $\\mathcal{I}$ with a unique final object. This shows that $\\mathcal{I}_0$ is directed. \n    \n      Finally, we verify that $M_0$ is cofinal. Since any object of $\\mathcal{I}$ is the final object in the subcategory consisting of only that object and its identity arrow, the functor $M_0$ is surjective on objects. In particular, Condition (1) of Definition 4.17.1 is satisfied. Given an object $i$ of $\\mathcal{I}$, objects $\\mathcal{F}_1, \\mathcal{F}_2$ in $\\mathcal{I}_0$ and maps $\\varphi _1 : i \\to M_0(\\mathcal{F}_1)$ and $\\varphi _2 : i \\to M_0(\\mathcal{F}_2)$ in $\\mathcal{I}$, we can take $\\mathcal{F}_{12}$ to be a finitely generated category with a unique final object containing $\\mathcal{F}_1$, $\\mathcal{F}_2$ and the morphisms $\\varphi _1, \\varphi _2$. The resulting diagram commutes \n    \n      \n  \\[  \\xymatrix{ &  M_0(\\mathcal{F}_{12}) &  \\\\  M_0(\\mathcal{F}_{1}) \\ar[ru] &  &  M_0(\\mathcal{F}_{2}) \\ar[lu] \\\\  &  i \\ar[lu] \\ar[ru] }  \\]\n\n    \n       since it lives in the category $\\mathcal{F}_{12}$ and $M_0(\\mathcal{F}_{12})$ is final in this category. Hence also Condition (2) is satisfied, which concludes the proof. \n      $\\square$\n    \n"," by
  have := (isCardinalFiltered_aleph0_iff.{w} J).2 inferInstance
  obtain âŸ¨Î±, _, _, F, _âŸ© := IsCardinalFiltered.exists_cardinal_directed J .aleph0
  have : IsFiltered Î± := by rwa [â† isCardinalFiltered_aleph0_iff.{w}]
  exact âŸ¨Î±, _, IsFiltered.isDirectedOrder _, nonempty, F, inferInstanceâŸ©
","lemma IsFiltered.exists_directed
    (J : Type w) [SmallCategory J] [IsFiltered J] :
    âˆƒ (Î± : Type w) (_ : PartialOrder Î±) (_ : IsDirected Î± (Â· â‰¤ Â·)) (_ : Nonempty Î±)
      (F : Î± â¥¤ J), F.Final ","Proof.\n      As explained in the text following Definition 4.21.2 [[\n  Definition 4.21.2. Let $(I, \\leq )$ be a preordered set. Let $\\mathcal{C}$ be a category. \n  \n  \nA system over $I$ in $\\mathcal{C}$, sometimes called a inductive system over $I$ in $\\mathcal{C}$ is given by objects $M_ i$ of $\\mathcal{C}$ and for every $i \\leq i\'$ a morphism $f_{ii\'} : M_ i \\to M_{i\'}$ such that $f_{ii} = \\text{id}$ and such that $f_{ii\'\'} = f_{i\'i\'\'} \\circ f_{i i\'}$ whenever $i \\leq i\' \\leq i\'\'$. \n\n\nAn inverse system over $I$ in $\\mathcal{C}$, sometimes called a projective system over $I$ in $\\mathcal{C}$ is given by objects $M_ i$ of $\\mathcal{C}$ and for every $i\' \\leq i$ a morphism $f_{ii\'} : M_ i \\to M_{i\'}$ such that $f_{ii} = \\text{id}$ and such that $f_{ii\'\'} = f_{i\'i\'\'} \\circ f_{i i\'}$ whenever $i\'\' \\leq i\' \\leq i$. (Note reversal of inequalities.) \n\n\n\n   We will say $(M_ i, f_{ii\'})$ is a (inverse) system over $I$ to denote this. The maps $f_{ii\'}$ are sometimes called the transition maps. \n]], we may view preordered sets as categories and systems as functors. Throughout the proof, we will freely shift between these two points of view. We prove the first statement by constructing a category $\\mathcal{I}_0$, corresponding to a directed set1, and a cofinal functor $M_0 : \\mathcal{I}_0 \\to \\mathcal{I}$. Then, by Lemma 4.17.2 [[\n  Lemma 4.17.2. Let $H : \\mathcal{I} \\to \\mathcal{J}$ be a functor of categories. Assume $\\mathcal{I}$ is cofinal in $\\mathcal{J}$. Then for every diagram $M : \\mathcal{J} \\to \\mathcal{C}$ we have a canonical isomorphism \n  \n  \\[  \\mathop{\\mathrm{colim}}\\nolimits _\\mathcal {I} M \\circ H = \\mathop{\\mathrm{colim}}\\nolimits _\\mathcal {J} M  \\]\n\n   if either side exists. \n\n    \n]], the colimit of a diagram $M : \\mathcal{I} \\to \\mathcal{C}$ coincides with the colimit of the diagram $M \\circ M_0 : \\mathcal{I}_0 \\to \\mathcal{C}$, from which the statement follows. The second statement is dual to the first and may be proved by interpreting a limit in $\\mathcal{C}$ as a colimit in $\\mathcal{C}^{opp}$. We omit the details. \n    \n      A category $\\mathcal{F}$ is called finitely generated if there exists a finite set $F$ of arrows in $\\mathcal{F}$, such that each arrow in $\\mathcal{F}$ may be obtained by composing arrows from $F$. In particular, this implies that $\\mathcal{F}$ has finitely many objects. We start the proof by reducing to the case when $\\mathcal{I}$ has the property that every finitely generated subcategory of $\\mathcal{I}$ may be extended to a finitely generated subcategory with a unique final object. \n    \n      Let $\\omega $ denote the directed set of finite ordinals, which we view as a filtered category. It is easy to verify that the product category $\\mathcal{I}\\times \\omega $ is also filtered, and the projection $\\Pi : \\mathcal{I} \\times \\omega \\to \\mathcal{I}$ is cofinal. \n    \n      Now let $\\mathcal{F}$ be any finitely generated subcategory of $\\mathcal{I}\\times \\omega $. By using the axioms of a filtered category and a simple induction argument on a finite set of generators of $\\mathcal{F}$, we may construct a cocone $(\\{ f_ i\\} , i_\\infty )$ in $\\mathcal{I} \\times \\omega $ for the diagram $\\mathcal{F} \\to \\mathcal{I} \\times \\omega $. That is, a morphism $f_ i : i \\to i_\\infty $ for every object $i$ in $\\mathcal{F}$ such that for each arrow $f : i \\to i\'$ in $\\mathcal{F}$ we have $f_ i = f_{i\'} \\circ f$. We can also choose $i_\\infty $ such that there are no arrows from $i_\\infty $ to an object in $\\mathcal{F}$. This is possible since we may always post-compose the arrows $f_ i$ with an arrow which is the identity on the $\\mathcal{I}$-component and strictly increasing on the $\\omega $-component. Now let $\\mathcal{F}^+$ denote the category consisting of all objects and arrows in $\\mathcal{F}$ together with the object $i_\\infty $, the identity arrow $\\text{id}_{i_\\infty }$ and the arrows $f_ i$. Since there are no arrows from $i_\\infty $ in $\\mathcal{F}^+$ to any object of $\\mathcal{F}$, the arrow set in $\\mathcal{F}^+$ is closed under composition, so $\\mathcal{F}^+$ is indeed a category. By construction, it is a finitely generated subcategory of $\\mathcal{I}$ which has $i_\\infty $ as unique final object. Since, by Lemma 4.17.2 [[\n  Lemma 4.17.2. Let $H : \\mathcal{I} \\to \\mathcal{J}$ be a functor of categories. Assume $\\mathcal{I}$ is cofinal in $\\mathcal{J}$. Then for every diagram $M : \\mathcal{J} \\to \\mathcal{C}$ we have a canonical isomorphism \n  \n  \\[  \\mathop{\\mathrm{colim}}\\nolimits _\\mathcal {I} M \\circ H = \\mathop{\\mathrm{colim}}\\nolimits _\\mathcal {J} M  \\]\n\n   if either side exists. \n\n    \n]], the colimit of any diagram $M : \\mathcal{I} \\to \\mathcal{C}$ coincides with the colimit of $M\\circ \\Pi $ , this gives the desired reduction. \n    \n      The set of all finitely generated subcategories of $\\mathcal{I}$ with a unique final object is naturally ordered by inclusion. We take $\\mathcal{I}_0$ to be the category corresponding to this set. We also have a functor $M_0 : \\mathcal{I}_0 \\to \\mathcal{I}$, which takes an arrow $\\mathcal{F} \\subset \\mathcal{F\'}$ in $\\mathcal{I}_0$ to the unique map from the final object of $\\mathcal{F}$ to the final object of $\\mathcal{F}\'$. Given any two finitely generated subcategories of $\\mathcal{I}$, the category generated by these two categories is also finitely generated. By our assumption on $\\mathcal{I}$, it is also contained in a finitely generated subcategory of $\\mathcal{I}$ with a unique final object. This shows that $\\mathcal{I}_0$ is directed. \n    \n      Finally, we verify that $M_0$ is cofinal. Since any object of $\\mathcal{I}$ is the final object in the subcategory consisting of only that object and its identity arrow, the functor $M_0$ is surjective on objects. In particular, Condition (1) of Definition 4.17.1 [[\n  Definition 4.17.1. Let $H : \\mathcal{I} \\to \\mathcal{J}$ be a functor between categories. We say $\\mathcal{I}$ is cofinal in $\\mathcal{J}$ or that $H$ is cofinal if \n  \n  \nfor all $y \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{J})$ there exist an $x \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{I})$ and a morphism $y \\to H(x)$, and \n\n\ngiven $y \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{J})$, $x, x\' \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{I})$ and morphisms $y \\to H(x)$ and $y \\to H(x\')$ there exist a sequence of morphisms \n\n\n  \\[  x = x_0 \\leftarrow x_1 \\rightarrow x_2 \\leftarrow x_3 \\rightarrow \\ldots \\rightarrow x_{2n} = x\'  \\]\n\n\n in $\\mathcal{I}$ and morphisms $y \\to H(x_ i)$ in $\\mathcal{J}$ with $y \\to H(x_0)$ and $y \\to H(x_{2n})$ the given morphisms such that the diagrams \n\n\n  \\[  \\xymatrix{ &  y \\ar[ld] \\ar[d] \\ar[rd] \\\\  H(x_{2k}) &  H(x_{2k + 1}) \\ar[l] \\ar[r] &  H(x_{2k + 2}) }  \\]\n\n\n commute for $k = 0, \\ldots , n - 1$. \n\n\n\n   In other words, fixing an object $y$ of $\\mathcal{J}$ consider the set $S$ of pairs $(x, b)$ where $x$ is an object of $\\mathcal{I}$ and $b : y \\to H(x)$ is a morphism. Consider the equivalence relation on $S$ generated by $(x, b) \\sim (x\', b\')$ if there exists a morphism $a : x \\to x\'$ with $b\' = H(a) \\circ b$. Then $S$ should consist of exactly one equivalence class. \n]] is satisfied. Given an object $i$ of $\\mathcal{I}$, objects $\\mathcal{F}_1, \\mathcal{F}_2$ in $\\mathcal{I}_0$ and maps $\\varphi _1 : i \\to M_0(\\mathcal{F}_1)$ and $\\varphi _2 : i \\to M_0(\\mathcal{F}_2)$ in $\\mathcal{I}$, we can take $\\mathcal{F}_{12}$ to be a finitely generated category with a unique final object containing $\\mathcal{F}_1$, $\\mathcal{F}_2$ and the morphisms $\\varphi _1, \\varphi _2$. The resulting diagram commutes \n    \n      \n  \\[  \\xymatrix{ &  M_0(\\mathcal{F}_{12}) &  \\\\  M_0(\\mathcal{F}_{1}) \\ar[ru] &  &  M_0(\\mathcal{F}_{2}) \\ar[lu] \\\\  &  i \\ar[lu] \\ar[ru] }  \\]\n\n    \n       since it lives in the category $\\mathcal{F}_{12}$ and $M_0(\\mathcal{F}_{12})$ is final in this category. Hence also Condition (2) is satisfied, which concludes the proof. \n      $\\square$\n    \n"
102,001W,"abbrev HasPullbacks :=
  HasLimitsOfShape WalkingCospan C
",Formal Proof of Stacks Project Tag 001W,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Limits/Shapes/Pullback/HasPullback.lean#L538-L539,Q27041,,4.6.3,definition,3.0,"['001U', '0011', '0ELQ']","\n  Definition 4.6.3. We say the category $\\mathcal{C}$ has fibre products if the fibre product exists for any $f\\in \\mathop{\\mathrm{Mor}}\\nolimits _{\\mathcal C}(x, y)$ and $g\\in \\mathop{\\mathrm{Mor}}\\nolimits _{\\mathcal C}(z, y)$. \n","\n  Definition 4.6.3. We say the category $\\mathcal{C}$ has fibre products if the fibre product exists for any $f\\in \\mathop{\\mathrm{Mor}}\\nolimits _{\\mathcal C}(x, y)$ and $g\\in \\mathop{\\mathrm{Mor}}\\nolimits _{\\mathcal C}(z, y)$. \n",,"
  HasLimitsOfShape WalkingCospan C
",abbrev HasPullbacks ,
103,002U,"instance (priority := 1300) hasLimitsOfSize [UnivLE.{v, u}] : HasLimitsOfSize.{w, v} (Type u) where
  has_limits_of_shape _ := { }
",Formal Proof of Stacks Project Tag 002U,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Limits/Types/Limits.lean#L189-L190,Q27041,Limits and colimits in the category of sets,4.15,section,2.0,"['0011', '0ELQ']","4.15 Limits and colimits in the category of sets\n\n\nNot only do limits and colimits exist in $\\textit{Sets}$ but they are also easy to describe. Namely, let $M : \\mathcal{I} \\to \\textit{Sets}$, $i \\mapsto M_ i$ be a diagram of sets. Denote $I = \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{I})$. The limit is described as \n\n\n  \\[  \\mathop{\\mathrm{lim}}\\nolimits _\\mathcal {I} M = \\{  (m_ i)_{i\\in I} \\in \\prod \\nolimits _{i\\in I} M_ i \\mid \\forall \\phi : i \\to i\' \\text{ in }\\mathcal{I}, M(\\phi )(m_ i) = m_{i\'} \\} .  \\]\n\n\n So we think of an element of the limit as a compatible system of elements of all the sets $M_ i$. \n\n\nOn the other hand, the colimit is \n\n\n  \\[  \\mathop{\\mathrm{colim}}\\nolimits _\\mathcal {I} M = (\\coprod \\nolimits _{i\\in I} M_ i)/\\sim  \\]\n\n\n where the equivalence relation $\\sim $ is the equivalence relation generated by setting $m_ i \\sim m_{i\'}$ if $m_ i \\in M_ i$, $m_{i\'} \\in M_{i\'}$ and $M(\\phi )(m_ i) = m_{i\'}$ for some $\\phi : i \\to i\'$. In other words, $m_ i \\in M_ i$ and $m_{i\'} \\in M_{i\'}$ are equivalent if there are a chain of morphisms in $\\mathcal{I}$ \n\n\n  \\[  \\xymatrix{ &  i_1 \\ar[ld] \\ar[rd] &  &  i_3 \\ar[ld] &  &  i_{2n-1} \\ar[rd] &  \\\\  i = i_0 &  &  i_2 &  &  \\ldots &  &  i_{2n} = i\' }  \\]\n\n\n and elements $m_{i_ j} \\in M_{i_ j}$ mapping to each other under the maps $M_{i_{2k-1}} \\to M_{i_{2k-2}}$ and $M_{i_{2k-1}} \\to M_{i_{2k}}$ induced from the maps in $\\mathcal{I}$ above. \n\n\nThis is not a very pleasant type of object to work with. But if the diagram is filtered then it is much easier to describe. We will explain this in Section 4.19. \n\n","4.15 Limits and colimits in the category of sets\n\n\nNot only do limits and colimits exist in $\\textit{Sets}$ but they are also easy to describe. Namely, let $M : \\mathcal{I} \\to \\textit{Sets}$, $i \\mapsto M_ i$ be a diagram of sets. Denote $I = \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{I})$. The limit is described as \n\n\n  \\[  \\mathop{\\mathrm{lim}}\\nolimits _\\mathcal {I} M = \\{  (m_ i)_{i\\in I} \\in \\prod \\nolimits _{i\\in I} M_ i \\mid \\forall \\phi : i \\to i\' \\text{ in }\\mathcal{I}, M(\\phi )(m_ i) = m_{i\'} \\} .  \\]\n\n\n So we think of an element of the limit as a compatible system of elements of all the sets $M_ i$. \n\n\nOn the other hand, the colimit is \n\n\n  \\[  \\mathop{\\mathrm{colim}}\\nolimits _\\mathcal {I} M = (\\coprod \\nolimits _{i\\in I} M_ i)/\\sim  \\]\n\n\n where the equivalence relation $\\sim $ is the equivalence relation generated by setting $m_ i \\sim m_{i\'}$ if $m_ i \\in M_ i$, $m_{i\'} \\in M_{i\'}$ and $M(\\phi )(m_ i) = m_{i\'}$ for some $\\phi : i \\to i\'$. In other words, $m_ i \\in M_ i$ and $m_{i\'} \\in M_{i\'}$ are equivalent if there are a chain of morphisms in $\\mathcal{I}$ \n\n\n  \\[  \\xymatrix{ &  i_1 \\ar[ld] \\ar[rd] &  &  i_3 \\ar[ld] &  &  i_{2n-1} \\ar[rd] &  \\\\  i = i_0 &  &  i_2 &  &  \\ldots &  &  i_{2n} = i\' }  \\]\n\n\n and elements $m_{i_ j} \\in M_{i_ j}$ mapping to each other under the maps $M_{i_{2k-1}} \\to M_{i_{2k-2}}$ and $M_{i_{2k-1}} \\to M_{i_{2k}}$ induced from the maps in $\\mathcal{I}$ above. \n\n\nThis is not a very pleasant type of object to work with. But if the diagram is filtered then it is much easier to describe. We will explain this in Section 4.19. \n\n",," 1300) hasLimitsOfSize [UnivLE.{v, u}] : HasLimitsOfSize.{w, v} (Type u) where
  has_limits_of_shape _ := { }
",instance (priority ,
104,0FFK,"-- Porting note: The Mathport did not translate the temporary notation
class MonoidalCategory (C : Type u) [ð’ž : Category.{v} C] extends MonoidalCategoryStruct C where
  tensorHom_def {Xâ‚ Yâ‚ Xâ‚‚ Yâ‚‚ : C} (f : Xâ‚ âŸ¶ Yâ‚) (g : Xâ‚‚ âŸ¶ Yâ‚‚) :
    f âŠ—â‚˜ g = (f â–· Xâ‚‚) â‰« (Yâ‚ â— g) := by
      cat_disch
  /-- Tensor product of identity maps is the identity: `ðŸ™ Xâ‚ âŠ—â‚˜ ðŸ™ Xâ‚‚ = ðŸ™ (Xâ‚ âŠ— Xâ‚‚)` -/
  id_tensorHom_id : âˆ€ Xâ‚ Xâ‚‚ : C, ðŸ™ Xâ‚ âŠ—â‚˜ ðŸ™ Xâ‚‚ = ðŸ™ (Xâ‚ âŠ— Xâ‚‚) := by cat_disch
  /--
  Composition of tensor products is tensor product of compositions:
  `(fâ‚ âŠ—â‚˜ fâ‚‚) â‰« (gâ‚ âŠ—â‚˜ gâ‚‚) = (fâ‚ â‰« gâ‚) âŠ—â‚˜ (fâ‚‚ â‰« gâ‚‚)`
  -/
  tensorHom_comp_tensorHom :
    âˆ€ {Xâ‚ Yâ‚ Zâ‚ Xâ‚‚ Yâ‚‚ Zâ‚‚ : C} (fâ‚ : Xâ‚ âŸ¶ Yâ‚) (fâ‚‚ : Xâ‚‚ âŸ¶ Yâ‚‚) (gâ‚ : Yâ‚ âŸ¶ Zâ‚) (gâ‚‚ : Yâ‚‚ âŸ¶ Zâ‚‚),
      (fâ‚ âŠ—â‚˜ fâ‚‚) â‰« (gâ‚ âŠ—â‚˜ gâ‚‚) = (fâ‚ â‰« gâ‚) âŠ—â‚˜ (fâ‚‚ â‰« gâ‚‚) := by
    cat_disch
  whiskerLeft_id : âˆ€ (X Y : C), X â— ðŸ™ Y = ðŸ™ (X âŠ— Y) := by
    cat_disch
  id_whiskerRight : âˆ€ (X Y : C), ðŸ™ X â–· Y = ðŸ™ (X âŠ— Y) := by
    cat_disch
  /-- Naturality of the associator isomorphism: `(fâ‚ âŠ—â‚˜ fâ‚‚) âŠ—â‚˜ fâ‚ƒ â‰ƒ fâ‚ âŠ—â‚˜ (fâ‚‚ âŠ—â‚˜ fâ‚ƒ)` -/
  associator_naturality :
    âˆ€ {Xâ‚ Xâ‚‚ Xâ‚ƒ Yâ‚ Yâ‚‚ Yâ‚ƒ : C} (fâ‚ : Xâ‚ âŸ¶ Yâ‚) (fâ‚‚ : Xâ‚‚ âŸ¶ Yâ‚‚) (fâ‚ƒ : Xâ‚ƒ âŸ¶ Yâ‚ƒ),
      ((fâ‚ âŠ—â‚˜ fâ‚‚) âŠ—â‚˜ fâ‚ƒ) â‰« (Î±_ Yâ‚ Yâ‚‚ Yâ‚ƒ).hom = (Î±_ Xâ‚ Xâ‚‚ Xâ‚ƒ).hom â‰« (fâ‚ âŠ—â‚˜ (fâ‚‚ âŠ—â‚˜ fâ‚ƒ)) := by
    cat_disch
  /--
  Naturality of the left unitor, commutativity of `ðŸ™_ C âŠ— X âŸ¶ ðŸ™_ C âŠ— Y âŸ¶ Y` and `ðŸ™_ C âŠ— X âŸ¶ X âŸ¶ Y`
  -/
  leftUnitor_naturality :
    âˆ€ {X Y : C} (f : X âŸ¶ Y), ðŸ™_ _ â— f â‰« (Î»_ Y).hom = (Î»_ X).hom â‰« f := by
    cat_disch
  /--
  Naturality of the right unitor: commutativity of `X âŠ— ðŸ™_ C âŸ¶ Y âŠ— ðŸ™_ C âŸ¶ Y` and `X âŠ— ðŸ™_ C âŸ¶ X âŸ¶ Y`
  -/
  rightUnitor_naturality :
    âˆ€ {X Y : C} (f : X âŸ¶ Y), f â–· ðŸ™_ _ â‰« (Ï_ Y).hom = (Ï_ X).hom â‰« f := by
    cat_disch
  /--
  The pentagon identity relating the isomorphism between `X âŠ— (Y âŠ— (Z âŠ— W))` and `((X âŠ— Y) âŠ— Z) âŠ— W`
  -/
  pentagon :
    âˆ€ W X Y Z : C,
      (Î±_ W X Y).hom â–· Z â‰« (Î±_ W (X âŠ— Y) Z).hom â‰« W â— (Î±_ X Y Z).hom =
        (Î±_ (W âŠ— X) Y Z).hom â‰« (Î±_ W X (Y âŠ— Z)).hom := by
    cat_disch
  /--
  The identity relating the isomorphisms between `X âŠ— (ðŸ™_ C âŠ— Y)`, `(X âŠ— ðŸ™_ C) âŠ— Y` and `X âŠ— Y`
  -/
  triangle :
    âˆ€ X Y : C, (Î±_ X (ðŸ™_ _) Y).hom â‰« X â— (Î»_ Y).hom = (Ï_ X).hom â–· Y := by
    cat_disch
",Formal Proof of Stacks Project Tag 0FFK,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Monoidal/Category.lean#L159-L208,Q27041,,4.43.1,definition,3.0,"['0FFJ', '0011', '0ELQ']","\n  Definition 4.43.1. A triple $(\\mathcal{C}, \\otimes , \\phi )$ where $\\mathcal{C}$ is a category, $\\otimes : \\mathcal{C} \\times \\mathcal{C} \\to \\mathcal{C}$ is a functor, and $\\phi $ is an associativity constraint is called a monoidal category if there exists a unit $\\mathbf{1}$. \n","\n  Definition 4.43.1. A triple $(\\mathcal{C}, \\otimes , \\phi )$ where $\\mathcal{C}$ is a category, $\\otimes : \\mathcal{C} \\times \\mathcal{C} \\to \\mathcal{C}$ is a functor, and $\\phi $ is an associativity constraint is called a monoidal category if there exists a unit $\\mathbf{1}$. \n",," by
      cat_disch
  /-- Tensor product of identity maps is the identity: `ðŸ™ Xâ‚ âŠ—â‚˜ ðŸ™ Xâ‚‚ = ðŸ™ (Xâ‚ âŠ— Xâ‚‚)` -/
  id_tensorHom_id : âˆ€ Xâ‚ Xâ‚‚ : C, ðŸ™ Xâ‚ âŠ—â‚˜ ðŸ™ Xâ‚‚ = ðŸ™ (Xâ‚ âŠ— Xâ‚‚) := by cat_disch
  /--
  Composition of tensor products is tensor product of compositions:
  `(fâ‚ âŠ—â‚˜ fâ‚‚) â‰« (gâ‚ âŠ—â‚˜ gâ‚‚) = (fâ‚ â‰« gâ‚) âŠ—â‚˜ (fâ‚‚ â‰« gâ‚‚)`
  -/
  tensorHom_comp_tensorHom :
    âˆ€ {Xâ‚ Yâ‚ Zâ‚ Xâ‚‚ Yâ‚‚ Zâ‚‚ : C} (fâ‚ : Xâ‚ âŸ¶ Yâ‚) (fâ‚‚ : Xâ‚‚ âŸ¶ Yâ‚‚) (gâ‚ : Yâ‚ âŸ¶ Zâ‚) (gâ‚‚ : Yâ‚‚ âŸ¶ Zâ‚‚),
      (fâ‚ âŠ—â‚˜ fâ‚‚) â‰« (gâ‚ âŠ—â‚˜ gâ‚‚) = (fâ‚ â‰« gâ‚) âŠ—â‚˜ (fâ‚‚ â‰« gâ‚‚) := by
    cat_disch
  whiskerLeft_id : âˆ€ (X Y : C), X â— ðŸ™ Y = ðŸ™ (X âŠ— Y) := by
    cat_disch
  id_whiskerRight : âˆ€ (X Y : C), ðŸ™ X â–· Y = ðŸ™ (X âŠ— Y) := by
    cat_disch
  /-- Naturality of the associator isomorphism: `(fâ‚ âŠ—â‚˜ fâ‚‚) âŠ—â‚˜ fâ‚ƒ â‰ƒ fâ‚ âŠ—â‚˜ (fâ‚‚ âŠ—â‚˜ fâ‚ƒ)` -/
  associator_naturality :
    âˆ€ {Xâ‚ Xâ‚‚ Xâ‚ƒ Yâ‚ Yâ‚‚ Yâ‚ƒ : C} (fâ‚ : Xâ‚ âŸ¶ Yâ‚) (fâ‚‚ : Xâ‚‚ âŸ¶ Yâ‚‚) (fâ‚ƒ : Xâ‚ƒ âŸ¶ Yâ‚ƒ),
      ((fâ‚ âŠ—â‚˜ fâ‚‚) âŠ—â‚˜ fâ‚ƒ) â‰« (Î±_ Yâ‚ Yâ‚‚ Yâ‚ƒ).hom = (Î±_ Xâ‚ Xâ‚‚ Xâ‚ƒ).hom â‰« (fâ‚ âŠ—â‚˜ (fâ‚‚ âŠ—â‚˜ fâ‚ƒ)) := by
    cat_disch
  /--
  Naturality of the left unitor, commutativity of `ðŸ™_ C âŠ— X âŸ¶ ðŸ™_ C âŠ— Y âŸ¶ Y` and `ðŸ™_ C âŠ— X âŸ¶ X âŸ¶ Y`
  -/
  leftUnitor_naturality :
    âˆ€ {X Y : C} (f : X âŸ¶ Y), ðŸ™_ _ â— f â‰« (Î»_ Y).hom = (Î»_ X).hom â‰« f := by
    cat_disch
  /--
  Naturality of the right unitor: commutativity of `X âŠ— ðŸ™_ C âŸ¶ Y âŠ— ðŸ™_ C âŸ¶ Y` and `X âŠ— ðŸ™_ C âŸ¶ X âŸ¶ Y`
  -/
  rightUnitor_naturality :
    âˆ€ {X Y : C} (f : X âŸ¶ Y), f â–· ðŸ™_ _ â‰« (Ï_ Y).hom = (Ï_ X).hom â‰« f := by
    cat_disch
  /--
  The pentagon identity relating the isomorphism between `X âŠ— (Y âŠ— (Z âŠ— W))` and `((X âŠ— Y) âŠ— Z) âŠ— W`
  -/
  pentagon :
    âˆ€ W X Y Z : C,
      (Î±_ W X Y).hom â–· Z â‰« (Î±_ W (X âŠ— Y) Z).hom â‰« W â— (Î±_ X Y Z).hom =
        (Î±_ (W âŠ— X) Y Z).hom â‰« (Î±_ W X (Y âŠ— Z)).hom := by
    cat_disch
  /--
  The identity relating the isomorphisms between `X âŠ— (ðŸ™_ C âŠ— Y)`, `(X âŠ— ðŸ™_ C) âŠ— Y` and `X âŠ— Y`
  -/
  triangle :
    âˆ€ X Y : C, (Î±_ X (ðŸ™_ _) Y).hom â‰« X â— (Î»_ Y).hom = (Ï_ X).hom â–· Y := by
    cat_disch
","-- Porting note: The Mathport did not translate the temporary notation
class MonoidalCategory (C : Type u) [ð’ž : Category.{v} C] extends MonoidalCategoryStruct C where
  tensorHom_def {Xâ‚ Yâ‚ Xâ‚‚ Yâ‚‚ : C} (f : Xâ‚ âŸ¶ Yâ‚) (g : Xâ‚‚ âŸ¶ Yâ‚‚) :
    f âŠ—â‚˜ g = (f â–· Xâ‚‚) â‰« (Yâ‚ â— g) ",
105,0FFW,"class SymmetricCategory (C : Type u) [Category.{v} C] [MonoidalCategory.{v} C] extends
    BraidedCategory.{v} C where
  -- braiding symmetric:
  symmetry : âˆ€ X Y : C, (Î²_ X Y).hom â‰« (Î²_ Y X).hom = ðŸ™ (X âŠ— Y) := by cat_disch
",Formal Proof of Stacks Project Tag 0FFW,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Monoidal/Braided/Basic.lean#L364-L367,Q27041,,4.43.9,definition,3.0,"['0FFJ', '0011', '0ELQ']","\n  Definition 4.43.9. A quadruple $(\\mathcal{C}, \\otimes , \\phi , \\psi )$ where $\\mathcal{C}$ is a category, $\\otimes : \\mathcal{C} \\otimes \\mathcal{C} \\to \\mathcal{C}$ is a functor, $\\phi $ is an associativity constraint, and $\\psi $ is a commutativity constraint compatible with $\\phi $ is called a symmetric monoidal category if there exists a unit. \n","\n  Definition 4.43.9. A quadruple $(\\mathcal{C}, \\otimes , \\phi , \\psi )$ where $\\mathcal{C}$ is a category, $\\otimes : \\mathcal{C} \\otimes \\mathcal{C} \\to \\mathcal{C}$ is a functor, $\\phi $ is an associativity constraint, and $\\psi $ is a commutativity constraint compatible with $\\phi $ is called a symmetric monoidal category if there exists a unit. \n",," by cat_disch
","class SymmetricCategory (C : Type u) [Category.{v} C] [MonoidalCategory.{v} C] extends
    BraidedCategory.{v} C where
  -- braiding symmetric:
  symmetry : âˆ€ X Y : C, (Î²_ X Y).hom â‰« (Î²_ Y X).hom = ðŸ™ (X âŠ— Y) ",
106,0BSI,"lemma IsStableUnderComposition.ind_of_preIndSpreads
    [âˆ€ X : C, (IsFinitelyAccessibleCategory.{w} (Under X))] [HasPushouts C]
    [P.IsStableUnderComposition] [P.IsStableUnderCobaseChange]
    [PreIndSpreads.{w} P] (H : P â‰¤ isFinitelyPresentable.{w} C) :
    (ind.{w} P).IsStableUnderComposition where
  comp_mem {X Y Z} f g hf hg := by
    rw [ind_iff_exists H]
    intro T p u hp hpu
    obtain âŸ¨Jâ‚, _, _, Dâ‚, sâ‚, tâ‚, htâ‚, hâ‚âŸ© := hf
    obtain âŸ¨Jâ‚‚, _, _, Dâ‚‚, sâ‚‚, tâ‚‚, htâ‚‚, hâ‚‚âŸ© := hg
    have : IsFinitelyPresentable (CategoryTheory.Under.mk p) := hp
    obtain âŸ¨jâ‚‚, q, hcomp, huâŸ© := IsFinitelyPresentable.exists_hom_of_isColimit_under
        htâ‚‚ p ((Functor.const _).map f â‰« sâ‚‚) u <| by simp [hâ‚‚, hpu]
    obtain âŸ¨jâ‚, W, f', g', h, hf'âŸ© :=
      P.exists_isPushout_of_isFiltered htâ‚ (sâ‚‚.app jâ‚‚) (hâ‚‚ jâ‚‚).left
    let D' : Under jâ‚ â¥¤ C :=
      (Under.post Dâ‚ â‹™ Under.pushout f') â‹™ CategoryTheory.Under.forget _
    let c' : Cocone D' :=
      (Under.pushout f' â‹™ CategoryTheory.Under.forget _).mapCocone
        ((Cocone.mk _ tâ‚).underPost jâ‚) |>.extend h.isoPushout.inv
    let hc' : IsColimit c' :=
      IsColimit.extendIso _ <| isColimitOfPreserves _ (htâ‚.underPost jâ‚)
    let s' : (Functor.const (Under jâ‚)).obj X âŸ¶ D' :=
      { app k := sâ‚.app k.right â‰« pushout.inl _ _
        naturality k l a := by
          have h2 := sâ‚.naturality a.right
          simp only [Functor.const_obj_obj, Functor.const_obj_map, Category.id_comp] at h2
          simp [h2, D'] }
    obtain âŸ¨jâ‚ƒ, v, hcomp', hqâŸ© := IsFinitelyPresentable.exists_hom_of_isColimit_under
        hc' p s' q <| fun k â†¦ by
      simp [c', s', hcomp, reassoc_of% (hâ‚ k.right).right]
    refine âŸ¨D'.obj jâ‚ƒ, v, c'.Î¹.app jâ‚ƒ â‰« tâ‚‚.app jâ‚‚, ?_, ?_âŸ©
    Â· rwa [reassoc_of% hq]
    Â· rw [hcomp']
      exact P.comp_mem _ _ (hâ‚ _).left (P.pushout_inl _ _ hf')
",Formal Proof of Stacks Project Tag 0BSI,The stacks project lemma is for the special case of ind-Ã©tale ring homomorphisms.,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/MorphismProperty/Ind.lean#L182-L216,Q27041,,10.154.2,lemma,3.0,"['0BSG', '00AO', '0ELQ']","\n  Lemma 10.154.2. Let $A \\to B \\to C$ be ring maps. If $A \\to B$ is a filtered colimit of \xc3\xa9tale ring maps and $B \\to C$ is a filtered colimit of \xc3\xa9tale ring maps, then $A \\to C$ is a filtered colimit of \xc3\xa9tale ring maps. \n\n    \n      Proof.\n      We will use the criterion of Lemma 10.127.4. Let $A \\to P \\to C$ be a factorization of $A \\to C$ with $P$ of finite presentation over $A$. Write $B = \\mathop{\\mathrm{colim}}\\nolimits _{i \\in I} B_ i$ where $I$ is a directed set and where $B_ i$ is an \xc3\xa9tale $A$-algebra. Write $C = \\mathop{\\mathrm{colim}}\\nolimits _{j \\in J} C_ j$ where $J$ is a directed set and where $C_ j$ is an \xc3\xa9tale $B$-algebra. We can factor $P \\to C$ as $P \\to C_ j \\to C$ for some $j$ by Lemma 10.127.3. By Lemma 10.143.3 we can find an $i \\in I$ and an \xc3\xa9tale ring map $B_ i \\to C\'_ j$ such that $C_ j = B \\otimes _{B_ i} C\'_ j$. Then $C_ j = \\mathop{\\mathrm{colim}}\\nolimits _{i\' \\geq i} B_{i\'} \\otimes _{B_ i} C\'_ j$ and again we see that $P \\to C_ j$ factors as $P \\to B_{i\'} \\otimes _{B_ i} C\'_ j \\to C$. As $A \\to C\' = B_{i\'} \\otimes _{B_ i} C\'_ j$ is \xc3\xa9tale as compositions and tensor products of \xc3\xa9tale ring maps are \xc3\xa9tale. Hence we have factored $P \\to C$ as $P \\to C\' \\to C$ with $C\'$ \xc3\xa9tale over $A$ and the criterion of Lemma 10.127.4 applies. \n      $\\square$\n    \n","\n  Lemma 10.154.2. Let $A \\to B \\to C$ be ring maps. If $A \\to B$ is a filtered colimit of \xc3\xa9tale ring maps and $B \\to C$ is a filtered colimit of \xc3\xa9tale ring maps, then $A \\to C$ is a filtered colimit of \xc3\xa9tale ring maps. \n\n    \n",Proof.\n      We will use the criterion of Lemma 10.127.4. Let $A \\to P \\to C$ be a factorization of $A \\to C$ with $P$ of finite presentation over $A$. Write $B = \\mathop{\\mathrm{colim}}\\nolimits _{i \\in I} B_ i$ where $I$ is a directed set and where $B_ i$ is an \xc3\xa9tale $A$-algebra. Write $C = \\mathop{\\mathrm{colim}}\\nolimits _{j \\in J} C_ j$ where $J$ is a directed set and where $C_ j$ is an \xc3\xa9tale $B$-algebra. We can factor $P \\to C$ as $P \\to C_ j \\to C$ for some $j$ by Lemma 10.127.3. By Lemma 10.143.3 we can find an $i \\in I$ and an \xc3\xa9tale ring map $B_ i \\to C\'_ j$ such that $C_ j = B \\otimes _{B_ i} C\'_ j$. Then $C_ j = \\mathop{\\mathrm{colim}}\\nolimits _{i\' \\geq i} B_{i\'} \\otimes _{B_ i} C\'_ j$ and again we see that $P \\to C_ j$ factors as $P \\to B_{i\'} \\otimes _{B_ i} C\'_ j \\to C$. As $A \\to C\' = B_{i\'} \\otimes _{B_ i} C\'_ j$ is \xc3\xa9tale as compositions and tensor products of \xc3\xa9tale ring maps are \xc3\xa9tale. Hence we have factored $P \\to C$ as $P \\to C\' \\to C$ with $C\'$ \xc3\xa9tale over $A$ and the criterion of Lemma 10.127.4 applies. \n      $\\square$\n    \n," by
    rw [ind_iff_exists H]
    intro T p u hp hpu
    obtain âŸ¨Jâ‚, _, _, Dâ‚, sâ‚, tâ‚, htâ‚, hâ‚âŸ© := hf
    obtain âŸ¨Jâ‚‚, _, _, Dâ‚‚, sâ‚‚, tâ‚‚, htâ‚‚, hâ‚‚âŸ© := hg
    have : IsFinitelyPresentable (CategoryTheory.Under.mk p) := hp
    obtain âŸ¨jâ‚‚, q, hcomp, huâŸ© := IsFinitelyPresentable.exists_hom_of_isColimit_under
        htâ‚‚ p ((Functor.const _).map f â‰« sâ‚‚) u <| by simp [hâ‚‚, hpu]
    obtain âŸ¨jâ‚, W, f', g', h, hf'âŸ© :=
      P.exists_isPushout_of_isFiltered htâ‚ (sâ‚‚.app jâ‚‚) (hâ‚‚ jâ‚‚).left
    let D' : Under jâ‚ â¥¤ C :=
      (Under.post Dâ‚ â‹™ Under.pushout f') â‹™ CategoryTheory.Under.forget _
    let c' : Cocone D' :=
      (Under.pushout f' â‹™ CategoryTheory.Under.forget _).mapCocone
        ((Cocone.mk _ tâ‚).underPost jâ‚) |>.extend h.isoPushout.inv
    let hc' : IsColimit c' :=
      IsColimit.extendIso _ <| isColimitOfPreserves _ (htâ‚.underPost jâ‚)
    let s' : (Functor.const (Under jâ‚)).obj X âŸ¶ D' :=
      { app k := sâ‚.app k.right â‰« pushout.inl _ _
        naturality k l a := by
          have h2 := sâ‚.naturality a.right
          simp only [Functor.const_obj_obj, Functor.const_obj_map, Category.id_comp] at h2
          simp [h2, D'] }
    obtain âŸ¨jâ‚ƒ, v, hcomp', hqâŸ© := IsFinitelyPresentable.exists_hom_of_isColimit_under
        hc' p s' q <| fun k â†¦ by
      simp [c', s', hcomp, reassoc_of% (hâ‚ k.right).right]
    refine âŸ¨D'.obj jâ‚ƒ, v, c'.Î¹.app jâ‚ƒ â‰« tâ‚‚.app jâ‚‚, ?_, ?_âŸ©
    Â· rwa [reassoc_of% hq]
    Â· rw [hcomp']
      exact P.comp_mem _ _ (hâ‚ _).left (P.pushout_inl _ _ hf')
","lemma IsStableUnderComposition.ind_of_preIndSpreads
    [âˆ€ X : C, (IsFinitelyAccessibleCategory.{w} (Under X))] [HasPushouts C]
    [P.IsStableUnderComposition] [P.IsStableUnderCobaseChange]
    [PreIndSpreads.{w} P] (H : P â‰¤ isFinitelyPresentable.{w} C) :
    (ind.{w} P).IsStableUnderComposition where
  comp_mem {X Y Z} f g hf hg ","Proof.\n      We will use the criterion of Lemma 10.127.4 [[\n  Lemma 10.127.4. Let $R \\to \\Lambda $ be a ring map. Let $\\mathcal{E}$ be a set of $R$-algebras such that each $A \\in \\mathcal{E}$ is of finite presentation over $R$. Then the following two statements are equivalent \n  \n  \n$\\Lambda $ is a filtered colimit of elements of $\\mathcal{E}$, and \n\n\nfor any $R$ algebra map $A \\to \\Lambda $ with $A$ of finite presentation over $R$ we can find a factorization $A \\to B \\to \\Lambda $ with $B \\in \\mathcal{E}$. \n\n\n\n\n    \n]]. Let $A \\to P \\to C$ be a factorization of $A \\to C$ with $P$ of finite presentation over $A$. Write $B = \\mathop{\\mathrm{colim}}\\nolimits _{i \\in I} B_ i$ where $I$ is a directed set and where $B_ i$ is an \xc3\xa9tale $A$-algebra. Write $C = \\mathop{\\mathrm{colim}}\\nolimits _{j \\in J} C_ j$ where $J$ is a directed set and where $C_ j$ is an \xc3\xa9tale $B$-algebra. We can factor $P \\to C$ as $P \\to C_ j \\to C$ for some $j$ by Lemma 10.127.3 [[\n  Lemma 10.127.3. Let $\\varphi : R \\to S$ be a ring map. The following are equivalent \n  \n  \n$\\varphi $ is of finite presentation, \n\n\nfor every directed system $A_\\lambda $ of $R$-algebras the map \n\n\n  \\[  \\mathop{\\mathrm{colim}}\\nolimits _\\lambda \\mathop{\\mathrm{Hom}}\\nolimits _ R(S, A_\\lambda ) \\longrightarrow \\mathop{\\mathrm{Hom}}\\nolimits _ R(S, \\mathop{\\mathrm{colim}}\\nolimits _\\lambda A_\\lambda )  \\]\n\n\n is bijective, and \n\n\nfor every directed system $A_\\lambda $ of $R$-algebras the map \n\n\n  \\[  \\mathop{\\mathrm{colim}}\\nolimits _\\lambda \\mathop{\\mathrm{Hom}}\\nolimits _ R(S, A_\\lambda ) \\longrightarrow \\mathop{\\mathrm{Hom}}\\nolimits _ R(S, \\mathop{\\mathrm{colim}}\\nolimits _\\lambda A_\\lambda )  \\]\n\n\n is surjective. \n\n\n\n\n    \n]]. By Lemma 10.143.3 [[\n  Lemma 10.143.3. Results on \xc3\xa9tale ring maps. \n  \n  \nThe ring map $R \\to R_ f$ is \xc3\xa9tale for any ring $R$ and any $f \\in R$. \n\n\nCompositions of \xc3\xa9tale ring maps are \xc3\xa9tale. \n\n\nA base change of an \xc3\xa9tale ring map is \xc3\xa9tale. \n\n\nThe property of being \xc3\xa9tale is local: Given a ring map $R \\to S$ and elements $g_1, \\ldots , g_ m \\in S$ which generate the unit ideal such that $R \\to S_{g_ j}$ is \xc3\xa9tale for $j = 1, \\ldots , m$ then $R \\to S$ is \xc3\xa9tale. \n\n\nGiven $R \\to S$ of finite presentation, and a flat ring map $R \\to R\'$, set $S\' = R\' \\otimes _ R S$. The set of primes where $R\' \\to S\'$ is \xc3\xa9tale is the inverse image via $\\mathop{\\mathrm{Spec}}(S\') \\to \\mathop{\\mathrm{Spec}}(S)$ of the set of primes where $R \\to S$ is \xc3\xa9tale. \n\n\nAn \xc3\xa9tale ring map is syntomic, in particular flat. \n\n\nIf $S$ is finite type over a field $k$, then $S$ is \xc3\xa9tale over $k$ if and only if $\\Omega _{S/k} = 0$. \n\n\nAny \xc3\xa9tale ring map $R \\to S$ is the base change of an \xc3\xa9tale ring map $R_0 \\to S_0$ with $R_0$ of finite type over $\\mathbf{Z}$. \n\n\nLet $A = \\mathop{\\mathrm{colim}}\\nolimits A_ i$ be a filtered colimit of rings. Let $A \\to B$ be an \xc3\xa9tale ring map. Then there exists an \xc3\xa9tale ring map $A_ i \\to B_ i$ for some $i$ such that $B \\cong A \\otimes _{A_ i} B_ i$. \n\n\nLet $A$ be a ring. Let $S$ be a multiplicative subset of $A$. Let $S^{-1}A \\to B\'$ be \xc3\xa9tale. Then there exists an \xc3\xa9tale ring map $A \\to B$ such that $B\' \\cong S^{-1}B$. \n\n\nLet $A$ be a ring. Let $B = B\' \\times B\'\'$ be a product of $A$-algebras. Then $B$ is \xc3\xa9tale over $A$ if and only if both $B\'$ and $B\'\'$ are \xc3\xa9tale over $A$. \n\n\n\n\n    \n]] we can find an $i \\in I$ and an \xc3\xa9tale ring map $B_ i \\to C\'_ j$ such that $C_ j = B \\otimes _{B_ i} C\'_ j$. Then $C_ j = \\mathop{\\mathrm{colim}}\\nolimits _{i\' \\geq i} B_{i\'} \\otimes _{B_ i} C\'_ j$ and again we see that $P \\to C_ j$ factors as $P \\to B_{i\'} \\otimes _{B_ i} C\'_ j \\to C$. As $A \\to C\' = B_{i\'} \\otimes _{B_ i} C\'_ j$ is \xc3\xa9tale as compositions and tensor products of \xc3\xa9tale ring maps are \xc3\xa9tale. Hence we have factored $P \\to C$ as $P \\to C\' \\to C$ with $C\'$ \xc3\xa9tale over $A$ and the criterion of Lemma 10.127.4 [[\n  Lemma 10.127.4. Let $R \\to \\Lambda $ be a ring map. Let $\\mathcal{E}$ be a set of $R$-algebras such that each $A \\in \\mathcal{E}$ is of finite presentation over $R$. Then the following two statements are equivalent \n  \n  \n$\\Lambda $ is a filtered colimit of elements of $\\mathcal{E}$, and \n\n\nfor any $R$ algebra map $A \\to \\Lambda $ with $A$ of finite presentation over $R$ we can find a factorization $A \\to B \\to \\Lambda $ with $B \\in \\mathcal{E}$. \n\n\n\n\n    \n]] applies. \n      $\\square$\n    \n"
107,0FXB,"def leftOrthogonal : ObjectProperty C :=
  fun X â†¦ âˆ€ â¦ƒY : Câ¦„ (f : X âŸ¶ Y), P Y â†’ f = 0
",Formal Proof of Stacks Project Tag 0FXB,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/ObjectProperty/Orthogonal.lean#L47-L48,Q27041,,13.40.1,definition,3.0,"['0CQP', '05QI', '0ELQ']","\n  Definition 13.40.1. Let $\\mathcal{D}$ be an additive category. Let $\\mathcal{A} \\subset \\mathcal{D}$ be a full subcategory. The right orthogonal $\\mathcal{A}^\\perp $ of $\\mathcal{A}$ is the full subcategory consisting of the objects $X$ of $\\mathcal{D}$ such that $\\mathop{\\mathrm{Hom}}\\nolimits (A, X) = 0$ for all $A \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{A})$. The left orthogonal ${}^\\perp \\mathcal{A}$ of $\\mathcal{A}$ is the full subcategory consisting of the objects $X$ of $\\mathcal{D}$ such that $\\mathop{\\mathrm{Hom}}\\nolimits (X, A) = 0$ for all $A \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{A})$. \n","\n  Definition 13.40.1. Let $\\mathcal{D}$ be an additive category. Let $\\mathcal{A} \\subset \\mathcal{D}$ be a full subcategory. The right orthogonal $\\mathcal{A}^\\perp $ of $\\mathcal{A}$ is the full subcategory consisting of the objects $X$ of $\\mathcal{D}$ such that $\\mathop{\\mathrm{Hom}}\\nolimits (A, X) = 0$ for all $A \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{A})$. The left orthogonal ${}^\\perp \\mathcal{A}$ of $\\mathcal{A}$ is the full subcategory consisting of the objects $X$ of $\\mathcal{D}$ such that $\\mathop{\\mathrm{Hom}}\\nolimits (X, A) = 0$ for all $A \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{A})$. \n",,"
  fun X â†¦ âˆ€ â¦ƒY : Câ¦„ (f : X âŸ¶ Y), P Y â†’ f = 0
",def leftOrthogonal : ObjectProperty C ,
108,00ZY,"class Preadditive where
  homGroup : âˆ€ P Q : C, AddCommGroup (P âŸ¶ Q) := by infer_instance
  add_comp : âˆ€ (P Q R : C) (f f' : P âŸ¶ Q) (g : Q âŸ¶ R), (f + f') â‰« g = f â‰« g + f' â‰« g := by
    cat_disch
  comp_add : âˆ€ (P Q R : C) (f : P âŸ¶ Q) (g g' : Q âŸ¶ R), f â‰« (g + g') = f â‰« g + f â‰« g' := by
    cat_disch
",Formal Proof of Stacks Project Tag 00ZY,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Preadditive/Basic.lean#L63-L68,Q27041,,12.3.1,definition,3.0,"['09SE', '00ZU', '0ELQ']","\n  Definition 12.3.1. A category $\\mathcal{A}$ is called preadditive if each morphism set $\\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {A}(x, y)$ is endowed with the structure of an abelian group such that the compositions \n  \n  \\[  \\mathop{\\mathrm{Mor}}\\nolimits (x, y) \\times \\mathop{\\mathrm{Mor}}\\nolimits (y, z) \\longrightarrow \\mathop{\\mathrm{Mor}}\\nolimits (x, z)  \\]\n\n   are bilinear. A functor $F : \\mathcal{A} \\to \\mathcal{B}$ of preadditive categories is called additive if and only if $F : \\mathop{\\mathrm{Mor}}\\nolimits (x, y) \\to \\mathop{\\mathrm{Mor}}\\nolimits (F(x), F(y))$ is a homomorphism of abelian groups for all $x, y \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{A})$. \n","\n  Definition 12.3.1. A category $\\mathcal{A}$ is called preadditive if each morphism set $\\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {A}(x, y)$ is endowed with the structure of an abelian group such that the compositions \n  \n  \\[  \\mathop{\\mathrm{Mor}}\\nolimits (x, y) \\times \\mathop{\\mathrm{Mor}}\\nolimits (y, z) \\longrightarrow \\mathop{\\mathrm{Mor}}\\nolimits (x, z)  \\]\n\n   are bilinear. A functor $F : \\mathcal{A} \\to \\mathcal{B}$ of preadditive categories is called additive if and only if $F : \\mathop{\\mathrm{Mor}}\\nolimits (x, y) \\to \\mathop{\\mathrm{Mor}}\\nolimits (F(x), F(y))$ is a homomorphism of abelian groups for all $x, y \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{A})$. \n",," by infer_instance
  add_comp : âˆ€ (P Q R : C) (f f' : P âŸ¶ Q) (g : Q âŸ¶ R), (f + f') â‰« g = f â‰« g + f' â‰« g := by
    cat_disch
  comp_add : âˆ€ (P Q R : C) (f : P âŸ¶ Q) (g g' : Q âŸ¶ R), f â‰« (g + g') = f â‰« g + f â‰« g' := by
    cat_disch
","class Preadditive where
  homGroup : âˆ€ P Q : C, AddCommGroup (P âŸ¶ Q) ",
109,001K,"instance prod' : Category.{max vâ‚ vâ‚‚} (C Ã— D) where
",Formal Proof of Stacks Project Tag 001K,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Products/Basic.lean#L99-L99,Q27041,,4.2.20,definition,3.0,"['0013', '0011', '0ELQ']","\n  Definition 4.2.20. Let $\\mathcal{A}$, $\\mathcal{B}$ be categories. We define the product category $\\mathcal{A} \\times \\mathcal{B}$ to be the category with objects $\\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{A} \\times \\mathcal{B}) = \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{A}) \\times \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{B})$ and \n  \n  \\[  \\mathop{\\mathrm{Mor}}\\nolimits _{\\mathcal{A} \\times \\mathcal{B}}((x, y), (x\', y\')) := \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {A}(x, x\')\\times \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {B}(y, y\').  \\]\n\n   Composition is defined componentwise. \n","\n  Definition 4.2.20. Let $\\mathcal{A}$, $\\mathcal{B}$ be categories. We define the product category $\\mathcal{A} \\times \\mathcal{B}$ to be the category with objects $\\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{A} \\times \\mathcal{B}) = \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{A}) \\times \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{B})$ and \n  \n  \\[  \\mathop{\\mathrm{Mor}}\\nolimits _{\\mathcal{A} \\times \\mathcal{B}}((x, y), (x\', y\')) := \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {A}(x, x\')\\times \\mathop{\\mathrm{Mor}}\\nolimits _\\mathcal {B}(y, y\').  \\]\n\n   Composition is defined componentwise. \n",,,"instance prod' : Category.{max vâ‚ vâ‚‚} (C Ã— D) where
",
110,00Z9,"proof (see the Stacks comments).""]
def finestTopologySingle (P : Cáµ’áµ– â¥¤ Type v) : GrothendieckTopology C where
  sieves X S := âˆ€ (Y) (f : Y âŸ¶ X), Presieve.IsSheafFor P (S.pullback f : Presieve Y)
  top_mem' X Y f := by
    rw [Sieve.pullback_top]
    exact Presieve.isSheafFor_top_sieve P
  pullback_stable' X Y S f hS Z g := by
    rw [â† pullback_comp]
    apply hS
  transitive' X S hS R hR Z g := by
    -- This is the hard part of the construction, showing that the given set of sieves satisfies
    -- the transitivity axiom.
    refine isSheafFor_trans P (pullback g S) _ (hS Z g) ?_ ?_
    Â· intro Y f _
      rw [â† pullback_comp]
      apply (hS _ _).isSeparatedFor
    Â· intro Y f hf
      have := hR hf _ (ðŸ™ _)
      rw [pullback_id, pullback_comp] at this
      apply this
",Formal Proof of Stacks Project Tag 00Z9,"This is a special case of the Stacks entry, but following a differen",https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Sites/Canonical.lean#L145-L164,Q27041,,7.47.11,lemma,3.0,"['00YW', '00UZ', '0ELQ']","\n  Lemma 7.47.11. Let $\\mathcal{C}$ be a category. Let $\\{  \\mathcal{F}_ i \\} _{i\\in I}$ be a collection of presheaves of sets on $\\mathcal{C}$. For each $U \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{C})$ denote $J(U)$ the set of sieves $S$ with the following property: For every morphism $V \\to U$, the maps \n  \n  \\[  \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(h_ V, \\mathcal{F}_ i) \\longrightarrow \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(S \\times _ U V, \\mathcal{F}_ i)  \\]\n\n   are bijective for all $i \\in I$. Then $J$ defines a topology on $\\mathcal{C}$. This topology is the finest topology in which all of the $\\mathcal{F}_ i$ are sheaves. \n\n    \n      Proof.\n      If we show that $J$ is a topology, then the last statement of the lemma immediately follows. The first and third axioms of a topology are immediately verified. Thus, assume that we have an object $U$, and sieves $S, S\'$ of $U$ such that $S \\in J(U)$, and for all $V \\to U$ in $S(V)$ we have $S\' \\times _ U V \\in J(V)$. We have to show that $S\' \\in J(U)$. In other words, we have to show that for any $f : W \\to U$, the maps \n    \n      \n  \\[  \\mathcal{F}_ i(W) = \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(h_ W, \\mathcal{F}_ i) \\longrightarrow \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(S\' \\times _ U W, \\mathcal{F}_ i)  \\]\n\n    \n       are bijective for all $i \\in I$. Pick an element $i \\in I$ and pick an element $\\varphi \\in \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(S\' \\times _ U W, \\mathcal{F}_ i)$. We will construct a section $s \\in \\mathcal{F}_ i(W)$ mapping to $\\varphi $. \n    \n      Suppose $\\alpha : V \\to W$ is an element of $S \\times _ U W$. According to the definition of pullbacks we see that the composition $f \\circ \\alpha : V \\to W \\to U$ is in $S$. Hence $S\' \\times _ U V$ is in $J(W)$ by assumption on the pair of sieves $S, S\'$. Now we have a commutative diagram of presheaves \n    \n      \n  \\[  \\xymatrix{ S\' \\times _ U V \\ar[r] \\ar[d] &  h_ V \\ar[d] \\\\  S\' \\times _ U W \\ar[r] &  h_ W }  \\]\n\n    \n       The restriction of $\\varphi $ to $S\' \\times _ U V$ corresponds to an element $s_{V, \\alpha } \\in \\mathcal{F}_ i(V)$. This we see from the definition of $J$, and because $S\' \\times _ U V$ is in $J(W)$. We leave it to the reader to check that the rule $(V, \\alpha ) \\mapsto s_{V, \\alpha }$ defines an element $\\psi \\in \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(S \\times _ U W, \\mathcal{F}_ i)$. Since $S \\in J(U)$ we see immediately from the definition of $J$ that $\\psi $ corresponds to an element $s$ of $\\mathcal{F}_ i(W)$. \n    \n      We leave it to the reader to verify that the construction $\\varphi \\mapsto s$ is inverse to the natural map displayed above. \n      $\\square$\n    \n","\n  Lemma 7.47.11. Let $\\mathcal{C}$ be a category. Let $\\{  \\mathcal{F}_ i \\} _{i\\in I}$ be a collection of presheaves of sets on $\\mathcal{C}$. For each $U \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{C})$ denote $J(U)$ the set of sieves $S$ with the following property: For every morphism $V \\to U$, the maps \n  \n  \\[  \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(h_ V, \\mathcal{F}_ i) \\longrightarrow \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(S \\times _ U V, \\mathcal{F}_ i)  \\]\n\n   are bijective for all $i \\in I$. Then $J$ defines a topology on $\\mathcal{C}$. This topology is the finest topology in which all of the $\\mathcal{F}_ i$ are sheaves. \n\n    \n","Proof.\n      If we show that $J$ is a topology, then the last statement of the lemma immediately follows. The first and third axioms of a topology are immediately verified. Thus, assume that we have an object $U$, and sieves $S, S\'$ of $U$ such that $S \\in J(U)$, and for all $V \\to U$ in $S(V)$ we have $S\' \\times _ U V \\in J(V)$. We have to show that $S\' \\in J(U)$. In other words, we have to show that for any $f : W \\to U$, the maps \n    \n      \n  \\[  \\mathcal{F}_ i(W) = \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(h_ W, \\mathcal{F}_ i) \\longrightarrow \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(S\' \\times _ U W, \\mathcal{F}_ i)  \\]\n\n    \n       are bijective for all $i \\in I$. Pick an element $i \\in I$ and pick an element $\\varphi \\in \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(S\' \\times _ U W, \\mathcal{F}_ i)$. We will construct a section $s \\in \\mathcal{F}_ i(W)$ mapping to $\\varphi $. \n    \n      Suppose $\\alpha : V \\to W$ is an element of $S \\times _ U W$. According to the definition of pullbacks we see that the composition $f \\circ \\alpha : V \\to W \\to U$ is in $S$. Hence $S\' \\times _ U V$ is in $J(W)$ by assumption on the pair of sieves $S, S\'$. Now we have a commutative diagram of presheaves \n    \n      \n  \\[  \\xymatrix{ S\' \\times _ U V \\ar[r] \\ar[d] &  h_ V \\ar[d] \\\\  S\' \\times _ U W \\ar[r] &  h_ W }  \\]\n\n    \n       The restriction of $\\varphi $ to $S\' \\times _ U V$ corresponds to an element $s_{V, \\alpha } \\in \\mathcal{F}_ i(V)$. This we see from the definition of $J$, and because $S\' \\times _ U V$ is in $J(W)$. We leave it to the reader to check that the rule $(V, \\alpha ) \\mapsto s_{V, \\alpha }$ defines an element $\\psi \\in \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(S \\times _ U W, \\mathcal{F}_ i)$. Since $S \\in J(U)$ we see immediately from the definition of $J$ that $\\psi $ corresponds to an element $s$ of $\\mathcal{F}_ i(W)$. \n    \n      We leave it to the reader to verify that the construction $\\varphi \\mapsto s$ is inverse to the natural map displayed above. \n      $\\square$\n    \n"," âˆ€ (Y) (f : Y âŸ¶ X), Presieve.IsSheafFor P (S.pullback f : Presieve Y)
  top_mem' X Y f := by
    rw [Sieve.pullback_top]
    exact Presieve.isSheafFor_top_sieve P
  pullback_stable' X Y S f hS Z g := by
    rw [â† pullback_comp]
    apply hS
  transitive' X S hS R hR Z g := by
    -- This is the hard part of the construction, showing that the given set of sieves satisfies
    -- the transitivity axiom.
    refine isSheafFor_trans P (pullback g S) _ (hS Z g) ?_ ?_
    Â· intro Y f _
      rw [â† pullback_comp]
      apply (hS _ _).isSeparatedFor
    Â· intro Y f hf
      have := hR hf _ (ðŸ™ _)
      rw [pullback_id, pullback_comp] at this
      apply this
","proof (see the Stacks comments).""]
def finestTopologySingle (P : Cáµ’áµ– â¥¤ Type v) : GrothendieckTopology C where
  sieves X S ","Proof.\n      If we show that $J$ is a topology, then the last statement of the lemma immediately follows. The first and third axioms of a topology are immediately verified. Thus, assume that we have an object $U$, and sieves $S, S\'$ of $U$ such that $S \\in J(U)$, and for all $V \\to U$ in $S(V)$ we have $S\' \\times _ U V \\in J(V)$. We have to show that $S\' \\in J(U)$. In other words, we have to show that for any $f : W \\to U$, the maps \n    \n      \n  \\[  \\mathcal{F}_ i(W) = \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(h_ W, \\mathcal{F}_ i) \\longrightarrow \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(S\' \\times _ U W, \\mathcal{F}_ i)  \\]\n\n    \n       are bijective for all $i \\in I$. Pick an element $i \\in I$ and pick an element $\\varphi \\in \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(S\' \\times _ U W, \\mathcal{F}_ i)$. We will construct a section $s \\in \\mathcal{F}_ i(W)$ mapping to $\\varphi $. \n    \n      Suppose $\\alpha : V \\to W$ is an element of $S \\times _ U W$. According to the definition of pullbacks we see that the composition $f \\circ \\alpha : V \\to W \\to U$ is in $S$. Hence $S\' \\times _ U V$ is in $J(W)$ by assumption on the pair of sieves $S, S\'$. Now we have a commutative diagram of presheaves \n    \n      \n  \\[  \\xymatrix{ S\' \\times _ U V \\ar[r] \\ar[d] &  h_ V \\ar[d] \\\\  S\' \\times _ U W \\ar[r] &  h_ W }  \\]\n\n    \n       The restriction of $\\varphi $ to $S\' \\times _ U V$ corresponds to an element $s_{V, \\alpha } \\in \\mathcal{F}_ i(V)$. This we see from the definition of $J$, and because $S\' \\times _ U V$ is in $J(W)$. We leave it to the reader to check that the rule $(V, \\alpha ) \\mapsto s_{V, \\alpha }$ defines an element $\\psi \\in \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(S \\times _ U W, \\mathcal{F}_ i)$. Since $S \\in J(U)$ we see immediately from the definition of $J$ that $\\psi $ corresponds to an element $s$ of $\\mathcal{F}_ i(W)$. \n    \n      We leave it to the reader to verify that the construction $\\varphi \\mapsto s$ is inverse to the natural map displayed above. \n      $\\square$\n    \n"
111,00Z9,"def finestTopology (Ps : Set (Cáµ’áµ– â¥¤ Type v)) : GrothendieckTopology C :=
  sInf (finestTopologySingle '' Ps)
",Formal Proof of Stacks Project Tag 00Z9,Equal to that Stacks construction,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Sites/Canonical.lean#L169-L170,Q27041,,7.47.11,lemma,3.0,"['00YW', '00UZ', '0ELQ']","\n  Lemma 7.47.11. Let $\\mathcal{C}$ be a category. Let $\\{  \\mathcal{F}_ i \\} _{i\\in I}$ be a collection of presheaves of sets on $\\mathcal{C}$. For each $U \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{C})$ denote $J(U)$ the set of sieves $S$ with the following property: For every morphism $V \\to U$, the maps \n  \n  \\[  \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(h_ V, \\mathcal{F}_ i) \\longrightarrow \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(S \\times _ U V, \\mathcal{F}_ i)  \\]\n\n   are bijective for all $i \\in I$. Then $J$ defines a topology on $\\mathcal{C}$. This topology is the finest topology in which all of the $\\mathcal{F}_ i$ are sheaves. \n\n    \n      Proof.\n      If we show that $J$ is a topology, then the last statement of the lemma immediately follows. The first and third axioms of a topology are immediately verified. Thus, assume that we have an object $U$, and sieves $S, S\'$ of $U$ such that $S \\in J(U)$, and for all $V \\to U$ in $S(V)$ we have $S\' \\times _ U V \\in J(V)$. We have to show that $S\' \\in J(U)$. In other words, we have to show that for any $f : W \\to U$, the maps \n    \n      \n  \\[  \\mathcal{F}_ i(W) = \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(h_ W, \\mathcal{F}_ i) \\longrightarrow \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(S\' \\times _ U W, \\mathcal{F}_ i)  \\]\n\n    \n       are bijective for all $i \\in I$. Pick an element $i \\in I$ and pick an element $\\varphi \\in \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(S\' \\times _ U W, \\mathcal{F}_ i)$. We will construct a section $s \\in \\mathcal{F}_ i(W)$ mapping to $\\varphi $. \n    \n      Suppose $\\alpha : V \\to W$ is an element of $S \\times _ U W$. According to the definition of pullbacks we see that the composition $f \\circ \\alpha : V \\to W \\to U$ is in $S$. Hence $S\' \\times _ U V$ is in $J(W)$ by assumption on the pair of sieves $S, S\'$. Now we have a commutative diagram of presheaves \n    \n      \n  \\[  \\xymatrix{ S\' \\times _ U V \\ar[r] \\ar[d] &  h_ V \\ar[d] \\\\  S\' \\times _ U W \\ar[r] &  h_ W }  \\]\n\n    \n       The restriction of $\\varphi $ to $S\' \\times _ U V$ corresponds to an element $s_{V, \\alpha } \\in \\mathcal{F}_ i(V)$. This we see from the definition of $J$, and because $S\' \\times _ U V$ is in $J(W)$. We leave it to the reader to check that the rule $(V, \\alpha ) \\mapsto s_{V, \\alpha }$ defines an element $\\psi \\in \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(S \\times _ U W, \\mathcal{F}_ i)$. Since $S \\in J(U)$ we see immediately from the definition of $J$ that $\\psi $ corresponds to an element $s$ of $\\mathcal{F}_ i(W)$. \n    \n      We leave it to the reader to verify that the construction $\\varphi \\mapsto s$ is inverse to the natural map displayed above. \n      $\\square$\n    \n","\n  Lemma 7.47.11. Let $\\mathcal{C}$ be a category. Let $\\{  \\mathcal{F}_ i \\} _{i\\in I}$ be a collection of presheaves of sets on $\\mathcal{C}$. For each $U \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{C})$ denote $J(U)$ the set of sieves $S$ with the following property: For every morphism $V \\to U$, the maps \n  \n  \\[  \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(h_ V, \\mathcal{F}_ i) \\longrightarrow \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(S \\times _ U V, \\mathcal{F}_ i)  \\]\n\n   are bijective for all $i \\in I$. Then $J$ defines a topology on $\\mathcal{C}$. This topology is the finest topology in which all of the $\\mathcal{F}_ i$ are sheaves. \n\n    \n","Proof.\n      If we show that $J$ is a topology, then the last statement of the lemma immediately follows. The first and third axioms of a topology are immediately verified. Thus, assume that we have an object $U$, and sieves $S, S\'$ of $U$ such that $S \\in J(U)$, and for all $V \\to U$ in $S(V)$ we have $S\' \\times _ U V \\in J(V)$. We have to show that $S\' \\in J(U)$. In other words, we have to show that for any $f : W \\to U$, the maps \n    \n      \n  \\[  \\mathcal{F}_ i(W) = \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(h_ W, \\mathcal{F}_ i) \\longrightarrow \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(S\' \\times _ U W, \\mathcal{F}_ i)  \\]\n\n    \n       are bijective for all $i \\in I$. Pick an element $i \\in I$ and pick an element $\\varphi \\in \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(S\' \\times _ U W, \\mathcal{F}_ i)$. We will construct a section $s \\in \\mathcal{F}_ i(W)$ mapping to $\\varphi $. \n    \n      Suppose $\\alpha : V \\to W$ is an element of $S \\times _ U W$. According to the definition of pullbacks we see that the composition $f \\circ \\alpha : V \\to W \\to U$ is in $S$. Hence $S\' \\times _ U V$ is in $J(W)$ by assumption on the pair of sieves $S, S\'$. Now we have a commutative diagram of presheaves \n    \n      \n  \\[  \\xymatrix{ S\' \\times _ U V \\ar[r] \\ar[d] &  h_ V \\ar[d] \\\\  S\' \\times _ U W \\ar[r] &  h_ W }  \\]\n\n    \n       The restriction of $\\varphi $ to $S\' \\times _ U V$ corresponds to an element $s_{V, \\alpha } \\in \\mathcal{F}_ i(V)$. This we see from the definition of $J$, and because $S\' \\times _ U V$ is in $J(W)$. We leave it to the reader to check that the rule $(V, \\alpha ) \\mapsto s_{V, \\alpha }$ defines an element $\\psi \\in \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(S \\times _ U W, \\mathcal{F}_ i)$. Since $S \\in J(U)$ we see immediately from the definition of $J$ that $\\psi $ corresponds to an element $s$ of $\\mathcal{F}_ i(W)$. \n    \n      We leave it to the reader to verify that the construction $\\varphi \\mapsto s$ is inverse to the natural map displayed above. \n      $\\square$\n    \n","
  sInf (finestTopologySingle '' Ps)
",def finestTopology (Ps : Set (Cáµ’áµ– â¥¤ Type v)) : GrothendieckTopology C ,"Proof.\n      If we show that $J$ is a topology, then the last statement of the lemma immediately follows. The first and third axioms of a topology are immediately verified. Thus, assume that we have an object $U$, and sieves $S, S\'$ of $U$ such that $S \\in J(U)$, and for all $V \\to U$ in $S(V)$ we have $S\' \\times _ U V \\in J(V)$. We have to show that $S\' \\in J(U)$. In other words, we have to show that for any $f : W \\to U$, the maps \n    \n      \n  \\[  \\mathcal{F}_ i(W) = \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(h_ W, \\mathcal{F}_ i) \\longrightarrow \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(S\' \\times _ U W, \\mathcal{F}_ i)  \\]\n\n    \n       are bijective for all $i \\in I$. Pick an element $i \\in I$ and pick an element $\\varphi \\in \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(S\' \\times _ U W, \\mathcal{F}_ i)$. We will construct a section $s \\in \\mathcal{F}_ i(W)$ mapping to $\\varphi $. \n    \n      Suppose $\\alpha : V \\to W$ is an element of $S \\times _ U W$. According to the definition of pullbacks we see that the composition $f \\circ \\alpha : V \\to W \\to U$ is in $S$. Hence $S\' \\times _ U V$ is in $J(W)$ by assumption on the pair of sieves $S, S\'$. Now we have a commutative diagram of presheaves \n    \n      \n  \\[  \\xymatrix{ S\' \\times _ U V \\ar[r] \\ar[d] &  h_ V \\ar[d] \\\\  S\' \\times _ U W \\ar[r] &  h_ W }  \\]\n\n    \n       The restriction of $\\varphi $ to $S\' \\times _ U V$ corresponds to an element $s_{V, \\alpha } \\in \\mathcal{F}_ i(V)$. This we see from the definition of $J$, and because $S\' \\times _ U V$ is in $J(W)$. We leave it to the reader to check that the rule $(V, \\alpha ) \\mapsto s_{V, \\alpha }$ defines an element $\\psi \\in \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(S \\times _ U W, \\mathcal{F}_ i)$. Since $S \\in J(U)$ we see immediately from the definition of $J$ that $\\psi $ corresponds to an element $s$ of $\\mathcal{F}_ i(W)$. \n    \n      We leave it to the reader to verify that the construction $\\varphi \\mapsto s$ is inverse to the natural map displayed above. \n      $\\square$\n    \n"
112,00ZA,"def canonicalTopology (C : Type u) [Category.{v} C] : GrothendieckTopology C :=
  finestTopology (Set.range yoneda.obj)
",Formal Proof of Stacks Project Tag 00ZA,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Sites/Canonical.lean#L190-L191,Q27041,,7.47.12,definition,3.0,"['00YW', '00UZ', '0ELQ']","\n  Definition 7.47.12. Let $\\mathcal{C}$ be a category. The finest topology on $\\mathcal{C}$ such that all representable presheaves are sheaves, see Lemma 7.47.11, is called the canonical topology of $\\mathcal{C}$. \n","\n  Definition 7.47.12. Let $\\mathcal{C}$ be a category. The finest topology on $\\mathcal{C}$ such that all representable presheaves are sheaves, see Lemma 7.47.11, is called the canonical topology of $\\mathcal{C}$. \n",,"
  finestTopology (Set.range yoneda.obj)
",def canonicalTopology (C : Type u) [Category.{v} C] : GrothendieckTopology C ,
113,00XK,"that `C` and `D` have pullbacks.""]
theorem ran_isSheaf_of_isCocontinuous (â„± : Sheaf J A) :
    Presheaf.IsSheaf K (G.op.ran.obj â„±.val) := by
  rw [Presheaf.isSheaf_iff_multifork]
  intro X S
  exact âŸ¨RanIsSheafOfIsCocontinuous.isLimitMultifork â„±.2
    (G.op.isPointwiseRightKanExtensionRanCounit â„±.val) SâŸ©
",Formal Proof of Stacks Project Tag 00XK,"Alternative reference. There, results are obtained under the additional assumptio",https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Sites/CoverLifting.lean#L220-L226,Q27041,,7.20.2,lemma,3.0,"['00XI', '00UZ', '0ELQ']","\n  Lemma 7.20.2. Let $\\mathcal{C}$ and $\\mathcal{D}$ be sites. Let $u : \\mathcal{C} \\to \\mathcal{D}$ be cocontinuous. Let $\\mathcal{F}$ be a sheaf on $\\mathcal{C}$. Then ${}_ pu\\mathcal{F}$ is a sheaf on $\\mathcal{D}$, which we will denote ${}_ su\\mathcal{F}$. \n\n    \n      Proof.\n      Let $\\{ V_ j \\to V\\} _{j \\in J}$ be a covering of the site $\\mathcal{D}$. We have to show that \n    \n      \n  \\[  \\xymatrix{ & \\  \\phantom{}_ pu\\mathcal{F}(V) \\ar[r] &  \\prod {}_ pu\\mathcal{F}(V_ j) \\ar@<1ex>[r] \\ar@<-1ex>[r] &  \\prod {}_ pu\\mathcal{F}(V_ j \\times _ V V_{j\'}) &  }  \\]\n\n    \n       is an equalizer diagram. Since ${}_ pu$ is right adjoint to $u^ p$ we have \n    \n      \n  \\[  {}_ pu\\mathcal{F}(V) = \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{D})}(h_ V, {}_ pu\\mathcal{F}) = \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(u^ ph_ V, \\mathcal{F}) = \\mathop{\\mathrm{Mor}}\\nolimits _{\\mathop{\\mathit{Sh}}\\nolimits (\\mathcal{C})}((u^ ph_ V)^\\# , \\mathcal{F})  \\]\n\n    \n       Hence it suffices to show that \n    \n      \n    7.20.2.1\n  \\begin{equation}  \\label{sites-equation-coequalizer} \\xymatrix{ \\coprod u^ p h_{V_ j \\times _ V V_{j\'}} \\ar@<1ex>[r] \\ar@<-1ex>[r] &  \\coprod u^ p h_{V_ j} \\ar[r] &  u^ p h_ V } \\end{equation}\n\n    \n       becomes a coequalizer diagram after sheafification. (Recall that a coproduct in the category of sheaves is the sheafification of the coproduct in the category of presheaves, see Lemma 7.10.14.) \n    \n      We first show that the second arrow of (7.20.2.1) becomes surjective after sheafification. To do this we use Lemma 7.11.2. Thus it suffices to show a section $s$ of $u^ ph_ V$ over $U$ lifts to a section of $\\coprod u^ p h_{V_ j}$ on the members of a covering of $U$. Note that $s$ is a morphism $s : u(U) \\to V$. Then $\\{ V_ j \\times _{V, s} u(U) \\to u(U)\\} $ is a covering of $\\mathcal{D}$. Hence, as $u$ is cocontinuous, there is a covering $\\{ U_ i \\to U\\} $ such that $\\{ u(U_ i) \\to u(U)\\} $ refines $\\{ V_ j \\times _{V, s} u(U) \\to u(U)\\} $. This means that each restriction $s|_{U_ i} : u(U_ i) \\to V$ factors through a morphism $s_ i : u(U_ i) \\to V_ j$ for some $j$, i.e., $s|_{U_ i}$ is in the image of $u^ ph_{V_ j}(U_ i) \\to u^ ph_ V(U_ i)$ as desired. \n    \n      Let $s, s\' \\in (\\coprod u^ ph_{V_ j})^\\# (U)$ map to the same element of $(u^ ph_ V)^\\# (U)$. To finish the proof of the lemma we show that after replacing $U$ by the members of a covering that $s, s\'$ are the image of the same section of $\\coprod u^ p h_{V_ j \\times _ V V_{j\'}}$ by the two maps of (7.20.2.1). We may first replace $U$ by the members of a covering and assume that $s \\in u^ ph_{V_ j}(U)$ and $s\' \\in u^ ph_{V_{j\'}}(U)$. A second such replacement guarantees that $s$ and $s\'$ have the same image in $u^ ph_ V(U)$ instead of in the sheafification. Hence $s : u(U) \\to V_ j$ and $s\' : u(U) \\to V_{j\'}$ are morphisms of $\\mathcal{D}$ such that \n    \n      \n  \\[  \\xymatrix{ u(U) \\ar[r]_{s\'} \\ar[d]_ s &  V_{j\'} \\ar[d] \\\\  V_ j \\ar[r] &  V }  \\]\n\n    \n       is commutative. Thus we obtain $t = (s, s\') : u(U) \\to V_ j \\times _ V V_{j\'}$, i.e., a section $t \\in u^ ph_{V_ j \\times _ V V_{j\'}}(U)$ which maps to $s, s\'$ as desired. \n      $\\square$\n    \n","\n  Lemma 7.20.2. Let $\\mathcal{C}$ and $\\mathcal{D}$ be sites. Let $u : \\mathcal{C} \\to \\mathcal{D}$ be cocontinuous. Let $\\mathcal{F}$ be a sheaf on $\\mathcal{C}$. Then ${}_ pu\\mathcal{F}$ is a sheaf on $\\mathcal{D}$, which we will denote ${}_ su\\mathcal{F}$. \n\n    \n","Proof.\n      Let $\\{ V_ j \\to V\\} _{j \\in J}$ be a covering of the site $\\mathcal{D}$. We have to show that \n    \n      \n  \\[  \\xymatrix{ & \\  \\phantom{}_ pu\\mathcal{F}(V) \\ar[r] &  \\prod {}_ pu\\mathcal{F}(V_ j) \\ar@<1ex>[r] \\ar@<-1ex>[r] &  \\prod {}_ pu\\mathcal{F}(V_ j \\times _ V V_{j\'}) &  }  \\]\n\n    \n       is an equalizer diagram. Since ${}_ pu$ is right adjoint to $u^ p$ we have \n    \n      \n  \\[  {}_ pu\\mathcal{F}(V) = \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{D})}(h_ V, {}_ pu\\mathcal{F}) = \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(u^ ph_ V, \\mathcal{F}) = \\mathop{\\mathrm{Mor}}\\nolimits _{\\mathop{\\mathit{Sh}}\\nolimits (\\mathcal{C})}((u^ ph_ V)^\\# , \\mathcal{F})  \\]\n\n    \n       Hence it suffices to show that \n    \n      \n    7.20.2.1\n  \\begin{equation}  \\label{sites-equation-coequalizer} \\xymatrix{ \\coprod u^ p h_{V_ j \\times _ V V_{j\'}} \\ar@<1ex>[r] \\ar@<-1ex>[r] &  \\coprod u^ p h_{V_ j} \\ar[r] &  u^ p h_ V } \\end{equation}\n\n    \n       becomes a coequalizer diagram after sheafification. (Recall that a coproduct in the category of sheaves is the sheafification of the coproduct in the category of presheaves, see Lemma 7.10.14.) \n    \n      We first show that the second arrow of (7.20.2.1) becomes surjective after sheafification. To do this we use Lemma 7.11.2. Thus it suffices to show a section $s$ of $u^ ph_ V$ over $U$ lifts to a section of $\\coprod u^ p h_{V_ j}$ on the members of a covering of $U$. Note that $s$ is a morphism $s : u(U) \\to V$. Then $\\{ V_ j \\times _{V, s} u(U) \\to u(U)\\} $ is a covering of $\\mathcal{D}$. Hence, as $u$ is cocontinuous, there is a covering $\\{ U_ i \\to U\\} $ such that $\\{ u(U_ i) \\to u(U)\\} $ refines $\\{ V_ j \\times _{V, s} u(U) \\to u(U)\\} $. This means that each restriction $s|_{U_ i} : u(U_ i) \\to V$ factors through a morphism $s_ i : u(U_ i) \\to V_ j$ for some $j$, i.e., $s|_{U_ i}$ is in the image of $u^ ph_{V_ j}(U_ i) \\to u^ ph_ V(U_ i)$ as desired. \n    \n      Let $s, s\' \\in (\\coprod u^ ph_{V_ j})^\\# (U)$ map to the same element of $(u^ ph_ V)^\\# (U)$. To finish the proof of the lemma we show that after replacing $U$ by the members of a covering that $s, s\'$ are the image of the same section of $\\coprod u^ p h_{V_ j \\times _ V V_{j\'}}$ by the two maps of (7.20.2.1). We may first replace $U$ by the members of a covering and assume that $s \\in u^ ph_{V_ j}(U)$ and $s\' \\in u^ ph_{V_{j\'}}(U)$. A second such replacement guarantees that $s$ and $s\'$ have the same image in $u^ ph_ V(U)$ instead of in the sheafification. Hence $s : u(U) \\to V_ j$ and $s\' : u(U) \\to V_{j\'}$ are morphisms of $\\mathcal{D}$ such that \n    \n      \n  \\[  \\xymatrix{ u(U) \\ar[r]_{s\'} \\ar[d]_ s &  V_{j\'} \\ar[d] \\\\  V_ j \\ar[r] &  V }  \\]\n\n    \n       is commutative. Thus we obtain $t = (s, s\') : u(U) \\to V_ j \\times _ V V_{j\'}$, i.e., a section $t \\in u^ ph_{V_ j \\times _ V V_{j\'}}(U)$ which maps to $s, s\'$ as desired. \n      $\\square$\n    \n"," by
  rw [Presheaf.isSheaf_iff_multifork]
  intro X S
  exact âŸ¨RanIsSheafOfIsCocontinuous.isLimitMultifork â„±.2
    (G.op.isPointwiseRightKanExtensionRanCounit â„±.val) SâŸ©
","that `C` and `D` have pullbacks.""]
theorem ran_isSheaf_of_isCocontinuous (â„± : Sheaf J A) :
    Presheaf.IsSheaf K (G.op.ran.obj â„±.val) ","Proof.\n      Let $\\{ V_ j \\to V\\} _{j \\in J}$ be a covering of the site $\\mathcal{D}$. We have to show that \n    \n      \n  \\[  \\xymatrix{ & \\  \\phantom{}_ pu\\mathcal{F}(V) \\ar[r] &  \\prod {}_ pu\\mathcal{F}(V_ j) \\ar@<1ex>[r] \\ar@<-1ex>[r] &  \\prod {}_ pu\\mathcal{F}(V_ j \\times _ V V_{j\'}) &  }  \\]\n\n    \n       is an equalizer diagram. Since ${}_ pu$ is right adjoint to $u^ p$ we have \n    \n      \n  \\[  {}_ pu\\mathcal{F}(V) = \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{D})}(h_ V, {}_ pu\\mathcal{F}) = \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(u^ ph_ V, \\mathcal{F}) = \\mathop{\\mathrm{Mor}}\\nolimits _{\\mathop{\\mathit{Sh}}\\nolimits (\\mathcal{C})}((u^ ph_ V)^\\# , \\mathcal{F})  \\]\n\n    \n       Hence it suffices to show that \n    \n      \n    7.20.2.1 [[\n    7.20.2.1\n  \\begin{equation}  \\label{sites-equation-coequalizer} \\xymatrix{ \\coprod u^ p h_{V_ j \\times _ V V_{j\'}} \\ar@<1ex>[r] \\ar@<-1ex>[r] &  \\coprod u^ p h_{V_ j} \\ar[r] &  u^ p h_ V } \\end{equation}\n]]\n  \\begin{equation}  \\label{sites-equation-coequalizer} \\xymatrix{ \\coprod u^ p h_{V_ j \\times _ V V_{j\'}} \\ar@<1ex>[r] \\ar@<-1ex>[r] &  \\coprod u^ p h_{V_ j} \\ar[r] &  u^ p h_ V } \\end{equation}\n\n    \n       becomes a coequalizer diagram after sheafification. (Recall that a coproduct in the category of sheaves is the sheafification of the coproduct in the category of presheaves, see Lemma 7.10.14 [[\n       \n      \n  Lemma 7.10.14. Let $\\mathcal{F} : \\mathcal{I} \\to \\mathop{\\mathit{Sh}}\\nolimits (\\mathcal{C})$ be a diagram. Then $\\mathop{\\mathrm{colim}}\\nolimits _\\mathcal {I} \\mathcal{F}$ exists and is the sheafification of the colimit in the category of presheaves. \n\n    \n]].) \n    \n      We first show that the second arrow of (7.20.2.1 [[\n    7.20.2.1\n  \\begin{equation}  \\label{sites-equation-coequalizer} \\xymatrix{ \\coprod u^ p h_{V_ j \\times _ V V_{j\'}} \\ar@<1ex>[r] \\ar@<-1ex>[r] &  \\coprod u^ p h_{V_ j} \\ar[r] &  u^ p h_ V } \\end{equation}\n]]) becomes surjective after sheafification. To do this we use Lemma 7.11.2 [[\n  Lemma 7.11.2. The injective (resp. surjective) maps defined above are exactly the monomorphisms (resp. epimorphisms) of the category $\\mathop{\\mathit{Sh}}\\nolimits (\\mathcal{C})$. A map of sheaves is an isomorphism if and only if it is both injective and surjective. \n\n    \n]]. Thus it suffices to show a section $s$ of $u^ ph_ V$ over $U$ lifts to a section of $\\coprod u^ p h_{V_ j}$ on the members of a covering of $U$. Note that $s$ is a morphism $s : u(U) \\to V$. Then $\\{ V_ j \\times _{V, s} u(U) \\to u(U)\\} $ is a covering of $\\mathcal{D}$. Hence, as $u$ is cocontinuous, there is a covering $\\{ U_ i \\to U\\} $ such that $\\{ u(U_ i) \\to u(U)\\} $ refines $\\{ V_ j \\times _{V, s} u(U) \\to u(U)\\} $. This means that each restriction $s|_{U_ i} : u(U_ i) \\to V$ factors through a morphism $s_ i : u(U_ i) \\to V_ j$ for some $j$, i.e., $s|_{U_ i}$ is in the image of $u^ ph_{V_ j}(U_ i) \\to u^ ph_ V(U_ i)$ as desired. \n    \n      Let $s, s\' \\in (\\coprod u^ ph_{V_ j})^\\# (U)$ map to the same element of $(u^ ph_ V)^\\# (U)$. To finish the proof of the lemma we show that after replacing $U$ by the members of a covering that $s, s\'$ are the image of the same section of $\\coprod u^ p h_{V_ j \\times _ V V_{j\'}}$ by the two maps of (7.20.2.1 [[\n    7.20.2.1\n  \\begin{equation}  \\label{sites-equation-coequalizer} \\xymatrix{ \\coprod u^ p h_{V_ j \\times _ V V_{j\'}} \\ar@<1ex>[r] \\ar@<-1ex>[r] &  \\coprod u^ p h_{V_ j} \\ar[r] &  u^ p h_ V } \\end{equation}\n]]). We may first replace $U$ by the members of a covering and assume that $s \\in u^ ph_{V_ j}(U)$ and $s\' \\in u^ ph_{V_{j\'}}(U)$. A second such replacement guarantees that $s$ and $s\'$ have the same image in $u^ ph_ V(U)$ instead of in the sheafification. Hence $s : u(U) \\to V_ j$ and $s\' : u(U) \\to V_{j\'}$ are morphisms of $\\mathcal{D}$ such that \n    \n      \n  \\[  \\xymatrix{ u(U) \\ar[r]_{s\'} \\ar[d]_ s &  V_{j\'} \\ar[d] \\\\  V_ j \\ar[r] &  V }  \\]\n\n    \n       is commutative. Thus we obtain $t = (s, s\') : u(U) \\to V_ j \\times _ V V_{j\'}$, i.e., a section $t \\in u^ ph_{V_ j \\times _ V V_{j\'}}(U)$ which maps to $s, s\'$ as desired. \n      $\\square$\n    \n"
114,00WW,"lemma Functor.isContinuous_of_coverPreserving (hFâ‚ : CompatiblePreserving.{w} K F)
    (hFâ‚‚ : CoverPreserving J K F) : Functor.IsContinuous.{w} F J K where
  op_comp_isSheaf_of_types G X S hS x hx := by
    apply existsUnique_of_exists_of_unique
    Â· have H := (isSheaf_iff_isSheaf_of_type _ _).1 G.2 _ (hFâ‚‚.cover_preserve hS)
      exact âŸ¨H.amalgamate (x.functorPushforward F) (hx.functorPushforward hFâ‚),
        fun V f hf => (H.isAmalgamation (hx.functorPushforward hFâ‚) (F.map f) _).trans
          (hFâ‚.apply_map _ hx hf)âŸ©
    Â· intro yâ‚ yâ‚‚ hyâ‚ hyâ‚‚
      apply (((isSheaf_iff_isSheaf_of_type _ _).1 G.2).isSeparated _ (hFâ‚‚.cover_preserve hS)).ext
      rintro Y _ âŸ¨Z, g, h, hg, rflâŸ©
      dsimp
      simp only [Functor.map_comp, types_comp_apply]
      have H := (hyâ‚ g hg).trans (hyâ‚‚ g hg).symm
      dsimp at H
      rw [H]
",Formal Proof of Stacks Project Tag 00WW,This is basically this Stacks entry.,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Sites/CoverPreserving.lean#L157-L172,Q27041,,7.13.2,lemma,3.0,"['00WU', '00UZ', '0ELQ']",\n  Lemma 7.13.2. Let $\\mathcal{C}$ and $\\mathcal{D}$ be sites. Let $u : \\mathcal{C} \\to \\mathcal{D}$ be a continuous functor. If $\\mathcal{F}$ is a sheaf on $\\mathcal{D}$ then $u^ p\\mathcal{F}$ is a sheaf as well. \n\n    \n      Proof.\n      Let $\\{ V_ i \\to V\\} $ be a covering. By assumption $\\{ u(V_ i) \\to u(V)\\} $ is a covering in $\\mathcal{D}$ and $u(V_ i \\times _ V V_ j) = u(V_ i)\\times _{u(V)}u(V_ j)$. Hence the sheaf condition for $u^ p\\mathcal{F}$ and the covering $\\{ V_ i \\to V\\} $ is precisely the same as the sheaf condition for $\\mathcal{F}$ and the covering $\\{ u(V_ i) \\to u(V)\\} $. \n      $\\square$\n    \n,\n  Lemma 7.13.2. Let $\\mathcal{C}$ and $\\mathcal{D}$ be sites. Let $u : \\mathcal{C} \\to \\mathcal{D}$ be a continuous functor. If $\\mathcal{F}$ is a sheaf on $\\mathcal{D}$ then $u^ p\\mathcal{F}$ is a sheaf as well. \n\n    \n,Proof.\n      Let $\\{ V_ i \\to V\\} $ be a covering. By assumption $\\{ u(V_ i) \\to u(V)\\} $ is a covering in $\\mathcal{D}$ and $u(V_ i \\times _ V V_ j) = u(V_ i)\\times _{u(V)}u(V_ j)$. Hence the sheaf condition for $u^ p\\mathcal{F}$ and the covering $\\{ V_ i \\to V\\} $ is precisely the same as the sheaf condition for $\\mathcal{F}$ and the covering $\\{ u(V_ i) \\to u(V)\\} $. \n      $\\square$\n    \n," by
    apply existsUnique_of_exists_of_unique
    Â· have H := (isSheaf_iff_isSheaf_of_type _ _).1 G.2 _ (hFâ‚‚.cover_preserve hS)
      exact âŸ¨H.amalgamate (x.functorPushforward F) (hx.functorPushforward hFâ‚),
        fun V f hf => (H.isAmalgamation (hx.functorPushforward hFâ‚) (F.map f) _).trans
          (hFâ‚.apply_map _ hx hf)âŸ©
    Â· intro yâ‚ yâ‚‚ hyâ‚ hyâ‚‚
      apply (((isSheaf_iff_isSheaf_of_type _ _).1 G.2).isSeparated _ (hFâ‚‚.cover_preserve hS)).ext
      rintro Y _ âŸ¨Z, g, h, hg, rflâŸ©
      dsimp
      simp only [Functor.map_comp, types_comp_apply]
      have H := (hyâ‚ g hg).trans (hyâ‚‚ g hg).symm
      dsimp at H
      rw [H]
","lemma Functor.isContinuous_of_coverPreserving (hFâ‚ : CompatiblePreserving.{w} K F)
    (hFâ‚‚ : CoverPreserving J K F) : Functor.IsContinuous.{w} F J K where
  op_comp_isSheaf_of_types G X S hS x hx ",Proof.\n      Let $\\{ V_ i \\to V\\} $ be a covering. By assumption $\\{ u(V_ i) \\to u(V)\\} $ is a covering in $\\mathcal{D}$ and $u(V_ i \\times _ V V_ j) = u(V_ i)\\times _{u(V)}u(V_ j)$. Hence the sheaf condition for $u^ p\\mathcal{F}$ and the covering $\\{ V_ i \\to V\\} $ is precisely the same as the sheaf condition for $\\mathcal{F}$ and the covering $\\{ u(V_ i) \\to u(V)\\} $. \n      $\\square$\n    \n
115,00VM,"def FirstObj : Type max v u :=
  âˆá¶œ fun f : Î£ Y, { f : Y âŸ¶ X // R f } => P.obj (op f.1)
",Formal Proof of Stacks Project Tag 00VM,This is the middle object of the fork diagram there.,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Sites/EqualizerSheafCondition.lean#L56-L57,Q27041,,7.7.1,definition,3.0,"['00VL', '00UZ', '0ELQ']","\n  Definition 7.7.1. Let $\\mathcal{C}$ be a site, and let $\\mathcal{F}$ be a presheaf of sets on $\\mathcal{C}$. We say $\\mathcal{F}$ is a sheaf if for every covering $\\{ U_ i \\to U\\} _{i \\in I} \\in \\text{Cov}(\\mathcal{C})$ the diagram \n  \n    7.7.1.1\n  \\begin{equation}  \\label{sites-equation-sheaf-condition} \\xymatrix{ \\mathcal{F}(U) \\ar[r] &  \\prod \\nolimits _{i\\in I} \\mathcal{F}(U_ i) \\ar@<1ex>[r]^-{\\text{pr}_0^*} \\ar@<-1ex>[r]_-{\\text{pr}_1^*} &  \\prod \\nolimits _{(i_0, i_1) \\in I \\times I} \\mathcal{F}(U_{i_0} \\times _ U U_{i_1}) } \\end{equation}\n\n   represents the first arrow as the equalizer of $\\text{pr}_0^*$ and $\\text{pr}_1^*$. \n","\n  Definition 7.7.1. Let $\\mathcal{C}$ be a site, and let $\\mathcal{F}$ be a presheaf of sets on $\\mathcal{C}$. We say $\\mathcal{F}$ is a sheaf if for every covering $\\{ U_ i \\to U\\} _{i \\in I} \\in \\text{Cov}(\\mathcal{C})$ the diagram \n  \n    7.7.1.1\n  \\begin{equation}  \\label{sites-equation-sheaf-condition} \\xymatrix{ \\mathcal{F}(U) \\ar[r] &  \\prod \\nolimits _{i\\in I} \\mathcal{F}(U_ i) \\ar@<1ex>[r]^-{\\text{pr}_0^*} \\ar@<-1ex>[r]_-{\\text{pr}_1^*} &  \\prod \\nolimits _{(i_0, i_1) \\in I \\times I} \\mathcal{F}(U_{i_0} \\times _ U U_{i_1}) } \\end{equation}\n\n   represents the first arrow as the equalizer of $\\text{pr}_0^*$ and $\\text{pr}_1^*$. \n",,"
  âˆá¶œ fun f : Î£ Y, { f : Y âŸ¶ X // R f } => P.obj (op f.1)
",def FirstObj : Type max v u ,
116,00VM,"def forkMap : P.obj (op X) âŸ¶ FirstObj P R :=
  Pi.lift fun f => P.map f.2.1.op
",Formal Proof of Stacks Project Tag 00VM,This is the left morphism of the fork diagram there.,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Sites/EqualizerSheafCondition.lean#L88-L89,Q27041,,7.7.1,definition,3.0,"['00VL', '00UZ', '0ELQ']","\n  Definition 7.7.1. Let $\\mathcal{C}$ be a site, and let $\\mathcal{F}$ be a presheaf of sets on $\\mathcal{C}$. We say $\\mathcal{F}$ is a sheaf if for every covering $\\{ U_ i \\to U\\} _{i \\in I} \\in \\text{Cov}(\\mathcal{C})$ the diagram \n  \n    7.7.1.1\n  \\begin{equation}  \\label{sites-equation-sheaf-condition} \\xymatrix{ \\mathcal{F}(U) \\ar[r] &  \\prod \\nolimits _{i\\in I} \\mathcal{F}(U_ i) \\ar@<1ex>[r]^-{\\text{pr}_0^*} \\ar@<-1ex>[r]_-{\\text{pr}_1^*} &  \\prod \\nolimits _{(i_0, i_1) \\in I \\times I} \\mathcal{F}(U_{i_0} \\times _ U U_{i_1}) } \\end{equation}\n\n   represents the first arrow as the equalizer of $\\text{pr}_0^*$ and $\\text{pr}_1^*$. \n","\n  Definition 7.7.1. Let $\\mathcal{C}$ be a site, and let $\\mathcal{F}$ be a presheaf of sets on $\\mathcal{C}$. We say $\\mathcal{F}$ is a sheaf if for every covering $\\{ U_ i \\to U\\} _{i \\in I} \\in \\text{Cov}(\\mathcal{C})$ the diagram \n  \n    7.7.1.1\n  \\begin{equation}  \\label{sites-equation-sheaf-condition} \\xymatrix{ \\mathcal{F}(U) \\ar[r] &  \\prod \\nolimits _{i\\in I} \\mathcal{F}(U_ i) \\ar@<1ex>[r]^-{\\text{pr}_0^*} \\ar@<-1ex>[r]_-{\\text{pr}_1^*} &  \\prod \\nolimits _{(i_0, i_1) \\in I \\times I} \\mathcal{F}(U_{i_0} \\times _ U U_{i_1}) } \\end{equation}\n\n   represents the first arrow as the equalizer of $\\text{pr}_0^*$ and $\\text{pr}_1^*$. \n",,"
  Pi.lift fun f => P.map f.2.1.op
",def forkMap : P.obj (op X) âŸ¶ FirstObj P R ,
117,00VM,"def firstMap : FirstObj P R âŸ¶ SecondObj P R :=
  Pi.lift fun fg =>
    haveI := Presieve.HasPairwisePullbacks.has_pullbacks fg.1.2.2 fg.2.2.2
    Pi.Ï€ _ _ â‰« P.map (pullback.fst _ _).op
",Formal Proof of Stacks Project Tag 00VM,This is the map `prâ‚€*` there.,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Sites/EqualizerSheafCondition.lean#L194-L197,Q27041,,7.7.1,definition,3.0,"['00VL', '00UZ', '0ELQ']","\n  Definition 7.7.1. Let $\\mathcal{C}$ be a site, and let $\\mathcal{F}$ be a presheaf of sets on $\\mathcal{C}$. We say $\\mathcal{F}$ is a sheaf if for every covering $\\{ U_ i \\to U\\} _{i \\in I} \\in \\text{Cov}(\\mathcal{C})$ the diagram \n  \n    7.7.1.1\n  \\begin{equation}  \\label{sites-equation-sheaf-condition} \\xymatrix{ \\mathcal{F}(U) \\ar[r] &  \\prod \\nolimits _{i\\in I} \\mathcal{F}(U_ i) \\ar@<1ex>[r]^-{\\text{pr}_0^*} \\ar@<-1ex>[r]_-{\\text{pr}_1^*} &  \\prod \\nolimits _{(i_0, i_1) \\in I \\times I} \\mathcal{F}(U_{i_0} \\times _ U U_{i_1}) } \\end{equation}\n\n   represents the first arrow as the equalizer of $\\text{pr}_0^*$ and $\\text{pr}_1^*$. \n","\n  Definition 7.7.1. Let $\\mathcal{C}$ be a site, and let $\\mathcal{F}$ be a presheaf of sets on $\\mathcal{C}$. We say $\\mathcal{F}$ is a sheaf if for every covering $\\{ U_ i \\to U\\} _{i \\in I} \\in \\text{Cov}(\\mathcal{C})$ the diagram \n  \n    7.7.1.1\n  \\begin{equation}  \\label{sites-equation-sheaf-condition} \\xymatrix{ \\mathcal{F}(U) \\ar[r] &  \\prod \\nolimits _{i\\in I} \\mathcal{F}(U_ i) \\ar@<1ex>[r]^-{\\text{pr}_0^*} \\ar@<-1ex>[r]_-{\\text{pr}_1^*} &  \\prod \\nolimits _{(i_0, i_1) \\in I \\times I} \\mathcal{F}(U_{i_0} \\times _ U U_{i_1}) } \\end{equation}\n\n   represents the first arrow as the equalizer of $\\text{pr}_0^*$ and $\\text{pr}_1^*$. \n",,"
  Pi.lift fun fg =>
    haveI := Presieve.HasPairwisePullbacks.has_pullbacks fg.1.2.2 fg.2.2.2
    Pi.Ï€ _ _ â‰« P.map (pullback.fst _ _).op
",def firstMap : FirstObj P R âŸ¶ SecondObj P R ,
118,00VM,"def secondMap : FirstObj P R âŸ¶ SecondObj P R :=
  Pi.lift fun fg =>
    haveI := Presieve.HasPairwisePullbacks.has_pullbacks fg.1.2.2 fg.2.2.2
    Pi.Ï€ _ _ â‰« P.map (pullback.snd _ _).op
",Formal Proof of Stacks Project Tag 00VM,This is the map `prâ‚*` there.,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Sites/EqualizerSheafCondition.lean#L204-L207,Q27041,,7.7.1,definition,3.0,"['00VL', '00UZ', '0ELQ']","\n  Definition 7.7.1. Let $\\mathcal{C}$ be a site, and let $\\mathcal{F}$ be a presheaf of sets on $\\mathcal{C}$. We say $\\mathcal{F}$ is a sheaf if for every covering $\\{ U_ i \\to U\\} _{i \\in I} \\in \\text{Cov}(\\mathcal{C})$ the diagram \n  \n    7.7.1.1\n  \\begin{equation}  \\label{sites-equation-sheaf-condition} \\xymatrix{ \\mathcal{F}(U) \\ar[r] &  \\prod \\nolimits _{i\\in I} \\mathcal{F}(U_ i) \\ar@<1ex>[r]^-{\\text{pr}_0^*} \\ar@<-1ex>[r]_-{\\text{pr}_1^*} &  \\prod \\nolimits _{(i_0, i_1) \\in I \\times I} \\mathcal{F}(U_{i_0} \\times _ U U_{i_1}) } \\end{equation}\n\n   represents the first arrow as the equalizer of $\\text{pr}_0^*$ and $\\text{pr}_1^*$. \n","\n  Definition 7.7.1. Let $\\mathcal{C}$ be a site, and let $\\mathcal{F}$ be a presheaf of sets on $\\mathcal{C}$. We say $\\mathcal{F}$ is a sheaf if for every covering $\\{ U_ i \\to U\\} _{i \\in I} \\in \\text{Cov}(\\mathcal{C})$ the diagram \n  \n    7.7.1.1\n  \\begin{equation}  \\label{sites-equation-sheaf-condition} \\xymatrix{ \\mathcal{F}(U) \\ar[r] &  \\prod \\nolimits _{i\\in I} \\mathcal{F}(U_ i) \\ar@<1ex>[r]^-{\\text{pr}_0^*} \\ar@<-1ex>[r]_-{\\text{pr}_1^*} &  \\prod \\nolimits _{(i_0, i_1) \\in I \\times I} \\mathcal{F}(U_{i_0} \\times _ U U_{i_1}) } \\end{equation}\n\n   represents the first arrow as the equalizer of $\\text{pr}_0^*$ and $\\text{pr}_1^*$. \n",,"
  Pi.lift fun fg =>
    haveI := Presieve.HasPairwisePullbacks.has_pullbacks fg.1.2.2 fg.2.2.2
    Pi.Ï€ _ _ â‰« P.map (pullback.snd _ _).op
",def secondMap : FirstObj P R âŸ¶ SecondObj P R ,
119,00VM,"theorem sheaf_condition : (Presieve.ofArrows X Ï€).IsSheafFor P â†”
    Nonempty (IsLimit (Fork.ofÎ¹ (forkMap P X Ï€) (w P X Ï€))) := by
  rw [Types.type_equalizer_iff_unique, isSheafFor_arrows_iff]
  simp only [FirstObj]
  rw [â† Equiv.forall_congr_right ((equivShrink _).trans (Types.Small.productIso _).toEquiv.symm)]
  simp_rw [â† compatible_iff_of_small, â† Iso.toEquiv_fun, Equiv.trans_apply, Equiv.apply_symm_apply,
    Equiv.symm_apply_apply]
  apply forallâ‚‚_congr
  intro x _
  apply existsUnique_congr
  intro t
  rw [Equiv.eq_symm_apply, â† Equiv.symm_apply_eq]
  constructor
  Â· intro q
    funext i
    simpa [forkMap] using q i
  Â· intro q i
    rw [â† q]
    simp [forkMap]
",Formal Proof of Stacks Project Tag 00VM,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Sites/EqualizerSheafCondition.lean#L350-L368,Q27041,,7.7.1,definition,3.0,"['00VL', '00UZ', '0ELQ']","\n  Definition 7.7.1. Let $\\mathcal{C}$ be a site, and let $\\mathcal{F}$ be a presheaf of sets on $\\mathcal{C}$. We say $\\mathcal{F}$ is a sheaf if for every covering $\\{ U_ i \\to U\\} _{i \\in I} \\in \\text{Cov}(\\mathcal{C})$ the diagram \n  \n    7.7.1.1\n  \\begin{equation}  \\label{sites-equation-sheaf-condition} \\xymatrix{ \\mathcal{F}(U) \\ar[r] &  \\prod \\nolimits _{i\\in I} \\mathcal{F}(U_ i) \\ar@<1ex>[r]^-{\\text{pr}_0^*} \\ar@<-1ex>[r]_-{\\text{pr}_1^*} &  \\prod \\nolimits _{(i_0, i_1) \\in I \\times I} \\mathcal{F}(U_{i_0} \\times _ U U_{i_1}) } \\end{equation}\n\n   represents the first arrow as the equalizer of $\\text{pr}_0^*$ and $\\text{pr}_1^*$. \n","\n  Definition 7.7.1. Let $\\mathcal{C}$ be a site, and let $\\mathcal{F}$ be a presheaf of sets on $\\mathcal{C}$. We say $\\mathcal{F}$ is a sheaf if for every covering $\\{ U_ i \\to U\\} _{i \\in I} \\in \\text{Cov}(\\mathcal{C})$ the diagram \n  \n    7.7.1.1\n  \\begin{equation}  \\label{sites-equation-sheaf-condition} \\xymatrix{ \\mathcal{F}(U) \\ar[r] &  \\prod \\nolimits _{i\\in I} \\mathcal{F}(U_ i) \\ar@<1ex>[r]^-{\\text{pr}_0^*} \\ar@<-1ex>[r]_-{\\text{pr}_1^*} &  \\prod \\nolimits _{(i_0, i_1) \\in I \\times I} \\mathcal{F}(U_{i_0} \\times _ U U_{i_1}) } \\end{equation}\n\n   represents the first arrow as the equalizer of $\\text{pr}_0^*$ and $\\text{pr}_1^*$. \n",," by
  rw [Types.type_equalizer_iff_unique, isSheafFor_arrows_iff]
  simp only [FirstObj]
  rw [â† Equiv.forall_congr_right ((equivShrink _).trans (Types.Small.productIso _).toEquiv.symm)]
  simp_rw [â† compatible_iff_of_small, â† Iso.toEquiv_fun, Equiv.trans_apply, Equiv.apply_symm_apply,
    Equiv.symm_apply_apply]
  apply forallâ‚‚_congr
  intro x _
  apply existsUnique_congr
  intro t
  rw [Equiv.eq_symm_apply, â† Equiv.symm_apply_eq]
  constructor
  Â· intro q
    funext i
    simpa [forkMap] using q i
  Â· intro q i
    rw [â† q]
    simp [forkMap]
","theorem sheaf_condition : (Presieve.ofArrows X Ï€).IsSheafFor P â†”
    Nonempty (IsLimit (Fork.ofÎ¹ (forkMap P X Ï€) (w P X Ï€))) ",
120,00VM,"def firstObj : A :=
  âˆá¶œ fun f : Î£ V, { f : V âŸ¶ U // R f } => P.obj (op f.1)
",Formal Proof of Stacks Project Tag 00VM,The middle object of the fork diagram there.,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Sites/Sheaf.lean#L629-L630,Q27041,,7.7.1,definition,3.0,"['00VL', '00UZ', '0ELQ']","\n  Definition 7.7.1. Let $\\mathcal{C}$ be a site, and let $\\mathcal{F}$ be a presheaf of sets on $\\mathcal{C}$. We say $\\mathcal{F}$ is a sheaf if for every covering $\\{ U_ i \\to U\\} _{i \\in I} \\in \\text{Cov}(\\mathcal{C})$ the diagram \n  \n    7.7.1.1\n  \\begin{equation}  \\label{sites-equation-sheaf-condition} \\xymatrix{ \\mathcal{F}(U) \\ar[r] &  \\prod \\nolimits _{i\\in I} \\mathcal{F}(U_ i) \\ar@<1ex>[r]^-{\\text{pr}_0^*} \\ar@<-1ex>[r]_-{\\text{pr}_1^*} &  \\prod \\nolimits _{(i_0, i_1) \\in I \\times I} \\mathcal{F}(U_{i_0} \\times _ U U_{i_1}) } \\end{equation}\n\n   represents the first arrow as the equalizer of $\\text{pr}_0^*$ and $\\text{pr}_1^*$. \n","\n  Definition 7.7.1. Let $\\mathcal{C}$ be a site, and let $\\mathcal{F}$ be a presheaf of sets on $\\mathcal{C}$. We say $\\mathcal{F}$ is a sheaf if for every covering $\\{ U_ i \\to U\\} _{i \\in I} \\in \\text{Cov}(\\mathcal{C})$ the diagram \n  \n    7.7.1.1\n  \\begin{equation}  \\label{sites-equation-sheaf-condition} \\xymatrix{ \\mathcal{F}(U) \\ar[r] &  \\prod \\nolimits _{i\\in I} \\mathcal{F}(U_ i) \\ar@<1ex>[r]^-{\\text{pr}_0^*} \\ar@<-1ex>[r]_-{\\text{pr}_1^*} &  \\prod \\nolimits _{(i_0, i_1) \\in I \\times I} \\mathcal{F}(U_{i_0} \\times _ U U_{i_1}) } \\end{equation}\n\n   represents the first arrow as the equalizer of $\\text{pr}_0^*$ and $\\text{pr}_1^*$. \n",,"
  âˆá¶œ fun f : Î£ V, { f : V âŸ¶ U // R f } => P.obj (op f.1)
",def firstObj : A ,
121,00VM,"def secondObj : A :=
  âˆá¶œ fun fg : (Î£ V, { f : V âŸ¶ U // R f }) Ã— Î£ W, { g : W âŸ¶ U // R g } =>
    P.obj (op (pullback fg.1.2.1 fg.2.2.1))
",Formal Proof of Stacks Project Tag 00VM,The rightmost object of the fork diagram there.,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Sites/Sheaf.lean#L644-L646,Q27041,,7.7.1,definition,3.0,"['00VL', '00UZ', '0ELQ']","\n  Definition 7.7.1. Let $\\mathcal{C}$ be a site, and let $\\mathcal{F}$ be a presheaf of sets on $\\mathcal{C}$. We say $\\mathcal{F}$ is a sheaf if for every covering $\\{ U_ i \\to U\\} _{i \\in I} \\in \\text{Cov}(\\mathcal{C})$ the diagram \n  \n    7.7.1.1\n  \\begin{equation}  \\label{sites-equation-sheaf-condition} \\xymatrix{ \\mathcal{F}(U) \\ar[r] &  \\prod \\nolimits _{i\\in I} \\mathcal{F}(U_ i) \\ar@<1ex>[r]^-{\\text{pr}_0^*} \\ar@<-1ex>[r]_-{\\text{pr}_1^*} &  \\prod \\nolimits _{(i_0, i_1) \\in I \\times I} \\mathcal{F}(U_{i_0} \\times _ U U_{i_1}) } \\end{equation}\n\n   represents the first arrow as the equalizer of $\\text{pr}_0^*$ and $\\text{pr}_1^*$. \n","\n  Definition 7.7.1. Let $\\mathcal{C}$ be a site, and let $\\mathcal{F}$ be a presheaf of sets on $\\mathcal{C}$. We say $\\mathcal{F}$ is a sheaf if for every covering $\\{ U_ i \\to U\\} _{i \\in I} \\in \\text{Cov}(\\mathcal{C})$ the diagram \n  \n    7.7.1.1\n  \\begin{equation}  \\label{sites-equation-sheaf-condition} \\xymatrix{ \\mathcal{F}(U) \\ar[r] &  \\prod \\nolimits _{i\\in I} \\mathcal{F}(U_ i) \\ar@<1ex>[r]^-{\\text{pr}_0^*} \\ar@<-1ex>[r]_-{\\text{pr}_1^*} &  \\prod \\nolimits _{(i_0, i_1) \\in I \\times I} \\mathcal{F}(U_{i_0} \\times _ U U_{i_1}) } \\end{equation}\n\n   represents the first arrow as the equalizer of $\\text{pr}_0^*$ and $\\text{pr}_1^*$. \n",,"
  âˆá¶œ fun fg : (Î£ V, { f : V âŸ¶ U // R f }) Ã— Î£ W, { g : W âŸ¶ U // R g } =>
    P.obj (op (pullback fg.1.2.1 fg.2.2.1))
",def secondObj : A ,
122,00Z4,"structure GrothendieckTopology where
  /-- A Grothendieck topology on `C` consists of a set of sieves for each object `X`,
  which satisfy some axioms. -/
  sieves : âˆ€ X : C, Set (Sieve X)
  /-- The sieves associated to each object must contain the top sieve.
  Use `GrothendieckTopology.top_mem`. -/
  top_mem' : âˆ€ X, âŠ¤ âˆˆ sieves X
  /-- Stability under pullback. Use `GrothendieckTopology.pullback_stable`. -/
  pullback_stable' : âˆ€ â¦ƒX Y : Câ¦„ â¦ƒS : Sieve Xâ¦„ (f : Y âŸ¶ X), S âˆˆ sieves X â†’ S.pullback f âˆˆ sieves Y
  /-- Transitivity of sieves in a Grothendieck topology. Use `GrothendieckTopology.transitive`. -/
  transitive' :
    âˆ€ â¦ƒXâ¦„ â¦ƒS : Sieve Xâ¦„ (_ : S âˆˆ sieves X) (R : Sieve X),
      (âˆ€ â¦ƒYâ¦„ â¦ƒf : Y âŸ¶ Xâ¦„, S f â†’ R.pullback f âˆˆ sieves Y) â†’ R âˆˆ sieves X
",Formal Proof of Stacks Project Tag 00Z4,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Sites/Grothendieck.lean#L76-L88,Q27041,,7.47.6,definition,3.0,"['00YW', '00UZ', '0ELQ']","\n  Definition 7.47.6. Let $\\mathcal{C}$ be a category. A topology on $\\mathcal{C}$ is given by a rule which assigns to every $U \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{C})$ a subset $J(U)$ of the set of all sieves on $U$ satisfying the following conditions \n  \n  \nFor every morphism $f : V \\to U$ in $\\mathcal{C}$, and every element $S \\in J(U)$ the pullback $S \\times _ U V$ is an element of $J(V)$. \n\n\nIf $S$ and $S\'$ are sieves on $U \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{C})$, if $S \\in J(U)$, and if for all $f \\in S(V)$ the pullback $S\' \\times _ U V$ belongs to $J(V)$, then $S\'$ belongs to $J(U)$. \n\n\nFor every $U \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{C})$ the maximal sieve $S = h_ U$ belongs to $J(U)$. \n\n\n\n","\n  Definition 7.47.6. Let $\\mathcal{C}$ be a category. A topology on $\\mathcal{C}$ is given by a rule which assigns to every $U \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{C})$ a subset $J(U)$ of the set of all sieves on $U$ satisfying the following conditions \n  \n  \nFor every morphism $f : V \\to U$ in $\\mathcal{C}$, and every element $S \\in J(U)$ the pullback $S \\times _ U V$ is an element of $J(V)$. \n\n\nIf $S$ and $S\'$ are sieves on $U \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{C})$, if $S \\in J(U)$, and if for all $f \\in S(V)$ the pullback $S\' \\times _ U V$ belongs to $J(V)$, then $S\'$ belongs to $J(U)$. \n\n\nFor every $U \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{C})$ the maximal sieve $S = h_ U$ belongs to $J(U)$. \n\n\n\n",,,"structure GrothendieckTopology where
  /-- A Grothendieck topology on `C` consists of a set of sieves for each object `X`,
  which satisfy some axioms. -/
  sieves : âˆ€ X : C, Set (Sieve X)
  /-- The sieves associated to each object must contain the top sieve.
  Use `GrothendieckTopology.top_mem`. -/
  top_mem' : âˆ€ X, âŠ¤ âˆˆ sieves X
  /-- Stability under pullback. Use `GrothendieckTopology.pullback_stable`. -/
  pullback_stable' : âˆ€ â¦ƒX Y : Câ¦„ â¦ƒS : Sieve Xâ¦„ (f : Y âŸ¶ X), S âˆˆ sieves X â†’ S.pullback f âˆˆ sieves Y
  /-- Transitivity of sieves in a Grothendieck topology. Use `GrothendieckTopology.transitive`. -/
  transitive' :
    âˆ€ â¦ƒXâ¦„ â¦ƒS : Sieve Xâ¦„ (_ : S âˆˆ sieves X) (R : Sieve X),
      (âˆ€ â¦ƒYâ¦„ â¦ƒf : Y âŸ¶ Xâ¦„, S f â†’ R.pullback f âˆˆ sieves Y) â†’ R âˆˆ sieves X
",
123,00Z5,"theorem superset_covering (Hss : S â‰¤ R) (sjx : S âˆˆ J X) : R âˆˆ J X := by
  apply J.transitive sjx R fun Y f hf => _
  intro Y f hf
  apply covering_of_eq_top
  rw [â† top_le_iff, â† S.pullback_eq_top_of_mem hf]
  apply Sieve.pullback_monotone _ Hss
",Formal Proof of Stacks Project Tag 00Z5,(2),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Sites/Grothendieck.lean#L163-L168,Q27041,,7.47.7,lemma,3.0,"['00YW', '00UZ', '0ELQ']","\n  Lemma 7.47.7. Let $\\mathcal{C}$ be a category. Let $J$ be a topology on $\\mathcal{C}$. Let $U \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{C})$. \n  \n  \nFinite intersections of elements of $J(U)$ are in $J(U)$. \n\n\nIf $S \\in J(U)$ and $S\' \\supset S$, then $S\' \\in J(U)$. \n\n\n\n\n    \n      Proof.\n      Let $S, S\' \\in J(U)$. Consider $S\'\' = S \\cap S\'$. For every $V \\to U$ in $S(V)$ we have \n    \n      \n  \\[  S\' \\times _ U V = S\'\' \\times _ U V  \\]\n\n    \n       simply because $V \\to U$ already is in $S$. Hence by the second axiom of the definition we see that $S\'\' \\in J(U)$. \n    \n      Let $S \\in J(U)$ and $S\' \\supset S$. For every $V \\to U$ in $S(V)$ we have $S\' \\times _ U V = h_ V$ by Lemma 7.47.5. Thus $S\' \\times _ U V \\in J(V)$ by the third axiom. Hence $S\' \\in J(U)$ by the second axiom. \n      $\\square$\n    \n","\n  Lemma 7.47.7. Let $\\mathcal{C}$ be a category. Let $J$ be a topology on $\\mathcal{C}$. Let $U \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{C})$. \n  \n  \nFinite intersections of elements of $J(U)$ are in $J(U)$. \n\n\nIf $S \\in J(U)$ and $S\' \\supset S$, then $S\' \\in J(U)$. \n\n\n\n\n    \n","Proof.\n      Let $S, S\' \\in J(U)$. Consider $S\'\' = S \\cap S\'$. For every $V \\to U$ in $S(V)$ we have \n    \n      \n  \\[  S\' \\times _ U V = S\'\' \\times _ U V  \\]\n\n    \n       simply because $V \\to U$ already is in $S$. Hence by the second axiom of the definition we see that $S\'\' \\in J(U)$. \n    \n      Let $S \\in J(U)$ and $S\' \\supset S$. For every $V \\to U$ in $S(V)$ we have $S\' \\times _ U V = h_ V$ by Lemma 7.47.5. Thus $S\' \\times _ U V \\in J(V)$ by the third axiom. Hence $S\' \\in J(U)$ by the second axiom. \n      $\\square$\n    \n"," by
  apply J.transitive sjx R fun Y f hf => _
  intro Y f hf
  apply covering_of_eq_top
  rw [â† top_le_iff, â† S.pullback_eq_top_of_mem hf]
  apply Sieve.pullback_monotone _ Hss
",theorem superset_covering (Hss : S â‰¤ R) (sjx : S âˆˆ J X) : R âˆˆ J X ,"Proof.\n      Let $S, S\' \\in J(U)$. Consider $S\'\' = S \\cap S\'$. For every $V \\to U$ in $S(V)$ we have \n    \n      \n  \\[  S\' \\times _ U V = S\'\' \\times _ U V  \\]\n\n    \n       simply because $V \\to U$ already is in $S$. Hence by the second axiom of the definition we see that $S\'\' \\in J(U)$. \n    \n      Let $S \\in J(U)$ and $S\' \\supset S$. For every $V \\to U$ in $S(V)$ we have $S\' \\times _ U V = h_ V$ by Lemma 7.47.5 [[\n  Lemma 7.47.5. Let $\\mathcal{C}$ be a category. Let $U \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{C})$. Let $S$ be a sieve on $U$. If $f : V \\to U$ is in $S$, then $S \\times _ U V = h_ V$ is maximal. \n\n    \n]]. Thus $S\' \\times _ U V \\in J(V)$ by the third axiom. Hence $S\' \\in J(U)$ by the second axiom. \n      $\\square$\n    \n"
124,00Z5,"theorem intersection_covering (rj : R âˆˆ J X) (sj : S âˆˆ J X) : R âŠ“ S âˆˆ J X := by
  apply J.transitive rj _ fun Y f Hf => _
  intro Y f hf
  rw [Sieve.pullback_inter, R.pullback_eq_top_of_mem hf]
  simp [sj]
",Formal Proof of Stacks Project Tag 00Z5,(1),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Sites/Grothendieck.lean#L174-L178,Q27041,,7.47.7,lemma,3.0,"['00YW', '00UZ', '0ELQ']","\n  Lemma 7.47.7. Let $\\mathcal{C}$ be a category. Let $J$ be a topology on $\\mathcal{C}$. Let $U \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{C})$. \n  \n  \nFinite intersections of elements of $J(U)$ are in $J(U)$. \n\n\nIf $S \\in J(U)$ and $S\' \\supset S$, then $S\' \\in J(U)$. \n\n\n\n\n    \n      Proof.\n      Let $S, S\' \\in J(U)$. Consider $S\'\' = S \\cap S\'$. For every $V \\to U$ in $S(V)$ we have \n    \n      \n  \\[  S\' \\times _ U V = S\'\' \\times _ U V  \\]\n\n    \n       simply because $V \\to U$ already is in $S$. Hence by the second axiom of the definition we see that $S\'\' \\in J(U)$. \n    \n      Let $S \\in J(U)$ and $S\' \\supset S$. For every $V \\to U$ in $S(V)$ we have $S\' \\times _ U V = h_ V$ by Lemma 7.47.5. Thus $S\' \\times _ U V \\in J(V)$ by the third axiom. Hence $S\' \\in J(U)$ by the second axiom. \n      $\\square$\n    \n","\n  Lemma 7.47.7. Let $\\mathcal{C}$ be a category. Let $J$ be a topology on $\\mathcal{C}$. Let $U \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{C})$. \n  \n  \nFinite intersections of elements of $J(U)$ are in $J(U)$. \n\n\nIf $S \\in J(U)$ and $S\' \\supset S$, then $S\' \\in J(U)$. \n\n\n\n\n    \n","Proof.\n      Let $S, S\' \\in J(U)$. Consider $S\'\' = S \\cap S\'$. For every $V \\to U$ in $S(V)$ we have \n    \n      \n  \\[  S\' \\times _ U V = S\'\' \\times _ U V  \\]\n\n    \n       simply because $V \\to U$ already is in $S$. Hence by the second axiom of the definition we see that $S\'\' \\in J(U)$. \n    \n      Let $S \\in J(U)$ and $S\' \\supset S$. For every $V \\to U$ in $S(V)$ we have $S\' \\times _ U V = h_ V$ by Lemma 7.47.5. Thus $S\' \\times _ U V \\in J(V)$ by the third axiom. Hence $S\' \\in J(U)$ by the second axiom. \n      $\\square$\n    \n"," by
  apply J.transitive rj _ fun Y f Hf => _
  intro Y f hf
  rw [Sieve.pullback_inter, R.pullback_eq_top_of_mem hf]
  simp [sj]
",theorem intersection_covering (rj : R âˆˆ J X) (sj : S âˆˆ J X) : R âŠ“ S âˆˆ J X ,"Proof.\n      Let $S, S\' \\in J(U)$. Consider $S\'\' = S \\cap S\'$. For every $V \\to U$ in $S(V)$ we have \n    \n      \n  \\[  S\' \\times _ U V = S\'\' \\times _ U V  \\]\n\n    \n       simply because $V \\to U$ already is in $S$. Hence by the second axiom of the definition we see that $S\'\' \\in J(U)$. \n    \n      Let $S \\in J(U)$ and $S\' \\supset S$. For every $V \\to U$ in $S(V)$ we have $S\' \\times _ U V = h_ V$ by Lemma 7.47.5 [[\n  Lemma 7.47.5. Let $\\mathcal{C}$ be a category. Let $U \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{C})$. Let $S$ be a sieve on $U$. If $f : V \\to U$ is in $S$, then $S \\times _ U V = h_ V$ is maximal. \n\n    \n]]. Thus $S\' \\times _ U V \\in J(V)$ by the third axiom. Hence $S\' \\in J(U)$ by the second axiom. \n      $\\square$\n    \n"
125,00Z6,"instance : PartialOrder (GrothendieckTopology C) :=
  { instLEGrothendieckTopology with
    le_refl := fun _ => le_def.mpr le_rfl
    le_trans := fun _ _ _ hâ‚â‚‚ hâ‚‚â‚ƒ => le_def.mpr (le_trans hâ‚â‚‚ hâ‚‚â‚ƒ)
    le_antisymm := fun _ _ hâ‚â‚‚ hâ‚‚â‚ => GrothendieckTopology.ext (le_antisymm hâ‚â‚‚ hâ‚‚â‚) }
",Formal Proof of Stacks Project Tag 00Z6,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Sites/Grothendieck.lean#L272-L276,Q27041,,7.47.8,definition,3.0,"['00YW', '00UZ', '0ELQ']","\n  Definition 7.47.8. Let $\\mathcal{C}$ be a category. Let $J$, $J\'$ be two topologies on $\\mathcal{C}$. We say that $J$ is finer or stronger than $J\'$ if and only if for every object $U$ of $\\mathcal{C}$ we have $J\'(U) \\subset J(U)$. In this case we also say that $J\'$ is coarser or weaker than $J$. \n","\n  Definition 7.47.8. Let $\\mathcal{C}$ be a category. Let $J$, $J\'$ be two topologies on $\\mathcal{C}$. We say that $J$ is finer or stronger than $J\'$ if and only if for every object $U$ of $\\mathcal{C}$ we have $J\'(U) \\subset J(U)$. In this case we also say that $J\'$ is coarser or weaker than $J$. \n",,"
  { instLEGrothendieckTopology with
    le_refl := fun _ => le_def.mpr le_rfl
    le_trans := fun _ _ _ hâ‚â‚‚ hâ‚‚â‚ƒ => le_def.mpr (le_trans hâ‚â‚‚ hâ‚‚â‚ƒ)
    le_antisymm := fun _ _ hâ‚â‚‚ hâ‚‚â‚ => GrothendieckTopology.ext (le_antisymm hâ‚â‚‚ hâ‚‚â‚) }
",instance : PartialOrder (GrothendieckTopology C) ,
126,00Z7,"theorem isGLB_sInf (s : Set (GrothendieckTopology C)) : IsGLB s (sInf s) := by
  refine @IsGLB.of_image _ _ _ _ sieves ?_ _ _ ?_
  Â· rfl
  Â· exact _root_.isGLB_sInf _
",Formal Proof of Stacks Project Tag 00Z7,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Sites/Grothendieck.lean#L299-L302,Q27041,,7.47.9,lemma,3.0,"['00YW', '00UZ', '0ELQ']",\n  Lemma 7.47.9. Let $\\mathcal{C}$ be a category. Let $\\{ J_ i\\} _{i\\in I}$ be a set of topologies. \n  \n  \nThe rule $J(U) = \\bigcap J_ i(U)$ defines a topology on $\\mathcal{C}$. \n\n\nThere is a coarsest topology finer than all of the topologies $J_ i$. \n\n\n\n\n    \n      Proof.\n      The first part is direct from the definitions. The second follows by taking the intersection of all topologies finer than all of the $J_ i$. \n      $\\square$\n    \n,\n  Lemma 7.47.9. Let $\\mathcal{C}$ be a category. Let $\\{ J_ i\\} _{i\\in I}$ be a set of topologies. \n  \n  \nThe rule $J(U) = \\bigcap J_ i(U)$ defines a topology on $\\mathcal{C}$. \n\n\nThere is a coarsest topology finer than all of the topologies $J_ i$. \n\n\n\n\n    \n,Proof.\n      The first part is direct from the definitions. The second follows by taking the intersection of all topologies finer than all of the $J_ i$. \n      $\\square$\n    \n," by
  refine @IsGLB.of_image _ _ _ _ sieves ?_ _ _ ?_
  Â· rfl
  Â· exact _root_.isGLB_sInf _
",theorem isGLB_sInf (s : Set (GrothendieckTopology C)) : IsGLB s (sInf s) ,Proof.\n      The first part is direct from the definitions. The second follows by taking the intersection of all topologies finer than all of the $J_ i$. \n      $\\square$\n    \n
127,00VM,"def FamilyOfElements (P : Cáµ’áµ– â¥¤ Type w) (R : Presieve X) :=
  âˆ€ â¦ƒY : Câ¦„ (f : Y âŸ¶ X), R f â†’ P.obj (op Y)
",Formal Proof of Stacks Project Tag 00VM,This is a concrete version of the elements of the middle object there.,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Sites/IsSheafFor.lean#L94-L95,Q27041,,7.7.1,definition,3.0,"['00VL', '00UZ', '0ELQ']","\n  Definition 7.7.1. Let $\\mathcal{C}$ be a site, and let $\\mathcal{F}$ be a presheaf of sets on $\\mathcal{C}$. We say $\\mathcal{F}$ is a sheaf if for every covering $\\{ U_ i \\to U\\} _{i \\in I} \\in \\text{Cov}(\\mathcal{C})$ the diagram \n  \n    7.7.1.1\n  \\begin{equation}  \\label{sites-equation-sheaf-condition} \\xymatrix{ \\mathcal{F}(U) \\ar[r] &  \\prod \\nolimits _{i\\in I} \\mathcal{F}(U_ i) \\ar@<1ex>[r]^-{\\text{pr}_0^*} \\ar@<-1ex>[r]_-{\\text{pr}_1^*} &  \\prod \\nolimits _{(i_0, i_1) \\in I \\times I} \\mathcal{F}(U_{i_0} \\times _ U U_{i_1}) } \\end{equation}\n\n   represents the first arrow as the equalizer of $\\text{pr}_0^*$ and $\\text{pr}_1^*$. \n","\n  Definition 7.7.1. Let $\\mathcal{C}$ be a site, and let $\\mathcal{F}$ be a presheaf of sets on $\\mathcal{C}$. We say $\\mathcal{F}$ is a sheaf if for every covering $\\{ U_ i \\to U\\} _{i \\in I} \\in \\text{Cov}(\\mathcal{C})$ the diagram \n  \n    7.7.1.1\n  \\begin{equation}  \\label{sites-equation-sheaf-condition} \\xymatrix{ \\mathcal{F}(U) \\ar[r] &  \\prod \\nolimits _{i\\in I} \\mathcal{F}(U_ i) \\ar@<1ex>[r]^-{\\text{pr}_0^*} \\ar@<-1ex>[r]_-{\\text{pr}_1^*} &  \\prod \\nolimits _{(i_0, i_1) \\in I \\times I} \\mathcal{F}(U_{i_0} \\times _ U U_{i_1}) } \\end{equation}\n\n   represents the first arrow as the equalizer of $\\text{pr}_0^*$ and $\\text{pr}_1^*$. \n",,"
  âˆ€ â¦ƒY : Câ¦„ (f : Y âŸ¶ X), R f â†’ P.obj (op Y)
",def FamilyOfElements (P : Cáµ’áµ– â¥¤ Type w) (R : Presieve X) ,
128,00Z8,"def YonedaSheafCondition (P : Cáµ’áµ– â¥¤ Type vâ‚) (S : Sieve X) : Prop :=
  âˆ€ f : S.functor âŸ¶ P, âˆƒ! g, S.functorInclusion â‰« g = f
",Formal Proof of Stacks Project Tag 00Z8,Direct reformulation,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Sites/IsSheafFor.lean#L476-L477,Q27041,,7.47.10,definition,3.0,"['00YW', '00UZ', '0ELQ']","\n  Definition 7.47.10. Let $\\mathcal{C}$ be a category endowed with a topology $J$. Let $\\mathcal{F}$ be a presheaf of sets on $\\mathcal{C}$. We say that $\\mathcal{F}$ is a sheaf on $\\mathcal{C}$ if for every $U \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{C})$ and for every covering sieve $S$ of $U$ the canonical map \n  \n  \\[  \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(h_ U, \\mathcal{F}) \\longrightarrow \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(S, \\mathcal{F})  \\]\n\n   is bijective. \n","\n  Definition 7.47.10. Let $\\mathcal{C}$ be a category endowed with a topology $J$. Let $\\mathcal{F}$ be a presheaf of sets on $\\mathcal{C}$. We say that $\\mathcal{F}$ is a sheaf on $\\mathcal{C}$ if for every $U \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{C})$ and for every covering sieve $S$ of $U$ the canonical map \n  \n  \\[  \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(h_ U, \\mathcal{F}) \\longrightarrow \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(S, \\mathcal{F})  \\]\n\n   is bijective. \n",,"
  âˆ€ f : S.functor âŸ¶ P, âˆƒ! g, S.functorInclusion â‰« g = f
",def YonedaSheafCondition (P : Cáµ’áµ– â¥¤ Type vâ‚) (S : Sieve X) : Prop ,
129,00ZC,"def toGrothendieck (K : Pretopology C) : GrothendieckTopology C where
  sieves X S := âˆƒ R âˆˆ K X, R â‰¤ (S : Presieve _)
  top_mem' _ := âŸ¨Presieve.singleton (ðŸ™ _), K.has_isos _, fun _ _ _ => âŸ¨âŸ©âŸ©
  pullback_stable' X Y S g := by
    rintro âŸ¨R, hR, RSâŸ©
    refine âŸ¨_, K.pullbacks g _ hR, ?_âŸ©
    rw [â† Sieve.generate_le_iff, Sieve.pullbackArrows_comm]
    apply Sieve.pullback_monotone
    rwa [Sieve.giGenerate.gc]
  transitive' := by
    rintro X S âŸ¨R', hR', RSâŸ© R t
    choose tâ‚ tâ‚‚ tâ‚ƒ using t
    refine âŸ¨_, K.transitive _ _ hR' fun _ f hf => tâ‚‚ (RS _ hf), ?_âŸ©
    rintro Y _ âŸ¨Z, g, f, hg, hf, rflâŸ©
    apply tâ‚ƒ (RS _ hg) _ hf
",Formal Proof of Stacks Project Tag 00ZC,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Sites/Pretopology.lean#L112-L126,Q27041,,7.48.1,lemma,3.0,"['00ZB', '00UZ', '0ELQ']","\n  Lemma 7.48.1. Let $\\mathcal{C}$ be a site with coverings $\\text{Cov}(\\mathcal{C})$. For every object $U$ of $\\mathcal{C}$, let $J(U)$ denote the set of sieves $S$ on $U$ with the following property: there exists a covering $\\{ f_ i : U_ i \\to U\\} _{i\\in I} \\in \\text{Cov}(\\mathcal{C})$ so that the sieve $S\'$ generated by the $f_ i$ (see Definition 7.47.3) is contained in $S$. \n  \n  \nThis $J$ is a topology on $\\mathcal{C}$. \n\n\nA presheaf $\\mathcal{F}$ is a sheaf for this topology (see Definition 7.47.10) if and only if it is a sheaf on the site (see Definition 7.7.1). \n\n\n\n\n    \n      Proof.\n      To prove the first assertion we just note that axioms (1), (2) and (3) of the definition of a site (Definition 7.6.2) directly imply the axioms (3), (2) and (1) of the definition of a topology (Definition 7.47.6). As an example we prove $J$ has property (2). Namely, let $U$ be an object of $\\mathcal{C}$, let $S, S\'$ be sieves on $U$ such that $S \\in J(U)$, and such that for every $V \\to U$ in $S(V)$ we have $S\' \\times _ U V \\in J(V)$. By definition of $J(U)$ we can find a covering $\\{ f_ i : U_ i \\to U\\} $ of the site such that $S$ the image of $h_{U_ i} \\to h_ U$ is contained in $S$. Since each $S\'\\times _ U U_ i$ is in $J(U_ i)$ we see that there are coverings $\\{ U_{ij} \\to U_ i\\} $ of the site such that $h_{U_{ij}} \\to h_{U_ i}$ is contained in $S\' \\times _ U U_ i$. By definition of the base change this means that $h_{U_{ij}} \\to h_ U$ is contained in the subpresheaf $S\' \\subset h_ U$. By axiom (2) for sites we see that $\\{ U_{ij} \\to U\\} $ is a covering of $U$ and we conclude that $S\' \\in J(U)$ by definition of $J$. \n    \n      Let $\\mathcal{F}$ be a presheaf. Suppose that $\\mathcal{F}$ is a sheaf in the topology $J$. We will show that $\\mathcal{F}$ is a sheaf on the site as well. Let $\\{ f_ i : U_ i \\to U\\} _{i\\in I}$ be a covering of the site. Let $s_ i \\in \\mathcal{F}(U_ i)$ be a family of sections such that $s_ i|_{U_ i \\times _ U U_ j} = s_ j|_{U_ i \\times _ U U_ j}$ for all $i, j$. We have to show that there exists a unique section $s \\in \\mathcal{F}(U)$ restricting back to the $s_ i$ on the $U_ i$. Let $S \\subset h_ U$ be the sieve generated by the $f_ i$. Note that $S \\in J(U)$ by definition. In stead of constructing $s$, by the sheaf condition in the topology, it suffices to construct an element \n    \n      \n  \\[  \\varphi \\in \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(S, \\mathcal{F}).  \\]\n\n    \n       Take $\\alpha \\in S(T)$ for some object $T \\in \\mathcal{U}$. This means exactly that $\\alpha : T \\to U$ is a morphism which factors through $f_ i$ for some $i\\in I$ (and maybe more than $1$). Pick such an index $i$ and a factorization $\\alpha = f_ i \\circ \\alpha _ i$. Define $\\varphi (\\alpha ) = \\alpha _ i^* s_ i$. If $i\'$, $\\alpha = f_ i \\circ \\alpha _{i\'}\'$ is a second choice, then $\\alpha _ i^* s_ i = (\\alpha _{i\'}\')^* s_{i\'}$ exactly because of our condition $s_ i|_{U_ i \\times _ U U_ j} = s_ j|_{U_ i \\times _ U U_ j}$ for all $i, j$. Thus $\\varphi (\\alpha )$ is well defined. We leave it to the reader to verify that $\\varphi $, which in turn determines $s$ is correct in the sense that $s$ restricts back to $s_ i$. \n    \n      Let $\\mathcal{F}$ be a presheaf. Suppose that $\\mathcal{F}$ is a sheaf on the site $(\\mathcal{C}, \\text{Cov}(\\mathcal{C}))$. We will show that $\\mathcal{F}$ is a sheaf for the topology $J$ as well. Let $U$ be an object of $\\mathcal{C}$. Let $S$ be a covering sieve on $U$ with respect to the topology $J$. Let \n    \n      \n  \\[  \\varphi \\in \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(S, \\mathcal{F}).  \\]\n\n    \n       We have to show there is a unique element in $\\mathcal{F}(U) = \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(h_ U, \\mathcal{F})$ which restricts back to $\\varphi $. By definition there exists a covering $\\{ f_ i : U_ i \\to U\\} _{i\\in I} \\in \\text{Cov}(\\mathcal{C})$ such that $f_ i : U_ i \\in U$ belongs to $S(U_ i)$. Hence we can set $s_ i = \\varphi (f_ i) \\in \\mathcal{F}(U_ i)$. Then it is a pleasant exercise to see that $s_ i|_{U_ i \\times _ U U_ j} = s_ j|_{U_ i \\times _ U U_ j}$ for all $i, j$. Thus we obtain the desired section $s$ by the sheaf condition for $\\mathcal{F}$ on the site $(\\mathcal{C}, \\text{Cov}(\\mathcal{C}))$. Details left to the reader. \n      $\\square$\n    \n","\n  Lemma 7.48.1. Let $\\mathcal{C}$ be a site with coverings $\\text{Cov}(\\mathcal{C})$. For every object $U$ of $\\mathcal{C}$, let $J(U)$ denote the set of sieves $S$ on $U$ with the following property: there exists a covering $\\{ f_ i : U_ i \\to U\\} _{i\\in I} \\in \\text{Cov}(\\mathcal{C})$ so that the sieve $S\'$ generated by the $f_ i$ (see Definition 7.47.3) is contained in $S$. \n  \n  \nThis $J$ is a topology on $\\mathcal{C}$. \n\n\nA presheaf $\\mathcal{F}$ is a sheaf for this topology (see Definition 7.47.10) if and only if it is a sheaf on the site (see Definition 7.7.1). \n\n\n\n\n    \n","Proof.\n      To prove the first assertion we just note that axioms (1), (2) and (3) of the definition of a site (Definition 7.6.2) directly imply the axioms (3), (2) and (1) of the definition of a topology (Definition 7.47.6). As an example we prove $J$ has property (2). Namely, let $U$ be an object of $\\mathcal{C}$, let $S, S\'$ be sieves on $U$ such that $S \\in J(U)$, and such that for every $V \\to U$ in $S(V)$ we have $S\' \\times _ U V \\in J(V)$. By definition of $J(U)$ we can find a covering $\\{ f_ i : U_ i \\to U\\} $ of the site such that $S$ the image of $h_{U_ i} \\to h_ U$ is contained in $S$. Since each $S\'\\times _ U U_ i$ is in $J(U_ i)$ we see that there are coverings $\\{ U_{ij} \\to U_ i\\} $ of the site such that $h_{U_{ij}} \\to h_{U_ i}$ is contained in $S\' \\times _ U U_ i$. By definition of the base change this means that $h_{U_{ij}} \\to h_ U$ is contained in the subpresheaf $S\' \\subset h_ U$. By axiom (2) for sites we see that $\\{ U_{ij} \\to U\\} $ is a covering of $U$ and we conclude that $S\' \\in J(U)$ by definition of $J$. \n    \n      Let $\\mathcal{F}$ be a presheaf. Suppose that $\\mathcal{F}$ is a sheaf in the topology $J$. We will show that $\\mathcal{F}$ is a sheaf on the site as well. Let $\\{ f_ i : U_ i \\to U\\} _{i\\in I}$ be a covering of the site. Let $s_ i \\in \\mathcal{F}(U_ i)$ be a family of sections such that $s_ i|_{U_ i \\times _ U U_ j} = s_ j|_{U_ i \\times _ U U_ j}$ for all $i, j$. We have to show that there exists a unique section $s \\in \\mathcal{F}(U)$ restricting back to the $s_ i$ on the $U_ i$. Let $S \\subset h_ U$ be the sieve generated by the $f_ i$. Note that $S \\in J(U)$ by definition. In stead of constructing $s$, by the sheaf condition in the topology, it suffices to construct an element \n    \n      \n  \\[  \\varphi \\in \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(S, \\mathcal{F}).  \\]\n\n    \n       Take $\\alpha \\in S(T)$ for some object $T \\in \\mathcal{U}$. This means exactly that $\\alpha : T \\to U$ is a morphism which factors through $f_ i$ for some $i\\in I$ (and maybe more than $1$). Pick such an index $i$ and a factorization $\\alpha = f_ i \\circ \\alpha _ i$. Define $\\varphi (\\alpha ) = \\alpha _ i^* s_ i$. If $i\'$, $\\alpha = f_ i \\circ \\alpha _{i\'}\'$ is a second choice, then $\\alpha _ i^* s_ i = (\\alpha _{i\'}\')^* s_{i\'}$ exactly because of our condition $s_ i|_{U_ i \\times _ U U_ j} = s_ j|_{U_ i \\times _ U U_ j}$ for all $i, j$. Thus $\\varphi (\\alpha )$ is well defined. We leave it to the reader to verify that $\\varphi $, which in turn determines $s$ is correct in the sense that $s$ restricts back to $s_ i$. \n    \n      Let $\\mathcal{F}$ be a presheaf. Suppose that $\\mathcal{F}$ is a sheaf on the site $(\\mathcal{C}, \\text{Cov}(\\mathcal{C}))$. We will show that $\\mathcal{F}$ is a sheaf for the topology $J$ as well. Let $U$ be an object of $\\mathcal{C}$. Let $S$ be a covering sieve on $U$ with respect to the topology $J$. Let \n    \n      \n  \\[  \\varphi \\in \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(S, \\mathcal{F}).  \\]\n\n    \n       We have to show there is a unique element in $\\mathcal{F}(U) = \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(h_ U, \\mathcal{F})$ which restricts back to $\\varphi $. By definition there exists a covering $\\{ f_ i : U_ i \\to U\\} _{i\\in I} \\in \\text{Cov}(\\mathcal{C})$ such that $f_ i : U_ i \\in U$ belongs to $S(U_ i)$. Hence we can set $s_ i = \\varphi (f_ i) \\in \\mathcal{F}(U_ i)$. Then it is a pleasant exercise to see that $s_ i|_{U_ i \\times _ U U_ j} = s_ j|_{U_ i \\times _ U U_ j}$ for all $i, j$. Thus we obtain the desired section $s$ by the sheaf condition for $\\mathcal{F}$ on the site $(\\mathcal{C}, \\text{Cov}(\\mathcal{C}))$. Details left to the reader. \n      $\\square$\n    \n"," âˆƒ R âˆˆ K X, R â‰¤ (S : Presieve _)
  top_mem' _ := âŸ¨Presieve.singleton (ðŸ™ _), K.has_isos _, fun _ _ _ => âŸ¨âŸ©âŸ©
  pullback_stable' X Y S g := by
    rintro âŸ¨R, hR, RSâŸ©
    refine âŸ¨_, K.pullbacks g _ hR, ?_âŸ©
    rw [â† Sieve.generate_le_iff, Sieve.pullbackArrows_comm]
    apply Sieve.pullback_monotone
    rwa [Sieve.giGenerate.gc]
  transitive' := by
    rintro X S âŸ¨R', hR', RSâŸ© R t
    choose tâ‚ tâ‚‚ tâ‚ƒ using t
    refine âŸ¨_, K.transitive _ _ hR' fun _ f hf => tâ‚‚ (RS _ hf), ?_âŸ©
    rintro Y _ âŸ¨Z, g, f, hg, hf, rflâŸ©
    apply tâ‚ƒ (RS _ hg) _ hf
","def toGrothendieck (K : Pretopology C) : GrothendieckTopology C where
  sieves X S ","Proof.\n      To prove the first assertion we just note that axioms (1), (2) and (3) of the definition of a site (Definition 7.6.2 [[\n  Definition 7.6.2. A site1 is given by a category $\\mathcal{C}$ and a set $\\text{Cov}(\\mathcal{C})$ of families of morphisms with fixed target $\\{ U_ i \\to U\\} _{i \\in I}$, called coverings of $\\mathcal{C}$, satisfying the following axioms \n  \n  \nIf $V \\to U$ is an isomorphism then $\\{ V \\to U\\}  \\in \\text{Cov}(\\mathcal{C})$. \n\n\nIf $\\{ U_ i \\to U\\} _{i\\in I} \\in \\text{Cov}(\\mathcal{C})$ and for each $i$ we have $\\{ V_{ij} \\to U_ i\\} _{j\\in J_ i} \\in \\text{Cov}(\\mathcal{C})$, then $\\{ V_{ij} \\to U\\} _{i \\in I, j\\in J_ i} \\in \\text{Cov}(\\mathcal{C})$. \n\n\nIf $\\{ U_ i \\to U\\} _{i\\in I}\\in \\text{Cov}(\\mathcal{C})$ and $V \\to U$ is a morphism of $\\mathcal{C}$ then $U_ i \\times _ U V$ exists for all $i$ and $\\{ U_ i \\times _ U V \\to V \\} _{i\\in I} \\in \\text{Cov}(\\mathcal{C})$. \n\n\n\n]]) directly imply the axioms (3), (2) and (1) of the definition of a topology (Definition 7.47.6 [[\n  Definition 7.47.6. Let $\\mathcal{C}$ be a category. A topology on $\\mathcal{C}$ is given by a rule which assigns to every $U \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{C})$ a subset $J(U)$ of the set of all sieves on $U$ satisfying the following conditions \n  \n  \nFor every morphism $f : V \\to U$ in $\\mathcal{C}$, and every element $S \\in J(U)$ the pullback $S \\times _ U V$ is an element of $J(V)$. \n\n\nIf $S$ and $S\'$ are sieves on $U \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{C})$, if $S \\in J(U)$, and if for all $f \\in S(V)$ the pullback $S\' \\times _ U V$ belongs to $J(V)$, then $S\'$ belongs to $J(U)$. \n\n\nFor every $U \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{C})$ the maximal sieve $S = h_ U$ belongs to $J(U)$. \n\n\n\n]]). As an example we prove $J$ has property (2). Namely, let $U$ be an object of $\\mathcal{C}$, let $S, S\'$ be sieves on $U$ such that $S \\in J(U)$, and such that for every $V \\to U$ in $S(V)$ we have $S\' \\times _ U V \\in J(V)$. By definition of $J(U)$ we can find a covering $\\{ f_ i : U_ i \\to U\\} $ of the site such that $S$ the image of $h_{U_ i} \\to h_ U$ is contained in $S$. Since each $S\'\\times _ U U_ i$ is in $J(U_ i)$ we see that there are coverings $\\{ U_{ij} \\to U_ i\\} $ of the site such that $h_{U_{ij}} \\to h_{U_ i}$ is contained in $S\' \\times _ U U_ i$. By definition of the base change this means that $h_{U_{ij}} \\to h_ U$ is contained in the subpresheaf $S\' \\subset h_ U$. By axiom (2) for sites we see that $\\{ U_{ij} \\to U\\} $ is a covering of $U$ and we conclude that $S\' \\in J(U)$ by definition of $J$. \n    \n      Let $\\mathcal{F}$ be a presheaf. Suppose that $\\mathcal{F}$ is a sheaf in the topology $J$. We will show that $\\mathcal{F}$ is a sheaf on the site as well. Let $\\{ f_ i : U_ i \\to U\\} _{i\\in I}$ be a covering of the site. Let $s_ i \\in \\mathcal{F}(U_ i)$ be a family of sections such that $s_ i|_{U_ i \\times _ U U_ j} = s_ j|_{U_ i \\times _ U U_ j}$ for all $i, j$. We have to show that there exists a unique section $s \\in \\mathcal{F}(U)$ restricting back to the $s_ i$ on the $U_ i$. Let $S \\subset h_ U$ be the sieve generated by the $f_ i$. Note that $S \\in J(U)$ by definition. In stead of constructing $s$, by the sheaf condition in the topology, it suffices to construct an element \n    \n      \n  \\[  \\varphi \\in \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(S, \\mathcal{F}).  \\]\n\n    \n       Take $\\alpha \\in S(T)$ for some object $T \\in \\mathcal{U}$. This means exactly that $\\alpha : T \\to U$ is a morphism which factors through $f_ i$ for some $i\\in I$ (and maybe more than $1$). Pick such an index $i$ and a factorization $\\alpha = f_ i \\circ \\alpha _ i$. Define $\\varphi (\\alpha ) = \\alpha _ i^* s_ i$. If $i\'$, $\\alpha = f_ i \\circ \\alpha _{i\'}\'$ is a second choice, then $\\alpha _ i^* s_ i = (\\alpha _{i\'}\')^* s_{i\'}$ exactly because of our condition $s_ i|_{U_ i \\times _ U U_ j} = s_ j|_{U_ i \\times _ U U_ j}$ for all $i, j$. Thus $\\varphi (\\alpha )$ is well defined. We leave it to the reader to verify that $\\varphi $, which in turn determines $s$ is correct in the sense that $s$ restricts back to $s_ i$. \n    \n      Let $\\mathcal{F}$ be a presheaf. Suppose that $\\mathcal{F}$ is a sheaf on the site $(\\mathcal{C}, \\text{Cov}(\\mathcal{C}))$. We will show that $\\mathcal{F}$ is a sheaf for the topology $J$ as well. Let $U$ be an object of $\\mathcal{C}$. Let $S$ be a covering sieve on $U$ with respect to the topology $J$. Let \n    \n      \n  \\[  \\varphi \\in \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(S, \\mathcal{F}).  \\]\n\n    \n       We have to show there is a unique element in $\\mathcal{F}(U) = \\mathop{\\mathrm{Mor}}\\nolimits _{\\textit{PSh}(\\mathcal{C})}(h_ U, \\mathcal{F})$ which restricts back to $\\varphi $. By definition there exists a covering $\\{ f_ i : U_ i \\to U\\} _{i\\in I} \\in \\text{Cov}(\\mathcal{C})$ such that $f_ i : U_ i \\in U$ belongs to $S(U_ i)$. Hence we can set $s_ i = \\varphi (f_ i) \\in \\mathcal{F}(U_ i)$. Then it is a pleasant exercise to see that $s_ i|_{U_ i \\times _ U U_ j} = s_ j|_{U_ i \\times _ U U_ j}$ for all $i, j$. Thus we obtain the desired section $s$ by the sheaf condition for $\\mathcal{F}$ on the site $(\\mathcal{C}, \\text{Cov}(\\mathcal{C}))$. Details left to the reader. \n      $\\square$\n    \n"
130,07GE,"def trivial : Pretopology C where
  coverings X S := âˆƒ (Y : _) (f : Y âŸ¶ X) (_ : IsIso f), S = Presieve.singleton f
  has_isos _ _ _ i := âŸ¨_, _, i, rflâŸ©
  pullbacks X Y f S := by
    rintro âŸ¨Z, g, i, rflâŸ©
    refine âŸ¨pullback g f, pullback.snd _ _, ?_, ?_âŸ©
    Â· refine âŸ¨âŸ¨pullback.lift (f â‰« inv g) (ðŸ™ _) (by simp), âŸ¨?_, by simpâŸ©âŸ©âŸ©
      ext
      Â· rw [assoc, pullback.lift_fst, â† pullback.condition_assoc]
        simp
      Â· simp
    Â· apply pullback_singleton
  transitive := by
    rintro X S Ti âŸ¨Z, g, i, rflâŸ© hS
    rcases hS g (singleton_self g) with âŸ¨Y, f, i, hTiâŸ©
    refine âŸ¨_, f â‰« g, ?_, ?_âŸ©
    Â· infer_instance
    -- Porting note (https://github.com/leanprover-community/mathlib4/issues/11041): the next four lines were just ""ext (W k)""
    apply funext
    rintro W
    apply Set.ext
    rintro k
    constructor
    Â· rintro âŸ¨V, h, k, âŸ¨_âŸ©, hh, rflâŸ©
      rw [hTi] at hh
      cases hh
      apply singleton.mk
    Â· rintro âŸ¨_âŸ©
      refine bind_comp g singleton.mk ?_
      rw [hTi]
      apply singleton.mk
",Formal Proof of Stacks Project Tag 07GE,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Sites/Pretopology.lean#L183-L213,Q27041,,7.6.6,example,3.0,"['00VG', '00UZ', '0ELQ']",\n  Example 7.6.6. Let $\\mathcal{C}$ be a category. There is a canonical way to turn this into a site where $\\{ f : V \\to U \\mid f\\text{ is an isomorphism}\\} $ are the coverings of $U$. Sheaves on this site are the presheaves on $\\mathcal{C}$. This corresponding topology is called the chaotic or indiscrete topology. \n,\n  Example 7.6.6. Let $\\mathcal{C}$ be a category. There is a canonical way to turn this into a site where $\\{ f : V \\to U \\mid f\\text{ is an isomorphism}\\} $ are the coverings of $U$. Sheaves on this site are the presheaves on $\\mathcal{C}$. This corresponding topology is called the chaotic or indiscrete topology. \n,," âˆƒ (Y : _) (f : Y âŸ¶ X) (_ : IsIso f), S = Presieve.singleton f
  has_isos _ _ _ i := âŸ¨_, _, i, rflâŸ©
  pullbacks X Y f S := by
    rintro âŸ¨Z, g, i, rflâŸ©
    refine âŸ¨pullback g f, pullback.snd _ _, ?_, ?_âŸ©
    Â· refine âŸ¨âŸ¨pullback.lift (f â‰« inv g) (ðŸ™ _) (by simp), âŸ¨?_, by simpâŸ©âŸ©âŸ©
      ext
      Â· rw [assoc, pullback.lift_fst, â† pullback.condition_assoc]
        simp
      Â· simp
    Â· apply pullback_singleton
  transitive := by
    rintro X S Ti âŸ¨Z, g, i, rflâŸ© hS
    rcases hS g (singleton_self g) with âŸ¨Y, f, i, hTiâŸ©
    refine âŸ¨_, f â‰« g, ?_, ?_âŸ©
    Â· infer_instance
    -- Porting note (https://github.com/leanprover-community/mathlib4/issues/11041): the next four lines were just ""ext (W k)""
    apply funext
    rintro W
    apply Set.ext
    rintro k
    constructor
    Â· rintro âŸ¨V, h, k, âŸ¨_âŸ©, hh, rflâŸ©
      rw [hTi] at hh
      cases hh
      apply singleton.mk
    Â· rintro âŸ¨_âŸ©
      refine bind_comp g singleton.mk ?_
      rw [hTi]
      apply singleton.mk
","def trivial : Pretopology C where
  coverings X S ",
131,00VR,"def IsSheaf (P : Cáµ’áµ– â¥¤ A) : Prop :=
  âˆ€ E : A, Presieve.IsSheaf J (P â‹™ coyoneda.obj (op E))
",Formal Proof of Stacks Project Tag 00VR,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Sites/Sheaf.lean#L77-L78,Q27041,,7.7.6,definition,3.0,"['00VL', '00UZ', '0ELQ']","\n  Definition 7.7.6. Let $\\mathcal{C}$ be a site, let $\\mathcal{A}$ be a category and let $\\mathcal{F}$ be a presheaf on $\\mathcal{C}$ with values in $\\mathcal{A}$. We say that $\\mathcal{F}$ is a sheaf if for all objects $X$ of $\\mathcal{A}$ the presheaf of sets $\\mathcal{F}_ X$ (defined above) is a sheaf. \n","\n  Definition 7.7.6. Let $\\mathcal{C}$ be a site, let $\\mathcal{A}$ be a category and let $\\mathcal{F}$ be a presheaf on $\\mathcal{C}$ with values in $\\mathcal{A}$. We say that $\\mathcal{F}$ is a sheaf if for all objects $X$ of $\\mathcal{A}$ the presheaf of sets $\\mathcal{F}_ X$ (defined above) is a sheaf. \n",,"
  âˆ€ E : A, Presieve.IsSheaf J (P â‹™ coyoneda.obj (op E))
",def IsSheaf (P : Cáµ’áµ– â¥¤ A) : Prop ,
132,00VM,"def forkMap : P.obj (op U) âŸ¶ firstObj R P :=
  Pi.lift fun f => P.map f.2.1.op
",Formal Proof of Stacks Project Tag 00VM,The left morphism the fork diagram there.,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Sites/Sheaf.lean#L635-L636,Q27041,,7.7.1,definition,3.0,"['00VL', '00UZ', '0ELQ']","\n  Definition 7.7.1. Let $\\mathcal{C}$ be a site, and let $\\mathcal{F}$ be a presheaf of sets on $\\mathcal{C}$. We say $\\mathcal{F}$ is a sheaf if for every covering $\\{ U_ i \\to U\\} _{i \\in I} \\in \\text{Cov}(\\mathcal{C})$ the diagram \n  \n    7.7.1.1\n  \\begin{equation}  \\label{sites-equation-sheaf-condition} \\xymatrix{ \\mathcal{F}(U) \\ar[r] &  \\prod \\nolimits _{i\\in I} \\mathcal{F}(U_ i) \\ar@<1ex>[r]^-{\\text{pr}_0^*} \\ar@<-1ex>[r]_-{\\text{pr}_1^*} &  \\prod \\nolimits _{(i_0, i_1) \\in I \\times I} \\mathcal{F}(U_{i_0} \\times _ U U_{i_1}) } \\end{equation}\n\n   represents the first arrow as the equalizer of $\\text{pr}_0^*$ and $\\text{pr}_1^*$. \n","\n  Definition 7.7.1. Let $\\mathcal{C}$ be a site, and let $\\mathcal{F}$ be a presheaf of sets on $\\mathcal{C}$. We say $\\mathcal{F}$ is a sheaf if for every covering $\\{ U_ i \\to U\\} _{i \\in I} \\in \\text{Cov}(\\mathcal{C})$ the diagram \n  \n    7.7.1.1\n  \\begin{equation}  \\label{sites-equation-sheaf-condition} \\xymatrix{ \\mathcal{F}(U) \\ar[r] &  \\prod \\nolimits _{i\\in I} \\mathcal{F}(U_ i) \\ar@<1ex>[r]^-{\\text{pr}_0^*} \\ar@<-1ex>[r]_-{\\text{pr}_1^*} &  \\prod \\nolimits _{(i_0, i_1) \\in I \\times I} \\mathcal{F}(U_{i_0} \\times _ U U_{i_1}) } \\end{equation}\n\n   represents the first arrow as the equalizer of $\\text{pr}_0^*$ and $\\text{pr}_1^*$. \n",,"
  Pi.lift fun f => P.map f.2.1.op
",def forkMap : P.obj (op U) âŸ¶ firstObj R P ,
133,00VM,"def firstMap : firstObj R P âŸ¶ secondObj R P :=
  Pi.lift fun _ => Pi.Ï€ _ _ â‰« P.map (pullback.fst _ _).op
",Formal Proof of Stacks Project Tag 00VM,The map `prâ‚€*` there.,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Sites/Sheaf.lean#L650-L651,Q27041,,7.7.1,definition,3.0,"['00VL', '00UZ', '0ELQ']","\n  Definition 7.7.1. Let $\\mathcal{C}$ be a site, and let $\\mathcal{F}$ be a presheaf of sets on $\\mathcal{C}$. We say $\\mathcal{F}$ is a sheaf if for every covering $\\{ U_ i \\to U\\} _{i \\in I} \\in \\text{Cov}(\\mathcal{C})$ the diagram \n  \n    7.7.1.1\n  \\begin{equation}  \\label{sites-equation-sheaf-condition} \\xymatrix{ \\mathcal{F}(U) \\ar[r] &  \\prod \\nolimits _{i\\in I} \\mathcal{F}(U_ i) \\ar@<1ex>[r]^-{\\text{pr}_0^*} \\ar@<-1ex>[r]_-{\\text{pr}_1^*} &  \\prod \\nolimits _{(i_0, i_1) \\in I \\times I} \\mathcal{F}(U_{i_0} \\times _ U U_{i_1}) } \\end{equation}\n\n   represents the first arrow as the equalizer of $\\text{pr}_0^*$ and $\\text{pr}_1^*$. \n","\n  Definition 7.7.1. Let $\\mathcal{C}$ be a site, and let $\\mathcal{F}$ be a presheaf of sets on $\\mathcal{C}$. We say $\\mathcal{F}$ is a sheaf if for every covering $\\{ U_ i \\to U\\} _{i \\in I} \\in \\text{Cov}(\\mathcal{C})$ the diagram \n  \n    7.7.1.1\n  \\begin{equation}  \\label{sites-equation-sheaf-condition} \\xymatrix{ \\mathcal{F}(U) \\ar[r] &  \\prod \\nolimits _{i\\in I} \\mathcal{F}(U_ i) \\ar@<1ex>[r]^-{\\text{pr}_0^*} \\ar@<-1ex>[r]_-{\\text{pr}_1^*} &  \\prod \\nolimits _{(i_0, i_1) \\in I \\times I} \\mathcal{F}(U_{i_0} \\times _ U U_{i_1}) } \\end{equation}\n\n   represents the first arrow as the equalizer of $\\text{pr}_0^*$ and $\\text{pr}_1^*$. \n",,"
  Pi.lift fun _ => Pi.Ï€ _ _ â‰« P.map (pullback.fst _ _).op
",def firstMap : firstObj R P âŸ¶ secondObj R P ,
134,00VM,"def secondMap : firstObj R P âŸ¶ secondObj R P :=
  Pi.lift fun _ => Pi.Ï€ _ _ â‰« P.map (pullback.snd _ _).op
",Formal Proof of Stacks Project Tag 00VM,The map `prâ‚*` there.,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Sites/Sheaf.lean#L655-L656,Q27041,,7.7.1,definition,3.0,"['00VL', '00UZ', '0ELQ']","\n  Definition 7.7.1. Let $\\mathcal{C}$ be a site, and let $\\mathcal{F}$ be a presheaf of sets on $\\mathcal{C}$. We say $\\mathcal{F}$ is a sheaf if for every covering $\\{ U_ i \\to U\\} _{i \\in I} \\in \\text{Cov}(\\mathcal{C})$ the diagram \n  \n    7.7.1.1\n  \\begin{equation}  \\label{sites-equation-sheaf-condition} \\xymatrix{ \\mathcal{F}(U) \\ar[r] &  \\prod \\nolimits _{i\\in I} \\mathcal{F}(U_ i) \\ar@<1ex>[r]^-{\\text{pr}_0^*} \\ar@<-1ex>[r]_-{\\text{pr}_1^*} &  \\prod \\nolimits _{(i_0, i_1) \\in I \\times I} \\mathcal{F}(U_{i_0} \\times _ U U_{i_1}) } \\end{equation}\n\n   represents the first arrow as the equalizer of $\\text{pr}_0^*$ and $\\text{pr}_1^*$. \n","\n  Definition 7.7.1. Let $\\mathcal{C}$ be a site, and let $\\mathcal{F}$ be a presheaf of sets on $\\mathcal{C}$. We say $\\mathcal{F}$ is a sheaf if for every covering $\\{ U_ i \\to U\\} _{i \\in I} \\in \\text{Cov}(\\mathcal{C})$ the diagram \n  \n    7.7.1.1\n  \\begin{equation}  \\label{sites-equation-sheaf-condition} \\xymatrix{ \\mathcal{F}(U) \\ar[r] &  \\prod \\nolimits _{i\\in I} \\mathcal{F}(U_ i) \\ar@<1ex>[r]^-{\\text{pr}_0^*} \\ar@<-1ex>[r]_-{\\text{pr}_1^*} &  \\prod \\nolimits _{(i_0, i_1) \\in I \\times I} \\mathcal{F}(U_{i_0} \\times _ U U_{i_1}) } \\end{equation}\n\n   represents the first arrow as the equalizer of $\\text{pr}_0^*$ and $\\text{pr}_1^*$. \n",,"
  Pi.lift fun _ => Pi.Ï€ _ _ â‰« P.map (pullback.snd _ _).op
",def secondMap : firstObj R P âŸ¶ secondObj R P ,
135,026F,"class IsPrestack (J : GrothendieckTopology C) : Prop where
  isSheaf (J) {S : C} (M N : F.obj (.mk (op S))) :
    Presheaf.IsSheaf (J.over S) (F.presheafHom M N)
",Formal Proof of Stacks Project Tag 026F,(2),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Sites/Descent/IsPrestack.lean#L158-L160,Q27041,,8.4.1,definition,3.0,"['0268', '0266', '0ELQ']","\n  Definition 8.4.1. Let $\\mathcal{C}$ be a site. A stack over $\\mathcal{C}$ is a category $p : \\mathcal{S} \\to \\mathcal{C}$ over $\\mathcal{C}$ which satisfies the following conditions: \n  \n  \n$p : \\mathcal{S} \\to \\mathcal{C}$ is a fibred category, see Categories, Definition 4.33.5, \n\n\nfor any $U \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{C})$ and any $x, y \\in \\mathcal{S}_ U$ the presheaf $\\mathit{Mor}(x, y)$ (see Definition 8.2.2) is a sheaf on the site $\\mathcal{C}/U$, and \n\n\nfor any covering $\\mathcal{U} = \\{ f_ i : U_ i \\to U\\} _{i \\in I}$ of the site $\\mathcal{C}$, any descent datum in $\\mathcal{S}$ relative to $\\mathcal{U}$ is effective. \n\n\n\n","\n  Definition 8.4.1. Let $\\mathcal{C}$ be a site. A stack over $\\mathcal{C}$ is a category $p : \\mathcal{S} \\to \\mathcal{C}$ over $\\mathcal{C}$ which satisfies the following conditions: \n  \n  \n$p : \\mathcal{S} \\to \\mathcal{C}$ is a fibred category, see Categories, Definition 4.33.5, \n\n\nfor any $U \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{C})$ and any $x, y \\in \\mathcal{S}_ U$ the presheaf $\\mathit{Mor}(x, y)$ (see Definition 8.2.2) is a sheaf on the site $\\mathcal{C}/U$, and \n\n\nfor any covering $\\mathcal{U} = \\{ f_ i : U_ i \\to U\\} _{i \\in I}$ of the site $\\mathcal{C}$, any descent datum in $\\mathcal{S}$ relative to $\\mathcal{U}$ is effective. \n\n\n\n",,,"class IsPrestack (J : GrothendieckTopology C) : Prop where
  isSheaf (J) {S : C} (M N : F.obj (.mk (op S))) :
    Presheaf.IsSheaf (J.over S) (F.presheafHom M N)
",
136,026F,"class IsStack (F : LocallyDiscrete Cáµ’áµ– â¥¤áµ– Cat.{v', u'}) (J : GrothendieckTopology C) : Prop
    extends F.IsPrestack J where
  essSurj_of_sieve (F) {S : C} (R : Sieve S) (hR : R âˆˆ J S) :
    (F.toDescentData (fun (f : R.arrows.category) â†¦ f.obj.hom)).EssSurj
",Formal Proof of Stacks Project Tag 026F,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Sites/Descent/IsStack.lean#L49-L52,Q27041,,8.4.1,definition,3.0,"['0268', '0266', '0ELQ']","\n  Definition 8.4.1. Let $\\mathcal{C}$ be a site. A stack over $\\mathcal{C}$ is a category $p : \\mathcal{S} \\to \\mathcal{C}$ over $\\mathcal{C}$ which satisfies the following conditions: \n  \n  \n$p : \\mathcal{S} \\to \\mathcal{C}$ is a fibred category, see Categories, Definition 4.33.5, \n\n\nfor any $U \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{C})$ and any $x, y \\in \\mathcal{S}_ U$ the presheaf $\\mathit{Mor}(x, y)$ (see Definition 8.2.2) is a sheaf on the site $\\mathcal{C}/U$, and \n\n\nfor any covering $\\mathcal{U} = \\{ f_ i : U_ i \\to U\\} _{i \\in I}$ of the site $\\mathcal{C}$, any descent datum in $\\mathcal{S}$ relative to $\\mathcal{U}$ is effective. \n\n\n\n","\n  Definition 8.4.1. Let $\\mathcal{C}$ be a site. A stack over $\\mathcal{C}$ is a category $p : \\mathcal{S} \\to \\mathcal{C}$ over $\\mathcal{C}$ which satisfies the following conditions: \n  \n  \n$p : \\mathcal{S} \\to \\mathcal{C}$ is a fibred category, see Categories, Definition 4.33.5, \n\n\nfor any $U \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{C})$ and any $x, y \\in \\mathcal{S}_ U$ the presheaf $\\mathit{Mor}(x, y)$ (see Definition 8.2.2) is a sheaf on the site $\\mathcal{C}/U$, and \n\n\nfor any covering $\\mathcal{U} = \\{ f_ i : U_ i \\to U\\} _{i \\in I}$ of the site $\\mathcal{C}$, any descent datum in $\\mathcal{S}$ relative to $\\mathcal{U}$ is effective. \n\n\n\n",,,"class IsStack (F : LocallyDiscrete Cáµ’áµ– â¥¤áµ– Cat.{v', u'}) (J : GrothendieckTopology C) : Prop
    extends F.IsPrestack J where
  essSurj_of_sieve (F) {S : C} (R : Sieve S) (hR : R âˆˆ J S) :
    (F.toDescentData (fun (f : R.arrows.category) â†¦ f.obj.hom)).EssSurj
",
137,0FCF,"abbrev IsArtinianObject : Prop := isArtinianObject.Is X
",Formal Proof of Stacks Project Tag 0FCF,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Subobject/ArtinianObject.lean#L56-L56,Q27041,,12.9.2,definition,3.0,"['0FCD', '00ZU', '0ELQ']",\n  Definition 12.9.2. Let $\\mathcal{A}$ be an abelian category. \n  \n  \nWe say an object $A$ of $\\mathcal{A}$ is Artinian if and only if it satisfies the descending chain condition for subobjects. \n\n\nWe say $\\mathcal{A}$ is Artinian if every object of $\\mathcal{A}$ is Artinian. \n\n\n\n,\n  Definition 12.9.2. Let $\\mathcal{A}$ be an abelian category. \n  \n  \nWe say an object $A$ of $\\mathcal{A}$ is Artinian if and only if it satisfies the descending chain condition for subobjects. \n\n\nWe say $\\mathcal{A}$ is Artinian if every object of $\\mathcal{A}$ is Artinian. \n\n\n\n,," isArtinianObject.Is X
",abbrev IsArtinianObject : Prop ,
138,0FCG,"abbrev IsNoetherianObject : Prop := isNoetherianObject.Is X
",Formal Proof of Stacks Project Tag 0FCG,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Subobject/NoetherianObject.lean#L55-L55,Q27041,,12.9.3,definition,3.0,"['0FCD', '00ZU', '0ELQ']",\n  Definition 12.9.3. Let $\\mathcal{A}$ be an abelian category. \n  \n  \nWe say an object $A$ of $\\mathcal{A}$ is Noetherian if and only if it satisfies the ascending chain condition for subobjects. \n\n\nWe say $\\mathcal{A}$ is Noetherian if every object of $\\mathcal{A}$ is Noetherian. \n\n\n\n,\n  Definition 12.9.3. Let $\\mathcal{A}$ be an abelian category. \n  \n  \nWe say an object $A$ of $\\mathcal{A}$ is Noetherian if and only if it satisfies the ascending chain condition for subobjects. \n\n\nWe say $\\mathcal{A}$ is Noetherian if every object of $\\mathcal{A}$ is Noetherian. \n\n\n\n,," isNoetherianObject.Is X
",abbrev IsNoetherianObject : Prop ,
139,0144,"structure Triangle where mk' ::
  /-- the first object of a triangle -/
  objâ‚ : C
  /-- the second object of a triangle -/
  objâ‚‚ : C
  /-- the third object of a triangle -/
  objâ‚ƒ : C
  /-- the first morphism of a triangle -/
  morâ‚ : objâ‚ âŸ¶ objâ‚‚
  /-- the second morphism of a triangle -/
  morâ‚‚ : objâ‚‚ âŸ¶ objâ‚ƒ
  /-- the third morphism of a triangle -/
  morâ‚ƒ : objâ‚ƒ âŸ¶ objâ‚âŸ¦(1 : â„¤)âŸ§
",Formal Proof of Stacks Project Tag 0144,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Triangulated/Basic.lean#L44-L56,Q27041,,13.3.1,definition,3.0,"['05QK', '05QI', '0ELQ']","\n  Definition 13.3.1. Let $\\mathcal{D}$ be an additive category. Let $[1] : \\mathcal{D} \\to \\mathcal{D}$, $E \\mapsto E[1]$ be an additive functor which is an auto-equivalence of $\\mathcal{D}$. \n  \n  \nA triangle is a sextuple $(X, Y, Z, f, g, h)$ where $X, Y, Z \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{D})$ and $f : X \\to Y$, $g : Y \\to Z$ and $h : Z \\to X[1]$ are morphisms of $\\mathcal{D}$. \n\n\nA morphism of triangles $(X, Y, Z, f, g, h) \\to (X\', Y\', Z\', f\', g\', h\')$ is given by morphisms $a : X \\to X\'$, $b : Y \\to Y\'$ and $c : Z \\to Z\'$ of $\\mathcal{D}$ such that $b \\circ f = f\' \\circ a$, $c \\circ g = g\' \\circ b$ and $a[1] \\circ h = h\' \\circ c$. \n\n\n\n","\n  Definition 13.3.1. Let $\\mathcal{D}$ be an additive category. Let $[1] : \\mathcal{D} \\to \\mathcal{D}$, $E \\mapsto E[1]$ be an additive functor which is an auto-equivalence of $\\mathcal{D}$. \n  \n  \nA triangle is a sextuple $(X, Y, Z, f, g, h)$ where $X, Y, Z \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{D})$ and $f : X \\to Y$, $g : Y \\to Z$ and $h : Z \\to X[1]$ are morphisms of $\\mathcal{D}$. \n\n\nA morphism of triangles $(X, Y, Z, f, g, h) \\to (X\', Y\', Z\', f\', g\', h\')$ is given by morphisms $a : X \\to X\'$, $b : Y \\to Y\'$ and $c : Z \\to Z\'$ of $\\mathcal{D}$ such that $b \\circ f = f\' \\circ a$, $c \\circ g = g\' \\circ b$ and $a[1] \\circ h = h\' \\circ c$. \n\n\n\n",,,"structure Triangle where mk' ::
  /-- the first object of a triangle -/
  objâ‚ : C
  /-- the second object of a triangle -/
  objâ‚‚ : C
  /-- the third object of a triangle -/
  objâ‚ƒ : C
  /-- the first morphism of a triangle -/
  morâ‚ : objâ‚ âŸ¶ objâ‚‚
  /-- the second morphism of a triangle -/
  morâ‚‚ : objâ‚‚ âŸ¶ objâ‚ƒ
  /-- the third morphism of a triangle -/
  morâ‚ƒ : objâ‚ƒ âŸ¶ objâ‚âŸ¦(1 : â„¤)âŸ§
",
140,0145,"class Pretriangulated [âˆ€ n : â„¤, Functor.Additive (shiftFunctor C n)] where
  /-- a class of triangle which are called `distinguished` -/
  distinguishedTriangles : Set (Triangle C)
  /-- a triangle that is isomorphic to a distinguished triangle is distinguished -/
  isomorphic_distinguished :
    âˆ€ Tâ‚ âˆˆ distinguishedTriangles, âˆ€ (Tâ‚‚) (_ : Tâ‚‚ â‰… Tâ‚), Tâ‚‚ âˆˆ distinguishedTriangles
  /-- obvious triangles `X âŸ¶ X âŸ¶ 0 âŸ¶ XâŸ¦1âŸ§` are distinguished -/
  contractible_distinguished : âˆ€ X : C, contractibleTriangle X âˆˆ distinguishedTriangles
  /-- any morphism `X âŸ¶ Y` is part of a distinguished triangle `X âŸ¶ Y âŸ¶ Z âŸ¶ XâŸ¦1âŸ§` -/
  distinguished_cocone_triangle :
    âˆ€ {X Y : C} (f : X âŸ¶ Y),
      âˆƒ (Z : C) (g : Y âŸ¶ Z) (h : Z âŸ¶ XâŸ¦(1 : â„¤)âŸ§), Triangle.mk f g h âˆˆ distinguishedTriangles
  /-- a triangle is distinguished iff it is so after rotating it -/
  rotate_distinguished_triangle :
    âˆ€ T : Triangle C, T âˆˆ distinguishedTriangles â†” T.rotate âˆˆ distinguishedTriangles
  /-- given two distinguished triangle, a commutative square
  can be extended as morphism of triangles -/
  complete_distinguished_triangle_morphism :
    âˆ€ (Tâ‚ Tâ‚‚ : Triangle C) (_ : Tâ‚ âˆˆ distinguishedTriangles) (_ : Tâ‚‚ âˆˆ distinguishedTriangles)
      (a : Tâ‚.objâ‚ âŸ¶ Tâ‚‚.objâ‚) (b : Tâ‚.objâ‚‚ âŸ¶ Tâ‚‚.objâ‚‚) (_ : Tâ‚.morâ‚ â‰« b = a â‰« Tâ‚‚.morâ‚),
      âˆƒ c : Tâ‚.objâ‚ƒ âŸ¶ Tâ‚‚.objâ‚ƒ, Tâ‚.morâ‚‚ â‰« c = b â‰« Tâ‚‚.morâ‚‚ âˆ§ Tâ‚.morâ‚ƒ â‰« aâŸ¦1âŸ§' = c â‰« Tâ‚‚.morâ‚ƒ
",Formal Proof of Stacks Project Tag 0145,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Triangulated/Pretriangulated.lean#L65-L85,Q27041,,13.3.2,definition,3.0,"['05QK', '05QI', '0ELQ']","\n  Definition 13.3.2. A triangulated category consists of a triple $(\\mathcal{D}, \\{ [n]\\} _{n\\in \\mathbf{Z}}, \\mathcal{T})$ where \n  \n  \n$\\mathcal{D}$ is an additive category, \n\n\n$[1] : \\mathcal{D} \\to \\mathcal{D}$, $E \\mapsto E[1]$ is an additive auto-equivalence and $[n]$ for $n \\in \\mathbf{Z}$ is as discussed above, and \n\n\n$\\mathcal{T}$ is a set of triangles (Definition 13.3.1) called the distinguished triangles \n\n\n\n   subject to the following conditions \n  \n  \nAny triangle isomorphic to a distinguished triangle is a distinguished triangle. Any triangle of the form $(X, X, 0, \\text{id}, 0, 0)$ is distinguished. For any morphism $f : X \\to Y$ of $\\mathcal{D}$ there exists a distinguished triangle of the form $(X, Y, Z, f, g, h)$. \n\n\nThe triangle $(X, Y, Z, f, g, h)$ is distinguished if and only if the triangle $(Y, Z, X[1], g, h, -f[1])$ is. \n\n\nGiven a solid diagram \n\n\n  \\[  \\xymatrix{ X \\ar[r]^ f \\ar[d]^ a &  Y \\ar[r]^ g \\ar[d]^ b &  Z \\ar[r]^ h \\ar@{-->}[d] &  X[1] \\ar[d]^{a[1]} \\\\  X\' \\ar[r]^{f\'} &  Y\' \\ar[r]^{g\'} &  Z\' \\ar[r]^{h\'} &  X\'[1] }  \\]\n\n\n whose rows are distinguished triangles and which satisfies $b \\circ f = f\' \\circ a$, there exists a morphism $c : Z \\to Z\'$ such that $(a, b, c)$ is a morphism of triangles. \n\n\nGiven objects $X$, $Y$, $Z$ of $\\mathcal{D}$, and morphisms $f : X \\to Y$, $g : Y \\to Z$, and distinguished triangles $(X, Y, Q_1, f, p_1, d_1)$, $(X, Z, Q_2, g \\circ f, p_2, d_2)$, and $(Y, Z, Q_3, g, p_3, d_3)$, there exist morphisms $a : Q_1 \\to Q_2$ and $b : Q_2 \\to Q_3$ such that \n\n\n  \n$(Q_1, Q_2, Q_3, a, b, p_1[1] \\circ d_3)$ is a distinguished triangle, \n\n\nthe triple $(\\text{id}_ X, g, a)$ is a morphism of triangles $(X, Y, Q_1, f, p_1, d_1) \\to (X, Z, Q_2, g \\circ f, p_2, d_2)$, and \n\n\nthe triple $(f, \\text{id}_ Z, b)$ is a morphism of triangles $(X, Z, Q_2, g \\circ f, p_2, d_2) \\to (Y, Z, Q_3, g, p_3, d_3)$. \n\n\n\n\n\n   We will call $(\\mathcal{D}, [\\  ], \\mathcal{T})$ a pre-triangulated category if TR1, TR2 and TR3 hold.1 \n","\n  Definition 13.3.2. A triangulated category consists of a triple $(\\mathcal{D}, \\{ [n]\\} _{n\\in \\mathbf{Z}}, \\mathcal{T})$ where \n  \n  \n$\\mathcal{D}$ is an additive category, \n\n\n$[1] : \\mathcal{D} \\to \\mathcal{D}$, $E \\mapsto E[1]$ is an additive auto-equivalence and $[n]$ for $n \\in \\mathbf{Z}$ is as discussed above, and \n\n\n$\\mathcal{T}$ is a set of triangles (Definition 13.3.1) called the distinguished triangles \n\n\n\n   subject to the following conditions \n  \n  \nAny triangle isomorphic to a distinguished triangle is a distinguished triangle. Any triangle of the form $(X, X, 0, \\text{id}, 0, 0)$ is distinguished. For any morphism $f : X \\to Y$ of $\\mathcal{D}$ there exists a distinguished triangle of the form $(X, Y, Z, f, g, h)$. \n\n\nThe triangle $(X, Y, Z, f, g, h)$ is distinguished if and only if the triangle $(Y, Z, X[1], g, h, -f[1])$ is. \n\n\nGiven a solid diagram \n\n\n  \\[  \\xymatrix{ X \\ar[r]^ f \\ar[d]^ a &  Y \\ar[r]^ g \\ar[d]^ b &  Z \\ar[r]^ h \\ar@{-->}[d] &  X[1] \\ar[d]^{a[1]} \\\\  X\' \\ar[r]^{f\'} &  Y\' \\ar[r]^{g\'} &  Z\' \\ar[r]^{h\'} &  X\'[1] }  \\]\n\n\n whose rows are distinguished triangles and which satisfies $b \\circ f = f\' \\circ a$, there exists a morphism $c : Z \\to Z\'$ such that $(a, b, c)$ is a morphism of triangles. \n\n\nGiven objects $X$, $Y$, $Z$ of $\\mathcal{D}$, and morphisms $f : X \\to Y$, $g : Y \\to Z$, and distinguished triangles $(X, Y, Q_1, f, p_1, d_1)$, $(X, Z, Q_2, g \\circ f, p_2, d_2)$, and $(Y, Z, Q_3, g, p_3, d_3)$, there exist morphisms $a : Q_1 \\to Q_2$ and $b : Q_2 \\to Q_3$ such that \n\n\n  \n$(Q_1, Q_2, Q_3, a, b, p_1[1] \\circ d_3)$ is a distinguished triangle, \n\n\nthe triple $(\\text{id}_ X, g, a)$ is a morphism of triangles $(X, Y, Q_1, f, p_1, d_1) \\to (X, Z, Q_2, g \\circ f, p_2, d_2)$, and \n\n\nthe triple $(f, \\text{id}_ Z, b)$ is a morphism of triangles $(X, Z, Q_2, g \\circ f, p_2, d_2) \\to (Y, Z, Q_3, g, p_3, d_3)$. \n\n\n\n\n\n   We will call $(\\mathcal{D}, [\\  ], \\mathcal{T})$ a pre-triangulated category if TR1, TR2 and TR3 hold.1 \n",,,"class Pretriangulated [âˆ€ n : â„¤, Functor.Additive (shiftFunctor C n)] where
  /-- a class of triangle which are called `distinguished` -/
  distinguishedTriangles : Set (Triangle C)
  /-- a triangle that is isomorphic to a distinguished triangle is distinguished -/
  isomorphic_distinguished :
    âˆ€ Tâ‚ âˆˆ distinguishedTriangles, âˆ€ (Tâ‚‚) (_ : Tâ‚‚ â‰… Tâ‚), Tâ‚‚ âˆˆ distinguishedTriangles
  /-- obvious triangles `X âŸ¶ X âŸ¶ 0 âŸ¶ XâŸ¦1âŸ§` are distinguished -/
  contractible_distinguished : âˆ€ X : C, contractibleTriangle X âˆˆ distinguishedTriangles
  /-- any morphism `X âŸ¶ Y` is part of a distinguished triangle `X âŸ¶ Y âŸ¶ Z âŸ¶ XâŸ¦1âŸ§` -/
  distinguished_cocone_triangle :
    âˆ€ {X Y : C} (f : X âŸ¶ Y),
      âˆƒ (Z : C) (g : Y âŸ¶ Z) (h : Z âŸ¶ XâŸ¦(1 : â„¤)âŸ§), Triangle.mk f g h âˆˆ distinguishedTriangles
  /-- a triangle is distinguished iff it is so after rotating it -/
  rotate_distinguished_triangle :
    âˆ€ T : Triangle C, T âˆˆ distinguishedTriangles â†” T.rotate âˆˆ distinguishedTriangles
  /-- given two distinguished triangle, a commutative square
  can be extended as morphism of triangles -/
  complete_distinguished_triangle_morphism :
    âˆ€ (Tâ‚ Tâ‚‚ : Triangle C) (_ : Tâ‚ âˆˆ distinguishedTriangles) (_ : Tâ‚‚ âˆˆ distinguishedTriangles)
      (a : Tâ‚.objâ‚ âŸ¶ Tâ‚‚.objâ‚) (b : Tâ‚.objâ‚‚ âŸ¶ Tâ‚‚.objâ‚‚) (_ : Tâ‚.morâ‚ â‰« b = a â‰« Tâ‚‚.morâ‚),
      âˆƒ c : Tâ‚.objâ‚ƒ âŸ¶ Tâ‚‚.objâ‚ƒ, Tâ‚.morâ‚‚ â‰« c = b â‰« Tâ‚‚.morâ‚‚ âˆ§ Tâ‚.morâ‚ƒ â‰« aâŸ¦1âŸ§' = c â‰« Tâ‚‚.morâ‚ƒ
",
141,05QK,"class IsTriangulated : Prop where
  /-- the octahedron axiom (TR 4) -/
  octahedron_axiom :
    âˆ€ {Xâ‚ Xâ‚‚ Xâ‚ƒ Zâ‚â‚‚ Zâ‚‚â‚ƒ Zâ‚â‚ƒ : C}
      {uâ‚â‚‚ : Xâ‚ âŸ¶ Xâ‚‚} {uâ‚‚â‚ƒ : Xâ‚‚ âŸ¶ Xâ‚ƒ} {uâ‚â‚ƒ : Xâ‚ âŸ¶ Xâ‚ƒ} (comm : uâ‚â‚‚ â‰« uâ‚‚â‚ƒ = uâ‚â‚ƒ)
      {vâ‚â‚‚ : Xâ‚‚ âŸ¶ Zâ‚â‚‚} {wâ‚â‚‚ : Zâ‚â‚‚ âŸ¶ Xâ‚âŸ¦(1 : â„¤)âŸ§} (hâ‚â‚‚ : Triangle.mk uâ‚â‚‚ vâ‚â‚‚ wâ‚â‚‚ âˆˆ distTriang C)
      {vâ‚‚â‚ƒ : Xâ‚ƒ âŸ¶ Zâ‚‚â‚ƒ} {wâ‚‚â‚ƒ : Zâ‚‚â‚ƒ âŸ¶ Xâ‚‚âŸ¦(1 : â„¤)âŸ§} (hâ‚‚â‚ƒ : Triangle.mk uâ‚‚â‚ƒ vâ‚‚â‚ƒ wâ‚‚â‚ƒ âˆˆ distTriang C)
      {vâ‚â‚ƒ : Xâ‚ƒ âŸ¶ Zâ‚â‚ƒ} {wâ‚â‚ƒ : Zâ‚â‚ƒ âŸ¶ Xâ‚âŸ¦(1 : â„¤)âŸ§} (hâ‚â‚ƒ : Triangle.mk uâ‚â‚ƒ vâ‚â‚ƒ wâ‚â‚ƒ âˆˆ distTriang C),
      Nonempty (Octahedron comm hâ‚â‚‚ hâ‚‚â‚ƒ hâ‚â‚ƒ)
",Formal Proof of Stacks Project Tag 05QK,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Triangulated/Triangulated.lean#L168-L176,Q27041,The definition of a triangulated category,13.3,section,2.0,"['05QI', '0ELQ']","13.3 The definition of a triangulated category\n\n\nIn this section we collect most of the definitions concerning triangulated and pre-triangulated categories. \n\n\n\n  Definition 13.3.1. Let $\\mathcal{D}$ be an additive category. Let $[1] : \\mathcal{D} \\to \\mathcal{D}$, $E \\mapsto E[1]$ be an additive functor which is an auto-equivalence of $\\mathcal{D}$. \n  \n  \nA triangle is a sextuple $(X, Y, Z, f, g, h)$ where $X, Y, Z \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{D})$ and $f : X \\to Y$, $g : Y \\to Z$ and $h : Z \\to X[1]$ are morphisms of $\\mathcal{D}$. \n\n\nA morphism of triangles $(X, Y, Z, f, g, h) \\to (X\', Y\', Z\', f\', g\', h\')$ is given by morphisms $a : X \\to X\'$, $b : Y \\to Y\'$ and $c : Z \\to Z\'$ of $\\mathcal{D}$ such that $b \\circ f = f\' \\circ a$, $c \\circ g = g\' \\circ b$ and $a[1] \\circ h = h\' \\circ c$. \n\n\n\n \n\n\nA morphism of triangles is visualized by the following commutative diagram \n\n\n  \\[  \\xymatrix{ X \\ar[r] \\ar[d]^ a &  Y \\ar[r] \\ar[d]^ b &  Z \\ar[r] \\ar[d]^ c &  X[1] \\ar[d]^{a[1]} \\\\  X\' \\ar[r] &  Y\' \\ar[r] &  Z\' \\ar[r] &  X\'[1] }  \\]\n\n\n In the setting of Definition 13.3.1, we write $[0] = \\text{id}$, for $n > 0$ we denote $[n]$ the $n$-fold composition of $[1]$, we choose a quasi-inverse $[-1]$ of $[1]$, and we set $[-n]$ equal to the $n$-fold composition of $[-1]$. Then $\\{ [n]\\} _{n \\in \\mathbf{Z}}$ is a collection of additive auto-equivalences of $\\mathcal{D}$ indexed by $n \\in \\mathbf{Z}$ such that we are given isomorphisms of functors $[n] \\circ [m] \\cong [n + m]$. \n\n\nHere is the definition of a triangulated category as given in Verdier\'s thesis. \n\n\n\n  Definition 13.3.2. A triangulated category consists of a triple $(\\mathcal{D}, \\{ [n]\\} _{n\\in \\mathbf{Z}}, \\mathcal{T})$ where \n  \n  \n$\\mathcal{D}$ is an additive category, \n\n\n$[1] : \\mathcal{D} \\to \\mathcal{D}$, $E \\mapsto E[1]$ is an additive auto-equivalence and $[n]$ for $n \\in \\mathbf{Z}$ is as discussed above, and \n\n\n$\\mathcal{T}$ is a set of triangles (Definition 13.3.1) called the distinguished triangles \n\n\n\n   subject to the following conditions \n  \n  \nAny triangle isomorphic to a distinguished triangle is a distinguished triangle. Any triangle of the form $(X, X, 0, \\text{id}, 0, 0)$ is distinguished. For any morphism $f : X \\to Y$ of $\\mathcal{D}$ there exists a distinguished triangle of the form $(X, Y, Z, f, g, h)$. \n\n\nThe triangle $(X, Y, Z, f, g, h)$ is distinguished if and only if the triangle $(Y, Z, X[1], g, h, -f[1])$ is. \n\n\nGiven a solid diagram \n\n\n  \\[  \\xymatrix{ X \\ar[r]^ f \\ar[d]^ a &  Y \\ar[r]^ g \\ar[d]^ b &  Z \\ar[r]^ h \\ar@{-->}[d] &  X[1] \\ar[d]^{a[1]} \\\\  X\' \\ar[r]^{f\'} &  Y\' \\ar[r]^{g\'} &  Z\' \\ar[r]^{h\'} &  X\'[1] }  \\]\n\n\n whose rows are distinguished triangles and which satisfies $b \\circ f = f\' \\circ a$, there exists a morphism $c : Z \\to Z\'$ such that $(a, b, c)$ is a morphism of triangles. \n\n\nGiven objects $X$, $Y$, $Z$ of $\\mathcal{D}$, and morphisms $f : X \\to Y$, $g : Y \\to Z$, and distinguished triangles $(X, Y, Q_1, f, p_1, d_1)$, $(X, Z, Q_2, g \\circ f, p_2, d_2)$, and $(Y, Z, Q_3, g, p_3, d_3)$, there exist morphisms $a : Q_1 \\to Q_2$ and $b : Q_2 \\to Q_3$ such that \n\n\n  \n$(Q_1, Q_2, Q_3, a, b, p_1[1] \\circ d_3)$ is a distinguished triangle, \n\n\nthe triple $(\\text{id}_ X, g, a)$ is a morphism of triangles $(X, Y, Q_1, f, p_1, d_1) \\to (X, Z, Q_2, g \\circ f, p_2, d_2)$, and \n\n\nthe triple $(f, \\text{id}_ Z, b)$ is a morphism of triangles $(X, Z, Q_2, g \\circ f, p_2, d_2) \\to (Y, Z, Q_3, g, p_3, d_3)$. \n\n\n\n\n\n   We will call $(\\mathcal{D}, [\\  ], \\mathcal{T})$ a pre-triangulated category if TR1, TR2 and TR3 hold.1 \n \n\n\nThe explanation of TR4 is that if you think of $Q_1$ as $Y/X$, $Q_2$ as $Z/X$ and $Q_3$ as $Z/Y$, then TR4(a) expresses the isomorphism $(Z/X)/(Y/X) \\cong Z/Y$ and TR4(b) and TR4(c) express that we can compare the triangles $X \\to Y \\to Q_1 \\to X[1]$ etc with morphisms of triangles. For a more precise reformulation of this idea see the proof of Lemma 13.10.2. \n\n\nThe sign in TR2 means that if $(X, Y, Z, f, g, h)$ is a distinguished triangle then in the long sequence \n\n\n    13.3.2.1\n  \\begin{equation}  \\label{derived-equation-rotate} \\ldots \\to Z[-1] \\xrightarrow {-h[-1]} X \\xrightarrow {f} Y \\xrightarrow {g} Z \\xrightarrow {h} X[1] \\xrightarrow {-f[1]} Y[1] \\xrightarrow {-g[1]} Z[1] \\to \\ldots \\end{equation}\n\n\n each four term sequence gives a distinguished triangle. \n\n\nAs usual we abuse notation and we simply speak of a (pre-)triangulated category $\\mathcal{D}$ without explicitly introducing notation for the additional data. The notion of a pre-triangulated category is useful in finding statements equivalent to TR4. \n\n\nWe have the following definition of a triangulated functor. \n\n\n\n  Definition 13.3.3. Let $\\mathcal{D}$, $\\mathcal{D}\'$ be pre-triangulated categories. An exact functor, or a triangulated functor from $\\mathcal{D}$ to $\\mathcal{D}\'$ is a functor $F : \\mathcal{D} \\to \\mathcal{D}\'$ together with given functorial isomorphisms $\\xi _ X : F(X[1]) \\to F(X)[1]$ such that for every distinguished triangle $(X, Y, Z, f, g, h)$ of $\\mathcal{D}$ the triangle $(F(X), F(Y), F(Z), F(f), F(g), \\xi _ X \\circ F(h))$ is a distinguished triangle of $\\mathcal{D}\'$. \n \n\n\nAn exact functor is additive, see Lemma 13.4.17. When we say two triangulated categories are equivalent we mean that they are equivalent in the $2$-category of triangulated categories. A $2$-morphism $a : (F, \\xi ) \\to (F\', \\xi \')$ in this $2$-category is simply a transformation of functors $a : F \\to F\'$ which is compatible with $\\xi $ and $\\xi \'$, i.e., \n\n\n  \\[  \\xymatrix{ F \\circ [1] \\ar[r]_\\xi \\ar[d]_{a \\star 1} &  [1] \\circ F \\ar[d]^{1 \\star a} \\\\  F\' \\circ [1] \\ar[r]^{\\xi \'} &  [1] \\circ F\' }  \\]\n\n\n commutes. \n\n\n\n  Definition 13.3.4. Let $(\\mathcal{D}, [\\  ], \\mathcal{T})$ be a pre-triangulated category. A pre-triangulated subcategory2 is a pair $(\\mathcal{D}\', \\mathcal{T}\')$ such that \n  \n  \n$\\mathcal{D}\'$ is an additive subcategory of $\\mathcal{D}$ which is preserved under $[1]$ and such that $[1] : \\mathcal{D}\' \\to \\mathcal{D}\'$ is an auto-equivalence, \n\n\n$\\mathcal{T}\' \\subset \\mathcal{T}$ is a subset such that for every $(X, Y, Z, f, g, h) \\in \\mathcal{T}\'$ we have $X, Y, Z \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{D}\')$ and $f, g, h \\in \\text{Arrows}(\\mathcal{D}\')$, and \n\n\n$(\\mathcal{D}\', [\\  ], \\mathcal{T}\')$ is a pre-triangulated category. \n\n\n\n   If $\\mathcal{D}$ is a triangulated category, then we say $(\\mathcal{D}\', \\mathcal{T}\')$ is a triangulated subcategory if it is a pre-triangulated subcategory and $(\\mathcal{D}\', [\\  ], \\mathcal{T}\')$ is a triangulated category. \n \n\n\nIn this situation the inclusion functor $\\mathcal{D}\' \\to \\mathcal{D}$ is an exact functor with $\\xi _ X : X[1] \\to X[1]$ given by the identity on $X[1]$. \n\n\nWe will see in Lemma 13.4.1 that for a distinguished triangle $(X, Y, Z, f, g, h)$ in a pre-triangulated category the composition $g \\circ f : X \\to Z$ is zero. Thus the sequence (13.3.2.1) is a complex. A homological functor is one that turns this complex into a long exact sequence. \n\n\n\n  Definition 13.3.5. Let $\\mathcal{D}$ be a pre-triangulated category. Let $\\mathcal{A}$ be an abelian category. An additive functor $H : \\mathcal{D} \\to \\mathcal{A}$ is called homological if for every distinguished triangle $(X, Y, Z, f, g, h)$ the sequence \n  \n  \\[  H(X) \\to H(Y) \\to H(Z)  \\]\n\n   is exact in the abelian category $\\mathcal{A}$. An additive functor $H : \\mathcal{D}^{opp} \\to \\mathcal{A}$ is called cohomological if the corresponding functor $\\mathcal{D} \\to \\mathcal{A}^{opp}$ is homological. \n \n\n\nIf $H : \\mathcal{D} \\to \\mathcal{A}$ is a homological functor we often write $H^ n(X) = H(X[n])$ so that $H(X) = H^0(X)$. Our discussion of TR2 above implies that a distinguished triangle $(X, Y, Z, f, g, h)$ determines a long exact sequence \n\n\n    13.3.5.1\n  \\begin{equation}  \\label{derived-equation-long-exact-cohomology-sequence} \\xymatrix@C=3pc{ H^{-1}(Z) \\ar[r]^{H(h[-1])} &  H^0(X) \\ar[r]^{H(f)} &  H^0(Y) \\ar[r]^{H(g)} &  H^0(Z) \\ar[r]^{H(h)} &  H^1(X) } \\end{equation}\n\n\n This will be called the long exact sequence associated to the distinguished triangle and the homological functor. As indicated we will not use any signs for the morphisms in the long exact sequence. This has the side effect that maps in the long exact sequence associated to the rotation (TR2) of a distinguished triangle differ from the maps in the sequence above by some signs. \n\n\n\n  Definition 13.3.6. Let $\\mathcal{A}$ be an abelian category. Let $\\mathcal{D}$ be a triangulated category. A $\\delta $-functor from $\\mathcal{A}$ to $\\mathcal{D}$ is given by a functor $G : \\mathcal{A} \\to \\mathcal{D}$ and a rule which assigns to every short exact sequence \n  \n  \\[  0 \\to A \\xrightarrow {a} B \\xrightarrow {b} C \\to 0  \\]\n\n   a morphism $\\delta = \\delta _{A \\to B \\to C} : G(C) \\to G(A)[1]$ such that \n  \n  \nthe triangle $(G(A), G(B), G(C), G(a), G(b), \\delta _{A \\to B \\to C})$ is a distinguished triangle of $\\mathcal{D}$ for any short exact sequence as above, and \n\n\nfor every morphism $(A \\to B \\to C) \\to (A\' \\to B\' \\to C\')$ of short exact sequences the diagram \n\n\n  \\[  \\xymatrix{ G(C) \\ar[d] \\ar[rr]_{\\delta _{A \\to B \\to C}} &  &  G(A)[1] \\ar[d] \\\\  G(C\') \\ar[rr]^{\\delta _{A\' \\to B\' \\to C\'}} &  &  G(A\')[1] }  \\]\n\n\n is commutative. \n\n\n\n   In this situation we call $(G(A), G(B), G(C), G(a), G(b), \\delta _{A \\to B \\to C})$ the image of the short exact sequence under the given $\\delta $-functor. \n \n\n\nNote how a $\\delta $-functor comes equipped with additional structure. Strictly speaking it does not make sense to say that a given functor $\\mathcal{A} \\to \\mathcal{D}$ is a $\\delta $-functor, but we will often do so anyway. \n\n","13.3 The definition of a triangulated category\n\n\nIn this section we collect most of the definitions concerning triangulated and pre-triangulated categories. \n\n\n\n  Definition 13.3.1. Let $\\mathcal{D}$ be an additive category. Let $[1] : \\mathcal{D} \\to \\mathcal{D}$, $E \\mapsto E[1]$ be an additive functor which is an auto-equivalence of $\\mathcal{D}$. \n  \n  \nA triangle is a sextuple $(X, Y, Z, f, g, h)$ where $X, Y, Z \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{D})$ and $f : X \\to Y$, $g : Y \\to Z$ and $h : Z \\to X[1]$ are morphisms of $\\mathcal{D}$. \n\n\nA morphism of triangles $(X, Y, Z, f, g, h) \\to (X\', Y\', Z\', f\', g\', h\')$ is given by morphisms $a : X \\to X\'$, $b : Y \\to Y\'$ and $c : Z \\to Z\'$ of $\\mathcal{D}$ such that $b \\circ f = f\' \\circ a$, $c \\circ g = g\' \\circ b$ and $a[1] \\circ h = h\' \\circ c$. \n\n\n\n \n\n\nA morphism of triangles is visualized by the following commutative diagram \n\n\n  \\[  \\xymatrix{ X \\ar[r] \\ar[d]^ a &  Y \\ar[r] \\ar[d]^ b &  Z \\ar[r] \\ar[d]^ c &  X[1] \\ar[d]^{a[1]} \\\\  X\' \\ar[r] &  Y\' \\ar[r] &  Z\' \\ar[r] &  X\'[1] }  \\]\n\n\n In the setting of Definition 13.3.1, we write $[0] = \\text{id}$, for $n > 0$ we denote $[n]$ the $n$-fold composition of $[1]$, we choose a quasi-inverse $[-1]$ of $[1]$, and we set $[-n]$ equal to the $n$-fold composition of $[-1]$. Then $\\{ [n]\\} _{n \\in \\mathbf{Z}}$ is a collection of additive auto-equivalences of $\\mathcal{D}$ indexed by $n \\in \\mathbf{Z}$ such that we are given isomorphisms of functors $[n] \\circ [m] \\cong [n + m]$. \n\n\nHere is the definition of a triangulated category as given in Verdier\'s thesis. \n\n\n\n  Definition 13.3.2. A triangulated category consists of a triple $(\\mathcal{D}, \\{ [n]\\} _{n\\in \\mathbf{Z}}, \\mathcal{T})$ where \n  \n  \n$\\mathcal{D}$ is an additive category, \n\n\n$[1] : \\mathcal{D} \\to \\mathcal{D}$, $E \\mapsto E[1]$ is an additive auto-equivalence and $[n]$ for $n \\in \\mathbf{Z}$ is as discussed above, and \n\n\n$\\mathcal{T}$ is a set of triangles (Definition 13.3.1) called the distinguished triangles \n\n\n\n   subject to the following conditions \n  \n  \nAny triangle isomorphic to a distinguished triangle is a distinguished triangle. Any triangle of the form $(X, X, 0, \\text{id}, 0, 0)$ is distinguished. For any morphism $f : X \\to Y$ of $\\mathcal{D}$ there exists a distinguished triangle of the form $(X, Y, Z, f, g, h)$. \n\n\nThe triangle $(X, Y, Z, f, g, h)$ is distinguished if and only if the triangle $(Y, Z, X[1], g, h, -f[1])$ is. \n\n\nGiven a solid diagram \n\n\n  \\[  \\xymatrix{ X \\ar[r]^ f \\ar[d]^ a &  Y \\ar[r]^ g \\ar[d]^ b &  Z \\ar[r]^ h \\ar@{-->}[d] &  X[1] \\ar[d]^{a[1]} \\\\  X\' \\ar[r]^{f\'} &  Y\' \\ar[r]^{g\'} &  Z\' \\ar[r]^{h\'} &  X\'[1] }  \\]\n\n\n whose rows are distinguished triangles and which satisfies $b \\circ f = f\' \\circ a$, there exists a morphism $c : Z \\to Z\'$ such that $(a, b, c)$ is a morphism of triangles. \n\n\nGiven objects $X$, $Y$, $Z$ of $\\mathcal{D}$, and morphisms $f : X \\to Y$, $g : Y \\to Z$, and distinguished triangles $(X, Y, Q_1, f, p_1, d_1)$, $(X, Z, Q_2, g \\circ f, p_2, d_2)$, and $(Y, Z, Q_3, g, p_3, d_3)$, there exist morphisms $a : Q_1 \\to Q_2$ and $b : Q_2 \\to Q_3$ such that \n\n\n  \n$(Q_1, Q_2, Q_3, a, b, p_1[1] \\circ d_3)$ is a distinguished triangle, \n\n\nthe triple $(\\text{id}_ X, g, a)$ is a morphism of triangles $(X, Y, Q_1, f, p_1, d_1) \\to (X, Z, Q_2, g \\circ f, p_2, d_2)$, and \n\n\nthe triple $(f, \\text{id}_ Z, b)$ is a morphism of triangles $(X, Z, Q_2, g \\circ f, p_2, d_2) \\to (Y, Z, Q_3, g, p_3, d_3)$. \n\n\n\n\n\n   We will call $(\\mathcal{D}, [\\  ], \\mathcal{T})$ a pre-triangulated category if TR1, TR2 and TR3 hold.1 \n \n\n\nThe explanation of TR4 is that if you think of $Q_1$ as $Y/X$, $Q_2$ as $Z/X$ and $Q_3$ as $Z/Y$, then TR4(a) expresses the isomorphism $(Z/X)/(Y/X) \\cong Z/Y$ and TR4(b) and TR4(c) express that we can compare the triangles $X \\to Y \\to Q_1 \\to X[1]$ etc with morphisms of triangles. For a more precise reformulation of this idea see the proof of Lemma 13.10.2. \n\n\nThe sign in TR2 means that if $(X, Y, Z, f, g, h)$ is a distinguished triangle then in the long sequence \n\n\n    13.3.2.1\n  \\begin{equation}  \\label{derived-equation-rotate} \\ldots \\to Z[-1] \\xrightarrow {-h[-1]} X \\xrightarrow {f} Y \\xrightarrow {g} Z \\xrightarrow {h} X[1] \\xrightarrow {-f[1]} Y[1] \\xrightarrow {-g[1]} Z[1] \\to \\ldots \\end{equation}\n\n\n each four term sequence gives a distinguished triangle. \n\n\nAs usual we abuse notation and we simply speak of a (pre-)triangulated category $\\mathcal{D}$ without explicitly introducing notation for the additional data. The notion of a pre-triangulated category is useful in finding statements equivalent to TR4. \n\n\nWe have the following definition of a triangulated functor. \n\n\n\n  Definition 13.3.3. Let $\\mathcal{D}$, $\\mathcal{D}\'$ be pre-triangulated categories. An exact functor, or a triangulated functor from $\\mathcal{D}$ to $\\mathcal{D}\'$ is a functor $F : \\mathcal{D} \\to \\mathcal{D}\'$ together with given functorial isomorphisms $\\xi _ X : F(X[1]) \\to F(X)[1]$ such that for every distinguished triangle $(X, Y, Z, f, g, h)$ of $\\mathcal{D}$ the triangle $(F(X), F(Y), F(Z), F(f), F(g), \\xi _ X \\circ F(h))$ is a distinguished triangle of $\\mathcal{D}\'$. \n \n\n\nAn exact functor is additive, see Lemma 13.4.17. When we say two triangulated categories are equivalent we mean that they are equivalent in the $2$-category of triangulated categories. A $2$-morphism $a : (F, \\xi ) \\to (F\', \\xi \')$ in this $2$-category is simply a transformation of functors $a : F \\to F\'$ which is compatible with $\\xi $ and $\\xi \'$, i.e., \n\n\n  \\[  \\xymatrix{ F \\circ [1] \\ar[r]_\\xi \\ar[d]_{a \\star 1} &  [1] \\circ F \\ar[d]^{1 \\star a} \\\\  F\' \\circ [1] \\ar[r]^{\\xi \'} &  [1] \\circ F\' }  \\]\n\n\n commutes. \n\n\n\n  Definition 13.3.4. Let $(\\mathcal{D}, [\\  ], \\mathcal{T})$ be a pre-triangulated category. A pre-triangulated subcategory2 is a pair $(\\mathcal{D}\', \\mathcal{T}\')$ such that \n  \n  \n$\\mathcal{D}\'$ is an additive subcategory of $\\mathcal{D}$ which is preserved under $[1]$ and such that $[1] : \\mathcal{D}\' \\to \\mathcal{D}\'$ is an auto-equivalence, \n\n\n$\\mathcal{T}\' \\subset \\mathcal{T}$ is a subset such that for every $(X, Y, Z, f, g, h) \\in \\mathcal{T}\'$ we have $X, Y, Z \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{D}\')$ and $f, g, h \\in \\text{Arrows}(\\mathcal{D}\')$, and \n\n\n$(\\mathcal{D}\', [\\  ], \\mathcal{T}\')$ is a pre-triangulated category. \n\n\n\n   If $\\mathcal{D}$ is a triangulated category, then we say $(\\mathcal{D}\', \\mathcal{T}\')$ is a triangulated subcategory if it is a pre-triangulated subcategory and $(\\mathcal{D}\', [\\  ], \\mathcal{T}\')$ is a triangulated category. \n \n\n\nIn this situation the inclusion functor $\\mathcal{D}\' \\to \\mathcal{D}$ is an exact functor with $\\xi _ X : X[1] \\to X[1]$ given by the identity on $X[1]$. \n\n\nWe will see in Lemma 13.4.1 that for a distinguished triangle $(X, Y, Z, f, g, h)$ in a pre-triangulated category the composition $g \\circ f : X \\to Z$ is zero. Thus the sequence (13.3.2.1) is a complex. A homological functor is one that turns this complex into a long exact sequence. \n\n\n\n  Definition 13.3.5. Let $\\mathcal{D}$ be a pre-triangulated category. Let $\\mathcal{A}$ be an abelian category. An additive functor $H : \\mathcal{D} \\to \\mathcal{A}$ is called homological if for every distinguished triangle $(X, Y, Z, f, g, h)$ the sequence \n  \n  \\[  H(X) \\to H(Y) \\to H(Z)  \\]\n\n   is exact in the abelian category $\\mathcal{A}$. An additive functor $H : \\mathcal{D}^{opp} \\to \\mathcal{A}$ is called cohomological if the corresponding functor $\\mathcal{D} \\to \\mathcal{A}^{opp}$ is homological. \n \n\n\nIf $H : \\mathcal{D} \\to \\mathcal{A}$ is a homological functor we often write $H^ n(X) = H(X[n])$ so that $H(X) = H^0(X)$. Our discussion of TR2 above implies that a distinguished triangle $(X, Y, Z, f, g, h)$ determines a long exact sequence \n\n\n    13.3.5.1\n  \\begin{equation}  \\label{derived-equation-long-exact-cohomology-sequence} \\xymatrix@C=3pc{ H^{-1}(Z) \\ar[r]^{H(h[-1])} &  H^0(X) \\ar[r]^{H(f)} &  H^0(Y) \\ar[r]^{H(g)} &  H^0(Z) \\ar[r]^{H(h)} &  H^1(X) } \\end{equation}\n\n\n This will be called the long exact sequence associated to the distinguished triangle and the homological functor. As indicated we will not use any signs for the morphisms in the long exact sequence. This has the side effect that maps in the long exact sequence associated to the rotation (TR2) of a distinguished triangle differ from the maps in the sequence above by some signs. \n\n\n\n  Definition 13.3.6. Let $\\mathcal{A}$ be an abelian category. Let $\\mathcal{D}$ be a triangulated category. A $\\delta $-functor from $\\mathcal{A}$ to $\\mathcal{D}$ is given by a functor $G : \\mathcal{A} \\to \\mathcal{D}$ and a rule which assigns to every short exact sequence \n  \n  \\[  0 \\to A \\xrightarrow {a} B \\xrightarrow {b} C \\to 0  \\]\n\n   a morphism $\\delta = \\delta _{A \\to B \\to C} : G(C) \\to G(A)[1]$ such that \n  \n  \nthe triangle $(G(A), G(B), G(C), G(a), G(b), \\delta _{A \\to B \\to C})$ is a distinguished triangle of $\\mathcal{D}$ for any short exact sequence as above, and \n\n\nfor every morphism $(A \\to B \\to C) \\to (A\' \\to B\' \\to C\')$ of short exact sequences the diagram \n\n\n  \\[  \\xymatrix{ G(C) \\ar[d] \\ar[rr]_{\\delta _{A \\to B \\to C}} &  &  G(A)[1] \\ar[d] \\\\  G(C\') \\ar[rr]^{\\delta _{A\' \\to B\' \\to C\'}} &  &  G(A\')[1] }  \\]\n\n\n is commutative. \n\n\n\n   In this situation we call $(G(A), G(B), G(C), G(a), G(b), \\delta _{A \\to B \\to C})$ the image of the short exact sequence under the given $\\delta $-functor. \n \n\n\nNote how a $\\delta $-functor comes equipped with additional structure. Strictly speaking it does not make sense to say that a given functor $\\mathcal{A} \\to \\mathcal{D}$ is a $\\delta $-functor, but we will often do so anyway. \n\n",,,"class IsTriangulated : Prop where
  /-- the octahedron axiom (TR 4) -/
  octahedron_axiom :
    âˆ€ {Xâ‚ Xâ‚‚ Xâ‚ƒ Zâ‚â‚‚ Zâ‚‚â‚ƒ Zâ‚â‚ƒ : C}
      {uâ‚â‚‚ : Xâ‚ âŸ¶ Xâ‚‚} {uâ‚‚â‚ƒ : Xâ‚‚ âŸ¶ Xâ‚ƒ} {uâ‚â‚ƒ : Xâ‚ âŸ¶ Xâ‚ƒ} (comm : uâ‚â‚‚ â‰« uâ‚‚â‚ƒ = uâ‚â‚ƒ)
      {vâ‚â‚‚ : Xâ‚‚ âŸ¶ Zâ‚â‚‚} {wâ‚â‚‚ : Zâ‚â‚‚ âŸ¶ Xâ‚âŸ¦(1 : â„¤)âŸ§} (hâ‚â‚‚ : Triangle.mk uâ‚â‚‚ vâ‚â‚‚ wâ‚â‚‚ âˆˆ distTriang C)
      {vâ‚‚â‚ƒ : Xâ‚ƒ âŸ¶ Zâ‚‚â‚ƒ} {wâ‚‚â‚ƒ : Zâ‚‚â‚ƒ âŸ¶ Xâ‚‚âŸ¦(1 : â„¤)âŸ§} (hâ‚‚â‚ƒ : Triangle.mk uâ‚‚â‚ƒ vâ‚‚â‚ƒ wâ‚‚â‚ƒ âˆˆ distTriang C)
      {vâ‚â‚ƒ : Xâ‚ƒ âŸ¶ Zâ‚â‚ƒ} {wâ‚â‚ƒ : Zâ‚â‚ƒ âŸ¶ Xâ‚âŸ¦(1 : â„¤)âŸ§} (hâ‚â‚ƒ : Triangle.mk uâ‚â‚ƒ vâ‚â‚ƒ wâ‚â‚ƒ âˆˆ distTriang C),
      Nonempty (Octahedron comm hâ‚â‚‚ hâ‚‚â‚ƒ hâ‚â‚ƒ)
",
142,003C,"theorem epi_iff_surjective {X Y : Type u} (f : X âŸ¶ Y) : Epi f â†” Function.Surjective f := by
  constructor
  Â· rintro âŸ¨HâŸ©
    refine Function.surjective_of_right_cancellable_Prop fun gâ‚ gâ‚‚ hg => ?_
    rw [â† Equiv.ulift.symm.injective.comp_left.eq_iff]
    apply H
    change ULift.up âˆ˜ gâ‚ âˆ˜ f = ULift.up âˆ˜ gâ‚‚ âˆ˜ f
    rw [hg]
  Â· exact fun H => âŸ¨fun g g' h => H.injective_comp_right hâŸ©
",Formal Proof of Stacks Project Tag 003C,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/CategoryTheory/Types/Basic.lean#L252-L260,Q27041,,4.13.2,example,3.0,"['003A', '0011', '0ELQ']",\n  Example 4.13.2. In the category of sets the monomorphisms correspond to injective maps and the epimorphisms correspond to surjective maps. \n,\n  Example 4.13.2. In the category of sets the monomorphisms correspond to injective maps and the epimorphisms correspond to surjective maps. \n,," by
  constructor
  Â· rintro âŸ¨HâŸ©
    refine Function.surjective_of_right_cancellable_Prop fun gâ‚ gâ‚‚ hg => ?_
    rw [â† Equiv.ulift.symm.injective.comp_left.eq_iff]
    apply H
    change ULift.up âˆ˜ gâ‚ âˆ˜ f = ULift.up âˆ˜ gâ‚‚ âˆ˜ f
    rw [hg]
  Â· exact fun H => âŸ¨fun g g' h => H.injective_comp_right hâŸ©
",theorem epi_iff_surjective {X Y : Type u} (f : X âŸ¶ Y) : Epi f â†” Function.Surjective f ,
143,09FR,"lemma cast_injective : Injective ((â†‘) : â„š â†’ Î±)
  | âŸ¨nâ‚, dâ‚, dâ‚0, câ‚âŸ©, âŸ¨nâ‚‚, dâ‚‚, dâ‚‚0, câ‚‚âŸ©, h => by
    have dâ‚a : (dâ‚ : Î±) â‰  0 := Nat.cast_ne_zero.2 dâ‚0
    have dâ‚‚a : (dâ‚‚ : Î±) â‰  0 := Nat.cast_ne_zero.2 dâ‚‚0
    rw [mk_eq_divInt, mk_eq_divInt] at h âŠ¢
    rw [cast_divInt_of_ne_zero, cast_divInt_of_ne_zero] at h <;> simp [dâ‚0, dâ‚‚0] at h âŠ¢
    rwa [eq_div_iff_mul_eq dâ‚‚a, division_def, mul_assoc, (dâ‚.cast_commute (dâ‚‚ : Î±)).inv_leftâ‚€.eq, â†
      mul_assoc, â† division_def, eq_comm, eq_div_iff_mul_eq dâ‚a, eq_comm, â† Int.cast_natCast dâ‚, â†
      Int.cast_mul, â† Int.cast_natCast dâ‚‚, â† Int.cast_mul, Int.cast_inj, â† mkRat_eq_iff dâ‚0 dâ‚‚0]
      at h
",Formal Proof of Stacks Project Tag 09FR,Characteristic zero case.,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/Data/Rat/Cast/CharZero.lean#L27-L36,Q27041,,9.5.1,definition,3.0,"['09FQ', '09FA', '0ELQ']","\n  Definition 9.5.1. The characteristic of a field $F$ is $0$ if $\\mathbf{Z} \\subset F$, or is a prime $p$ if $p = 0$ in $F$. The prime subfield of $F$ is the smallest subfield of $F$ which is either $\\mathbf{Q} \\subset F$ if the characteristic is zero, or $\\mathbf{F}_ p \\subset F$ if the characteristic is $p > 0$. \n","\n  Definition 9.5.1. The characteristic of a field $F$ is $0$ if $\\mathbf{Z} \\subset F$, or is a prime $p$ if $p = 0$ in $F$. The prime subfield of $F$ is the smallest subfield of $F$ which is either $\\mathbf{Q} \\subset F$ if the characteristic is zero, or $\\mathbf{F}_ p \\subset F$ if the characteristic is $p > 0$. \n",," Nat.cast_ne_zero.2 dâ‚0
    have dâ‚‚a : (dâ‚‚ : Î±) â‰  0 := Nat.cast_ne_zero.2 dâ‚‚0
    rw [mk_eq_divInt, mk_eq_divInt] at h âŠ¢
    rw [cast_divInt_of_ne_zero, cast_divInt_of_ne_zero] at h <;> simp [dâ‚0, dâ‚‚0] at h âŠ¢
    rwa [eq_div_iff_mul_eq dâ‚‚a, division_def, mul_assoc, (dâ‚.cast_commute (dâ‚‚ : Î±)).inv_leftâ‚€.eq, â†
      mul_assoc, â† division_def, eq_comm, eq_div_iff_mul_eq dâ‚a, eq_comm, â† Int.cast_natCast dâ‚, â†
      Int.cast_mul, â† Int.cast_natCast dâ‚‚, â† Int.cast_mul, Int.cast_inj, â† mkRat_eq_iff dâ‚0 dâ‚‚0]
      at h
","lemma cast_injective : Injective ((â†‘) : â„š â†’ Î±)
  | âŸ¨nâ‚, dâ‚, dâ‚0, câ‚âŸ©, âŸ¨nâ‚‚, dâ‚‚, dâ‚‚0, câ‚‚âŸ©, h => by
    have dâ‚a : (dâ‚ : Î±) â‰  0 ",
144,09GI,"def algebraicClosure : IntermediateField F E :=
  Algebra.IsAlgebraic.toIntermediateField (integralClosure F E)
",Formal Proof of Stacks Project Tag 09GI,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/AlgebraicClosure.lean#L40-L41,Q27041,,9.8.7,lemma,3.0,"['09GB', '09FA', '0ELQ']","\n  Lemma 9.8.7. Let $E/k$ be a field extension. Then the elements of $E$ algebraic over $k$ form a subextension of $E/k$. \n\n    \n      Proof.\n      Let $\\alpha , \\beta \\in E$ be algebraic over $k$. Then $k(\\alpha , \\beta )/k$ is a finite extension by Lemma 9.8.6. It follows that $k(\\alpha + \\beta ) \\subset k(\\alpha , \\beta )$ is a finite extension, which implies that $\\alpha + \\beta $ is algebraic by Lemma 9.8.5. Similarly for the difference, product and quotient of $\\alpha $ and $\\beta $. \n      $\\square$\n    \n",\n  Lemma 9.8.7. Let $E/k$ be a field extension. Then the elements of $E$ algebraic over $k$ form a subextension of $E/k$. \n\n    \n,"Proof.\n      Let $\\alpha , \\beta \\in E$ be algebraic over $k$. Then $k(\\alpha , \\beta )/k$ is a finite extension by Lemma 9.8.6. It follows that $k(\\alpha + \\beta ) \\subset k(\\alpha , \\beta )$ is a finite extension, which implies that $\\alpha + \\beta $ is algebraic by Lemma 9.8.5. Similarly for the difference, product and quotient of $\\alpha $ and $\\beta $. \n      $\\square$\n    \n","
  Algebra.IsAlgebraic.toIntermediateField (integralClosure F E)
",def algebraicClosure : IntermediateField F E ,"Proof.\n      Let $\\alpha , \\beta \\in E$ be algebraic over $k$. Then $k(\\alpha , \\beta )/k$ is a finite extension by Lemma 9.8.6 [[\n       \n      \n  Lemma 9.8.6. Let $k$ be a field, and let $\\alpha _1, \\alpha _2, \\ldots , \\alpha _ n$ be elements of some extension field such that each $\\alpha _ i$ is algebraic over $k$. Then the extension $k(\\alpha _1, \\ldots , \\alpha _ n)/k$ is finite. That is, a finitely generated algebraic extension is finite. \n\n    \n]]. It follows that $k(\\alpha + \\beta ) \\subset k(\\alpha , \\beta )$ is a finite extension, which implies that $\\alpha + \\beta $ is algebraic by Lemma 9.8.5 [[\n  Lemma 9.8.5. A finite extension is algebraic. In fact, an extension $E/k$ is algebraic if and only if every subextension $k(\\alpha )/k$ generated by some $\\alpha \\in E$ is finite. \n\n    \n]]. Similarly for the difference, product and quotient of $\\alpha $ and $\\beta $. \n      $\\square$\n    \n"
145,09I3,"theorem finrank_eq_card [Fintype G] [FaithfulSMul G F] :
    finrank (FixedPoints.subfield G F) F = Fintype.card G :=
  le_antisymm (FixedPoints.finrank_le_card G F) <|
    calc
      Fintype.card G â‰¤ Fintype.card (F â†’â‚[FixedPoints.subfield G F] F) :=
        Fintype.card_le_of_injective _ (MulSemiringAction.toAlgHom_injective _ F)
      _ â‰¤ finrank F (F â†’â‚—[FixedPoints.subfield G F] F) := finrank_algHom (subfield G F) F
      _ = finrank (FixedPoints.subfield G F) F := finrank_linearMap_self _ _ _
",Formal Proof of Stacks Project Tag 09I3,second part,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/Fixed.lean#L326-L333,Q27041,,9.21.6,lemma,3.0,"['09DU', '09FA', '0ELQ']","\n  Lemma 9.21.6. Let $K$ be a field. Let $G$ be a finite group acting faithfully on $K$. Then the extension $K/K^ G$ is Galois, we have $[K : K^ G] = |G|$, and the Galois group of the extension is $G$. \n\n    \n      Proof.\n      Given $\\alpha \\in K$ consider the orbit $G \\cdot \\alpha \\subset K$ of $\\alpha $ under the group action. Consider the polynomial \n    \n      \n  \\[  P = \\prod \\nolimits _{\\beta \\in G \\cdot \\alpha } (x - \\beta ) \\in K[x]  \\]\n\n    \n       The key to the whole lemma is that this polynomial is invariant under the action of $G$ and hence has coefficients in $K^ G$. Namely, for $\\tau \\in G$ we have \n    \n      \n  \\[  P^\\tau = \\prod \\nolimits _{\\beta \\in G \\cdot \\alpha } (x - \\tau (\\beta )) = \\prod \\nolimits _{\\beta \\in G \\cdot \\alpha } (x - \\beta ) = P  \\]\n\n    \n       because the map $\\beta \\mapsto \\tau (\\beta )$ is a permutation of the orbit $G \\cdot \\alpha $. Thus $P \\in K^ G[x]$. Since also $P(\\alpha ) = 0$ as $\\alpha $ is an element of its orbit we conclude that the extension $K/K^ G$ is algebraic. Moreover, the minimal polynomial $Q$ of $\\alpha $ over $K^ G$ divides the polynomial $P$ just constructed. Hence $Q$ is separable (by Lemma 9.12.4 for example) and we conclude that $K/K^ G$ is separable. Thus $K/K^ G$ is Galois. To finish the proof it suffices to show that $[K : K^ G] = |G|$ since then $G$ will be the Galois group by Lemma 9.21.2. \n    \n      Pick finitely many elements $\\alpha _ i \\in K$, $i = 1, \\ldots , n$ such that $\\sigma (\\alpha _ i) = \\alpha _ i$ for $i = 1, \\ldots , n$ implies $\\sigma $ is the neutral element of $G$. Set \n    \n      \n  \\[  L = K^ G(\\{ \\sigma (\\alpha _ i); 1 \\leq i \\leq n, \\sigma \\in G\\} ) \\subset K  \\]\n\n    \n       and observe that the action of $G$ on $K$ induces an action of $G$ on $L$. We will show that $L$ has degree $|G|$ over $K^ G$. This will finish the proof, since if $L \\subset K$ is proper, then we can add an element $\\alpha \\in K$, $\\alpha \\not\\in L$ to our list of elements $\\alpha _1, \\ldots , \\alpha _ n$ without increasing $L$ which is absurd. This reduces us to the case that $K/K^ G$ is finite which is treated in the next paragraph. \n    \n      Assume $K/K^ G$ is finite. By Lemma 9.19.1 we can find $\\alpha \\in K$ such that $K = K^ G(\\alpha )$. By the construction in the first paragraph of this proof we see that $\\alpha $ has degree at most $|G|$ over $K$. However, the degree cannot be less than $|G|$ as $G$ acts faithfully on $K^ G(\\alpha ) = L$ by construction and the inequality of Lemma 9.15.9. \n      $\\square$\n    \n","\n  Lemma 9.21.6. Let $K$ be a field. Let $G$ be a finite group acting faithfully on $K$. Then the extension $K/K^ G$ is Galois, we have $[K : K^ G] = |G|$, and the Galois group of the extension is $G$. \n\n    \n","Proof.\n      Given $\\alpha \\in K$ consider the orbit $G \\cdot \\alpha \\subset K$ of $\\alpha $ under the group action. Consider the polynomial \n    \n      \n  \\[  P = \\prod \\nolimits _{\\beta \\in G \\cdot \\alpha } (x - \\beta ) \\in K[x]  \\]\n\n    \n       The key to the whole lemma is that this polynomial is invariant under the action of $G$ and hence has coefficients in $K^ G$. Namely, for $\\tau \\in G$ we have \n    \n      \n  \\[  P^\\tau = \\prod \\nolimits _{\\beta \\in G \\cdot \\alpha } (x - \\tau (\\beta )) = \\prod \\nolimits _{\\beta \\in G \\cdot \\alpha } (x - \\beta ) = P  \\]\n\n    \n       because the map $\\beta \\mapsto \\tau (\\beta )$ is a permutation of the orbit $G \\cdot \\alpha $. Thus $P \\in K^ G[x]$. Since also $P(\\alpha ) = 0$ as $\\alpha $ is an element of its orbit we conclude that the extension $K/K^ G$ is algebraic. Moreover, the minimal polynomial $Q$ of $\\alpha $ over $K^ G$ divides the polynomial $P$ just constructed. Hence $Q$ is separable (by Lemma 9.12.4 for example) and we conclude that $K/K^ G$ is separable. Thus $K/K^ G$ is Galois. To finish the proof it suffices to show that $[K : K^ G] = |G|$ since then $G$ will be the Galois group by Lemma 9.21.2. \n    \n      Pick finitely many elements $\\alpha _ i \\in K$, $i = 1, \\ldots , n$ such that $\\sigma (\\alpha _ i) = \\alpha _ i$ for $i = 1, \\ldots , n$ implies $\\sigma $ is the neutral element of $G$. Set \n    \n      \n  \\[  L = K^ G(\\{ \\sigma (\\alpha _ i); 1 \\leq i \\leq n, \\sigma \\in G\\} ) \\subset K  \\]\n\n    \n       and observe that the action of $G$ on $K$ induces an action of $G$ on $L$. We will show that $L$ has degree $|G|$ over $K^ G$. This will finish the proof, since if $L \\subset K$ is proper, then we can add an element $\\alpha \\in K$, $\\alpha \\not\\in L$ to our list of elements $\\alpha _1, \\ldots , \\alpha _ n$ without increasing $L$ which is absurd. This reduces us to the case that $K/K^ G$ is finite which is treated in the next paragraph. \n    \n      Assume $K/K^ G$ is finite. By Lemma 9.19.1 we can find $\\alpha \\in K$ such that $K = K^ G(\\alpha )$. By the construction in the first paragraph of this proof we see that $\\alpha $ has degree at most $|G|$ over $K$. However, the degree cannot be less than $|G|$ as $G$ acts faithfully on $K^ G(\\alpha ) = L$ by construction and the inequality of Lemma 9.15.9. \n      $\\square$\n    \n","
  le_antisymm (FixedPoints.finrank_le_card G F) <|
    calc
      Fintype.card G â‰¤ Fintype.card (F â†’â‚[FixedPoints.subfield G F] F) :=
        Fintype.card_le_of_injective _ (MulSemiringAction.toAlgHom_injective _ F)
      _ â‰¤ finrank F (F â†’â‚—[FixedPoints.subfield G F] F) := finrank_algHom (subfield G F) F
      _ = finrank (FixedPoints.subfield G F) F := finrank_linearMap_self _ _ _
","theorem finrank_eq_card [Fintype G] [FaithfulSMul G F] :
    finrank (FixedPoints.subfield G F) F = Fintype.card G ","Proof.\n      Given $\\alpha \\in K$ consider the orbit $G \\cdot \\alpha \\subset K$ of $\\alpha $ under the group action. Consider the polynomial \n    \n      \n  \\[  P = \\prod \\nolimits _{\\beta \\in G \\cdot \\alpha } (x - \\beta ) \\in K[x]  \\]\n\n    \n       The key to the whole lemma is that this polynomial is invariant under the action of $G$ and hence has coefficients in $K^ G$. Namely, for $\\tau \\in G$ we have \n    \n      \n  \\[  P^\\tau = \\prod \\nolimits _{\\beta \\in G \\cdot \\alpha } (x - \\tau (\\beta )) = \\prod \\nolimits _{\\beta \\in G \\cdot \\alpha } (x - \\beta ) = P  \\]\n\n    \n       because the map $\\beta \\mapsto \\tau (\\beta )$ is a permutation of the orbit $G \\cdot \\alpha $. Thus $P \\in K^ G[x]$. Since also $P(\\alpha ) = 0$ as $\\alpha $ is an element of its orbit we conclude that the extension $K/K^ G$ is algebraic. Moreover, the minimal polynomial $Q$ of $\\alpha $ over $K^ G$ divides the polynomial $P$ just constructed. Hence $Q$ is separable (by Lemma 9.12.4 [[\n  Lemma 9.12.4. Let $F$ be a field. An irreducible polynomial $P$ over $F$ is separable if and only if $P$ has pairwise distinct roots in an algebraic closure of $F$. \n\n    \n]] for example) and we conclude that $K/K^ G$ is separable. Thus $K/K^ G$ is Galois. To finish the proof it suffices to show that $[K : K^ G] = |G|$ since then $G$ will be the Galois group by Lemma 9.21.2 [[\n  Lemma 9.21.2. Let $E/F$ be a finite extension of fields. Then $E$ is Galois over $F$ if and only if $|\\text{Aut}(E/F)| = [E : F]$. \n\n    \n]]. \n    \n      Pick finitely many elements $\\alpha _ i \\in K$, $i = 1, \\ldots , n$ such that $\\sigma (\\alpha _ i) = \\alpha _ i$ for $i = 1, \\ldots , n$ implies $\\sigma $ is the neutral element of $G$. Set \n    \n      \n  \\[  L = K^ G(\\{ \\sigma (\\alpha _ i); 1 \\leq i \\leq n, \\sigma \\in G\\} ) \\subset K  \\]\n\n    \n       and observe that the action of $G$ on $K$ induces an action of $G$ on $L$. We will show that $L$ has degree $|G|$ over $K^ G$. This will finish the proof, since if $L \\subset K$ is proper, then we can add an element $\\alpha \\in K$, $\\alpha \\not\\in L$ to our list of elements $\\alpha _1, \\ldots , \\alpha _ n$ without increasing $L$ which is absurd. This reduces us to the case that $K/K^ G$ is finite which is treated in the next paragraph. \n    \n      Assume $K/K^ G$ is finite. By Lemma 9.19.1 [[\n  Lemma 9.19.1 (Primitive element).  Let $E/F$ be a finite extension of fields. The following are equivalent \n  \n  \nthere exists a primitive element for $E$ over $F$, and \n\n\nthere are finitely many subextensions $E/K/F$. \n\n\n\n   Moreover, (1) and (2) hold if $E/F$ is separable. \n\n    \n]] we can find $\\alpha \\in K$ such that $K = K^ G(\\alpha )$. By the construction in the first paragraph of this proof we see that $\\alpha $ has degree at most $|G|$ over $K$. However, the degree cannot be less than $|G|$ as $G$ acts faithfully on $K^ G(\\alpha ) = L$ by construction and the inequality of Lemma 9.15.9 [[\n  Lemma 9.15.9. Let $E/F$ be a finite extension. We have \n  \n  \\[  |\\text{Aut}(E/F)| \\leq [E : F]_ s  \\]\n\n   with equality if and only if $E$ is normal over $F$. \n\n    \n]]. \n      $\\square$\n    \n"
146,0BMJ,"instance (K L : Type*) [Field K] [Field L] [Algebra K L] : IsTopologicalGroup Gal(L/K) :=
  GroupFilterBasis.isTopologicalGroup (galGroupBasis K L)
",Formal Proof of Stacks Project Tag 0BMJ,We define Krull topology directly without proving the universal property,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/KrullTopology.lean#L139-L140,Q27041,,9.22.1,lemma,3.0,"['0BMI', '09FA', '0ELQ']","\n  Lemma 9.22.1. Let $E/F$ be a Galois extension. Endow $\\text{Gal}(E/F)$ with the coarsest topology such that \n  \n  \\[  \\text{Gal}(E/F) \\times E \\longrightarrow E  \\]\n\n   is continuous when $E$ is given the discrete topology. Then \n  \n  \nfor any topological space $X$ and map $X \\to \\text{Gal}(E/F)$ such that the action $X \\times E \\to E$ is continuous the induced map $X \\to \\text{Gal}(E/F)$ is continuous, \n\n\nthis topology turns $\\text{Gal}(E/F)$ into a profinite topological group. \n\n\n\n\n    \n      Proof.\n      Throughout this proof we think of $E$ as a discrete topological space. Recall that the compact open topology on the set of self maps $\\text{Map}(E, E)$ is the universal topology such that the action $\\text{Map}(E, E) \\times E \\to E$ is continuous. See Topology, Example 5.30.2 for a precise statement. The topology of the lemma on $\\text{Gal}(E/F)$ is the induced topology coming from the injective map $\\text{Gal}(E/F) \\to \\text{Map}(E, E)$. Hence the universal property (1) follows from the corresponding universal property of the compact open topology. Since the set of invertible self maps $\\text{Aut}(E)$ endowed with the compact open topology forms a topological group, see Topology, Example 5.30.2, and since $\\text{Gal}(E/F) = \\text{Aut}(E/F) \\to \\text{Map}(E, E)$ factors through $\\text{Aut}(E)$ we obtain a topological group. In other words, we are using the injection \n    \n      \n  \\[  \\text{Gal}(E/F) \\subset \\text{Aut}(E)  \\]\n\n    \n       to endow $\\text{Gal}(E/F)$ with the induced structure of a topological group (see Topology, Section 5.30) and by construction this is the coarsest structure of a topological group such that the action $\\text{Gal}(E/F) \\times E \\to E$ is continuous. \n    \n      To show that $\\text{Gal}(E/F)$ is profinite we argue as follows (our argument is necessarily nonstandard because we have defined the topology before showing that the Galois group is an inverse limit of finite groups). By Topology, Lemma 5.30.4 it suffices to show that the underlying topological space of $\\text{Gal}(E/F)$ is profinite. For any subset $S \\subset E$ consider the set \n    \n      \n  \\[  G(S) = \\{  f : S \\to E \\mid \\begin{matrix}  f(\\alpha )\\text{ is a root of the minimal polynomial}\n\n\\\\  \\text{of }\\alpha \\text{ over }F\\text{ for all }\\alpha \\in S \n\n\\end{matrix} \\}   \\]\n\n    \n       Since a polynomial has only a finite number of roots we see that $G(S)$ is finite for all $S \\subset E$ finite. If $S \\subset S\'$ then restriction gives a map $G(S\') \\to G(S)$. Also, observe that if $\\alpha \\in S \\cap F$ and $f \\in G(S)$, then $f(\\alpha ) = \\alpha $ because the minimal polynomial is linear in this case. Consider the profinite topological space \n    \n      \n  \\[  G = \\mathop{\\mathrm{lim}}\\nolimits _{S \\subset E\\text{ finite}} G(S)  \\]\n\n    \n       Consider the canonical map \n    \n      \n  \\[  c : \\text{Gal}(E/F) \\longrightarrow G,\\quad \\sigma \\longmapsto (\\sigma |_ S : S \\to E)_ S  \\]\n\n    \n       This is injective and unwinding the definitions the reader sees the topology on $\\text{Gal}(E/F)$ as defined above is the induced topology from $G$. An element $(f_ S) \\in G$ is in the image of $c$ exactly if (A) $f_ S(\\alpha ) + f_ S(\\beta ) = f_ S(\\alpha + \\beta )$ and (M) $f_ S(\\alpha )f_ S(\\beta ) = f_ S(\\alpha \\beta )$ whenever this makes sense (i.e., $\\alpha , \\beta , \\alpha + \\beta , \\alpha \\beta \\in S$). Namely, this means $\\mathop{\\mathrm{lim}}\\nolimits f_ S : E \\to E$ will be an $F$-algebra map and hence an automorphism by Lemma 9.8.11. The conditions (A) and (M) for a given triple $(S, \\alpha , \\beta )$ define a closed subset of $G$ and hence $\\text{Gal}(E/F)$ is homeomorphic to a closed subset of a profinite space and therefore profinite itself. \n      $\\square$\n    \n","\n  Lemma 9.22.1. Let $E/F$ be a Galois extension. Endow $\\text{Gal}(E/F)$ with the coarsest topology such that \n  \n  \\[  \\text{Gal}(E/F) \\times E \\longrightarrow E  \\]\n\n   is continuous when $E$ is given the discrete topology. Then \n  \n  \nfor any topological space $X$ and map $X \\to \\text{Gal}(E/F)$ such that the action $X \\times E \\to E$ is continuous the induced map $X \\to \\text{Gal}(E/F)$ is continuous, \n\n\nthis topology turns $\\text{Gal}(E/F)$ into a profinite topological group. \n\n\n\n\n    \n","Proof.\n      Throughout this proof we think of $E$ as a discrete topological space. Recall that the compact open topology on the set of self maps $\\text{Map}(E, E)$ is the universal topology such that the action $\\text{Map}(E, E) \\times E \\to E$ is continuous. See Topology, Example 5.30.2 for a precise statement. The topology of the lemma on $\\text{Gal}(E/F)$ is the induced topology coming from the injective map $\\text{Gal}(E/F) \\to \\text{Map}(E, E)$. Hence the universal property (1) follows from the corresponding universal property of the compact open topology. Since the set of invertible self maps $\\text{Aut}(E)$ endowed with the compact open topology forms a topological group, see Topology, Example 5.30.2, and since $\\text{Gal}(E/F) = \\text{Aut}(E/F) \\to \\text{Map}(E, E)$ factors through $\\text{Aut}(E)$ we obtain a topological group. In other words, we are using the injection \n    \n      \n  \\[  \\text{Gal}(E/F) \\subset \\text{Aut}(E)  \\]\n\n    \n       to endow $\\text{Gal}(E/F)$ with the induced structure of a topological group (see Topology, Section 5.30) and by construction this is the coarsest structure of a topological group such that the action $\\text{Gal}(E/F) \\times E \\to E$ is continuous. \n    \n      To show that $\\text{Gal}(E/F)$ is profinite we argue as follows (our argument is necessarily nonstandard because we have defined the topology before showing that the Galois group is an inverse limit of finite groups). By Topology, Lemma 5.30.4 it suffices to show that the underlying topological space of $\\text{Gal}(E/F)$ is profinite. For any subset $S \\subset E$ consider the set \n    \n      \n  \\[  G(S) = \\{  f : S \\to E \\mid \\begin{matrix}  f(\\alpha )\\text{ is a root of the minimal polynomial}\n\n\\\\  \\text{of }\\alpha \\text{ over }F\\text{ for all }\\alpha \\in S \n\n\\end{matrix} \\}   \\]\n\n    \n       Since a polynomial has only a finite number of roots we see that $G(S)$ is finite for all $S \\subset E$ finite. If $S \\subset S\'$ then restriction gives a map $G(S\') \\to G(S)$. Also, observe that if $\\alpha \\in S \\cap F$ and $f \\in G(S)$, then $f(\\alpha ) = \\alpha $ because the minimal polynomial is linear in this case. Consider the profinite topological space \n    \n      \n  \\[  G = \\mathop{\\mathrm{lim}}\\nolimits _{S \\subset E\\text{ finite}} G(S)  \\]\n\n    \n       Consider the canonical map \n    \n      \n  \\[  c : \\text{Gal}(E/F) \\longrightarrow G,\\quad \\sigma \\longmapsto (\\sigma |_ S : S \\to E)_ S  \\]\n\n    \n       This is injective and unwinding the definitions the reader sees the topology on $\\text{Gal}(E/F)$ as defined above is the induced topology from $G$. An element $(f_ S) \\in G$ is in the image of $c$ exactly if (A) $f_ S(\\alpha ) + f_ S(\\beta ) = f_ S(\\alpha + \\beta )$ and (M) $f_ S(\\alpha )f_ S(\\beta ) = f_ S(\\alpha \\beta )$ whenever this makes sense (i.e., $\\alpha , \\beta , \\alpha + \\beta , \\alpha \\beta \\in S$). Namely, this means $\\mathop{\\mathrm{lim}}\\nolimits f_ S : E \\to E$ will be an $F$-algebra map and hence an automorphism by Lemma 9.8.11. The conditions (A) and (M) for a given triple $(S, \\alpha , \\beta )$ define a closed subset of $G$ and hence $\\text{Gal}(E/F)$ is homeomorphic to a closed subset of a profinite space and therefore profinite itself. \n      $\\square$\n    \n","
  GroupFilterBasis.isTopologicalGroup (galGroupBasis K L)
",instance (K L : Type*) [Field K] [Field L] [Algebra K L] : IsTopologicalGroup Gal(L/K) ,"Proof.\n      Throughout this proof we think of $E$ as a discrete topological space. Recall that the compact open topology on the set of self maps $\\text{Map}(E, E)$ is the universal topology such that the action $\\text{Map}(E, E) \\times E \\to E$ is continuous. See Topology, Example 5.30.2 [[\n  Example 5.30.2. Let $E$ be a set. We can endow the set of self maps $\\text{Map}(E, E)$ with the compact open topology, i.e., the topology such that given $f : E \\to E$ a fundamental system of neighbourhoods of $f$ is given by the sets $U_ S(f) = \\{ f\' : E \\to E \\mid f\'|_ S = f|_ S\\} $ where $S \\subset E$ is finite. With this topology the action \n  \n  \\[  \\text{Map}(E, E) \\times E \\longrightarrow E,\\quad (f, e) \\longmapsto f(e)  \\]\n\n   is continuous when $E$ is given the discrete topology. If $X$ is a topological space and $X \\times E \\to E$ is a continuous map, then the map $X \\to \\text{Map}(E, E)$ is continuous. In other words, the compact open topology is the coarsest topology such that the \xe2\x80\x9caction\xe2\x80\x9d map displayed above is continuous. The composition \n  \n  \\[  \\text{Map}(E, E) \\times \\text{Map}(E, E) \\to \\text{Map}(E, E)  \\]\n\n   is continuous as well (as is easily verified using the description of neighbourhoods above). Finally, if $\\text{Aut}(E) \\subset \\text{Map}(E, E)$ is the subset of invertible maps, then the inverse $i : \\text{Aut}(E) \\to \\text{Aut}(E)$, $f \\mapsto f^{-1}$ is continuous too. Namely, say $S \\subset E$ is finite, then $i^{-1}(U_ S(f^{-1})) = U_{f^{-1}(S)}(f)$. Hence $\\text{Aut}(E)$ is a topological group as in Definition 5.30.1. \n]] for a precise statement. The topology of the lemma on $\\text{Gal}(E/F)$ is the induced topology coming from the injective map $\\text{Gal}(E/F) \\to \\text{Map}(E, E)$. Hence the universal property (1) follows from the corresponding universal property of the compact open topology. Since the set of invertible self maps $\\text{Aut}(E)$ endowed with the compact open topology forms a topological group, see Topology, Example 5.30.2 [[\n  Example 5.30.2. Let $E$ be a set. We can endow the set of self maps $\\text{Map}(E, E)$ with the compact open topology, i.e., the topology such that given $f : E \\to E$ a fundamental system of neighbourhoods of $f$ is given by the sets $U_ S(f) = \\{ f\' : E \\to E \\mid f\'|_ S = f|_ S\\} $ where $S \\subset E$ is finite. With this topology the action \n  \n  \\[  \\text{Map}(E, E) \\times E \\longrightarrow E,\\quad (f, e) \\longmapsto f(e)  \\]\n\n   is continuous when $E$ is given the discrete topology. If $X$ is a topological space and $X \\times E \\to E$ is a continuous map, then the map $X \\to \\text{Map}(E, E)$ is continuous. In other words, the compact open topology is the coarsest topology such that the \xe2\x80\x9caction\xe2\x80\x9d map displayed above is continuous. The composition \n  \n  \\[  \\text{Map}(E, E) \\times \\text{Map}(E, E) \\to \\text{Map}(E, E)  \\]\n\n   is continuous as well (as is easily verified using the description of neighbourhoods above). Finally, if $\\text{Aut}(E) \\subset \\text{Map}(E, E)$ is the subset of invertible maps, then the inverse $i : \\text{Aut}(E) \\to \\text{Aut}(E)$, $f \\mapsto f^{-1}$ is continuous too. Namely, say $S \\subset E$ is finite, then $i^{-1}(U_ S(f^{-1})) = U_{f^{-1}(S)}(f)$. Hence $\\text{Aut}(E)$ is a topological group as in Definition 5.30.1. \n]], and since $\\text{Gal}(E/F) = \\text{Aut}(E/F) \\to \\text{Map}(E, E)$ factors through $\\text{Aut}(E)$ we obtain a topological group. In other words, we are using the injection \n    \n      \n  \\[  \\text{Gal}(E/F) \\subset \\text{Aut}(E)  \\]\n\n    \n       to endow $\\text{Gal}(E/F)$ with the induced structure of a topological group (see Topology, Section 5.30 [[5.30 Topological groups, rings, modules\n\n\nThis is just a short section with definitions and elementary properties. \n\n\n\n  Definition 5.30.1. A topological group is a group $G$ endowed with a topology such that multiplication $G \\times G \\to G$, $(x, y) \\mapsto xy$ and inverse $G \\to G$, $x \\mapsto x^{-1}$ are continuous. A homomorphism of topological groups is a homomorphism of groups which is continuous. \n \n\n\nIf $G$ is a topological group and $H \\subset G$ is a subgroup, then $H$ with the induced topology is a topological group. If $G$ is a topological group and $G \\to H$ is a surjection of groups, then $H$ endowed with the quotient topology is a topological group. \n\n\n\n  Example 5.30.2. Let $E$ be a set. We can endow the set of self maps $\\text{Map}(E, E)$ with the compact open topology, i.e., the topology such that given $f : E \\to E$ a fundamental system of neighbourhoods of $f$ is given by the sets $U_ S(f) = \\{ f\' : E \\to E \\mid f\'|_ S = f|_ S\\} $ where $S \\subset E$ is finite. With this topology the action \n  \n  \\[  \\text{Map}(E, E) \\times E \\longrightarrow E,\\quad (f, e) \\longmapsto f(e)  \\]\n\n   is continuous when $E$ is given the discrete topology. If $X$ is a topological space and $X \\times E \\to E$ is a continuous map, then the map $X \\to \\text{Map}(E, E)$ is continuous. In other words, the compact open topology is the coarsest topology such that the \xe2\x80\x9caction\xe2\x80\x9d map displayed above is continuous. The composition \n  \n  \\[  \\text{Map}(E, E) \\times \\text{Map}(E, E) \\to \\text{Map}(E, E)  \\]\n\n   is continuous as well (as is easily verified using the description of neighbourhoods above). Finally, if $\\text{Aut}(E) \\subset \\text{Map}(E, E)$ is the subset of invertible maps, then the inverse $i : \\text{Aut}(E) \\to \\text{Aut}(E)$, $f \\mapsto f^{-1}$ is continuous too. Namely, say $S \\subset E$ is finite, then $i^{-1}(U_ S(f^{-1})) = U_{f^{-1}(S)}(f)$. Hence $\\text{Aut}(E)$ is a topological group as in Definition 5.30.1. \n \n\n\n\n  Lemma 5.30.3. The category of topological groups has limits and limits commute with the forgetful functors to (a) the category of topological spaces and (b) the category of groups. \n \n\n\n    \n]]) and by construction this is the coarsest structure of a topological group such that the action $\\text{Gal}(E/F) \\times E \\to E$ is continuous. \n    \n      To show that $\\text{Gal}(E/F)$ is profinite we argue as follows (our argument is necessarily nonstandard because we have defined the topology before showing that the Galois group is an inverse limit of finite groups). By Topology, Lemma 5.30.4 [[\n  Lemma 5.30.4. Let $G$ be a topological group. The following are equivalent \n  \n  \n$G$ as a topological space is profinite, \n\n\n$G$ is a limit of a diagram of finite discrete topological groups, \n\n\n$G$ is a cofiltered limit of finite discrete topological groups. \n\n\n\n\n    \n]] it suffices to show that the underlying topological space of $\\text{Gal}(E/F)$ is profinite. For any subset $S \\subset E$ consider the set \n    \n      \n  \\[  G(S) = \\{  f : S \\to E \\mid \\begin{matrix}  f(\\alpha )\\text{ is a root of the minimal polynomial}\n\n\\\\  \\text{of }\\alpha \\text{ over }F\\text{ for all }\\alpha \\in S \n\n\\end{matrix} \\}   \\]\n\n    \n       Since a polynomial has only a finite number of roots we see that $G(S)$ is finite for all $S \\subset E$ finite. If $S \\subset S\'$ then restriction gives a map $G(S\') \\to G(S)$. Also, observe that if $\\alpha \\in S \\cap F$ and $f \\in G(S)$, then $f(\\alpha ) = \\alpha $ because the minimal polynomial is linear in this case. Consider the profinite topological space \n    \n      \n  \\[  G = \\mathop{\\mathrm{lim}}\\nolimits _{S \\subset E\\text{ finite}} G(S)  \\]\n\n    \n       Consider the canonical map \n    \n      \n  \\[  c : \\text{Gal}(E/F) \\longrightarrow G,\\quad \\sigma \\longmapsto (\\sigma |_ S : S \\to E)_ S  \\]\n\n    \n       This is injective and unwinding the definitions the reader sees the topology on $\\text{Gal}(E/F)$ as defined above is the induced topology from $G$. An element $(f_ S) \\in G$ is in the image of $c$ exactly if (A) $f_ S(\\alpha ) + f_ S(\\beta ) = f_ S(\\alpha + \\beta )$ and (M) $f_ S(\\alpha )f_ S(\\beta ) = f_ S(\\alpha \\beta )$ whenever this makes sense (i.e., $\\alpha , \\beta , \\alpha + \\beta , \\alpha \\beta \\in S$). Namely, this means $\\mathop{\\mathrm{lim}}\\nolimits f_ S : E \\to E$ will be an $F$-algebra map and hence an automorphism by Lemma 9.8.11 [[\n  Lemma 9.8.11. Let $E/F$ an algebraic extension of fields. Any $F$-algebra map $f : E \\to E$ is an automorphism. \n\n    \n]]. The conditions (A) and (M) for a given triple $(S, \\alpha , \\beta )$ define a closed subset of $G$ and hence $\\text{Gal}(E/F)$ is homeomorphic to a closed subset of a profinite space and therefore profinite itself. \n      $\\square$\n    \n"
147,09HF,"theorem X_pow_sub_C_irreducible_of_prime {p : â„•} (hp : p.Prime) {a : K} (ha : âˆ€ b : K, b ^ p â‰  a) :
    Irreducible (X ^ p - C a) := by
  -- First of all, We may find an irreducible factor `g` of `X ^ p - C a`.
  have : Â¬ IsUnit (X ^ p - C a) := by
    rw [Polynomial.isUnit_iff_degree_eq_zero, degree_X_pow_sub_C hp.pos, Nat.cast_eq_zero]
    exact hp.ne_zero
  have âŸ¨g, hg, hg'âŸ© := WfDvdMonoid.exists_irreducible_factor this (X_pow_sub_C_ne_zero hp.pos a)
  -- It suffices to show that `deg g = p`.
  suffices natDegree g = p from (associated_of_dvd_of_natDegree_le hg'
    (X_pow_sub_C_ne_zero hp.pos a) (this.trans natDegree_X_pow_sub_C.symm).ge).irreducible hg
  -- Suppose `deg g â‰  p`.
  by_contra h
  -- Let `r` be a root of `g`, then `N_K(r) ^ p = N_K(r ^ p) = N_K(a) = a ^ (deg g)`.
  have key : (Algebra.norm K (AdjoinRoot.root g)) ^ p = a ^ g.natDegree := by
    have := evalâ‚‚_eq_zero_of_dvd_of_evalâ‚‚_eq_zero _ _ hg' (AdjoinRoot.evalâ‚‚_root g)
    rw [evalâ‚‚_sub, evalâ‚‚_pow, evalâ‚‚_C, evalâ‚‚_X, sub_eq_zero] at this
    rw [â† map_pow, this, â† AdjoinRoot.algebraMap_eq, Algebra.norm_algebraMap,
      (powerBasis hg.ne_zero).finrank, powerBasis_dim hg.ne_zero]
  -- Since `a ^ (deg g)` is a `p`-power, and `p` is coprime to `deg g`, we conclude that `a` is
  -- also a `p`-power, contradicting the hypothesis
  have : p.Coprime (natDegree g) := hp.coprime_iff_not_dvd.mpr (fun e â†¦ h (((natDegree_le_of_dvd hg'
    (X_pow_sub_C_ne_zero hp.pos a)).trans_eq natDegree_X_pow_sub_C).antisymm (Nat.le_of_dvd
      (natDegree_pos_iff_degree_pos.mpr <| Polynomial.degree_pos_of_irreducible hg) e)))
  exact ha _ ((pow_mem_range_pow_of_coprime this.symm a).mp âŸ¨_, keyâŸ©).choose_spec
",Formal Proof of Stacks Project Tag 09HF,We proved the result without the condition that `K` is char p in 09HF.,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/KummerPolynomial.lean#L98-L121,Q27041,,9.14.2,lemma,3.0,"['09HD', '09FA', '0ELQ']","\n  Lemma 9.14.2. Let $p$ be a prime number. Let $F$ be a field of characteristic $p$. Let $t \\in F$ be an element which does not have a $p$th root in $F$. Then the polynomial $x^ p - t$ is irreducible over $F$. \n\n    \n      Proof.\n      To see this, suppose that we have a factorization $x^ p - t = f g$. Taking derivatives we get $f\' g + f g\' = 0$. Note that neither $f\' = 0$ nor $g\' = 0$ as the degrees of $f$ and $g$ are smaller than $p$. Moreover, $\\deg (f\') < \\deg (f)$ and $\\deg (g\') < \\deg (g)$. We conclude that $f$ and $g$ have a factor in common. Thus if $x^ p - t$ is reducible, then it is of the form $x^ p - t = c f^ n$ for some irreducible $f$, $c \\in F^*$, and $n > 1$. Since $p$ is a prime number this implies $n = p$ and $f$ linear, which would imply $x^ p - t$ has a root in $F$. Contradiction. \n      $\\square$\n    \n",\n  Lemma 9.14.2. Let $p$ be a prime number. Let $F$ be a field of characteristic $p$. Let $t \\in F$ be an element which does not have a $p$th root in $F$. Then the polynomial $x^ p - t$ is irreducible over $F$. \n\n    \n,"Proof.\n      To see this, suppose that we have a factorization $x^ p - t = f g$. Taking derivatives we get $f\' g + f g\' = 0$. Note that neither $f\' = 0$ nor $g\' = 0$ as the degrees of $f$ and $g$ are smaller than $p$. Moreover, $\\deg (f\') < \\deg (f)$ and $\\deg (g\') < \\deg (g)$. We conclude that $f$ and $g$ have a factor in common. Thus if $x^ p - t$ is reducible, then it is of the form $x^ p - t = c f^ n$ for some irreducible $f$, $c \\in F^*$, and $n > 1$. Since $p$ is a prime number this implies $n = p$ and $f$ linear, which would imply $x^ p - t$ has a root in $F$. Contradiction. \n      $\\square$\n    \n"," by
  -- First of all, We may find an irreducible factor `g` of `X ^ p - C a`.
  have : Â¬ IsUnit (X ^ p - C a) := by
    rw [Polynomial.isUnit_iff_degree_eq_zero, degree_X_pow_sub_C hp.pos, Nat.cast_eq_zero]
    exact hp.ne_zero
  have âŸ¨g, hg, hg'âŸ© := WfDvdMonoid.exists_irreducible_factor this (X_pow_sub_C_ne_zero hp.pos a)
  -- It suffices to show that `deg g = p`.
  suffices natDegree g = p from (associated_of_dvd_of_natDegree_le hg'
    (X_pow_sub_C_ne_zero hp.pos a) (this.trans natDegree_X_pow_sub_C.symm).ge).irreducible hg
  -- Suppose `deg g â‰  p`.
  by_contra h
  -- Let `r` be a root of `g`, then `N_K(r) ^ p = N_K(r ^ p) = N_K(a) = a ^ (deg g)`.
  have key : (Algebra.norm K (AdjoinRoot.root g)) ^ p = a ^ g.natDegree := by
    have := evalâ‚‚_eq_zero_of_dvd_of_evalâ‚‚_eq_zero _ _ hg' (AdjoinRoot.evalâ‚‚_root g)
    rw [evalâ‚‚_sub, evalâ‚‚_pow, evalâ‚‚_C, evalâ‚‚_X, sub_eq_zero] at this
    rw [â† map_pow, this, â† AdjoinRoot.algebraMap_eq, Algebra.norm_algebraMap,
      (powerBasis hg.ne_zero).finrank, powerBasis_dim hg.ne_zero]
  -- Since `a ^ (deg g)` is a `p`-power, and `p` is coprime to `deg g`, we conclude that `a` is
  -- also a `p`-power, contradicting the hypothesis
  have : p.Coprime (natDegree g) := hp.coprime_iff_not_dvd.mpr (fun e â†¦ h (((natDegree_le_of_dvd hg'
    (X_pow_sub_C_ne_zero hp.pos a)).trans_eq natDegree_X_pow_sub_C).antisymm (Nat.le_of_dvd
      (natDegree_pos_iff_degree_pos.mpr <| Polynomial.degree_pos_of_irreducible hg) e)))
  exact ha _ ((pow_mem_range_pow_of_coprime this.symm a).mp âŸ¨_, keyâŸ©).choose_spec
","theorem X_pow_sub_C_irreducible_of_prime {p : â„•} (hp : p.Prime) {a : K} (ha : âˆ€ b : K, b ^ p â‰  a) :
    Irreducible (X ^ p - C a) ","Proof.\n      To see this, suppose that we have a factorization $x^ p - t = f g$. Taking derivatives we get $f\' g + f g\' = 0$. Note that neither $f\' = 0$ nor $g\' = 0$ as the degrees of $f$ and $g$ are smaller than $p$. Moreover, $\\deg (f\') < \\deg (f)$ and $\\deg (g\') < \\deg (g)$. We conclude that $f$ and $g$ have a factor in common. Thus if $x^ p - t$ is reducible, then it is of the form $x^ p - t = c f^ n$ for some irreducible $f$, $c \\in F^*$, and $n > 1$. Since $p$ is a prime number this implies $n = p$ and $f$ linear, which would imply $x^ p - t$ has a root in $F$. Contradiction. \n      $\\square$\n    \n"
148,09HY,"theorem exists_primitive_element_of_finite_top [Finite E] : âˆƒ Î± : E, FâŸ®Î±âŸ¯ = âŠ¤ := by
  obtain âŸ¨Î±, hÎ±âŸ© := @IsCyclic.exists_generator EË£ _ _
  use Î±
  rw [eq_top_iff]
  rintro x -
  by_cases hx : x = 0
  Â· rw [hx]
    exact FâŸ®Î±.valâŸ¯.zero_mem
  Â· obtain âŸ¨n, hnâŸ© := Set.mem_range.mp (hÎ± (Units.mk0 x hx))
    rw [show x = Î± ^ n by norm_cast; rw [hn, Units.val_mk0]]
    exact zpow_mem (mem_adjoin_simple_self F (E := E) â†‘Î±) n
",Formal Proof of Stacks Project Tag 09HY,second part,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/PrimitiveElement.lean#L59-L69,Q27041,Finite fields,9.18,section,2.0,"['09FA', '0ELQ']","9.18 Finite fields\n\n\nLet $F$ be a finite field. It is clear that $F$ has positive characteristic as we cannot have an injection $\\mathbf{Q} \\to F$. Say the characteristic of $F$ is $p$. The extension $\\mathbf{F}_ p \\subset F$ is finite. Hence we see that $F$ has $q = p^ f$ elements for some $f \\geq 1$. \n\n\nLet us think about the group of units $F^*$. This is a finite abelian group, so it has some exponent $e$. Then $F^* = \\mu _ e(F)$ and we see from the discussion in Section 9.17 that $F^*$ is a cyclic group of order $q - 1$. (A posteriori it follows that $e = q - 1$ as well.) In particular, if $\\alpha \\in F^*$ is a generator then it clearly is true that \n\n\n  \\[  F = \\mathbf{F}_ p(\\alpha )  \\]\n\n\n In other words, the extension $F/\\mathbf{F}_ p$ is generated by a single element. Of course, the same thing is true for any extension of finite fields $E/F$ (because $E$ is already generated by a single element over the prime field). \n\n","9.18 Finite fields\n\n\nLet $F$ be a finite field. It is clear that $F$ has positive characteristic as we cannot have an injection $\\mathbf{Q} \\to F$. Say the characteristic of $F$ is $p$. The extension $\\mathbf{F}_ p \\subset F$ is finite. Hence we see that $F$ has $q = p^ f$ elements for some $f \\geq 1$. \n\n\nLet us think about the group of units $F^*$. This is a finite abelian group, so it has some exponent $e$. Then $F^* = \\mu _ e(F)$ and we see from the discussion in Section 9.17 that $F^*$ is a cyclic group of order $q - 1$. (A posteriori it follows that $e = q - 1$ as well.) In particular, if $\\alpha \\in F^*$ is a generator then it clearly is true that \n\n\n  \\[  F = \\mathbf{F}_ p(\\alpha )  \\]\n\n\n In other words, the extension $F/\\mathbf{F}_ p$ is generated by a single element. Of course, the same thing is true for any extension of finite fields $E/F$ (because $E$ is already generated by a single element over the prime field). \n\n",," by
  obtain âŸ¨Î±, hÎ±âŸ© := @IsCyclic.exists_generator EË£ _ _
  use Î±
  rw [eq_top_iff]
  rintro x -
  by_cases hx : x = 0
  Â· rw [hx]
    exact FâŸ®Î±.valâŸ¯.zero_mem
  Â· obtain âŸ¨n, hnâŸ© := Set.mem_range.mp (hÎ± (Units.mk0 x hx))
    rw [show x = Î± ^ n by norm_cast; rw [hn, Units.val_mk0]]
    exact zpow_mem (mem_adjoin_simple_self F (E := E) â†‘Î±) n
","theorem exists_primitive_element_of_finite_top [Finite E] : âˆƒ Î± : E, FâŸ®Î±âŸ¯ = âŠ¤ ",
149,030N,"theorem exists_primitive_element : âˆƒ Î± : E, FâŸ®Î±âŸ¯ = âŠ¤ := by
  rcases isEmpty_or_nonempty (Fintype F) with (F_inf | âŸ¨âŸ¨F_finiteâŸ©âŸ©)
  Â· let P : IntermediateField F E â†’ Prop := fun K => âˆƒ Î± : E, FâŸ®Î±âŸ¯ = K
    have base : P âŠ¥ := âŸ¨0, adjoin_zeroâŸ©
    have ih : âˆ€ (K : IntermediateField F E) (x : E), P K â†’ P (KâŸ®xâŸ¯.restrictScalars F) := by
      intro K Î² hK
      obtain âŸ¨Î±, hKâŸ© := hK
      rw [â† hK, adjoin_simple_adjoin_simple]
      haveI : Infinite F := isEmpty_fintype.mp F_inf
      obtain âŸ¨Î³, hÎ³âŸ© := primitive_element_inf_aux F Î± Î²
      exact âŸ¨Î³, hÎ³.symmâŸ©
    exact induction_on_adjoin P base ih âŠ¤
  Â· exact exists_primitive_element_of_finite_bot F E
",Formal Proof of Stacks Project Tag 030N,The moreover part,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/PrimitiveElement.lean#L213-L225,Q27041,Primitive element,9.19.1,lemma,3.0,"['09HZ', '09FA', '0ELQ']","\n  Lemma 9.19.1 (Primitive element).  Let $E/F$ be a finite extension of fields. The following are equivalent \n  \n  \nthere exists a primitive element for $E$ over $F$, and \n\n\nthere are finitely many subextensions $E/K/F$. \n\n\n\n   Moreover, (1) and (2) hold if $E/F$ is separable. \n\n    \n      Proof.\n      Let $\\alpha \\in E$ be a primitive element. Let $P$ be the minimal polynomial of $\\alpha $ over $F$. Next, let $E/K/F$ be a subextension. Let $Q$ be the minimal polynomial of $\\alpha $ over $K$. Observe that $\\deg (Q) = [E : K]$. Writing $Q = x^ d + \\sum _{i < d} a_ i x^ i$ we claim that $K$ is equal to $L = F(a_0, \\ldots , a_{d - 1})$. Indeed $\\alpha $ has degree $d$ over $L$ and $L \\subset K$. Hence $[E : L] = [E : K]$ and it follows that $[K : L] = 1$, i.e., $K = L$. Thus it suffices to show there are at most finitely many possibilities for the polynomial $Q$. This is clear because we have a factorization $P = QR$ in $K[x]$ in particular in $E[x]$. Since we have unique factorization in $E[x]$ there are at most finitely many monic factors of $P$ in $E[x]$. \n    \n      If $F$ is a finite field (equivalently $E$ is a finite field), then $E/F$ has a primitive element by the discussion in Section 9.18. Next, assume $F$ is infinite and there are at most finitely many proper subfields $E/K/F$. List them, say $K_1, \\ldots , K_ N$. Then each $K_ i \\subset E$ is a proper sub $F$-vector space. As $F$ is infinite we can find a vector $\\alpha \\in E$ with $\\alpha \\not\\in K_ i$ for all $i$ (a vector space can never be equal to a finite union of proper subvector spaces; details omitted). Then $\\alpha $ is a primitive element for $E$ over $F$. \n    \n      Having established the equivalence of (1) and (2) we now turn to the final statement of the lemma. Choose an algebraic closure $\\overline{F}$ of $F$. Enumerate the elements $\\sigma _1, \\ldots , \\sigma _ n \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})$. Since $E/F$ is separable we have $n = [E : F]$ by Lemma 9.12.11. Note that if $i \\not= j$, then \n    \n      \n  \\[  V_{ij} = \\mathop{\\mathrm{Ker}}(\\sigma _ i - \\sigma _ j : E \\longrightarrow \\overline{F})  \\]\n\n    \n       is not equal to $E$. Hence arguing as in the preceding paragraph we can find $\\alpha \\in E$ with $\\alpha \\not\\in V_{ij}$ for all $i \\not= j$. It follows that $|\\mathop{\\mathrm{Mor}}\\nolimits _ F(F(\\alpha ), \\overline{F})| \\geq n$. On the other hand $[F(\\alpha ) : F] \\leq [E : F]$. Hence equality by Lemma 9.12.11 and we conclude that $E = F(\\alpha )$. \n      $\\square$\n    \n","\n  Lemma 9.19.1 (Primitive element).  Let $E/F$ be a finite extension of fields. The following are equivalent \n  \n  \nthere exists a primitive element for $E$ over $F$, and \n\n\nthere are finitely many subextensions $E/K/F$. \n\n\n\n   Moreover, (1) and (2) hold if $E/F$ is separable. \n\n    \n","Proof.\n      Let $\\alpha \\in E$ be a primitive element. Let $P$ be the minimal polynomial of $\\alpha $ over $F$. Next, let $E/K/F$ be a subextension. Let $Q$ be the minimal polynomial of $\\alpha $ over $K$. Observe that $\\deg (Q) = [E : K]$. Writing $Q = x^ d + \\sum _{i < d} a_ i x^ i$ we claim that $K$ is equal to $L = F(a_0, \\ldots , a_{d - 1})$. Indeed $\\alpha $ has degree $d$ over $L$ and $L \\subset K$. Hence $[E : L] = [E : K]$ and it follows that $[K : L] = 1$, i.e., $K = L$. Thus it suffices to show there are at most finitely many possibilities for the polynomial $Q$. This is clear because we have a factorization $P = QR$ in $K[x]$ in particular in $E[x]$. Since we have unique factorization in $E[x]$ there are at most finitely many monic factors of $P$ in $E[x]$. \n    \n      If $F$ is a finite field (equivalently $E$ is a finite field), then $E/F$ has a primitive element by the discussion in Section 9.18. Next, assume $F$ is infinite and there are at most finitely many proper subfields $E/K/F$. List them, say $K_1, \\ldots , K_ N$. Then each $K_ i \\subset E$ is a proper sub $F$-vector space. As $F$ is infinite we can find a vector $\\alpha \\in E$ with $\\alpha \\not\\in K_ i$ for all $i$ (a vector space can never be equal to a finite union of proper subvector spaces; details omitted). Then $\\alpha $ is a primitive element for $E$ over $F$. \n    \n      Having established the equivalence of (1) and (2) we now turn to the final statement of the lemma. Choose an algebraic closure $\\overline{F}$ of $F$. Enumerate the elements $\\sigma _1, \\ldots , \\sigma _ n \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})$. Since $E/F$ is separable we have $n = [E : F]$ by Lemma 9.12.11. Note that if $i \\not= j$, then \n    \n      \n  \\[  V_{ij} = \\mathop{\\mathrm{Ker}}(\\sigma _ i - \\sigma _ j : E \\longrightarrow \\overline{F})  \\]\n\n    \n       is not equal to $E$. Hence arguing as in the preceding paragraph we can find $\\alpha \\in E$ with $\\alpha \\not\\in V_{ij}$ for all $i \\not= j$. It follows that $|\\mathop{\\mathrm{Mor}}\\nolimits _ F(F(\\alpha ), \\overline{F})| \\geq n$. On the other hand $[F(\\alpha ) : F] \\leq [E : F]$. Hence equality by Lemma 9.12.11 and we conclude that $E = F(\\alpha )$. \n      $\\square$\n    \n"," by
  rcases isEmpty_or_nonempty (Fintype F) with (F_inf | âŸ¨âŸ¨F_finiteâŸ©âŸ©)
  Â· let P : IntermediateField F E â†’ Prop := fun K => âˆƒ Î± : E, FâŸ®Î±âŸ¯ = K
    have base : P âŠ¥ := âŸ¨0, adjoin_zeroâŸ©
    have ih : âˆ€ (K : IntermediateField F E) (x : E), P K â†’ P (KâŸ®xâŸ¯.restrictScalars F) := by
      intro K Î² hK
      obtain âŸ¨Î±, hKâŸ© := hK
      rw [â† hK, adjoin_simple_adjoin_simple]
      haveI : Infinite F := isEmpty_fintype.mp F_inf
      obtain âŸ¨Î³, hÎ³âŸ© := primitive_element_inf_aux F Î± Î²
      exact âŸ¨Î³, hÎ³.symmâŸ©
    exact induction_on_adjoin P base ih âŠ¤
  Â· exact exists_primitive_element_of_finite_bot F E
","theorem exists_primitive_element : âˆƒ Î± : E, FâŸ®Î±âŸ¯ = âŠ¤ ","Proof.\n      Let $\\alpha \\in E$ be a primitive element. Let $P$ be the minimal polynomial of $\\alpha $ over $F$. Next, let $E/K/F$ be a subextension. Let $Q$ be the minimal polynomial of $\\alpha $ over $K$. Observe that $\\deg (Q) = [E : K]$. Writing $Q = x^ d + \\sum _{i < d} a_ i x^ i$ we claim that $K$ is equal to $L = F(a_0, \\ldots , a_{d - 1})$. Indeed $\\alpha $ has degree $d$ over $L$ and $L \\subset K$. Hence $[E : L] = [E : K]$ and it follows that $[K : L] = 1$, i.e., $K = L$. Thus it suffices to show there are at most finitely many possibilities for the polynomial $Q$. This is clear because we have a factorization $P = QR$ in $K[x]$ in particular in $E[x]$. Since we have unique factorization in $E[x]$ there are at most finitely many monic factors of $P$ in $E[x]$. \n    \n      If $F$ is a finite field (equivalently $E$ is a finite field), then $E/F$ has a primitive element by the discussion in Section 9.18 [[9.18 Finite fields\n\n\nLet $F$ be a finite field. It is clear that $F$ has positive characteristic as we cannot have an injection $\\mathbf{Q} \\to F$. Say the characteristic of $F$ is $p$. The extension $\\mathbf{F}_ p \\subset F$ is finite. Hence we see that $F$ has $q = p^ f$ elements for some $f \\geq 1$. \n\n\nLet us think about the group of units $F^*$. This is a finite abelian group, so it has some exponent $e$. Then $F^* = \\mu _ e(F)$ and we see from the discussion in Section 9.17 that $F^*$ is a cyclic group of order $q - 1$. (A posteriori it follows that $e = q - 1$ as well.) In particular, if $\\alpha \\in F^*$ is a generator then it clearly is true that \n\n\n  \\[  F = \\mathbf{F}_ p(\\alpha )  \\]\n\n\n In other words, the extension $F/\\mathbf{F}_ p$ is generated by a single element. Of course, the same thing is true for any extension of finite fields $E/F$ (because $E$ is already generated by a single element over the prime field). \n\n]]. Next, assume $F$ is infinite and there are at most finitely many proper subfields $E/K/F$. List them, say $K_1, \\ldots , K_ N$. Then each $K_ i \\subset E$ is a proper sub $F$-vector space. As $F$ is infinite we can find a vector $\\alpha \\in E$ with $\\alpha \\not\\in K_ i$ for all $i$ (a vector space can never be equal to a finite union of proper subvector spaces; details omitted). Then $\\alpha $ is a primitive element for $E$ over $F$. \n    \n      Having established the equivalence of (1) and (2) we now turn to the final statement of the lemma. Choose an algebraic closure $\\overline{F}$ of $F$. Enumerate the elements $\\sigma _1, \\ldots , \\sigma _ n \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})$. Since $E/F$ is separable we have $n = [E : F]$ by Lemma 9.12.11 [[\n  Lemma 9.12.11. Let $K/F$ be a finite extension of fields. Let $\\overline{F}$ be an algebraic closure of $F$. Then we have \n  \n  \\[  |\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})| \\leq [K : F]  \\]\n\n   with equality if and only if $K$ is separable over $F$. \n\n    \n]]. Note that if $i \\not= j$, then \n    \n      \n  \\[  V_{ij} = \\mathop{\\mathrm{Ker}}(\\sigma _ i - \\sigma _ j : E \\longrightarrow \\overline{F})  \\]\n\n    \n       is not equal to $E$. Hence arguing as in the preceding paragraph we can find $\\alpha \\in E$ with $\\alpha \\not\\in V_{ij}$ for all $i \\not= j$. It follows that $|\\mathop{\\mathrm{Mor}}\\nolimits _ F(F(\\alpha ), \\overline{F})| \\geq n$. On the other hand $[F(\\alpha ) : F] \\leq [E : F]$. Hence equality by Lemma 9.12.11 [[\n  Lemma 9.12.11. Let $K/F$ be a finite extension of fields. Let $\\overline{F}$ be an algebraic closure of $F$. Then we have \n  \n  \\[  |\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})| \\leq [K : F]  \\]\n\n   with equality if and only if $K$ is separable over $F$. \n\n    \n]] and we conclude that $E = F(\\alpha )$. \n      $\\square$\n    \n"
150,030N,"theorem exists_primitive_element_iff_finite_intermediateField :
    (Algebra.IsAlgebraic F E âˆ§ âˆƒ Î± : E, FâŸ®Î±âŸ¯ = âŠ¤) â†” Finite (IntermediateField F E) :=
  âŸ¨fun âŸ¨_, hâŸ© â†¦ finite_intermediateField_of_exists_primitive_element F E h,
    fun _ â†¦ âŸ¨isAlgebraic_of_finite_intermediateField F E,
      exists_primitive_element_of_finite_intermediateField F E _âŸ©âŸ©
",Formal Proof of Stacks Project Tag 030N,Equivalence of (1) & (2),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/PrimitiveElement.lean#L337-L341,Q27041,Primitive element,9.19.1,lemma,3.0,"['09HZ', '09FA', '0ELQ']","\n  Lemma 9.19.1 (Primitive element).  Let $E/F$ be a finite extension of fields. The following are equivalent \n  \n  \nthere exists a primitive element for $E$ over $F$, and \n\n\nthere are finitely many subextensions $E/K/F$. \n\n\n\n   Moreover, (1) and (2) hold if $E/F$ is separable. \n\n    \n      Proof.\n      Let $\\alpha \\in E$ be a primitive element. Let $P$ be the minimal polynomial of $\\alpha $ over $F$. Next, let $E/K/F$ be a subextension. Let $Q$ be the minimal polynomial of $\\alpha $ over $K$. Observe that $\\deg (Q) = [E : K]$. Writing $Q = x^ d + \\sum _{i < d} a_ i x^ i$ we claim that $K$ is equal to $L = F(a_0, \\ldots , a_{d - 1})$. Indeed $\\alpha $ has degree $d$ over $L$ and $L \\subset K$. Hence $[E : L] = [E : K]$ and it follows that $[K : L] = 1$, i.e., $K = L$. Thus it suffices to show there are at most finitely many possibilities for the polynomial $Q$. This is clear because we have a factorization $P = QR$ in $K[x]$ in particular in $E[x]$. Since we have unique factorization in $E[x]$ there are at most finitely many monic factors of $P$ in $E[x]$. \n    \n      If $F$ is a finite field (equivalently $E$ is a finite field), then $E/F$ has a primitive element by the discussion in Section 9.18. Next, assume $F$ is infinite and there are at most finitely many proper subfields $E/K/F$. List them, say $K_1, \\ldots , K_ N$. Then each $K_ i \\subset E$ is a proper sub $F$-vector space. As $F$ is infinite we can find a vector $\\alpha \\in E$ with $\\alpha \\not\\in K_ i$ for all $i$ (a vector space can never be equal to a finite union of proper subvector spaces; details omitted). Then $\\alpha $ is a primitive element for $E$ over $F$. \n    \n      Having established the equivalence of (1) and (2) we now turn to the final statement of the lemma. Choose an algebraic closure $\\overline{F}$ of $F$. Enumerate the elements $\\sigma _1, \\ldots , \\sigma _ n \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})$. Since $E/F$ is separable we have $n = [E : F]$ by Lemma 9.12.11. Note that if $i \\not= j$, then \n    \n      \n  \\[  V_{ij} = \\mathop{\\mathrm{Ker}}(\\sigma _ i - \\sigma _ j : E \\longrightarrow \\overline{F})  \\]\n\n    \n       is not equal to $E$. Hence arguing as in the preceding paragraph we can find $\\alpha \\in E$ with $\\alpha \\not\\in V_{ij}$ for all $i \\not= j$. It follows that $|\\mathop{\\mathrm{Mor}}\\nolimits _ F(F(\\alpha ), \\overline{F})| \\geq n$. On the other hand $[F(\\alpha ) : F] \\leq [E : F]$. Hence equality by Lemma 9.12.11 and we conclude that $E = F(\\alpha )$. \n      $\\square$\n    \n","\n  Lemma 9.19.1 (Primitive element).  Let $E/F$ be a finite extension of fields. The following are equivalent \n  \n  \nthere exists a primitive element for $E$ over $F$, and \n\n\nthere are finitely many subextensions $E/K/F$. \n\n\n\n   Moreover, (1) and (2) hold if $E/F$ is separable. \n\n    \n","Proof.\n      Let $\\alpha \\in E$ be a primitive element. Let $P$ be the minimal polynomial of $\\alpha $ over $F$. Next, let $E/K/F$ be a subextension. Let $Q$ be the minimal polynomial of $\\alpha $ over $K$. Observe that $\\deg (Q) = [E : K]$. Writing $Q = x^ d + \\sum _{i < d} a_ i x^ i$ we claim that $K$ is equal to $L = F(a_0, \\ldots , a_{d - 1})$. Indeed $\\alpha $ has degree $d$ over $L$ and $L \\subset K$. Hence $[E : L] = [E : K]$ and it follows that $[K : L] = 1$, i.e., $K = L$. Thus it suffices to show there are at most finitely many possibilities for the polynomial $Q$. This is clear because we have a factorization $P = QR$ in $K[x]$ in particular in $E[x]$. Since we have unique factorization in $E[x]$ there are at most finitely many monic factors of $P$ in $E[x]$. \n    \n      If $F$ is a finite field (equivalently $E$ is a finite field), then $E/F$ has a primitive element by the discussion in Section 9.18. Next, assume $F$ is infinite and there are at most finitely many proper subfields $E/K/F$. List them, say $K_1, \\ldots , K_ N$. Then each $K_ i \\subset E$ is a proper sub $F$-vector space. As $F$ is infinite we can find a vector $\\alpha \\in E$ with $\\alpha \\not\\in K_ i$ for all $i$ (a vector space can never be equal to a finite union of proper subvector spaces; details omitted). Then $\\alpha $ is a primitive element for $E$ over $F$. \n    \n      Having established the equivalence of (1) and (2) we now turn to the final statement of the lemma. Choose an algebraic closure $\\overline{F}$ of $F$. Enumerate the elements $\\sigma _1, \\ldots , \\sigma _ n \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})$. Since $E/F$ is separable we have $n = [E : F]$ by Lemma 9.12.11. Note that if $i \\not= j$, then \n    \n      \n  \\[  V_{ij} = \\mathop{\\mathrm{Ker}}(\\sigma _ i - \\sigma _ j : E \\longrightarrow \\overline{F})  \\]\n\n    \n       is not equal to $E$. Hence arguing as in the preceding paragraph we can find $\\alpha \\in E$ with $\\alpha \\not\\in V_{ij}$ for all $i \\not= j$. It follows that $|\\mathop{\\mathrm{Mor}}\\nolimits _ F(F(\\alpha ), \\overline{F})| \\geq n$. On the other hand $[F(\\alpha ) : F] \\leq [E : F]$. Hence equality by Lemma 9.12.11 and we conclude that $E = F(\\alpha )$. \n      $\\square$\n    \n","
  âŸ¨fun âŸ¨_, hâŸ© â†¦ finite_intermediateField_of_exists_primitive_element F E h,
    fun _ â†¦ âŸ¨isAlgebraic_of_finite_intermediateField F E,
      exists_primitive_element_of_finite_intermediateField F E _âŸ©âŸ©
","theorem exists_primitive_element_iff_finite_intermediateField :
    (Algebra.IsAlgebraic F E âˆ§ âˆƒ Î± : E, FâŸ®Î±âŸ¯ = âŠ¤) â†” Finite (IntermediateField F E) ","Proof.\n      Let $\\alpha \\in E$ be a primitive element. Let $P$ be the minimal polynomial of $\\alpha $ over $F$. Next, let $E/K/F$ be a subextension. Let $Q$ be the minimal polynomial of $\\alpha $ over $K$. Observe that $\\deg (Q) = [E : K]$. Writing $Q = x^ d + \\sum _{i < d} a_ i x^ i$ we claim that $K$ is equal to $L = F(a_0, \\ldots , a_{d - 1})$. Indeed $\\alpha $ has degree $d$ over $L$ and $L \\subset K$. Hence $[E : L] = [E : K]$ and it follows that $[K : L] = 1$, i.e., $K = L$. Thus it suffices to show there are at most finitely many possibilities for the polynomial $Q$. This is clear because we have a factorization $P = QR$ in $K[x]$ in particular in $E[x]$. Since we have unique factorization in $E[x]$ there are at most finitely many monic factors of $P$ in $E[x]$. \n    \n      If $F$ is a finite field (equivalently $E$ is a finite field), then $E/F$ has a primitive element by the discussion in Section 9.18 [[9.18 Finite fields\n\n\nLet $F$ be a finite field. It is clear that $F$ has positive characteristic as we cannot have an injection $\\mathbf{Q} \\to F$. Say the characteristic of $F$ is $p$. The extension $\\mathbf{F}_ p \\subset F$ is finite. Hence we see that $F$ has $q = p^ f$ elements for some $f \\geq 1$. \n\n\nLet us think about the group of units $F^*$. This is a finite abelian group, so it has some exponent $e$. Then $F^* = \\mu _ e(F)$ and we see from the discussion in Section 9.17 that $F^*$ is a cyclic group of order $q - 1$. (A posteriori it follows that $e = q - 1$ as well.) In particular, if $\\alpha \\in F^*$ is a generator then it clearly is true that \n\n\n  \\[  F = \\mathbf{F}_ p(\\alpha )  \\]\n\n\n In other words, the extension $F/\\mathbf{F}_ p$ is generated by a single element. Of course, the same thing is true for any extension of finite fields $E/F$ (because $E$ is already generated by a single element over the prime field). \n\n]]. Next, assume $F$ is infinite and there are at most finitely many proper subfields $E/K/F$. List them, say $K_1, \\ldots , K_ N$. Then each $K_ i \\subset E$ is a proper sub $F$-vector space. As $F$ is infinite we can find a vector $\\alpha \\in E$ with $\\alpha \\not\\in K_ i$ for all $i$ (a vector space can never be equal to a finite union of proper subvector spaces; details omitted). Then $\\alpha $ is a primitive element for $E$ over $F$. \n    \n      Having established the equivalence of (1) and (2) we now turn to the final statement of the lemma. Choose an algebraic closure $\\overline{F}$ of $F$. Enumerate the elements $\\sigma _1, \\ldots , \\sigma _ n \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})$. Since $E/F$ is separable we have $n = [E : F]$ by Lemma 9.12.11 [[\n  Lemma 9.12.11. Let $K/F$ be a finite extension of fields. Let $\\overline{F}$ be an algebraic closure of $F$. Then we have \n  \n  \\[  |\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})| \\leq [K : F]  \\]\n\n   with equality if and only if $K$ is separable over $F$. \n\n    \n]]. Note that if $i \\not= j$, then \n    \n      \n  \\[  V_{ij} = \\mathop{\\mathrm{Ker}}(\\sigma _ i - \\sigma _ j : E \\longrightarrow \\overline{F})  \\]\n\n    \n       is not equal to $E$. Hence arguing as in the preceding paragraph we can find $\\alpha \\in E$ with $\\alpha \\not\\in V_{ij}$ for all $i \\not= j$. It follows that $|\\mathop{\\mathrm{Mor}}\\nolimits _ F(F(\\alpha ), \\overline{F})| \\geq n$. On the other hand $[F(\\alpha ) : F] \\leq [E : F]$. Hence equality by Lemma 9.12.11 [[\n  Lemma 9.12.11. Let $K/F$ be a finite extension of fields. Let $\\overline{F}$ be an algebraic closure of $F$. Then we have \n  \n  \\[  |\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})| \\leq [K : F]  \\]\n\n   with equality if and only if $K$ is separable over $F$. \n\n    \n]] and we conclude that $E = F(\\alpha )$. \n      $\\square$\n    \n"
151,09H1,"def Separable (f : R[X]) : Prop :=
  IsCoprime f (derivative f)
",Formal Proof of Stacks Project Tag 09H1,first part,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/Separable.lean#L49-L50,Q27041,,9.12.2,definition,3.0,"['09GZ', '09FA', '0ELQ']","\n  Definition 9.12.2. Let $F$ be a field. Let $K/F$ be an extension of fields. \n  \n  \nWe say an irreducible polynomial $P$ over $F$ is separable if it is relatively prime to its derivative. \n\n\nGiven $\\alpha \\in K$ algebraic over $F$ we say $\\alpha $ is separable over $F$ if its minimal polynomial is separable over $F$. \n\n\nIf $K$ is an algebraic extension of $F$, we say $K$ is separable1 over $F$ if every element of $K$ is separable over $F$. \n\n\n\n","\n  Definition 9.12.2. Let $F$ be a field. Let $K/F$ be an extension of fields. \n  \n  \nWe say an irreducible polynomial $P$ over $F$ is separable if it is relatively prime to its derivative. \n\n\nGiven $\\alpha \\in K$ algebraic over $F$ we say $\\alpha $ is separable over $F$ if its minimal polynomial is separable over $F$. \n\n\nIf $K$ is an algebraic extension of $F$, we say $K$ is separable1 over $F$ if every element of $K$ is separable over $F$. \n\n\n\n",,"
  IsCoprime f (derivative f)
",def Separable (f : R[X]) : Prop ,
152,09H3,"theorem nodup_aroots_iff_of_splits [Algebra F K] {f : F[X]} (hf : f â‰  0)
    (h : (f.map (algebraMap F K)).Splits) : (f.aroots K).Nodup â†” f.Separable := by
  rw [nodup_roots_iff_of_splits (map_ne_zero hf) h, separable_map]
",Formal Proof of Stacks Project Tag 09H3,Here we only require `f` splits instead of `K` is algebraically closed.,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/Separable.lean#L478-L480,Q27041,,9.12.4,lemma,3.0,"['09GZ', '09FA', '0ELQ']","\n  Lemma 9.12.4. Let $F$ be a field. An irreducible polynomial $P$ over $F$ is separable if and only if $P$ has pairwise distinct roots in an algebraic closure of $F$. \n\n    \n      Proof.\n      Suppose that $\\alpha \\in \\overline{F}$ is a root of both $P$ and $P\'$. Then $P = (x - \\alpha )Q$ for some polynomial $Q$. Taking derivatives we obtain $P\' = Q + (x - \\alpha )Q\'$. Thus $\\alpha $ is a root of $Q$. Hence we see that if $P$ and $P\'$ have a common root, then $P$ does not have pairwise distinct roots. Conversely, if $P$ has a repeated root, i.e., $(x - \\alpha )^2$ divides $P$, then $\\alpha $ is a root of both $P$ and $P\'$. Combined with Lemma 9.11.2 this proves the lemma. \n      $\\square$\n    \n",\n  Lemma 9.12.4. Let $F$ be a field. An irreducible polynomial $P$ over $F$ is separable if and only if $P$ has pairwise distinct roots in an algebraic closure of $F$. \n\n    \n,"Proof.\n      Suppose that $\\alpha \\in \\overline{F}$ is a root of both $P$ and $P\'$. Then $P = (x - \\alpha )Q$ for some polynomial $Q$. Taking derivatives we obtain $P\' = Q + (x - \\alpha )Q\'$. Thus $\\alpha $ is a root of $Q$. Hence we see that if $P$ and $P\'$ have a common root, then $P$ does not have pairwise distinct roots. Conversely, if $P$ has a repeated root, i.e., $(x - \\alpha )^2$ divides $P$, then $\\alpha $ is a root of both $P$ and $P\'$. Combined with Lemma 9.11.2 this proves the lemma. \n      $\\square$\n    \n"," by
  rw [nodup_roots_iff_of_splits (map_ne_zero hf) h, separable_map]
","theorem nodup_aroots_iff_of_splits [Algebra F K] {f : F[X]} (hf : f â‰  0)
    (h : (f.map (algebraMap F K)).Splits) : (f.aroots K).Nodup â†” f.Separable ","Proof.\n      Suppose that $\\alpha \\in \\overline{F}$ is a root of both $P$ and $P\'$. Then $P = (x - \\alpha )Q$ for some polynomial $Q$. Taking derivatives we obtain $P\' = Q + (x - \\alpha )Q\'$. Thus $\\alpha $ is a root of $Q$. Hence we see that if $P$ and $P\'$ have a common root, then $P$ does not have pairwise distinct roots. Conversely, if $P$ has a repeated root, i.e., $(x - \\alpha )^2$ divides $P$, then $\\alpha $ is a root of both $P$ and $P\'$. Combined with Lemma 9.11.2 [[\n  Lemma 9.11.2. Two polynomials in $k[x]$ are relatively prime precisely when they have no common roots in an algebraic closure $\\overline{k}$ of $k$. \n\n    \n]] this proves the lemma. \n      $\\square$\n    \n"
153,09H1,"def IsSeparable (x : K) : Prop := Polynomial.Separable (minpoly F x)
",Formal Proof of Stacks Project Tag 09H1,second part,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/Separable.lean#L554-L554,Q27041,,9.12.2,definition,3.0,"['09GZ', '09FA', '0ELQ']","\n  Definition 9.12.2. Let $F$ be a field. Let $K/F$ be an extension of fields. \n  \n  \nWe say an irreducible polynomial $P$ over $F$ is separable if it is relatively prime to its derivative. \n\n\nGiven $\\alpha \\in K$ algebraic over $F$ we say $\\alpha $ is separable over $F$ if its minimal polynomial is separable over $F$. \n\n\nIf $K$ is an algebraic extension of $F$, we say $K$ is separable1 over $F$ if every element of $K$ is separable over $F$. \n\n\n\n","\n  Definition 9.12.2. Let $F$ be a field. Let $K/F$ be an extension of fields. \n  \n  \nWe say an irreducible polynomial $P$ over $F$ is separable if it is relatively prime to its derivative. \n\n\nGiven $\\alpha \\in K$ algebraic over $F$ we say $\\alpha $ is separable over $F$ if its minimal polynomial is separable over $F$. \n\n\nIf $K$ is an algebraic extension of $F$, we say $K$ is separable1 over $F$ if every element of $K$ is separable over $F$. \n\n\n\n",," Polynomial.Separable (minpoly F x)
",def IsSeparable (x : K) : Prop ,
154,09H2,"theorem IsSeparable.tower_top
    {x : E} (h : IsSeparable F x) : IsSeparable L x :=
  .of_dvd (.map h) (minpoly.dvd_map_of_isScalarTower ..)
",Formal Proof of Stacks Project Tag 09H2,first part,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/Separable.lean#L639-L641,Q27041,,9.12.3,lemma,3.0,"['09GZ', '09FA', '0ELQ']","\n  Lemma 9.12.3. Let $K/E/F$ be a tower of algebraic field extensions. \n  \n  \nIf $\\alpha \\in K$ is separable over $F$, then $\\alpha $ is separable over $E$. \n\n\nif $K$ is separable over $F$, then $K$ is separable over $E$. \n\n\n\n\n    \n      Proof.\n      We will use Lemma 9.12.1 without further mention. Let $P$ be the minimal polynomial of $\\alpha $ over $F$. Let $Q$ be the minimal polynomial of $\\alpha $ over $E$. Then $Q$ divides $P$ in the polynomial ring $E[x]$, say $P = QR$. Then $P\' = Q\'R + QR\'$. Thus if $Q\' = 0$, then $Q$ divides $P$ and $P\'$ hence $P\' = 0$ by the lemma. This proves (1). Part (2) follows immediately from (1) and the definitions. \n      $\\square$\n    \n","\n  Lemma 9.12.3. Let $K/E/F$ be a tower of algebraic field extensions. \n  \n  \nIf $\\alpha \\in K$ is separable over $F$, then $\\alpha $ is separable over $E$. \n\n\nif $K$ is separable over $F$, then $K$ is separable over $E$. \n\n\n\n\n    \n","Proof.\n      We will use Lemma 9.12.1 without further mention. Let $P$ be the minimal polynomial of $\\alpha $ over $F$. Let $Q$ be the minimal polynomial of $\\alpha $ over $E$. Then $Q$ divides $P$ in the polynomial ring $E[x]$, say $P = QR$. Then $P\' = Q\'R + QR\'$. Thus if $Q\' = 0$, then $Q$ divides $P$ and $P\'$ hence $P\' = 0$ by the lemma. This proves (1). Part (2) follows immediately from (1) and the definitions. \n      $\\square$\n    \n","
  .of_dvd (.map h) (minpoly.dvd_map_of_isScalarTower ..)
","theorem IsSeparable.tower_top
    {x : E} (h : IsSeparable F x) : IsSeparable L x ","Proof.\n      We will use Lemma 9.12.1 [[\n  Lemma 9.12.1. Let $F$ be a field. Let $P \\in F[x]$ be an irreducible polynomial over $F$. Let $P\' = \\text{d}P/\\text{d}x$ be the derivative of $P$ with respect to $x$. Then one of the following two cases happens \n  \n  \n$P$ and $P\'$ are relatively prime, or \n\n\n$P\'$ is the zero polynomial. \n\n\n\n   The second case can only happen if $F$ has characteristic $p > 0$. In this case $P(x) = Q(x^ q)$ where $q = p^ f$ is a power of $p$ and $Q \\in F[x]$ is an irreducible polynomial such that $Q$ and $Q\'$ are relatively prime. \n\n    \n]] without further mention. Let $P$ be the minimal polynomial of $\\alpha $ over $F$. Let $Q$ be the minimal polynomial of $\\alpha $ over $E$. Then $Q$ divides $P$ in the polynomial ring $E[x]$, say $P = QR$. Then $P\' = Q\'R + QR\'$. Thus if $Q\' = 0$, then $Q$ divides $P$ and $P\'$ hence $P\' = 0$ by the lemma. This proves (1). Part (2) follows immediately from (1) and the definitions. \n      $\\square$\n    \n"
155,09H2,"theorem Algebra.isSeparable_tower_top_of_isSeparable [Algebra.IsSeparable F E] :
    Algebra.IsSeparable L E :=
  âŸ¨fun x â†¦ IsSeparable.tower_top _ (Algebra.IsSeparable.isSeparable F x)âŸ©
",Formal Proof of Stacks Project Tag 09H2,second part,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/Separable.lean#L647-L649,Q27041,,9.12.3,lemma,3.0,"['09GZ', '09FA', '0ELQ']","\n  Lemma 9.12.3. Let $K/E/F$ be a tower of algebraic field extensions. \n  \n  \nIf $\\alpha \\in K$ is separable over $F$, then $\\alpha $ is separable over $E$. \n\n\nif $K$ is separable over $F$, then $K$ is separable over $E$. \n\n\n\n\n    \n      Proof.\n      We will use Lemma 9.12.1 without further mention. Let $P$ be the minimal polynomial of $\\alpha $ over $F$. Let $Q$ be the minimal polynomial of $\\alpha $ over $E$. Then $Q$ divides $P$ in the polynomial ring $E[x]$, say $P = QR$. Then $P\' = Q\'R + QR\'$. Thus if $Q\' = 0$, then $Q$ divides $P$ and $P\'$ hence $P\' = 0$ by the lemma. This proves (1). Part (2) follows immediately from (1) and the definitions. \n      $\\square$\n    \n","\n  Lemma 9.12.3. Let $K/E/F$ be a tower of algebraic field extensions. \n  \n  \nIf $\\alpha \\in K$ is separable over $F$, then $\\alpha $ is separable over $E$. \n\n\nif $K$ is separable over $F$, then $K$ is separable over $E$. \n\n\n\n\n    \n","Proof.\n      We will use Lemma 9.12.1 without further mention. Let $P$ be the minimal polynomial of $\\alpha $ over $F$. Let $Q$ be the minimal polynomial of $\\alpha $ over $E$. Then $Q$ divides $P$ in the polynomial ring $E[x]$, say $P = QR$. Then $P\' = Q\'R + QR\'$. Thus if $Q\' = 0$, then $Q$ divides $P$ and $P\'$ hence $P\' = 0$ by the lemma. This proves (1). Part (2) follows immediately from (1) and the definitions. \n      $\\square$\n    \n","
  âŸ¨fun x â†¦ IsSeparable.tower_top _ (Algebra.IsSeparable.isSeparable F x)âŸ©
","theorem Algebra.isSeparable_tower_top_of_isSeparable [Algebra.IsSeparable F E] :
    Algebra.IsSeparable L E ","Proof.\n      We will use Lemma 9.12.1 [[\n  Lemma 9.12.1. Let $F$ be a field. Let $P \\in F[x]$ be an irreducible polynomial over $F$. Let $P\' = \\text{d}P/\\text{d}x$ be the derivative of $P$ with respect to $x$. Then one of the following two cases happens \n  \n  \n$P$ and $P\'$ are relatively prime, or \n\n\n$P\'$ is the zero polynomial. \n\n\n\n   The second case can only happen if $F$ has characteristic $p > 0$. In this case $P(x) = Q(x^ q)$ where $q = p^ f$ is a power of $p$ and $Q \\in F[x]$ is an irreducible polynomial such that $Q$ and $Q\'$ are relatively prime. \n\n    \n]] without further mention. Let $P$ be the minimal polynomial of $\\alpha $ over $F$. Let $Q$ be the minimal polynomial of $\\alpha $ over $E$. Then $Q$ divides $P$ in the polynomial ring $E[x]$, say $P = QR$. Then $P\' = Q\'R + QR\'$. Thus if $Q\' = 0$, then $Q$ divides $P$ and $P\'$ hence $P\' = 0$ by the lemma. This proves (1). Part (2) follows immediately from (1) and the definitions. \n      $\\square$\n    \n"
156,09HC,"def separableClosure : IntermediateField F E where
  carrier := {x | IsSeparable F x}
  mul_mem' := isSeparable_mul
  add_mem' := isSeparable_add
  algebraMap_mem' := isSeparable_algebraMap
  inv_mem' _ := isSeparable_inv
",Formal Proof of Stacks Project Tag 09HC,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/SeparableClosure.lean#L82-L87,Q27041,,9.12.13,lemma,3.0,"['09GZ', '09FA', '0ELQ']","\n  Lemma 9.12.13. Let $E/k$ be a field extension. Then the elements of $E$ separable over $k$ form a subextension of $E/k$. \n\n    \n      Proof.\n      Let $\\alpha , \\beta \\in E$ be separable over $k$. Then $\\beta $ is separable over $k(\\alpha )$ by Lemma 9.12.3. By Lemma 9.12.10 (applied with $n = 2$, $\\alpha _1 = \\alpha $, and $\\alpha _2 = \\beta $) we see that $k(\\alpha , \\beta )$ is separable over $k$. \n      $\\square$\n    \n",\n  Lemma 9.12.13. Let $E/k$ be a field extension. Then the elements of $E$ separable over $k$ form a subextension of $E/k$. \n\n    \n,"Proof.\n      Let $\\alpha , \\beta \\in E$ be separable over $k$. Then $\\beta $ is separable over $k(\\alpha )$ by Lemma 9.12.3. By Lemma 9.12.10 (applied with $n = 2$, $\\alpha _1 = \\alpha $, and $\\alpha _2 = \\beta $) we see that $k(\\alpha , \\beta )$ is separable over $k$. \n      $\\square$\n    \n"," {x | IsSeparable F x}
  mul_mem' := isSeparable_mul
  add_mem' := isSeparable_add
  algebraMap_mem' := isSeparable_algebraMap
  inv_mem' _ := isSeparable_inv
","def separableClosure : IntermediateField F E where
  carrier ","Proof.\n      Let $\\alpha , \\beta \\in E$ be separable over $k$. Then $\\beta $ is separable over $k(\\alpha )$ by Lemma 9.12.3 [[\n  Lemma 9.12.3. Let $K/E/F$ be a tower of algebraic field extensions. \n  \n  \nIf $\\alpha \\in K$ is separable over $F$, then $\\alpha $ is separable over $E$. \n\n\nif $K$ is separable over $F$, then $K$ is separable over $E$. \n\n\n\n\n    \n]]. By Lemma 9.12.10 [[\n  Lemma 9.12.10. Assumptions and notation as in Situation 9.12.7. If each $P_ i$ is separable, i.e., each $\\alpha _ i$ is separable over $K_{i - 1}$, then \n  \n  \\[  |\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})| = [K : F]  \\]\n\n   and the field extension $K/F$ is separable. If one of the $\\alpha _ i$ is not separable over $K_{i - 1}$, then $|\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})| < [K : F]$. \n\n    \n]] (applied with $n = 2$, $\\alpha _1 = \\alpha $, and $\\alpha _2 = \\beta $) we see that $k(\\alpha , \\beta )$ is separable over $k$. \n      $\\square$\n    \n"
157,030K,"instance separableClosure.isSeparable : Algebra.IsSeparable F (separableClosure F E) :=
  âŸ¨fun x â†¦ by simpa only [IsSeparable, minpoly_eq] using x.2âŸ©
",Formal Proof of Stacks Project Tag 030K,$E_{sep}/F$ is separable,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/SeparableClosure.lean#L150-L151,Q27041,,9.14.6,lemma,3.0,"['09HD', '09FA', '0ELQ']","\n       \n      \n  Lemma 9.14.6. Let $E/F$ be an algebraic field extension. There exists a unique subextension $E/E_{sep}/F$ such that $E_{sep}/F$ is separable and $E/E_{sep}$ is purely inseparable. \n\n    \n      Proof.\n      If the characteristic is zero we set $E_{sep} = E$. Assume the characteristic is $p > 0$. Let $E_{sep}$ be the set of elements of $E$ which are separable over $F$. This is a subextension by Lemma 9.12.13 and of course $E_{sep}$ is separable over $F$. Given an $\\alpha $ in $E$ there exists a $p$-power $q$ such that $\\alpha ^ q$ is separable over $F$. Namely, $q$ is that power of $p$ such that the minimal polynomial of $\\alpha $ is of the form $P(x^ q)$ with $P$ separable algebraic, see Lemma 9.12.1. Hence $E/E_{sep}$ is purely inseparable. Uniqueness is clear. \n      $\\square$\n    \n",\n       \n      \n  Lemma 9.14.6. Let $E/F$ be an algebraic field extension. There exists a unique subextension $E/E_{sep}/F$ such that $E_{sep}/F$ is separable and $E/E_{sep}$ is purely inseparable. \n\n    \n,"Proof.\n      If the characteristic is zero we set $E_{sep} = E$. Assume the characteristic is $p > 0$. Let $E_{sep}$ be the set of elements of $E$ which are separable over $F$. This is a subextension by Lemma 9.12.13 and of course $E_{sep}$ is separable over $F$. Given an $\\alpha $ in $E$ there exists a $p$-power $q$ such that $\\alpha ^ q$ is separable over $F$. Namely, $q$ is that power of $p$ such that the minimal polynomial of $\\alpha $ is of the form $P(x^ q)$ with $P$ separable algebraic, see Lemma 9.12.1. Hence $E/E_{sep}$ is purely inseparable. Uniqueness is clear. \n      $\\square$\n    \n","
  âŸ¨fun x â†¦ by simpa only [IsSeparable, minpoly_eq] using x.2âŸ©
",instance separableClosure.isSeparable : Algebra.IsSeparable F (separableClosure F E) ,"Proof.\n      If the characteristic is zero we set $E_{sep} = E$. Assume the characteristic is $p > 0$. Let $E_{sep}$ be the set of elements of $E$ which are separable over $F$. This is a subextension by Lemma 9.12.13 [[\n  Lemma 9.12.13. Let $E/k$ be a field extension. Then the elements of $E$ separable over $k$ form a subextension of $E/k$. \n\n    \n]] and of course $E_{sep}$ is separable over $F$. Given an $\\alpha $ in $E$ there exists a $p$-power $q$ such that $\\alpha ^ q$ is separable over $F$. Namely, $q$ is that power of $p$ such that the minimal polynomial of $\\alpha $ is of the form $P(x^ q)$ with $P$ separable algebraic, see Lemma 9.12.1 [[\n  Lemma 9.12.1. Let $F$ be a field. Let $P \\in F[x]$ be an irreducible polynomial over $F$. Let $P\' = \\text{d}P/\\text{d}x$ be the derivative of $P$ with respect to $x$. Then one of the following two cases happens \n  \n  \n$P$ and $P\'$ are relatively prime, or \n\n\n$P\'$ is the zero polynomial. \n\n\n\n   The second case can only happen if $F$ has characteristic $p > 0$. In this case $P(x) = Q(x^ q)$ where $q = p^ f$ is a power of $p$ and $Q \\in F[x]$ is an irreducible polynomial such that $Q$ and $Q\'$ are relatively prime. \n\n    \n]]. Hence $E/E_{sep}$ is purely inseparable. Uniqueness is clear. \n      $\\square$\n    \n"
158,0EXK,"instance separableClosure.isGalois [Normal F E] : IsGalois F (separableClosure F E) where
  to_isSeparable := separableClosure.isSeparable F E
  to_normal := by
    rw [â† separableClosure.normalClosure_eq_self]
    exact normalClosure.normal F _ E
",Formal Proof of Stacks Project Tag 0EXK,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/SeparableClosure.lean#L186-L190,Q27041,,9.15.4,lemma,3.0,"['09HL', '09FA', '0ELQ']","\n  Lemma 9.15.4. Let $E/F$ be a normal algebraic field extension. Then the subextension $E/E_{sep}/F$ of Lemma 9.14.6 is normal. \n\n    \n      Proof.\n      If the characteristic is zero, then $E_{sep} = E$, and the result is clear. If the characteristic is $p > 0$, then $E_{sep}$ is the set of elements of $E$ which are separable over $F$. Then if $\\alpha \\in E_{sep}$ has minimal polynomial $P$ write $P = c(x - \\alpha )(x - \\alpha _2) \\ldots (x - \\alpha _ d)$ with $\\alpha _2, \\ldots , \\alpha _ d \\in E$. Since $P$ is a separable polynomial and since $\\alpha _ i$ is a root of $P$, we conclude $\\alpha _ i \\in E_{sep}$ as desired. \n      $\\square$\n    \n",\n  Lemma 9.15.4. Let $E/F$ be a normal algebraic field extension. Then the subextension $E/E_{sep}/F$ of Lemma 9.14.6 is normal. \n\n    \n,"Proof.\n      If the characteristic is zero, then $E_{sep} = E$, and the result is clear. If the characteristic is $p > 0$, then $E_{sep}$ is the set of elements of $E$ which are separable over $F$. Then if $\\alpha \\in E_{sep}$ has minimal polynomial $P$ write $P = c(x - \\alpha )(x - \\alpha _2) \\ldots (x - \\alpha _ d)$ with $\\alpha _2, \\ldots , \\alpha _ d \\in E$. Since $P$ is a separable polynomial and since $\\alpha _ i$ is a root of $P$, we conclude $\\alpha _ i \\in E_{sep}$ as desired. \n      $\\square$\n    \n"," separableClosure.isSeparable F E
  to_normal := by
    rw [â† separableClosure.normalClosure_eq_self]
    exact normalClosure.normal F _ E
","instance separableClosure.isGalois [Normal F E] : IsGalois F (separableClosure F E) where
  to_isSeparable ","Proof.\n      If the characteristic is zero, then $E_{sep} = E$, and the result is clear. If the characteristic is $p > 0$, then $E_{sep}$ is the set of elements of $E$ which are separable over $F$. Then if $\\alpha \\in E_{sep}$ has minimal polynomial $P$ write $P = c(x - \\alpha )(x - \\alpha _2) \\ldots (x - \\alpha _ d)$ with $\\alpha _2, \\ldots , \\alpha _ d \\in E$. Since $P$ is a separable polynomial and since $\\alpha _ i$ is a root of $P$, we conclude $\\alpha _ i \\in E_{sep}$ as desired. \n      $\\square$\n    \n"
159,030L,"def sepDegree := Module.rank F (separableClosure F E)
",Formal Proof of Stacks Project Tag 030L,Part 1,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/SeparableClosure.lean#L296-L296,Q27041,,9.14.7,definition,3.0,"['09HD', '09FA', '0ELQ']","\n  Definition 9.14.7. Let $E/F$ be an algebraic field extension. Let $E_{sep}$ be the subextension found in Lemma 9.14.6. \n  \n  \nThe integer $[E_{sep} : F]$ is called the separable degree of the extension. Notation $[E : F]_ s$. \n\n\nThe integer $[E : E_{sep}]$ is called the inseparable degree, or the degree of inseparability of the extension. Notation $[E : F]_ i$. \n\n\n\n","\n  Definition 9.14.7. Let $E/F$ be an algebraic field extension. Let $E_{sep}$ be the subextension found in Lemma 9.14.6. \n  \n  \nThe integer $[E_{sep} : F]$ is called the separable degree of the extension. Notation $[E : F]_ s$. \n\n\nThe integer $[E : E_{sep}]$ is called the inseparable degree, or the degree of inseparability of the extension. Notation $[E : F]_ i$. \n\n\n\n",," Module.rank F (separableClosure F E)
",def sepDegree ,
160,030L,"def insepDegree := Module.rank (separableClosure F E) E
",Formal Proof of Stacks Project Tag 030L,Part 2,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/SeparableClosure.lean#L301-L301,Q27041,,9.14.7,definition,3.0,"['09HD', '09FA', '0ELQ']","\n  Definition 9.14.7. Let $E/F$ be an algebraic field extension. Let $E_{sep}$ be the subextension found in Lemma 9.14.6. \n  \n  \nThe integer $[E_{sep} : F]$ is called the separable degree of the extension. Notation $[E : F]_ s$. \n\n\nThe integer $[E : E_{sep}]$ is called the inseparable degree, or the degree of inseparability of the extension. Notation $[E : F]_ i$. \n\n\n\n","\n  Definition 9.14.7. Let $E/F$ be an algebraic field extension. Let $E_{sep}$ be the subextension found in Lemma 9.14.6. \n  \n  \nThe integer $[E_{sep} : F]$ is called the separable degree of the extension. Notation $[E : F]_ s$. \n\n\nThe integer $[E : E_{sep}]$ is called the inseparable degree, or the degree of inseparability of the extension. Notation $[E : F]_ i$. \n\n\n\n",," Module.rank (separableClosure F E) E
",def insepDegree ,
161,09HJ,"theorem finSepDegree_eq_of_isAlgClosed [Algebra.IsAlgebraic F E] [IsAlgClosed K] :
    finSepDegree F E = Nat.card (E â†’â‚[F] K) := Nat.card_congr (embEquivOfIsAlgClosed F E K)
",Formal Proof of Stacks Project Tag 09HJ,We use `finSepDegree` to state a more general result.,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/SeparableDegree.lean#L233-L234,Q27041,,9.14.8,lemma,3.0,"['09HD', '09FA', '0ELQ']","\n  Lemma 9.14.8. Let $K/F$ be a finite extension. Let $\\overline{F}$ be an algebraic closure of $F$. Then $[K : F]_ s = |\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})|$. \n\n    \n      Proof.\n      We first prove this when $K/F$ is purely inseparable. Namely, we claim that in this case there is a unique map $K \\to \\overline{F}$. This can be seen by choosing a sequence of elements $\\alpha _1, \\ldots , \\alpha _ n \\in K$ as in Lemma 9.14.5. The irreducible polynomial of $\\alpha _ i$ over $F(\\alpha _1, \\ldots , \\alpha _{i - 1})$ is $x^ p - \\alpha _ i^ p$. Applying Lemma 9.12.9 we see that $|\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})| = 1$. On the other hand, $[K : F]_ s = 1$ in this case hence the equality holds. \n    \n      Let\'s return to a general finite extension $K/F$. In this case choose $F \\subset K_ s \\subset K$ as in Lemma 9.14.6. By Lemma 9.12.11 we have $|\\mathop{\\mathrm{Mor}}\\nolimits _ F(K_ s, \\overline{F})| = [K_ s : F] = [K : F]_ s$. On the other hand, every field map $\\sigma \' : K_ s \\to \\overline{F}$ extends to a unique field map $\\sigma : K \\to \\overline{F}$ by the result of the previous paragraph. In other words $|\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})| = |\\mathop{\\mathrm{Mor}}\\nolimits _ F(K_ s, \\overline{F})|$ and the proof is done. \n      $\\square$\n    \n","\n  Lemma 9.14.8. Let $K/F$ be a finite extension. Let $\\overline{F}$ be an algebraic closure of $F$. Then $[K : F]_ s = |\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})|$. \n\n    \n","Proof.\n      We first prove this when $K/F$ is purely inseparable. Namely, we claim that in this case there is a unique map $K \\to \\overline{F}$. This can be seen by choosing a sequence of elements $\\alpha _1, \\ldots , \\alpha _ n \\in K$ as in Lemma 9.14.5. The irreducible polynomial of $\\alpha _ i$ over $F(\\alpha _1, \\ldots , \\alpha _{i - 1})$ is $x^ p - \\alpha _ i^ p$. Applying Lemma 9.12.9 we see that $|\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})| = 1$. On the other hand, $[K : F]_ s = 1$ in this case hence the equality holds. \n    \n      Let\'s return to a general finite extension $K/F$. In this case choose $F \\subset K_ s \\subset K$ as in Lemma 9.14.6. By Lemma 9.12.11 we have $|\\mathop{\\mathrm{Mor}}\\nolimits _ F(K_ s, \\overline{F})| = [K_ s : F] = [K : F]_ s$. On the other hand, every field map $\\sigma \' : K_ s \\to \\overline{F}$ extends to a unique field map $\\sigma : K \\to \\overline{F}$ by the result of the previous paragraph. In other words $|\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})| = |\\mathop{\\mathrm{Mor}}\\nolimits _ F(K_ s, \\overline{F})|$ and the proof is done. \n      $\\square$\n    \n"," Nat.card_congr (embEquivOfIsAlgClosed F E K)
","theorem finSepDegree_eq_of_isAlgClosed [Algebra.IsAlgebraic F E] [IsAlgClosed K] :
    finSepDegree F E = Nat.card (E â†’â‚[F] K) ","Proof.\n      We first prove this when $K/F$ is purely inseparable. Namely, we claim that in this case there is a unique map $K \\to \\overline{F}$. This can be seen by choosing a sequence of elements $\\alpha _1, \\ldots , \\alpha _ n \\in K$ as in Lemma 9.14.5 [[\n  Lemma 9.14.5. Let $E/F$ be a finite purely inseparable field extension of characteristic $p > 0$. Then there exists a sequence of elements $\\alpha _1, \\ldots , \\alpha _ n \\in E$ such that we obtain a tower of fields \n  \n  \\[  E = F(\\alpha _1, \\ldots , \\alpha _ n) \\supset F(\\alpha _1, \\ldots , \\alpha _{n - 1}) \\supset \\ldots \\supset F(\\alpha _1) \\supset F  \\]\n\n   such that each intermediate extension is of degree $p$ and comes from adjoining a $p$th root. Namely, $\\alpha _ i^ p \\in F(\\alpha _1, \\ldots , \\alpha _{i - 1})$ is an element which does not have a $p$th root in $F(\\alpha _1, \\ldots , \\alpha _{i - 1})$ for $i = 1, \\ldots , n$. \n\n    \n]]. The irreducible polynomial of $\\alpha _ i$ over $F(\\alpha _1, \\ldots , \\alpha _{i - 1})$ is $x^ p - \\alpha _ i^ p$. Applying Lemma 9.12.9 [[\n  Lemma 9.12.9. In Situation 9.12.7 we have $|\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})| = \\prod _{i = 1}^ n \\deg _ s(P_ i)$. \n\n    \n]] we see that $|\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})| = 1$. On the other hand, $[K : F]_ s = 1$ in this case hence the equality holds. \n    \n      Let\'s return to a general finite extension $K/F$. In this case choose $F \\subset K_ s \\subset K$ as in Lemma 9.14.6 [[\n       \n      \n  Lemma 9.14.6. Let $E/F$ be an algebraic field extension. There exists a unique subextension $E/E_{sep}/F$ such that $E_{sep}/F$ is separable and $E/E_{sep}$ is purely inseparable. \n\n    \n]]. By Lemma 9.12.11 [[\n  Lemma 9.12.11. Let $K/F$ be a finite extension of fields. Let $\\overline{F}$ be an algebraic closure of $F$. Then we have \n  \n  \\[  |\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})| \\leq [K : F]  \\]\n\n   with equality if and only if $K$ is separable over $F$. \n\n    \n]] we have $|\\mathop{\\mathrm{Mor}}\\nolimits _ F(K_ s, \\overline{F})| = [K_ s : F] = [K : F]_ s$. On the other hand, every field map $\\sigma \' : K_ s \\to \\overline{F}$ extends to a unique field map $\\sigma : K \\to \\overline{F}$ by the result of the previous paragraph. In other words $|\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})| = |\\mathop{\\mathrm{Mor}}\\nolimits _ F(K_ s, \\overline{F})|$ and the proof is done. \n      $\\square$\n    \n"
162,09HK,"theorem finSepDegree_mul_finSepDegree_of_isAlgebraic
    [Algebra E K] [IsScalarTower F E K] [Algebra.IsAlgebraic E K] :
    finSepDegree F E * finSepDegree E K = finSepDegree F K := by
  simpa only [Nat.card_prod] using Nat.card_congr (embProdEmbOfIsAlgebraic F E K)
",Formal Proof of Stacks Project Tag 09HK,"Part 1, `finSepDegree` variant",https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/SeparableDegree.lean#L282-L285,Q27041,Multiplicativity,9.14.9,lemma,3.0,"['09HD', '09FA', '0ELQ']","\n  Lemma 9.14.9 (Multiplicativity).  Suppose given a tower of algebraic field extensions $K/E/F$. Then \n  \n  \\[  [K : F]_ s = [K : E]_ s [E : F]_ s \\quad \\text{and}\\quad [K : F]_ i = [K : E]_ i [E : F]_ i  \\]\n\n\n    \n      Proof.\n      We first prove this in case $K$ is finite over $F$. Since we have multiplicativity for the usual degree (by Lemma 9.7.7) it suffices to prove one of the two formulas. By Lemma 9.14.8 we have $[K : F]_ s = |\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})|$. By the same lemma, given any $\\sigma \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})$ the number of extensions of $\\sigma $ to a map $\\tau : K \\to \\overline{F}$ is $[K : E]_ s$. Namely, via $E \\cong \\sigma (E) \\subset \\overline{F}$ we can view $\\overline{F}$ as an algebraic closure of $E$. Combined with the fact that there are $[E : F]_ s = |\\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})|$ choices for $\\sigma $ we obtain the result. \n    \n      We omit the proof if the extensions are infinite. \n      $\\square$\n    \n",\n  Lemma 9.14.9 (Multiplicativity).  Suppose given a tower of algebraic field extensions $K/E/F$. Then \n  \n  \\[  [K : F]_ s = [K : E]_ s [E : F]_ s \\quad \\text{and}\\quad [K : F]_ i = [K : E]_ i [E : F]_ i  \\]\n\n\n    \n,"Proof.\n      We first prove this in case $K$ is finite over $F$. Since we have multiplicativity for the usual degree (by Lemma 9.7.7) it suffices to prove one of the two formulas. By Lemma 9.14.8 we have $[K : F]_ s = |\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})|$. By the same lemma, given any $\\sigma \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})$ the number of extensions of $\\sigma $ to a map $\\tau : K \\to \\overline{F}$ is $[K : E]_ s$. Namely, via $E \\cong \\sigma (E) \\subset \\overline{F}$ we can view $\\overline{F}$ as an algebraic closure of $E$. Combined with the fact that there are $[E : F]_ s = |\\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})|$ choices for $\\sigma $ we obtain the result. \n    \n      We omit the proof if the extensions are infinite. \n      $\\square$\n    \n"," by
  simpa only [Nat.card_prod] using Nat.card_congr (embProdEmbOfIsAlgebraic F E K)
","theorem finSepDegree_mul_finSepDegree_of_isAlgebraic
    [Algebra E K] [IsScalarTower F E K] [Algebra.IsAlgebraic E K] :
    finSepDegree F E * finSepDegree E K = finSepDegree F K ","Proof.\n      We first prove this in case $K$ is finite over $F$. Since we have multiplicativity for the usual degree (by Lemma 9.7.7 [[\n  Lemma 9.7.7 (Multiplicativity).  Suppose given a tower of fields $F/E/k$. Then \n  \n  \\[  [F:k] = [F:E][E:k]  \\]\n\n\n    \n]]) it suffices to prove one of the two formulas. By Lemma 9.14.8 [[\n  Lemma 9.14.8. Let $K/F$ be a finite extension. Let $\\overline{F}$ be an algebraic closure of $F$. Then $[K : F]_ s = |\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})|$. \n\n    \n]] we have $[K : F]_ s = |\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})|$. By the same lemma, given any $\\sigma \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})$ the number of extensions of $\\sigma $ to a map $\\tau : K \\to \\overline{F}$ is $[K : E]_ s$. Namely, via $E \\cong \\sigma (E) \\subset \\overline{F}$ we can view $\\overline{F}$ as an algebraic closure of $E$. Combined with the fact that there are $[E : F]_ s = |\\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})|$ choices for $\\sigma $ we obtain the result. \n    \n      We omit the proof if the extensions are infinite. \n      $\\square$\n    \n"
163,09HA,"theorem finSepDegree_le_finrank [FiniteDimensional F E] :
    finSepDegree F E â‰¤ finrank F E := Nat.le_of_dvd finrank_pos <| finSepDegree_dvd_finrank F E
",Formal Proof of Stacks Project Tag 09HA,The inequality,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/SeparableDegree.lean#L741-L742,Q27041,,9.12.11,lemma,3.0,"['09GZ', '09FA', '0ELQ']","\n  Lemma 9.12.11. Let $K/F$ be a finite extension of fields. Let $\\overline{F}$ be an algebraic closure of $F$. Then we have \n  \n  \\[  |\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})| \\leq [K : F]  \\]\n\n   with equality if and only if $K$ is separable over $F$. \n\n    \n      Proof.\n      This is a corollary of Lemma 9.12.10. Namely, since $K/F$ is finite we can find finitely many elements $\\alpha _1, \\ldots , \\alpha _ n \\in K$ generating $K$ over $F$ (for example we can choose the $\\alpha _ i$ to be a basis of $K$ over $F$). If $K/F$ is separable, then each $\\alpha _ i$ is separable over $F(\\alpha _1, \\ldots , \\alpha _{i - 1})$ by Lemma 9.12.3 and we get equality by Lemma 9.12.10. On the other hand, if we have equality, then no matter how we choose $\\alpha _1, \\ldots , \\alpha _ n$ we get that $\\alpha _1$ is separable over $F$ by Lemma 9.12.10. Since we can start the sequence with an arbitrary element of $K$ it follows that $K$ is separable over $F$. \n      $\\square$\n    \n","\n  Lemma 9.12.11. Let $K/F$ be a finite extension of fields. Let $\\overline{F}$ be an algebraic closure of $F$. Then we have \n  \n  \\[  |\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})| \\leq [K : F]  \\]\n\n   with equality if and only if $K$ is separable over $F$. \n\n    \n","Proof.\n      This is a corollary of Lemma 9.12.10. Namely, since $K/F$ is finite we can find finitely many elements $\\alpha _1, \\ldots , \\alpha _ n \\in K$ generating $K$ over $F$ (for example we can choose the $\\alpha _ i$ to be a basis of $K$ over $F$). If $K/F$ is separable, then each $\\alpha _ i$ is separable over $F(\\alpha _1, \\ldots , \\alpha _{i - 1})$ by Lemma 9.12.3 and we get equality by Lemma 9.12.10. On the other hand, if we have equality, then no matter how we choose $\\alpha _1, \\ldots , \\alpha _ n$ we get that $\\alpha _1$ is separable over $F$ by Lemma 9.12.10. Since we can start the sequence with an arbitrary element of $K$ it follows that $K$ is separable over $F$. \n      $\\square$\n    \n"," Nat.le_of_dvd finrank_pos <| finSepDegree_dvd_finrank F E
","theorem finSepDegree_le_finrank [FiniteDimensional F E] :
    finSepDegree F E â‰¤ finrank F E ","Proof.\n      This is a corollary of Lemma 9.12.10 [[\n  Lemma 9.12.10. Assumptions and notation as in Situation 9.12.7. If each $P_ i$ is separable, i.e., each $\\alpha _ i$ is separable over $K_{i - 1}$, then \n  \n  \\[  |\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})| = [K : F]  \\]\n\n   and the field extension $K/F$ is separable. If one of the $\\alpha _ i$ is not separable over $K_{i - 1}$, then $|\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})| < [K : F]$. \n\n    \n]]. Namely, since $K/F$ is finite we can find finitely many elements $\\alpha _1, \\ldots , \\alpha _ n \\in K$ generating $K$ over $F$ (for example we can choose the $\\alpha _ i$ to be a basis of $K$ over $F$). If $K/F$ is separable, then each $\\alpha _ i$ is separable over $F(\\alpha _1, \\ldots , \\alpha _{i - 1})$ by Lemma 9.12.3 [[\n  Lemma 9.12.3. Let $K/E/F$ be a tower of algebraic field extensions. \n  \n  \nIf $\\alpha \\in K$ is separable over $F$, then $\\alpha $ is separable over $E$. \n\n\nif $K$ is separable over $F$, then $K$ is separable over $E$. \n\n\n\n\n    \n]] and we get equality by Lemma 9.12.10 [[\n  Lemma 9.12.10. Assumptions and notation as in Situation 9.12.7. If each $P_ i$ is separable, i.e., each $\\alpha _ i$ is separable over $K_{i - 1}$, then \n  \n  \\[  |\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})| = [K : F]  \\]\n\n   and the field extension $K/F$ is separable. If one of the $\\alpha _ i$ is not separable over $K_{i - 1}$, then $|\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})| < [K : F]$. \n\n    \n]]. On the other hand, if we have equality, then no matter how we choose $\\alpha _1, \\ldots , \\alpha _ n$ we get that $\\alpha _1$ is separable over $F$ by Lemma 9.12.10 [[\n  Lemma 9.12.10. Assumptions and notation as in Situation 9.12.7. If each $P_ i$ is separable, i.e., each $\\alpha _ i$ is separable over $K_{i - 1}$, then \n  \n  \\[  |\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})| = [K : F]  \\]\n\n   and the field extension $K/F$ is separable. If one of the $\\alpha _ i$ is not separable over $K_{i - 1}$, then $|\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})| < [K : F]$. \n\n    \n]]. Since we can start the sequence with an arbitrary element of $K$ it follows that $K$ is separable over $F$. \n      $\\square$\n    \n"
164,09HA,"theorem finSepDegree_eq_finrank_iff [FiniteDimensional F E] :
    finSepDegree F E = finrank F E â†” Algebra.IsSeparable F E :=
  âŸ¨fun heq â†¦ âŸ¨fun x â†¦ by
    have halg := IsAlgebraic.of_finite F x
    refine (finSepDegree_adjoin_simple_eq_finrank_iff F E x halg).1 <| le_antisymm
      (finSepDegree_adjoin_simple_le_finrank F E x halg) <| le_of_not_gt fun h â†¦ ?_
    have := Nat.mul_lt_mul_of_lt_of_le' h (finSepDegree_le_finrank FâŸ®xâŸ¯ E) Fin.pos'
    rw [finSepDegree_mul_finSepDegree_of_isAlgebraic F FâŸ®xâŸ¯ E,
      Module.finrank_mul_finrank F FâŸ®xâŸ¯ E] at this
    linarith only [heq, this]âŸ©, fun _ â†¦ finSepDegree_eq_finrank_of_isSeparable F EâŸ©
",Formal Proof of Stacks Project Tag 09HA,The equality condition,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/SeparableDegree.lean#L773-L782,Q27041,,9.12.11,lemma,3.0,"['09GZ', '09FA', '0ELQ']","\n  Lemma 9.12.11. Let $K/F$ be a finite extension of fields. Let $\\overline{F}$ be an algebraic closure of $F$. Then we have \n  \n  \\[  |\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})| \\leq [K : F]  \\]\n\n   with equality if and only if $K$ is separable over $F$. \n\n    \n      Proof.\n      This is a corollary of Lemma 9.12.10. Namely, since $K/F$ is finite we can find finitely many elements $\\alpha _1, \\ldots , \\alpha _ n \\in K$ generating $K$ over $F$ (for example we can choose the $\\alpha _ i$ to be a basis of $K$ over $F$). If $K/F$ is separable, then each $\\alpha _ i$ is separable over $F(\\alpha _1, \\ldots , \\alpha _{i - 1})$ by Lemma 9.12.3 and we get equality by Lemma 9.12.10. On the other hand, if we have equality, then no matter how we choose $\\alpha _1, \\ldots , \\alpha _ n$ we get that $\\alpha _1$ is separable over $F$ by Lemma 9.12.10. Since we can start the sequence with an arbitrary element of $K$ it follows that $K$ is separable over $F$. \n      $\\square$\n    \n","\n  Lemma 9.12.11. Let $K/F$ be a finite extension of fields. Let $\\overline{F}$ be an algebraic closure of $F$. Then we have \n  \n  \\[  |\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})| \\leq [K : F]  \\]\n\n   with equality if and only if $K$ is separable over $F$. \n\n    \n","Proof.\n      This is a corollary of Lemma 9.12.10. Namely, since $K/F$ is finite we can find finitely many elements $\\alpha _1, \\ldots , \\alpha _ n \\in K$ generating $K$ over $F$ (for example we can choose the $\\alpha _ i$ to be a basis of $K$ over $F$). If $K/F$ is separable, then each $\\alpha _ i$ is separable over $F(\\alpha _1, \\ldots , \\alpha _{i - 1})$ by Lemma 9.12.3 and we get equality by Lemma 9.12.10. On the other hand, if we have equality, then no matter how we choose $\\alpha _1, \\ldots , \\alpha _ n$ we get that $\\alpha _1$ is separable over $F$ by Lemma 9.12.10. Since we can start the sequence with an arbitrary element of $K$ it follows that $K$ is separable over $F$. \n      $\\square$\n    \n","
  âŸ¨fun heq â†¦ âŸ¨fun x â†¦ by
    have halg := IsAlgebraic.of_finite F x
    refine (finSepDegree_adjoin_simple_eq_finrank_iff F E x halg).1 <| le_antisymm
      (finSepDegree_adjoin_simple_le_finrank F E x halg) <| le_of_not_gt fun h â†¦ ?_
    have := Nat.mul_lt_mul_of_lt_of_le' h (finSepDegree_le_finrank FâŸ®xâŸ¯ E) Fin.pos'
    rw [finSepDegree_mul_finSepDegree_of_isAlgebraic F FâŸ®xâŸ¯ E,
      Module.finrank_mul_finrank F FâŸ®xâŸ¯ E] at this
    linarith only [heq, this]âŸ©, fun _ â†¦ finSepDegree_eq_finrank_of_isSeparable F EâŸ©
","theorem finSepDegree_eq_finrank_iff [FiniteDimensional F E] :
    finSepDegree F E = finrank F E â†” Algebra.IsSeparable F E ","Proof.\n      This is a corollary of Lemma 9.12.10 [[\n  Lemma 9.12.10. Assumptions and notation as in Situation 9.12.7. If each $P_ i$ is separable, i.e., each $\\alpha _ i$ is separable over $K_{i - 1}$, then \n  \n  \\[  |\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})| = [K : F]  \\]\n\n   and the field extension $K/F$ is separable. If one of the $\\alpha _ i$ is not separable over $K_{i - 1}$, then $|\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})| < [K : F]$. \n\n    \n]]. Namely, since $K/F$ is finite we can find finitely many elements $\\alpha _1, \\ldots , \\alpha _ n \\in K$ generating $K$ over $F$ (for example we can choose the $\\alpha _ i$ to be a basis of $K$ over $F$). If $K/F$ is separable, then each $\\alpha _ i$ is separable over $F(\\alpha _1, \\ldots , \\alpha _{i - 1})$ by Lemma 9.12.3 [[\n  Lemma 9.12.3. Let $K/E/F$ be a tower of algebraic field extensions. \n  \n  \nIf $\\alpha \\in K$ is separable over $F$, then $\\alpha $ is separable over $E$. \n\n\nif $K$ is separable over $F$, then $K$ is separable over $E$. \n\n\n\n\n    \n]] and we get equality by Lemma 9.12.10 [[\n  Lemma 9.12.10. Assumptions and notation as in Situation 9.12.7. If each $P_ i$ is separable, i.e., each $\\alpha _ i$ is separable over $K_{i - 1}$, then \n  \n  \\[  |\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})| = [K : F]  \\]\n\n   and the field extension $K/F$ is separable. If one of the $\\alpha _ i$ is not separable over $K_{i - 1}$, then $|\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})| < [K : F]$. \n\n    \n]]. On the other hand, if we have equality, then no matter how we choose $\\alpha _1, \\ldots , \\alpha _ n$ we get that $\\alpha _1$ is separable over $F$ by Lemma 9.12.10 [[\n  Lemma 9.12.10. Assumptions and notation as in Situation 9.12.7. If each $P_ i$ is separable, i.e., each $\\alpha _ i$ is separable over $K_{i - 1}$, then \n  \n  \\[  |\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})| = [K : F]  \\]\n\n   and the field extension $K/F$ is separable. If one of the $\\alpha _ i$ is not separable over $K_{i - 1}$, then $|\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})| < [K : F]$. \n\n    \n]]. Since we can start the sequence with an arbitrary element of $K$ it follows that $K$ is separable over $F$. \n      $\\square$\n    \n"
165,09HB,"theorem Algebra.IsSeparable.trans [Algebra E K] [IsScalarTower F E K]
    [Algebra.IsSeparable F E] [Algebra.IsSeparable E K] : Algebra.IsSeparable F K :=
  âŸ¨fun x â†¦ IsSeparable.of_algebra_isSeparable_of_isSeparable F
    (Algebra.IsSeparable.isSeparable E x)âŸ©
",Formal Proof of Stacks Project Tag 09HB,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/SeparableDegree.lean#L834-L837,Q27041,,9.12.12,lemma,3.0,"['09GZ', '09FA', '0ELQ']","\n  Lemma 9.12.12. Let $E/k$ and $F/E$ be separable algebraic extensions of fields. Then $F/k$ is a separable extension of fields. \n\n    \n      Proof.\n      Choose $\\alpha \\in F$. Then $\\alpha $ is separable algebraic over $E$. Let $P = x^ d + \\sum _{i < d} a_ i x^ i$ be the minimal polynomial of $\\alpha $ over $E$. Each $a_ i$ is separable algebraic over $k$. Consider the tower of fields \n    \n      \n  \\[  k \\subset k(a_0) \\subset k(a_0, a_1) \\subset \\ldots \\subset k(a_0, \\ldots , a_{d - 1}) \\subset k(a_0, \\ldots , a_{d - 1}, \\alpha )  \\]\n\n    \n       Because $a_ i$ is separable algebraic over $k$ it is separable algebraic over $k(a_0, \\ldots , a_{i - 1})$ by Lemma 9.12.3. Finally, $\\alpha $ is separable algebraic over $k(a_0, \\ldots , a_{d - 1})$ because it is a root of $P$ which is irreducible (as it is irreducible over the possibly bigger field $E$) and separable (as it is separable over $E$). Thus $k(a_0, \\ldots , a_{d - 1}, \\alpha )$ is separable over $k$ by Lemma 9.12.10 and we conclude that $\\alpha $ is separable over $k$ as desired. \n      $\\square$\n    \n",\n  Lemma 9.12.12. Let $E/k$ and $F/E$ be separable algebraic extensions of fields. Then $F/k$ is a separable extension of fields. \n\n    \n,"Proof.\n      Choose $\\alpha \\in F$. Then $\\alpha $ is separable algebraic over $E$. Let $P = x^ d + \\sum _{i < d} a_ i x^ i$ be the minimal polynomial of $\\alpha $ over $E$. Each $a_ i$ is separable algebraic over $k$. Consider the tower of fields \n    \n      \n  \\[  k \\subset k(a_0) \\subset k(a_0, a_1) \\subset \\ldots \\subset k(a_0, \\ldots , a_{d - 1}) \\subset k(a_0, \\ldots , a_{d - 1}, \\alpha )  \\]\n\n    \n       Because $a_ i$ is separable algebraic over $k$ it is separable algebraic over $k(a_0, \\ldots , a_{i - 1})$ by Lemma 9.12.3. Finally, $\\alpha $ is separable algebraic over $k(a_0, \\ldots , a_{d - 1})$ because it is a root of $P$ which is irreducible (as it is irreducible over the possibly bigger field $E$) and separable (as it is separable over $E$). Thus $k(a_0, \\ldots , a_{d - 1}, \\alpha )$ is separable over $k$ by Lemma 9.12.10 and we conclude that $\\alpha $ is separable over $k$ as desired. \n      $\\square$\n    \n","
  âŸ¨fun x â†¦ IsSeparable.of_algebra_isSeparable_of_isSeparable F
    (Algebra.IsSeparable.isSeparable E x)âŸ©
","theorem Algebra.IsSeparable.trans [Algebra E K] [IsScalarTower F E K]
    [Algebra.IsSeparable F E] [Algebra.IsSeparable E K] : Algebra.IsSeparable F K ","Proof.\n      Choose $\\alpha \\in F$. Then $\\alpha $ is separable algebraic over $E$. Let $P = x^ d + \\sum _{i < d} a_ i x^ i$ be the minimal polynomial of $\\alpha $ over $E$. Each $a_ i$ is separable algebraic over $k$. Consider the tower of fields \n    \n      \n  \\[  k \\subset k(a_0) \\subset k(a_0, a_1) \\subset \\ldots \\subset k(a_0, \\ldots , a_{d - 1}) \\subset k(a_0, \\ldots , a_{d - 1}, \\alpha )  \\]\n\n    \n       Because $a_ i$ is separable algebraic over $k$ it is separable algebraic over $k(a_0, \\ldots , a_{i - 1})$ by Lemma 9.12.3 [[\n  Lemma 9.12.3. Let $K/E/F$ be a tower of algebraic field extensions. \n  \n  \nIf $\\alpha \\in K$ is separable over $F$, then $\\alpha $ is separable over $E$. \n\n\nif $K$ is separable over $F$, then $K$ is separable over $E$. \n\n\n\n\n    \n]]. Finally, $\\alpha $ is separable algebraic over $k(a_0, \\ldots , a_{d - 1})$ because it is a root of $P$ which is irreducible (as it is irreducible over the possibly bigger field $E$) and separable (as it is separable over $E$). Thus $k(a_0, \\ldots , a_{d - 1}, \\alpha )$ is separable over $k$ by Lemma 9.12.10 [[\n  Lemma 9.12.10. Assumptions and notation as in Situation 9.12.7. If each $P_ i$ is separable, i.e., each $\\alpha _ i$ is separable over $K_{i - 1}$, then \n  \n  \\[  |\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})| = [K : F]  \\]\n\n   and the field extension $K/F$ is separable. If one of the $\\alpha _ i$ is not separable over $K_{i - 1}$, then $|\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})| < [K : F]$. \n\n    \n]] and we conclude that $\\alpha $ is separable over $k$ as desired. \n      $\\square$\n    \n"
166,0H71,"lemma exists_isTranscendenceBasis_and_isSeparable_of_linearIndepOn_pow_of_adjoin_eq_top
    (ha : IntermediateField.adjoin k (Set.range a) = âŠ¤)
    (ha' : IsTranscendenceBasis k fun i : {i // i â‰  n} â†¦ a i) :
    âˆƒ i : Î¹, IsTranscendenceBasis k (fun j : {j // j â‰  i} â†¦ a j) âˆ§
      Algebra.IsSeparable (adjoin k (a '' {i}á¶œ)) K := by
  have âŸ¨i, hiâŸ© := exists_isTranscendenceBasis_and_isSeparable_of_linearIndepOn_pow p hp H n ha'
  refine âŸ¨i, hi.1, ?_âŸ©
  rw [â† separableClosure.eq_top_iff, â† (restrictScalars_injective k).eq_iff,
    restrictScalars_top, eq_top_iff, â† ha, adjoin_le_iff]
  rintro _ âŸ¨x, rflâŸ©
  obtain rfl | ne := eq_or_ne x i
  Â· exact hi.2
  Â· exact isSeparable_algebraMap (F := adjoin k (a '' {i}á¶œ)) âŸ¨_, subset_adjoin _ _ âŸ¨x, ne, rflâŸ©âŸ©
",Formal Proof of Stacks Project Tag 0H71,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/SeparablyGenerated.lean#L255-L267,Q27041,,10.44.1,lemma,3.0,"['05DT', '00AO', '0ELQ']","\n  Lemma 10.44.1. Let $k$ be a field of characteristic $p > 1$. Let $K/k$ be a field extension generated by $x_1, \\ldots , x_{n + 1} \\in K$ such that \n  \n  \n$\\{ x_1, \\ldots , x_ n\\} $ is a transcendence base of $K/k$, \n\n\nfor every $k$-linearly independent subset $\\{ a_1, \\ldots , a_ m\\} $ of $K$ the set $\\{ a^ p_1, \\ldots , a_ m^ p\\} $ is $k$-linearly independent. \n\n\n\n   Then there is $1 \\leq j \\leq n+1$ such that $\\{  x_1, \\ldots , \\widehat{x}_ j, \\ldots , x_{n+1}\\} $ is a separating transcendence base for $K / k$. \n\n    \n      Proof.\n      By assumption $x_{n + 1}$ is algebraic over $k(x_1, \\ldots , x_ n)$ so there exists a non-zero polynomial $F \\in k[X_1, \\ldots , X_{n + 1}]$ such that $F(x_1, \\ldots , x_{n+1}) = 0$. Choose $F$ of minimal total degree. Then $F$ is irreducible, because at least one irreducible factor must also have the same property. \n    \n      We claim that, for some $i$, not all powers of $X_ i$ appearing in $F$ are multiples of $p$. Suppose for a contradiction that all the exponents appearing in $F$ were multiples of $p$, then the set \n    \n      \n  \\[  \\{ x_1^{\\alpha _1} \\ldots x^{\\alpha _{n+1}}_{n+1} \\mid \\lambda _\\alpha \\neq 0\\}  \\subset K  \\]\n\n    \n       is $k$-linearly dependent where $\\lambda _\\alpha $ are the coefficients of $F$. By assumption (2) we conclude the set \n    \n      \n  \\[  \\{ x_1^{\\alpha _1 / p} \\ldots x^{\\alpha _{n+1} / p}_{n+1} \\mid \\lambda _\\alpha \\neq 0 \\}   \\]\n\n    \n       is also $k$-linearly dependent, contradicting minimality of $\\deg (F)$. \n    \n      Choose $i$ for which a non-$p$th power of $X_ i$ appears in $F$. Then we see that $x_ i$ is algebraic over $L = k(x_1, \\ldots , x_{i - 1}, x_{i + 1}, \\ldots , x_{n+1})$. By Fields, Lemma 9.26.3 we see that $x_1, \\ldots , x_{i - 1}, x_{i + 1}, \\ldots , x_{n+1}$ is a transcendence base of $K/k$. Thus $L$ is the fraction field of the polynomial ring over $k$ in $x_1, \\ldots , x_{i - 1}, x_{i + 1}, \\ldots , x_{n + 1}$. By Gauss\' Lemma we conclude that \n    \n      \n  \\[  P(T) = F(x_1, \\ldots , x_{i - 1}, T, x_{i + 1}, \\ldots , x_{n + 1}) \\in L[T]  \\]\n\n    \n       is irreducible. By construction $P(T)$ is not contained in $L[T^ p]$. Hence $K/L$ is separable as required. \n      $\\square$\n    \n","\n  Lemma 10.44.1. Let $k$ be a field of characteristic $p > 1$. Let $K/k$ be a field extension generated by $x_1, \\ldots , x_{n + 1} \\in K$ such that \n  \n  \n$\\{ x_1, \\ldots , x_ n\\} $ is a transcendence base of $K/k$, \n\n\nfor every $k$-linearly independent subset $\\{ a_1, \\ldots , a_ m\\} $ of $K$ the set $\\{ a^ p_1, \\ldots , a_ m^ p\\} $ is $k$-linearly independent. \n\n\n\n   Then there is $1 \\leq j \\leq n+1$ such that $\\{  x_1, \\ldots , \\widehat{x}_ j, \\ldots , x_{n+1}\\} $ is a separating transcendence base for $K / k$. \n\n    \n","Proof.\n      By assumption $x_{n + 1}$ is algebraic over $k(x_1, \\ldots , x_ n)$ so there exists a non-zero polynomial $F \\in k[X_1, \\ldots , X_{n + 1}]$ such that $F(x_1, \\ldots , x_{n+1}) = 0$. Choose $F$ of minimal total degree. Then $F$ is irreducible, because at least one irreducible factor must also have the same property. \n    \n      We claim that, for some $i$, not all powers of $X_ i$ appearing in $F$ are multiples of $p$. Suppose for a contradiction that all the exponents appearing in $F$ were multiples of $p$, then the set \n    \n      \n  \\[  \\{ x_1^{\\alpha _1} \\ldots x^{\\alpha _{n+1}}_{n+1} \\mid \\lambda _\\alpha \\neq 0\\}  \\subset K  \\]\n\n    \n       is $k$-linearly dependent where $\\lambda _\\alpha $ are the coefficients of $F$. By assumption (2) we conclude the set \n    \n      \n  \\[  \\{ x_1^{\\alpha _1 / p} \\ldots x^{\\alpha _{n+1} / p}_{n+1} \\mid \\lambda _\\alpha \\neq 0 \\}   \\]\n\n    \n       is also $k$-linearly dependent, contradicting minimality of $\\deg (F)$. \n    \n      Choose $i$ for which a non-$p$th power of $X_ i$ appears in $F$. Then we see that $x_ i$ is algebraic over $L = k(x_1, \\ldots , x_{i - 1}, x_{i + 1}, \\ldots , x_{n+1})$. By Fields, Lemma 9.26.3 we see that $x_1, \\ldots , x_{i - 1}, x_{i + 1}, \\ldots , x_{n+1}$ is a transcendence base of $K/k$. Thus $L$ is the fraction field of the polynomial ring over $k$ in $x_1, \\ldots , x_{i - 1}, x_{i + 1}, \\ldots , x_{n + 1}$. By Gauss\' Lemma we conclude that \n    \n      \n  \\[  P(T) = F(x_1, \\ldots , x_{i - 1}, T, x_{i + 1}, \\ldots , x_{n + 1}) \\in L[T]  \\]\n\n    \n       is irreducible. By construction $P(T)$ is not contained in $L[T^ p]$. Hence $K/L$ is separable as required. \n      $\\square$\n    \n"," by
  have âŸ¨i, hiâŸ© := exists_isTranscendenceBasis_and_isSeparable_of_linearIndepOn_pow p hp H n ha'
  refine âŸ¨i, hi.1, ?_âŸ©
  rw [â† separableClosure.eq_top_iff, â† (restrictScalars_injective k).eq_iff,
    restrictScalars_top, eq_top_iff, â† ha, adjoin_le_iff]
  rintro _ âŸ¨x, rflâŸ©
  obtain rfl | ne := eq_or_ne x i
  Â· exact hi.2
  Â· exact isSeparable_algebraMap (F := adjoin k (a '' {i}á¶œ)) âŸ¨_, subset_adjoin _ _ âŸ¨x, ne, rflâŸ©âŸ©
","lemma exists_isTranscendenceBasis_and_isSeparable_of_linearIndepOn_pow_of_adjoin_eq_top
    (ha : IntermediateField.adjoin k (Set.range a) = âŠ¤)
    (ha' : IsTranscendenceBasis k fun i : {i // i â‰  n} â†¦ a i) :
    âˆƒ i : Î¹, IsTranscendenceBasis k (fun j : {j // j â‰  i} â†¦ a j) âˆ§
      Algebra.IsSeparable (adjoin k (a '' {i}á¶œ)) K ","Proof.\n      By assumption $x_{n + 1}$ is algebraic over $k(x_1, \\ldots , x_ n)$ so there exists a non-zero polynomial $F \\in k[X_1, \\ldots , X_{n + 1}]$ such that $F(x_1, \\ldots , x_{n+1}) = 0$. Choose $F$ of minimal total degree. Then $F$ is irreducible, because at least one irreducible factor must also have the same property. \n    \n      We claim that, for some $i$, not all powers of $X_ i$ appearing in $F$ are multiples of $p$. Suppose for a contradiction that all the exponents appearing in $F$ were multiples of $p$, then the set \n    \n      \n  \\[  \\{ x_1^{\\alpha _1} \\ldots x^{\\alpha _{n+1}}_{n+1} \\mid \\lambda _\\alpha \\neq 0\\}  \\subset K  \\]\n\n    \n       is $k$-linearly dependent where $\\lambda _\\alpha $ are the coefficients of $F$. By assumption (2) we conclude the set \n    \n      \n  \\[  \\{ x_1^{\\alpha _1 / p} \\ldots x^{\\alpha _{n+1} / p}_{n+1} \\mid \\lambda _\\alpha \\neq 0 \\}   \\]\n\n    \n       is also $k$-linearly dependent, contradicting minimality of $\\deg (F)$. \n    \n      Choose $i$ for which a non-$p$th power of $X_ i$ appears in $F$. Then we see that $x_ i$ is algebraic over $L = k(x_1, \\ldots , x_{i - 1}, x_{i + 1}, \\ldots , x_{n+1})$. By Fields, Lemma 9.26.3 [[\n  Lemma 9.26.3. Let $E/F$ be a field extension. A transcendence basis of $E$ over $F$ exists. Any two transcendence bases have the same cardinality. \n\n    \n]] we see that $x_1, \\ldots , x_{i - 1}, x_{i + 1}, \\ldots , x_{n+1}$ is a transcendence base of $K/k$. Thus $L$ is the fraction field of the polynomial ring over $k$ in $x_1, \\ldots , x_{i - 1}, x_{i + 1}, \\ldots , x_{n + 1}$. By Gauss\' Lemma we conclude that \n    \n      \n  \\[  P(T) = F(x_1, \\ldots , x_{i - 1}, T, x_{i + 1}, \\ldots , x_{n + 1}) \\in L[T]  \\]\n\n    \n       is irreducible. By construction $P(T)$ is not contained in $L[T^ p]$. Hence $K/L$ is separable as required. \n      $\\square$\n    \n"
167,030W,"lemma exists_isTranscendenceBasis_and_isSeparable_of_linearIndepOn_pow_of_essFiniteType
    [Algebra.EssFiniteType k K] :
    âˆƒ s : Finset K, IsTranscendenceBasis k ((â†‘) : s â†’ K) âˆ§
      Algebra.IsSeparable (adjoin k (s : Set K)) K := by
  have âŸ¨s, hs, HsâŸ© := exists_finset_maximalFor_isTranscendenceBasis_separableClosure k K
  refine âŸ¨s, hs, âŸ¨fun n â†¦ of_not_not fun hn â†¦ ?_âŸ©âŸ©
  have hns : n âˆ‰ s := fun h â†¦ hn (le_restrictScalars_separableClosure _ (subset_adjoin _ _ h))
  have âŸ¨i, hiâ‚, hiâ‚‚âŸ© := exists_isTranscendenceBasis_and_isSeparable_of_linearIndepOn_pow'
    p hp (a := id) H s n hs hns
  rw [Set.image_id] at hiâ‚‚
  refine not_lt_iff_le_imp_ge.mpr (Hs hiâ‚) (SetLike.lt_iff_le_and_exists.mpr âŸ¨?_, n, ?_, hnâŸ©)
  Â· rw [separableClosure_le_separableClosure_iff, adjoin_le_iff]
    intro x hx
    obtain rfl | ne := eq_or_ne x i
    exacts [hiâ‚‚, le_restrictScalars_separableClosure _ (subset_adjoin _ _ âŸ¨.inr hx, neâŸ©)]
  Â· obtain rfl | ne := eq_or_ne n i
    exacts [hiâ‚‚, le_restrictScalars_separableClosure _ (subset_adjoin _ _ âŸ¨.inl rfl, neâŸ©)]
",Formal Proof of Stacks Project Tag 030W,(2) â‡’ (1) finitely genenerated case,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/SeparablyGenerated.lean#L279-L295,Q27041,,10.44.2,lemma,3.0,"['05DT', '00AO', '0ELQ']","\n  Lemma 10.44.2. Let $k$ be a field of characteristic $p > 0$. Let $K/k$ be a field extension. The following are equivalent: \n  \n  \n$K$ is separable over $k$, \n\n\nfor every $k$-linearly independent subset $\\{ a_1, \\ldots , a_ m\\} $ of $K$ the set $\\{ a^ p_1, \\ldots , a_ m^ p\\} $ is $k$-linearly independent, \n\n\nthe ring $K \\otimes _ k k^{1/p}$ is reduced, and \n\n\n$K$ is geometrically reduced over $k$. \n\n\n\n\n    \n      Proof.\n      The implication (1) $\\Rightarrow $ (4) follows from Lemma 10.43.6. The implication (4) $\\Rightarrow $ (3) is immediate. \n    \n      Assume (3). Consider the ring homomorphism $m : K \\otimes _ k k^{1/p} \\rightarrow K$ given by \n    \n      \n  \\[  \\lambda \\otimes \\mu \\rightarrow \\lambda ^ p \\mu ^ p  \\]\n\n    \n       Note that $x^ p = m(x) \\otimes 1$ for all $x \\in K \\otimes _ k k^{1/p}$. Since $K \\otimes _ k k^{1/p}$ is reduced we see $m$ is injective. If $\\{ a_1, \\ldots , a_ m\\}  \\subset K$ is $k$-linearly independent, then $\\{ a_1 \\otimes 1, \\ldots , a_ m \\otimes 1\\} $ is $k^{1/p}$-linearly independent. By injectivity of $m$ we deduce that no nontrivial $k$-linear combination of $a_1^ p, \\ldots , a_ m^ p$ is is zero. Hence (3) implies (2). \n    \n      Assume (2). To prove (1) we may assume that $K$ is finitely generated over $k$ and we have to prove that $K$ is separably generated over $k$. Let $\\{ x_1, \\ldots , x_ d\\} $ be a transcendence base of $K/k$. By Fields, Lemma 9.8.6 we have $[K : K\'] < \\infty $ where $K\' = k(x_1, \\ldots , x_ d)$. Choose the transcendence base such that the degree of inseparability $[K : K\']_ i$ is minimal. If $K / K\'$ is separable then we win. Assume this is not the case to get a contradiction. Then there exists $x_{d + 1} \\in K$ which is not separable over $K\'$, and in particular $[K\'(x_{d+1}) : K\']_ i > 1$. Then by Lemma 10.44.1 there is $1 \\leq j \\leq n + 1$ such that $K\'\' = k(x_1, \\ldots , \\widehat{x}_ j, \\ldots , x_{d+1})$ satisfies $[K\'(x_{d+1}) : K\'\']_ i = 1$. By multiplicativity $[K : K\'\']_ i < [K : K\']_ i$ and we obtain the contradiction. \n      $\\square$\n    \n","\n  Lemma 10.44.2. Let $k$ be a field of characteristic $p > 0$. Let $K/k$ be a field extension. The following are equivalent: \n  \n  \n$K$ is separable over $k$, \n\n\nfor every $k$-linearly independent subset $\\{ a_1, \\ldots , a_ m\\} $ of $K$ the set $\\{ a^ p_1, \\ldots , a_ m^ p\\} $ is $k$-linearly independent, \n\n\nthe ring $K \\otimes _ k k^{1/p}$ is reduced, and \n\n\n$K$ is geometrically reduced over $k$. \n\n\n\n\n    \n","Proof.\n      The implication (1) $\\Rightarrow $ (4) follows from Lemma 10.43.6. The implication (4) $\\Rightarrow $ (3) is immediate. \n    \n      Assume (3). Consider the ring homomorphism $m : K \\otimes _ k k^{1/p} \\rightarrow K$ given by \n    \n      \n  \\[  \\lambda \\otimes \\mu \\rightarrow \\lambda ^ p \\mu ^ p  \\]\n\n    \n       Note that $x^ p = m(x) \\otimes 1$ for all $x \\in K \\otimes _ k k^{1/p}$. Since $K \\otimes _ k k^{1/p}$ is reduced we see $m$ is injective. If $\\{ a_1, \\ldots , a_ m\\}  \\subset K$ is $k$-linearly independent, then $\\{ a_1 \\otimes 1, \\ldots , a_ m \\otimes 1\\} $ is $k^{1/p}$-linearly independent. By injectivity of $m$ we deduce that no nontrivial $k$-linear combination of $a_1^ p, \\ldots , a_ m^ p$ is is zero. Hence (3) implies (2). \n    \n      Assume (2). To prove (1) we may assume that $K$ is finitely generated over $k$ and we have to prove that $K$ is separably generated over $k$. Let $\\{ x_1, \\ldots , x_ d\\} $ be a transcendence base of $K/k$. By Fields, Lemma 9.8.6 we have $[K : K\'] < \\infty $ where $K\' = k(x_1, \\ldots , x_ d)$. Choose the transcendence base such that the degree of inseparability $[K : K\']_ i$ is minimal. If $K / K\'$ is separable then we win. Assume this is not the case to get a contradiction. Then there exists $x_{d + 1} \\in K$ which is not separable over $K\'$, and in particular $[K\'(x_{d+1}) : K\']_ i > 1$. Then by Lemma 10.44.1 there is $1 \\leq j \\leq n + 1$ such that $K\'\' = k(x_1, \\ldots , \\widehat{x}_ j, \\ldots , x_{d+1})$ satisfies $[K\'(x_{d+1}) : K\'\']_ i = 1$. By multiplicativity $[K : K\'\']_ i < [K : K\']_ i$ and we obtain the contradiction. \n      $\\square$\n    \n"," by
  have âŸ¨s, hs, HsâŸ© := exists_finset_maximalFor_isTranscendenceBasis_separableClosure k K
  refine âŸ¨s, hs, âŸ¨fun n â†¦ of_not_not fun hn â†¦ ?_âŸ©âŸ©
  have hns : n âˆ‰ s := fun h â†¦ hn (le_restrictScalars_separableClosure _ (subset_adjoin _ _ h))
  have âŸ¨i, hiâ‚, hiâ‚‚âŸ© := exists_isTranscendenceBasis_and_isSeparable_of_linearIndepOn_pow'
    p hp (a := id) H s n hs hns
  rw [Set.image_id] at hiâ‚‚
  refine not_lt_iff_le_imp_ge.mpr (Hs hiâ‚) (SetLike.lt_iff_le_and_exists.mpr âŸ¨?_, n, ?_, hnâŸ©)
  Â· rw [separableClosure_le_separableClosure_iff, adjoin_le_iff]
    intro x hx
    obtain rfl | ne := eq_or_ne x i
    exacts [hiâ‚‚, le_restrictScalars_separableClosure _ (subset_adjoin _ _ âŸ¨.inr hx, neâŸ©)]
  Â· obtain rfl | ne := eq_or_ne n i
    exacts [hiâ‚‚, le_restrictScalars_separableClosure _ (subset_adjoin _ _ âŸ¨.inl rfl, neâŸ©)]
","lemma exists_isTranscendenceBasis_and_isSeparable_of_linearIndepOn_pow_of_essFiniteType
    [Algebra.EssFiniteType k K] :
    âˆƒ s : Finset K, IsTranscendenceBasis k ((â†‘) : s â†’ K) âˆ§
      Algebra.IsSeparable (adjoin k (s : Set K)) K ","Proof.\n      The implication (1) $\\Rightarrow $ (4) follows from Lemma 10.43.6 [[\n  Lemma 10.43.6. Let $k$ be a field. Let $S$ be a reduced $k$-algebra. Let $K/k$ be either a separable field extension, or a separably generated field extension. Then $K \\otimes _ k S$ is reduced. \n\n    \n]]. The implication (4) $\\Rightarrow $ (3) is immediate. \n    \n      Assume (3). Consider the ring homomorphism $m : K \\otimes _ k k^{1/p} \\rightarrow K$ given by \n    \n      \n  \\[  \\lambda \\otimes \\mu \\rightarrow \\lambda ^ p \\mu ^ p  \\]\n\n    \n       Note that $x^ p = m(x) \\otimes 1$ for all $x \\in K \\otimes _ k k^{1/p}$. Since $K \\otimes _ k k^{1/p}$ is reduced we see $m$ is injective. If $\\{ a_1, \\ldots , a_ m\\}  \\subset K$ is $k$-linearly independent, then $\\{ a_1 \\otimes 1, \\ldots , a_ m \\otimes 1\\} $ is $k^{1/p}$-linearly independent. By injectivity of $m$ we deduce that no nontrivial $k$-linear combination of $a_1^ p, \\ldots , a_ m^ p$ is is zero. Hence (3) implies (2). \n    \n      Assume (2). To prove (1) we may assume that $K$ is finitely generated over $k$ and we have to prove that $K$ is separably generated over $k$. Let $\\{ x_1, \\ldots , x_ d\\} $ be a transcendence base of $K/k$. By Fields, Lemma 9.8.6 [[\n       \n      \n  Lemma 9.8.6. Let $k$ be a field, and let $\\alpha _1, \\alpha _2, \\ldots , \\alpha _ n$ be elements of some extension field such that each $\\alpha _ i$ is algebraic over $k$. Then the extension $k(\\alpha _1, \\ldots , \\alpha _ n)/k$ is finite. That is, a finitely generated algebraic extension is finite. \n\n    \n]] we have $[K : K\'] < \\infty $ where $K\' = k(x_1, \\ldots , x_ d)$. Choose the transcendence base such that the degree of inseparability $[K : K\']_ i$ is minimal. If $K / K\'$ is separable then we win. Assume this is not the case to get a contradiction. Then there exists $x_{d + 1} \\in K$ which is not separable over $K\'$, and in particular $[K\'(x_{d+1}) : K\']_ i > 1$. Then by Lemma 10.44.1 [[\n  Lemma 10.44.1. Let $k$ be a field of characteristic $p > 1$. Let $K/k$ be a field extension generated by $x_1, \\ldots , x_{n + 1} \\in K$ such that \n  \n  \n$\\{ x_1, \\ldots , x_ n\\} $ is a transcendence base of $K/k$, \n\n\nfor every $k$-linearly independent subset $\\{ a_1, \\ldots , a_ m\\} $ of $K$ the set $\\{ a^ p_1, \\ldots , a_ m^ p\\} $ is $k$-linearly independent. \n\n\n\n   Then there is $1 \\leq j \\leq n+1$ such that $\\{  x_1, \\ldots , \\widehat{x}_ j, \\ldots , x_{n+1}\\} $ is a separating transcendence base for $K / k$. \n\n    \n]] there is $1 \\leq j \\leq n + 1$ such that $K\'\' = k(x_1, \\ldots , \\widehat{x}_ j, \\ldots , x_{d+1})$ satisfies $[K\'(x_{d+1}) : K\'\']_ i = 1$. By multiplicativity $[K : K\'\']_ i < [K : K\']_ i$ and we obtain the contradiction. \n      $\\square$\n    \n"
168,09G5,"theorem right [hf : Module.Finite F A] : Module.Finite K A :=
  let âŸ¨âŸ¨b, hbâŸ©âŸ© := hf
  âŸ¨âŸ¨b, Submodule.restrictScalars_injective F _ _ <| by
    rw [Submodule.restrictScalars_top, eq_top_iff, â† hb, Submodule.span_le]
    exact Submodule.subset_spanâŸ©âŸ©
",Formal Proof of Stacks Project Tag 09G5,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/Tower.lean#L55-L59,Q27041,,9.7.3,lemma,3.0,"['09G2', '09FA', '0ELQ']","\n  Lemma 9.7.3. Let $K/E/F$ be a tower of algebraic field extensions. If $K$ is finite over $F$, then $K$ is finite over $E$. \n\n    \n      Proof.\n      Direct from the definition. \n      $\\square$\n    \n","\n  Lemma 9.7.3. Let $K/E/F$ be a tower of algebraic field extensions. If $K$ is finite over $F$, then $K$ is finite over $E$. \n\n    \n",Proof.\n      Direct from the definition. \n      $\\square$\n    \n,"
  let âŸ¨âŸ¨b, hbâŸ©âŸ© := hf
  âŸ¨âŸ¨b, Submodule.restrictScalars_injective F _ _ <| by
    rw [Submodule.restrictScalars_top, eq_top_iff, â† hb, Submodule.span_le]
    exact Submodule.subset_spanâŸ©âŸ©
",theorem right [hf : Module.Finite F A] : Module.Finite K A ,Proof.\n      Direct from the definition. \n      $\\square$\n    \n
169,09HY,"theorem card (p : â„•) [CharP K p] : âˆƒ n : â„•+, Nat.Prime p âˆ§ q = p ^ (n : â„•) := by
  haveI hp : Fact p.Prime := âŸ¨CharP.char_is_prime K pâŸ©
  letI : Module (ZMod p) K := { (ZMod.castHom dvd_rfl K : ZMod p â†’+* _).toModule with }
  obtain âŸ¨n, hâŸ© := VectorSpace.card_fintype (ZMod p) K
  rw [ZMod.card] at h
  refine âŸ¨âŸ¨n, ?_âŸ©, hp.1, hâŸ©
  apply Or.resolve_left (Nat.eq_zero_or_pos n)
  rintro rfl
  rw [pow_zero] at h
  have : (0 : K) = 1 := by apply Fintype.card_le_one_iff.mp (le_of_eq h)
  exact absurd this zero_ne_one
",Formal Proof of Stacks Project Tag 09HY,first part,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/Finite/Basic.lean#L246-L256,Q27041,Finite fields,9.18,section,2.0,"['09FA', '0ELQ']","9.18 Finite fields\n\n\nLet $F$ be a finite field. It is clear that $F$ has positive characteristic as we cannot have an injection $\\mathbf{Q} \\to F$. Say the characteristic of $F$ is $p$. The extension $\\mathbf{F}_ p \\subset F$ is finite. Hence we see that $F$ has $q = p^ f$ elements for some $f \\geq 1$. \n\n\nLet us think about the group of units $F^*$. This is a finite abelian group, so it has some exponent $e$. Then $F^* = \\mu _ e(F)$ and we see from the discussion in Section 9.17 that $F^*$ is a cyclic group of order $q - 1$. (A posteriori it follows that $e = q - 1$ as well.) In particular, if $\\alpha \\in F^*$ is a generator then it clearly is true that \n\n\n  \\[  F = \\mathbf{F}_ p(\\alpha )  \\]\n\n\n In other words, the extension $F/\\mathbf{F}_ p$ is generated by a single element. Of course, the same thing is true for any extension of finite fields $E/F$ (because $E$ is already generated by a single element over the prime field). \n\n","9.18 Finite fields\n\n\nLet $F$ be a finite field. It is clear that $F$ has positive characteristic as we cannot have an injection $\\mathbf{Q} \\to F$. Say the characteristic of $F$ is $p$. The extension $\\mathbf{F}_ p \\subset F$ is finite. Hence we see that $F$ has $q = p^ f$ elements for some $f \\geq 1$. \n\n\nLet us think about the group of units $F^*$. This is a finite abelian group, so it has some exponent $e$. Then $F^* = \\mu _ e(F)$ and we see from the discussion in Section 9.17 that $F^*$ is a cyclic group of order $q - 1$. (A posteriori it follows that $e = q - 1$ as well.) In particular, if $\\alpha \\in F^*$ is a generator then it clearly is true that \n\n\n  \\[  F = \\mathbf{F}_ p(\\alpha )  \\]\n\n\n In other words, the extension $F/\\mathbf{F}_ p$ is generated by a single element. Of course, the same thing is true for any extension of finite fields $E/F$ (because $E$ is already generated by a single element over the prime field). \n\n",," by
  haveI hp : Fact p.Prime := âŸ¨CharP.char_is_prime K pâŸ©
  letI : Module (ZMod p) K := { (ZMod.castHom dvd_rfl K : ZMod p â†’+* _).toModule with }
  obtain âŸ¨n, hâŸ© := VectorSpace.card_fintype (ZMod p) K
  rw [ZMod.card] at h
  refine âŸ¨âŸ¨n, ?_âŸ©, hp.1, hâŸ©
  apply Or.resolve_left (Nat.eq_zero_or_pos n)
  rintro rfl
  rw [pow_zero] at h
  have : (0 : K) = 1 := by apply Fintype.card_le_one_iff.mp (le_of_eq h)
  exact absurd this zero_ne_one
","theorem card (p : â„•) [CharP K p] : âˆƒ n : â„•+, Nat.Prime p âˆ§ q = p ^ (n : â„•) ",
170,09I0,"class IsGalois : Prop where
  [to_isSeparable : Algebra.IsSeparable F E]
  [to_normal : Normal F E]
",Formal Proof of Stacks Project Tag 09I0,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/Galois/Basic.lean#L57-L59,Q27041,,9.21.1,definition,3.0,"['09DU', '09FA', '0ELQ']","\n  Definition 9.21.1. A field extension $E/F$ is called Galois if it is algebraic, separable, and normal. \n","\n  Definition 9.21.1. A field extension $E/F$ is called Galois if it is algebraic, separable, and normal. \n",,,"class IsGalois : Prop where
  [to_isSeparable : Algebra.IsSeparable F E]
  [to_normal : Normal F E]
",
171,09I3,"instance of_fixed_field (G : Type*) [Group G] [Finite G] [MulSemiringAction G E] :
    IsGalois (FixedPoints.subfield G E) E :=
  âŸ¨âŸ©
",Formal Proof of Stacks Project Tag 09I3,first part,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/Galois/Basic.lean#L94-L96,Q27041,,9.21.6,lemma,3.0,"['09DU', '09FA', '0ELQ']","\n  Lemma 9.21.6. Let $K$ be a field. Let $G$ be a finite group acting faithfully on $K$. Then the extension $K/K^ G$ is Galois, we have $[K : K^ G] = |G|$, and the Galois group of the extension is $G$. \n\n    \n      Proof.\n      Given $\\alpha \\in K$ consider the orbit $G \\cdot \\alpha \\subset K$ of $\\alpha $ under the group action. Consider the polynomial \n    \n      \n  \\[  P = \\prod \\nolimits _{\\beta \\in G \\cdot \\alpha } (x - \\beta ) \\in K[x]  \\]\n\n    \n       The key to the whole lemma is that this polynomial is invariant under the action of $G$ and hence has coefficients in $K^ G$. Namely, for $\\tau \\in G$ we have \n    \n      \n  \\[  P^\\tau = \\prod \\nolimits _{\\beta \\in G \\cdot \\alpha } (x - \\tau (\\beta )) = \\prod \\nolimits _{\\beta \\in G \\cdot \\alpha } (x - \\beta ) = P  \\]\n\n    \n       because the map $\\beta \\mapsto \\tau (\\beta )$ is a permutation of the orbit $G \\cdot \\alpha $. Thus $P \\in K^ G[x]$. Since also $P(\\alpha ) = 0$ as $\\alpha $ is an element of its orbit we conclude that the extension $K/K^ G$ is algebraic. Moreover, the minimal polynomial $Q$ of $\\alpha $ over $K^ G$ divides the polynomial $P$ just constructed. Hence $Q$ is separable (by Lemma 9.12.4 for example) and we conclude that $K/K^ G$ is separable. Thus $K/K^ G$ is Galois. To finish the proof it suffices to show that $[K : K^ G] = |G|$ since then $G$ will be the Galois group by Lemma 9.21.2. \n    \n      Pick finitely many elements $\\alpha _ i \\in K$, $i = 1, \\ldots , n$ such that $\\sigma (\\alpha _ i) = \\alpha _ i$ for $i = 1, \\ldots , n$ implies $\\sigma $ is the neutral element of $G$. Set \n    \n      \n  \\[  L = K^ G(\\{ \\sigma (\\alpha _ i); 1 \\leq i \\leq n, \\sigma \\in G\\} ) \\subset K  \\]\n\n    \n       and observe that the action of $G$ on $K$ induces an action of $G$ on $L$. We will show that $L$ has degree $|G|$ over $K^ G$. This will finish the proof, since if $L \\subset K$ is proper, then we can add an element $\\alpha \\in K$, $\\alpha \\not\\in L$ to our list of elements $\\alpha _1, \\ldots , \\alpha _ n$ without increasing $L$ which is absurd. This reduces us to the case that $K/K^ G$ is finite which is treated in the next paragraph. \n    \n      Assume $K/K^ G$ is finite. By Lemma 9.19.1 we can find $\\alpha \\in K$ such that $K = K^ G(\\alpha )$. By the construction in the first paragraph of this proof we see that $\\alpha $ has degree at most $|G|$ over $K$. However, the degree cannot be less than $|G|$ as $G$ acts faithfully on $K^ G(\\alpha ) = L$ by construction and the inequality of Lemma 9.15.9. \n      $\\square$\n    \n","\n  Lemma 9.21.6. Let $K$ be a field. Let $G$ be a finite group acting faithfully on $K$. Then the extension $K/K^ G$ is Galois, we have $[K : K^ G] = |G|$, and the Galois group of the extension is $G$. \n\n    \n","Proof.\n      Given $\\alpha \\in K$ consider the orbit $G \\cdot \\alpha \\subset K$ of $\\alpha $ under the group action. Consider the polynomial \n    \n      \n  \\[  P = \\prod \\nolimits _{\\beta \\in G \\cdot \\alpha } (x - \\beta ) \\in K[x]  \\]\n\n    \n       The key to the whole lemma is that this polynomial is invariant under the action of $G$ and hence has coefficients in $K^ G$. Namely, for $\\tau \\in G$ we have \n    \n      \n  \\[  P^\\tau = \\prod \\nolimits _{\\beta \\in G \\cdot \\alpha } (x - \\tau (\\beta )) = \\prod \\nolimits _{\\beta \\in G \\cdot \\alpha } (x - \\beta ) = P  \\]\n\n    \n       because the map $\\beta \\mapsto \\tau (\\beta )$ is a permutation of the orbit $G \\cdot \\alpha $. Thus $P \\in K^ G[x]$. Since also $P(\\alpha ) = 0$ as $\\alpha $ is an element of its orbit we conclude that the extension $K/K^ G$ is algebraic. Moreover, the minimal polynomial $Q$ of $\\alpha $ over $K^ G$ divides the polynomial $P$ just constructed. Hence $Q$ is separable (by Lemma 9.12.4 for example) and we conclude that $K/K^ G$ is separable. Thus $K/K^ G$ is Galois. To finish the proof it suffices to show that $[K : K^ G] = |G|$ since then $G$ will be the Galois group by Lemma 9.21.2. \n    \n      Pick finitely many elements $\\alpha _ i \\in K$, $i = 1, \\ldots , n$ such that $\\sigma (\\alpha _ i) = \\alpha _ i$ for $i = 1, \\ldots , n$ implies $\\sigma $ is the neutral element of $G$. Set \n    \n      \n  \\[  L = K^ G(\\{ \\sigma (\\alpha _ i); 1 \\leq i \\leq n, \\sigma \\in G\\} ) \\subset K  \\]\n\n    \n       and observe that the action of $G$ on $K$ induces an action of $G$ on $L$. We will show that $L$ has degree $|G|$ over $K^ G$. This will finish the proof, since if $L \\subset K$ is proper, then we can add an element $\\alpha \\in K$, $\\alpha \\not\\in L$ to our list of elements $\\alpha _1, \\ldots , \\alpha _ n$ without increasing $L$ which is absurd. This reduces us to the case that $K/K^ G$ is finite which is treated in the next paragraph. \n    \n      Assume $K/K^ G$ is finite. By Lemma 9.19.1 we can find $\\alpha \\in K$ such that $K = K^ G(\\alpha )$. By the construction in the first paragraph of this proof we see that $\\alpha $ has degree at most $|G|$ over $K$. However, the degree cannot be less than $|G|$ as $G$ acts faithfully on $K^ G(\\alpha ) = L$ by construction and the inequality of Lemma 9.15.9. \n      $\\square$\n    \n","
  âŸ¨âŸ©
","instance of_fixed_field (G : Type*) [Group G] [Finite G] [MulSemiringAction G E] :
    IsGalois (FixedPoints.subfield G E) E ","Proof.\n      Given $\\alpha \\in K$ consider the orbit $G \\cdot \\alpha \\subset K$ of $\\alpha $ under the group action. Consider the polynomial \n    \n      \n  \\[  P = \\prod \\nolimits _{\\beta \\in G \\cdot \\alpha } (x - \\beta ) \\in K[x]  \\]\n\n    \n       The key to the whole lemma is that this polynomial is invariant under the action of $G$ and hence has coefficients in $K^ G$. Namely, for $\\tau \\in G$ we have \n    \n      \n  \\[  P^\\tau = \\prod \\nolimits _{\\beta \\in G \\cdot \\alpha } (x - \\tau (\\beta )) = \\prod \\nolimits _{\\beta \\in G \\cdot \\alpha } (x - \\beta ) = P  \\]\n\n    \n       because the map $\\beta \\mapsto \\tau (\\beta )$ is a permutation of the orbit $G \\cdot \\alpha $. Thus $P \\in K^ G[x]$. Since also $P(\\alpha ) = 0$ as $\\alpha $ is an element of its orbit we conclude that the extension $K/K^ G$ is algebraic. Moreover, the minimal polynomial $Q$ of $\\alpha $ over $K^ G$ divides the polynomial $P$ just constructed. Hence $Q$ is separable (by Lemma 9.12.4 [[\n  Lemma 9.12.4. Let $F$ be a field. An irreducible polynomial $P$ over $F$ is separable if and only if $P$ has pairwise distinct roots in an algebraic closure of $F$. \n\n    \n]] for example) and we conclude that $K/K^ G$ is separable. Thus $K/K^ G$ is Galois. To finish the proof it suffices to show that $[K : K^ G] = |G|$ since then $G$ will be the Galois group by Lemma 9.21.2 [[\n  Lemma 9.21.2. Let $E/F$ be a finite extension of fields. Then $E$ is Galois over $F$ if and only if $|\\text{Aut}(E/F)| = [E : F]$. \n\n    \n]]. \n    \n      Pick finitely many elements $\\alpha _ i \\in K$, $i = 1, \\ldots , n$ such that $\\sigma (\\alpha _ i) = \\alpha _ i$ for $i = 1, \\ldots , n$ implies $\\sigma $ is the neutral element of $G$. Set \n    \n      \n  \\[  L = K^ G(\\{ \\sigma (\\alpha _ i); 1 \\leq i \\leq n, \\sigma \\in G\\} ) \\subset K  \\]\n\n    \n       and observe that the action of $G$ on $K$ induces an action of $G$ on $L$. We will show that $L$ has degree $|G|$ over $K^ G$. This will finish the proof, since if $L \\subset K$ is proper, then we can add an element $\\alpha \\in K$, $\\alpha \\not\\in L$ to our list of elements $\\alpha _1, \\ldots , \\alpha _ n$ without increasing $L$ which is absurd. This reduces us to the case that $K/K^ G$ is finite which is treated in the next paragraph. \n    \n      Assume $K/K^ G$ is finite. By Lemma 9.19.1 [[\n  Lemma 9.19.1 (Primitive element).  Let $E/F$ be a finite extension of fields. The following are equivalent \n  \n  \nthere exists a primitive element for $E$ over $F$, and \n\n\nthere are finitely many subextensions $E/K/F$. \n\n\n\n   Moreover, (1) and (2) hold if $E/F$ is separable. \n\n    \n]] we can find $\\alpha \\in K$ such that $K = K^ G(\\alpha )$. By the construction in the first paragraph of this proof we see that $\\alpha $ has degree at most $|G|$ over $K$. However, the degree cannot be less than $|G|$ as $G$ acts faithfully on $K^ G(\\alpha ) = L$ by construction and the inequality of Lemma 9.15.9 [[\n  Lemma 9.15.9. Let $E/F$ be a finite extension. We have \n  \n  \\[  |\\text{Aut}(E/F)| \\leq [E : F]_ s  \\]\n\n   with equality if and only if $E$ is normal over $F$. \n\n    \n]]. \n      $\\square$\n    \n"
172,09I1,"theorem card_aut_eq_finrank [FiniteDimensional F E] [IsGalois F E] :
    Nat.card Gal(E/F) = finrank F E := by
  obtain âŸ¨Î±, hÎ±âŸ© := Field.exists_primitive_element F E
  let iso : FâŸ®Î±âŸ¯ â‰ƒâ‚[F] E :=
    { toFun := fun e => e.val
      invFun := fun e => âŸ¨e, by rw [hÎ±]; exact IntermediateField.mem_topâŸ©
      map_mul' := fun _ _ => rfl
      map_add' := fun _ _ => rfl
      commutes' := fun _ => rfl }
  have H : IsIntegral F Î± := IsGalois.integral F Î±
  have h_sep : IsSeparable F Î± := IsGalois.separable F Î±
  have h_splits : ((minpoly F Î±).map (algebraMap F E)).Splits := IsGalois.splits F Î±
  replace h_splits : ((minpoly F Î±).map (algebraMap F FâŸ®Î±âŸ¯)).Splits := by
    simpa [Polynomial.map_map] using h_splits.map iso.symm.toRingHom
  rw [â† LinearEquiv.finrank_eq iso.toLinearEquiv]
  rw [â† IntermediateField.AdjoinSimple.card_aut_eq_finrank F E H h_sep h_splits]
  apply Nat.card_congr
  exact Equiv.mk (fun Ï• => iso.trans (Ï•.trans iso.symm)) fun Ï• => iso.symm.trans (Ï•.trans iso)
",Formal Proof of Stacks Project Tag 09I1,'only if' part,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/Galois/Basic.lean#L109-L126,Q27041,,9.21.2,lemma,3.0,"['09DU', '09FA', '0ELQ']","\n  Lemma 9.21.2. Let $E/F$ be a finite extension of fields. Then $E$ is Galois over $F$ if and only if $|\\text{Aut}(E/F)| = [E : F]$. \n\n    \n      Proof.\n      Assume $|\\text{Aut}(E/F)| = [E : F]$. By Lemma 9.15.9 this implies that $E/F$ is separable and normal, hence Galois. Conversely, if $E/F$ is separable then $[E : F] = [E : F]_ s$ and if $E/F$ is in addition normal, then Lemma 9.15.9 implies that $|\\text{Aut}(E/F)| = [E : F]$. \n      $\\square$\n    \n",\n  Lemma 9.21.2. Let $E/F$ be a finite extension of fields. Then $E$ is Galois over $F$ if and only if $|\\text{Aut}(E/F)| = [E : F]$. \n\n    \n,"Proof.\n      Assume $|\\text{Aut}(E/F)| = [E : F]$. By Lemma 9.15.9 this implies that $E/F$ is separable and normal, hence Galois. Conversely, if $E/F$ is separable then $[E : F] = [E : F]_ s$ and if $E/F$ is in addition normal, then Lemma 9.15.9 implies that $|\\text{Aut}(E/F)| = [E : F]$. \n      $\\square$\n    \n"," by
  obtain âŸ¨Î±, hÎ±âŸ© := Field.exists_primitive_element F E
  let iso : FâŸ®Î±âŸ¯ â‰ƒâ‚[F] E :=
    { toFun := fun e => e.val
      invFun := fun e => âŸ¨e, by rw [hÎ±]; exact IntermediateField.mem_topâŸ©
      map_mul' := fun _ _ => rfl
      map_add' := fun _ _ => rfl
      commutes' := fun _ => rfl }
  have H : IsIntegral F Î± := IsGalois.integral F Î±
  have h_sep : IsSeparable F Î± := IsGalois.separable F Î±
  have h_splits : ((minpoly F Î±).map (algebraMap F E)).Splits := IsGalois.splits F Î±
  replace h_splits : ((minpoly F Î±).map (algebraMap F FâŸ®Î±âŸ¯)).Splits := by
    simpa [Polynomial.map_map] using h_splits.map iso.symm.toRingHom
  rw [â† LinearEquiv.finrank_eq iso.toLinearEquiv]
  rw [â† IntermediateField.AdjoinSimple.card_aut_eq_finrank F E H h_sep h_splits]
  apply Nat.card_congr
  exact Equiv.mk (fun Ï• => iso.trans (Ï•.trans iso.symm)) fun Ï• => iso.symm.trans (Ï•.trans iso)
","theorem card_aut_eq_finrank [FiniteDimensional F E] [IsGalois F E] :
    Nat.card Gal(E/F) = finrank F E ","Proof.\n      Assume $|\\text{Aut}(E/F)| = [E : F]$. By Lemma 9.15.9 [[\n  Lemma 9.15.9. Let $E/F$ be a finite extension. We have \n  \n  \\[  |\\text{Aut}(E/F)| \\leq [E : F]_ s  \\]\n\n   with equality if and only if $E$ is normal over $F$. \n\n    \n]] this implies that $E/F$ is separable and normal, hence Galois. Conversely, if $E/F$ is separable then $[E : F] = [E : F]_ s$ and if $E/F$ is in addition normal, then Lemma 9.15.9 [[\n  Lemma 9.15.9. Let $E/F$ be a finite extension. We have \n  \n  \\[  |\\text{Aut}(E/F)| \\leq [E : F]_ s  \\]\n\n   with equality if and only if $E$ is normal over $F$. \n\n    \n]] implies that $|\\text{Aut}(E/F)| = [E : F]$. \n      $\\square$\n    \n"
173,09I2,"theorem IsGalois.tower_top_of_isGalois [IsGalois F E] : IsGalois K E :=
  { to_isSeparable := Algebra.isSeparable_tower_top_of_isSeparable F K E
    to_normal := Normal.tower_top_of_normal F K E }
",Formal Proof of Stacks Project Tag 09I2,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/Galois/Basic.lean#L152-L154,Q27041,,9.21.4,lemma,3.0,"['09DU', '09FA', '0ELQ']","\n  Lemma 9.21.4. Let $K/E/F$ be a tower of algebraic field extensions. If $K$ is Galois over $F$, then $K$ is Galois over $E$. \n\n    \n      Proof.\n      Combine Lemmas 9.15.2 and 9.12.3. \n      $\\square$\n    \n","\n  Lemma 9.21.4. Let $K/E/F$ be a tower of algebraic field extensions. If $K$ is Galois over $F$, then $K$ is Galois over $E$. \n\n    \n",Proof.\n      Combine Lemmas 9.15.2 and 9.12.3. \n      $\\square$\n    \n,"
  { to_isSeparable := Algebra.isSeparable_tower_top_of_isSeparable F K E
    to_normal := Normal.tower_top_of_normal F K E }
",theorem IsGalois.tower_top_of_isGalois [IsGalois F E] : IsGalois K E ,"Proof.\n      Combine Lemmas 9.15.2 [[\n  Lemma 9.15.2. Let $K/E/F$ be a tower of algebraic field extensions. If $K$ is normal over $F$, then $K$ is normal over $E$. \n\n    \n]] and 9.12.3 [[\n  Lemma 9.12.3. Let $K/E/F$ be a tower of algebraic field extensions. \n  \n  \nIf $\\alpha \\in K$ is separable over $F$, then $\\alpha $ is separable over $E$. \n\n\nif $K$ is separable over $F$, then $K$ is separable over $E$. \n\n\n\n\n    \n]]. \n      $\\square$\n    \n"
174,09I1,"theorem of_card_aut_eq_finrank [FiniteDimensional F E]
    (h : Nat.card Gal(E/F) = finrank F E) : IsGalois F E := by
  apply of_fixedField_eq_bot
  have p : 0 < finrank (IntermediateField.fixedField (âŠ¤ : Subgroup Gal(E/F))) E := finrank_pos
  classical
  rw [â† IntermediateField.finrank_eq_one_iff, â† mul_left_inj' (ne_of_lt p).symm,
    finrank_mul_finrank, â† h, one_mul, IntermediateField.finrank_fixedField_eq_card]
  apply Nat.card_congr
  exact { toFun := fun g => âŸ¨g, Subgroup.mem_top gâŸ©, invFun := (â†‘) }
",Formal Proof of Stacks Project Tag 09I1,'if' part,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/Galois/Basic.lean#L489-L497,Q27041,,9.21.2,lemma,3.0,"['09DU', '09FA', '0ELQ']","\n  Lemma 9.21.2. Let $E/F$ be a finite extension of fields. Then $E$ is Galois over $F$ if and only if $|\\text{Aut}(E/F)| = [E : F]$. \n\n    \n      Proof.\n      Assume $|\\text{Aut}(E/F)| = [E : F]$. By Lemma 9.15.9 this implies that $E/F$ is separable and normal, hence Galois. Conversely, if $E/F$ is separable then $[E : F] = [E : F]_ s$ and if $E/F$ is in addition normal, then Lemma 9.15.9 implies that $|\\text{Aut}(E/F)| = [E : F]$. \n      $\\square$\n    \n",\n  Lemma 9.21.2. Let $E/F$ be a finite extension of fields. Then $E$ is Galois over $F$ if and only if $|\\text{Aut}(E/F)| = [E : F]$. \n\n    \n,"Proof.\n      Assume $|\\text{Aut}(E/F)| = [E : F]$. By Lemma 9.15.9 this implies that $E/F$ is separable and normal, hence Galois. Conversely, if $E/F$ is separable then $[E : F] = [E : F]_ s$ and if $E/F$ is in addition normal, then Lemma 9.15.9 implies that $|\\text{Aut}(E/F)| = [E : F]$. \n      $\\square$\n    \n"," by
  apply of_fixedField_eq_bot
  have p : 0 < finrank (IntermediateField.fixedField (âŠ¤ : Subgroup Gal(E/F))) E := finrank_pos
  classical
  rw [â† IntermediateField.finrank_eq_one_iff, â† mul_left_inj' (ne_of_lt p).symm,
    finrank_mul_finrank, â† h, one_mul, IntermediateField.finrank_fixedField_eq_card]
  apply Nat.card_congr
  exact { toFun := fun g => âŸ¨g, Subgroup.mem_top gâŸ©, invFun := (â†‘) }
","theorem of_card_aut_eq_finrank [FiniteDimensional F E]
    (h : Nat.card Gal(E/F) = finrank F E) : IsGalois F E ","Proof.\n      Assume $|\\text{Aut}(E/F)| = [E : F]$. By Lemma 9.15.9 [[\n  Lemma 9.15.9. Let $E/F$ be a finite extension. We have \n  \n  \\[  |\\text{Aut}(E/F)| \\leq [E : F]_ s  \\]\n\n   with equality if and only if $E$ is normal over $F$. \n\n    \n]] this implies that $E/F$ is separable and normal, hence Galois. Conversely, if $E/F$ is separable then $[E : F] = [E : F]_ s$ and if $E/F$ is in addition normal, then Lemma 9.15.9 [[\n  Lemma 9.15.9. Let $E/F$ be a finite extension. We have \n  \n  \\[  |\\text{Aut}(E/F)| \\leq [E : F]_ s  \\]\n\n   with equality if and only if $E$ is normal over $F$. \n\n    \n]] implies that $|\\text{Aut}(E/F)| = [E : F]$. \n      $\\square$\n    \n"
175,0EXM,"instance IsGalois.normalClosure : IsGalois k (normalClosure k K F) where
  to_isSeparable := Algebra.isSeparable_tower_bot_of_isSeparable k _ F
",Formal Proof of Stacks Project Tag 0EXM,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/Galois/Basic.lean#L608-L609,Q27041,,9.21.5,lemma,3.0,"['09DU', '09FA', '0ELQ']",\n  Lemma 9.21.5. Let $L/K$ be a finite separable extension of fields. Let $M$ be the normal closure of $L$ over $K$ (Definition 9.16.4). Then $M/K$ is Galois. \n\n    \n      Proof.\n      The subextension $M/M_{sep}/K$ of Lemma 9.14.6 is normal by Lemma 9.15.4. Since $L/K$ is separable we have $L \\subset M_{sep}$. By minimality $M = M_{sep}$ and the proof is done. \n      $\\square$\n    \n,\n  Lemma 9.21.5. Let $L/K$ be a finite separable extension of fields. Let $M$ be the normal closure of $L$ over $K$ (Definition 9.16.4). Then $M/K$ is Galois. \n\n    \n,Proof.\n      The subextension $M/M_{sep}/K$ of Lemma 9.14.6 is normal by Lemma 9.15.4. Since $L/K$ is separable we have $L \\subset M_{sep}$. By minimality $M = M_{sep}$ and the proof is done. \n      $\\square$\n    \n," Algebra.isSeparable_tower_bot_of_isSeparable k _ F
","instance IsGalois.normalClosure : IsGalois k (normalClosure k K F) where
  to_isSeparable ",Proof.\n      The subextension $M/M_{sep}/K$ of Lemma 9.14.6 [[\n       \n      \n  Lemma 9.14.6. Let $E/F$ be an algebraic field extension. There exists a unique subextension $E/E_{sep}/F$ such that $E_{sep}/F$ is separable and $E/E_{sep}$ is purely inseparable. \n\n    \n]] is normal by Lemma 9.15.4 [[\n  Lemma 9.15.4. Let $E/F$ be a normal algebraic field extension. Then the subextension $E/E_{sep}/F$ of Lemma 9.14.6 is normal. \n\n    \n]]. Since $L/K$ is separable we have $L \\subset M_{sep}$. By minimality $M = M_{sep}$ and the proof is done. \n      $\\square$\n    \n
176,09G1,"noncomputable def adjoinRootEquivAdjoin (h : IsIntegral F Î±) :
    AdjoinRoot (minpoly F Î±) â‰ƒâ‚[F] FâŸ®Î±âŸ¯ :=
  AlgEquiv.ofBijective
    (AdjoinRoot.liftAlgHom (minpoly F Î±) _ (AdjoinSimple.gen F Î±) (aeval_gen_minpoly F Î±))
    (by
      set f := AdjoinRoot.lift _ _ (aeval_gen_minpoly F Î± :)
      haveI := Fact.mk (minpoly.irreducible h)
      constructor
      Â· exact RingHom.injective f
      Â· suffices FâŸ®Î±âŸ¯.toSubfield â‰¤ RingHom.fieldRange (FâŸ®Î±âŸ¯.toSubfield.subtype.comp f) by
          intro x
          obtain âŸ¨y, hyâŸ© := this (Subtype.mem x)
          exact âŸ¨y, Subtype.ext hyâŸ©
        refine Subfield.closure_le.mpr (Set.union_subset (fun x hx => ?_) ?_)
        Â· obtain âŸ¨y, hyâŸ© := hx
          refine âŸ¨y, ?_âŸ©
          rw [RingHom.comp_apply]
          dsimp only [coe_type_toSubfield]
          rw [AdjoinRoot.lift_of (aeval_gen_minpoly F Î±)]
          exact hy
        Â· refine Set.singleton_subset_iff.mpr âŸ¨AdjoinRoot.root (minpoly F Î±), ?_âŸ©
          rw [RingHom.comp_apply]
          dsimp only [coe_type_toSubfield]
          rw [AdjoinRoot.lift_root (aeval_gen_minpoly F Î±)]
          rfl)
",Formal Proof of Stacks Project Tag 09G1,Algebraic case,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/IntermediateField/Adjoin/Basic.lean#L388-L412,Q27041,Classification of simple extensions,9.6.8,lemma,3.0,"['09FT', '09FA', '0ELQ']","\n  Lemma 9.6.8 (Classification of simple extensions).  If a field extension $F/k$ is generated by one element, then it is $k$-isomorphic either to the rational function field $k(t)/k$ or to one of the extensions $k[t]/(P)$ for $P \\in k[t]$ irreducible. \n\n    \n      Proof.\n      Let $\\alpha \\in F$ be such that $F = k(\\alpha )$; by assumption, such an $\\alpha $ exists. There is a morphism of rings \n    \n      \n  \\[  k[t] \\to F  \\]\n\n    \n       sending the indeterminate $t$ to $\\alpha $. The image is a domain, so the kernel is a prime ideal. Thus, it is either $(0)$ or $(P)$ for $P \\in k[t]$ irreducible. \n    \n      If the kernel is $(P)$ for $P \\in k[t]$ irreducible, then the map factors through $k[t]/(P)$, and induces a morphism of fields $k[t]/(P) \\to F$. Since the image contains $\\alpha $, we see easily that the map is surjective, hence an isomorphism. In this case, $k[t]/(P) \\simeq F$. \n    \n      If the kernel is trivial, then we have an injection $k[t] \\to F$. One may thus define a morphism of the quotient field $k(t)$ into $F$; given a quotient $R(t)/Q(t)$ with $R(t), Q(t) \\in k[t]$, we map this to $R(\\alpha )/Q(\\alpha )$. The hypothesis that $k[t] \\to F$ is injective implies that $Q(\\alpha ) \\neq 0$ unless $Q$ is the zero polynomial. The quotient field of $k[t]$ is the rational function field $k(t)$, so we get a morphism $k(t) \\to F$ whose image contains $\\alpha $. It is thus surjective, hence an isomorphism. \n      $\\square$\n    \n","\n  Lemma 9.6.8 (Classification of simple extensions).  If a field extension $F/k$ is generated by one element, then it is $k$-isomorphic either to the rational function field $k(t)/k$ or to one of the extensions $k[t]/(P)$ for $P \\in k[t]$ irreducible. \n\n    \n","Proof.\n      Let $\\alpha \\in F$ be such that $F = k(\\alpha )$; by assumption, such an $\\alpha $ exists. There is a morphism of rings \n    \n      \n  \\[  k[t] \\to F  \\]\n\n    \n       sending the indeterminate $t$ to $\\alpha $. The image is a domain, so the kernel is a prime ideal. Thus, it is either $(0)$ or $(P)$ for $P \\in k[t]$ irreducible. \n    \n      If the kernel is $(P)$ for $P \\in k[t]$ irreducible, then the map factors through $k[t]/(P)$, and induces a morphism of fields $k[t]/(P) \\to F$. Since the image contains $\\alpha $, we see easily that the map is surjective, hence an isomorphism. In this case, $k[t]/(P) \\simeq F$. \n    \n      If the kernel is trivial, then we have an injection $k[t] \\to F$. One may thus define a morphism of the quotient field $k(t)$ into $F$; given a quotient $R(t)/Q(t)$ with $R(t), Q(t) \\in k[t]$, we map this to $R(\\alpha )/Q(\\alpha )$. The hypothesis that $k[t] \\to F$ is injective implies that $Q(\\alpha ) \\neq 0$ unless $Q$ is the zero polynomial. The quotient field of $k[t]$ is the rational function field $k(t)$, so we get a morphism $k(t) \\to F$ whose image contains $\\alpha $. It is thus surjective, hence an isomorphism. \n      $\\square$\n    \n","
  AlgEquiv.ofBijective
    (AdjoinRoot.liftAlgHom (minpoly F Î±) _ (AdjoinSimple.gen F Î±) (aeval_gen_minpoly F Î±))
    (by
      set f := AdjoinRoot.lift _ _ (aeval_gen_minpoly F Î± :)
      haveI := Fact.mk (minpoly.irreducible h)
      constructor
      Â· exact RingHom.injective f
      Â· suffices FâŸ®Î±âŸ¯.toSubfield â‰¤ RingHom.fieldRange (FâŸ®Î±âŸ¯.toSubfield.subtype.comp f) by
          intro x
          obtain âŸ¨y, hyâŸ© := this (Subtype.mem x)
          exact âŸ¨y, Subtype.ext hyâŸ©
        refine Subfield.closure_le.mpr (Set.union_subset (fun x hx => ?_) ?_)
        Â· obtain âŸ¨y, hyâŸ© := hx
          refine âŸ¨y, ?_âŸ©
          rw [RingHom.comp_apply]
          dsimp only [coe_type_toSubfield]
          rw [AdjoinRoot.lift_of (aeval_gen_minpoly F Î±)]
          exact hy
        Â· refine Set.singleton_subset_iff.mpr âŸ¨AdjoinRoot.root (minpoly F Î±), ?_âŸ©
          rw [RingHom.comp_apply]
          dsimp only [coe_type_toSubfield]
          rw [AdjoinRoot.lift_root (aeval_gen_minpoly F Î±)]
          rfl)
","noncomputable def adjoinRootEquivAdjoin (h : IsIntegral F Î±) :
    AdjoinRoot (minpoly F Î±) â‰ƒâ‚[F] FâŸ®Î±âŸ¯ ","Proof.\n      Let $\\alpha \\in F$ be such that $F = k(\\alpha )$; by assumption, such an $\\alpha $ exists. There is a morphism of rings \n    \n      \n  \\[  k[t] \\to F  \\]\n\n    \n       sending the indeterminate $t$ to $\\alpha $. The image is a domain, so the kernel is a prime ideal. Thus, it is either $(0)$ or $(P)$ for $P \\in k[t]$ irreducible. \n    \n      If the kernel is $(P)$ for $P \\in k[t]$ irreducible, then the map factors through $k[t]/(P)$, and induces a morphism of fields $k[t]/(P) \\to F$. Since the image contains $\\alpha $, we see easily that the map is surjective, hence an isomorphism. In this case, $k[t]/(P) \\simeq F$. \n    \n      If the kernel is trivial, then we have an injection $k[t] \\to F$. One may thus define a morphism of the quotient field $k(t)$ into $F$; given a quotient $R(t)/Q(t)$ with $R(t), Q(t) \\in k[t]$, we map this to $R(\\alpha )/Q(\\alpha )$. The hypothesis that $k[t] \\to F$ is injective implies that $Q(\\alpha ) \\neq 0$ unless $Q$ is the zero polynomial. The quotient field of $k[t]$ is the rational function field $k(t)$, so we get a morphism $k(t) \\to F$ whose image contains $\\alpha $. It is thus surjective, hence an isomorphism. \n      $\\square$\n    \n"
177,09GN,"theorem adjoin.finrank {x : L} (hx : IsIntegral K x) :
    Module.finrank K KâŸ®xâŸ¯ = (minpoly K x).natDegree := by
  rw [PowerBasis.finrank (adjoin.powerBasis hx :)]
  rfl
",Formal Proof of Stacks Project Tag 09GN,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/IntermediateField/Adjoin/Basic.lean#L459-L462,Q27041,,9.9.2,lemma,3.0,"['09GL', '09FA', '0ELQ']","\n  Lemma 9.9.2. The degree of the minimal polynomial is $[k(\\alpha ) : k]$. \n\n    \n      Proof.\n      This is just a restatement of the argument in Lemma 9.6.8: the observation is that if $P$ is the minimal polynomial of $\\alpha $, then the map \n    \n      \n  \\[  k[x]/(P) \\to k(\\alpha ), \\quad x \\mapsto \\alpha  \\]\n\n    \n       is an isomorphism as in the aforementioned proof, and we have counted the degree of such an extension (see Example 9.7.6). \n      $\\square$\n    \n",\n  Lemma 9.9.2. The degree of the minimal polynomial is $[k(\\alpha ) : k]$. \n\n    \n,"Proof.\n      This is just a restatement of the argument in Lemma 9.6.8: the observation is that if $P$ is the minimal polynomial of $\\alpha $, then the map \n    \n      \n  \\[  k[x]/(P) \\to k(\\alpha ), \\quad x \\mapsto \\alpha  \\]\n\n    \n       is an isomorphism as in the aforementioned proof, and we have counted the degree of such an extension (see Example 9.7.6). \n      $\\square$\n    \n"," by
  rw [PowerBasis.finrank (adjoin.powerBasis hx :)]
  rfl
","theorem adjoin.finrank {x : L} (hx : IsIntegral K x) :
    Module.finrank K KâŸ®xâŸ¯ = (minpoly K x).natDegree ","Proof.\n      This is just a restatement of the argument in Lemma 9.6.8 [[\n  Lemma 9.6.8 (Classification of simple extensions).  If a field extension $F/k$ is generated by one element, then it is $k$-isomorphic either to the rational function field $k(t)/k$ or to one of the extensions $k[t]/(P)$ for $P \\in k[t]$ irreducible. \n\n    \n]]: the observation is that if $P$ is the minimal polynomial of $\\alpha $, then the map \n    \n      \n  \\[  k[x]/(P) \\to k(\\alpha ), \\quad x \\mapsto \\alpha  \\]\n\n    \n       is an isomorphism as in the aforementioned proof, and we have counted the degree of such an extension (see Example 9.7.6 [[\n  Example 9.7.6 (Degree of a simple algebraic extension).  Consider a monogenic field extension $E/k$ of the form discussed in Example 9.6.4. In other words, $E = k[t]/(P)$ for $P \\in k[t]$ an irreducible polynomial. Then the degree $[E : k]$ is just the degree $d = \\deg (P)$ of the polynomial $P$. Indeed, say \n  \n    9.7.6.1\n  \\begin{equation}  \\label{fields-equation-P} P = a_ d t^ d + a_{d - 1} t^{d - 1} + \\ldots + a_0. \\end{equation}\n\n   with $a_ d \\not= 0$. Then the images of $1, t, \\ldots , t^{d - 1}$ in $k[t]/(P)$ are linearly independent over $k$, because any relation involving them would have degree strictly smaller than that of $P$, and $P$ is the element of smallest degree in the ideal $(P)$. \n  Conversely, the set $S = \\{ 1, t, \\ldots , t^{d - 1}\\} $ (or more properly their images) spans $k[t]/(P)$ as a vector space. Indeed, we have by (9.7.6.1) that $a_ d t^ d$ lies in the span of $S$. Since $a_ d$ is invertible, we see that $t^ d$ is in the span of $S$. Similarly, the relation $t P(t) = 0$ shows that the image of $t^{d + 1}$ lies in the span of $\\{ 1, t, \\ldots , t^ d\\} $ \xe2\x80\x94 by what was just shown, thus in the span of $S$. Working upward inductively, we find that the image of $t^ n$ for $n \\geq d$ lies in the span of $S$. \n]]). \n      $\\square$\n    \n"
178,09FZ,"def adjoin : IntermediateField F E :=
  { Subfield.closure (Set.range (algebraMap F E) âˆª S) with
    algebraMap_mem' := fun x => Subfield.subset_closure (Or.inl (Set.mem_range_self x)) }
",Formal Proof of Stacks Project Tag 09FZ,first part,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/IntermediateField/Adjoin/Defs.lean#L34-L36,Q27041,,9.6.6,definition,3.0,"['09FT', '09FA', '0ELQ']","\n  Definition 9.6.6. Let $k$ be a field. If $F/k$ is an extension of fields and $S \\subset F$, we write $k(S)$ for the smallest subfield of $F$ containing $k$ and $S$. We will say that $S$ generates the field extension $k(S)/k$. If $S = \\{ \\alpha \\} $ is a singleton, then we write $k(\\alpha )$ instead of $k(\\{ \\alpha \\} )$. We say $F/k$ is a finitely generated field extension if there exists a finite subset $S \\subset F$ with $F = k(S)$. \n","\n  Definition 9.6.6. Let $k$ be a field. If $F/k$ is an extension of fields and $S \\subset F$, we write $k(S)$ for the smallest subfield of $F$ containing $k$ and $S$. We will say that $S$ generates the field extension $k(S)/k$. If $S = \\{ \\alpha \\} $ is a singleton, then we write $k(\\alpha )$ instead of $k(\\{ \\alpha \\} )$. We say $F/k$ is a finitely generated field extension if there exists a finite subset $S \\subset F$ with $F = k(S)$. \n",,"
  { Subfield.closure (Set.range (algebraMap F E) âˆª S) with
    algebraMap_mem' := fun x => Subfield.subset_closure (Or.inl (Set.mem_range_self x)) }
",def adjoin : IntermediateField F E ,
179,09FZ,"def FG (S : IntermediateField F E) : Prop :=
  âˆƒ t : Finset E, adjoin F â†‘t = S
",Formal Proof of Stacks Project Tag 09FZ,second part,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/IntermediateField/Adjoin/Defs.lean#L626-L627,Q27041,,9.6.6,definition,3.0,"['09FT', '09FA', '0ELQ']","\n  Definition 9.6.6. Let $k$ be a field. If $F/k$ is an extension of fields and $S \\subset F$, we write $k(S)$ for the smallest subfield of $F$ containing $k$ and $S$. We will say that $S$ generates the field extension $k(S)/k$. If $S = \\{ \\alpha \\} $ is a singleton, then we write $k(\\alpha )$ instead of $k(\\{ \\alpha \\} )$. We say $F/k$ is a finitely generated field extension if there exists a finite subset $S \\subset F$ with $F = k(S)$. \n","\n  Definition 9.6.6. Let $k$ be a field. If $F/k$ is an extension of fields and $S \\subset F$, we write $k(S)$ for the smallest subfield of $F$ containing $k$ and $S$. We will say that $S$ generates the field extension $k(S)/k$. If $S = \\{ \\alpha \\} $ is a singleton, then we write $k(\\alpha )$ instead of $k(\\{ \\alpha \\} )$. We say $F/k$ is a finitely generated field extension if there exists a finite subset $S \\subset F$ with $F = k(S)$. \n",,"
  âˆƒ t : Finset E, adjoin F â†‘t = S
",def FG (S : IntermediateField F E) : Prop ,
180,09GT,"def AlgebraicClosure : Type u :=
  MvPolynomial (Vars k) k â§¸ maxIdeal k
",Formal Proof of Stacks Project Tag 09GT,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/IsAlgClosed/AlgebraicClosure.lean#L127-L128,Q27041,,9.10.4,theorem,3.0,"['09GP', '09FA', '0ELQ']","\n  Theorem 9.10.4. Every field has an algebraic closure. \n\n    \n      Proof.\n      Let $F$ be a field. By Lemma 9.8.9 the cardinality of an algebraic extension of $F$ is bounded by $\\max (\\aleph _0, |F|)$. Choose a set $S$ containing $F$ with $|S| > \\max (\\aleph _0, |F|)$. Let\'s consider triples $(E, \\sigma _ E, \\mu _ E)$ where \n    \n      \n  \n$E$ is a set with $F \\subset E \\subset S$, and \n\n\n$\\sigma _ E : E \\times E \\to E$ and $\\mu _ E : E \\times E \\to E$ are maps of sets such that $(E, \\sigma _ E, \\mu _ E)$ defines the structure of a field extension of $F$ (in particular $\\sigma _ E(a, b) = a +_ F b$ for $a, b \\in F$ and similarly for $\\mu _ E$), and \n\n\n$E/F$ is an algebraic field extension. \n\n\n\n    \n       The collection of all triples $(E, \\sigma _ E, \\mu _ E)$ forms a set $I$. For $i \\in I$ we will denote $E_ i = (E_ i, \\sigma _ i, \\mu _ i)$ the corresponding field extension to $F$. We define a partial ordering on $I$ by declaring $i \\leq i\'$ if and only if $E_ i \\subset E_{i\'}$ (this makes sense as $E_ i$ and $E_{i\'}$ are subsets of the same set $S$) and we have $\\sigma _ i = \\sigma _{i\'}|_{E_ i \\times E_ i}$ and $\\mu _ i = \\mu _{i\'}|_{E_ i \\times E_ i}$, in other words, $E_{i\'}$ is a field extension of $E_ i$. \n    \n      Let $T \\subset I$ be a totally ordered subset. Then it is clear that $E_ T = \\bigcup _{i \\in T} E_ i$ with induced maps $\\sigma _ T = \\bigcup \\sigma _ i$ and $\\mu _ T = \\bigcup \\mu _ i$ is another element of $I$. In other words every totally order subset of $I$ has a upper bound in $I$. By Zorn\'s lemma there exists a maximal element $(E, \\sigma _ E, \\mu _ E)$ in $I$. We claim that $E$ is an algebraic closure. Since by definition of $I$ the extension $E/F$ is algebraic, it suffices to show that $E$ is algebraically closed. \n    \n      To see this we argue by contradiction. Namely, suppose that $E$ is not algebraically closed. Then there exists an irreducible polynomial $P$ over $E$ of degree $> 1$, see Lemma 9.10.2. By Lemma 9.8.5 we obtain a nontrivial finite extension $E\' = E[x]/(P)$. Observe that $E\'/F$ is algebraic by Lemma 9.8.8. Thus the cardinality of $E\'$ is $\\leq \\max (\\aleph _0, |F|)$. By elementary set theory we can extend the given injection $E \\subset S$ to an injection $E\' \\to S$. In other words, we may think of $E\'$ as an element of our set $I$ contradicting the maximality of $E$. This contradiction completes the proof. \n      $\\square$\n    \n",\n  Theorem 9.10.4. Every field has an algebraic closure. \n\n    \n,"Proof.\n      Let $F$ be a field. By Lemma 9.8.9 the cardinality of an algebraic extension of $F$ is bounded by $\\max (\\aleph _0, |F|)$. Choose a set $S$ containing $F$ with $|S| > \\max (\\aleph _0, |F|)$. Let\'s consider triples $(E, \\sigma _ E, \\mu _ E)$ where \n    \n      \n  \n$E$ is a set with $F \\subset E \\subset S$, and \n\n\n$\\sigma _ E : E \\times E \\to E$ and $\\mu _ E : E \\times E \\to E$ are maps of sets such that $(E, \\sigma _ E, \\mu _ E)$ defines the structure of a field extension of $F$ (in particular $\\sigma _ E(a, b) = a +_ F b$ for $a, b \\in F$ and similarly for $\\mu _ E$), and \n\n\n$E/F$ is an algebraic field extension. \n\n\n\n    \n       The collection of all triples $(E, \\sigma _ E, \\mu _ E)$ forms a set $I$. For $i \\in I$ we will denote $E_ i = (E_ i, \\sigma _ i, \\mu _ i)$ the corresponding field extension to $F$. We define a partial ordering on $I$ by declaring $i \\leq i\'$ if and only if $E_ i \\subset E_{i\'}$ (this makes sense as $E_ i$ and $E_{i\'}$ are subsets of the same set $S$) and we have $\\sigma _ i = \\sigma _{i\'}|_{E_ i \\times E_ i}$ and $\\mu _ i = \\mu _{i\'}|_{E_ i \\times E_ i}$, in other words, $E_{i\'}$ is a field extension of $E_ i$. \n    \n      Let $T \\subset I$ be a totally ordered subset. Then it is clear that $E_ T = \\bigcup _{i \\in T} E_ i$ with induced maps $\\sigma _ T = \\bigcup \\sigma _ i$ and $\\mu _ T = \\bigcup \\mu _ i$ is another element of $I$. In other words every totally order subset of $I$ has a upper bound in $I$. By Zorn\'s lemma there exists a maximal element $(E, \\sigma _ E, \\mu _ E)$ in $I$. We claim that $E$ is an algebraic closure. Since by definition of $I$ the extension $E/F$ is algebraic, it suffices to show that $E$ is algebraically closed. \n    \n      To see this we argue by contradiction. Namely, suppose that $E$ is not algebraically closed. Then there exists an irreducible polynomial $P$ over $E$ of degree $> 1$, see Lemma 9.10.2. By Lemma 9.8.5 we obtain a nontrivial finite extension $E\' = E[x]/(P)$. Observe that $E\'/F$ is algebraic by Lemma 9.8.8. Thus the cardinality of $E\'$ is $\\leq \\max (\\aleph _0, |F|)$. By elementary set theory we can extend the given injection $E \\subset S$ to an injection $E\' \\to S$. In other words, we may think of $E\'$ as an element of our set $I$ contradicting the maximality of $E$. This contradiction completes the proof. \n      $\\square$\n    \n","
  MvPolynomial (Vars k) k â§¸ maxIdeal k
",def AlgebraicClosure : Type u ,"Proof.\n      Let $F$ be a field. By Lemma 9.8.9 [[\n  Lemma 9.8.9. Let $E/F$ be an algebraic extension of fields. Then the cardinality $|E|$ of $E$ is at most $\\max (\\aleph _0, |F|)$. \n\n    \n]] the cardinality of an algebraic extension of $F$ is bounded by $\\max (\\aleph _0, |F|)$. Choose a set $S$ containing $F$ with $|S| > \\max (\\aleph _0, |F|)$. Let\'s consider triples $(E, \\sigma _ E, \\mu _ E)$ where \n    \n      \n  \n$E$ is a set with $F \\subset E \\subset S$, and \n\n\n$\\sigma _ E : E \\times E \\to E$ and $\\mu _ E : E \\times E \\to E$ are maps of sets such that $(E, \\sigma _ E, \\mu _ E)$ defines the structure of a field extension of $F$ (in particular $\\sigma _ E(a, b) = a +_ F b$ for $a, b \\in F$ and similarly for $\\mu _ E$), and \n\n\n$E/F$ is an algebraic field extension. \n\n\n\n    \n       The collection of all triples $(E, \\sigma _ E, \\mu _ E)$ forms a set $I$. For $i \\in I$ we will denote $E_ i = (E_ i, \\sigma _ i, \\mu _ i)$ the corresponding field extension to $F$. We define a partial ordering on $I$ by declaring $i \\leq i\'$ if and only if $E_ i \\subset E_{i\'}$ (this makes sense as $E_ i$ and $E_{i\'}$ are subsets of the same set $S$) and we have $\\sigma _ i = \\sigma _{i\'}|_{E_ i \\times E_ i}$ and $\\mu _ i = \\mu _{i\'}|_{E_ i \\times E_ i}$, in other words, $E_{i\'}$ is a field extension of $E_ i$. \n    \n      Let $T \\subset I$ be a totally ordered subset. Then it is clear that $E_ T = \\bigcup _{i \\in T} E_ i$ with induced maps $\\sigma _ T = \\bigcup \\sigma _ i$ and $\\mu _ T = \\bigcup \\mu _ i$ is another element of $I$. In other words every totally order subset of $I$ has a upper bound in $I$. By Zorn\'s lemma there exists a maximal element $(E, \\sigma _ E, \\mu _ E)$ in $I$. We claim that $E$ is an algebraic closure. Since by definition of $I$ the extension $E/F$ is algebraic, it suffices to show that $E$ is algebraically closed. \n    \n      To see this we argue by contradiction. Namely, suppose that $E$ is not algebraically closed. Then there exists an irreducible polynomial $P$ over $E$ of degree $> 1$, see Lemma 9.10.2 [[\n  Lemma 9.10.2. Let $F$ be a field. The following are equivalent \n  \n  \n$F$ is algebraically closed, \n\n\nevery irreducible polynomial over $F$ is linear, \n\n\nevery nonconstant polynomial over $F$ has a root, \n\n\nevery nonconstant polynomial over $F$ is a product of linear factors. \n\n\n\n\n    \n]]. By Lemma 9.8.5 [[\n  Lemma 9.8.5. A finite extension is algebraic. In fact, an extension $E/k$ is algebraic if and only if every subextension $k(\\alpha )/k$ generated by some $\\alpha \\in E$ is finite. \n\n    \n]] we obtain a nontrivial finite extension $E\' = E[x]/(P)$. Observe that $E\'/F$ is algebraic by Lemma 9.8.8 [[\n  Lemma 9.8.8. Let $E/k$ and $F/E$ be algebraic extensions of fields. Then $F/k$ is an algebraic extension of fields. \n\n    \n]]. Thus the cardinality of $E\'$ is $\\leq \\max (\\aleph _0, |F|)$. By elementary set theory we can extend the given injection $E \\subset S$ to an injection $E\' \\to S$. In other words, we may think of $E\'$ as an element of our set $I$ contradicting the maximality of $E$. This contradiction completes the proof. \n      $\\square$\n    \n"
181,09GR,"class IsAlgClosed : Prop where
  splits : âˆ€ p : k[X], p.Splits
",Formal Proof of Stacks Project Tag 09GR,The definition of `IsAlgClosed` in mathlib is 09GR (4),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/IsAlgClosed/Basic.lean#L63-L64,Q27041,,9.10.2,lemma,3.0,"['09GP', '09FA', '0ELQ']","\n  Lemma 9.10.2. Let $F$ be a field. The following are equivalent \n  \n  \n$F$ is algebraically closed, \n\n\nevery irreducible polynomial over $F$ is linear, \n\n\nevery nonconstant polynomial over $F$ has a root, \n\n\nevery nonconstant polynomial over $F$ is a product of linear factors. \n\n\n\n\n    \n      Proof.\n      If $F$ is algebraically closed, then every irreducible polynomial is linear. Namely, if there exists an irreducible polynomial of degree $> 1$, then this generates a nontrivial finite (hence algebraic) field extension, see Example 9.7.6. Thus (1) implies (2). If every irreducible polynomial is linear, then every irreducible polynomial has a root, whence every nonconstant polynomial has a root. Thus (2) implies (3). \n    \n      Assume every nonconstant polynomial has a root. Let $P \\in F[x]$ be nonconstant. If $P(\\alpha ) = 0$ with $\\alpha \\in F$, then we see that $P = (x - \\alpha )Q$ for some $Q \\in F[x]$ (by division with remainder). Thus we can argue by induction on the degree that any nonconstant polynomial can be written as a product $c \\prod (x - \\alpha _ i)$. \n    \n      Finally, suppose that every nonconstant polynomial over $F$ is a product of linear factors. Let $E/F$ be an algebraic extension. Then all the simple subextensions $F(\\alpha )/F$ of $E$ are necessarily trivial (because the only irreducible polynomials are linear by assumption). Thus $E = F$. We see that (4) implies (1) and we are done. \n      $\\square$\n    \n","\n  Lemma 9.10.2. Let $F$ be a field. The following are equivalent \n  \n  \n$F$ is algebraically closed, \n\n\nevery irreducible polynomial over $F$ is linear, \n\n\nevery nonconstant polynomial over $F$ has a root, \n\n\nevery nonconstant polynomial over $F$ is a product of linear factors. \n\n\n\n\n    \n","Proof.\n      If $F$ is algebraically closed, then every irreducible polynomial is linear. Namely, if there exists an irreducible polynomial of degree $> 1$, then this generates a nontrivial finite (hence algebraic) field extension, see Example 9.7.6. Thus (1) implies (2). If every irreducible polynomial is linear, then every irreducible polynomial has a root, whence every nonconstant polynomial has a root. Thus (2) implies (3). \n    \n      Assume every nonconstant polynomial has a root. Let $P \\in F[x]$ be nonconstant. If $P(\\alpha ) = 0$ with $\\alpha \\in F$, then we see that $P = (x - \\alpha )Q$ for some $Q \\in F[x]$ (by division with remainder). Thus we can argue by induction on the degree that any nonconstant polynomial can be written as a product $c \\prod (x - \\alpha _ i)$. \n    \n      Finally, suppose that every nonconstant polynomial over $F$ is a product of linear factors. Let $E/F$ be an algebraic extension. Then all the simple subextensions $F(\\alpha )/F$ of $E$ are necessarily trivial (because the only irreducible polynomials are linear by assumption). Thus $E = F$. We see that (4) implies (1) and we are done. \n      $\\square$\n    \n",,"class IsAlgClosed : Prop where
  splits : âˆ€ p : k[X], p.Splits
","Proof.\n      If $F$ is algebraically closed, then every irreducible polynomial is linear. Namely, if there exists an irreducible polynomial of degree $> 1$, then this generates a nontrivial finite (hence algebraic) field extension, see Example 9.7.6 [[\n  Example 9.7.6 (Degree of a simple algebraic extension).  Consider a monogenic field extension $E/k$ of the form discussed in Example 9.6.4. In other words, $E = k[t]/(P)$ for $P \\in k[t]$ an irreducible polynomial. Then the degree $[E : k]$ is just the degree $d = \\deg (P)$ of the polynomial $P$. Indeed, say \n  \n    9.7.6.1\n  \\begin{equation}  \\label{fields-equation-P} P = a_ d t^ d + a_{d - 1} t^{d - 1} + \\ldots + a_0. \\end{equation}\n\n   with $a_ d \\not= 0$. Then the images of $1, t, \\ldots , t^{d - 1}$ in $k[t]/(P)$ are linearly independent over $k$, because any relation involving them would have degree strictly smaller than that of $P$, and $P$ is the element of smallest degree in the ideal $(P)$. \n  Conversely, the set $S = \\{ 1, t, \\ldots , t^{d - 1}\\} $ (or more properly their images) spans $k[t]/(P)$ as a vector space. Indeed, we have by (9.7.6.1) that $a_ d t^ d$ lies in the span of $S$. Since $a_ d$ is invertible, we see that $t^ d$ is in the span of $S$. Similarly, the relation $t P(t) = 0$ shows that the image of $t^{d + 1}$ lies in the span of $\\{ 1, t, \\ldots , t^ d\\} $ \xe2\x80\x94 by what was just shown, thus in the span of $S$. Working upward inductively, we find that the image of $t^ n$ for $n \\geq d$ lies in the span of $S$. \n]]. Thus (1) implies (2). If every irreducible polynomial is linear, then every irreducible polynomial has a root, whence every nonconstant polynomial has a root. Thus (2) implies (3). \n    \n      Assume every nonconstant polynomial has a root. Let $P \\in F[x]$ be nonconstant. If $P(\\alpha ) = 0$ with $\\alpha \\in F$, then we see that $P = (x - \\alpha )Q$ for some $Q \\in F[x]$ (by division with remainder). Thus we can argue by induction on the degree that any nonconstant polynomial can be written as a product $c \\prod (x - \\alpha _ i)$. \n    \n      Finally, suppose that every nonconstant polynomial over $F$ is a product of linear factors. Let $E/F$ be an algebraic extension. Then all the simple subextensions $F(\\alpha )/F$ of $E$ are necessarily trivial (because the only irreducible polynomials are linear by assumption). Thus $E = F$. We see that (4) implies (1) and we are done. \n      $\\square$\n    \n"
182,09GR,"theorem exists_root [IsAlgClosed k] (p : k[X]) (hp : p.degree â‰  0) : âˆƒ x, IsRoot p x :=
  (IsAlgClosed.splits p).exists_eval_eq_zero hp
",Formal Proof of Stacks Project Tag 09GR,(4) âŸ¹ (3),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/IsAlgClosed/Basic.lean#L91-L92,Q27041,,9.10.2,lemma,3.0,"['09GP', '09FA', '0ELQ']","\n  Lemma 9.10.2. Let $F$ be a field. The following are equivalent \n  \n  \n$F$ is algebraically closed, \n\n\nevery irreducible polynomial over $F$ is linear, \n\n\nevery nonconstant polynomial over $F$ has a root, \n\n\nevery nonconstant polynomial over $F$ is a product of linear factors. \n\n\n\n\n    \n      Proof.\n      If $F$ is algebraically closed, then every irreducible polynomial is linear. Namely, if there exists an irreducible polynomial of degree $> 1$, then this generates a nontrivial finite (hence algebraic) field extension, see Example 9.7.6. Thus (1) implies (2). If every irreducible polynomial is linear, then every irreducible polynomial has a root, whence every nonconstant polynomial has a root. Thus (2) implies (3). \n    \n      Assume every nonconstant polynomial has a root. Let $P \\in F[x]$ be nonconstant. If $P(\\alpha ) = 0$ with $\\alpha \\in F$, then we see that $P = (x - \\alpha )Q$ for some $Q \\in F[x]$ (by division with remainder). Thus we can argue by induction on the degree that any nonconstant polynomial can be written as a product $c \\prod (x - \\alpha _ i)$. \n    \n      Finally, suppose that every nonconstant polynomial over $F$ is a product of linear factors. Let $E/F$ be an algebraic extension. Then all the simple subextensions $F(\\alpha )/F$ of $E$ are necessarily trivial (because the only irreducible polynomials are linear by assumption). Thus $E = F$. We see that (4) implies (1) and we are done. \n      $\\square$\n    \n","\n  Lemma 9.10.2. Let $F$ be a field. The following are equivalent \n  \n  \n$F$ is algebraically closed, \n\n\nevery irreducible polynomial over $F$ is linear, \n\n\nevery nonconstant polynomial over $F$ has a root, \n\n\nevery nonconstant polynomial over $F$ is a product of linear factors. \n\n\n\n\n    \n","Proof.\n      If $F$ is algebraically closed, then every irreducible polynomial is linear. Namely, if there exists an irreducible polynomial of degree $> 1$, then this generates a nontrivial finite (hence algebraic) field extension, see Example 9.7.6. Thus (1) implies (2). If every irreducible polynomial is linear, then every irreducible polynomial has a root, whence every nonconstant polynomial has a root. Thus (2) implies (3). \n    \n      Assume every nonconstant polynomial has a root. Let $P \\in F[x]$ be nonconstant. If $P(\\alpha ) = 0$ with $\\alpha \\in F$, then we see that $P = (x - \\alpha )Q$ for some $Q \\in F[x]$ (by division with remainder). Thus we can argue by induction on the degree that any nonconstant polynomial can be written as a product $c \\prod (x - \\alpha _ i)$. \n    \n      Finally, suppose that every nonconstant polynomial over $F$ is a product of linear factors. Let $E/F$ be an algebraic extension. Then all the simple subextensions $F(\\alpha )/F$ of $E$ are necessarily trivial (because the only irreducible polynomials are linear by assumption). Thus $E = F$. We see that (4) implies (1) and we are done. \n      $\\square$\n    \n","
  (IsAlgClosed.splits p).exists_eval_eq_zero hp
","theorem exists_root [IsAlgClosed k] (p : k[X]) (hp : p.degree â‰  0) : âˆƒ x, IsRoot p x ","Proof.\n      If $F$ is algebraically closed, then every irreducible polynomial is linear. Namely, if there exists an irreducible polynomial of degree $> 1$, then this generates a nontrivial finite (hence algebraic) field extension, see Example 9.7.6 [[\n  Example 9.7.6 (Degree of a simple algebraic extension).  Consider a monogenic field extension $E/k$ of the form discussed in Example 9.6.4. In other words, $E = k[t]/(P)$ for $P \\in k[t]$ an irreducible polynomial. Then the degree $[E : k]$ is just the degree $d = \\deg (P)$ of the polynomial $P$. Indeed, say \n  \n    9.7.6.1\n  \\begin{equation}  \\label{fields-equation-P} P = a_ d t^ d + a_{d - 1} t^{d - 1} + \\ldots + a_0. \\end{equation}\n\n   with $a_ d \\not= 0$. Then the images of $1, t, \\ldots , t^{d - 1}$ in $k[t]/(P)$ are linearly independent over $k$, because any relation involving them would have degree strictly smaller than that of $P$, and $P$ is the element of smallest degree in the ideal $(P)$. \n  Conversely, the set $S = \\{ 1, t, \\ldots , t^{d - 1}\\} $ (or more properly their images) spans $k[t]/(P)$ as a vector space. Indeed, we have by (9.7.6.1) that $a_ d t^ d$ lies in the span of $S$. Since $a_ d$ is invertible, we see that $t^ d$ is in the span of $S$. Similarly, the relation $t P(t) = 0$ shows that the image of $t^{d + 1}$ lies in the span of $\\{ 1, t, \\ldots , t^ d\\} $ \xe2\x80\x94 by what was just shown, thus in the span of $S$. Working upward inductively, we find that the image of $t^ n$ for $n \\geq d$ lies in the span of $S$. \n]]. Thus (1) implies (2). If every irreducible polynomial is linear, then every irreducible polynomial has a root, whence every nonconstant polynomial has a root. Thus (2) implies (3). \n    \n      Assume every nonconstant polynomial has a root. Let $P \\in F[x]$ be nonconstant. If $P(\\alpha ) = 0$ with $\\alpha \\in F$, then we see that $P = (x - \\alpha )Q$ for some $Q \\in F[x]$ (by division with remainder). Thus we can argue by induction on the degree that any nonconstant polynomial can be written as a product $c \\prod (x - \\alpha _ i)$. \n    \n      Finally, suppose that every nonconstant polynomial over $F$ is a product of linear factors. Let $E/F$ be an algebraic extension. Then all the simple subextensions $F(\\alpha )/F$ of $E$ are necessarily trivial (because the only irreducible polynomials are linear by assumption). Thus $E = F$. We see that (4) implies (1) and we are done. \n      $\\square$\n    \n"
183,09GR,"theorem of_exists_root (H : âˆ€ p : k[X], p.Monic â†’ Irreducible p â†’ âˆƒ x, p.eval x = 0) :
    IsAlgClosed k := by
  replace H (p : k[X]) (hp : Irreducible p) : âˆƒ x, p.eval x = 0 := by
    obtain âŸ¨x, hxâŸ© := H (p * C (leadingCoeff p)â»Â¹) (monic_mul_leadingCoeff_inv hp.ne_zero)
      (irreducible_mul_leadingCoeff_inv.mpr hp)
    exact âŸ¨x, by simpa [hp.ne_zero] using hxâŸ©
  refine âŸ¨fun p â†¦ ?_âŸ©
  by_cases hp0 : p = 0
  Â· simp [hp0]
  obtain âŸ¨u, huâŸ© := UniqueFactorizationMonoid.factors_prod hp0
  rw [â† hu]
  refine (Splits.multisetProd fun f hf â†¦ ?_).mul u.isUnit.splits
  let h := UniqueFactorizationMonoid.irreducible_of_factor f hf
  obtain âŸ¨x, hxâŸ© := H f h
  exact Splits.of_degree_eq_one (degree_eq_one_of_irreducible_of_root h hx)
",Formal Proof of Stacks Project Tag 09GR,(3) âŸ¹ (4),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/IsAlgClosed/Basic.lean#L194-L208,Q27041,,9.10.2,lemma,3.0,"['09GP', '09FA', '0ELQ']","\n  Lemma 9.10.2. Let $F$ be a field. The following are equivalent \n  \n  \n$F$ is algebraically closed, \n\n\nevery irreducible polynomial over $F$ is linear, \n\n\nevery nonconstant polynomial over $F$ has a root, \n\n\nevery nonconstant polynomial over $F$ is a product of linear factors. \n\n\n\n\n    \n      Proof.\n      If $F$ is algebraically closed, then every irreducible polynomial is linear. Namely, if there exists an irreducible polynomial of degree $> 1$, then this generates a nontrivial finite (hence algebraic) field extension, see Example 9.7.6. Thus (1) implies (2). If every irreducible polynomial is linear, then every irreducible polynomial has a root, whence every nonconstant polynomial has a root. Thus (2) implies (3). \n    \n      Assume every nonconstant polynomial has a root. Let $P \\in F[x]$ be nonconstant. If $P(\\alpha ) = 0$ with $\\alpha \\in F$, then we see that $P = (x - \\alpha )Q$ for some $Q \\in F[x]$ (by division with remainder). Thus we can argue by induction on the degree that any nonconstant polynomial can be written as a product $c \\prod (x - \\alpha _ i)$. \n    \n      Finally, suppose that every nonconstant polynomial over $F$ is a product of linear factors. Let $E/F$ be an algebraic extension. Then all the simple subextensions $F(\\alpha )/F$ of $E$ are necessarily trivial (because the only irreducible polynomials are linear by assumption). Thus $E = F$. We see that (4) implies (1) and we are done. \n      $\\square$\n    \n","\n  Lemma 9.10.2. Let $F$ be a field. The following are equivalent \n  \n  \n$F$ is algebraically closed, \n\n\nevery irreducible polynomial over $F$ is linear, \n\n\nevery nonconstant polynomial over $F$ has a root, \n\n\nevery nonconstant polynomial over $F$ is a product of linear factors. \n\n\n\n\n    \n","Proof.\n      If $F$ is algebraically closed, then every irreducible polynomial is linear. Namely, if there exists an irreducible polynomial of degree $> 1$, then this generates a nontrivial finite (hence algebraic) field extension, see Example 9.7.6. Thus (1) implies (2). If every irreducible polynomial is linear, then every irreducible polynomial has a root, whence every nonconstant polynomial has a root. Thus (2) implies (3). \n    \n      Assume every nonconstant polynomial has a root. Let $P \\in F[x]$ be nonconstant. If $P(\\alpha ) = 0$ with $\\alpha \\in F$, then we see that $P = (x - \\alpha )Q$ for some $Q \\in F[x]$ (by division with remainder). Thus we can argue by induction on the degree that any nonconstant polynomial can be written as a product $c \\prod (x - \\alpha _ i)$. \n    \n      Finally, suppose that every nonconstant polynomial over $F$ is a product of linear factors. Let $E/F$ be an algebraic extension. Then all the simple subextensions $F(\\alpha )/F$ of $E$ are necessarily trivial (because the only irreducible polynomials are linear by assumption). Thus $E = F$. We see that (4) implies (1) and we are done. \n      $\\square$\n    \n"," by
  replace H (p : k[X]) (hp : Irreducible p) : âˆƒ x, p.eval x = 0 := by
    obtain âŸ¨x, hxâŸ© := H (p * C (leadingCoeff p)â»Â¹) (monic_mul_leadingCoeff_inv hp.ne_zero)
      (irreducible_mul_leadingCoeff_inv.mpr hp)
    exact âŸ¨x, by simpa [hp.ne_zero] using hxâŸ©
  refine âŸ¨fun p â†¦ ?_âŸ©
  by_cases hp0 : p = 0
  Â· simp [hp0]
  obtain âŸ¨u, huâŸ© := UniqueFactorizationMonoid.factors_prod hp0
  rw [â† hu]
  refine (Splits.multisetProd fun f hf â†¦ ?_).mul u.isUnit.splits
  let h := UniqueFactorizationMonoid.irreducible_of_factor f hf
  obtain âŸ¨x, hxâŸ© := H f h
  exact Splits.of_degree_eq_one (degree_eq_one_of_irreducible_of_root h hx)
","theorem of_exists_root (H : âˆ€ p : k[X], p.Monic â†’ Irreducible p â†’ âˆƒ x, p.eval x = 0) :
    IsAlgClosed k ","Proof.\n      If $F$ is algebraically closed, then every irreducible polynomial is linear. Namely, if there exists an irreducible polynomial of degree $> 1$, then this generates a nontrivial finite (hence algebraic) field extension, see Example 9.7.6 [[\n  Example 9.7.6 (Degree of a simple algebraic extension).  Consider a monogenic field extension $E/k$ of the form discussed in Example 9.6.4. In other words, $E = k[t]/(P)$ for $P \\in k[t]$ an irreducible polynomial. Then the degree $[E : k]$ is just the degree $d = \\deg (P)$ of the polynomial $P$. Indeed, say \n  \n    9.7.6.1\n  \\begin{equation}  \\label{fields-equation-P} P = a_ d t^ d + a_{d - 1} t^{d - 1} + \\ldots + a_0. \\end{equation}\n\n   with $a_ d \\not= 0$. Then the images of $1, t, \\ldots , t^{d - 1}$ in $k[t]/(P)$ are linearly independent over $k$, because any relation involving them would have degree strictly smaller than that of $P$, and $P$ is the element of smallest degree in the ideal $(P)$. \n  Conversely, the set $S = \\{ 1, t, \\ldots , t^{d - 1}\\} $ (or more properly their images) spans $k[t]/(P)$ as a vector space. Indeed, we have by (9.7.6.1) that $a_ d t^ d$ lies in the span of $S$. Since $a_ d$ is invertible, we see that $t^ d$ is in the span of $S$. Similarly, the relation $t P(t) = 0$ shows that the image of $t^{d + 1}$ lies in the span of $\\{ 1, t, \\ldots , t^ d\\} $ \xe2\x80\x94 by what was just shown, thus in the span of $S$. Working upward inductively, we find that the image of $t^ n$ for $n \\geq d$ lies in the span of $S$. \n]]. Thus (1) implies (2). If every irreducible polynomial is linear, then every irreducible polynomial has a root, whence every nonconstant polynomial has a root. Thus (2) implies (3). \n    \n      Assume every nonconstant polynomial has a root. Let $P \\in F[x]$ be nonconstant. If $P(\\alpha ) = 0$ with $\\alpha \\in F$, then we see that $P = (x - \\alpha )Q$ for some $Q \\in F[x]$ (by division with remainder). Thus we can argue by induction on the degree that any nonconstant polynomial can be written as a product $c \\prod (x - \\alpha _ i)$. \n    \n      Finally, suppose that every nonconstant polynomial over $F$ is a product of linear factors. Let $E/F$ be an algebraic extension. Then all the simple subextensions $F(\\alpha )/F$ of $E$ are necessarily trivial (because the only irreducible polynomials are linear by assumption). Thus $E = F$. We see that (4) implies (1) and we are done. \n      $\\square$\n    \n"
184,09GR,"theorem degree_eq_one_of_irreducible [IsAlgClosed k] {p : k[X]} (hp : Irreducible p) :
    p.degree = 1 :=
  (IsAlgClosed.splits p).degree_eq_one_of_irreducible hp
",Formal Proof of Stacks Project Tag 09GR,(4) âŸ¹ (2),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/IsAlgClosed/Basic.lean#L229-L231,Q27041,,9.10.2,lemma,3.0,"['09GP', '09FA', '0ELQ']","\n  Lemma 9.10.2. Let $F$ be a field. The following are equivalent \n  \n  \n$F$ is algebraically closed, \n\n\nevery irreducible polynomial over $F$ is linear, \n\n\nevery nonconstant polynomial over $F$ has a root, \n\n\nevery nonconstant polynomial over $F$ is a product of linear factors. \n\n\n\n\n    \n      Proof.\n      If $F$ is algebraically closed, then every irreducible polynomial is linear. Namely, if there exists an irreducible polynomial of degree $> 1$, then this generates a nontrivial finite (hence algebraic) field extension, see Example 9.7.6. Thus (1) implies (2). If every irreducible polynomial is linear, then every irreducible polynomial has a root, whence every nonconstant polynomial has a root. Thus (2) implies (3). \n    \n      Assume every nonconstant polynomial has a root. Let $P \\in F[x]$ be nonconstant. If $P(\\alpha ) = 0$ with $\\alpha \\in F$, then we see that $P = (x - \\alpha )Q$ for some $Q \\in F[x]$ (by division with remainder). Thus we can argue by induction on the degree that any nonconstant polynomial can be written as a product $c \\prod (x - \\alpha _ i)$. \n    \n      Finally, suppose that every nonconstant polynomial over $F$ is a product of linear factors. Let $E/F$ be an algebraic extension. Then all the simple subextensions $F(\\alpha )/F$ of $E$ are necessarily trivial (because the only irreducible polynomials are linear by assumption). Thus $E = F$. We see that (4) implies (1) and we are done. \n      $\\square$\n    \n","\n  Lemma 9.10.2. Let $F$ be a field. The following are equivalent \n  \n  \n$F$ is algebraically closed, \n\n\nevery irreducible polynomial over $F$ is linear, \n\n\nevery nonconstant polynomial over $F$ has a root, \n\n\nevery nonconstant polynomial over $F$ is a product of linear factors. \n\n\n\n\n    \n","Proof.\n      If $F$ is algebraically closed, then every irreducible polynomial is linear. Namely, if there exists an irreducible polynomial of degree $> 1$, then this generates a nontrivial finite (hence algebraic) field extension, see Example 9.7.6. Thus (1) implies (2). If every irreducible polynomial is linear, then every irreducible polynomial has a root, whence every nonconstant polynomial has a root. Thus (2) implies (3). \n    \n      Assume every nonconstant polynomial has a root. Let $P \\in F[x]$ be nonconstant. If $P(\\alpha ) = 0$ with $\\alpha \\in F$, then we see that $P = (x - \\alpha )Q$ for some $Q \\in F[x]$ (by division with remainder). Thus we can argue by induction on the degree that any nonconstant polynomial can be written as a product $c \\prod (x - \\alpha _ i)$. \n    \n      Finally, suppose that every nonconstant polynomial over $F$ is a product of linear factors. Let $E/F$ be an algebraic extension. Then all the simple subextensions $F(\\alpha )/F$ of $E$ are necessarily trivial (because the only irreducible polynomials are linear by assumption). Thus $E = F$. We see that (4) implies (1) and we are done. \n      $\\square$\n    \n","
  (IsAlgClosed.splits p).degree_eq_one_of_irreducible hp
","theorem degree_eq_one_of_irreducible [IsAlgClosed k] {p : k[X]} (hp : Irreducible p) :
    p.degree = 1 ","Proof.\n      If $F$ is algebraically closed, then every irreducible polynomial is linear. Namely, if there exists an irreducible polynomial of degree $> 1$, then this generates a nontrivial finite (hence algebraic) field extension, see Example 9.7.6 [[\n  Example 9.7.6 (Degree of a simple algebraic extension).  Consider a monogenic field extension $E/k$ of the form discussed in Example 9.6.4. In other words, $E = k[t]/(P)$ for $P \\in k[t]$ an irreducible polynomial. Then the degree $[E : k]$ is just the degree $d = \\deg (P)$ of the polynomial $P$. Indeed, say \n  \n    9.7.6.1\n  \\begin{equation}  \\label{fields-equation-P} P = a_ d t^ d + a_{d - 1} t^{d - 1} + \\ldots + a_0. \\end{equation}\n\n   with $a_ d \\not= 0$. Then the images of $1, t, \\ldots , t^{d - 1}$ in $k[t]/(P)$ are linearly independent over $k$, because any relation involving them would have degree strictly smaller than that of $P$, and $P$ is the element of smallest degree in the ideal $(P)$. \n  Conversely, the set $S = \\{ 1, t, \\ldots , t^{d - 1}\\} $ (or more properly their images) spans $k[t]/(P)$ as a vector space. Indeed, we have by (9.7.6.1) that $a_ d t^ d$ lies in the span of $S$. Since $a_ d$ is invertible, we see that $t^ d$ is in the span of $S$. Similarly, the relation $t P(t) = 0$ shows that the image of $t^{d + 1}$ lies in the span of $\\{ 1, t, \\ldots , t^ d\\} $ \xe2\x80\x94 by what was just shown, thus in the span of $S$. Working upward inductively, we find that the image of $t^ n$ for $n \\geq d$ lies in the span of $S$. \n]]. Thus (1) implies (2). If every irreducible polynomial is linear, then every irreducible polynomial has a root, whence every nonconstant polynomial has a root. Thus (2) implies (3). \n    \n      Assume every nonconstant polynomial has a root. Let $P \\in F[x]$ be nonconstant. If $P(\\alpha ) = 0$ with $\\alpha \\in F$, then we see that $P = (x - \\alpha )Q$ for some $Q \\in F[x]$ (by division with remainder). Thus we can argue by induction on the degree that any nonconstant polynomial can be written as a product $c \\prod (x - \\alpha _ i)$. \n    \n      Finally, suppose that every nonconstant polynomial over $F$ is a product of linear factors. Let $E/F$ be an algebraic extension. Then all the simple subextensions $F(\\alpha )/F$ of $E$ are necessarily trivial (because the only irreducible polynomials are linear by assumption). Thus $E = F$. We see that (4) implies (1) and we are done. \n      $\\square$\n    \n"
185,09GQ,"This statement is 09GR (4) âŸ¹ (1).""]
theorem IntermediateField.eq_bot_of_isAlgClosed_of_isAlgebraic {k K : Type*} [Field k] [Field K]
    [IsAlgClosed k] [Algebra k K] (L : IntermediateField k K) [Algebra.IsAlgebraic k L] :
    L = âŠ¥ := bot_unique fun x hx â†¦ by
  obtain âŸ¨y, hyâŸ© := (IsAlgClosed.algebraMap_bijective_of_isIntegral (k := k)).2 (âŸ¨x, hxâŸ© : L)
  exact âŸ¨y, congr_arg (algebraMap L K) hyâŸ©
",Formal Proof of Stacks Project Tag 09GQ,The result is the definition of algebraically closedness in Stacks Project. ,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/IsAlgClosed/Basic.lean#L257-L262,Q27041,,9.10.1,definition,3.0,"['09GP', '09FA', '0ELQ']","\n  Definition 9.10.1. A field $F$ is said to be algebraically closed if every algebraic extension $E/F$ is trivial, i.e., $E = F$. \n","\n  Definition 9.10.1. A field $F$ is said to be algebraically closed if every algebraic extension $E/F$ is trivial, i.e., $E = F$. \n",," bot_unique fun x hx â†¦ by
  obtain âŸ¨y, hyâŸ© := (IsAlgClosed.algebraMap_bijective_of_isIntegral (k := k)).2 (âŸ¨x, hxâŸ© : L)
  exact âŸ¨y, congr_arg (algebraMap L K) hyâŸ©
","This statement is 09GR (4) âŸ¹ (1).""]
theorem IntermediateField.eq_bot_of_isAlgClosed_of_isAlgebraic {k K : Type*} [Field k] [Field K]
    [IsAlgClosed k] [Algebra k K] (L : IntermediateField k K) [Algebra.IsAlgebraic k L] :
    L = âŠ¥ ",
186,09GS,"class IsAlgClosure (R : Type u) (K : Type v) [CommRing R] [Field K] [Algebra R K]
    [IsTorsionFree R K] : Prop where
  isAlgClosed : IsAlgClosed K
  isAlgebraic : Algebra.IsAlgebraic R K
",Formal Proof of Stacks Project Tag 09GS,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/IsAlgClosed/Basic.lean#L277-L280,Q27041,,9.10.3,definition,3.0,"['09GP', '09FA', '0ELQ']",\n  Definition 9.10.3. Let $F$ be a field. An algebraic closure of $F$ is a field $\\overline{F}$ containing $F$ such that: \n  \n  \n$\\overline{F}$ is algebraic over $F$. \n\n\n$\\overline{F}$ is algebraically closed. \n\n\n\n,\n  Definition 9.10.3. Let $F$ be a field. An algebraic closure of $F$ is a field $\\overline{F}$ containing $F$ such that: \n  \n  \n$\\overline{F}$ is algebraic over $F$. \n\n\n$\\overline{F}$ is algebraically closed. \n\n\n\n,,,"class IsAlgClosure (R : Type u) (K : Type v) [CommRing R] [Field K] [Algebra R K]
    [IsTorsionFree R K] : Prop where
  isAlgClosed : IsAlgClosed K
  isAlgebraic : Algebra.IsAlgebraic R K
",
187,09GU,"noncomputable irreducible_def lift : S â†’â‚[R] M := by
  letI : IsDomain R := (FaithfulSMul.algebraMap_injective R S).isDomain _
  letI := FractionRing.liftAlgebra R M
  letI := FractionRing.liftAlgebra R (FractionRing S)
  have := FractionRing.isScalarTower_liftAlgebra R M
  have := FractionRing.isScalarTower_liftAlgebra R (FractionRing S)
  let f : FractionRing S â†’â‚[FractionRing R] M := liftAux (FractionRing R) (FractionRing S) M
  exact (f.restrictScalars R).comp ((Algebra.ofId S (FractionRing S)).restrictScalars R)
",Formal Proof of Stacks Project Tag 09GU,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/IsAlgClosed/Basic.lean#L360-L367,Q27041,,9.10.5,lemma,3.0,"['09GP', '09FA', '0ELQ']","\n  Lemma 9.10.5. Let $F$ be a field. Let $\\overline{F}$ be an algebraic closure of $F$. Let $M/F$ be an algebraic extension. Then there is a morphism of $F$-extensions $M \\to \\overline{F}$. \n\n    \n      Proof.\n      Consider the set $I$ of pairs $(E, \\varphi )$ where $F \\subset E \\subset M$ is a subextension and $\\varphi : E \\to \\overline{F}$ is a morphism of $F$-extensions. We partially order the set $I$ by declaring $(E, \\varphi ) \\leq (E\', \\varphi \')$ if and only if $E \\subset E\'$ and $\\varphi \'|_ E = \\varphi $. If $T = \\{ (E_ t, \\varphi _ t)\\}  \\subset I$ is a totally ordered subset, then $\\bigcup \\varphi _ t : \\bigcup E_ t \\to \\overline{F}$ is an element of $I$. Thus every totally ordered subset of $I$ has an upper bound. By Zorn\'s lemma there exists a maximal element $(E, \\varphi )$ in $I$. We claim that $E = M$, which will finish the proof. If not, then pick $\\alpha \\in M$, $\\alpha \\not\\in E$. The $\\alpha $ is algebraic over $E$, see Lemma 9.8.4. Let $P$ be the minimal polynomial of $\\alpha $ over $E$. Let $P^\\varphi $ be the image of $P$ by $\\varphi $ in $\\overline{F}[x]$. Since $\\overline{F}$ is algebraically closed there is a root $\\beta $ of $P^\\varphi $ in $\\overline{F}$. Then we can extend $\\varphi $ to $\\varphi \' : E(\\alpha ) = E[x]/(P) \\to \\overline{F}$ by mapping $x$ to $\\beta $. This contradicts the maximality of $(E, \\varphi )$ as desired. \n      $\\square$\n    \n",\n  Lemma 9.10.5. Let $F$ be a field. Let $\\overline{F}$ be an algebraic closure of $F$. Let $M/F$ be an algebraic extension. Then there is a morphism of $F$-extensions $M \\to \\overline{F}$. \n\n    \n,"Proof.\n      Consider the set $I$ of pairs $(E, \\varphi )$ where $F \\subset E \\subset M$ is a subextension and $\\varphi : E \\to \\overline{F}$ is a morphism of $F$-extensions. We partially order the set $I$ by declaring $(E, \\varphi ) \\leq (E\', \\varphi \')$ if and only if $E \\subset E\'$ and $\\varphi \'|_ E = \\varphi $. If $T = \\{ (E_ t, \\varphi _ t)\\}  \\subset I$ is a totally ordered subset, then $\\bigcup \\varphi _ t : \\bigcup E_ t \\to \\overline{F}$ is an element of $I$. Thus every totally ordered subset of $I$ has an upper bound. By Zorn\'s lemma there exists a maximal element $(E, \\varphi )$ in $I$. We claim that $E = M$, which will finish the proof. If not, then pick $\\alpha \\in M$, $\\alpha \\not\\in E$. The $\\alpha $ is algebraic over $E$, see Lemma 9.8.4. Let $P$ be the minimal polynomial of $\\alpha $ over $E$. Let $P^\\varphi $ be the image of $P$ by $\\varphi $ in $\\overline{F}[x]$. Since $\\overline{F}$ is algebraically closed there is a root $\\beta $ of $P^\\varphi $ in $\\overline{F}$. Then we can extend $\\varphi $ to $\\varphi \' : E(\\alpha ) = E[x]/(P) \\to \\overline{F}$ by mapping $x$ to $\\beta $. This contradicts the maximality of $(E, \\varphi )$ as desired. \n      $\\square$\n    \n"," by
  letI : IsDomain R := (FaithfulSMul.algebraMap_injective R S).isDomain _
  letI := FractionRing.liftAlgebra R M
  letI := FractionRing.liftAlgebra R (FractionRing S)
  have := FractionRing.isScalarTower_liftAlgebra R M
  have := FractionRing.isScalarTower_liftAlgebra R (FractionRing S)
  let f : FractionRing S â†’â‚[FractionRing R] M := liftAux (FractionRing R) (FractionRing S) M
  exact (f.restrictScalars R).comp ((Algebra.ofId S (FractionRing S)).restrictScalars R)
",noncomputable irreducible_def lift : S â†’â‚[R] M ,"Proof.\n      Consider the set $I$ of pairs $(E, \\varphi )$ where $F \\subset E \\subset M$ is a subextension and $\\varphi : E \\to \\overline{F}$ is a morphism of $F$-extensions. We partially order the set $I$ by declaring $(E, \\varphi ) \\leq (E\', \\varphi \')$ if and only if $E \\subset E\'$ and $\\varphi \'|_ E = \\varphi $. If $T = \\{ (E_ t, \\varphi _ t)\\}  \\subset I$ is a totally ordered subset, then $\\bigcup \\varphi _ t : \\bigcup E_ t \\to \\overline{F}$ is an element of $I$. Thus every totally ordered subset of $I$ has an upper bound. By Zorn\'s lemma there exists a maximal element $(E, \\varphi )$ in $I$. We claim that $E = M$, which will finish the proof. If not, then pick $\\alpha \\in M$, $\\alpha \\not\\in E$. The $\\alpha $ is algebraic over $E$, see Lemma 9.8.4 [[\n  Lemma 9.8.4. Let $K/E/F$ be a tower of field extensions. \n  \n  \nIf $\\alpha \\in K$ is algebraic over $F$, then $\\alpha $ is algebraic over $E$. \n\n\nIf $K$ is algebraic over $F$, then $K$ is algebraic over $E$. \n\n\n\n\n    \n]]. Let $P$ be the minimal polynomial of $\\alpha $ over $E$. Let $P^\\varphi $ be the image of $P$ by $\\varphi $ in $\\overline{F}[x]$. Since $\\overline{F}$ is algebraically closed there is a root $\\beta $ of $P^\\varphi $ in $\\overline{F}$. Then we can extend $\\varphi $ to $\\varphi \' : E(\\alpha ) = E[x]/(P) \\to \\overline{F}$ by mapping $x$ to $\\beta $. This contradicts the maximality of $(E, \\varphi )$ as desired. \n      $\\square$\n    \n"
188,09GV,"noncomputable def equiv : L â‰ƒâ‚[R] M :=
  AlgEquiv.ofBijective _ (IsAlgClosure.isAlgebraic.algHom_bijectiveâ‚‚
    (IsAlgClosed.lift : L â†’â‚[R] M)
    (IsAlgClosed.lift : M â†’â‚[R] L)).1
",Formal Proof of Stacks Project Tag 09GV,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/IsAlgClosed/Basic.lean#L415-L418,Q27041,,9.10.6,lemma,3.0,"['09GP', '09FA', '0ELQ']","\n  Lemma 9.10.6. Any two algebraic closures of a field are isomorphic. \n\n    \n      Proof.\n      Let $F$ be a field. If $M$ and $\\overline{F}$ are algebraic closures of $F$, then there exists a morphism of $F$-extensions $\\varphi : M \\to \\overline{F}$ by Lemma 9.10.5. Now the image $\\varphi (M)$ is algebraically closed. On the other hand, the extension $\\varphi (M) \\subset \\overline{F}$ is algebraic by Lemma 9.8.4. Thus $\\varphi (M) = \\overline{F}$. \n      $\\square$\n    \n",\n  Lemma 9.10.6. Any two algebraic closures of a field are isomorphic. \n\n    \n,"Proof.\n      Let $F$ be a field. If $M$ and $\\overline{F}$ are algebraic closures of $F$, then there exists a morphism of $F$-extensions $\\varphi : M \\to \\overline{F}$ by Lemma 9.10.5. Now the image $\\varphi (M)$ is algebraically closed. On the other hand, the extension $\\varphi (M) \\subset \\overline{F}$ is algebraic by Lemma 9.8.4. Thus $\\varphi (M) = \\overline{F}$. \n      $\\square$\n    \n","
  AlgEquiv.ofBijective _ (IsAlgClosure.isAlgebraic.algHom_bijectiveâ‚‚
    (IsAlgClosed.lift : L â†’â‚[R] M)
    (IsAlgClosed.lift : M â†’â‚[R] L)).1
",noncomputable def equiv : L â‰ƒâ‚[R] M ,"Proof.\n      Let $F$ be a field. If $M$ and $\\overline{F}$ are algebraic closures of $F$, then there exists a morphism of $F$-extensions $\\varphi : M \\to \\overline{F}$ by Lemma 9.10.5 [[\n  Lemma 9.10.5. Let $F$ be a field. Let $\\overline{F}$ be an algebraic closure of $F$. Let $M/F$ be an algebraic extension. Then there is a morphism of $F$-extensions $M \\to \\overline{F}$. \n\n    \n]]. Now the image $\\varphi (M)$ is algebraically closed. On the other hand, the extension $\\varphi (M) \\subset \\overline{F}$ is algebraic by Lemma 9.8.4 [[\n  Lemma 9.8.4. Let $K/E/F$ be a tower of field extensions. \n  \n  \nIf $\\alpha \\in K$ is algebraic over $F$, then $\\alpha $ is algebraic over $E$. \n\n\nIf $K$ is algebraic over $F$, then $K$ is algebraic over $E$. \n\n\n\n\n    \n]]. Thus $\\varphi (M) = \\overline{F}$. \n      $\\square$\n    \n"
189,09GM,"noncomputable def minpoly (x : B) : A[X] :=
  if hx : IsIntegral A x then degree_lt_wf.min _ hx else 0
",Formal Proof of Stacks Project Tag 09GM,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/Minpoly/Basic.lean#L41-L42,Q27041,,9.9.1,definition,3.0,"['09GL', '09FA', '0ELQ']",\n  Definition 9.9.1. The polynomial $P$ above is called the minimal polynomial of $\\alpha $ over $k$. \n,\n  Definition 9.9.1. The polynomial $P$ above is called the minimal polynomial of $\\alpha $ over $k$. \n,,"
  if hx : IsIntegral A x then degree_lt_wf.min _ hx else 0
",noncomputable def minpoly (x : B) : A[X] ,
190,09HU,"theorem Normal.of_isSplittingField (p : F[X]) [hFEp : IsSplittingField F E p] : Normal F E := by
  rcases eq_or_ne p 0 with (rfl | hp)
  Â· have := hFEp.adjoin_rootSet
    rw [rootSet_zero, Algebra.adjoin_empty] at this
    exact Normal.of_algEquiv
      (AlgEquiv.ofBijective (Algebra.ofId F E) (Algebra.bijective_algebraMap_iff.2 this.symm))
  refine normal_iff.mpr fun x â†¦ ?_
  haveI : FiniteDimensional F E := IsSplittingField.finiteDimensional E p
  have hx := IsIntegral.of_finite F x
  let L := (p * minpoly F x).SplittingField
  have hL := SplittingField.splits (p * minpoly F x)
  rw [Polynomial.map_mul, splits_mul_iff _ (map_ne_zero (minpoly.ne_zero hx))] at hL
  Â· obtain âŸ¨hL1, hL2âŸ© := hL
    let j : E â†’â‚[F] L := IsSplittingField.lift E p hL1
    rw [â† j.comp_algebraMap, â† Polynomial.map_map] at hL2
    refine âŸ¨hx, Splits.of_splits_map (j : E â†’+* L) hL2 fun a ha â†¦ ?_âŸ©
    rw [Polynomial.map_map, j.comp_algebraMap] at ha
    letI : Algebra FâŸ®xâŸ¯ L := ((algHomAdjoinIntegralEquiv F hx).symm âŸ¨a, haâŸ©).toRingHom.toAlgebra
    let j' : E â†’â‚[FâŸ®xâŸ¯] L := IsSplittingField.lift E (p.map (algebraMap F FâŸ®xâŸ¯)) ?_
    Â· change a âˆˆ j.range
      rw [â† IsSplittingField.adjoin_rootSet_eq_range E p j,
            IsSplittingField.adjoin_rootSet_eq_range E p (j'.restrictScalars F)]
      exact âŸ¨x, (j'.commutes _).trans (algHomAdjoinIntegralEquiv_symm_apply_gen F hx _)âŸ©
    Â· rwa [Polynomial.map_map, â† IsScalarTower.algebraMap_eq]
  Â· exact Polynomial.map_ne_zero hp
",Formal Proof of Stacks Project Tag 09HU,Normal part,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/Normal/Basic.lean#L63-L87,Q27041,,9.16.1,lemma,3.0,"['09HT', '09FA', '0ELQ']","\n  Lemma 9.16.1. Let $F$ be a field. Let $P \\in F[x]$ be a nonconstant polynomial. There exists a smallest field extension $E/F$ such that $P$ splits completely over $E$. Moreover, the field extension $E/F$ is normal and unique up to (nonunique) isomorphism. \n\n    \n      Proof.\n      Choose an algebraic closure $\\overline{F}$. Then we can write $P = c (x - \\beta _1) \\ldots (x - \\beta _ n)$ in $\\overline{F}[x]$, see Lemma 9.10.2. Note that $c \\in F^*$. Set $E = F(\\beta _1, \\ldots , \\beta _ n)$. Then it is clear that $E$ is minimal with the requirement that $P$ splits completely over $E$. \n    \n      Next, let $E\'$ be another minimal field extension of $F$ such that $P$ splits completely over $E\'$. Write $P = c (x - \\alpha _1) \\ldots (x - \\alpha _ n)$ with $c \\in F$ and $\\alpha _ i \\in E\'$. Again it follows from minimality that $E\' = F(\\alpha _1, \\ldots , \\alpha _ n)$. Moreover, if we pick any $\\sigma : E\' \\to \\overline{F}$ (Lemma 9.10.5) then we immediately see that $\\sigma (\\alpha _ i) = \\beta _{\\tau (i)}$ for some permutation $\\tau : \\{ 1, \\ldots , n\\}  \\to \\{ 1, \\ldots , n\\} $. Thus $\\sigma (E\') = E$. This implies that $E\'$ is a normal extension of $F$ by Lemma 9.15.5 and that $E \\cong E\'$ as extensions of $F$ thereby finishing the proof. \n      $\\square$\n    \n","\n  Lemma 9.16.1. Let $F$ be a field. Let $P \\in F[x]$ be a nonconstant polynomial. There exists a smallest field extension $E/F$ such that $P$ splits completely over $E$. Moreover, the field extension $E/F$ is normal and unique up to (nonunique) isomorphism. \n\n    \n","Proof.\n      Choose an algebraic closure $\\overline{F}$. Then we can write $P = c (x - \\beta _1) \\ldots (x - \\beta _ n)$ in $\\overline{F}[x]$, see Lemma 9.10.2. Note that $c \\in F^*$. Set $E = F(\\beta _1, \\ldots , \\beta _ n)$. Then it is clear that $E$ is minimal with the requirement that $P$ splits completely over $E$. \n    \n      Next, let $E\'$ be another minimal field extension of $F$ such that $P$ splits completely over $E\'$. Write $P = c (x - \\alpha _1) \\ldots (x - \\alpha _ n)$ with $c \\in F$ and $\\alpha _ i \\in E\'$. Again it follows from minimality that $E\' = F(\\alpha _1, \\ldots , \\alpha _ n)$. Moreover, if we pick any $\\sigma : E\' \\to \\overline{F}$ (Lemma 9.10.5) then we immediately see that $\\sigma (\\alpha _ i) = \\beta _{\\tau (i)}$ for some permutation $\\tau : \\{ 1, \\ldots , n\\}  \\to \\{ 1, \\ldots , n\\} $. Thus $\\sigma (E\') = E$. This implies that $E\'$ is a normal extension of $F$ by Lemma 9.15.5 and that $E \\cong E\'$ as extensions of $F$ thereby finishing the proof. \n      $\\square$\n    \n"," by
  rcases eq_or_ne p 0 with (rfl | hp)
  Â· have := hFEp.adjoin_rootSet
    rw [rootSet_zero, Algebra.adjoin_empty] at this
    exact Normal.of_algEquiv
      (AlgEquiv.ofBijective (Algebra.ofId F E) (Algebra.bijective_algebraMap_iff.2 this.symm))
  refine normal_iff.mpr fun x â†¦ ?_
  haveI : FiniteDimensional F E := IsSplittingField.finiteDimensional E p
  have hx := IsIntegral.of_finite F x
  let L := (p * minpoly F x).SplittingField
  have hL := SplittingField.splits (p * minpoly F x)
  rw [Polynomial.map_mul, splits_mul_iff _ (map_ne_zero (minpoly.ne_zero hx))] at hL
  Â· obtain âŸ¨hL1, hL2âŸ© := hL
    let j : E â†’â‚[F] L := IsSplittingField.lift E p hL1
    rw [â† j.comp_algebraMap, â† Polynomial.map_map] at hL2
    refine âŸ¨hx, Splits.of_splits_map (j : E â†’+* L) hL2 fun a ha â†¦ ?_âŸ©
    rw [Polynomial.map_map, j.comp_algebraMap] at ha
    letI : Algebra FâŸ®xâŸ¯ L := ((algHomAdjoinIntegralEquiv F hx).symm âŸ¨a, haâŸ©).toRingHom.toAlgebra
    let j' : E â†’â‚[FâŸ®xâŸ¯] L := IsSplittingField.lift E (p.map (algebraMap F FâŸ®xâŸ¯)) ?_
    Â· change a âˆˆ j.range
      rw [â† IsSplittingField.adjoin_rootSet_eq_range E p j,
            IsSplittingField.adjoin_rootSet_eq_range E p (j'.restrictScalars F)]
      exact âŸ¨x, (j'.commutes _).trans (algHomAdjoinIntegralEquiv_symm_apply_gen F hx _)âŸ©
    Â· rwa [Polynomial.map_map, â† IsScalarTower.algebraMap_eq]
  Â· exact Polynomial.map_ne_zero hp
",theorem Normal.of_isSplittingField (p : F[X]) [hFEp : IsSplittingField F E p] : Normal F E ,"Proof.\n      Choose an algebraic closure $\\overline{F}$. Then we can write $P = c (x - \\beta _1) \\ldots (x - \\beta _ n)$ in $\\overline{F}[x]$, see Lemma 9.10.2 [[\n  Lemma 9.10.2. Let $F$ be a field. The following are equivalent \n  \n  \n$F$ is algebraically closed, \n\n\nevery irreducible polynomial over $F$ is linear, \n\n\nevery nonconstant polynomial over $F$ has a root, \n\n\nevery nonconstant polynomial over $F$ is a product of linear factors. \n\n\n\n\n    \n]]. Note that $c \\in F^*$. Set $E = F(\\beta _1, \\ldots , \\beta _ n)$. Then it is clear that $E$ is minimal with the requirement that $P$ splits completely over $E$. \n    \n      Next, let $E\'$ be another minimal field extension of $F$ such that $P$ splits completely over $E\'$. Write $P = c (x - \\alpha _1) \\ldots (x - \\alpha _ n)$ with $c \\in F$ and $\\alpha _ i \\in E\'$. Again it follows from minimality that $E\' = F(\\alpha _1, \\ldots , \\alpha _ n)$. Moreover, if we pick any $\\sigma : E\' \\to \\overline{F}$ (Lemma 9.10.5 [[\n  Lemma 9.10.5. Let $F$ be a field. Let $\\overline{F}$ be an algebraic closure of $F$. Let $M/F$ be an algebraic extension. Then there is a morphism of $F$-extensions $M \\to \\overline{F}$. \n\n    \n]]) then we immediately see that $\\sigma (\\alpha _ i) = \\beta _{\\tau (i)}$ for some permutation $\\tau : \\{ 1, \\ldots , n\\}  \\to \\{ 1, \\ldots , n\\} $. Thus $\\sigma (E\') = E$. This implies that $E\'$ is a normal extension of $F$ by Lemma 9.15.5 [[\n  Lemma 9.15.5. Let $E/F$ be an algebraic extension of fields. Let $\\overline{F}$ be an algebraic closure of $F$. The following are equivalent \n  \n  \n$E$ is normal over $F$, and \n\n\nfor every pair $\\sigma , \\sigma \' \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})$ we have $\\sigma (E) = \\sigma \'(E)$. \n\n\n\n\n    \n]] and that $E \\cong E\'$ as extensions of $F$ thereby finishing the proof. \n      $\\square$\n    \n"
191,0BR3,"theorem splits_of_mem_adjoin {L} [Field L] [Algebra F L] {S : Set K}
    (splits : âˆ€ x âˆˆ S, IsIntegral F x âˆ§ ((minpoly F x).map (algebraMap F L)).Splits) {x : K}
    (hx : x âˆˆ adjoin F S) : ((minpoly F x).map (algebraMap F L)).Splits := by
  let E : IntermediateField F L := â¨† x : S, adjoin F ((minpoly F x.val).rootSet L)
  have normal : Normal F E := normal_iSup (h := fun x â†¦
    Normal.of_isSplittingField (hFEp := adjoin_rootSet_isSplittingField (splits x x.2).2))
  have : âˆ€ x âˆˆ S, ((minpoly F x).map (algebraMap F E)).Splits := fun x hx â†¦ splits_of_splits
    (splits x hx).2 fun y hy â†¦ (le_iSup _ âŸ¨x, hxâŸ© : _ â‰¤ E) (subset_adjoin F _ <| by exact hy)
  obtain âŸ¨Ï†âŸ© := nonempty_algHom_adjoin_of_splits fun x hx â†¦ âŸ¨(splits x hx).1, this x hxâŸ©
  convert (normal.splits <| Ï† âŸ¨x, hxâŸ©).map E.val.toRingHom
  simp [minpoly.algHom_eq _ Ï†.injective, â† minpoly.algHom_eq _ (adjoin F S).val.injective,
    Polynomial.map_map]
",Formal Proof of Stacks Project Tag 0BR3,first part,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/Normal/Basic.lean#L121-L132,Q27041,,9.15.6,lemma,3.0,"['09HL', '09FA', '0ELQ']","\n  Lemma 9.15.6. Let $E/F$ be an algebraic extension of fields. If $E$ is generated by $\\alpha _ i \\in E$, $i \\in I$ over $F$ and if for each $i$ the minimal polynomial of $\\alpha _ i$ over $F$ splits completely in $E$, then $E/F$ is normal. \n\n    \n      Proof.\n      Let $P_ i$ be the minimal polynomial of $\\alpha _ i$ over $F$. Let $\\alpha _ i = \\alpha _{i, 1}, \\alpha _{i, 2}, \\ldots , \\alpha _{i, d_ i}$ be the roots of $P_ i$ over $E$. Given two embeddings $\\sigma , \\sigma \' : E \\to \\overline{F}$ over $F$ we see that \n    \n      \n  \\[  \\{ \\sigma (\\alpha _{i, 1}), \\ldots , \\sigma (\\alpha _{i, d_ i})\\}  = \\{ \\sigma \'(\\alpha _{i, 1}), \\ldots , \\sigma \'(\\alpha _{i, d_ i})\\}   \\]\n\n    \n       because both sides are equal to the set of roots of $P_ i$ in $\\overline{F}$. The elements $\\alpha _{i, j}$ generate $E$ over $F$ and we find that $\\sigma (E) = \\sigma \'(E)$. Hence $E/F$ is normal by Lemma 9.15.5. \n      $\\square$\n    \n","\n  Lemma 9.15.6. Let $E/F$ be an algebraic extension of fields. If $E$ is generated by $\\alpha _ i \\in E$, $i \\in I$ over $F$ and if for each $i$ the minimal polynomial of $\\alpha _ i$ over $F$ splits completely in $E$, then $E/F$ is normal. \n\n    \n","Proof.\n      Let $P_ i$ be the minimal polynomial of $\\alpha _ i$ over $F$. Let $\\alpha _ i = \\alpha _{i, 1}, \\alpha _{i, 2}, \\ldots , \\alpha _{i, d_ i}$ be the roots of $P_ i$ over $E$. Given two embeddings $\\sigma , \\sigma \' : E \\to \\overline{F}$ over $F$ we see that \n    \n      \n  \\[  \\{ \\sigma (\\alpha _{i, 1}), \\ldots , \\sigma (\\alpha _{i, d_ i})\\}  = \\{ \\sigma \'(\\alpha _{i, 1}), \\ldots , \\sigma \'(\\alpha _{i, d_ i})\\}   \\]\n\n    \n       because both sides are equal to the set of roots of $P_ i$ in $\\overline{F}$. The elements $\\alpha _{i, j}$ generate $E$ over $F$ and we find that $\\sigma (E) = \\sigma \'(E)$. Hence $E/F$ is normal by Lemma 9.15.5. \n      $\\square$\n    \n"," by
  let E : IntermediateField F L := â¨† x : S, adjoin F ((minpoly F x.val).rootSet L)
  have normal : Normal F E := normal_iSup (h := fun x â†¦
    Normal.of_isSplittingField (hFEp := adjoin_rootSet_isSplittingField (splits x x.2).2))
  have : âˆ€ x âˆˆ S, ((minpoly F x).map (algebraMap F E)).Splits := fun x hx â†¦ splits_of_splits
    (splits x hx).2 fun y hy â†¦ (le_iSup _ âŸ¨x, hxâŸ© : _ â‰¤ E) (subset_adjoin F _ <| by exact hy)
  obtain âŸ¨Ï†âŸ© := nonempty_algHom_adjoin_of_splits fun x hx â†¦ âŸ¨(splits x hx).1, this x hxâŸ©
  convert (normal.splits <| Ï† âŸ¨x, hxâŸ©).map E.val.toRingHom
  simp [minpoly.algHom_eq _ Ï†.injective, â† minpoly.algHom_eq _ (adjoin F S).val.injective,
    Polynomial.map_map]
","theorem splits_of_mem_adjoin {L} [Field L] [Algebra F L] {S : Set K}
    (splits : âˆ€ x âˆˆ S, IsIntegral F x âˆ§ ((minpoly F x).map (algebraMap F L)).Splits) {x : K}
    (hx : x âˆˆ adjoin F S) : ((minpoly F x).map (algebraMap F L)).Splits ","Proof.\n      Let $P_ i$ be the minimal polynomial of $\\alpha _ i$ over $F$. Let $\\alpha _ i = \\alpha _{i, 1}, \\alpha _{i, 2}, \\ldots , \\alpha _{i, d_ i}$ be the roots of $P_ i$ over $E$. Given two embeddings $\\sigma , \\sigma \' : E \\to \\overline{F}$ over $F$ we see that \n    \n      \n  \\[  \\{ \\sigma (\\alpha _{i, 1}), \\ldots , \\sigma (\\alpha _{i, d_ i})\\}  = \\{ \\sigma \'(\\alpha _{i, 1}), \\ldots , \\sigma \'(\\alpha _{i, d_ i})\\}   \\]\n\n    \n       because both sides are equal to the set of roots of $P_ i$ in $\\overline{F}$. The elements $\\alpha _{i, j}$ generate $E$ over $F$ and we find that $\\sigma (E) = \\sigma \'(E)$. Hence $E/F$ is normal by Lemma 9.15.5 [[\n  Lemma 9.15.5. Let $E/F$ be an algebraic extension of fields. Let $\\overline{F}$ be an algebraic closure of $F$. The following are equivalent \n  \n  \n$E$ is normal over $F$, and \n\n\nfor every pair $\\sigma , \\sigma \' \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})$ we have $\\sigma (E) = \\sigma \'(E)$. \n\n\n\n\n    \n]]. \n      $\\square$\n    \n"
192,09HP,"instance normal_inf
    (E E' : IntermediateField F K) [Normal F E] [Normal F E'] :
    Normal F (E âŠ“ E' : IntermediateField F K) :=
  iInf_bool_eq (f := Bool.rec E' E) â–¸ normal_iInf (h := by rintro (_ | _) <;> infer_instance)
",Formal Proof of Stacks Project Tag 09HP,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/Normal/Basic.lean#L156-L159,Q27041,,9.15.3,lemma,3.0,"['09HL', '09FA', '0ELQ']","\n  Lemma 9.15.3. Let $F$ be a field. Let $M/F$ be an algebraic extension. Let $M/E_ i/F$, $i \\in I$ be subextensions with $E_ i/F$ normal. Then $\\bigcap E_ i$ is normal over $F$. \n\n    \n      Proof.\n      Direct from the definitions. \n      $\\square$\n    \n","\n  Lemma 9.15.3. Let $F$ be a field. Let $M/F$ be an algebraic extension. Let $M/E_ i/F$, $i \\in I$ be subextensions with $E_ i/F$ normal. Then $\\bigcap E_ i$ is normal over $F$. \n\n    \n",Proof.\n      Direct from the definitions. \n      $\\square$\n    \n,"
  iInf_bool_eq (f := Bool.rec E' E) â–¸ normal_iInf (h := by rintro (_ | _) <;> infer_instance)
","instance normal_inf
    (E E' : IntermediateField F K) [Normal F E] [Normal F E'] :
    Normal F (E âŠ“ E' : IntermediateField F K) ",Proof.\n      Direct from the definitions. \n      $\\square$\n    \n
193,0BME,"noncomputable def AlgHom.liftNormal [h : Normal F E] : E â†’â‚[F] E :=
  @AlgHom.restrictScalars F Kâ‚ E E _ _ _ _ _ _
      ((IsScalarTower.toAlgHom F Kâ‚‚ E).comp Ï•).toRingHom.toAlgebra _ _ _ _ <|
    Nonempty.some <|
      @IntermediateField.nonempty_algHom_of_adjoin_splits _ _ _ _ _ _ _
        ((IsScalarTower.toAlgHom F Kâ‚‚ E).comp Ï•).toRingHom.toAlgebra _
        (fun x _ â†¦ âŸ¨(h.out x).1.tower_top,
          @IsIntegral.minpoly_splits_tower_top F Kâ‚ E E _ _ _ _ _ _ _ _ x
            (RingHom.toAlgebra _) _ _ (h.out x).1 (h.out x).2âŸ©)
        (IntermediateField.adjoin_univ _ _)
",Formal Proof of Stacks Project Tag 0BME,Part 2,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/Normal/Basic.lean#L190-L199,Q27041,,9.15.7,lemma,3.0,"['09HL', '09FA', '0ELQ']","\n  Lemma 9.15.7. Let $L/M/K$ be a tower of algebraic extensions. \n  \n  \nIf $M/K$ is normal, then any automorphism $\\tau $ of $L/K$ induces an automorphism $\\tau |_ M : M \\to M$. \n\n\nIf $L/K$ is normal, then any $K$-algebra map $\\sigma : M \\to L$ extends to an automorphism of $L$. \n\n\n\n\n    \n      Proof.\n      Choose an algebraic closure $\\overline{L}$ of $L$ (Theorem 9.10.4). \n    \n      Let $\\tau $ be as in (1). Then $\\tau (M) = M$ as subfields of $\\overline{L}$ by Lemma 9.15.5 and hence $\\tau |_ M : M \\to M$ is an automorphism. \n    \n      Let $\\sigma : M \\to L$ be as in (2). By Lemma 9.10.5 we can extend $\\sigma $ to a map $\\tau : L \\to \\overline{L}$, i.e., such that \n    \n      \n  \\[  \\xymatrix{ L \\ar[r]_\\tau &  \\overline{L} \\\\  M \\ar[u] \\ar[ru]_\\sigma &  K \\ar[l] \\ar[u] }  \\]\n\n    \n       is commutative. By Lemma 9.15.5 we see that $\\tau (L) = L$. Hence $\\tau : L \\to L$ is an automorphism which extends $\\sigma $. \n      $\\square$\n    \n","\n  Lemma 9.15.7. Let $L/M/K$ be a tower of algebraic extensions. \n  \n  \nIf $M/K$ is normal, then any automorphism $\\tau $ of $L/K$ induces an automorphism $\\tau |_ M : M \\to M$. \n\n\nIf $L/K$ is normal, then any $K$-algebra map $\\sigma : M \\to L$ extends to an automorphism of $L$. \n\n\n\n\n    \n","Proof.\n      Choose an algebraic closure $\\overline{L}$ of $L$ (Theorem 9.10.4). \n    \n      Let $\\tau $ be as in (1). Then $\\tau (M) = M$ as subfields of $\\overline{L}$ by Lemma 9.15.5 and hence $\\tau |_ M : M \\to M$ is an automorphism. \n    \n      Let $\\sigma : M \\to L$ be as in (2). By Lemma 9.10.5 we can extend $\\sigma $ to a map $\\tau : L \\to \\overline{L}$, i.e., such that \n    \n      \n  \\[  \\xymatrix{ L \\ar[r]_\\tau &  \\overline{L} \\\\  M \\ar[u] \\ar[ru]_\\sigma &  K \\ar[l] \\ar[u] }  \\]\n\n    \n       is commutative. By Lemma 9.15.5 we see that $\\tau (L) = L$. Hence $\\tau : L \\to L$ is an automorphism which extends $\\sigma $. \n      $\\square$\n    \n","
  @AlgHom.restrictScalars F Kâ‚ E E _ _ _ _ _ _
      ((IsScalarTower.toAlgHom F Kâ‚‚ E).comp Ï•).toRingHom.toAlgebra _ _ _ _ <|
    Nonempty.some <|
      @IntermediateField.nonempty_algHom_of_adjoin_splits _ _ _ _ _ _ _
        ((IsScalarTower.toAlgHom F Kâ‚‚ E).comp Ï•).toRingHom.toAlgebra _
        (fun x _ â†¦ âŸ¨(h.out x).1.tower_top,
          @IsIntegral.minpoly_splits_tower_top F Kâ‚ E E _ _ _ _ _ _ _ _ x
            (RingHom.toAlgebra _) _ _ (h.out x).1 (h.out x).2âŸ©)
        (IntermediateField.adjoin_univ _ _)
",noncomputable def AlgHom.liftNormal [h : Normal F E] : E â†’â‚[F] E ,"Proof.\n      Choose an algebraic closure $\\overline{L}$ of $L$ (Theorem 9.10.4 [[\n  Theorem 9.10.4. Every field has an algebraic closure. \n\n    \n]]). \n    \n      Let $\\tau $ be as in (1). Then $\\tau (M) = M$ as subfields of $\\overline{L}$ by Lemma 9.15.5 [[\n  Lemma 9.15.5. Let $E/F$ be an algebraic extension of fields. Let $\\overline{F}$ be an algebraic closure of $F$. The following are equivalent \n  \n  \n$E$ is normal over $F$, and \n\n\nfor every pair $\\sigma , \\sigma \' \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})$ we have $\\sigma (E) = \\sigma \'(E)$. \n\n\n\n\n    \n]] and hence $\\tau |_ M : M \\to M$ is an automorphism. \n    \n      Let $\\sigma : M \\to L$ be as in (2). By Lemma 9.10.5 [[\n  Lemma 9.10.5. Let $F$ be a field. Let $\\overline{F}$ be an algebraic closure of $F$. Let $M/F$ be an algebraic extension. Then there is a morphism of $F$-extensions $M \\to \\overline{F}$. \n\n    \n]] we can extend $\\sigma $ to a map $\\tau : L \\to \\overline{L}$, i.e., such that \n    \n      \n  \\[  \\xymatrix{ L \\ar[r]_\\tau &  \\overline{L} \\\\  M \\ar[u] \\ar[ru]_\\sigma &  K \\ar[l] \\ar[u] }  \\]\n\n    \n       is commutative. By Lemma 9.15.5 [[\n  Lemma 9.15.5. Let $E/F$ be an algebraic extension of fields. Let $\\overline{F}$ be an algebraic closure of $F$. The following are equivalent \n  \n  \n$E$ is normal over $F$, and \n\n\nfor every pair $\\sigma , \\sigma \' \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})$ we have $\\sigma (E) = \\sigma \'(E)$. \n\n\n\n\n    \n]] we see that $\\tau (L) = L$. Hence $\\tau : L \\to L$ is an automorphism which extends $\\sigma $. \n      $\\square$\n    \n"
194,0BMF,"class IsNormalClosure : Prop where
  splits (x : K) : ((minpoly F x).map (algebraMap F L)).Splits
  adjoin_rootSet : â¨† x : K, adjoin F ((minpoly F x).rootSet L) = âŠ¤
/- TODO: show `IsNormalClosure F K L â†” IsNormalClosure F (integralClosure F K) L`; we can't state
  this yet because `integralClosure F K` needs to have a `Field` instance. -/
",Formal Proof of Stacks Project Tag 0BMF,Predicate version,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/Normal/Closure.lean#L42-L46,Q27041,,9.16.4,definition,3.0,"['09HT', '09FA', '0ELQ']",\n  Definition 9.16.4. Let $E/F$ be a finite extension of fields. The field extension $K/E$ constructed in Lemma 9.16.3 is called the normal closure $E$ over $F$. \n,\n  Definition 9.16.4. Let $E/F$ be a finite extension of fields. The field extension $K/E$ constructed in Lemma 9.16.3 is called the normal closure $E$ over $F$. \n,,,"class IsNormalClosure : Prop where
  splits (x : K) : ((minpoly F x).map (algebraMap F L)).Splits
  adjoin_rootSet : â¨† x : K, adjoin F ((minpoly F x).rootSet L) = âŠ¤
/- TODO: show `IsNormalClosure F K L â†” IsNormalClosure F (integralClosure F K) L`; we can't state
  this yet because `integralClosure F K` needs to have a `Field` instance. -/
",
195,0BMF,"noncomputable def IntermediateField.normalClosure : IntermediateField F L :=
  â¨† f : K â†’â‚[F] L, f.fieldRange
",Formal Proof of Stacks Project Tag 0BMF,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/Normal/Closure.lean#L50-L51,Q27041,,9.16.4,definition,3.0,"['09HT', '09FA', '0ELQ']",\n  Definition 9.16.4. Let $E/F$ be a finite extension of fields. The field extension $K/E$ constructed in Lemma 9.16.3 is called the normal closure $E$ over $F$. \n,\n  Definition 9.16.4. Let $E/F$ be a finite extension of fields. The field extension $K/E$ constructed in Lemma 9.16.3 is called the normal closure $E$ over $F$. \n,,"
  â¨† f : K â†’â‚[F] L, f.fieldRange
",noncomputable def IntermediateField.normalClosure : IntermediateField F L ,
196,0BMG,"instance normal [h : Normal F L] : Normal F (normalClosure F K L) := by
  obtain _ | Ï† := isEmpty_or_nonempty (K â†’â‚[F] L)
  Â· rw [normalClosure, iSup_of_empty]; exact Normal.of_algEquiv (botEquiv F L).symm
  Â· exact (isNormalClosure_normalClosure F K L).normal
",Formal Proof of Stacks Project Tag 0BMG,(1) normality.,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/Normal/Closure.lean#L168-L171,Q27041,,9.16.5,lemma,3.0,"['09HT', '09FA', '0ELQ']","\n  Lemma 9.16.5. Let $L/K$ be an algebraic normal extension. \n  \n  \nIf $L/M/K$ is a subextension with $M/K$ finite, then there exists a tower $L/M\'/M/K$ with $M\'/K$ finite and normal. \n\n\nIf $L/M\'/M/K$ is a tower with $M/K$ normal and $M\'/M$ finite, then there exists a tower $L/M\'\'/M\'/M/K$ with $M\'\'/M$ finite and $M\'\'/K$ normal. \n\n\n\n\n    \n      Proof.\n      Proof of (1). Let $M\'$ be the smallest subextension of $L/K$ containing $M$ which is normal over $K$. By Lemma 9.16.3 this is the normal closure of $M/K$ and is finite over $K$. \n    \n      Proof of (2). Let $\\alpha _1, \\ldots , \\alpha _ n \\in M\'$ generate $M\'$ over $M$. Let $P_1, \\ldots , P_ n$ be the minimal polynomials of $\\alpha _1, \\ldots , \\alpha _ n$ over $K$. Let $\\alpha _{i, j}$ be the roots of $P_ i$ in $L$. Let $M\'\' = M(\\alpha _{i, j})$. It follows from Lemma 9.15.6 (applied with the set of generators $M \\cup \\{ \\alpha _{i, j}\\} $) that $M\'\'$ is normal over $K$. \n      $\\square$\n    \n","\n  Lemma 9.16.5. Let $L/K$ be an algebraic normal extension. \n  \n  \nIf $L/M/K$ is a subextension with $M/K$ finite, then there exists a tower $L/M\'/M/K$ with $M\'/K$ finite and normal. \n\n\nIf $L/M\'/M/K$ is a tower with $M/K$ normal and $M\'/M$ finite, then there exists a tower $L/M\'\'/M\'/M/K$ with $M\'\'/M$ finite and $M\'\'/K$ normal. \n\n\n\n\n    \n","Proof.\n      Proof of (1). Let $M\'$ be the smallest subextension of $L/K$ containing $M$ which is normal over $K$. By Lemma 9.16.3 this is the normal closure of $M/K$ and is finite over $K$. \n    \n      Proof of (2). Let $\\alpha _1, \\ldots , \\alpha _ n \\in M\'$ generate $M\'$ over $M$. Let $P_1, \\ldots , P_ n$ be the minimal polynomials of $\\alpha _1, \\ldots , \\alpha _ n$ over $K$. Let $\\alpha _{i, j}$ be the roots of $P_ i$ in $L$. Let $M\'\' = M(\\alpha _{i, j})$. It follows from Lemma 9.15.6 (applied with the set of generators $M \\cup \\{ \\alpha _{i, j}\\} $) that $M\'\'$ is normal over $K$. \n      $\\square$\n    \n"," by
  obtain _ | Ï† := isEmpty_or_nonempty (K â†’â‚[F] L)
  Â· rw [normalClosure, iSup_of_empty]; exact Normal.of_algEquiv (botEquiv F L).symm
  Â· exact (isNormalClosure_normalClosure F K L).normal
",instance normal [h : Normal F L] : Normal F (normalClosure F K L) ,"Proof.\n      Proof of (1). Let $M\'$ be the smallest subextension of $L/K$ containing $M$ which is normal over $K$. By Lemma 9.16.3 [[\n       \n      \n  Lemma 9.16.3. Let $E/F$ be a finite extension of fields. There exists a unique smallest finite extension $K/E$ such that $K$ is normal over $F$. \n\n    \n]] this is the normal closure of $M/K$ and is finite over $K$. \n    \n      Proof of (2). Let $\\alpha _1, \\ldots , \\alpha _ n \\in M\'$ generate $M\'$ over $M$. Let $P_1, \\ldots , P_ n$ be the minimal polynomials of $\\alpha _1, \\ldots , \\alpha _ n$ over $K$. Let $\\alpha _{i, j}$ be the roots of $P_ i$ in $L$. Let $M\'\' = M(\\alpha _{i, j})$. It follows from Lemma 9.15.6 [[\n  Lemma 9.15.6. Let $E/F$ be an algebraic extension of fields. If $E$ is generated by $\\alpha _ i \\in E$, $i \\in I$ over $F$ and if for each $i$ the minimal polynomial of $\\alpha _ i$ over $F$ splits completely in $E$, then $E/F$ is normal. \n\n    \n]] (applied with the set of generators $M \\cup \\{ \\alpha _{i, j}\\} $) that $M\'\'$ is normal over $K$. \n      $\\square$\n    \n"
197,0BMG,"instance is_finiteDimensional [FiniteDimensional F K] :
    FiniteDimensional F (normalClosure F K L) := by
  haveI : âˆ€ f : K â†’â‚[F] L, FiniteDimensional F f.fieldRange := fun f â†¦
    f.toLinearMap.finiteDimensional_range
  apply IntermediateField.finiteDimensional_iSup_of_finite
",Formal Proof of Stacks Project Tag 0BMG,"When `L` is normal over `K`, this agrees with 0BMG (1) finiteness.",https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/Normal/Closure.lean#L174-L178,Q27041,,9.16.5,lemma,3.0,"['09HT', '09FA', '0ELQ']","\n  Lemma 9.16.5. Let $L/K$ be an algebraic normal extension. \n  \n  \nIf $L/M/K$ is a subextension with $M/K$ finite, then there exists a tower $L/M\'/M/K$ with $M\'/K$ finite and normal. \n\n\nIf $L/M\'/M/K$ is a tower with $M/K$ normal and $M\'/M$ finite, then there exists a tower $L/M\'\'/M\'/M/K$ with $M\'\'/M$ finite and $M\'\'/K$ normal. \n\n\n\n\n    \n      Proof.\n      Proof of (1). Let $M\'$ be the smallest subextension of $L/K$ containing $M$ which is normal over $K$. By Lemma 9.16.3 this is the normal closure of $M/K$ and is finite over $K$. \n    \n      Proof of (2). Let $\\alpha _1, \\ldots , \\alpha _ n \\in M\'$ generate $M\'$ over $M$. Let $P_1, \\ldots , P_ n$ be the minimal polynomials of $\\alpha _1, \\ldots , \\alpha _ n$ over $K$. Let $\\alpha _{i, j}$ be the roots of $P_ i$ in $L$. Let $M\'\' = M(\\alpha _{i, j})$. It follows from Lemma 9.15.6 (applied with the set of generators $M \\cup \\{ \\alpha _{i, j}\\} $) that $M\'\'$ is normal over $K$. \n      $\\square$\n    \n","\n  Lemma 9.16.5. Let $L/K$ be an algebraic normal extension. \n  \n  \nIf $L/M/K$ is a subextension with $M/K$ finite, then there exists a tower $L/M\'/M/K$ with $M\'/K$ finite and normal. \n\n\nIf $L/M\'/M/K$ is a tower with $M/K$ normal and $M\'/M$ finite, then there exists a tower $L/M\'\'/M\'/M/K$ with $M\'\'/M$ finite and $M\'\'/K$ normal. \n\n\n\n\n    \n","Proof.\n      Proof of (1). Let $M\'$ be the smallest subextension of $L/K$ containing $M$ which is normal over $K$. By Lemma 9.16.3 this is the normal closure of $M/K$ and is finite over $K$. \n    \n      Proof of (2). Let $\\alpha _1, \\ldots , \\alpha _ n \\in M\'$ generate $M\'$ over $M$. Let $P_1, \\ldots , P_ n$ be the minimal polynomials of $\\alpha _1, \\ldots , \\alpha _ n$ over $K$. Let $\\alpha _{i, j}$ be the roots of $P_ i$ in $L$. Let $M\'\' = M(\\alpha _{i, j})$. It follows from Lemma 9.15.6 (applied with the set of generators $M \\cup \\{ \\alpha _{i, j}\\} $) that $M\'\'$ is normal over $K$. \n      $\\square$\n    \n"," by
  haveI : âˆ€ f : K â†’â‚[F] L, FiniteDimensional F f.fieldRange := fun f â†¦
    f.toLinearMap.finiteDimensional_range
  apply IntermediateField.finiteDimensional_iSup_of_finite
","instance is_finiteDimensional [FiniteDimensional F K] :
    FiniteDimensional F (normalClosure F K L) ","Proof.\n      Proof of (1). Let $M\'$ be the smallest subextension of $L/K$ containing $M$ which is normal over $K$. By Lemma 9.16.3 [[\n       \n      \n  Lemma 9.16.3. Let $E/F$ be a finite extension of fields. There exists a unique smallest finite extension $K/E$ such that $K$ is normal over $F$. \n\n    \n]] this is the normal closure of $M/K$ and is finite over $K$. \n    \n      Proof of (2). Let $\\alpha _1, \\ldots , \\alpha _ n \\in M\'$ generate $M\'$ over $M$. Let $P_1, \\ldots , P_ n$ be the minimal polynomials of $\\alpha _1, \\ldots , \\alpha _ n$ over $K$. Let $\\alpha _{i, j}$ be the roots of $P_ i$ in $L$. Let $M\'\' = M(\\alpha _{i, j})$. It follows from Lemma 9.15.6 [[\n  Lemma 9.15.6. Let $E/F$ be an algebraic extension of fields. If $E$ is generated by $\\alpha _ i \\in E$, $i \\in I$ over $F$ and if for each $i$ the minimal polynomial of $\\alpha _ i$ over $F$ splits completely in $E$, then $E/F$ is normal. \n\n    \n]] (applied with the set of generators $M \\cup \\{ \\alpha _{i, j}\\} $) that $M\'\'$ is normal over $K$. \n      $\\square$\n    \n"
198,09HQ,"lemma normal_iff_forall_fieldRange_eq : Normal F K â†” âˆ€ Ïƒ : K â†’â‚[F] L, Ïƒ.fieldRange = K :=
âŸ¨@AlgHom.fieldRange_of_normal (E := K), normal_iff_forall_fieldRange_le.2 âˆ˜ fun h Ïƒ â†¦ (h Ïƒ).leâŸ©
",Formal Proof of Stacks Project Tag 09HQ,stronger version replacing an algebraic closure by a normal extension,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/Normal/Closure.lean#L287-L288,Q27041,,9.15.5,lemma,3.0,"['09HL', '09FA', '0ELQ']","\n  Lemma 9.15.5. Let $E/F$ be an algebraic extension of fields. Let $\\overline{F}$ be an algebraic closure of $F$. The following are equivalent \n  \n  \n$E$ is normal over $F$, and \n\n\nfor every pair $\\sigma , \\sigma \' \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})$ we have $\\sigma (E) = \\sigma \'(E)$. \n\n\n\n\n    \n      Proof.\n      Let $\\mathcal{P}$ be the set of all minimal polynomials over $F$ of all elements of $E$. Set \n    \n      \n  \\[  T = \\{ \\beta \\in \\overline{F} \\mid P(\\beta ) = 0\\text{ for some }P \\in \\mathcal{P}\\}   \\]\n\n    \n       It is clear that if $E$ is normal over $F$, then $\\sigma (E) = T$ for all $\\sigma \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})$. Thus we see that (1) implies (2). \n    \n      Conversely, assume (2). Pick $\\beta \\in T$. We can find a corresponding $\\alpha \\in E$ whose minimal polynomial $P \\in \\mathcal{P}$ annihilates $\\beta $. Because $F(\\alpha ) = F[x]/(P)$ we can find an element $\\sigma _0 \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(F(\\alpha ), \\overline{F})$ mapping $\\alpha $ to $\\beta $. By Lemma 9.10.5 we can extend $\\sigma _0$ to a $\\sigma \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})$. Whence we see that $\\beta $ is in the common image of all embeddings $\\sigma : E \\to \\overline{F}$. It follows that $\\sigma (E) = T$ for any $\\sigma $. Fix a $\\sigma $. Now let $P \\in \\mathcal{P}$. Then we can write \n    \n      \n  \\[  P = (x - \\beta _1) \\ldots (x - \\beta _ n)  \\]\n\n    \n       for some $n$ and $\\beta _ i \\in \\overline{F}$ by Lemma 9.10.2. Observe that $\\beta _ i \\in T$. Thus $\\beta _ i = \\sigma (\\alpha _ i)$ for some $\\alpha _ i \\in E$. Thus $P = (x - \\alpha _1) \\ldots (x - \\alpha _ n)$ splits completely over $E$. This finishes the proof. \n      $\\square$\n    \n","\n  Lemma 9.15.5. Let $E/F$ be an algebraic extension of fields. Let $\\overline{F}$ be an algebraic closure of $F$. The following are equivalent \n  \n  \n$E$ is normal over $F$, and \n\n\nfor every pair $\\sigma , \\sigma \' \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})$ we have $\\sigma (E) = \\sigma \'(E)$. \n\n\n\n\n    \n","Proof.\n      Let $\\mathcal{P}$ be the set of all minimal polynomials over $F$ of all elements of $E$. Set \n    \n      \n  \\[  T = \\{ \\beta \\in \\overline{F} \\mid P(\\beta ) = 0\\text{ for some }P \\in \\mathcal{P}\\}   \\]\n\n    \n       It is clear that if $E$ is normal over $F$, then $\\sigma (E) = T$ for all $\\sigma \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})$. Thus we see that (1) implies (2). \n    \n      Conversely, assume (2). Pick $\\beta \\in T$. We can find a corresponding $\\alpha \\in E$ whose minimal polynomial $P \\in \\mathcal{P}$ annihilates $\\beta $. Because $F(\\alpha ) = F[x]/(P)$ we can find an element $\\sigma _0 \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(F(\\alpha ), \\overline{F})$ mapping $\\alpha $ to $\\beta $. By Lemma 9.10.5 we can extend $\\sigma _0$ to a $\\sigma \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})$. Whence we see that $\\beta $ is in the common image of all embeddings $\\sigma : E \\to \\overline{F}$. It follows that $\\sigma (E) = T$ for any $\\sigma $. Fix a $\\sigma $. Now let $P \\in \\mathcal{P}$. Then we can write \n    \n      \n  \\[  P = (x - \\beta _1) \\ldots (x - \\beta _ n)  \\]\n\n    \n       for some $n$ and $\\beta _ i \\in \\overline{F}$ by Lemma 9.10.2. Observe that $\\beta _ i \\in T$. Thus $\\beta _ i = \\sigma (\\alpha _ i)$ for some $\\alpha _ i \\in E$. Thus $P = (x - \\alpha _1) \\ldots (x - \\alpha _ n)$ splits completely over $E$. This finishes the proof. \n      $\\square$\n    \n","
âŸ¨@AlgHom.fieldRange_of_normal (E := K), normal_iff_forall_fieldRange_le.2 âˆ˜ fun h Ïƒ â†¦ (h Ïƒ).leâŸ©
","lemma normal_iff_forall_fieldRange_eq : Normal F K â†” âˆ€ Ïƒ : K â†’â‚[F] L, Ïƒ.fieldRange = K ","Proof.\n      Let $\\mathcal{P}$ be the set of all minimal polynomials over $F$ of all elements of $E$. Set \n    \n      \n  \\[  T = \\{ \\beta \\in \\overline{F} \\mid P(\\beta ) = 0\\text{ for some }P \\in \\mathcal{P}\\}   \\]\n\n    \n       It is clear that if $E$ is normal over $F$, then $\\sigma (E) = T$ for all $\\sigma \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})$. Thus we see that (1) implies (2). \n    \n      Conversely, assume (2). Pick $\\beta \\in T$. We can find a corresponding $\\alpha \\in E$ whose minimal polynomial $P \\in \\mathcal{P}$ annihilates $\\beta $. Because $F(\\alpha ) = F[x]/(P)$ we can find an element $\\sigma _0 \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(F(\\alpha ), \\overline{F})$ mapping $\\alpha $ to $\\beta $. By Lemma 9.10.5 [[\n  Lemma 9.10.5. Let $F$ be a field. Let $\\overline{F}$ be an algebraic closure of $F$. Let $M/F$ be an algebraic extension. Then there is a morphism of $F$-extensions $M \\to \\overline{F}$. \n\n    \n]] we can extend $\\sigma _0$ to a $\\sigma \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})$. Whence we see that $\\beta $ is in the common image of all embeddings $\\sigma : E \\to \\overline{F}$. It follows that $\\sigma (E) = T$ for any $\\sigma $. Fix a $\\sigma $. Now let $P \\in \\mathcal{P}$. Then we can write \n    \n      \n  \\[  P = (x - \\beta _1) \\ldots (x - \\beta _ n)  \\]\n\n    \n       for some $n$ and $\\beta _ i \\in \\overline{F}$ by Lemma 9.10.2 [[\n  Lemma 9.10.2. Let $F$ be a field. The following are equivalent \n  \n  \n$F$ is algebraically closed, \n\n\nevery irreducible polynomial over $F$ is linear, \n\n\nevery nonconstant polynomial over $F$ has a root, \n\n\nevery nonconstant polynomial over $F$ is a product of linear factors. \n\n\n\n\n    \n]]. Observe that $\\beta _ i \\in T$. Thus $\\beta _ i = \\sigma (\\alpha _ i)$ for some $\\alpha _ i \\in E$. Thus $P = (x - \\alpha _1) \\ldots (x - \\alpha _ n)$ splits completely over $E$. This finishes the proof. \n      $\\square$\n    \n"
199,09HM,"class Normal : Prop extends Algebra.IsAlgebraic F K where
  splits' (x : K) : Splits ((minpoly F x).map (algebraMap F K))
",Formal Proof of Stacks Project Tag 09HM,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/Normal/Defs.lean#L35-L36,Q27041,,9.15.1,definition,3.0,"['09HL', '09FA', '0ELQ']",\n  Definition 9.15.1. Let $E/F$ be an algebraic field extension. We say $E$ is normal over $F$ if for all $\\alpha \\in E$ the minimal polynomial $P$ of $\\alpha $ over $F$ splits completely into linear factors over $E$. \n,\n  Definition 9.15.1. Let $E/F$ be an algebraic field extension. We say $E$ is normal over $F$ if for all $\\alpha \\in E$ the minimal polynomial $P$ of $\\alpha $ over $F$ splits completely into linear factors over $E$. \n,,,"class Normal : Prop extends Algebra.IsAlgebraic F K where
  splits' (x : K) : Splits ((minpoly F x).map (algebraMap F K))
",
200,09HN,"theorem Normal.tower_top_of_normal [h : Normal F E] : Normal K E :=
  normal_iff.2 fun x => by
    obtain âŸ¨hx, hhxâŸ© := h.out x
    rw [algebraMap_eq F K E, â† map_map] at hhx
    exact âŸ¨hx.tower_top, hhx.of_dvd (map_ne_zero (map_ne_zero (minpoly.ne_zero hx)))
      ((map_dvd_map' _).mpr (minpoly.dvd_map_of_isScalarTower F K x))âŸ©
",Formal Proof of Stacks Project Tag 09HN,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/Normal/Defs.lean#L67-L72,Q27041,,9.15.2,lemma,3.0,"['09HL', '09FA', '0ELQ']","\n  Lemma 9.15.2. Let $K/E/F$ be a tower of algebraic field extensions. If $K$ is normal over $F$, then $K$ is normal over $E$. \n\n    \n      Proof.\n      Let $\\alpha \\in K$. Let $P$ be the minimal polynomial of $\\alpha $ over $F$. Let $Q$ be the minimal polynomial of $\\alpha $ over $E$. Then $Q$ divides $P$ in the polynomial ring $E[x]$, say $P = QR$. Hence, if $P$ splits completely over $K$, then so does $Q$. \n      $\\square$\n    \n","\n  Lemma 9.15.2. Let $K/E/F$ be a tower of algebraic field extensions. If $K$ is normal over $F$, then $K$ is normal over $E$. \n\n    \n","Proof.\n      Let $\\alpha \\in K$. Let $P$ be the minimal polynomial of $\\alpha $ over $F$. Let $Q$ be the minimal polynomial of $\\alpha $ over $E$. Then $Q$ divides $P$ in the polynomial ring $E[x]$, say $P = QR$. Hence, if $P$ splits completely over $K$, then so does $Q$. \n      $\\square$\n    \n","
  normal_iff.2 fun x => by
    obtain âŸ¨hx, hhxâŸ© := h.out x
    rw [algebraMap_eq F K E, â† map_map] at hhx
    exact âŸ¨hx.tower_top, hhx.of_dvd (map_ne_zero (map_ne_zero (minpoly.ne_zero hx)))
      ((map_dvd_map' _).mpr (minpoly.dvd_map_of_isScalarTower F K x))âŸ©
",theorem Normal.tower_top_of_normal [h : Normal F E] : Normal K E ,"Proof.\n      Let $\\alpha \\in K$. Let $P$ be the minimal polynomial of $\\alpha $ over $F$. Let $Q$ be the minimal polynomial of $\\alpha $ over $E$. Then $Q$ divides $P$ in the polynomial ring $E[x]$, say $P = QR$. Hence, if $P$ splits completely over $K$, then so does $Q$. \n      $\\square$\n    \n"
201,0BME,"def AlgHom.restrictNormal [Normal F E] : E â†’â‚[F] E :=
  ((AlgEquiv.ofInjectiveField (IsScalarTower.toAlgHom F E Kâ‚‚)).symm.toAlgHom.comp
        (Ï•.restrictNormalAux E)).comp
    (AlgEquiv.ofInjectiveField (IsScalarTower.toAlgHom F E Kâ‚)).toAlgHom
",Formal Proof of Stacks Project Tag 0BME,Part 1,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/Normal/Defs.lean#L147-L150,Q27041,,9.15.7,lemma,3.0,"['09HL', '09FA', '0ELQ']","\n  Lemma 9.15.7. Let $L/M/K$ be a tower of algebraic extensions. \n  \n  \nIf $M/K$ is normal, then any automorphism $\\tau $ of $L/K$ induces an automorphism $\\tau |_ M : M \\to M$. \n\n\nIf $L/K$ is normal, then any $K$-algebra map $\\sigma : M \\to L$ extends to an automorphism of $L$. \n\n\n\n\n    \n      Proof.\n      Choose an algebraic closure $\\overline{L}$ of $L$ (Theorem 9.10.4). \n    \n      Let $\\tau $ be as in (1). Then $\\tau (M) = M$ as subfields of $\\overline{L}$ by Lemma 9.15.5 and hence $\\tau |_ M : M \\to M$ is an automorphism. \n    \n      Let $\\sigma : M \\to L$ be as in (2). By Lemma 9.10.5 we can extend $\\sigma $ to a map $\\tau : L \\to \\overline{L}$, i.e., such that \n    \n      \n  \\[  \\xymatrix{ L \\ar[r]_\\tau &  \\overline{L} \\\\  M \\ar[u] \\ar[ru]_\\sigma &  K \\ar[l] \\ar[u] }  \\]\n\n    \n       is commutative. By Lemma 9.15.5 we see that $\\tau (L) = L$. Hence $\\tau : L \\to L$ is an automorphism which extends $\\sigma $. \n      $\\square$\n    \n","\n  Lemma 9.15.7. Let $L/M/K$ be a tower of algebraic extensions. \n  \n  \nIf $M/K$ is normal, then any automorphism $\\tau $ of $L/K$ induces an automorphism $\\tau |_ M : M \\to M$. \n\n\nIf $L/K$ is normal, then any $K$-algebra map $\\sigma : M \\to L$ extends to an automorphism of $L$. \n\n\n\n\n    \n","Proof.\n      Choose an algebraic closure $\\overline{L}$ of $L$ (Theorem 9.10.4). \n    \n      Let $\\tau $ be as in (1). Then $\\tau (M) = M$ as subfields of $\\overline{L}$ by Lemma 9.15.5 and hence $\\tau |_ M : M \\to M$ is an automorphism. \n    \n      Let $\\sigma : M \\to L$ be as in (2). By Lemma 9.10.5 we can extend $\\sigma $ to a map $\\tau : L \\to \\overline{L}$, i.e., such that \n    \n      \n  \\[  \\xymatrix{ L \\ar[r]_\\tau &  \\overline{L} \\\\  M \\ar[u] \\ar[ru]_\\sigma &  K \\ar[l] \\ar[u] }  \\]\n\n    \n       is commutative. By Lemma 9.15.5 we see that $\\tau (L) = L$. Hence $\\tau : L \\to L$ is an automorphism which extends $\\sigma $. \n      $\\square$\n    \n","
  ((AlgEquiv.ofInjectiveField (IsScalarTower.toAlgHom F E Kâ‚‚)).symm.toAlgHom.comp
        (Ï•.restrictNormalAux E)).comp
    (AlgEquiv.ofInjectiveField (IsScalarTower.toAlgHom F E Kâ‚)).toAlgHom
",def AlgHom.restrictNormal [Normal F E] : E â†’â‚[F] E ,"Proof.\n      Choose an algebraic closure $\\overline{L}$ of $L$ (Theorem 9.10.4 [[\n  Theorem 9.10.4. Every field has an algebraic closure. \n\n    \n]]). \n    \n      Let $\\tau $ be as in (1). Then $\\tau (M) = M$ as subfields of $\\overline{L}$ by Lemma 9.15.5 [[\n  Lemma 9.15.5. Let $E/F$ be an algebraic extension of fields. Let $\\overline{F}$ be an algebraic closure of $F$. The following are equivalent \n  \n  \n$E$ is normal over $F$, and \n\n\nfor every pair $\\sigma , \\sigma \' \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})$ we have $\\sigma (E) = \\sigma \'(E)$. \n\n\n\n\n    \n]] and hence $\\tau |_ M : M \\to M$ is an automorphism. \n    \n      Let $\\sigma : M \\to L$ be as in (2). By Lemma 9.10.5 [[\n  Lemma 9.10.5. Let $F$ be a field. Let $\\overline{F}$ be an algebraic closure of $F$. Let $M/F$ be an algebraic extension. Then there is a morphism of $F$-extensions $M \\to \\overline{F}$. \n\n    \n]] we can extend $\\sigma $ to a map $\\tau : L \\to \\overline{L}$, i.e., such that \n    \n      \n  \\[  \\xymatrix{ L \\ar[r]_\\tau &  \\overline{L} \\\\  M \\ar[u] \\ar[ru]_\\sigma &  K \\ar[l] \\ar[u] }  \\]\n\n    \n       is commutative. By Lemma 9.15.5 [[\n  Lemma 9.15.5. Let $E/F$ be an algebraic extension of fields. Let $\\overline{F}$ be an algebraic closure of $F$. The following are equivalent \n  \n  \n$E$ is normal over $F$, and \n\n\nfor every pair $\\sigma , \\sigma \' \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})$ we have $\\sigma (E) = \\sigma \'(E)$. \n\n\n\n\n    \n]] we see that $\\tau (L) = L$. Hence $\\tau : L \\to L$ is an automorphism which extends $\\sigma $. \n      $\\square$\n    \n"
202,09HE,"theorem isPurelyInseparable_iff_pow_mem :
    IsPurelyInseparable F E â†” âˆ€ x : E, âˆƒ n : â„•, x ^ q ^ n âˆˆ (algebraMap F E).range := by
  rw [isPurelyInseparable_iff]
  refine âŸ¨fun h x â†¦ ?_, fun h x â†¦ ?_âŸ©
  Â· obtain âŸ¨g, h1, n, h2âŸ© := (minpoly.irreducible (h x).1).hasSeparableContraction q
    exact âŸ¨n, (h _).2 <| h1.of_dvd <| minpoly.dvd F _ <| by
      simpa only [expand_aeval, minpoly.aeval] using congr_arg (aeval x) h2âŸ©
  have hdeg := (minpoly.natSepDegree_eq_one_iff_pow_mem q).2 (h x)
  have halg : IsIntegral F x := by_contra fun h' â†¦ by
    simp only [minpoly.eq_zero h', natSepDegree_zero, zero_ne_one] at hdeg
  refine âŸ¨halg, fun hsep â†¦ ?_âŸ©
  rwa [hsep.natSepDegree_eq_natDegree, minpoly.natDegree_eq_one_iff] at hdeg
",Formal Proof of Stacks Project Tag 09HE,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/PurelyInseparable/Basic.lean#L211-L222,Q27041,,9.14.1,definition,3.0,"['09HD', '09FA', '0ELQ']","\n  Definition 9.14.1. Let $F$ be a field of characteristic $p > 0$. Let $K/F$ be an extension. \n  \n  \nAn element $\\alpha \\in K$ is purely inseparable over $F$ if there exists a power $q$ of $p$ such that $\\alpha ^ q \\in F$. \n\n\nThe extension $K/F$ is said to be purely inseparable if and only if every element of $K$ is purely inseparable over $F$. \n\n\n\n   If we have a field extension $L/M$ (with no condition on the characteristic of $M$), then we will say the extension is purely inseparable if either $L = M$ or the characteristic of $M$ is a prime number $p$ and $L/M$ is purely inseparable in the sense defined above. \n","\n  Definition 9.14.1. Let $F$ be a field of characteristic $p > 0$. Let $K/F$ be an extension. \n  \n  \nAn element $\\alpha \\in K$ is purely inseparable over $F$ if there exists a power $q$ of $p$ such that $\\alpha ^ q \\in F$. \n\n\nThe extension $K/F$ is said to be purely inseparable if and only if every element of $K$ is purely inseparable over $F$. \n\n\n\n   If we have a field extension $L/M$ (with no condition on the characteristic of $M$), then we will say the extension is purely inseparable if either $L = M$ or the characteristic of $M$ is a prime number $p$ and $L/M$ is purely inseparable in the sense defined above. \n",," by
  rw [isPurelyInseparable_iff]
  refine âŸ¨fun h x â†¦ ?_, fun h x â†¦ ?_âŸ©
  Â· obtain âŸ¨g, h1, n, h2âŸ© := (minpoly.irreducible (h x).1).hasSeparableContraction q
    exact âŸ¨n, (h _).2 <| h1.of_dvd <| minpoly.dvd F _ <| by
      simpa only [expand_aeval, minpoly.aeval] using congr_arg (aeval x) h2âŸ©
  have hdeg := (minpoly.natSepDegree_eq_one_iff_pow_mem q).2 (h x)
  have halg : IsIntegral F x := by_contra fun h' â†¦ by
    simp only [minpoly.eq_zero h', natSepDegree_zero, zero_ne_one] at hdeg
  refine âŸ¨halg, fun hsep â†¦ ?_âŸ©
  rwa [hsep.natSepDegree_eq_natDegree, minpoly.natDegree_eq_one_iff] at hdeg
","theorem isPurelyInseparable_iff_pow_mem :
    IsPurelyInseparable F E â†” âˆ€ x : E, âˆƒ n : â„•, x ^ q ^ n âˆˆ (algebraMap F E).range ",
203,02JJ,"theorem IsPurelyInseparable.trans [Algebra E K] [IsScalarTower F E K]
    [h1 : IsPurelyInseparable F E] [h2 : IsPurelyInseparable E K] : IsPurelyInseparable F K := by
  obtain âŸ¨q, _âŸ© := ExpChar.exists F
  haveI := expChar_of_injective_algebraMap (algebraMap F E).injective q
  rw [isPurelyInseparable_iff_pow_mem _ q] at h1 h2 âŠ¢
  intro x
  obtain âŸ¨n, y, h2âŸ© := h2 x
  obtain âŸ¨m, z, h1âŸ© := h1 y
  refine âŸ¨n + m, z, ?_âŸ©
  rw [IsScalarTower.algebraMap_apply F E K, h1, map_pow, h2, â† pow_mul, â† pow_add]
",Formal Proof of Stacks Project Tag 02JJ,See also 00GM,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/PurelyInseparable/Basic.lean#L260-L269,Q27041,,10.36.5,lemma,3.0,"['00GH', '00AO', '0ELQ']","\n  Lemma 10.36.5. Let $R \\to S$ be a ring map. The following are equivalent \n  \n  \n$R \\to S$ is finite, \n\n\n$R \\to S$ is integral and of finite type, and \n\n\nthere exist $x_1, \\ldots , x_ n \\in S$ which generate $S$ as an algebra over $R$ such that each $x_ i$ is integral over $R$. \n\n\n\n\n    \n      Proof.\n      Clear from Lemma 10.36.4. \n      $\\square$\n    \n","\n  Lemma 10.36.5. Let $R \\to S$ be a ring map. The following are equivalent \n  \n  \n$R \\to S$ is finite, \n\n\n$R \\to S$ is integral and of finite type, and \n\n\nthere exist $x_1, \\ldots , x_ n \\in S$ which generate $S$ as an algebra over $R$ such that each $x_ i$ is integral over $R$. \n\n\n\n\n    \n",Proof.\n      Clear from Lemma 10.36.4. \n      $\\square$\n    \n," by
  obtain âŸ¨q, _âŸ© := ExpChar.exists F
  haveI := expChar_of_injective_algebraMap (algebraMap F E).injective q
  rw [isPurelyInseparable_iff_pow_mem _ q] at h1 h2 âŠ¢
  intro x
  obtain âŸ¨n, y, h2âŸ© := h2 x
  obtain âŸ¨m, z, h1âŸ© := h1 y
  refine âŸ¨n + m, z, ?_âŸ©
  rw [IsScalarTower.algebraMap_apply F E K, h1, map_pow, h2, â† pow_mul, â† pow_add]
","theorem IsPurelyInseparable.trans [Algebra E K] [IsScalarTower F E K]
    [h1 : IsPurelyInseparable F E] [h2 : IsPurelyInseparable E K] : IsPurelyInseparable F K ","Proof.\n      Clear from Lemma 10.36.4 [[\n  Lemma 10.36.4. Let $\\varphi : R \\to S$ be a ring map. Let $s_1, \\ldots , s_ n$ be a finite set of elements of $S$. In this case $s_ i$ is integral over $R$ for all $i = 1, \\ldots , n$ if and only if there exists an $R$-subalgebra $S\' \\subset S$ finite over $R$ containing all of the $s_ i$. \n\n    \n]]. \n      $\\square$\n    \n"
204,030K,"instance separableClosure.isPurelyInseparable [Algebra.IsAlgebraic F E] :
    IsPurelyInseparable (separableClosure F E) E := isPurelyInseparable_iff.2 fun x â†¦ by
  set L := separableClosure F E
  refine âŸ¨(IsAlgebraic.tower_top L (Algebra.IsAlgebraic.isAlgebraic (R := F) x)).isIntegral,
    fun h â†¦ ?_âŸ©
  haveI := (isSeparable_adjoin_simple_iff_isSeparable L E).2 h
  haveI : Algebra.IsSeparable F (restrictScalars F LâŸ®xâŸ¯) := Algebra.IsSeparable.trans F L LâŸ®xâŸ¯
  have hx : x âˆˆ restrictScalars F LâŸ®xâŸ¯ := mem_adjoin_simple_self _ x
  exact âŸ¨âŸ¨x, mem_separableClosure_iff.2 <| isSeparable_of_mem_isSeparable F E hxâŸ©, rflâŸ©
",Formal Proof of Stacks Project Tag 030K,$E/E_{sep}$ is purely inseparable.,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/PurelyInseparable/Basic.lean#L473-L481,Q27041,,9.14.6,lemma,3.0,"['09HD', '09FA', '0ELQ']","\n       \n      \n  Lemma 9.14.6. Let $E/F$ be an algebraic field extension. There exists a unique subextension $E/E_{sep}/F$ such that $E_{sep}/F$ is separable and $E/E_{sep}$ is purely inseparable. \n\n    \n      Proof.\n      If the characteristic is zero we set $E_{sep} = E$. Assume the characteristic is $p > 0$. Let $E_{sep}$ be the set of elements of $E$ which are separable over $F$. This is a subextension by Lemma 9.12.13 and of course $E_{sep}$ is separable over $F$. Given an $\\alpha $ in $E$ there exists a $p$-power $q$ such that $\\alpha ^ q$ is separable over $F$. Namely, $q$ is that power of $p$ such that the minimal polynomial of $\\alpha $ is of the form $P(x^ q)$ with $P$ separable algebraic, see Lemma 9.12.1. Hence $E/E_{sep}$ is purely inseparable. Uniqueness is clear. \n      $\\square$\n    \n",\n       \n      \n  Lemma 9.14.6. Let $E/F$ be an algebraic field extension. There exists a unique subextension $E/E_{sep}/F$ such that $E_{sep}/F$ is separable and $E/E_{sep}$ is purely inseparable. \n\n    \n,"Proof.\n      If the characteristic is zero we set $E_{sep} = E$. Assume the characteristic is $p > 0$. Let $E_{sep}$ be the set of elements of $E$ which are separable over $F$. This is a subextension by Lemma 9.12.13 and of course $E_{sep}$ is separable over $F$. Given an $\\alpha $ in $E$ there exists a $p$-power $q$ such that $\\alpha ^ q$ is separable over $F$. Namely, $q$ is that power of $p$ such that the minimal polynomial of $\\alpha $ is of the form $P(x^ q)$ with $P$ separable algebraic, see Lemma 9.12.1. Hence $E/E_{sep}$ is purely inseparable. Uniqueness is clear. \n      $\\square$\n    \n"," isPurelyInseparable_iff.2 fun x â†¦ by
  set L := separableClosure F E
  refine âŸ¨(IsAlgebraic.tower_top L (Algebra.IsAlgebraic.isAlgebraic (R := F) x)).isIntegral,
    fun h â†¦ ?_âŸ©
  haveI := (isSeparable_adjoin_simple_iff_isSeparable L E).2 h
  haveI : Algebra.IsSeparable F (restrictScalars F LâŸ®xâŸ¯) := Algebra.IsSeparable.trans F L LâŸ®xâŸ¯
  have hx : x âˆˆ restrictScalars F LâŸ®xâŸ¯ := mem_adjoin_simple_self _ x
  exact âŸ¨âŸ¨x, mem_separableClosure_iff.2 <| isSeparable_of_mem_isSeparable F E hxâŸ©, rflâŸ©
","instance separableClosure.isPurelyInseparable [Algebra.IsAlgebraic F E] :
    IsPurelyInseparable (separableClosure F E) E ","Proof.\n      If the characteristic is zero we set $E_{sep} = E$. Assume the characteristic is $p > 0$. Let $E_{sep}$ be the set of elements of $E$ which are separable over $F$. This is a subextension by Lemma 9.12.13 [[\n  Lemma 9.12.13. Let $E/k$ be a field extension. Then the elements of $E$ separable over $k$ form a subextension of $E/k$. \n\n    \n]] and of course $E_{sep}$ is separable over $F$. Given an $\\alpha $ in $E$ there exists a $p$-power $q$ such that $\\alpha ^ q$ is separable over $F$. Namely, $q$ is that power of $p$ such that the minimal polynomial of $\\alpha $ is of the form $P(x^ q)$ with $P$ separable algebraic, see Lemma 9.12.1 [[\n  Lemma 9.12.1. Let $F$ be a field. Let $P \\in F[x]$ be an irreducible polynomial over $F$. Let $P\' = \\text{d}P/\\text{d}x$ be the derivative of $P$ with respect to $x$. Then one of the following two cases happens \n  \n  \n$P$ and $P\'$ are relatively prime, or \n\n\n$P\'$ is the zero polynomial. \n\n\n\n   The second case can only happen if $F$ has characteristic $p > 0$. In this case $P(x) = Q(x^ q)$ where $q = p^ f$ is a power of $p$ and $Q \\in F[x]$ is an irreducible polynomial such that $Q$ and $Q\'$ are relatively prime. \n\n    \n]]. Hence $E/E_{sep}$ is purely inseparable. Uniqueness is clear. \n      $\\square$\n    \n"
205,09HJ,"theorem finSepDegree_eq [Algebra.IsAlgebraic F E] :
    finSepDegree F E = Cardinal.toNat (sepDegree F E) := by
  have h := finSepDegree_mul_finSepDegree_of_isAlgebraic F (separableClosure F E) E |>.symm
  rwa [finSepDegree_eq_finrank_of_isSeparable F (separableClosure F E),
    IsPurelyInseparable.finSepDegree_eq_one (separableClosure F E) E, mul_one] at h
",Formal Proof of Stacks Project Tag 09HJ,`sepDegree` is defined as the right-hand side of 09HJ,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/PurelyInseparable/Basic.lean#L572-L576,Q27041,,9.14.8,lemma,3.0,"['09HD', '09FA', '0ELQ']","\n  Lemma 9.14.8. Let $K/F$ be a finite extension. Let $\\overline{F}$ be an algebraic closure of $F$. Then $[K : F]_ s = |\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})|$. \n\n    \n      Proof.\n      We first prove this when $K/F$ is purely inseparable. Namely, we claim that in this case there is a unique map $K \\to \\overline{F}$. This can be seen by choosing a sequence of elements $\\alpha _1, \\ldots , \\alpha _ n \\in K$ as in Lemma 9.14.5. The irreducible polynomial of $\\alpha _ i$ over $F(\\alpha _1, \\ldots , \\alpha _{i - 1})$ is $x^ p - \\alpha _ i^ p$. Applying Lemma 9.12.9 we see that $|\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})| = 1$. On the other hand, $[K : F]_ s = 1$ in this case hence the equality holds. \n    \n      Let\'s return to a general finite extension $K/F$. In this case choose $F \\subset K_ s \\subset K$ as in Lemma 9.14.6. By Lemma 9.12.11 we have $|\\mathop{\\mathrm{Mor}}\\nolimits _ F(K_ s, \\overline{F})| = [K_ s : F] = [K : F]_ s$. On the other hand, every field map $\\sigma \' : K_ s \\to \\overline{F}$ extends to a unique field map $\\sigma : K \\to \\overline{F}$ by the result of the previous paragraph. In other words $|\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})| = |\\mathop{\\mathrm{Mor}}\\nolimits _ F(K_ s, \\overline{F})|$ and the proof is done. \n      $\\square$\n    \n","\n  Lemma 9.14.8. Let $K/F$ be a finite extension. Let $\\overline{F}$ be an algebraic closure of $F$. Then $[K : F]_ s = |\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})|$. \n\n    \n","Proof.\n      We first prove this when $K/F$ is purely inseparable. Namely, we claim that in this case there is a unique map $K \\to \\overline{F}$. This can be seen by choosing a sequence of elements $\\alpha _1, \\ldots , \\alpha _ n \\in K$ as in Lemma 9.14.5. The irreducible polynomial of $\\alpha _ i$ over $F(\\alpha _1, \\ldots , \\alpha _{i - 1})$ is $x^ p - \\alpha _ i^ p$. Applying Lemma 9.12.9 we see that $|\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})| = 1$. On the other hand, $[K : F]_ s = 1$ in this case hence the equality holds. \n    \n      Let\'s return to a general finite extension $K/F$. In this case choose $F \\subset K_ s \\subset K$ as in Lemma 9.14.6. By Lemma 9.12.11 we have $|\\mathop{\\mathrm{Mor}}\\nolimits _ F(K_ s, \\overline{F})| = [K_ s : F] = [K : F]_ s$. On the other hand, every field map $\\sigma \' : K_ s \\to \\overline{F}$ extends to a unique field map $\\sigma : K \\to \\overline{F}$ by the result of the previous paragraph. In other words $|\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})| = |\\mathop{\\mathrm{Mor}}\\nolimits _ F(K_ s, \\overline{F})|$ and the proof is done. \n      $\\square$\n    \n"," by
  have h := finSepDegree_mul_finSepDegree_of_isAlgebraic F (separableClosure F E) E |>.symm
  rwa [finSepDegree_eq_finrank_of_isSeparable F (separableClosure F E),
    IsPurelyInseparable.finSepDegree_eq_one (separableClosure F E) E, mul_one] at h
","theorem finSepDegree_eq [Algebra.IsAlgebraic F E] :
    finSepDegree F E = Cardinal.toNat (sepDegree F E) ","Proof.\n      We first prove this when $K/F$ is purely inseparable. Namely, we claim that in this case there is a unique map $K \\to \\overline{F}$. This can be seen by choosing a sequence of elements $\\alpha _1, \\ldots , \\alpha _ n \\in K$ as in Lemma 9.14.5 [[\n  Lemma 9.14.5. Let $E/F$ be a finite purely inseparable field extension of characteristic $p > 0$. Then there exists a sequence of elements $\\alpha _1, \\ldots , \\alpha _ n \\in E$ such that we obtain a tower of fields \n  \n  \\[  E = F(\\alpha _1, \\ldots , \\alpha _ n) \\supset F(\\alpha _1, \\ldots , \\alpha _{n - 1}) \\supset \\ldots \\supset F(\\alpha _1) \\supset F  \\]\n\n   such that each intermediate extension is of degree $p$ and comes from adjoining a $p$th root. Namely, $\\alpha _ i^ p \\in F(\\alpha _1, \\ldots , \\alpha _{i - 1})$ is an element which does not have a $p$th root in $F(\\alpha _1, \\ldots , \\alpha _{i - 1})$ for $i = 1, \\ldots , n$. \n\n    \n]]. The irreducible polynomial of $\\alpha _ i$ over $F(\\alpha _1, \\ldots , \\alpha _{i - 1})$ is $x^ p - \\alpha _ i^ p$. Applying Lemma 9.12.9 [[\n  Lemma 9.12.9. In Situation 9.12.7 we have $|\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})| = \\prod _{i = 1}^ n \\deg _ s(P_ i)$. \n\n    \n]] we see that $|\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})| = 1$. On the other hand, $[K : F]_ s = 1$ in this case hence the equality holds. \n    \n      Let\'s return to a general finite extension $K/F$. In this case choose $F \\subset K_ s \\subset K$ as in Lemma 9.14.6 [[\n       \n      \n  Lemma 9.14.6. Let $E/F$ be an algebraic field extension. There exists a unique subextension $E/E_{sep}/F$ such that $E_{sep}/F$ is separable and $E/E_{sep}$ is purely inseparable. \n\n    \n]]. By Lemma 9.12.11 [[\n  Lemma 9.12.11. Let $K/F$ be a finite extension of fields. Let $\\overline{F}$ be an algebraic closure of $F$. Then we have \n  \n  \\[  |\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})| \\leq [K : F]  \\]\n\n   with equality if and only if $K$ is separable over $F$. \n\n    \n]] we have $|\\mathop{\\mathrm{Mor}}\\nolimits _ F(K_ s, \\overline{F})| = [K_ s : F] = [K : F]_ s$. On the other hand, every field map $\\sigma \' : K_ s \\to \\overline{F}$ extends to a unique field map $\\sigma : K \\to \\overline{F}$ by the result of the previous paragraph. In other words $|\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})| = |\\mathop{\\mathrm{Mor}}\\nolimits _ F(K_ s, \\overline{F})|$ and the proof is done. \n      $\\square$\n    \n"
206,09HH,"def perfectClosure : IntermediateField F E where
  __ := have := expChar_of_injective_algebraMap (algebraMap F E).injective (ringExpChar F)
    Subalgebra.perfectClosure F E (ringExpChar F)
  inv_mem' := by
    rintro x âŸ¨n, hxâŸ©
    use n; rw [inv_pow]
    apply inv_mem (id hx : _ âˆˆ (âŠ¥ : IntermediateField F E))
",Formal Proof of Stacks Project Tag 09HH,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/PurelyInseparable/PerfectClosure.lean#L62-L68,Q27041,,9.14.4,lemma,3.0,"['09HD', '09FA', '0ELQ']","\n  Lemma 9.14.4. Let $E/k$ be a field extension. Then the elements of $E$ purely-inseparable over $k$ form a subextension of $E/k$. \n\n    \n      Proof.\n      Let $p$ be the characteristic of $k$. Let $\\alpha , \\beta \\in E$ be purely inseparable over $k$. Say $\\alpha ^ q \\in k$ and $\\beta ^{q\'} \\in k$ for some $p$-powers $q, q\'$. If $q\'\'$ is a $p$-power, then $(\\alpha + \\beta )^{q\'\'} = \\alpha ^{q\'\'} + \\beta ^{q\'\'}$. Hence if $q\'\' \\geq q, q\'$, then we conclude that $\\alpha + \\beta $ is purely inseparable over $k$. Similarly for the difference, product and quotient of $\\alpha $ and $\\beta $. \n      $\\square$\n    \n",\n  Lemma 9.14.4. Let $E/k$ be a field extension. Then the elements of $E$ purely-inseparable over $k$ form a subextension of $E/k$. \n\n    \n,"Proof.\n      Let $p$ be the characteristic of $k$. Let $\\alpha , \\beta \\in E$ be purely inseparable over $k$. Say $\\alpha ^ q \\in k$ and $\\beta ^{q\'} \\in k$ for some $p$-powers $q, q\'$. If $q\'\'$ is a $p$-power, then $(\\alpha + \\beta )^{q\'\'} = \\alpha ^{q\'\'} + \\beta ^{q\'\'}$. Hence if $q\'\' \\geq q, q\'$, then we conclude that $\\alpha + \\beta $ is purely inseparable over $k$. Similarly for the difference, product and quotient of $\\alpha $ and $\\beta $. \n      $\\square$\n    \n"," have := expChar_of_injective_algebraMap (algebraMap F E).injective (ringExpChar F)
    Subalgebra.perfectClosure F E (ringExpChar F)
  inv_mem' := by
    rintro x âŸ¨n, hxâŸ©
    use n; rw [inv_pow]
    apply inv_mem (id hx : _ âˆˆ (âŠ¥ : IntermediateField F E))
","def perfectClosure : IntermediateField F E where
  __ ","Proof.\n      Let $p$ be the characteristic of $k$. Let $\\alpha , \\beta \\in E$ be purely inseparable over $k$. Say $\\alpha ^ q \\in k$ and $\\beta ^{q\'} \\in k$ for some $p$-powers $q, q\'$. If $q\'\'$ is a $p$-power, then $(\\alpha + \\beta )^{q\'\'} = \\alpha ^{q\'\'} + \\beta ^{q\'\'}$. Hence if $q\'\' \\geq q, q\'$, then we conclude that $\\alpha + \\beta $ is purely inseparable over $k$. Similarly for the difference, product and quotient of $\\alpha $ and $\\beta $. \n      $\\square$\n    \n"
207,09HK,"theorem sepDegree_mul_sepDegree_of_isAlgebraic (K : Type v) [Field K] [Algebra F K]
    [Algebra E K] [IsScalarTower F E K] [Algebra.IsAlgebraic F E] :
    sepDegree F E * sepDegree E K = sepDegree F K := by
  simpa only [Cardinal.lift_id] using lift_sepDegree_mul_lift_sepDegree_of_isAlgebraic F E K
",Formal Proof of Stacks Project Tag 09HK,Part 1,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/PurelyInseparable/Tower.lean#L185-L188,Q27041,Multiplicativity,9.14.9,lemma,3.0,"['09HD', '09FA', '0ELQ']","\n  Lemma 9.14.9 (Multiplicativity).  Suppose given a tower of algebraic field extensions $K/E/F$. Then \n  \n  \\[  [K : F]_ s = [K : E]_ s [E : F]_ s \\quad \\text{and}\\quad [K : F]_ i = [K : E]_ i [E : F]_ i  \\]\n\n\n    \n      Proof.\n      We first prove this in case $K$ is finite over $F$. Since we have multiplicativity for the usual degree (by Lemma 9.7.7) it suffices to prove one of the two formulas. By Lemma 9.14.8 we have $[K : F]_ s = |\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})|$. By the same lemma, given any $\\sigma \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})$ the number of extensions of $\\sigma $ to a map $\\tau : K \\to \\overline{F}$ is $[K : E]_ s$. Namely, via $E \\cong \\sigma (E) \\subset \\overline{F}$ we can view $\\overline{F}$ as an algebraic closure of $E$. Combined with the fact that there are $[E : F]_ s = |\\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})|$ choices for $\\sigma $ we obtain the result. \n    \n      We omit the proof if the extensions are infinite. \n      $\\square$\n    \n",\n  Lemma 9.14.9 (Multiplicativity).  Suppose given a tower of algebraic field extensions $K/E/F$. Then \n  \n  \\[  [K : F]_ s = [K : E]_ s [E : F]_ s \\quad \\text{and}\\quad [K : F]_ i = [K : E]_ i [E : F]_ i  \\]\n\n\n    \n,"Proof.\n      We first prove this in case $K$ is finite over $F$. Since we have multiplicativity for the usual degree (by Lemma 9.7.7) it suffices to prove one of the two formulas. By Lemma 9.14.8 we have $[K : F]_ s = |\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})|$. By the same lemma, given any $\\sigma \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})$ the number of extensions of $\\sigma $ to a map $\\tau : K \\to \\overline{F}$ is $[K : E]_ s$. Namely, via $E \\cong \\sigma (E) \\subset \\overline{F}$ we can view $\\overline{F}$ as an algebraic closure of $E$. Combined with the fact that there are $[E : F]_ s = |\\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})|$ choices for $\\sigma $ we obtain the result. \n    \n      We omit the proof if the extensions are infinite. \n      $\\square$\n    \n"," by
  simpa only [Cardinal.lift_id] using lift_sepDegree_mul_lift_sepDegree_of_isAlgebraic F E K
","theorem sepDegree_mul_sepDegree_of_isAlgebraic (K : Type v) [Field K] [Algebra F K]
    [Algebra E K] [IsScalarTower F E K] [Algebra.IsAlgebraic F E] :
    sepDegree F E * sepDegree E K = sepDegree F K ","Proof.\n      We first prove this in case $K$ is finite over $F$. Since we have multiplicativity for the usual degree (by Lemma 9.7.7 [[\n  Lemma 9.7.7 (Multiplicativity).  Suppose given a tower of fields $F/E/k$. Then \n  \n  \\[  [F:k] = [F:E][E:k]  \\]\n\n\n    \n]]) it suffices to prove one of the two formulas. By Lemma 9.14.8 [[\n  Lemma 9.14.8. Let $K/F$ be a finite extension. Let $\\overline{F}$ be an algebraic closure of $F$. Then $[K : F]_ s = |\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})|$. \n\n    \n]] we have $[K : F]_ s = |\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})|$. By the same lemma, given any $\\sigma \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})$ the number of extensions of $\\sigma $ to a map $\\tau : K \\to \\overline{F}$ is $[K : E]_ s$. Namely, via $E \\cong \\sigma (E) \\subset \\overline{F}$ we can view $\\overline{F}$ as an algebraic closure of $E$. Combined with the fact that there are $[E : F]_ s = |\\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})|$ choices for $\\sigma $ we obtain the result. \n    \n      We omit the proof if the extensions are infinite. \n      $\\square$\n    \n"
208,09HK,"theorem insepDegree_mul_insepDegree_of_isAlgebraic (K : Type v) [Field K] [Algebra F K]
    [Algebra E K] [IsScalarTower F E K] [Algebra.IsAlgebraic F E] :
    insepDegree F E * insepDegree E K = insepDegree F K := by
  simpa only [Cardinal.lift_id] using lift_insepDegree_mul_lift_insepDegree_of_isAlgebraic F E K
",Formal Proof of Stacks Project Tag 09HK,Part 2,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/PurelyInseparable/Tower.lean#L200-L203,Q27041,Multiplicativity,9.14.9,lemma,3.0,"['09HD', '09FA', '0ELQ']","\n  Lemma 9.14.9 (Multiplicativity).  Suppose given a tower of algebraic field extensions $K/E/F$. Then \n  \n  \\[  [K : F]_ s = [K : E]_ s [E : F]_ s \\quad \\text{and}\\quad [K : F]_ i = [K : E]_ i [E : F]_ i  \\]\n\n\n    \n      Proof.\n      We first prove this in case $K$ is finite over $F$. Since we have multiplicativity for the usual degree (by Lemma 9.7.7) it suffices to prove one of the two formulas. By Lemma 9.14.8 we have $[K : F]_ s = |\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})|$. By the same lemma, given any $\\sigma \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})$ the number of extensions of $\\sigma $ to a map $\\tau : K \\to \\overline{F}$ is $[K : E]_ s$. Namely, via $E \\cong \\sigma (E) \\subset \\overline{F}$ we can view $\\overline{F}$ as an algebraic closure of $E$. Combined with the fact that there are $[E : F]_ s = |\\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})|$ choices for $\\sigma $ we obtain the result. \n    \n      We omit the proof if the extensions are infinite. \n      $\\square$\n    \n",\n  Lemma 9.14.9 (Multiplicativity).  Suppose given a tower of algebraic field extensions $K/E/F$. Then \n  \n  \\[  [K : F]_ s = [K : E]_ s [E : F]_ s \\quad \\text{and}\\quad [K : F]_ i = [K : E]_ i [E : F]_ i  \\]\n\n\n    \n,"Proof.\n      We first prove this in case $K$ is finite over $F$. Since we have multiplicativity for the usual degree (by Lemma 9.7.7) it suffices to prove one of the two formulas. By Lemma 9.14.8 we have $[K : F]_ s = |\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})|$. By the same lemma, given any $\\sigma \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})$ the number of extensions of $\\sigma $ to a map $\\tau : K \\to \\overline{F}$ is $[K : E]_ s$. Namely, via $E \\cong \\sigma (E) \\subset \\overline{F}$ we can view $\\overline{F}$ as an algebraic closure of $E$. Combined with the fact that there are $[E : F]_ s = |\\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})|$ choices for $\\sigma $ we obtain the result. \n    \n      We omit the proof if the extensions are infinite. \n      $\\square$\n    \n"," by
  simpa only [Cardinal.lift_id] using lift_insepDegree_mul_lift_insepDegree_of_isAlgebraic F E K
","theorem insepDegree_mul_insepDegree_of_isAlgebraic (K : Type v) [Field K] [Algebra F K]
    [Algebra E K] [IsScalarTower F E K] [Algebra.IsAlgebraic F E] :
    insepDegree F E * insepDegree E K = insepDegree F K ","Proof.\n      We first prove this in case $K$ is finite over $F$. Since we have multiplicativity for the usual degree (by Lemma 9.7.7 [[\n  Lemma 9.7.7 (Multiplicativity).  Suppose given a tower of fields $F/E/k$. Then \n  \n  \\[  [F:k] = [F:E][E:k]  \\]\n\n\n    \n]]) it suffices to prove one of the two formulas. By Lemma 9.14.8 [[\n  Lemma 9.14.8. Let $K/F$ be a finite extension. Let $\\overline{F}$ be an algebraic closure of $F$. Then $[K : F]_ s = |\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})|$. \n\n    \n]] we have $[K : F]_ s = |\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})|$. By the same lemma, given any $\\sigma \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})$ the number of extensions of $\\sigma $ to a map $\\tau : K \\to \\overline{F}$ is $[K : E]_ s$. Namely, via $E \\cong \\sigma (E) \\subset \\overline{F}$ we can view $\\overline{F}$ as an algebraic closure of $E$. Combined with the fact that there are $[E : F]_ s = |\\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})|$ choices for $\\sigma $ we obtain the result. \n    \n      We omit the proof if the extensions are infinite. \n      $\\square$\n    \n"
209,09HK,"theorem finInsepDegree_mul_finInsepDegree_of_isAlgebraic [Algebra.IsAlgebraic F E] :
    finInsepDegree F E * finInsepDegree E K = finInsepDegree F K := by
  simpa only [map_mul, Cardinal.toNat_lift] using
    congr(Cardinal.toNat $(lift_insepDegree_mul_lift_insepDegree_of_isAlgebraic F E K))
",Formal Proof of Stacks Project Tag 09HK,"Part 2, `finInsepDegree` variant",https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/PurelyInseparable/Tower.lean#L208-L211,Q27041,Multiplicativity,9.14.9,lemma,3.0,"['09HD', '09FA', '0ELQ']","\n  Lemma 9.14.9 (Multiplicativity).  Suppose given a tower of algebraic field extensions $K/E/F$. Then \n  \n  \\[  [K : F]_ s = [K : E]_ s [E : F]_ s \\quad \\text{and}\\quad [K : F]_ i = [K : E]_ i [E : F]_ i  \\]\n\n\n    \n      Proof.\n      We first prove this in case $K$ is finite over $F$. Since we have multiplicativity for the usual degree (by Lemma 9.7.7) it suffices to prove one of the two formulas. By Lemma 9.14.8 we have $[K : F]_ s = |\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})|$. By the same lemma, given any $\\sigma \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})$ the number of extensions of $\\sigma $ to a map $\\tau : K \\to \\overline{F}$ is $[K : E]_ s$. Namely, via $E \\cong \\sigma (E) \\subset \\overline{F}$ we can view $\\overline{F}$ as an algebraic closure of $E$. Combined with the fact that there are $[E : F]_ s = |\\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})|$ choices for $\\sigma $ we obtain the result. \n    \n      We omit the proof if the extensions are infinite. \n      $\\square$\n    \n",\n  Lemma 9.14.9 (Multiplicativity).  Suppose given a tower of algebraic field extensions $K/E/F$. Then \n  \n  \\[  [K : F]_ s = [K : E]_ s [E : F]_ s \\quad \\text{and}\\quad [K : F]_ i = [K : E]_ i [E : F]_ i  \\]\n\n\n    \n,"Proof.\n      We first prove this in case $K$ is finite over $F$. Since we have multiplicativity for the usual degree (by Lemma 9.7.7) it suffices to prove one of the two formulas. By Lemma 9.14.8 we have $[K : F]_ s = |\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})|$. By the same lemma, given any $\\sigma \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})$ the number of extensions of $\\sigma $ to a map $\\tau : K \\to \\overline{F}$ is $[K : E]_ s$. Namely, via $E \\cong \\sigma (E) \\subset \\overline{F}$ we can view $\\overline{F}$ as an algebraic closure of $E$. Combined with the fact that there are $[E : F]_ s = |\\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})|$ choices for $\\sigma $ we obtain the result. \n    \n      We omit the proof if the extensions are infinite. \n      $\\square$\n    \n"," by
  simpa only [map_mul, Cardinal.toNat_lift] using
    congr(Cardinal.toNat $(lift_insepDegree_mul_lift_insepDegree_of_isAlgebraic F E K))
","theorem finInsepDegree_mul_finInsepDegree_of_isAlgebraic [Algebra.IsAlgebraic F E] :
    finInsepDegree F E * finInsepDegree E K = finInsepDegree F K ","Proof.\n      We first prove this in case $K$ is finite over $F$. Since we have multiplicativity for the usual degree (by Lemma 9.7.7 [[\n  Lemma 9.7.7 (Multiplicativity).  Suppose given a tower of fields $F/E/k$. Then \n  \n  \\[  [F:k] = [F:E][E:k]  \\]\n\n\n    \n]]) it suffices to prove one of the two formulas. By Lemma 9.14.8 [[\n  Lemma 9.14.8. Let $K/F$ be a finite extension. Let $\\overline{F}$ be an algebraic closure of $F$. Then $[K : F]_ s = |\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})|$. \n\n    \n]] we have $[K : F]_ s = |\\mathop{\\mathrm{Mor}}\\nolimits _ F(K, \\overline{F})|$. By the same lemma, given any $\\sigma \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})$ the number of extensions of $\\sigma $ to a map $\\tau : K \\to \\overline{F}$ is $[K : E]_ s$. Namely, via $E \\cong \\sigma (E) \\subset \\overline{F}$ we can view $\\overline{F}$ as an algebraic closure of $E$. Combined with the fact that there are $[E : F]_ s = |\\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})|$ choices for $\\sigma $ we obtain the result. \n    \n      We omit the proof if the extensions are infinite. \n      $\\square$\n    \n"
210,09FK,"instance instField [IsDomain K] : Field (RatFunc K) where
  inv_zero := by frac_tac
  div_eq_mul_inv := by frac_tac
  mul_inv_cancel _ := mul_inv_cancel
  zpow := zpowRec
  nnqsmul := _
  nnqsmul_def := fun _ _ => rfl
  qsmul := _
  qsmul_def := fun _ _ => rfl
",Formal Proof of Stacks Project Tag 09FK,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/RatFunc/Basic.lean#L476-L484,Q27041,Field of rational functions,9.3.5,example,3.0,"['09FF', '09FA', '0ELQ']","\n  Example 9.3.5 (Field of rational functions).  If $k$ is a field, then we can consider the field $k(x)$ of rational functions over $k$. This is the quotient field of the polynomial ring $k[x]$. In other words, it is the set of quotients $F/G$ for $F, G \\in k[x]$, $G \\not= 0$ with the obvious equivalence relation. \n","\n  Example 9.3.5 (Field of rational functions).  If $k$ is a field, then we can consider the field $k(x)$ of rational functions over $k$. This is the quotient field of the polynomial ring $k[x]$. In other words, it is the set of quotients $F/G$ for $F, G \\in k[x]$, $G \\not= 0$ with the obvious equivalence relation. \n",," by frac_tac
  div_eq_mul_inv := by frac_tac
  mul_inv_cancel _ := mul_inv_cancel
  zpow := zpowRec
  nnqsmul := _
  nnqsmul_def := fun _ _ => rfl
  qsmul := _
  qsmul_def := fun _ _ => rfl
","instance instField [IsDomain K] : Field (RatFunc K) where
  inv_zero ",
211,09HV,"def SplittingField (f : K[X]) :=
  MvPolynomial (SplittingFieldAux f.natDegree f) K â§¸
    RingHom.ker (MvPolynomial.aeval (R := K) id).toRingHom
deriving Inhabited, CommRing, Algebra K
",Formal Proof of Stacks Project Tag 09HV,The construction of the splitting field.,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/SplittingField/Construction.lean#L216-L219,Q27041,,9.16.2,definition,3.0,"['09HT', '09FA', '0ELQ']",\n  Definition 9.16.2. Let $F$ be a field. Let $P \\in F[x]$ be a nonconstant polynomial. The field extension $E/F$ constructed in Lemma 9.16.1 is called the splitting field of $P$ over $F$. \n,\n  Definition 9.16.2. Let $F$ be a field. Let $P \\in F[x]$ be a nonconstant polynomial. The field extension $E/F$ constructed in Lemma 9.16.1 is called the splitting field of $P$ over $F$. \n,,"
  MvPolynomial (SplittingFieldAux f.natDegree f) K â§¸
    RingHom.ker (MvPolynomial.aeval (R := K) id).toRingHom
deriving Inhabited, CommRing, Algebra K
",def SplittingField (f : K[X]) ,
212,09HU,"protected theorem splits : Splits (f.map (algebraMap K (SplittingField f))) :=
  IsSplittingField.splits f.SplittingField f
",Formal Proof of Stacks Project Tag 09HU,Splitting part,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/SplittingField/Construction.lean#L272-L273,Q27041,,9.16.1,lemma,3.0,"['09HT', '09FA', '0ELQ']","\n  Lemma 9.16.1. Let $F$ be a field. Let $P \\in F[x]$ be a nonconstant polynomial. There exists a smallest field extension $E/F$ such that $P$ splits completely over $E$. Moreover, the field extension $E/F$ is normal and unique up to (nonunique) isomorphism. \n\n    \n      Proof.\n      Choose an algebraic closure $\\overline{F}$. Then we can write $P = c (x - \\beta _1) \\ldots (x - \\beta _ n)$ in $\\overline{F}[x]$, see Lemma 9.10.2. Note that $c \\in F^*$. Set $E = F(\\beta _1, \\ldots , \\beta _ n)$. Then it is clear that $E$ is minimal with the requirement that $P$ splits completely over $E$. \n    \n      Next, let $E\'$ be another minimal field extension of $F$ such that $P$ splits completely over $E\'$. Write $P = c (x - \\alpha _1) \\ldots (x - \\alpha _ n)$ with $c \\in F$ and $\\alpha _ i \\in E\'$. Again it follows from minimality that $E\' = F(\\alpha _1, \\ldots , \\alpha _ n)$. Moreover, if we pick any $\\sigma : E\' \\to \\overline{F}$ (Lemma 9.10.5) then we immediately see that $\\sigma (\\alpha _ i) = \\beta _{\\tau (i)}$ for some permutation $\\tau : \\{ 1, \\ldots , n\\}  \\to \\{ 1, \\ldots , n\\} $. Thus $\\sigma (E\') = E$. This implies that $E\'$ is a normal extension of $F$ by Lemma 9.15.5 and that $E \\cong E\'$ as extensions of $F$ thereby finishing the proof. \n      $\\square$\n    \n","\n  Lemma 9.16.1. Let $F$ be a field. Let $P \\in F[x]$ be a nonconstant polynomial. There exists a smallest field extension $E/F$ such that $P$ splits completely over $E$. Moreover, the field extension $E/F$ is normal and unique up to (nonunique) isomorphism. \n\n    \n","Proof.\n      Choose an algebraic closure $\\overline{F}$. Then we can write $P = c (x - \\beta _1) \\ldots (x - \\beta _ n)$ in $\\overline{F}[x]$, see Lemma 9.10.2. Note that $c \\in F^*$. Set $E = F(\\beta _1, \\ldots , \\beta _ n)$. Then it is clear that $E$ is minimal with the requirement that $P$ splits completely over $E$. \n    \n      Next, let $E\'$ be another minimal field extension of $F$ such that $P$ splits completely over $E\'$. Write $P = c (x - \\alpha _1) \\ldots (x - \\alpha _ n)$ with $c \\in F$ and $\\alpha _ i \\in E\'$. Again it follows from minimality that $E\' = F(\\alpha _1, \\ldots , \\alpha _ n)$. Moreover, if we pick any $\\sigma : E\' \\to \\overline{F}$ (Lemma 9.10.5) then we immediately see that $\\sigma (\\alpha _ i) = \\beta _{\\tau (i)}$ for some permutation $\\tau : \\{ 1, \\ldots , n\\}  \\to \\{ 1, \\ldots , n\\} $. Thus $\\sigma (E\') = E$. This implies that $E\'$ is a normal extension of $F$ by Lemma 9.15.5 and that $E \\cong E\'$ as extensions of $F$ thereby finishing the proof. \n      $\\square$\n    \n","
  IsSplittingField.splits f.SplittingField f
",protected theorem splits : Splits (f.map (algebraMap K (SplittingField f))) ,"Proof.\n      Choose an algebraic closure $\\overline{F}$. Then we can write $P = c (x - \\beta _1) \\ldots (x - \\beta _ n)$ in $\\overline{F}[x]$, see Lemma 9.10.2 [[\n  Lemma 9.10.2. Let $F$ be a field. The following are equivalent \n  \n  \n$F$ is algebraically closed, \n\n\nevery irreducible polynomial over $F$ is linear, \n\n\nevery nonconstant polynomial over $F$ has a root, \n\n\nevery nonconstant polynomial over $F$ is a product of linear factors. \n\n\n\n\n    \n]]. Note that $c \\in F^*$. Set $E = F(\\beta _1, \\ldots , \\beta _ n)$. Then it is clear that $E$ is minimal with the requirement that $P$ splits completely over $E$. \n    \n      Next, let $E\'$ be another minimal field extension of $F$ such that $P$ splits completely over $E\'$. Write $P = c (x - \\alpha _1) \\ldots (x - \\alpha _ n)$ with $c \\in F$ and $\\alpha _ i \\in E\'$. Again it follows from minimality that $E\' = F(\\alpha _1, \\ldots , \\alpha _ n)$. Moreover, if we pick any $\\sigma : E\' \\to \\overline{F}$ (Lemma 9.10.5 [[\n  Lemma 9.10.5. Let $F$ be a field. Let $\\overline{F}$ be an algebraic closure of $F$. Let $M/F$ be an algebraic extension. Then there is a morphism of $F$-extensions $M \\to \\overline{F}$. \n\n    \n]]) then we immediately see that $\\sigma (\\alpha _ i) = \\beta _{\\tau (i)}$ for some permutation $\\tau : \\{ 1, \\ldots , n\\}  \\to \\{ 1, \\ldots , n\\} $. Thus $\\sigma (E\') = E$. This implies that $E\'$ is a normal extension of $F$ by Lemma 9.15.5 [[\n  Lemma 9.15.5. Let $E/F$ be an algebraic extension of fields. Let $\\overline{F}$ be an algebraic closure of $F$. The following are equivalent \n  \n  \n$E$ is normal over $F$, and \n\n\nfor every pair $\\sigma , \\sigma \' \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})$ we have $\\sigma (E) = \\sigma \'(E)$. \n\n\n\n\n    \n]] and that $E \\cong E\'$ as extensions of $F$ thereby finishing the proof. \n      $\\square$\n    \n"
213,09HV,"class IsSplittingField (f : K[X]) : Prop where
  splits' : Splits (f.map (algebraMap K L))
  adjoin_rootSet' : Algebra.adjoin K (f.rootSet L : Set L) = âŠ¤
",Formal Proof of Stacks Project Tag 09HV,Predicate version,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/FieldTheory/SplittingField/IsSplittingField.lean#L47-L49,Q27041,,9.16.2,definition,3.0,"['09HT', '09FA', '0ELQ']",\n  Definition 9.16.2. Let $F$ be a field. Let $P \\in F[x]$ be a nonconstant polynomial. The field extension $E/F$ constructed in Lemma 9.16.1 is called the splitting field of $P$ over $F$. \n,\n  Definition 9.16.2. Let $F$ be a field. Let $P \\in F[x]$ be a nonconstant polynomial. The field extension $E/F$ constructed in Lemma 9.16.1 is called the splitting field of $P$ over $F$. \n,,,"class IsSplittingField (f : K[X]) : Prop where
  splits' : Splits (f.map (algebraMap K L))
  adjoin_rootSet' : Algebra.adjoin K (f.rootSet L : Set L) = âŠ¤
",
214,09FN,"instance (priority := 100) _root_.Module.Free.of_divisionRing : Module.Free K V :=
  Module.Free.of_basis (ofVectorSpace K V)
",Formal Proof of Stacks Project Tag 09FN,Generalized from fields to division rings.,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/LinearAlgebra/Basis/VectorSpace.lean#L153-L154,Q27041,,9.4.1,lemma,3.0,"['09FM', '09FA', '0ELQ']","\n  Lemma 9.4.1. If $k$ is a field, then every $k$-module is free. \n\n    \n      Proof.\n      Indeed, by linear algebra we know that a $k$-module (i.e. vector space) $V$ has a basis $\\mathcal{B} \\subset V$, which defines an isomorphism from the free vector space on $\\mathcal{B}$ to $V$. \n      $\\square$\n    \n","\n  Lemma 9.4.1. If $k$ is a field, then every $k$-module is free. \n\n    \n","Proof.\n      Indeed, by linear algebra we know that a $k$-module (i.e. vector space) $V$ has a basis $\\mathcal{B} \\subset V$, which defines an isomorphism from the free vector space on $\\mathcal{B}$ to $V$. \n      $\\square$\n    \n"," 100) _root_.Module.Free.of_divisionRing : Module.Free K V :=
  Module.Free.of_basis (ofVectorSpace K V)
",instance (priority ,"Proof.\n      Indeed, by linear algebra we know that a $k$-module (i.e. vector space) $V$ has a basis $\\mathcal{B} \\subset V$, which defines an isomorphism from the free vector space on $\\mathcal{B}$ to $V$. \n      $\\square$\n    \n"
215,09G3,"protected irreducible_def Module.rank : Cardinal :=
  â¨† Î¹ : { s : Set M // LinearIndepOn R id s }, (#Î¹.1)
",Formal Proof of Stacks Project Tag 09G3,first part,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/LinearAlgebra/Dimension/Basic.lean#L68-L69,Q27041,,9.7.1,definition,3.0,"['09G2', '09FA', '0ELQ']",\n  Definition 9.7.1. Let $F/E$ be an extension of fields. The dimension of $F$ considered as an $E$-vector space is called the degree of the extension and is denoted $[F : E]$. If $[F : E] < \\infty $ then $F$ is said to be a finite extension of $E$. \n,\n  Definition 9.7.1. Let $F/E$ be an extension of fields. The dimension of $F$ considered as an $E$-vector space is called the degree of the extension and is denoted $[F : E]$. If $[F : E] < \\infty $ then $F$ is said to be a finite extension of $E$. \n,,"
  â¨† Î¹ : { s : Set M // LinearIndepOn R id s }, (#Î¹.1)
",protected irreducible_def Module.rank : Cardinal ,
216,09G9,"theorem rank_mul_rank (A : Type v) [AddCommMonoid A]
    [Module K A] [Module F A] [IsScalarTower F K A] [Module.Free K A] :
    Module.rank F K * Module.rank K A = Module.rank F A := by
  convert lift_rank_mul_lift_rank F K A <;> rw [lift_id]
",Formal Proof of Stacks Project Tag 09G9,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/LinearAlgebra/Dimension/Free.lean#L58-L61,Q27041,Multiplicativity,9.7.7,lemma,3.0,"['09G2', '09FA', '0ELQ']","\n  Lemma 9.7.7 (Multiplicativity).  Suppose given a tower of fields $F/E/k$. Then \n  \n  \\[  [F:k] = [F:E][E:k]  \\]\n\n\n    \n      Proof.\n      Let $\\alpha _1, \\ldots , \\alpha _ n \\in F$ be an $E$-basis for $F$. Let $\\beta _1, \\ldots , \\beta _ m \\in E$ be a $k$-basis for $E$. Then the claim is that the set of products $\\{ \\alpha _ i \\beta _ j, 1 \\leq i \\leq n, 1 \\leq j \\leq m\\} $ is a $k$-basis for $F$. Indeed, let us check first that they span $F$ over $k$. \n    \n      By assumption, the $\\{ \\alpha _ i\\} $ span $F$ over $E$. So if $f \\in F$, there are $a_ i \\in E$ with \n    \n      \n  \\[  f = \\sum \\nolimits _ i a_ i \\alpha _ i,  \\]\n\n    \n       and, for each $i$, we can write $a_ i = \\sum b_{ij} \\beta _ j$ for some $b_{ij} \\in k$. Putting these together, we find \n    \n      \n  \\[  f = \\sum \\nolimits _{i,j} b_{ij} \\alpha _ i \\beta _ j,  \\]\n\n    \n       proving that the $\\{ \\alpha _ i \\beta _ j\\} $ span $F$ over $k$. \n    \n      Suppose now that there existed a nontrivial relation \n    \n      \n  \\[  \\sum \\nolimits _{i,j} c_{ij} \\alpha _ i \\beta _ j = 0  \\]\n\n    \n       for the $c_{ij} \\in k$. In that case, we would have \n    \n      \n  \\[  \\sum \\nolimits _ i \\alpha _ i \\left( \\sum \\nolimits _ j c_{ij} \\beta _ j \\right) = 0,  \\]\n\n    \n       and the inner terms lie in $E$ as the $\\beta _ j$ do. Now $E$-linear independence of the $\\{ \\alpha _ i\\} $ shows that the inner sums are all zero. Then $k$-linear independence of the $\\{ \\beta _ j\\} $ shows that the $c_{ij}$ all vanish. \n      $\\square$\n    \n",\n  Lemma 9.7.7 (Multiplicativity).  Suppose given a tower of fields $F/E/k$. Then \n  \n  \\[  [F:k] = [F:E][E:k]  \\]\n\n\n    \n,"Proof.\n      Let $\\alpha _1, \\ldots , \\alpha _ n \\in F$ be an $E$-basis for $F$. Let $\\beta _1, \\ldots , \\beta _ m \\in E$ be a $k$-basis for $E$. Then the claim is that the set of products $\\{ \\alpha _ i \\beta _ j, 1 \\leq i \\leq n, 1 \\leq j \\leq m\\} $ is a $k$-basis for $F$. Indeed, let us check first that they span $F$ over $k$. \n    \n      By assumption, the $\\{ \\alpha _ i\\} $ span $F$ over $E$. So if $f \\in F$, there are $a_ i \\in E$ with \n    \n      \n  \\[  f = \\sum \\nolimits _ i a_ i \\alpha _ i,  \\]\n\n    \n       and, for each $i$, we can write $a_ i = \\sum b_{ij} \\beta _ j$ for some $b_{ij} \\in k$. Putting these together, we find \n    \n      \n  \\[  f = \\sum \\nolimits _{i,j} b_{ij} \\alpha _ i \\beta _ j,  \\]\n\n    \n       proving that the $\\{ \\alpha _ i \\beta _ j\\} $ span $F$ over $k$. \n    \n      Suppose now that there existed a nontrivial relation \n    \n      \n  \\[  \\sum \\nolimits _{i,j} c_{ij} \\alpha _ i \\beta _ j = 0  \\]\n\n    \n       for the $c_{ij} \\in k$. In that case, we would have \n    \n      \n  \\[  \\sum \\nolimits _ i \\alpha _ i \\left( \\sum \\nolimits _ j c_{ij} \\beta _ j \\right) = 0,  \\]\n\n    \n       and the inner terms lie in $E$ as the $\\beta _ j$ do. Now $E$-linear independence of the $\\{ \\alpha _ i\\} $ shows that the inner sums are all zero. Then $k$-linear independence of the $\\{ \\beta _ j\\} $ shows that the $c_{ij}$ all vanish. \n      $\\square$\n    \n"," by
  convert lift_rank_mul_lift_rank F K A <;> rw [lift_id]
","theorem rank_mul_rank (A : Type v) [AddCommMonoid A]
    [Module K A] [Module F A] [IsScalarTower F K A] [Module.Free K A] :
    Module.rank F K * Module.rank K A = Module.rank F A ","Proof.\n      Let $\\alpha _1, \\ldots , \\alpha _ n \\in F$ be an $E$-basis for $F$. Let $\\beta _1, \\ldots , \\beta _ m \\in E$ be a $k$-basis for $E$. Then the claim is that the set of products $\\{ \\alpha _ i \\beta _ j, 1 \\leq i \\leq n, 1 \\leq j \\leq m\\} $ is a $k$-basis for $F$. Indeed, let us check first that they span $F$ over $k$. \n    \n      By assumption, the $\\{ \\alpha _ i\\} $ span $F$ over $E$. So if $f \\in F$, there are $a_ i \\in E$ with \n    \n      \n  \\[  f = \\sum \\nolimits _ i a_ i \\alpha _ i,  \\]\n\n    \n       and, for each $i$, we can write $a_ i = \\sum b_{ij} \\beta _ j$ for some $b_{ij} \\in k$. Putting these together, we find \n    \n      \n  \\[  f = \\sum \\nolimits _{i,j} b_{ij} \\alpha _ i \\beta _ j,  \\]\n\n    \n       proving that the $\\{ \\alpha _ i \\beta _ j\\} $ span $F$ over $k$. \n    \n      Suppose now that there existed a nontrivial relation \n    \n      \n  \\[  \\sum \\nolimits _{i,j} c_{ij} \\alpha _ i \\beta _ j = 0  \\]\n\n    \n       for the $c_{ij} \\in k$. In that case, we would have \n    \n      \n  \\[  \\sum \\nolimits _ i \\alpha _ i \\left( \\sum \\nolimits _ j c_{ij} \\beta _ j \\right) = 0,  \\]\n\n    \n       and the inner terms lie in $E$ as the $\\beta _ j$ do. Now $E$-linear independence of the $\\{ \\alpha _ i\\} $ shows that the inner sums are all zero. Then $k$-linear independence of the $\\{ \\beta _ j\\} $ shows that the $c_{ij}$ all vanish. \n      $\\square$\n    \n"
217,09HS,"theorem card_algHom_le_finrank : Nat.card (M â†’â‚[K] L) â‰¤ finrank K M := by
  convert toNat_le_toNat (cardinalMk_algHom_le_rank K M L) ?_
  Â· rw [toNat_lift, finrank]
  Â· rw [lift_lt_aleph0]; have := Module.nontrivial K L; apply Module.rank_lt_aleph0
",Formal Proof of Stacks Project Tag 09HS,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/LinearAlgebra/FreeModule/Finite/Matrix.lean#L91-L94,Q27041,,9.15.9,lemma,3.0,"['09HL', '09FA', '0ELQ']","\n  Lemma 9.15.9. Let $E/F$ be a finite extension. We have \n  \n  \\[  |\\text{Aut}(E/F)| \\leq [E : F]_ s  \\]\n\n   with equality if and only if $E$ is normal over $F$. \n\n    \n      Proof.\n      Choose an algebraic closure $\\overline{F}$ of $F$. Recall that $[E : F]_ s = |\\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})|$. Pick an element $\\sigma _0 \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})$. Then the map \n    \n      \n  \\[  \\text{Aut}(E/F) \\longrightarrow \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F}),\\quad \\tau \\longmapsto \\sigma _0 \\circ \\tau  \\]\n\n    \n       is injective. Thus the inequality. If equality holds, then every $\\sigma \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})$ is gotten by precomposing $\\sigma _0$ by an automorphism. Hence $\\sigma (E) = \\sigma _0(E)$. Thus $E$ is normal over $F$ by Lemma 9.15.5. \n    \n      Conversely, assume that $E/F$ is normal. Then by Lemma 9.15.5 we have $\\sigma (E) = \\sigma _0(E)$ for all $\\sigma \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})$. Thus we get an automorphism of $E$ over $F$ by setting $\\tau = \\sigma _0^{-1} \\circ \\sigma $. Whence the map displayed above is surjective. \n      $\\square$\n    \n",\n  Lemma 9.15.9. Let $E/F$ be a finite extension. We have \n  \n  \\[  |\\text{Aut}(E/F)| \\leq [E : F]_ s  \\]\n\n   with equality if and only if $E$ is normal over $F$. \n\n    \n,"Proof.\n      Choose an algebraic closure $\\overline{F}$ of $F$. Recall that $[E : F]_ s = |\\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})|$. Pick an element $\\sigma _0 \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})$. Then the map \n    \n      \n  \\[  \\text{Aut}(E/F) \\longrightarrow \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F}),\\quad \\tau \\longmapsto \\sigma _0 \\circ \\tau  \\]\n\n    \n       is injective. Thus the inequality. If equality holds, then every $\\sigma \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})$ is gotten by precomposing $\\sigma _0$ by an automorphism. Hence $\\sigma (E) = \\sigma _0(E)$. Thus $E$ is normal over $F$ by Lemma 9.15.5. \n    \n      Conversely, assume that $E/F$ is normal. Then by Lemma 9.15.5 we have $\\sigma (E) = \\sigma _0(E)$ for all $\\sigma \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})$. Thus we get an automorphism of $E$ over $F$ by setting $\\tau = \\sigma _0^{-1} \\circ \\sigma $. Whence the map displayed above is surjective. \n      $\\square$\n    \n"," by
  convert toNat_le_toNat (cardinalMk_algHom_le_rank K M L) ?_
  Â· rw [toNat_lift, finrank]
  Â· rw [lift_lt_aleph0]; have := Module.nontrivial K L; apply Module.rank_lt_aleph0
",theorem card_algHom_le_finrank : Nat.card (M â†’â‚[K] L) â‰¤ finrank K M ,"Proof.\n      Choose an algebraic closure $\\overline{F}$ of $F$. Recall that $[E : F]_ s = |\\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})|$. Pick an element $\\sigma _0 \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})$. Then the map \n    \n      \n  \\[  \\text{Aut}(E/F) \\longrightarrow \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F}),\\quad \\tau \\longmapsto \\sigma _0 \\circ \\tau  \\]\n\n    \n       is injective. Thus the inequality. If equality holds, then every $\\sigma \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})$ is gotten by precomposing $\\sigma _0$ by an automorphism. Hence $\\sigma (E) = \\sigma _0(E)$. Thus $E$ is normal over $F$ by Lemma 9.15.5 [[\n  Lemma 9.15.5. Let $E/F$ be an algebraic extension of fields. Let $\\overline{F}$ be an algebraic closure of $F$. The following are equivalent \n  \n  \n$E$ is normal over $F$, and \n\n\nfor every pair $\\sigma , \\sigma \' \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})$ we have $\\sigma (E) = \\sigma \'(E)$. \n\n\n\n\n    \n]]. \n    \n      Conversely, assume that $E/F$ is normal. Then by Lemma 9.15.5 [[\n  Lemma 9.15.5. Let $E/F$ be an algebraic extension of fields. Let $\\overline{F}$ be an algebraic closure of $F$. The following are equivalent \n  \n  \n$E$ is normal over $F$, and \n\n\nfor every pair $\\sigma , \\sigma \' \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})$ we have $\\sigma (E) = \\sigma \'(E)$. \n\n\n\n\n    \n]] we have $\\sigma (E) = \\sigma _0(E)$ for all $\\sigma \\in \\mathop{\\mathrm{Mor}}\\nolimits _ F(E, \\overline{F})$. Thus we get an automorphism of $E$ over $F$ by setting $\\tau = \\sigma _0^{-1} \\circ \\sigma $. Whence the map displayed above is surjective. \n      $\\square$\n    \n"
218,0CKL,"theorem linearIndependent_monoidHom (G : Type*) [MulOneClass G] (L : Type*) [CommRing L]
    [IsDomain L] : LinearIndependent L (M := G â†’ L) (fun f => f : (G â†’* L) â†’ G â†’ L) := by
  letI := Classical.decEq (G â†’* L)
  letI : MulAction L L := DistribMulAction.toMulAction
  -- We prove linear independence by showing that only the trivial linear combination vanishes.
  apply linearIndependent_iff'.2
  intro s
  induction s using Finset.induction_on with
  | empty => simp
  | insert a s has ih =>
  intro g hg
  -- Here
  -- * `a` is a new character we will insert into the `Finset` of characters `s`,
  -- * `ih` is the fact that only the trivial linear combination of characters in `s` is zero
  -- * `hg` is the fact that `g` are the coefficients of a linear combination summing to zero
  -- and it remains to prove that `g` vanishes on `insert a s`.
  -- We now make the key calculation:
  -- For any character `i` in the original `Finset`, we have `g i â€¢ i = g i â€¢ a` as functions
  -- on the monoid `G`.
  have h1 (i) (his : i âˆˆ s) : (g i â€¢ i : G â†’ L) = g i â€¢ a := by
    ext x
    rw [â† sub_eq_zero]
    apply ih (fun j => g j * j x - g j * a x) _ i his
    ext y
    -- After that, it's just a chase scene.
    calc
      (âˆ‘ i âˆˆ s, (g i * i x - g i * a x) â€¢ i : G â†’ L) y =
          (âˆ‘ i âˆˆ s, g i * i x * i y) - âˆ‘ i âˆˆ s, g i * a x * i y := by simp [sub_mul]
      _ = (âˆ‘ i âˆˆ insert a s, g i * i x * i y) -
            âˆ‘ i âˆˆ insert a s, g i * a x * i y := by simp [Finset.sum_insert has]
      _ = (âˆ‘ i âˆˆ insert a s, g i * (i x * i y)) -
            âˆ‘ i âˆˆ insert a s, a x * (g i * i y) := by
        congrm âˆ‘ i âˆˆ insert a s, ?_ - âˆ‘ i âˆˆ insert a s, ?_
        Â· rw [mul_assoc]
        Â· rw [mul_assoc, mul_left_comm]
      _ = (âˆ‘ i âˆˆ insert a s, g i â€¢ i : G â†’ L) (x * y) -
            a x * (âˆ‘ i âˆˆ insert a s, (g i â€¢ (i : G â†’ L))) y := by simp [Finset.mul_sum]
      _ = 0 := by rw [hg]; simp
  -- On the other hand, since `a` is not already in `s`, for any character `i âˆˆ s`
  -- there is some element of the monoid on which it differs from `a`.
  have h2 (i) (his : i âˆˆ s) : âˆƒ y, i y â‰  a y := by
    by_contra! hia
    obtain rfl : i = a := MonoidHom.ext hia
    contradiction
  -- From these two facts we deduce that `g` actually vanishes on `s`,
  have h3 (i) (his : i âˆˆ s) : g i = 0 := by
    let âŸ¨y, hyâŸ© := h2 i his
    have h : g i â€¢ i y = g i â€¢ a y := congr_fun (h1 i his) y
    rw [â† sub_eq_zero, â† smul_sub, smul_eq_zero] at h
    exact h.resolve_right (sub_ne_zero_of_ne hy)
  -- And so, using the fact that the linear combination over `s` and over `insert a s` both
  -- vanish, we deduce that `g a = 0`.
  have h4 : g a = 0 :=
    calc
      g a = g a * 1 := (mul_one _).symm
      _ = (g a â€¢ a : G â†’ L) 1 := by rw [â† a.map_one]; rfl
      _ = (âˆ‘ i âˆˆ insert a s, g i â€¢ i : G â†’ L) 1 := by
        rw [Finset.sum_insert has, Finset.sum_eq_zero, add_zero]
        simp +contextual [h3]
      _ = 0 := by rw [hg]; rfl
  -- Now we're done; the last two facts together imply that `g` vanishes on every element
  -- of `insert a s`.
  exact (Finset.forall_mem_insert ..).2 âŸ¨h4, h3âŸ©
",Formal Proof of Stacks Project Tag 0CKL,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/LinearAlgebra/LinearIndependent/Basic.lean#L486-L548,Q27041,,9.13.1,lemma,3.0,"['0CKK', '09FA', '0ELQ']","\n  Lemma 9.13.1. Let $L$ be a field. Let $G$ be a monoid, for example a group. Let $\\chi _1, \\ldots , \\chi _ n : G \\to L$ be pairwise distinct homomorphisms of monoids where $L$ is regarded as a monoid by multiplication. Then $\\chi _1, \\ldots , \\chi _ n$ are $L$-linearly independent: if $\\lambda _1, \\ldots , \\lambda _ n \\in L$ not all zero, then $\\sum \\lambda _ i\\chi _ i(g) \\not= 0$ for some $g \\in G$. \n\n    \n      Proof.\n      If $n = 1$ this is true because $\\chi _1(e) = 1$ if $e \\in G$ is the neutral (identity) element. We prove the result by induction for $n > 1$. Suppose that $\\lambda _1, \\ldots , \\lambda _ n \\in L$ not all zero. If $\\lambda _ i = 0$ for some, then we win by induction on $n$. Since we want to show that $\\sum \\lambda _ i\\chi _ i(g) \\not= 0$ for some $g \\in G$ we may after dividing by $-\\lambda _ n$ assume that $\\lambda _ n = -1$. Then the only way we get in trouble is if \n    \n      \n  \\[  \\chi _ n(g) = \\sum \\nolimits _{i = 1, \\ldots , n - 1} \\lambda _ i\\chi _ i(g)  \\]\n\n    \n       for all $g \\in G$. Fix $h \\in G$. Then we would also get \n    \n      \n  \\begin{align*}  \\chi _ n(h)\\chi _ n(g) &  = \\chi _ n(hg) \\\\ &  = \\sum \\nolimits _{i = 1, \\ldots , n - 1} \\lambda _ i\\chi _ i(hg) \\\\ &  = \\sum \\nolimits _{i = 1, \\ldots , n - 1} \\lambda _ i\\chi _ i(h) \\chi _ i(g) \\end{align*}\n\n    \n       Multiplying the previous relation by $\\chi _ n(h)$ and subtracting we obtain \n    \n      \n  \\[  0 = \\sum \\nolimits _{i = 1, \\ldots , n - 1} \\lambda _ i (\\chi _ n(h) - \\chi _ i(h)) \\chi _ i(g)  \\]\n\n    \n       for all $g \\in G$. Since $\\lambda _ i \\not= 0$ we conclude that $\\chi _ n(h) = \\chi _ i(h)$ for all $i$ by induction. The choice of $h$ above was arbitrary, so we conclude that $\\chi _ i = \\chi _ n$ for $i \\leq n - 1$ which contradicts the assumption that our characters $\\chi _ i$ are pairwise distinct. \n      $\\square$\n    \n","\n  Lemma 9.13.1. Let $L$ be a field. Let $G$ be a monoid, for example a group. Let $\\chi _1, \\ldots , \\chi _ n : G \\to L$ be pairwise distinct homomorphisms of monoids where $L$ is regarded as a monoid by multiplication. Then $\\chi _1, \\ldots , \\chi _ n$ are $L$-linearly independent: if $\\lambda _1, \\ldots , \\lambda _ n \\in L$ not all zero, then $\\sum \\lambda _ i\\chi _ i(g) \\not= 0$ for some $g \\in G$. \n\n    \n","Proof.\n      If $n = 1$ this is true because $\\chi _1(e) = 1$ if $e \\in G$ is the neutral (identity) element. We prove the result by induction for $n > 1$. Suppose that $\\lambda _1, \\ldots , \\lambda _ n \\in L$ not all zero. If $\\lambda _ i = 0$ for some, then we win by induction on $n$. Since we want to show that $\\sum \\lambda _ i\\chi _ i(g) \\not= 0$ for some $g \\in G$ we may after dividing by $-\\lambda _ n$ assume that $\\lambda _ n = -1$. Then the only way we get in trouble is if \n    \n      \n  \\[  \\chi _ n(g) = \\sum \\nolimits _{i = 1, \\ldots , n - 1} \\lambda _ i\\chi _ i(g)  \\]\n\n    \n       for all $g \\in G$. Fix $h \\in G$. Then we would also get \n    \n      \n  \\begin{align*}  \\chi _ n(h)\\chi _ n(g) &  = \\chi _ n(hg) \\\\ &  = \\sum \\nolimits _{i = 1, \\ldots , n - 1} \\lambda _ i\\chi _ i(hg) \\\\ &  = \\sum \\nolimits _{i = 1, \\ldots , n - 1} \\lambda _ i\\chi _ i(h) \\chi _ i(g) \\end{align*}\n\n    \n       Multiplying the previous relation by $\\chi _ n(h)$ and subtracting we obtain \n    \n      \n  \\[  0 = \\sum \\nolimits _{i = 1, \\ldots , n - 1} \\lambda _ i (\\chi _ n(h) - \\chi _ i(h)) \\chi _ i(g)  \\]\n\n    \n       for all $g \\in G$. Since $\\lambda _ i \\not= 0$ we conclude that $\\chi _ n(h) = \\chi _ i(h)$ for all $i$ by induction. The choice of $h$ above was arbitrary, so we conclude that $\\chi _ i = \\chi _ n$ for $i \\leq n - 1$ which contradicts the assumption that our characters $\\chi _ i$ are pairwise distinct. \n      $\\square$\n    \n"," G â†’ L) (fun f => f : (G â†’* L) â†’ G â†’ L) := by
  letI := Classical.decEq (G â†’* L)
  letI : MulAction L L := DistribMulAction.toMulAction
  -- We prove linear independence by showing that only the trivial linear combination vanishes.
  apply linearIndependent_iff'.2
  intro s
  induction s using Finset.induction_on with
  | empty => simp
  | insert a s has ih =>
  intro g hg
  -- Here
  -- * `a` is a new character we will insert into the `Finset` of characters `s`,
  -- * `ih` is the fact that only the trivial linear combination of characters in `s` is zero
  -- * `hg` is the fact that `g` are the coefficients of a linear combination summing to zero
  -- and it remains to prove that `g` vanishes on `insert a s`.
  -- We now make the key calculation:
  -- For any character `i` in the original `Finset`, we have `g i â€¢ i = g i â€¢ a` as functions
  -- on the monoid `G`.
  have h1 (i) (his : i âˆˆ s) : (g i â€¢ i : G â†’ L) = g i â€¢ a := by
    ext x
    rw [â† sub_eq_zero]
    apply ih (fun j => g j * j x - g j * a x) _ i his
    ext y
    -- After that, it's just a chase scene.
    calc
      (âˆ‘ i âˆˆ s, (g i * i x - g i * a x) â€¢ i : G â†’ L) y =
          (âˆ‘ i âˆˆ s, g i * i x * i y) - âˆ‘ i âˆˆ s, g i * a x * i y := by simp [sub_mul]
      _ = (âˆ‘ i âˆˆ insert a s, g i * i x * i y) -
            âˆ‘ i âˆˆ insert a s, g i * a x * i y := by simp [Finset.sum_insert has]
      _ = (âˆ‘ i âˆˆ insert a s, g i * (i x * i y)) -
            âˆ‘ i âˆˆ insert a s, a x * (g i * i y) := by
        congrm âˆ‘ i âˆˆ insert a s, ?_ - âˆ‘ i âˆˆ insert a s, ?_
        Â· rw [mul_assoc]
        Â· rw [mul_assoc, mul_left_comm]
      _ = (âˆ‘ i âˆˆ insert a s, g i â€¢ i : G â†’ L) (x * y) -
            a x * (âˆ‘ i âˆˆ insert a s, (g i â€¢ (i : G â†’ L))) y := by simp [Finset.mul_sum]
      _ = 0 := by rw [hg]; simp
  -- On the other hand, since `a` is not already in `s`, for any character `i âˆˆ s`
  -- there is some element of the monoid on which it differs from `a`.
  have h2 (i) (his : i âˆˆ s) : âˆƒ y, i y â‰  a y := by
    by_contra! hia
    obtain rfl : i = a := MonoidHom.ext hia
    contradiction
  -- From these two facts we deduce that `g` actually vanishes on `s`,
  have h3 (i) (his : i âˆˆ s) : g i = 0 := by
    let âŸ¨y, hyâŸ© := h2 i his
    have h : g i â€¢ i y = g i â€¢ a y := congr_fun (h1 i his) y
    rw [â† sub_eq_zero, â† smul_sub, smul_eq_zero] at h
    exact h.resolve_right (sub_ne_zero_of_ne hy)
  -- And so, using the fact that the linear combination over `s` and over `insert a s` both
  -- vanish, we deduce that `g a = 0`.
  have h4 : g a = 0 :=
    calc
      g a = g a * 1 := (mul_one _).symm
      _ = (g a â€¢ a : G â†’ L) 1 := by rw [â† a.map_one]; rfl
      _ = (âˆ‘ i âˆˆ insert a s, g i â€¢ i : G â†’ L) 1 := by
        rw [Finset.sum_insert has, Finset.sum_eq_zero, add_zero]
        simp +contextual [h3]
      _ = 0 := by rw [hg]; rfl
  -- Now we're done; the last two facts together imply that `g` vanishes on every element
  -- of `insert a s`.
  exact (Finset.forall_mem_insert ..).2 âŸ¨h4, h3âŸ©
","theorem linearIndependent_monoidHom (G : Type*) [MulOneClass G] (L : Type*) [CommRing L]
    [IsDomain L] : LinearIndependent L (M ","Proof.\n      If $n = 1$ this is true because $\\chi _1(e) = 1$ if $e \\in G$ is the neutral (identity) element. We prove the result by induction for $n > 1$. Suppose that $\\lambda _1, \\ldots , \\lambda _ n \\in L$ not all zero. If $\\lambda _ i = 0$ for some, then we win by induction on $n$. Since we want to show that $\\sum \\lambda _ i\\chi _ i(g) \\not= 0$ for some $g \\in G$ we may after dividing by $-\\lambda _ n$ assume that $\\lambda _ n = -1$. Then the only way we get in trouble is if \n    \n      \n  \\[  \\chi _ n(g) = \\sum \\nolimits _{i = 1, \\ldots , n - 1} \\lambda _ i\\chi _ i(g)  \\]\n\n    \n       for all $g \\in G$. Fix $h \\in G$. Then we would also get \n    \n      \n  \\begin{align*}  \\chi _ n(h)\\chi _ n(g) &  = \\chi _ n(hg) \\\\ &  = \\sum \\nolimits _{i = 1, \\ldots , n - 1} \\lambda _ i\\chi _ i(hg) \\\\ &  = \\sum \\nolimits _{i = 1, \\ldots , n - 1} \\lambda _ i\\chi _ i(h) \\chi _ i(g) \\end{align*}\n\n    \n       Multiplying the previous relation by $\\chi _ n(h)$ and subtracting we obtain \n    \n      \n  \\[  0 = \\sum \\nolimits _{i = 1, \\ldots , n - 1} \\lambda _ i (\\chi _ n(h) - \\chi _ i(h)) \\chi _ i(g)  \\]\n\n    \n       for all $g \\in G$. Since $\\lambda _ i \\not= 0$ we conclude that $\\chi _ n(h) = \\chi _ i(h)$ for all $i$ by induction. The choice of $h$ above was arbitrary, so we conclude that $\\chi _ i = \\chi _ n$ for $i \\leq n - 1$ which contradicts the assumption that our characters $\\chi _ i$ are pairwise distinct. \n      $\\square$\n    \n"
219,0CKM,"lemma linearIndependent_algHom_toLinearMap
    (K M L) [CommSemiring K] [Semiring M] [Algebra K M] [CommRing L] [IsDomain L] [Algebra K L] :
    LinearIndependent L (AlgHom.toLinearMap : (M â†’â‚[K] L) â†’ M â†’â‚—[K] L) := by
  apply LinearIndependent.of_comp (LinearMap.ltoFun K M L L)
  exact (linearIndependent_monoidHom M L).comp
    (RingHom.toMonoidHom âˆ˜ AlgHom.toRingHom)
    (fun _ _ e â†¦ AlgHom.ext (DFunLike.congr_fun e :))
",Formal Proof of Stacks Project Tag 0CKM,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/LinearAlgebra/LinearIndependent/Lemmas.lean#L469-L475,Q27041,,9.13.3,lemma,3.0,"['0CKK', '09FA', '0ELQ']","\n  Lemma 9.13.3. Let $K/F$ and $L/F$ be field extensions. Let $\\sigma _1, \\ldots , \\sigma _ n : K \\to L$ be pairwise distinct morphisms of $F$-extensions. Then $\\sigma _1, \\ldots , \\sigma _ n$ are $L$-linearly independent: if $\\lambda _1, \\ldots , \\lambda _ n \\in L$ not all zero, then $\\sum \\lambda _ i\\sigma _ i(\\alpha ) \\not= 0$ for some $\\alpha \\in K$. \n\n    \n      Proof.\n      Apply Lemma 9.13.1 to the restrictions of $\\sigma _ i$ to the groups of units. \n      $\\square$\n    \n","\n  Lemma 9.13.3. Let $K/F$ and $L/F$ be field extensions. Let $\\sigma _1, \\ldots , \\sigma _ n : K \\to L$ be pairwise distinct morphisms of $F$-extensions. Then $\\sigma _1, \\ldots , \\sigma _ n$ are $L$-linearly independent: if $\\lambda _1, \\ldots , \\lambda _ n \\in L$ not all zero, then $\\sum \\lambda _ i\\sigma _ i(\\alpha ) \\not= 0$ for some $\\alpha \\in K$. \n\n    \n",Proof.\n      Apply Lemma 9.13.1 to the restrictions of $\\sigma _ i$ to the groups of units. \n      $\\square$\n    \n," by
  apply LinearIndependent.of_comp (LinearMap.ltoFun K M L L)
  exact (linearIndependent_monoidHom M L).comp
    (RingHom.toMonoidHom âˆ˜ AlgHom.toRingHom)
    (fun _ _ e â†¦ AlgHom.ext (DFunLike.congr_fun e :))
","lemma linearIndependent_algHom_toLinearMap
    (K M L) [CommSemiring K] [Semiring M] [Algebra K M] [CommRing L] [IsDomain L] [Algebra K L] :
    LinearIndependent L (AlgHom.toLinearMap : (M â†’â‚[K] L) â†’ M â†’â‚—[K] L) ","Proof.\n      Apply Lemma 9.13.1 [[\n  Lemma 9.13.1. Let $L$ be a field. Let $G$ be a monoid, for example a group. Let $\\chi _1, \\ldots , \\chi _ n : G \\to L$ be pairwise distinct homomorphisms of monoids where $L$ is regarded as a monoid by multiplication. Then $\\chi _1, \\ldots , \\chi _ n$ are $L$-linearly independent: if $\\lambda _1, \\ldots , \\lambda _ n \\in L$ not all zero, then $\\sum \\lambda _ i\\chi _ i(g) \\not= 0$ for some $g \\in G$. \n\n    \n]] to the restrictions of $\\sigma _ i$ to the groups of units. \n      $\\square$\n    \n"
220,09GA,"class NumberField (K : Type*) [Field K] : Prop where
  [to_charZero : CharZero K]
  [to_finiteDimensional : FiniteDimensional â„š K]
",Formal Proof of Stacks Project Tag 09GA,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/NumberTheory/NumberField/Basic.lean#L43-L45,Q27041,,9.7.8,definition,3.0,"['09G2', '09FA', '0ELQ']",\n  Definition 9.7.8. A field $K$ is said to be a number field if it has characteristic $0$ and the extension $K/\\mathbf{Q}$ is finite. \n,\n  Definition 9.7.8. A field $K$ is said to be a number field if it has characteristic $0$ and the extension $K/\\mathbf{Q}$ is finite. \n,,,"class NumberField (K : Type*) [Field K] : Prop where
  [to_charZero : CharZero K]
  [to_finiteDimensional : FiniteDimensional â„š K]
",
221,09FX,"instance [CommSemiring S] [Algebra S R] : Algebra S (AdjoinRoot f) :=
  Ideal.Quotient.algebra S
",Formal Proof of Stacks Project Tag 09FX,second part,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/AdjoinRoot.lean#L133-L134,Q27041,,9.6.4,example,3.0,"['09FT', '09FA', '0ELQ']","\n  Example 9.6.4. Let $k$ be a field, and $P \\in k[x]$ an irreducible polynomial. We have seen that $k[x]/(P)$ is a field (Example 9.3.3). Since it is also a $k$-algebra in the obvious way, it is an extension of $k$. \n","\n  Example 9.6.4. Let $k$ be a field, and $P \\in k[x]$ an irreducible polynomial. We have seen that $k[x]/(P)$ is a field (Example 9.3.3). Since it is also a $k$-algebra in the obvious way, it is an extension of $k$. \n",,"
  Ideal.Quotient.algebra S
",instance [CommSemiring S] [Algebra S R] : Algebra S (AdjoinRoot f) ,
222,09FX,"noncomputable instance instField [Fact (Irreducible f)] : Field (AdjoinRoot f) where
  __ := instCommRing _
  __ := instGroupWithZero
  nnqsmul := (Â· â€¢ Â·)
  qsmul := (Â· â€¢ Â·)
  nnratCast_def q := by
    rw [â† map_natCast (of f), â† map_natCast (of f), â† map_divâ‚€, â† NNRat.cast_def]; rfl
  ratCast_def q := by
    rw [â† map_natCast (of f), â† map_intCast (of f), â† map_divâ‚€, â† Rat.cast_def]; rfl
  nnqsmul_def q x :=
    AdjoinRoot.induction_on f (C := fun y â†¦ q â€¢ y = (of f) q * y) x fun p â†¦ by
      simp only [smul_mk, of, RingHom.comp_apply, â† (mk f).map_mul, Polynomial.nnqsmul_eq_C_mul]
  qsmul_def q x :=
    -- Porting note: I gave the explicit motive and changed `rw` to `simp`.
    AdjoinRoot.induction_on f (C := fun y â†¦ q â€¢ y = (of f) q * y) x fun p â†¦ by
      simp only [smul_mk, of, RingHom.comp_apply, â† (mk f).map_mul, Polynomial.qsmul_eq_C_mul]
",Formal Proof of Stacks Project Tag 09FX,"first part, see also 09FI",https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/AdjoinRoot.lean#L556-L571,Q27041,,9.6.4,example,3.0,"['09FT', '09FA', '0ELQ']","\n  Example 9.6.4. Let $k$ be a field, and $P \\in k[x]$ an irreducible polynomial. We have seen that $k[x]/(P)$ is a field (Example 9.3.3). Since it is also a $k$-algebra in the obvious way, it is an extension of $k$. \n","\n  Example 9.6.4. Let $k$ be a field, and $P \\in k[x]$ an irreducible polynomial. We have seen that $k[x]/(P)$ is a field (Example 9.3.3). Since it is also a $k$-algebra in the obvious way, it is an extension of $k$. \n",," instCommRing _
  __ := instGroupWithZero
  nnqsmul := (Â· â€¢ Â·)
  qsmul := (Â· â€¢ Â·)
  nnratCast_def q := by
    rw [â† map_natCast (of f), â† map_natCast (of f), â† map_divâ‚€, â† NNRat.cast_def]; rfl
  ratCast_def q := by
    rw [â† map_natCast (of f), â† map_intCast (of f), â† map_divâ‚€, â† Rat.cast_def]; rfl
  nnqsmul_def q x :=
    AdjoinRoot.induction_on f (C := fun y â†¦ q â€¢ y = (of f) q * y) x fun p â†¦ by
      simp only [smul_mk, of, RingHom.comp_apply, â† (mk f).map_mul, Polynomial.nnqsmul_eq_C_mul]
  qsmul_def q x :=
    -- Porting note: I gave the explicit motive and changed `rw` to `simp`.
    AdjoinRoot.induction_on f (C := fun y â†¦ q â€¢ y = (of f) q * y) x fun p â†¦ by
      simp only [smul_mk, of, RingHom.comp_apply, â† (mk f).map_mul, Polynomial.qsmul_eq_C_mul]
","noncomputable instance instField [Fact (Irreducible f)] : Field (AdjoinRoot f) where
  __ ",
223,0561,"theorem of_restrict_scalars_finitePresentation [Algebra A B] [IsScalarTower R A B]
    [FinitePresentation.{wâ‚, wâ‚ƒ} R B] [FiniteType R A] :
    FinitePresentation.{wâ‚‚, wâ‚ƒ} A B := by
  classical
  obtain âŸ¨n, f, hf, s, hsâŸ© := FinitePresentation.out (R := R) (A := B)
  letI RX := MvPolynomial (Fin n) R
  letI AX := MvPolynomial (Fin n) A
  refine âŸ¨n, MvPolynomial.aeval (f âˆ˜ X), ?_, ?_âŸ©
  Â· rw [â† AlgHom.range_eq_top, â† Algebra.adjoin_range_eq_range_aeval,
      Set.range_comp f MvPolynomial.X, eq_top_iff, â† @adjoin_adjoin_of_tower R A B,
      adjoin_image, adjoin_range_X, Algebra.map_top, (AlgHom.range_eq_top _).mpr hf]
    exact fun {x} => subset_adjoin âŸ¨âŸ©
  Â· obtain âŸ¨t, htâŸ© := FiniteType.out (R := R) (A := A)
    have := fun i : t => hf (algebraMap A B i)
    choose t' ht' using this
    have ht'' : Algebra.adjoin R (algebraMap A AX '' t âˆª Set.range (X : _ â†’ AX)) = âŠ¤ := by
      rw [adjoin_union_eq_adjoin_adjoin, â† Subalgebra.restrictScalars_top R (A := AX)
        (S := { x // x âˆˆ adjoin R ((algebraMap A AX) '' t) })]
      refine congrArg (Subalgebra.restrictScalars R) ?_
      rw [adjoin_algebraMap, ht]
      apply Subalgebra.restrictScalars_injective R
      rw [â† adjoin_restrictScalars, adjoin_range_X, Subalgebra.restrictScalars_top,
        Subalgebra.restrictScalars_top]
    letI g : t â†’ AX := fun x => MvPolynomial.C (x : A) - map (algebraMap R A) (t' x)
    refine âŸ¨s.image (map (algebraMap R A)) âˆª t.attach.image g, ?_âŸ©
    rw [Finset.coe_union, Finset.coe_image, Finset.coe_image, Finset.attach_eq_univ,
      Finset.coe_univ, Set.image_univ]
    let sâ‚€ := (MvPolynomial.map (algebraMap R A)) '' s âˆª Set.range g
    let I := RingHom.ker (MvPolynomial.aeval (R := A) (f âˆ˜ MvPolynomial.X))
    change Ideal.span sâ‚€ = I
    have leI : Ideal.span ((MvPolynomial.map (algebraMap R A)) '' s âˆª Set.range g) â‰¤
      RingHom.ker (MvPolynomial.aeval (R := A) (f âˆ˜ MvPolynomial.X)) := by
      rw [Ideal.span_le]
      rintro _ (âŸ¨x, hx, rflâŸ© | âŸ¨âŸ¨x, hxâŸ©, rflâŸ©) <;>
      rw [SetLike.mem_coe, RingHom.mem_ker]
      Â· rw [MvPolynomial.aeval_map_algebraMap (R := R) (A := A), â† aeval_unique]
        have := Ideal.subset_span hx
        rwa [hs] at this
      Â· rw [map_sub, MvPolynomial.aeval_map_algebraMap, â† aeval_unique,
          MvPolynomial.aeval_C, ht', Subtype.coe_mk, sub_self]
    apply leI.antisymm
    intro x hx
    rw [RingHom.mem_ker] at hx
    let sâ‚€ := (MvPolynomial.map (algebraMap R A)) '' â†‘s âˆª Set.range g
    change x âˆˆ Ideal.span sâ‚€
    have : x âˆˆ (MvPolynomial.map (algebraMap R A) : _ â†’+* AX).range.toAddSubmonoid âŠ”
      (Ideal.span sâ‚€).toAddSubmonoid := by
      have : x âˆˆ (âŠ¤ : Subalgebra R AX) := trivial
      rw [â† ht''] at this
      refine adjoin_induction ?_ ?_ ?_ ?_ this
      Â· rintro _ (âŸ¨x, hx, rflâŸ© | âŸ¨i, rflâŸ©)
        Â· rw [MvPolynomial.algebraMap_eq, â† sub_add_cancel (MvPolynomial.C x)
            (map (algebraMap R A) (t' âŸ¨x, hxâŸ©)), add_comm]
          apply AddSubmonoid.add_mem_sup
          Â· exact Set.mem_range_self _
          Â· apply Ideal.subset_span
            apply Set.mem_union_right
            exact Set.mem_range_self _
        Â· apply AddSubmonoid.mem_sup_left
          exact âŸ¨X i, map_X _ _âŸ©
      Â· intro r
        apply AddSubmonoid.mem_sup_left
        exact âŸ¨C r, map_C _ _âŸ©
      Â· intro _ _ _ _ hâ‚ hâ‚‚
        exact add_mem hâ‚ hâ‚‚
      Â· intro xâ‚ xâ‚‚ _ _ hâ‚ hâ‚‚
        obtain âŸ¨_, âŸ¨pâ‚, rflâŸ©, qâ‚, hqâ‚, rflâŸ© := AddSubmonoid.mem_sup.mp hâ‚
        obtain âŸ¨_, âŸ¨pâ‚‚, rflâŸ©, qâ‚‚, hqâ‚‚, rflâŸ© := AddSubmonoid.mem_sup.mp hâ‚‚
        rw [add_mul, mul_add, add_assoc, â† map_mul]
        apply AddSubmonoid.add_mem_sup
        Â· exact Set.mem_range_self _
        Â· refine add_mem (Ideal.mul_mem_left _ _ hqâ‚‚) (Ideal.mul_mem_right _ _ hqâ‚)
    obtain âŸ¨_, âŸ¨p, rflâŸ©, q, hq, rflâŸ© := AddSubmonoid.mem_sup.mp this
    rw [map_add, aeval_map_algebraMap, â† aeval_unique, show MvPolynomial.aeval (f âˆ˜ X) q = 0
      from leI hq, add_zero] at hx
    suffices Ideal.span (s : Set RX) â‰¤ (Ideal.span sâ‚€).comap (MvPolynomial.map <| algebraMap R A) by
      refine add_mem ?_ hq
      rw [hs] at this
      exact this hx
    rw [Ideal.span_le]
    intro x hx
    apply Ideal.subset_span
    apply Set.mem_union_left
    exact Set.mem_image_of_mem _ hx
",Formal Proof of Stacks Project Tag 0561,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/FinitePresentation.lean#L210-L293,Q27041,,10.6.4,lemma,3.0,"['00F2', '00AO', '0ELQ']","\n  Lemma 10.6.4. Let $R \\to S$ be a ring map. Let $M$ be an $S$-module. Assume $R \\to S$ is of finite type and $M$ is finitely presented as an $R$-module. Then $M$ is finitely presented as an $S$-module. \n\n    \n      Proof.\n      This is similar to the proof of part (4) of Lemma 10.6.2. We may assume $S = R[x_1, \\ldots , x_ n]/J$. Choose $y_1, \\ldots , y_ m \\in M$ which generate $M$ as an $R$-module and choose relations $\\sum a_{ij} y_ j = 0$, $i = 1, \\ldots , t$ which generate the kernel of $R^{\\oplus m} \\to M$. For any $i = 1, \\ldots , n$ and $j = 1, \\ldots , m$ write \n    \n      \n  \\[  x_ i y_ j = \\sum a_{ijk} y_ k  \\]\n\n    \n       for some $a_{ijk} \\in R$. Consider the $S$-module $N$ generated by $y_1, \\ldots , y_ m$ subject to the relations $\\sum a_{ij} y_ j = 0$, $i = 1, \\ldots , t$ and $x_ i y_ j = \\sum a_{ijk} y_ k$, $i = 1, \\ldots , n$ and $j = 1, \\ldots , m$. Then $N$ has a presentation \n    \n      \n  \\[  S^{\\oplus nm + t} \\longrightarrow S^{\\oplus m} \\longrightarrow N \\longrightarrow 0  \\]\n\n    \n       By construction there is a surjective map $\\varphi : N \\to M$. To finish the proof we show $\\varphi $ is injective. Suppose $z = \\sum b_ j y_ j \\in N$ for some $b_ j \\in S$. We may think of $b_ j$ as a polynomial in $x_1, \\ldots , x_ n$ with coefficients in $R$. By applying the relations of the form $x_ i y_ j = \\sum a_{ijk} y_ k$ we can inductively lower the degree of the polynomials. Hence we see that $z = \\sum c_ j y_ j$ for some $c_ j \\in R$. Hence if $\\varphi (z) = 0$ then the vector $(c_1, \\ldots , c_ m)$ is an $R$-linear combination of the vectors $(a_{i1}, \\ldots , a_{im})$ and we conclude that $z = 0$ as desired. \n      $\\square$\n    \n",\n  Lemma 10.6.4. Let $R \\to S$ be a ring map. Let $M$ be an $S$-module. Assume $R \\to S$ is of finite type and $M$ is finitely presented as an $R$-module. Then $M$ is finitely presented as an $S$-module. \n\n    \n,"Proof.\n      This is similar to the proof of part (4) of Lemma 10.6.2. We may assume $S = R[x_1, \\ldots , x_ n]/J$. Choose $y_1, \\ldots , y_ m \\in M$ which generate $M$ as an $R$-module and choose relations $\\sum a_{ij} y_ j = 0$, $i = 1, \\ldots , t$ which generate the kernel of $R^{\\oplus m} \\to M$. For any $i = 1, \\ldots , n$ and $j = 1, \\ldots , m$ write \n    \n      \n  \\[  x_ i y_ j = \\sum a_{ijk} y_ k  \\]\n\n    \n       for some $a_{ijk} \\in R$. Consider the $S$-module $N$ generated by $y_1, \\ldots , y_ m$ subject to the relations $\\sum a_{ij} y_ j = 0$, $i = 1, \\ldots , t$ and $x_ i y_ j = \\sum a_{ijk} y_ k$, $i = 1, \\ldots , n$ and $j = 1, \\ldots , m$. Then $N$ has a presentation \n    \n      \n  \\[  S^{\\oplus nm + t} \\longrightarrow S^{\\oplus m} \\longrightarrow N \\longrightarrow 0  \\]\n\n    \n       By construction there is a surjective map $\\varphi : N \\to M$. To finish the proof we show $\\varphi $ is injective. Suppose $z = \\sum b_ j y_ j \\in N$ for some $b_ j \\in S$. We may think of $b_ j$ as a polynomial in $x_1, \\ldots , x_ n$ with coefficients in $R$. By applying the relations of the form $x_ i y_ j = \\sum a_{ijk} y_ k$ we can inductively lower the degree of the polynomials. Hence we see that $z = \\sum c_ j y_ j$ for some $c_ j \\in R$. Hence if $\\varphi (z) = 0$ then the vector $(c_1, \\ldots , c_ m)$ is an $R$-linear combination of the vectors $(a_{i1}, \\ldots , a_{im})$ and we conclude that $z = 0$ as desired. \n      $\\square$\n    \n"," by
  classical
  obtain âŸ¨n, f, hf, s, hsâŸ© := FinitePresentation.out (R := R) (A := B)
  letI RX := MvPolynomial (Fin n) R
  letI AX := MvPolynomial (Fin n) A
  refine âŸ¨n, MvPolynomial.aeval (f âˆ˜ X), ?_, ?_âŸ©
  Â· rw [â† AlgHom.range_eq_top, â† Algebra.adjoin_range_eq_range_aeval,
      Set.range_comp f MvPolynomial.X, eq_top_iff, â† @adjoin_adjoin_of_tower R A B,
      adjoin_image, adjoin_range_X, Algebra.map_top, (AlgHom.range_eq_top _).mpr hf]
    exact fun {x} => subset_adjoin âŸ¨âŸ©
  Â· obtain âŸ¨t, htâŸ© := FiniteType.out (R := R) (A := A)
    have := fun i : t => hf (algebraMap A B i)
    choose t' ht' using this
    have ht'' : Algebra.adjoin R (algebraMap A AX '' t âˆª Set.range (X : _ â†’ AX)) = âŠ¤ := by
      rw [adjoin_union_eq_adjoin_adjoin, â† Subalgebra.restrictScalars_top R (A := AX)
        (S := { x // x âˆˆ adjoin R ((algebraMap A AX) '' t) })]
      refine congrArg (Subalgebra.restrictScalars R) ?_
      rw [adjoin_algebraMap, ht]
      apply Subalgebra.restrictScalars_injective R
      rw [â† adjoin_restrictScalars, adjoin_range_X, Subalgebra.restrictScalars_top,
        Subalgebra.restrictScalars_top]
    letI g : t â†’ AX := fun x => MvPolynomial.C (x : A) - map (algebraMap R A) (t' x)
    refine âŸ¨s.image (map (algebraMap R A)) âˆª t.attach.image g, ?_âŸ©
    rw [Finset.coe_union, Finset.coe_image, Finset.coe_image, Finset.attach_eq_univ,
      Finset.coe_univ, Set.image_univ]
    let sâ‚€ := (MvPolynomial.map (algebraMap R A)) '' s âˆª Set.range g
    let I := RingHom.ker (MvPolynomial.aeval (R := A) (f âˆ˜ MvPolynomial.X))
    change Ideal.span sâ‚€ = I
    have leI : Ideal.span ((MvPolynomial.map (algebraMap R A)) '' s âˆª Set.range g) â‰¤
      RingHom.ker (MvPolynomial.aeval (R := A) (f âˆ˜ MvPolynomial.X)) := by
      rw [Ideal.span_le]
      rintro _ (âŸ¨x, hx, rflâŸ© | âŸ¨âŸ¨x, hxâŸ©, rflâŸ©) <;>
      rw [SetLike.mem_coe, RingHom.mem_ker]
      Â· rw [MvPolynomial.aeval_map_algebraMap (R := R) (A := A), â† aeval_unique]
        have := Ideal.subset_span hx
        rwa [hs] at this
      Â· rw [map_sub, MvPolynomial.aeval_map_algebraMap, â† aeval_unique,
          MvPolynomial.aeval_C, ht', Subtype.coe_mk, sub_self]
    apply leI.antisymm
    intro x hx
    rw [RingHom.mem_ker] at hx
    let sâ‚€ := (MvPolynomial.map (algebraMap R A)) '' â†‘s âˆª Set.range g
    change x âˆˆ Ideal.span sâ‚€
    have : x âˆˆ (MvPolynomial.map (algebraMap R A) : _ â†’+* AX).range.toAddSubmonoid âŠ”
      (Ideal.span sâ‚€).toAddSubmonoid := by
      have : x âˆˆ (âŠ¤ : Subalgebra R AX) := trivial
      rw [â† ht''] at this
      refine adjoin_induction ?_ ?_ ?_ ?_ this
      Â· rintro _ (âŸ¨x, hx, rflâŸ© | âŸ¨i, rflâŸ©)
        Â· rw [MvPolynomial.algebraMap_eq, â† sub_add_cancel (MvPolynomial.C x)
            (map (algebraMap R A) (t' âŸ¨x, hxâŸ©)), add_comm]
          apply AddSubmonoid.add_mem_sup
          Â· exact Set.mem_range_self _
          Â· apply Ideal.subset_span
            apply Set.mem_union_right
            exact Set.mem_range_self _
        Â· apply AddSubmonoid.mem_sup_left
          exact âŸ¨X i, map_X _ _âŸ©
      Â· intro r
        apply AddSubmonoid.mem_sup_left
        exact âŸ¨C r, map_C _ _âŸ©
      Â· intro _ _ _ _ hâ‚ hâ‚‚
        exact add_mem hâ‚ hâ‚‚
      Â· intro xâ‚ xâ‚‚ _ _ hâ‚ hâ‚‚
        obtain âŸ¨_, âŸ¨pâ‚, rflâŸ©, qâ‚, hqâ‚, rflâŸ© := AddSubmonoid.mem_sup.mp hâ‚
        obtain âŸ¨_, âŸ¨pâ‚‚, rflâŸ©, qâ‚‚, hqâ‚‚, rflâŸ© := AddSubmonoid.mem_sup.mp hâ‚‚
        rw [add_mul, mul_add, add_assoc, â† map_mul]
        apply AddSubmonoid.add_mem_sup
        Â· exact Set.mem_range_self _
        Â· refine add_mem (Ideal.mul_mem_left _ _ hqâ‚‚) (Ideal.mul_mem_right _ _ hqâ‚)
    obtain âŸ¨_, âŸ¨p, rflâŸ©, q, hq, rflâŸ© := AddSubmonoid.mem_sup.mp this
    rw [map_add, aeval_map_algebraMap, â† aeval_unique, show MvPolynomial.aeval (f âˆ˜ X) q = 0
      from leI hq, add_zero] at hx
    suffices Ideal.span (s : Set RX) â‰¤ (Ideal.span sâ‚€).comap (MvPolynomial.map <| algebraMap R A) by
      refine add_mem ?_ hq
      rw [hs] at this
      exact this hx
    rw [Ideal.span_le]
    intro x hx
    apply Ideal.subset_span
    apply Set.mem_union_left
    exact Set.mem_image_of_mem _ hx
","theorem of_restrict_scalars_finitePresentation [Algebra A B] [IsScalarTower R A B]
    [FinitePresentation.{wâ‚, wâ‚ƒ} R B] [FiniteType R A] :
    FinitePresentation.{wâ‚‚, wâ‚ƒ} A B ","Proof.\n      This is similar to the proof of part (4) of Lemma 10.6.2 [[\n  Lemma 10.6.2. The notions finite type and finite presentation have the following permanence properties. \n  \n  \nA composition of ring maps of finite type is of finite type. \n\n\nA composition of ring maps of finite presentation is of finite presentation. \n\n\nGiven $R \\to S\' \\to S$ with $R \\to S$ of finite type, then $S\' \\to S$ is of finite type. \n\n\nGiven $R \\to S\' \\to S$, with $R \\to S$ of finite presentation, and $R \\to S\'$ of finite type, then $S\' \\to S$ is of finite presentation. \n\n\n\n\n    \n]]. We may assume $S = R[x_1, \\ldots , x_ n]/J$. Choose $y_1, \\ldots , y_ m \\in M$ which generate $M$ as an $R$-module and choose relations $\\sum a_{ij} y_ j = 0$, $i = 1, \\ldots , t$ which generate the kernel of $R^{\\oplus m} \\to M$. For any $i = 1, \\ldots , n$ and $j = 1, \\ldots , m$ write \n    \n      \n  \\[  x_ i y_ j = \\sum a_{ijk} y_ k  \\]\n\n    \n       for some $a_{ijk} \\in R$. Consider the $S$-module $N$ generated by $y_1, \\ldots , y_ m$ subject to the relations $\\sum a_{ij} y_ j = 0$, $i = 1, \\ldots , t$ and $x_ i y_ j = \\sum a_{ijk} y_ k$, $i = 1, \\ldots , n$ and $j = 1, \\ldots , m$. Then $N$ has a presentation \n    \n      \n  \\[  S^{\\oplus nm + t} \\longrightarrow S^{\\oplus m} \\longrightarrow N \\longrightarrow 0  \\]\n\n    \n       By construction there is a surjective map $\\varphi : N \\to M$. To finish the proof we show $\\varphi $ is injective. Suppose $z = \\sum b_ j y_ j \\in N$ for some $b_ j \\in S$. We may think of $b_ j$ as a polynomial in $x_1, \\ldots , x_ n$ with coefficients in $R$. By applying the relations of the form $x_ i y_ j = \\sum a_{ijk} y_ k$ we can inductively lower the degree of the polynomials. Hence we see that $z = \\sum c_ j y_ j$ for some $c_ j \\in R$. Hence if $\\varphi (z) = 0$ then the vector $(c_1, \\ldots , c_ m)$ is an $R$-linear combination of the vectors $(a_{i1}, \\ldots , a_{im})$ and we conclude that $z = 0$ as desired. \n      $\\square$\n    \n"
224,089R,"  finite_quotient : Module.Finite R (M â§¸ toSubmodule)
  projective_quotient : Projective R (M â§¸ toSubmodule)
  rankAtStalk_eq : âˆ€ p, rankAtStalk (R := R) (M â§¸ toSubmodule) p = k
",Formal Proof of Stacks Project Tag 089R, structure Grassmannian extends Submodule R M wher,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Grassmannian.lean#L65-L67,Q27041,Grassmannians,27.22,section,2.0,"['01LE', '0ELP']","27.22 Grassmannians\n\n\nIn this section we introduce the standard Grassmannian functors and we show that they are represented by schemes. Pick integers $k$, $n$ with $0 < k < n$. We will construct a functor \n\n\n    27.22.0.1\n  \\begin{equation}  \\label{constructions-equation-gkn} G(k, n) : \\mathit{Sch}\\longrightarrow \\textit{Sets} \\end{equation}\n\n\n which will loosely speaking parametrize $k$-dimensional subspaces of $n$-space. However, for technical reasons it is more convenient to parametrize $(n - k)$-dimensional quotients and this is what we will do. \n\n\nMore precisely, $G(k, n)$ associates to a scheme $S$ the set $G(k, n)(S)$ of isomorphism classes of surjections \n\n\n  \\[  q : \\mathcal{O}_ S^{\\oplus n} \\longrightarrow \\mathcal{Q}  \\]\n\n\n where $\\mathcal{Q}$ is a finite locally free $\\mathcal{O}_ S$-module of rank $n - k$. Note that this is indeed a set, for example by Modules, Lemma 17.9.8 or by the observation that the isomorphism class of the surjection $q$ is determined by the kernel of $q$ (and given a sheaf there is a set of subsheaves). Given a morphism of schemes $f : T \\to S$ we let $G(k, n)(f) : G(k, n)(S) \\to G(k, n)(T)$ which sends the isomorphism class of $q : \\mathcal{O}_ S^{\\oplus n} \\longrightarrow \\mathcal{Q}$ to the isomorphism class of $f^*q : \\mathcal{O}_ T^{\\oplus n} \\longrightarrow f^*\\mathcal{Q}$. This makes sense since (1) $f^*\\mathcal{O}_ S = \\mathcal{O}_ T$, (2) $f^*$ is additive, (3) $f^*$ preserves locally free modules (Modules, Lemma 17.14.3), and (4) $f^*$ is right exact (Modules, Lemma 17.3.3). \n\n\n\n  Lemma 27.22.1. Let $0 < k < n$. The functor $G(k, n)$ of (27.22.0.1) is representable by a scheme. \n \n\n\n    \n      Proof.\n      Set $F = G(k, n)$. To prove the lemma we will use the criterion of Schemes, Lemma 26.15.4. The reason $F$ satisfies the sheaf property for the Zariski topology is that we can glue sheaves, see Sheaves, Section 6.33 (some details omitted). \n    \n      The family of subfunctors $F_ i$. Let $I$ be the set of subsets of $\\{ 1, \\ldots , n\\} $ of cardinality $n - k$. Given a scheme $S$ and $j \\in \\{ 1, \\ldots , n\\} $ we denote $e_ j$ the global section \n    \n      \n  \\[  e_ j = (0, \\ldots , 0, 1, 0, \\ldots , 0)\\quad (1\\text{ in }j\\text{th spot})  \\]\n\n    \n       of $\\mathcal{O}_ S^{\\oplus n}$. Of course these sections freely generate $\\mathcal{O}_ S^{\\oplus n}$. Similarly, for $j \\in \\{ 1, \\ldots , n - k\\} $ we denote $f_ j$ the global section of $\\mathcal{O}_ S^{\\oplus n - k}$ which is zero in all summands except the $j$th where we put a $1$. For $i \\in I$ we let \n    \n      \n  \\[  s_ i : \\mathcal{O}_ S^{\\oplus n - k} \\longrightarrow \\mathcal{O}_ S^{\\oplus n}  \\]\n\n    \n       which is the direct sum of the coprojections $\\mathcal{O}_ S \\to \\mathcal{O}_ S^{\\oplus n}$ corresponding to elements of $I$. More precisely, if $i = \\{ i_1, \\ldots , i_{n - k}\\} $ with $i_1 < i_2 < \\ldots < i_{n - k}$ then $s_ i$ maps $f_ j$ to $e_{i_ j}$ for $j \\in \\{ 1, \\ldots , n - k\\} $. With this notation we can set \n    \n      \n  \\[  F_ i(S) = \\{ q : \\mathcal{O}_ S^{\\oplus n} \\to \\mathcal{Q} \\in F(S) \\mid q \\circ s_ i \\text{ is surjective}\\}  \\subset F(S)  \\]\n\n    \n       Given a morphism $f : T \\to S$ of schemes the pullback $f^*s_ i$ is the corresponding map over $T$. Since $f^*$ is right exact (Modules, Lemma 17.3.3) we conclude that $F_ i$ is a subfunctor of $F$. \n    \n      Representability of $F_ i$. To prove this we may assume (after renumbering) that $i = \\{ 1, \\ldots , n - k\\} $. This means $s_ i$ is the inclusion of the first $n - k$ summands. Observe that if $q \\circ s_ i$ is surjective, then $q \\circ s_ i$ is an isomorphism as a surjective map between finite locally free modules of the same rank (Modules, Lemma 17.14.5). Thus if $q : \\mathcal{O}_ S^{\\oplus n} \\to \\mathcal{Q}$ is an element of $F_ i(S)$, then we can use $q \\circ s_ i$ to identify $\\mathcal{Q}$ with $\\mathcal{O}_ S^{\\oplus n - k}$. After doing so we obtain \n    \n      \n  \\[  q : \\mathcal{O}_ S^{\\oplus n} \\longrightarrow \\mathcal{O}_ S^{\\oplus n - k}  \\]\n\n    \n       mapping $e_ j$ to $f_ j$ (notation as above) for $j = 1, \\ldots , n - k$. To determine $q$ completely we have to fix the images $q(e_{n - k + 1}), \\ldots , q(e_ n)$ in $\\Gamma (S, \\mathcal{O}_ S^{\\oplus n - k})$. It follows that $F_ i$ is isomorphic to the functor \n    \n      \n  \\[  S \\longmapsto \\prod \\nolimits _{j = n - k + 1, \\ldots , n} \\Gamma (S, \\mathcal{O}_ S^{\\oplus n - k})  \\]\n\n    \n       This functor is isomorphic to the $k(n - k)$-fold self product of the functor $S \\mapsto \\Gamma (S, \\mathcal{O}_ S)$. By Schemes, Example 26.15.2 the latter is representable by $\\mathbf{A}^1_\\mathbf {Z}$. It follows $F_ i$ is representable by $\\mathbf{A}^{k(n - k)}_\\mathbf {Z}$ since fibred product over $\\mathop{\\mathrm{Spec}}(\\mathbf{Z})$ is the product in the category of schemes. \n    \n      The inclusion $F_ i \\subset F$ is representable by open immersions. Let $S$ be a scheme and let $q : \\mathcal{O}_ S^{\\oplus n} \\to \\mathcal{Q}$ be an element of $F(S)$. By Modules, Lemma 17.9.4. the set $U_ i = \\{ s \\in S \\mid (q \\circ s_ i)_ s\\text{ surjective}\\} $ is open in $S$. Since $\\mathcal{O}_{S, s}$ is a local ring and $\\mathcal{Q}_ s$ a finite $\\mathcal{O}_{S, s}$-module by Nakayama\'s lemma (Algebra, Lemma 10.20.1) we have \n    \n      \n  \\[  s \\in U_ i \\Leftrightarrow \\left( \\text{the map } \\kappa (s)^{\\oplus n - k} \\to \\mathcal{Q}_ s/\\mathfrak m_ s\\mathcal{Q}_ s \\text{ induced by } (q \\circ s_ i)_ s \\text{ is surjective} \\right)  \\]\n\n    \n       Let $f : T \\to S$ be a morphism of schemes and let $t \\in T$ be a point mapping to $s \\in S$. We have $(f^*\\mathcal{Q})_ t = \\mathcal{Q}_ s \\otimes _{\\mathcal{O}_{S, s}} \\mathcal{O}_{T, t}$ (Sheaves, Lemma 6.26.4) and so on. Thus the map \n    \n      \n  \\[  \\kappa (t)^{\\oplus n - k} \\to (f^*\\mathcal{Q})_ t/\\mathfrak m_ t(f^*\\mathcal{Q})_ t  \\]\n\n    \n       induced by $(f^*q \\circ f^*s_ i)_ t$ is the base change of the map $\\kappa (s)^{\\oplus n - k} \\to \\mathcal{Q}_ s/\\mathfrak m_ s\\mathcal{Q}_ s$ above by the field extension $\\kappa (t)/\\kappa (s)$. It follows that $s \\in U_ i$ if and only if $t$ is in the corresponding open for $f^*q$. In particular $T \\to S$ factors through $U_ i$ if and only if $f^*q \\in F_ i(T)$ as desired. \n    \n      The collection $F_ i$, $i \\in I$ covers $F$. Let $q : \\mathcal{O}_ S^{\\oplus n} \\to \\mathcal{Q}$ be an element of $F(S)$. We have to show that for every point $s$ of $S$ there exists an $i \\in I$ such that $s_ i$ is surjective in a neighbourhood of $s$. Thus we have to show that one of the compositions \n    \n      \n  \\[  \\kappa (s)^{\\oplus n - k} \\xrightarrow {s_ i} \\kappa (s)^{\\oplus n} \\rightarrow \\mathcal{Q}_ s/\\mathfrak m_ s\\mathcal{Q}_ s  \\]\n\n    \n       is surjective (see previous paragraph). As $\\mathcal{Q}_ s/\\mathfrak m_ s\\mathcal{Q}_ s$ is a vector space of dimension $n - k$ this follows from the theory of vector spaces. \n      $\\square$\n    \n\n\n\n  Definition 27.22.2. Let $0 < k < n$. The scheme $\\mathbf{G}(k, n)$ representing the functor $G(k, n)$ is called Grassmannian over $\\mathbf{Z}$. Its base change $\\mathbf{G}(k, n)_ S$ to a scheme $S$ is called Grassmannian over $S$. If $R$ is a ring the base change to $\\mathop{\\mathrm{Spec}}(R)$ is denoted $\\mathbf{G}(k, n)_ R$ and called Grassmannian over $R$. \n \n\n\nThe definition makes sense as we\'ve shown in Lemma 27.22.1 that these functors are indeed representable. \n\n\n\n  Lemma 27.22.3. Let $n \\geq 1$. There is a canonical isomorphism $\\mathbf{G}(n, n + 1) = \\mathbf{P}^ n_\\mathbf {Z}$. \n \n\n\n    \n      Proof.\n      According to Lemma 27.13.1 the scheme $\\mathbf{P}^ n_\\mathbf {Z}$ represents the functor which assigns to a scheme $S$ the set of isomorphisms classes of pairs $(\\mathcal{L}, (s_0, \\ldots , s_ n))$ consisting of an invertible module $\\mathcal{L}$ and an $(n + 1)$-tuple of global sections generating $\\mathcal{L}$. Given such a pair we obtain a quotient \n    \n      \n  \\[  \\mathcal{O}_ S^{\\oplus n + 1} \\longrightarrow \\mathcal{L},\\quad (h_0, \\ldots , h_ n) \\longmapsto \\sum h_ i s_ i.  \\]\n\n    \n       Conversely, given an element $q : \\mathcal{O}_ S^{\\oplus n + 1} \\to \\mathcal{Q}$ of $G(n, n + 1)(S)$ we obtain such a pair, namely $(\\mathcal{Q}, (q(e_1), \\ldots , q(e_{n + 1})))$. Here $e_ i$, $i = 1, \\ldots , n + 1$ are the standard generating sections of the free module $\\mathcal{O}_ S^{\\oplus n + 1}$. We omit the verification that these constructions define mutually inverse transformations of functors. \n      $\\square$\n    \n\n","27.22 Grassmannians\n\n\nIn this section we introduce the standard Grassmannian functors and we show that they are represented by schemes. Pick integers $k$, $n$ with $0 < k < n$. We will construct a functor \n\n\n    27.22.0.1\n  \\begin{equation}  \\label{constructions-equation-gkn} G(k, n) : \\mathit{Sch}\\longrightarrow \\textit{Sets} \\end{equation}\n\n\n which will loosely speaking parametrize $k$-dimensional subspaces of $n$-space. However, for technical reasons it is more convenient to parametrize $(n - k)$-dimensional quotients and this is what we will do. \n\n\nMore precisely, $G(k, n)$ associates to a scheme $S$ the set $G(k, n)(S)$ of isomorphism classes of surjections \n\n\n  \\[  q : \\mathcal{O}_ S^{\\oplus n} \\longrightarrow \\mathcal{Q}  \\]\n\n\n where $\\mathcal{Q}$ is a finite locally free $\\mathcal{O}_ S$-module of rank $n - k$. Note that this is indeed a set, for example by Modules, Lemma 17.9.8 or by the observation that the isomorphism class of the surjection $q$ is determined by the kernel of $q$ (and given a sheaf there is a set of subsheaves). Given a morphism of schemes $f : T \\to S$ we let $G(k, n)(f) : G(k, n)(S) \\to G(k, n)(T)$ which sends the isomorphism class of $q : \\mathcal{O}_ S^{\\oplus n} \\longrightarrow \\mathcal{Q}$ to the isomorphism class of $f^*q : \\mathcal{O}_ T^{\\oplus n} \\longrightarrow f^*\\mathcal{Q}$. This makes sense since (1) $f^*\\mathcal{O}_ S = \\mathcal{O}_ T$, (2) $f^*$ is additive, (3) $f^*$ preserves locally free modules (Modules, Lemma 17.14.3), and (4) $f^*$ is right exact (Modules, Lemma 17.3.3). \n\n\n\n  Lemma 27.22.1. Let $0 < k < n$. The functor $G(k, n)$ of (27.22.0.1) is representable by a scheme. \n \n\n\n    \n","Proof.\n      Set $F = G(k, n)$. To prove the lemma we will use the criterion of Schemes, Lemma 26.15.4. The reason $F$ satisfies the sheaf property for the Zariski topology is that we can glue sheaves, see Sheaves, Section 6.33 (some details omitted). \n    \n      The family of subfunctors $F_ i$. Let $I$ be the set of subsets of $\\{ 1, \\ldots , n\\} $ of cardinality $n - k$. Given a scheme $S$ and $j \\in \\{ 1, \\ldots , n\\} $ we denote $e_ j$ the global section \n    \n      \n  \\[  e_ j = (0, \\ldots , 0, 1, 0, \\ldots , 0)\\quad (1\\text{ in }j\\text{th spot})  \\]\n\n    \n       of $\\mathcal{O}_ S^{\\oplus n}$. Of course these sections freely generate $\\mathcal{O}_ S^{\\oplus n}$. Similarly, for $j \\in \\{ 1, \\ldots , n - k\\} $ we denote $f_ j$ the global section of $\\mathcal{O}_ S^{\\oplus n - k}$ which is zero in all summands except the $j$th where we put a $1$. For $i \\in I$ we let \n    \n      \n  \\[  s_ i : \\mathcal{O}_ S^{\\oplus n - k} \\longrightarrow \\mathcal{O}_ S^{\\oplus n}  \\]\n\n    \n       which is the direct sum of the coprojections $\\mathcal{O}_ S \\to \\mathcal{O}_ S^{\\oplus n}$ corresponding to elements of $I$. More precisely, if $i = \\{ i_1, \\ldots , i_{n - k}\\} $ with $i_1 < i_2 < \\ldots < i_{n - k}$ then $s_ i$ maps $f_ j$ to $e_{i_ j}$ for $j \\in \\{ 1, \\ldots , n - k\\} $. With this notation we can set \n    \n      \n  \\[  F_ i(S) = \\{ q : \\mathcal{O}_ S^{\\oplus n} \\to \\mathcal{Q} \\in F(S) \\mid q \\circ s_ i \\text{ is surjective}\\}  \\subset F(S)  \\]\n\n    \n       Given a morphism $f : T \\to S$ of schemes the pullback $f^*s_ i$ is the corresponding map over $T$. Since $f^*$ is right exact (Modules, Lemma 17.3.3) we conclude that $F_ i$ is a subfunctor of $F$. \n    \n      Representability of $F_ i$. To prove this we may assume (after renumbering) that $i = \\{ 1, \\ldots , n - k\\} $. This means $s_ i$ is the inclusion of the first $n - k$ summands. Observe that if $q \\circ s_ i$ is surjective, then $q \\circ s_ i$ is an isomorphism as a surjective map between finite locally free modules of the same rank (Modules, Lemma 17.14.5). Thus if $q : \\mathcal{O}_ S^{\\oplus n} \\to \\mathcal{Q}$ is an element of $F_ i(S)$, then we can use $q \\circ s_ i$ to identify $\\mathcal{Q}$ with $\\mathcal{O}_ S^{\\oplus n - k}$. After doing so we obtain \n    \n      \n  \\[  q : \\mathcal{O}_ S^{\\oplus n} \\longrightarrow \\mathcal{O}_ S^{\\oplus n - k}  \\]\n\n    \n       mapping $e_ j$ to $f_ j$ (notation as above) for $j = 1, \\ldots , n - k$. To determine $q$ completely we have to fix the images $q(e_{n - k + 1}), \\ldots , q(e_ n)$ in $\\Gamma (S, \\mathcal{O}_ S^{\\oplus n - k})$. It follows that $F_ i$ is isomorphic to the functor \n    \n      \n  \\[  S \\longmapsto \\prod \\nolimits _{j = n - k + 1, \\ldots , n} \\Gamma (S, \\mathcal{O}_ S^{\\oplus n - k})  \\]\n\n    \n       This functor is isomorphic to the $k(n - k)$-fold self product of the functor $S \\mapsto \\Gamma (S, \\mathcal{O}_ S)$. By Schemes, Example 26.15.2 the latter is representable by $\\mathbf{A}^1_\\mathbf {Z}$. It follows $F_ i$ is representable by $\\mathbf{A}^{k(n - k)}_\\mathbf {Z}$ since fibred product over $\\mathop{\\mathrm{Spec}}(\\mathbf{Z})$ is the product in the category of schemes. \n    \n      The inclusion $F_ i \\subset F$ is representable by open immersions. Let $S$ be a scheme and let $q : \\mathcal{O}_ S^{\\oplus n} \\to \\mathcal{Q}$ be an element of $F(S)$. By Modules, Lemma 17.9.4. the set $U_ i = \\{ s \\in S \\mid (q \\circ s_ i)_ s\\text{ surjective}\\} $ is open in $S$. Since $\\mathcal{O}_{S, s}$ is a local ring and $\\mathcal{Q}_ s$ a finite $\\mathcal{O}_{S, s}$-module by Nakayama\'s lemma (Algebra, Lemma 10.20.1) we have \n    \n      \n  \\[  s \\in U_ i \\Leftrightarrow \\left( \\text{the map } \\kappa (s)^{\\oplus n - k} \\to \\mathcal{Q}_ s/\\mathfrak m_ s\\mathcal{Q}_ s \\text{ induced by } (q \\circ s_ i)_ s \\text{ is surjective} \\right)  \\]\n\n    \n       Let $f : T \\to S$ be a morphism of schemes and let $t \\in T$ be a point mapping to $s \\in S$. We have $(f^*\\mathcal{Q})_ t = \\mathcal{Q}_ s \\otimes _{\\mathcal{O}_{S, s}} \\mathcal{O}_{T, t}$ (Sheaves, Lemma 6.26.4) and so on. Thus the map \n    \n      \n  \\[  \\kappa (t)^{\\oplus n - k} \\to (f^*\\mathcal{Q})_ t/\\mathfrak m_ t(f^*\\mathcal{Q})_ t  \\]\n\n    \n       induced by $(f^*q \\circ f^*s_ i)_ t$ is the base change of the map $\\kappa (s)^{\\oplus n - k} \\to \\mathcal{Q}_ s/\\mathfrak m_ s\\mathcal{Q}_ s$ above by the field extension $\\kappa (t)/\\kappa (s)$. It follows that $s \\in U_ i$ if and only if $t$ is in the corresponding open for $f^*q$. In particular $T \\to S$ factors through $U_ i$ if and only if $f^*q \\in F_ i(T)$ as desired. \n    \n      The collection $F_ i$, $i \\in I$ covers $F$. Let $q : \\mathcal{O}_ S^{\\oplus n} \\to \\mathcal{Q}$ be an element of $F(S)$. We have to show that for every point $s$ of $S$ there exists an $i \\in I$ such that $s_ i$ is surjective in a neighbourhood of $s$. Thus we have to show that one of the compositions \n    \n      \n  \\[  \\kappa (s)^{\\oplus n - k} \\xrightarrow {s_ i} \\kappa (s)^{\\oplus n} \\rightarrow \\mathcal{Q}_ s/\\mathfrak m_ s\\mathcal{Q}_ s  \\]\n\n    \n       is surjective (see previous paragraph). As $\\mathcal{Q}_ s/\\mathfrak m_ s\\mathcal{Q}_ s$ is a vector space of dimension $n - k$ this follows from the theory of vector spaces. \n      $\\square$\n    \n\n\n\n  Definition 27.22.2. Let $0 < k < n$. The scheme $\\mathbf{G}(k, n)$ representing the functor $G(k, n)$ is called Grassmannian over $\\mathbf{Z}$. Its base change $\\mathbf{G}(k, n)_ S$ to a scheme $S$ is called Grassmannian over $S$. If $R$ is a ring the base change to $\\mathop{\\mathrm{Spec}}(R)$ is denoted $\\mathbf{G}(k, n)_ R$ and called Grassmannian over $R$. \n \n\n\nThe definition makes sense as we\'ve shown in Lemma 27.22.1 that these functors are indeed representable. \n\n\n\n  Lemma 27.22.3. Let $n \\geq 1$. There is a canonical isomorphism $\\mathbf{G}(n, n + 1) = \\mathbf{P}^ n_\\mathbf {Z}$. \n \n\n\n    \n      Proof.\n      According to Lemma 27.13.1 the scheme $\\mathbf{P}^ n_\\mathbf {Z}$ represents the functor which assigns to a scheme $S$ the set of isomorphisms classes of pairs $(\\mathcal{L}, (s_0, \\ldots , s_ n))$ consisting of an invertible module $\\mathcal{L}$ and an $(n + 1)$-tuple of global sections generating $\\mathcal{L}$. Given such a pair we obtain a quotient \n    \n      \n  \\[  \\mathcal{O}_ S^{\\oplus n + 1} \\longrightarrow \\mathcal{L},\\quad (h_0, \\ldots , h_ n) \\longmapsto \\sum h_ i s_ i.  \\]\n\n    \n       Conversely, given an element $q : \\mathcal{O}_ S^{\\oplus n + 1} \\to \\mathcal{Q}$ of $G(n, n + 1)(S)$ we obtain such a pair, namely $(\\mathcal{Q}, (q(e_1), \\ldots , q(e_{n + 1})))$. Here $e_ i$, $i = 1, \\ldots , n + 1$ are the standard generating sections of the free module $\\mathcal{O}_ S^{\\oplus n + 1}$. We omit the verification that these constructions define mutually inverse transformations of functors. \n      $\\square$\n    \n\n"," R) (M â§¸ toSubmodule) p = k
","  finite_quotient : Module.Finite R (M â§¸ toSubmodule)
  projective_quotient : Projective R (M â§¸ toSubmodule)
  rankAtStalk_eq : âˆ€ p, rankAtStalk (R ","Proof.\n      Set $F = G(k, n)$. To prove the lemma we will use the criterion of Schemes, Lemma 26.15.4 [[\n  Lemma 26.15.4. Let $F$ be a contravariant functor on the category of schemes with values in the category of sets. Suppose that \n  \n  \n$F$ satisfies the sheaf property for the Zariski topology, \n\n\nthere exists a set $I$ and a collection of subfunctors $F_ i \\subset F$ such that \n\n\n  \neach $F_ i$ is representable, \n\n\neach $F_ i \\subset F$ is representable by open immersions, and \n\n\nthe collection $(F_ i)_{i \\in I}$ covers $F$. \n\n\n\n\n\n   Then $F$ is representable. \n\n    \n]]. The reason $F$ satisfies the sheaf property for the Zariski topology is that we can glue sheaves, see Sheaves, Section 6.33 [[6.33 Glueing sheaves\n\n\nIn this section we glue sheaves defined on the members of a covering of $X$. We first deal with maps. \n\n\n\n  Lemma 6.33.1. Let $X$ be a topological space. Let $X = \\bigcup U_ i$ be an open covering. Let $\\mathcal{F}$, $\\mathcal{G}$ be sheaves of sets on $X$. Given a collection \n  \n  \\[  \\varphi _ i : \\mathcal{F}|_{U_ i} \\longrightarrow \\mathcal{G}|_{U_ i}  \\]\n\n   of maps of sheaves such that for all $i, j \\in I$ the maps $\\varphi _ i, \\varphi _ j$ restrict to the same map $\\mathcal{F}|_{U_ i \\cap U_ j} \\to \\mathcal{G}|_{U_ i \\cap U_ j}$ then there exists a unique map of sheaves \n  \n  \\[  \\varphi : \\mathcal{F} \\longrightarrow \\mathcal{G}  \\]\n\n   whose restriction to each $U_ i$ agrees with $\\varphi _ i$. \n \n\n\n    \n]] (some details omitted). \n    \n      The family of subfunctors $F_ i$. Let $I$ be the set of subsets of $\\{ 1, \\ldots , n\\} $ of cardinality $n - k$. Given a scheme $S$ and $j \\in \\{ 1, \\ldots , n\\} $ we denote $e_ j$ the global section \n    \n      \n  \\[  e_ j = (0, \\ldots , 0, 1, 0, \\ldots , 0)\\quad (1\\text{ in }j\\text{th spot})  \\]\n\n    \n       of $\\mathcal{O}_ S^{\\oplus n}$. Of course these sections freely generate $\\mathcal{O}_ S^{\\oplus n}$. Similarly, for $j \\in \\{ 1, \\ldots , n - k\\} $ we denote $f_ j$ the global section of $\\mathcal{O}_ S^{\\oplus n - k}$ which is zero in all summands except the $j$th where we put a $1$. For $i \\in I$ we let \n    \n      \n  \\[  s_ i : \\mathcal{O}_ S^{\\oplus n - k} \\longrightarrow \\mathcal{O}_ S^{\\oplus n}  \\]\n\n    \n       which is the direct sum of the coprojections $\\mathcal{O}_ S \\to \\mathcal{O}_ S^{\\oplus n}$ corresponding to elements of $I$. More precisely, if $i = \\{ i_1, \\ldots , i_{n - k}\\} $ with $i_1 < i_2 < \\ldots < i_{n - k}$ then $s_ i$ maps $f_ j$ to $e_{i_ j}$ for $j \\in \\{ 1, \\ldots , n - k\\} $. With this notation we can set \n    \n      \n  \\[  F_ i(S) = \\{ q : \\mathcal{O}_ S^{\\oplus n} \\to \\mathcal{Q} \\in F(S) \\mid q \\circ s_ i \\text{ is surjective}\\}  \\subset F(S)  \\]\n\n    \n       Given a morphism $f : T \\to S$ of schemes the pullback $f^*s_ i$ is the corresponding map over $T$. Since $f^*$ is right exact (Modules, Lemma 17.3.3 [[\n  Lemma 17.3.3. Let $f : (X, \\mathcal{O}_ X) \\to (Y, \\mathcal{O}_ Y)$ be a morphism of ringed spaces. \n  \n  \nThe functor $f_* : \\textit{Mod}(\\mathcal{O}_ X) \\to \\textit{Mod}(\\mathcal{O}_ Y)$ is left exact. In fact it commutes with all limits. \n\n\nThe functor $f^* : \\textit{Mod}(\\mathcal{O}_ Y) \\to \\textit{Mod}(\\mathcal{O}_ X)$ is right exact. In fact it commutes with all colimits. \n\n\nPullback $f^{-1} : \\textit{Ab}(Y) \\to \\textit{Ab}(X)$ on abelian sheaves is exact. \n\n\n\n\n    \n]]) we conclude that $F_ i$ is a subfunctor of $F$. \n    \n      Representability of $F_ i$. To prove this we may assume (after renumbering) that $i = \\{ 1, \\ldots , n - k\\} $. This means $s_ i$ is the inclusion of the first $n - k$ summands. Observe that if $q \\circ s_ i$ is surjective, then $q \\circ s_ i$ is an isomorphism as a surjective map between finite locally free modules of the same rank (Modules, Lemma 17.14.5 [[\n  Lemma 17.14.5. Let $(X, \\mathcal{O}_ X)$ be a ringed space. Let $r \\geq 0$. Let $\\varphi : \\mathcal{F} \\to \\mathcal{G}$ be a map of finite locally free $\\mathcal{O}_ X$-modules of rank $r$. Then $\\varphi $ is an isomorphism if and only if $\\varphi $ is surjective. \n\n    \n]]). Thus if $q : \\mathcal{O}_ S^{\\oplus n} \\to \\mathcal{Q}$ is an element of $F_ i(S)$, then we can use $q \\circ s_ i$ to identify $\\mathcal{Q}$ with $\\mathcal{O}_ S^{\\oplus n - k}$. After doing so we obtain \n    \n      \n  \\[  q : \\mathcal{O}_ S^{\\oplus n} \\longrightarrow \\mathcal{O}_ S^{\\oplus n - k}  \\]\n\n    \n       mapping $e_ j$ to $f_ j$ (notation as above) for $j = 1, \\ldots , n - k$. To determine $q$ completely we have to fix the images $q(e_{n - k + 1}), \\ldots , q(e_ n)$ in $\\Gamma (S, \\mathcal{O}_ S^{\\oplus n - k})$. It follows that $F_ i$ is isomorphic to the functor \n    \n      \n  \\[  S \\longmapsto \\prod \\nolimits _{j = n - k + 1, \\ldots , n} \\Gamma (S, \\mathcal{O}_ S^{\\oplus n - k})  \\]\n\n    \n       This functor is isomorphic to the $k(n - k)$-fold self product of the functor $S \\mapsto \\Gamma (S, \\mathcal{O}_ S)$. By Schemes, Example 26.15.2 [[\n  Example 26.15.2. Consider the rule which associates to every scheme $T$ the set $F(T) = \\Gamma (T, \\mathcal{O}_ T)$. We can turn this into a contravariant functor by using for a morphism $f : T\' \\to T$ the pullback map $f^\\sharp : \\Gamma (T, \\mathcal{O}_ T) \\to \\Gamma (T\', \\mathcal{O}_{T\'})$. Given a ring $R$ and an element $t \\in R$ there exists a unique ring homomorphism $\\mathbf{Z}[x] \\to R$ which maps $x$ to $t$. Thus, using Lemma 26.6.4, we see that \n  \n  \\[  \\mathop{\\mathrm{Mor}}\\nolimits (T, \\mathop{\\mathrm{Spec}}(\\mathbf{Z}[x])) = \\mathop{\\mathrm{Hom}}\\nolimits (\\mathbf{Z}[x], \\Gamma (T, \\mathcal{O}_ T)) = \\Gamma (T, \\mathcal{O}_ T).  \\]\n\n   This does indeed give an isomorphism $h_{\\mathop{\\mathrm{Spec}}(\\mathbf{Z}[x])} \\to F$. What is the \xe2\x80\x9cuniversal family\xe2\x80\x9d $\\xi $? To get it we have to apply the identifications above to $\\text{id}_{\\mathop{\\mathrm{Spec}}(\\mathbf{Z}[x])}$. Clearly under the identifications above this gives that $\\xi = x \\in \\Gamma (\\mathop{\\mathrm{Spec}}(\\mathbf{Z}[x]), \\mathcal{O}_{\\mathop{\\mathrm{Spec}}(\\mathbf{Z}[x])}) = \\mathbf{Z}[x]$ as expected. \n]] the latter is representable by $\\mathbf{A}^1_\\mathbf {Z}$. It follows $F_ i$ is representable by $\\mathbf{A}^{k(n - k)}_\\mathbf {Z}$ since fibred product over $\\mathop{\\mathrm{Spec}}(\\mathbf{Z})$ is the product in the category of schemes. \n    \n      The inclusion $F_ i \\subset F$ is representable by open immersions. Let $S$ be a scheme and let $q : \\mathcal{O}_ S^{\\oplus n} \\to \\mathcal{Q}$ be an element of $F(S)$. By Modules, Lemma 17.9.4 [[\n  Lemma 17.9.4. Let $X$ be a ringed space. Let $\\varphi : \\mathcal{G} \\to \\mathcal{F}$ be a homomorphism of $\\mathcal{O}_ X$-modules. Let $x \\in X$. Assume $\\mathcal{F}$ of finite type and the map on stalks $\\varphi _ x : \\mathcal{G}_ x \\to \\mathcal{F}_ x$ surjective. Then there exists an open neighbourhood $x \\in U \\subset X$ such that $\\varphi |_ U$ is surjective. \n\n    \n]]. the set $U_ i = \\{ s \\in S \\mid (q \\circ s_ i)_ s\\text{ surjective}\\} $ is open in $S$. Since $\\mathcal{O}_{S, s}$ is a local ring and $\\mathcal{Q}_ s$ a finite $\\mathcal{O}_{S, s}$-module by Nakayama\'s lemma (Algebra, Lemma 10.20.1 [[\n        \n      \n      \n  Lemma 10.20.1 (Nakayama\'s lemma). Let $R$ be a ring with Jacobson radical $\\text{rad}(R)$. Let $M$ be an $R$-module. Let $I \\subset R$ be an ideal. \n  \n  \n If $IM = M$ and $M$ is finite, then there exists an $f \\in 1 + I$ such that $fM = 0$. \n\n\nIf $IM = M$, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $M = 0$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, and $N\'$ is finite, then there exists an $f \\in 1 + I$ such that $fM \\subset N$ and $M_ f = N_ f$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, $N\'$ is finite, and $I \\subset \\text{rad}(R)$, then $M = N$. \n\n\nIf $N \\to M$ is a module map, $N/IN \\to M/IM$ is surjective, and $M$ is finite, then there exists an $f \\in 1 + I$ such that $N_ f \\to M_ f$ is surjective. \n\n\nIf $N \\to M$ is a module map, $N/IN \\to M/IM$ is surjective, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $N \\to M$ is surjective. \n\n\nIf $x_1, \\ldots , x_ n \\in M$ generate $M/IM$ and $M$ is finite, then there exists an $f \\in 1 + I$ such that $x_1, \\ldots , x_ n$ generate $M_ f$ over $R_ f$. \n\n\nIf $x_1, \\ldots , x_ n \\in M$ generate $M/IM$, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $M$ is generated by $x_1, \\ldots , x_ n$. \n\n\nIf $IM = M$, $I$ is nilpotent, then $M = 0$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, and $I$ is nilpotent then $M = N$. \n\n\nIf $N \\to M$ is a module map, $I$ is nilpotent, and $N/IN \\to M/IM$ is surjective, then $N \\to M$ is surjective. \n\n\nIf $\\{ x_\\alpha \\} _{\\alpha \\in A}$ is a set of elements of $M$ which generate $M/IM$ and $I$ is nilpotent, then $M$ is generated by the $x_\\alpha $. \n\n\n\n\n    \n]]) we have \n    \n      \n  \\[  s \\in U_ i \\Leftrightarrow \\left( \\text{the map } \\kappa (s)^{\\oplus n - k} \\to \\mathcal{Q}_ s/\\mathfrak m_ s\\mathcal{Q}_ s \\text{ induced by } (q \\circ s_ i)_ s \\text{ is surjective} \\right)  \\]\n\n    \n       Let $f : T \\to S$ be a morphism of schemes and let $t \\in T$ be a point mapping to $s \\in S$. We have $(f^*\\mathcal{Q})_ t = \\mathcal{Q}_ s \\otimes _{\\mathcal{O}_{S, s}} \\mathcal{O}_{T, t}$ (Sheaves, Lemma 6.26.4 [[\n  Lemma 6.26.4. Let $(f, f^\\sharp ) : (X, \\mathcal{O}_ X) \\to (Y, \\mathcal{O}_ Y)$ be a morphism of ringed spaces. Let $\\mathcal{G}$ be a sheaf of $\\mathcal{O}_ Y$-modules. Let $x \\in X$. Then \n  \n  \\[  (f^*\\mathcal{G})_ x = \\mathcal{G}_{f(x)} \\otimes _{\\mathcal{O}_{Y, f(x)}} \\mathcal{O}_{X, x}  \\]\n\n   as $\\mathcal{O}_{X, x}$-modules where the tensor product on the right uses $f^\\sharp _ x : \\mathcal{O}_{Y, f(x)} \\to \\mathcal{O}_{X, x}$. \n\n    \n]]) and so on. Thus the map \n    \n      \n  \\[  \\kappa (t)^{\\oplus n - k} \\to (f^*\\mathcal{Q})_ t/\\mathfrak m_ t(f^*\\mathcal{Q})_ t  \\]\n\n    \n       induced by $(f^*q \\circ f^*s_ i)_ t$ is the base change of the map $\\kappa (s)^{\\oplus n - k} \\to \\mathcal{Q}_ s/\\mathfrak m_ s\\mathcal{Q}_ s$ above by the field extension $\\kappa (t)/\\kappa (s)$. It follows that $s \\in U_ i$ if and only if $t$ is in the corresponding open for $f^*q$. In particular $T \\to S$ factors through $U_ i$ if and only if $f^*q \\in F_ i(T)$ as desired. \n    \n      The collection $F_ i$, $i \\in I$ covers $F$. Let $q : \\mathcal{O}_ S^{\\oplus n} \\to \\mathcal{Q}$ be an element of $F(S)$. We have to show that for every point $s$ of $S$ there exists an $i \\in I$ such that $s_ i$ is surjective in a neighbourhood of $s$. Thus we have to show that one of the compositions \n    \n      \n  \\[  \\kappa (s)^{\\oplus n - k} \\xrightarrow {s_ i} \\kappa (s)^{\\oplus n} \\rightarrow \\mathcal{Q}_ s/\\mathfrak m_ s\\mathcal{Q}_ s  \\]\n\n    \n       is surjective (see previous paragraph). As $\\mathcal{Q}_ s/\\mathfrak m_ s\\mathcal{Q}_ s$ is a vector space of dimension $n - k$ this follows from the theory of vector spaces. \n      $\\square$\n    \n\n\n\n  Definition 27.22.2 [[\n  Definition 27.22.2. Let $0 < k < n$. The scheme $\\mathbf{G}(k, n)$ representing the functor $G(k, n)$ is called Grassmannian over $\\mathbf{Z}$. Its base change $\\mathbf{G}(k, n)_ S$ to a scheme $S$ is called Grassmannian over $S$. If $R$ is a ring the base change to $\\mathop{\\mathrm{Spec}}(R)$ is denoted $\\mathbf{G}(k, n)_ R$ and called Grassmannian over $R$. \n]]. Let $0 < k < n$. The scheme $\\mathbf{G}(k, n)$ representing the functor $G(k, n)$ is called Grassmannian over $\\mathbf{Z}$. Its base change $\\mathbf{G}(k, n)_ S$ to a scheme $S$ is called Grassmannian over $S$. If $R$ is a ring the base change to $\\mathop{\\mathrm{Spec}}(R)$ is denoted $\\mathbf{G}(k, n)_ R$ and called Grassmannian over $R$. \n \n\n\nThe definition makes sense as we\'ve shown in Lemma 27.22.1 [[\n  Lemma 27.22.1. Let $0 < k < n$. The functor $G(k, n)$ of (27.22.0.1) is representable by a scheme. \n\n    \n]] that these functors are indeed representable. \n\n\n\n  Lemma 27.22.3 [[\n  Lemma 27.22.3. Let $n \\geq 1$. There is a canonical isomorphism $\\mathbf{G}(n, n + 1) = \\mathbf{P}^ n_\\mathbf {Z}$. \n\n    \n]]. Let $n \\geq 1$. There is a canonical isomorphism $\\mathbf{G}(n, n + 1) = \\mathbf{P}^ n_\\mathbf {Z}$. \n \n\n\n    \n      Proof.\n      According to Lemma 27.13.1 [[\n  Lemma 27.13.1. Let $S = \\mathbf{Z}[T_0, \\ldots , T_ n]$ with $\\deg (T_ i) = 1$. The scheme \n  \n  \\[  \\mathbf{P}^ n_{\\mathbf{Z}} = \\text{Proj}(S)  \\]\n\n   represents the functor which associates to a scheme $Y$ the pairs $(\\mathcal{L}, (s_0, \\ldots , s_ n))$ where \n  \n  \n$\\mathcal{L}$ is an invertible $\\mathcal{O}_ Y$-module, and \n\n\n$s_0, \\ldots , s_ n$ are global sections of $\\mathcal{L}$ which generate $\\mathcal{L}$ \n\n\n\n   up to the following equivalence: $(\\mathcal{L}, (s_0, \\ldots , s_ n)) \\sim (\\mathcal{N}, (t_0, \\ldots , t_ n))$ $\\Leftrightarrow $ there exists an isomorphism $\\beta : \\mathcal{L} \\to \\mathcal{N}$ with $\\beta (s_ i) = t_ i$ for $i = 0, \\ldots , n$. \n\n    \n]] the scheme $\\mathbf{P}^ n_\\mathbf {Z}$ represents the functor which assigns to a scheme $S$ the set of isomorphisms classes of pairs $(\\mathcal{L}, (s_0, \\ldots , s_ n))$ consisting of an invertible module $\\mathcal{L}$ and an $(n + 1)$-tuple of global sections generating $\\mathcal{L}$. Given such a pair we obtain a quotient \n    \n      \n  \\[  \\mathcal{O}_ S^{\\oplus n + 1} \\longrightarrow \\mathcal{L},\\quad (h_0, \\ldots , h_ n) \\longmapsto \\sum h_ i s_ i.  \\]\n\n    \n       Conversely, given an element $q : \\mathcal{O}_ S^{\\oplus n + 1} \\to \\mathcal{Q}$ of $G(n, n + 1)(S)$ we obtain such a pair, namely $(\\mathcal{Q}, (q(e_1), \\ldots , q(e_{n + 1})))$. Here $e_ i$, $i = 1, \\ldots , n + 1$ are the standard generating sections of the free module $\\mathcal{O}_ S^{\\oplus n + 1}$. We omit the verification that these constructions define mutually inverse transformations of functors. \n      $\\square$\n    \n\n"
225,00JB,"theorem isArtinianRing_iff_isFiniteLength : IsArtinianRing R â†” IsFiniteLength R R :=
  âŸ¨fun h â†¦ ((IsArtinianRing.tfae R R).out 2 3).mp h,
    fun h â†¦ (isFiniteLength_iff_isNoetherian_isArtinian.mp h).2âŸ©
",Formal Proof of Stacks Project Tag 00JB,A ring is Artinian if and only if it has finite length as a module over itself.,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/HopkinsLevitzki.lean#L135-L137,Q27041,,10.53.6,lemma,3.0,"['00J4', '00AO', '0ELQ']","\n  Lemma 10.53.6. A ring $R$ is Artinian if and only if it has finite length as a module over itself. Any such ring $R$ is both Artinian and Noetherian, any prime ideal of $R$ is a maximal ideal, and $R$ is equal to the (finite) product of its localizations at its maximal ideals. \n\n    \n      Proof.\n      If $R$ has finite length over itself then it satisfies both the ascending chain condition and the descending chain condition for ideals. Hence it is both Noetherian and Artinian. Any Artinian ring is equal to product of its localizations at maximal ideals by Lemmas 10.53.3, 10.53.4, and 10.53.5. \n    \n      Suppose that $R$ is Artinian. We will show $R$ has finite length over itself. It suffices to exhibit a chain of submodules whose successive quotients have finite length. By what we said above we may assume that $R$ is local, with maximal ideal $\\mathfrak m$. By Lemma 10.53.4 we have $\\mathfrak m^ n =0$ for some $n$. Consider the sequence $0 = \\mathfrak m^ n \\subset \\mathfrak m^{n-1} \\subset \\ldots \\subset \\mathfrak m \\subset R$. By Lemma 10.52.6 the length of each subquotient $\\mathfrak m^ j/\\mathfrak m^{j + 1}$ is the dimension of this as a vector space over $\\kappa (\\mathfrak m)$. This has to be finite since otherwise we would have an infinite descending chain of sub vector spaces which would correspond to an infinite descending chain of ideals in $R$. \n      $\\square$\n    \n","\n  Lemma 10.53.6. A ring $R$ is Artinian if and only if it has finite length as a module over itself. Any such ring $R$ is both Artinian and Noetherian, any prime ideal of $R$ is a maximal ideal, and $R$ is equal to the (finite) product of its localizations at its maximal ideals. \n\n    \n","Proof.\n      If $R$ has finite length over itself then it satisfies both the ascending chain condition and the descending chain condition for ideals. Hence it is both Noetherian and Artinian. Any Artinian ring is equal to product of its localizations at maximal ideals by Lemmas 10.53.3, 10.53.4, and 10.53.5. \n    \n      Suppose that $R$ is Artinian. We will show $R$ has finite length over itself. It suffices to exhibit a chain of submodules whose successive quotients have finite length. By what we said above we may assume that $R$ is local, with maximal ideal $\\mathfrak m$. By Lemma 10.53.4 we have $\\mathfrak m^ n =0$ for some $n$. Consider the sequence $0 = \\mathfrak m^ n \\subset \\mathfrak m^{n-1} \\subset \\ldots \\subset \\mathfrak m \\subset R$. By Lemma 10.52.6 the length of each subquotient $\\mathfrak m^ j/\\mathfrak m^{j + 1}$ is the dimension of this as a vector space over $\\kappa (\\mathfrak m)$. This has to be finite since otherwise we would have an infinite descending chain of sub vector spaces which would correspond to an infinite descending chain of ideals in $R$. \n      $\\square$\n    \n","
  âŸ¨fun h â†¦ ((IsArtinianRing.tfae R R).out 2 3).mp h,
    fun h â†¦ (isFiniteLength_iff_isNoetherian_isArtinian.mp h).2âŸ©
",theorem isArtinianRing_iff_isFiniteLength : IsArtinianRing R â†” IsFiniteLength R R ,"Proof.\n      If $R$ has finite length over itself then it satisfies both the ascending chain condition and the descending chain condition for ideals. Hence it is both Noetherian and Artinian. Any Artinian ring is equal to product of its localizations at maximal ideals by Lemmas 10.53.3 [[\n  Lemma 10.53.3. If $R$ is Artinian then $R$ has only finitely many maximal ideals. \n\n    \n]], 10.53.4 [[\n  Lemma 10.53.4. Let $R$ be Artinian. The Jacobson radical of $R$ is a nilpotent ideal. \n\n    \n]], and 10.53.5 [[\n  Lemma 10.53.5. Any ring with finitely many maximal ideals and locally nilpotent Jacobson radical is the product of its localizations at its maximal ideals. Also, all primes are maximal. \n\n    \n]]. \n    \n      Suppose that $R$ is Artinian. We will show $R$ has finite length over itself. It suffices to exhibit a chain of submodules whose successive quotients have finite length. By what we said above we may assume that $R$ is local, with maximal ideal $\\mathfrak m$. By Lemma 10.53.4 [[\n  Lemma 10.53.4. Let $R$ be Artinian. The Jacobson radical of $R$ is a nilpotent ideal. \n\n    \n]] we have $\\mathfrak m^ n =0$ for some $n$. Consider the sequence $0 = \\mathfrak m^ n \\subset \\mathfrak m^{n-1} \\subset \\ldots \\subset \\mathfrak m \\subset R$. By Lemma 10.52.6 [[\n  Lemma 10.52.6. Let $R$ be a ring with maximal ideal $\\mathfrak m$. Suppose that $M$ is an $R$-module with $\\mathfrak m M = 0$. Then the length of $M$ as an $R$-module agrees with the dimension of $M$ as a $R/\\mathfrak m$ vector space. The length is finite if and only if $M$ is a finite $R$-module. \n\n    \n]] the length of each subquotient $\\mathfrak m^ j/\\mathfrak m^{j + 1}$ is the dimension of this as a vector space over $\\kappa (\\mathfrak m)$. This has to be finite since otherwise we would have an infinite descending chain of sub vector spaces which would correspond to an infinite descending chain of ideals in $R$. \n      $\\square$\n    \n"
226,00JB,"**Any such ring is both Artinian and Noetherian.**""]
instance [IsArtinianRing R] : IsNoetherianRing R := ((IsArtinianRing.tfae R R).out 2 1).mp â€¹_â€º
",Formal Proof of Stacks Project Tag 00JB,A ring is Artinian if and only if it has finite length as a module over itself,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/HopkinsLevitzki.lean#L140-L141,Q27041,,10.53.6,lemma,3.0,"['00J4', '00AO', '0ELQ']","\n  Lemma 10.53.6. A ring $R$ is Artinian if and only if it has finite length as a module over itself. Any such ring $R$ is both Artinian and Noetherian, any prime ideal of $R$ is a maximal ideal, and $R$ is equal to the (finite) product of its localizations at its maximal ideals. \n\n    \n      Proof.\n      If $R$ has finite length over itself then it satisfies both the ascending chain condition and the descending chain condition for ideals. Hence it is both Noetherian and Artinian. Any Artinian ring is equal to product of its localizations at maximal ideals by Lemmas 10.53.3, 10.53.4, and 10.53.5. \n    \n      Suppose that $R$ is Artinian. We will show $R$ has finite length over itself. It suffices to exhibit a chain of submodules whose successive quotients have finite length. By what we said above we may assume that $R$ is local, with maximal ideal $\\mathfrak m$. By Lemma 10.53.4 we have $\\mathfrak m^ n =0$ for some $n$. Consider the sequence $0 = \\mathfrak m^ n \\subset \\mathfrak m^{n-1} \\subset \\ldots \\subset \\mathfrak m \\subset R$. By Lemma 10.52.6 the length of each subquotient $\\mathfrak m^ j/\\mathfrak m^{j + 1}$ is the dimension of this as a vector space over $\\kappa (\\mathfrak m)$. This has to be finite since otherwise we would have an infinite descending chain of sub vector spaces which would correspond to an infinite descending chain of ideals in $R$. \n      $\\square$\n    \n","\n  Lemma 10.53.6. A ring $R$ is Artinian if and only if it has finite length as a module over itself. Any such ring $R$ is both Artinian and Noetherian, any prime ideal of $R$ is a maximal ideal, and $R$ is equal to the (finite) product of its localizations at its maximal ideals. \n\n    \n","Proof.\n      If $R$ has finite length over itself then it satisfies both the ascending chain condition and the descending chain condition for ideals. Hence it is both Noetherian and Artinian. Any Artinian ring is equal to product of its localizations at maximal ideals by Lemmas 10.53.3, 10.53.4, and 10.53.5. \n    \n      Suppose that $R$ is Artinian. We will show $R$ has finite length over itself. It suffices to exhibit a chain of submodules whose successive quotients have finite length. By what we said above we may assume that $R$ is local, with maximal ideal $\\mathfrak m$. By Lemma 10.53.4 we have $\\mathfrak m^ n =0$ for some $n$. Consider the sequence $0 = \\mathfrak m^ n \\subset \\mathfrak m^{n-1} \\subset \\ldots \\subset \\mathfrak m \\subset R$. By Lemma 10.52.6 the length of each subquotient $\\mathfrak m^ j/\\mathfrak m^{j + 1}$ is the dimension of this as a vector space over $\\kappa (\\mathfrak m)$. This has to be finite since otherwise we would have an infinite descending chain of sub vector spaces which would correspond to an infinite descending chain of ideals in $R$. \n      $\\square$\n    \n"," ((IsArtinianRing.tfae R R).out 2 1).mp â€¹_â€º
","**Any such ring is both Artinian and Noetherian.**""]
instance [IsArtinianRing R] : IsNoetherianRing R ","Proof.\n      If $R$ has finite length over itself then it satisfies both the ascending chain condition and the descending chain condition for ideals. Hence it is both Noetherian and Artinian. Any Artinian ring is equal to product of its localizations at maximal ideals by Lemmas 10.53.3 [[\n  Lemma 10.53.3. If $R$ is Artinian then $R$ has only finitely many maximal ideals. \n\n    \n]], 10.53.4 [[\n  Lemma 10.53.4. Let $R$ be Artinian. The Jacobson radical of $R$ is a nilpotent ideal. \n\n    \n]], and 10.53.5 [[\n  Lemma 10.53.5. Any ring with finitely many maximal ideals and locally nilpotent Jacobson radical is the product of its localizations at its maximal ideals. Also, all primes are maximal. \n\n    \n]]. \n    \n      Suppose that $R$ is Artinian. We will show $R$ has finite length over itself. It suffices to exhibit a chain of submodules whose successive quotients have finite length. By what we said above we may assume that $R$ is local, with maximal ideal $\\mathfrak m$. By Lemma 10.53.4 [[\n  Lemma 10.53.4. Let $R$ be Artinian. The Jacobson radical of $R$ is a nilpotent ideal. \n\n    \n]] we have $\\mathfrak m^ n =0$ for some $n$. Consider the sequence $0 = \\mathfrak m^ n \\subset \\mathfrak m^{n-1} \\subset \\ldots \\subset \\mathfrak m \\subset R$. By Lemma 10.52.6 [[\n  Lemma 10.52.6. Let $R$ be a ring with maximal ideal $\\mathfrak m$. Suppose that $M$ is an $R$-module with $\\mathfrak m M = 0$. Then the length of $M$ as an $R$-module agrees with the dimension of $M$ as a $R/\\mathfrak m$ vector space. The length is finite if and only if $M$ is a finite $R$-module. \n\n    \n]] the length of each subquotient $\\mathfrak m^ j/\\mathfrak m^{j + 1}$ is the dimension of this as a vector space over $\\kappa (\\mathfrak m)$. This has to be finite since otherwise we would have an infinite descending chain of sub vector spaces which would correspond to an infinite descending chain of ideals in $R$. \n      $\\square$\n    \n"
227,00KH,"    IsArtinianRing R â†” IsNoetherianRing R âˆ§ Ring.KrullDimLE 0 R :=
  âŸ¨fun _ â†¦ âŸ¨inferInstance, inferInstanceâŸ©, fun âŸ¨h, _âŸ© â†¦ h.isArtinianRing_of_krullDimLE_zeroâŸ©
",Formal Proof of Stacks Project Tag 00KH, theorem isArtinianRing_iff_isNoetherianRing_krullDimLE_zero {R} [CommRing R] ,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/HopkinsLevitzki.lean#L177-L178,Q27041,,10.60.5,lemma,3.0,"['00KD', '00AO', '0ELQ']","\n  Lemma 10.60.5. A Noetherian ring of dimension $0$ is Artinian. Conversely, any Artinian ring is Noetherian of dimension zero. \n\n    \n      Proof.\n      Assume $R$ is a Noetherian ring of dimension $0$. By Lemma 10.31.5 the space $\\mathop{\\mathrm{Spec}}(R)$ is Noetherian. By Topology, Lemma 5.9.2 we see that $\\mathop{\\mathrm{Spec}}(R)$ has finitely many irreducible components, say $\\mathop{\\mathrm{Spec}}(R) = Z_1 \\cup \\ldots \\cup Z_ r$. According to Lemma 10.26.1 each $Z_ i = V(\\mathfrak p_ i)$ with $\\mathfrak p_ i$ a minimal ideal. Since the dimension is $0$ these $\\mathfrak p_ i$ are also maximal. Thus $\\mathop{\\mathrm{Spec}}(R)$ is the discrete topological space with elements $\\mathfrak p_ i$. All elements $f$ of the Jacobson radical $\\bigcap \\mathfrak p_ i$ are nilpotent since otherwise $R_ f$ would not be the zero ring and we would have another prime. By Lemma 10.53.5 $R$ is equal to $\\prod R_{\\mathfrak p_ i}$. Since $R_{\\mathfrak p_ i}$ is also Noetherian and dimension $0$, the previous arguments show that its radical $\\mathfrak p_ iR_{\\mathfrak p_ i}$ is locally nilpotent. Lemma 10.32.5 gives $\\mathfrak p_ i^ nR_{\\mathfrak p_ i} = 0$ for some $n \\geq 1$. By Lemma 10.52.8 we conclude that $R_{\\mathfrak p_ i}$ has finite length over $R$. Hence we conclude that $R$ is Artinian by Lemma 10.53.6. \n    \n      If $R$ is an Artinian ring then by Lemma 10.53.6 it is Noetherian. All of its primes are maximal by a combination of Lemmas 10.53.3, 10.53.4 and 10.53.5. \n      $\\square$\n    \n","\n  Lemma 10.60.5. A Noetherian ring of dimension $0$ is Artinian. Conversely, any Artinian ring is Noetherian of dimension zero. \n\n    \n","Proof.\n      Assume $R$ is a Noetherian ring of dimension $0$. By Lemma 10.31.5 the space $\\mathop{\\mathrm{Spec}}(R)$ is Noetherian. By Topology, Lemma 5.9.2 we see that $\\mathop{\\mathrm{Spec}}(R)$ has finitely many irreducible components, say $\\mathop{\\mathrm{Spec}}(R) = Z_1 \\cup \\ldots \\cup Z_ r$. According to Lemma 10.26.1 each $Z_ i = V(\\mathfrak p_ i)$ with $\\mathfrak p_ i$ a minimal ideal. Since the dimension is $0$ these $\\mathfrak p_ i$ are also maximal. Thus $\\mathop{\\mathrm{Spec}}(R)$ is the discrete topological space with elements $\\mathfrak p_ i$. All elements $f$ of the Jacobson radical $\\bigcap \\mathfrak p_ i$ are nilpotent since otherwise $R_ f$ would not be the zero ring and we would have another prime. By Lemma 10.53.5 $R$ is equal to $\\prod R_{\\mathfrak p_ i}$. Since $R_{\\mathfrak p_ i}$ is also Noetherian and dimension $0$, the previous arguments show that its radical $\\mathfrak p_ iR_{\\mathfrak p_ i}$ is locally nilpotent. Lemma 10.32.5 gives $\\mathfrak p_ i^ nR_{\\mathfrak p_ i} = 0$ for some $n \\geq 1$. By Lemma 10.52.8 we conclude that $R_{\\mathfrak p_ i}$ has finite length over $R$. Hence we conclude that $R$ is Artinian by Lemma 10.53.6. \n    \n      If $R$ is an Artinian ring then by Lemma 10.53.6 it is Noetherian. All of its primes are maximal by a combination of Lemmas 10.53.3, 10.53.4 and 10.53.5. \n      $\\square$\n    \n","
  âŸ¨fun _ â†¦ âŸ¨inferInstance, inferInstanceâŸ©, fun âŸ¨h, _âŸ© â†¦ h.isArtinianRing_of_krullDimLE_zeroâŸ©
",    IsArtinianRing R â†” IsNoetherianRing R âˆ§ Ring.KrullDimLE 0 R ,"Proof.\n      Assume $R$ is a Noetherian ring of dimension $0$. By Lemma 10.31.5 [[\n  Lemma 10.31.5. If $R$ is a Noetherian ring then $\\mathop{\\mathrm{Spec}}(R)$ is a Noetherian topological space, see Topology, Definition 5.9.1. \n\n    \n]] the space $\\mathop{\\mathrm{Spec}}(R)$ is Noetherian. By Topology, Lemma 5.9.2 [[\n  Lemma 5.9.2. Let $X$ be a Noetherian topological space. \n  \n  \nAny subset of $X$ with the induced topology is Noetherian. \n\n\nThe space $X$ has finitely many irreducible components. \n\n\nEach irreducible component of $X$ contains a nonempty open of $X$. \n\n\n\n\n    \n]] we see that $\\mathop{\\mathrm{Spec}}(R)$ has finitely many irreducible components, say $\\mathop{\\mathrm{Spec}}(R) = Z_1 \\cup \\ldots \\cup Z_ r$. According to Lemma 10.26.1 [[\n  Lemma 10.26.1. Let $R$ be a ring. \n  \n  \nFor a prime $\\mathfrak p \\subset R$ the closure of $\\{ \\mathfrak p\\} $ in the Zariski topology is $V(\\mathfrak p)$. In a formula $\\overline{\\{ \\mathfrak p\\} } = V(\\mathfrak p)$. \n\n\nThe irreducible closed subsets of $\\mathop{\\mathrm{Spec}}(R)$ are exactly the subsets $V(\\mathfrak p)$, with $\\mathfrak p \\subset R$ a prime. \n\n\nThe irreducible components (see Topology, Definition 5.8.1) of $\\mathop{\\mathrm{Spec}}(R)$ are exactly the subsets $V(\\mathfrak p)$, with $\\mathfrak p \\subset R$ a minimal prime. \n\n\n\n\n    \n]] each $Z_ i = V(\\mathfrak p_ i)$ with $\\mathfrak p_ i$ a minimal ideal. Since the dimension is $0$ these $\\mathfrak p_ i$ are also maximal. Thus $\\mathop{\\mathrm{Spec}}(R)$ is the discrete topological space with elements $\\mathfrak p_ i$. All elements $f$ of the Jacobson radical $\\bigcap \\mathfrak p_ i$ are nilpotent since otherwise $R_ f$ would not be the zero ring and we would have another prime. By Lemma 10.53.5 [[\n  Lemma 10.53.5. Any ring with finitely many maximal ideals and locally nilpotent Jacobson radical is the product of its localizations at its maximal ideals. Also, all primes are maximal. \n\n    \n]] $R$ is equal to $\\prod R_{\\mathfrak p_ i}$. Since $R_{\\mathfrak p_ i}$ is also Noetherian and dimension $0$, the previous arguments show that its radical $\\mathfrak p_ iR_{\\mathfrak p_ i}$ is locally nilpotent. Lemma 10.32.5 [[\n       \n      \n  Lemma 10.32.5. Let $R$ be a Noetherian ring. Let $I, J$ be ideals of $R$. Suppose $J \\subset \\sqrt{I}$. Then $J^ n \\subset I$ for some $n$. In particular, in a Noetherian ring the notions of \xe2\x80\x9clocally nilpotent ideal\xe2\x80\x9d and \xe2\x80\x9cnilpotent ideal\xe2\x80\x9d coincide. \n\n    \n]] gives $\\mathfrak p_ i^ nR_{\\mathfrak p_ i} = 0$ for some $n \\geq 1$. By Lemma 10.52.8 [[\n  Lemma 10.52.8. Let $R$ be a ring with finitely generated maximal ideal $\\mathfrak m$. (For example $R$ Noetherian.) Suppose that $M$ is a finite $R$-module with $\\mathfrak m^ n M = 0$ for some $n$. Then $\\text{length}_ R(M) < \\infty $. \n\n    \n]] we conclude that $R_{\\mathfrak p_ i}$ has finite length over $R$. Hence we conclude that $R$ is Artinian by Lemma 10.53.6 [[\n  Lemma 10.53.6. A ring $R$ is Artinian if and only if it has finite length as a module over itself. Any such ring $R$ is both Artinian and Noetherian, any prime ideal of $R$ is a maximal ideal, and $R$ is equal to the (finite) product of its localizations at its maximal ideals. \n\n    \n]]. \n    \n      If $R$ is an Artinian ring then by Lemma 10.53.6 [[\n  Lemma 10.53.6. A ring $R$ is Artinian if and only if it has finite length as a module over itself. Any such ring $R$ is both Artinian and Noetherian, any prime ideal of $R$ is a maximal ideal, and $R$ is equal to the (finite) product of its localizations at its maximal ideals. \n\n    \n]] it is Noetherian. All of its primes are maximal by a combination of Lemmas 10.53.3 [[\n  Lemma 10.53.3. If $R$ is Artinian then $R$ has only finitely many maximal ideals. \n\n    \n]], 10.53.4 [[\n  Lemma 10.53.4. Let $R$ be Artinian. The Jacobson radical of $R$ is a nilpotent ideal. \n\n    \n]] and 10.53.5 [[\n  Lemma 10.53.5. Any ring with finitely many maximal ideals and locally nilpotent Jacobson radical is the product of its localizations at its maximal ideals. Also, all primes are maximal. \n\n    \n]]. \n      $\\square$\n    \n"
228,00J9,"theorem existsUnique_isIdempotentElem_eq_of_ker_isNilpotent (h : âˆ€ x âˆˆ RingHom.ker f, IsNilpotent x)
    (e : S) (he : e âˆˆ f.range) (he' : IsIdempotentElem e) :
    âˆƒ! e' : R, IsIdempotentElem e' âˆ§ f e' = e := by
  obtain âŸ¨e', heâ‚‚, rflâŸ© := exists_isIdempotentElem_eq_of_ker_isNilpotent f h e he he'
  exact âŸ¨e', âŸ¨heâ‚‚, rflâŸ©, fun x âŸ¨hx, hx'âŸ© â†¦
    eq_of_isNilpotent_sub_of_isIdempotentElem hx heâ‚‚
      (h _ (by rw [RingHom.mem_ker, map_sub, hx', sub_self]))âŸ©
",Formal Proof of Stacks Project Tag 00J9,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Idempotents.lean#L374-L380,Q27041,,10.32.6,lemma,3.0,"['0AMF', '00AO', '0ELQ']","\n  Lemma 10.32.6. Let $R$ be a ring. Let $I \\subset R$ be a locally nilpotent ideal. Then $R \\to R/I$ induces a bijection on idempotents. \n\n    \n      Second proof of Lemma 10.32.6.\n       Suppose $\\overline{e} \\in R/I$ is an idempotent. We have to lift $\\overline{e}$ to an idempotent of $R$. \n    \n      First, choose any lift $f \\in R$ of $\\overline{e}$, and set $x = f^2 - f$. Then, $x \\in I$, so $x$ is nilpotent (since $I$ is locally nilpotent). Let now $J$ be the ideal of $R$ generated by $x$. Then, $J$ is nilpotent (not just locally nilpotent), since it is generated by the nilpotent $x$. \n    \n      Now, assume that we have found a lift $e \\in R$ of $\\overline{e}$ such that $e^2 - e \\in J^ k$ for some $k \\geq 1$. Let $e\' = e - (2e - 1)(e^2 - e) = 3e^2 - 2e^3$, which is another lift of $\\overline{e}$ (since the idempotency of $\\overline{e}$ yields $e^2 - e \\in I$). Then \n    \n      \n  \\[  (e\')^2 - e\' = (4e^2 - 4e - 3)(e^2 - e)^2 \\in J^{2k}  \\]\n\n    \n       by a simple computation. \n    \n      We thus have started with a lift $e$ of $\\overline{e}$ such that $e^2 - e \\in J^ k$, and obtained a lift $e\'$ of $\\overline{e}$ such that $(e\')^2 - e\' \\in J^{2k}$. This way we can successively improve the approximation (starting with $e = f$, which fits the bill for $k = 1$). Eventually, we reach a stage where $J^ k = 0$, and at that stage we have a lift $e$ of $\\overline{e}$ such that $e^2 - e \\in J^ k = 0$, that is, this $e$ is idempotent. \n    \n      We thus have seen that if $\\overline{e} \\in R/I$ is any idempotent, then there exists a lift of $\\overline{e}$ which is an idempotent of $R$. It remains to prove that this lift is unique. Indeed, let $e_1$ and $e_2$ be two such lifts. We need to show that $e_1 = e_2$. \n    \n      By definition of $e_1$ and $e_2$, we have $e_1 \\equiv e_2 \\mod I$, and both $e_1$ and $e_2$ are idempotent. From $e_1 \\equiv e_2 \\mod I$, we see that $e_1 - e_2 \\in I$, so that $e_1 - e_2$ is nilpotent (since $I$ is locally nilpotent). A straightforward computation (using the idempotency of $e_1$ and $e_2$) reveals that $(e_1 - e_2)^3 = e_1 - e_2$. Using this and induction, we obtain $(e_1 - e_2)^ k = e_1 - e_2$ for any positive odd integer $k$. Since all high enough $k$ satisfy $(e_1 - e_2)^ k = 0$ (since $e_1 - e_2$ is nilpotent), this shows $e_1 - e_2 = 0$, so that $e_1 = e_2$, which completes our proof. \n      $\\square$\n    \n\n    \n      First proof of Lemma 10.32.6.\n       As $I$ is locally nilpotent it is contained in every prime ideal. Hence $\\mathop{\\mathrm{Spec}}(R/I) = V(I) = \\mathop{\\mathrm{Spec}}(R)$. Hence the lemma follows from Lemma 10.21.3. \n      $\\square$\n    \n","\n  Lemma 10.32.6. Let $R$ be a ring. Let $I \\subset R$ be a locally nilpotent ideal. Then $R \\to R/I$ induces a bijection on idempotents. \n\n    \n      Second proof of Lemma 10.32.6.\n       Suppose $\\overline{e} \\in R/I$ is an idempotent. We have to lift $\\overline{e}$ to an idempotent of $R$. \n    \n      First, choose any lift $f \\in R$ of $\\overline{e}$, and set $x = f^2 - f$. Then, $x \\in I$, so $x$ is nilpotent (since $I$ is locally nilpotent). Let now $J$ be the ideal of $R$ generated by $x$. Then, $J$ is nilpotent (not just locally nilpotent), since it is generated by the nilpotent $x$. \n    \n      Now, assume that we have found a lift $e \\in R$ of $\\overline{e}$ such that $e^2 - e \\in J^ k$ for some $k \\geq 1$. Let $e\' = e - (2e - 1)(e^2 - e) = 3e^2 - 2e^3$, which is another lift of $\\overline{e}$ (since the idempotency of $\\overline{e}$ yields $e^2 - e \\in I$). Then \n    \n      \n  \\[  (e\')^2 - e\' = (4e^2 - 4e - 3)(e^2 - e)^2 \\in J^{2k}  \\]\n\n    \n       by a simple computation. \n    \n      We thus have started with a lift $e$ of $\\overline{e}$ such that $e^2 - e \\in J^ k$, and obtained a lift $e\'$ of $\\overline{e}$ such that $(e\')^2 - e\' \\in J^{2k}$. This way we can successively improve the approximation (starting with $e = f$, which fits the bill for $k = 1$). Eventually, we reach a stage where $J^ k = 0$, and at that stage we have a lift $e$ of $\\overline{e}$ such that $e^2 - e \\in J^ k = 0$, that is, this $e$ is idempotent. \n    \n      We thus have seen that if $\\overline{e} \\in R/I$ is any idempotent, then there exists a lift of $\\overline{e}$ which is an idempotent of $R$. It remains to prove that this lift is unique. Indeed, let $e_1$ and $e_2$ be two such lifts. We need to show that $e_1 = e_2$. \n    \n      By definition of $e_1$ and $e_2$, we have $e_1 \\equiv e_2 \\mod I$, and both $e_1$ and $e_2$ are idempotent. From $e_1 \\equiv e_2 \\mod I$, we see that $e_1 - e_2 \\in I$, so that $e_1 - e_2$ is nilpotent (since $I$ is locally nilpotent). A straightforward computation (using the idempotency of $e_1$ and $e_2$) reveals that $(e_1 - e_2)^3 = e_1 - e_2$. Using this and induction, we obtain $(e_1 - e_2)^ k = e_1 - e_2$ for any positive odd integer $k$. Since all high enough $k$ satisfy $(e_1 - e_2)^ k = 0$ (since $e_1 - e_2$ is nilpotent), this shows $e_1 - e_2 = 0$, so that $e_1 = e_2$, which completes our proof. \n      $\\square$\n    \n\n    \n      First proof of Lemma 10.32.6.\n       As $I$ is locally nilpotent it is contained in every prime ideal. Hence $\\mathop{\\mathrm{Spec}}(R/I) = V(I) = \\mathop{\\mathrm{Spec}}(R)$. Hence the lemma follows from Lemma 10.21.3. \n      $\\square$\n    \n",," by
  obtain âŸ¨e', heâ‚‚, rflâŸ© := exists_isIdempotentElem_eq_of_ker_isNilpotent f h e he he'
  exact âŸ¨e', âŸ¨heâ‚‚, rflâŸ©, fun x âŸ¨hx, hx'âŸ© â†¦
    eq_of_isNilpotent_sub_of_isIdempotentElem hx heâ‚‚
      (h _ (by rw [RingHom.mem_ker, map_sub, hx', sub_self]))âŸ©
","theorem existsUnique_isIdempotentElem_eq_of_ker_isNilpotent (h : âˆ€ x âˆˆ RingHom.ker f, IsNilpotent x)
    (e : S) (he : e âˆˆ f.range) (he' : IsIdempotentElem e) :
    âˆƒ! e' : R, IsIdempotentElem e' âˆ§ f e' = e ",
229,00DV,"theorem eq_bot_of_le_smul_of_le_jacobson_bot (I : Ideal R) (N : Submodule R M) (hN : N.FG)
    (hIN : N â‰¤ I â€¢ N) (hIjac : I â‰¤ jacobson âŠ¥) : N = âŠ¥ := by
  rw [eq_smul_of_le_smul_of_le_jacobson hN hIN hIjac, Submodule.bot_smul]
",Formal Proof of Stacks Project Tag 00DV,(2),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Nakayama.lean#L118-L120,Q27041,Nakayama's lemma,10.20.1,lemma,3.0,"['07RC', '00AO', '0ELQ']","\n        \n      \n      \n  Lemma 10.20.1 (Nakayama\'s lemma). Let $R$ be a ring with Jacobson radical $\\text{rad}(R)$. Let $M$ be an $R$-module. Let $I \\subset R$ be an ideal. \n  \n  \n If $IM = M$ and $M$ is finite, then there exists an $f \\in 1 + I$ such that $fM = 0$. \n\n\nIf $IM = M$, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $M = 0$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, and $N\'$ is finite, then there exists an $f \\in 1 + I$ such that $fM \\subset N$ and $M_ f = N_ f$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, $N\'$ is finite, and $I \\subset \\text{rad}(R)$, then $M = N$. \n\n\nIf $N \\to M$ is a module map, $N/IN \\to M/IM$ is surjective, and $M$ is finite, then there exists an $f \\in 1 + I$ such that $N_ f \\to M_ f$ is surjective. \n\n\nIf $N \\to M$ is a module map, $N/IN \\to M/IM$ is surjective, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $N \\to M$ is surjective. \n\n\nIf $x_1, \\ldots , x_ n \\in M$ generate $M/IM$ and $M$ is finite, then there exists an $f \\in 1 + I$ such that $x_1, \\ldots , x_ n$ generate $M_ f$ over $R_ f$. \n\n\nIf $x_1, \\ldots , x_ n \\in M$ generate $M/IM$, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $M$ is generated by $x_1, \\ldots , x_ n$. \n\n\nIf $IM = M$, $I$ is nilpotent, then $M = 0$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, and $I$ is nilpotent then $M = N$. \n\n\nIf $N \\to M$ is a module map, $I$ is nilpotent, and $N/IN \\to M/IM$ is surjective, then $N \\to M$ is surjective. \n\n\nIf $\\{ x_\\alpha \\} _{\\alpha \\in A}$ is a set of elements of $M$ which generate $M/IM$ and $I$ is nilpotent, then $M$ is generated by the $x_\\alpha $. \n\n\n\n\n    \n      Proof.\n      Proof of (1). Choose generators $y_1, \\ldots , y_ m$ of $M$ over $R$. For each $i$ we can write $y_ i = \\sum z_{ij} y_ j$ with $z_{ij} \\in I$ (since $M = IM$). In other words $\\sum _ j (\\delta _{ij} - z_{ij})y_ j = 0$. Let $f$ be the determinant of the $m \\times m$ matrix $A = (\\delta _{ij} - z_{ij})$. Note that $f \\in 1 + I$ (since the matrix $A$ is entrywise congruent to the $m \\times m$ identity matrix modulo $I$). By Lemma 10.15.5 (1), there exists an $m \\times m$ matrix $B$ such that $BA = f 1_{m \\times m}$. Writing out we see that $\\sum _{i} b_{hi} a_{ij} = f \\delta _{hj}$ for all $h$ and $j$; hence, $\\sum _{i, j} b_{hi} a_{ij} y_ j = \\sum _{j} f \\delta _{hj} y_ j = f y_ h$ for every $h$. In other words, $0 = f y_ h$ for every $h$ (since each $i$ satisfies $\\sum _ j a_{ij} y_ j = 0$). This implies that $f$ annihilates $M$. \n    \n      By Lemma 10.19.1 an element of $1 + \\text{rad}(R)$ is invertible element of $R$. Hence we see that (1) implies (2). We obtain (3) by applying (1) to $M/N$ which is finite as $N\'$ is finite. We obtain (4) by applying (2) to $M/N$ which is finite as $N\'$ is finite. We obtain (5) by applying (3) to $M$ and the submodules $\\mathop{\\mathrm{Im}}(N \\to M)$ and $M$. We obtain (6) by applying (4) to $M$ and the submodules $\\mathop{\\mathrm{Im}}(N \\to M)$ and $M$. We obtain (7) by applying (5) to the map $R^{\\oplus n} \\to M$, $(a_1, \\ldots , a_ n) \\mapsto a_1x_1 + \\ldots + a_ nx_ n$. We obtain (8) by applying (6) to the map $R^{\\oplus n} \\to M$, $(a_1, \\ldots , a_ n) \\mapsto a_1x_1 + \\ldots + a_ nx_ n$. \n    \n      Part (9) holds because if $M = IM$ then $M = I^ nM$ for all $n \\geq 0$ and $I$ being nilpotent means $I^ n = 0$ for some $n \\gg 0$. Parts (10), (11), and (12) follow from (9) by the arguments used above. \n      $\\square$\n    \n","\n        \n      \n      \n  Lemma 10.20.1 (Nakayama\'s lemma). Let $R$ be a ring with Jacobson radical $\\text{rad}(R)$. Let $M$ be an $R$-module. Let $I \\subset R$ be an ideal. \n  \n  \n If $IM = M$ and $M$ is finite, then there exists an $f \\in 1 + I$ such that $fM = 0$. \n\n\nIf $IM = M$, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $M = 0$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, and $N\'$ is finite, then there exists an $f \\in 1 + I$ such that $fM \\subset N$ and $M_ f = N_ f$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, $N\'$ is finite, and $I \\subset \\text{rad}(R)$, then $M = N$. \n\n\nIf $N \\to M$ is a module map, $N/IN \\to M/IM$ is surjective, and $M$ is finite, then there exists an $f \\in 1 + I$ such that $N_ f \\to M_ f$ is surjective. \n\n\nIf $N \\to M$ is a module map, $N/IN \\to M/IM$ is surjective, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $N \\to M$ is surjective. \n\n\nIf $x_1, \\ldots , x_ n \\in M$ generate $M/IM$ and $M$ is finite, then there exists an $f \\in 1 + I$ such that $x_1, \\ldots , x_ n$ generate $M_ f$ over $R_ f$. \n\n\nIf $x_1, \\ldots , x_ n \\in M$ generate $M/IM$, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $M$ is generated by $x_1, \\ldots , x_ n$. \n\n\nIf $IM = M$, $I$ is nilpotent, then $M = 0$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, and $I$ is nilpotent then $M = N$. \n\n\nIf $N \\to M$ is a module map, $I$ is nilpotent, and $N/IN \\to M/IM$ is surjective, then $N \\to M$ is surjective. \n\n\nIf $\\{ x_\\alpha \\} _{\\alpha \\in A}$ is a set of elements of $M$ which generate $M/IM$ and $I$ is nilpotent, then $M$ is generated by the $x_\\alpha $. \n\n\n\n\n    \n","Proof.\n      Proof of (1). Choose generators $y_1, \\ldots , y_ m$ of $M$ over $R$. For each $i$ we can write $y_ i = \\sum z_{ij} y_ j$ with $z_{ij} \\in I$ (since $M = IM$). In other words $\\sum _ j (\\delta _{ij} - z_{ij})y_ j = 0$. Let $f$ be the determinant of the $m \\times m$ matrix $A = (\\delta _{ij} - z_{ij})$. Note that $f \\in 1 + I$ (since the matrix $A$ is entrywise congruent to the $m \\times m$ identity matrix modulo $I$). By Lemma 10.15.5 (1), there exists an $m \\times m$ matrix $B$ such that $BA = f 1_{m \\times m}$. Writing out we see that $\\sum _{i} b_{hi} a_{ij} = f \\delta _{hj}$ for all $h$ and $j$; hence, $\\sum _{i, j} b_{hi} a_{ij} y_ j = \\sum _{j} f \\delta _{hj} y_ j = f y_ h$ for every $h$. In other words, $0 = f y_ h$ for every $h$ (since each $i$ satisfies $\\sum _ j a_{ij} y_ j = 0$). This implies that $f$ annihilates $M$. \n    \n      By Lemma 10.19.1 an element of $1 + \\text{rad}(R)$ is invertible element of $R$. Hence we see that (1) implies (2). We obtain (3) by applying (1) to $M/N$ which is finite as $N\'$ is finite. We obtain (4) by applying (2) to $M/N$ which is finite as $N\'$ is finite. We obtain (5) by applying (3) to $M$ and the submodules $\\mathop{\\mathrm{Im}}(N \\to M)$ and $M$. We obtain (6) by applying (4) to $M$ and the submodules $\\mathop{\\mathrm{Im}}(N \\to M)$ and $M$. We obtain (7) by applying (5) to the map $R^{\\oplus n} \\to M$, $(a_1, \\ldots , a_ n) \\mapsto a_1x_1 + \\ldots + a_ nx_ n$. We obtain (8) by applying (6) to the map $R^{\\oplus n} \\to M$, $(a_1, \\ldots , a_ n) \\mapsto a_1x_1 + \\ldots + a_ nx_ n$. \n    \n      Part (9) holds because if $M = IM$ then $M = I^ nM$ for all $n \\geq 0$ and $I$ being nilpotent means $I^ n = 0$ for some $n \\gg 0$. Parts (10), (11), and (12) follow from (9) by the arguments used above. \n      $\\square$\n    \n"," by
  rw [eq_smul_of_le_smul_of_le_jacobson hN hIN hIjac, Submodule.bot_smul]
","theorem eq_bot_of_le_smul_of_le_jacobson_bot (I : Ideal R) (N : Submodule R M) (hN : N.FG)
    (hIN : N â‰¤ I â€¢ N) (hIjac : I â‰¤ jacobson âŠ¥) : N = âŠ¥ ","Proof.\n      Proof of (1). Choose generators $y_1, \\ldots , y_ m$ of $M$ over $R$. For each $i$ we can write $y_ i = \\sum z_{ij} y_ j$ with $z_{ij} \\in I$ (since $M = IM$). In other words $\\sum _ j (\\delta _{ij} - z_{ij})y_ j = 0$. Let $f$ be the determinant of the $m \\times m$ matrix $A = (\\delta _{ij} - z_{ij})$. Note that $f \\in 1 + I$ (since the matrix $A$ is entrywise congruent to the $m \\times m$ identity matrix modulo $I$). By Lemma 10.15.5 [[\n  Lemma 10.15.5. Let $R$ be a ring. Let $n \\geq m$. Let $A$ be an $n \\times m$ matrix with coefficients in $R$. Let $J \\subset R$ be the ideal generated by the $m \\times m$ minors of $A$. \n  \n  \nFor any $f \\in J$ there exists a $m \\times n$ matrix $B$ such that $BA = f 1_{m \\times m}$. \n\n\nIf $f \\in R$ and $BA = f 1_{m \\times m}$ for some $m \\times n$ matrix $B$, then $f^ m \\in J$. \n\n\n\n\n    \n]] (1), there exists an $m \\times m$ matrix $B$ such that $BA = f 1_{m \\times m}$. Writing out we see that $\\sum _{i} b_{hi} a_{ij} = f \\delta _{hj}$ for all $h$ and $j$; hence, $\\sum _{i, j} b_{hi} a_{ij} y_ j = \\sum _{j} f \\delta _{hj} y_ j = f y_ h$ for every $h$. In other words, $0 = f y_ h$ for every $h$ (since each $i$ satisfies $\\sum _ j a_{ij} y_ j = 0$). This implies that $f$ annihilates $M$. \n    \n      By Lemma 10.19.1 [[\n  Lemma 10.19.1. Let $R$ be a ring with Jacobson radical $\\text{rad}(R)$. Let $I \\subset R$ be an ideal. The following are equivalent \n  \n  \n$I \\subset \\text{rad}(R)$, and \n\n\nevery element of $1 + I$ is a unit in $R$. \n\n\n\n   In this case every element of $R$ which maps to a unit of $R/I$ is a unit. \n\n    \n]] an element of $1 + \\text{rad}(R)$ is invertible element of $R$. Hence we see that (1) implies (2). We obtain (3) by applying (1) to $M/N$ which is finite as $N\'$ is finite. We obtain (4) by applying (2) to $M/N$ which is finite as $N\'$ is finite. We obtain (5) by applying (3) to $M$ and the submodules $\\mathop{\\mathrm{Im}}(N \\to M)$ and $M$. We obtain (6) by applying (4) to $M$ and the submodules $\\mathop{\\mathrm{Im}}(N \\to M)$ and $M$. We obtain (7) by applying (5) to the map $R^{\\oplus n} \\to M$, $(a_1, \\ldots , a_ n) \\mapsto a_1x_1 + \\ldots + a_ nx_ n$. We obtain (8) by applying (6) to the map $R^{\\oplus n} \\to M$, $(a_1, \\ldots , a_ n) \\mapsto a_1x_1 + \\ldots + a_ nx_ n$. \n    \n      Part (9) holds because if $M = IM$ then $M = I^ nM$ for all $n \\geq 0$ and $I$ being nilpotent means $I^ n = 0$ for some $n \\gg 0$. Parts (10), (11), and (12) follow from (9) by the arguments used above. \n      $\\square$\n    \n"
230,00DV,"theorem smul_le_of_le_smul_of_le_jacobson_bot {I : Ideal R} {N N' : Submodule R M} (hN' : N'.FG)
    (hIJ : I â‰¤ jacobson âŠ¥) (hNN : N' â‰¤ N âŠ” I â€¢ N') : I â€¢ N' â‰¤ N :=
  smul_le_right.trans (le_of_le_smul_of_le_jacobson_bot hN' hIJ hNN)
",Formal Proof of Stacks Project Tag 00DV,(4),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Nakayama.lean#L156-L158,Q27041,Nakayama's lemma,10.20.1,lemma,3.0,"['07RC', '00AO', '0ELQ']","\n        \n      \n      \n  Lemma 10.20.1 (Nakayama\'s lemma). Let $R$ be a ring with Jacobson radical $\\text{rad}(R)$. Let $M$ be an $R$-module. Let $I \\subset R$ be an ideal. \n  \n  \n If $IM = M$ and $M$ is finite, then there exists an $f \\in 1 + I$ such that $fM = 0$. \n\n\nIf $IM = M$, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $M = 0$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, and $N\'$ is finite, then there exists an $f \\in 1 + I$ such that $fM \\subset N$ and $M_ f = N_ f$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, $N\'$ is finite, and $I \\subset \\text{rad}(R)$, then $M = N$. \n\n\nIf $N \\to M$ is a module map, $N/IN \\to M/IM$ is surjective, and $M$ is finite, then there exists an $f \\in 1 + I$ such that $N_ f \\to M_ f$ is surjective. \n\n\nIf $N \\to M$ is a module map, $N/IN \\to M/IM$ is surjective, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $N \\to M$ is surjective. \n\n\nIf $x_1, \\ldots , x_ n \\in M$ generate $M/IM$ and $M$ is finite, then there exists an $f \\in 1 + I$ such that $x_1, \\ldots , x_ n$ generate $M_ f$ over $R_ f$. \n\n\nIf $x_1, \\ldots , x_ n \\in M$ generate $M/IM$, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $M$ is generated by $x_1, \\ldots , x_ n$. \n\n\nIf $IM = M$, $I$ is nilpotent, then $M = 0$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, and $I$ is nilpotent then $M = N$. \n\n\nIf $N \\to M$ is a module map, $I$ is nilpotent, and $N/IN \\to M/IM$ is surjective, then $N \\to M$ is surjective. \n\n\nIf $\\{ x_\\alpha \\} _{\\alpha \\in A}$ is a set of elements of $M$ which generate $M/IM$ and $I$ is nilpotent, then $M$ is generated by the $x_\\alpha $. \n\n\n\n\n    \n      Proof.\n      Proof of (1). Choose generators $y_1, \\ldots , y_ m$ of $M$ over $R$. For each $i$ we can write $y_ i = \\sum z_{ij} y_ j$ with $z_{ij} \\in I$ (since $M = IM$). In other words $\\sum _ j (\\delta _{ij} - z_{ij})y_ j = 0$. Let $f$ be the determinant of the $m \\times m$ matrix $A = (\\delta _{ij} - z_{ij})$. Note that $f \\in 1 + I$ (since the matrix $A$ is entrywise congruent to the $m \\times m$ identity matrix modulo $I$). By Lemma 10.15.5 (1), there exists an $m \\times m$ matrix $B$ such that $BA = f 1_{m \\times m}$. Writing out we see that $\\sum _{i} b_{hi} a_{ij} = f \\delta _{hj}$ for all $h$ and $j$; hence, $\\sum _{i, j} b_{hi} a_{ij} y_ j = \\sum _{j} f \\delta _{hj} y_ j = f y_ h$ for every $h$. In other words, $0 = f y_ h$ for every $h$ (since each $i$ satisfies $\\sum _ j a_{ij} y_ j = 0$). This implies that $f$ annihilates $M$. \n    \n      By Lemma 10.19.1 an element of $1 + \\text{rad}(R)$ is invertible element of $R$. Hence we see that (1) implies (2). We obtain (3) by applying (1) to $M/N$ which is finite as $N\'$ is finite. We obtain (4) by applying (2) to $M/N$ which is finite as $N\'$ is finite. We obtain (5) by applying (3) to $M$ and the submodules $\\mathop{\\mathrm{Im}}(N \\to M)$ and $M$. We obtain (6) by applying (4) to $M$ and the submodules $\\mathop{\\mathrm{Im}}(N \\to M)$ and $M$. We obtain (7) by applying (5) to the map $R^{\\oplus n} \\to M$, $(a_1, \\ldots , a_ n) \\mapsto a_1x_1 + \\ldots + a_ nx_ n$. We obtain (8) by applying (6) to the map $R^{\\oplus n} \\to M$, $(a_1, \\ldots , a_ n) \\mapsto a_1x_1 + \\ldots + a_ nx_ n$. \n    \n      Part (9) holds because if $M = IM$ then $M = I^ nM$ for all $n \\geq 0$ and $I$ being nilpotent means $I^ n = 0$ for some $n \\gg 0$. Parts (10), (11), and (12) follow from (9) by the arguments used above. \n      $\\square$\n    \n","\n        \n      \n      \n  Lemma 10.20.1 (Nakayama\'s lemma). Let $R$ be a ring with Jacobson radical $\\text{rad}(R)$. Let $M$ be an $R$-module. Let $I \\subset R$ be an ideal. \n  \n  \n If $IM = M$ and $M$ is finite, then there exists an $f \\in 1 + I$ such that $fM = 0$. \n\n\nIf $IM = M$, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $M = 0$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, and $N\'$ is finite, then there exists an $f \\in 1 + I$ such that $fM \\subset N$ and $M_ f = N_ f$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, $N\'$ is finite, and $I \\subset \\text{rad}(R)$, then $M = N$. \n\n\nIf $N \\to M$ is a module map, $N/IN \\to M/IM$ is surjective, and $M$ is finite, then there exists an $f \\in 1 + I$ such that $N_ f \\to M_ f$ is surjective. \n\n\nIf $N \\to M$ is a module map, $N/IN \\to M/IM$ is surjective, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $N \\to M$ is surjective. \n\n\nIf $x_1, \\ldots , x_ n \\in M$ generate $M/IM$ and $M$ is finite, then there exists an $f \\in 1 + I$ such that $x_1, \\ldots , x_ n$ generate $M_ f$ over $R_ f$. \n\n\nIf $x_1, \\ldots , x_ n \\in M$ generate $M/IM$, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $M$ is generated by $x_1, \\ldots , x_ n$. \n\n\nIf $IM = M$, $I$ is nilpotent, then $M = 0$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, and $I$ is nilpotent then $M = N$. \n\n\nIf $N \\to M$ is a module map, $I$ is nilpotent, and $N/IN \\to M/IM$ is surjective, then $N \\to M$ is surjective. \n\n\nIf $\\{ x_\\alpha \\} _{\\alpha \\in A}$ is a set of elements of $M$ which generate $M/IM$ and $I$ is nilpotent, then $M$ is generated by the $x_\\alpha $. \n\n\n\n\n    \n","Proof.\n      Proof of (1). Choose generators $y_1, \\ldots , y_ m$ of $M$ over $R$. For each $i$ we can write $y_ i = \\sum z_{ij} y_ j$ with $z_{ij} \\in I$ (since $M = IM$). In other words $\\sum _ j (\\delta _{ij} - z_{ij})y_ j = 0$. Let $f$ be the determinant of the $m \\times m$ matrix $A = (\\delta _{ij} - z_{ij})$. Note that $f \\in 1 + I$ (since the matrix $A$ is entrywise congruent to the $m \\times m$ identity matrix modulo $I$). By Lemma 10.15.5 (1), there exists an $m \\times m$ matrix $B$ such that $BA = f 1_{m \\times m}$. Writing out we see that $\\sum _{i} b_{hi} a_{ij} = f \\delta _{hj}$ for all $h$ and $j$; hence, $\\sum _{i, j} b_{hi} a_{ij} y_ j = \\sum _{j} f \\delta _{hj} y_ j = f y_ h$ for every $h$. In other words, $0 = f y_ h$ for every $h$ (since each $i$ satisfies $\\sum _ j a_{ij} y_ j = 0$). This implies that $f$ annihilates $M$. \n    \n      By Lemma 10.19.1 an element of $1 + \\text{rad}(R)$ is invertible element of $R$. Hence we see that (1) implies (2). We obtain (3) by applying (1) to $M/N$ which is finite as $N\'$ is finite. We obtain (4) by applying (2) to $M/N$ which is finite as $N\'$ is finite. We obtain (5) by applying (3) to $M$ and the submodules $\\mathop{\\mathrm{Im}}(N \\to M)$ and $M$. We obtain (6) by applying (4) to $M$ and the submodules $\\mathop{\\mathrm{Im}}(N \\to M)$ and $M$. We obtain (7) by applying (5) to the map $R^{\\oplus n} \\to M$, $(a_1, \\ldots , a_ n) \\mapsto a_1x_1 + \\ldots + a_ nx_ n$. We obtain (8) by applying (6) to the map $R^{\\oplus n} \\to M$, $(a_1, \\ldots , a_ n) \\mapsto a_1x_1 + \\ldots + a_ nx_ n$. \n    \n      Part (9) holds because if $M = IM$ then $M = I^ nM$ for all $n \\geq 0$ and $I$ being nilpotent means $I^ n = 0$ for some $n \\gg 0$. Parts (10), (11), and (12) follow from (9) by the arguments used above. \n      $\\square$\n    \n","
  smul_le_right.trans (le_of_le_smul_of_le_jacobson_bot hN' hIJ hNN)
","theorem smul_le_of_le_smul_of_le_jacobson_bot {I : Ideal R} {N N' : Submodule R M} (hN' : N'.FG)
    (hIJ : I â‰¤ jacobson âŠ¥) (hNN : N' â‰¤ N âŠ” I â€¢ N') : I â€¢ N' â‰¤ N ","Proof.\n      Proof of (1). Choose generators $y_1, \\ldots , y_ m$ of $M$ over $R$. For each $i$ we can write $y_ i = \\sum z_{ij} y_ j$ with $z_{ij} \\in I$ (since $M = IM$). In other words $\\sum _ j (\\delta _{ij} - z_{ij})y_ j = 0$. Let $f$ be the determinant of the $m \\times m$ matrix $A = (\\delta _{ij} - z_{ij})$. Note that $f \\in 1 + I$ (since the matrix $A$ is entrywise congruent to the $m \\times m$ identity matrix modulo $I$). By Lemma 10.15.5 [[\n  Lemma 10.15.5. Let $R$ be a ring. Let $n \\geq m$. Let $A$ be an $n \\times m$ matrix with coefficients in $R$. Let $J \\subset R$ be the ideal generated by the $m \\times m$ minors of $A$. \n  \n  \nFor any $f \\in J$ there exists a $m \\times n$ matrix $B$ such that $BA = f 1_{m \\times m}$. \n\n\nIf $f \\in R$ and $BA = f 1_{m \\times m}$ for some $m \\times n$ matrix $B$, then $f^ m \\in J$. \n\n\n\n\n    \n]] (1), there exists an $m \\times m$ matrix $B$ such that $BA = f 1_{m \\times m}$. Writing out we see that $\\sum _{i} b_{hi} a_{ij} = f \\delta _{hj}$ for all $h$ and $j$; hence, $\\sum _{i, j} b_{hi} a_{ij} y_ j = \\sum _{j} f \\delta _{hj} y_ j = f y_ h$ for every $h$. In other words, $0 = f y_ h$ for every $h$ (since each $i$ satisfies $\\sum _ j a_{ij} y_ j = 0$). This implies that $f$ annihilates $M$. \n    \n      By Lemma 10.19.1 [[\n  Lemma 10.19.1. Let $R$ be a ring with Jacobson radical $\\text{rad}(R)$. Let $I \\subset R$ be an ideal. The following are equivalent \n  \n  \n$I \\subset \\text{rad}(R)$, and \n\n\nevery element of $1 + I$ is a unit in $R$. \n\n\n\n   In this case every element of $R$ which maps to a unit of $R/I$ is a unit. \n\n    \n]] an element of $1 + \\text{rad}(R)$ is invertible element of $R$. Hence we see that (1) implies (2). We obtain (3) by applying (1) to $M/N$ which is finite as $N\'$ is finite. We obtain (4) by applying (2) to $M/N$ which is finite as $N\'$ is finite. We obtain (5) by applying (3) to $M$ and the submodules $\\mathop{\\mathrm{Im}}(N \\to M)$ and $M$. We obtain (6) by applying (4) to $M$ and the submodules $\\mathop{\\mathrm{Im}}(N \\to M)$ and $M$. We obtain (7) by applying (5) to the map $R^{\\oplus n} \\to M$, $(a_1, \\ldots , a_ n) \\mapsto a_1x_1 + \\ldots + a_ nx_ n$. We obtain (8) by applying (6) to the map $R^{\\oplus n} \\to M$, $(a_1, \\ldots , a_ n) \\mapsto a_1x_1 + \\ldots + a_ nx_ n$. \n    \n      Part (9) holds because if $M = IM$ then $M = I^ nM$ for all $n \\geq 0$ and $I$ being nilpotent means $I^ n = 0$ for some $n \\gg 0$. Parts (10), (11), and (12) follow from (9) by the arguments used above. \n      $\\square$\n    \n"
231,00DV,"lemma exists_sub_one_mem_and_smul_le_of_fg_of_le_sup {I : Ideal R}
    {N N' P : Submodule R M} (hN' : N'.FG) (hN'le : N' â‰¤ P) (hNN' : P â‰¤ N âŠ” I â€¢ N') :
    âˆƒ r : R, r - 1 âˆˆ I âˆ§ r â€¢ P â‰¤ N := by
  have hNN'' : P â‰¤ N âŠ” N' := le_trans hNN' (by simpa using le_trans smul_le_right le_sup_right)
  have h1 : P.map N.mkQ = N'.map N.mkQ := by
    refine le_antisymm ?_ (map_mono hN'le)
    simpa using map_mono (f := N.mkQ) hNN''
  have h2 : P.map N.mkQ = (I â€¢ N').map N.mkQ := by
    apply le_antisymm
    Â· simpa using map_mono (f := N.mkQ) hNN'
    Â· rw [h1]
      simp [smul_le_right]
  have hle : (P.map N.mkQ) â‰¤ I â€¢ P.map N.mkQ := by
    conv_lhs => rw [h2]
    simp [â† h1]
  obtain âŸ¨r, hmem, hrâŸ© := exists_sub_one_mem_and_smul_eq_zero_of_fg_of_le_smul I _
    (h1 â–¸ hN'.map _) hle
  refine âŸ¨r, hmem, fun x hx â†¦ ?_âŸ©
  induction hx using Submodule.smul_inductionOn_pointwise with
  | smulâ‚€ p hp =>
    rw [â† Submodule.Quotient.mk_eq_zero, Quotient.mk_smul]
    exact hr _ âŸ¨p, hp, rflâŸ©
  | smulâ‚ _ _ _ h => exact N.smul_mem _ h
  | add _ _ _ _ hx hy => exact N.add_mem hx hy
  | zero => exact N.zero_mem
",Formal Proof of Stacks Project Tag 00DV,(3) see `Submodule.localizedâ‚€_le_localizedâ‚€_of_smul_le` for the second conclusion.,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Nakayama.lean#L162-L186,Q27041,Nakayama's lemma,10.20.1,lemma,3.0,"['07RC', '00AO', '0ELQ']","\n        \n      \n      \n  Lemma 10.20.1 (Nakayama\'s lemma). Let $R$ be a ring with Jacobson radical $\\text{rad}(R)$. Let $M$ be an $R$-module. Let $I \\subset R$ be an ideal. \n  \n  \n If $IM = M$ and $M$ is finite, then there exists an $f \\in 1 + I$ such that $fM = 0$. \n\n\nIf $IM = M$, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $M = 0$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, and $N\'$ is finite, then there exists an $f \\in 1 + I$ such that $fM \\subset N$ and $M_ f = N_ f$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, $N\'$ is finite, and $I \\subset \\text{rad}(R)$, then $M = N$. \n\n\nIf $N \\to M$ is a module map, $N/IN \\to M/IM$ is surjective, and $M$ is finite, then there exists an $f \\in 1 + I$ such that $N_ f \\to M_ f$ is surjective. \n\n\nIf $N \\to M$ is a module map, $N/IN \\to M/IM$ is surjective, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $N \\to M$ is surjective. \n\n\nIf $x_1, \\ldots , x_ n \\in M$ generate $M/IM$ and $M$ is finite, then there exists an $f \\in 1 + I$ such that $x_1, \\ldots , x_ n$ generate $M_ f$ over $R_ f$. \n\n\nIf $x_1, \\ldots , x_ n \\in M$ generate $M/IM$, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $M$ is generated by $x_1, \\ldots , x_ n$. \n\n\nIf $IM = M$, $I$ is nilpotent, then $M = 0$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, and $I$ is nilpotent then $M = N$. \n\n\nIf $N \\to M$ is a module map, $I$ is nilpotent, and $N/IN \\to M/IM$ is surjective, then $N \\to M$ is surjective. \n\n\nIf $\\{ x_\\alpha \\} _{\\alpha \\in A}$ is a set of elements of $M$ which generate $M/IM$ and $I$ is nilpotent, then $M$ is generated by the $x_\\alpha $. \n\n\n\n\n    \n      Proof.\n      Proof of (1). Choose generators $y_1, \\ldots , y_ m$ of $M$ over $R$. For each $i$ we can write $y_ i = \\sum z_{ij} y_ j$ with $z_{ij} \\in I$ (since $M = IM$). In other words $\\sum _ j (\\delta _{ij} - z_{ij})y_ j = 0$. Let $f$ be the determinant of the $m \\times m$ matrix $A = (\\delta _{ij} - z_{ij})$. Note that $f \\in 1 + I$ (since the matrix $A$ is entrywise congruent to the $m \\times m$ identity matrix modulo $I$). By Lemma 10.15.5 (1), there exists an $m \\times m$ matrix $B$ such that $BA = f 1_{m \\times m}$. Writing out we see that $\\sum _{i} b_{hi} a_{ij} = f \\delta _{hj}$ for all $h$ and $j$; hence, $\\sum _{i, j} b_{hi} a_{ij} y_ j = \\sum _{j} f \\delta _{hj} y_ j = f y_ h$ for every $h$. In other words, $0 = f y_ h$ for every $h$ (since each $i$ satisfies $\\sum _ j a_{ij} y_ j = 0$). This implies that $f$ annihilates $M$. \n    \n      By Lemma 10.19.1 an element of $1 + \\text{rad}(R)$ is invertible element of $R$. Hence we see that (1) implies (2). We obtain (3) by applying (1) to $M/N$ which is finite as $N\'$ is finite. We obtain (4) by applying (2) to $M/N$ which is finite as $N\'$ is finite. We obtain (5) by applying (3) to $M$ and the submodules $\\mathop{\\mathrm{Im}}(N \\to M)$ and $M$. We obtain (6) by applying (4) to $M$ and the submodules $\\mathop{\\mathrm{Im}}(N \\to M)$ and $M$. We obtain (7) by applying (5) to the map $R^{\\oplus n} \\to M$, $(a_1, \\ldots , a_ n) \\mapsto a_1x_1 + \\ldots + a_ nx_ n$. We obtain (8) by applying (6) to the map $R^{\\oplus n} \\to M$, $(a_1, \\ldots , a_ n) \\mapsto a_1x_1 + \\ldots + a_ nx_ n$. \n    \n      Part (9) holds because if $M = IM$ then $M = I^ nM$ for all $n \\geq 0$ and $I$ being nilpotent means $I^ n = 0$ for some $n \\gg 0$. Parts (10), (11), and (12) follow from (9) by the arguments used above. \n      $\\square$\n    \n","\n        \n      \n      \n  Lemma 10.20.1 (Nakayama\'s lemma). Let $R$ be a ring with Jacobson radical $\\text{rad}(R)$. Let $M$ be an $R$-module. Let $I \\subset R$ be an ideal. \n  \n  \n If $IM = M$ and $M$ is finite, then there exists an $f \\in 1 + I$ such that $fM = 0$. \n\n\nIf $IM = M$, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $M = 0$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, and $N\'$ is finite, then there exists an $f \\in 1 + I$ such that $fM \\subset N$ and $M_ f = N_ f$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, $N\'$ is finite, and $I \\subset \\text{rad}(R)$, then $M = N$. \n\n\nIf $N \\to M$ is a module map, $N/IN \\to M/IM$ is surjective, and $M$ is finite, then there exists an $f \\in 1 + I$ such that $N_ f \\to M_ f$ is surjective. \n\n\nIf $N \\to M$ is a module map, $N/IN \\to M/IM$ is surjective, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $N \\to M$ is surjective. \n\n\nIf $x_1, \\ldots , x_ n \\in M$ generate $M/IM$ and $M$ is finite, then there exists an $f \\in 1 + I$ such that $x_1, \\ldots , x_ n$ generate $M_ f$ over $R_ f$. \n\n\nIf $x_1, \\ldots , x_ n \\in M$ generate $M/IM$, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $M$ is generated by $x_1, \\ldots , x_ n$. \n\n\nIf $IM = M$, $I$ is nilpotent, then $M = 0$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, and $I$ is nilpotent then $M = N$. \n\n\nIf $N \\to M$ is a module map, $I$ is nilpotent, and $N/IN \\to M/IM$ is surjective, then $N \\to M$ is surjective. \n\n\nIf $\\{ x_\\alpha \\} _{\\alpha \\in A}$ is a set of elements of $M$ which generate $M/IM$ and $I$ is nilpotent, then $M$ is generated by the $x_\\alpha $. \n\n\n\n\n    \n","Proof.\n      Proof of (1). Choose generators $y_1, \\ldots , y_ m$ of $M$ over $R$. For each $i$ we can write $y_ i = \\sum z_{ij} y_ j$ with $z_{ij} \\in I$ (since $M = IM$). In other words $\\sum _ j (\\delta _{ij} - z_{ij})y_ j = 0$. Let $f$ be the determinant of the $m \\times m$ matrix $A = (\\delta _{ij} - z_{ij})$. Note that $f \\in 1 + I$ (since the matrix $A$ is entrywise congruent to the $m \\times m$ identity matrix modulo $I$). By Lemma 10.15.5 (1), there exists an $m \\times m$ matrix $B$ such that $BA = f 1_{m \\times m}$. Writing out we see that $\\sum _{i} b_{hi} a_{ij} = f \\delta _{hj}$ for all $h$ and $j$; hence, $\\sum _{i, j} b_{hi} a_{ij} y_ j = \\sum _{j} f \\delta _{hj} y_ j = f y_ h$ for every $h$. In other words, $0 = f y_ h$ for every $h$ (since each $i$ satisfies $\\sum _ j a_{ij} y_ j = 0$). This implies that $f$ annihilates $M$. \n    \n      By Lemma 10.19.1 an element of $1 + \\text{rad}(R)$ is invertible element of $R$. Hence we see that (1) implies (2). We obtain (3) by applying (1) to $M/N$ which is finite as $N\'$ is finite. We obtain (4) by applying (2) to $M/N$ which is finite as $N\'$ is finite. We obtain (5) by applying (3) to $M$ and the submodules $\\mathop{\\mathrm{Im}}(N \\to M)$ and $M$. We obtain (6) by applying (4) to $M$ and the submodules $\\mathop{\\mathrm{Im}}(N \\to M)$ and $M$. We obtain (7) by applying (5) to the map $R^{\\oplus n} \\to M$, $(a_1, \\ldots , a_ n) \\mapsto a_1x_1 + \\ldots + a_ nx_ n$. We obtain (8) by applying (6) to the map $R^{\\oplus n} \\to M$, $(a_1, \\ldots , a_ n) \\mapsto a_1x_1 + \\ldots + a_ nx_ n$. \n    \n      Part (9) holds because if $M = IM$ then $M = I^ nM$ for all $n \\geq 0$ and $I$ being nilpotent means $I^ n = 0$ for some $n \\gg 0$. Parts (10), (11), and (12) follow from (9) by the arguments used above. \n      $\\square$\n    \n"," by
  have hNN'' : P â‰¤ N âŠ” N' := le_trans hNN' (by simpa using le_trans smul_le_right le_sup_right)
  have h1 : P.map N.mkQ = N'.map N.mkQ := by
    refine le_antisymm ?_ (map_mono hN'le)
    simpa using map_mono (f := N.mkQ) hNN''
  have h2 : P.map N.mkQ = (I â€¢ N').map N.mkQ := by
    apply le_antisymm
    Â· simpa using map_mono (f := N.mkQ) hNN'
    Â· rw [h1]
      simp [smul_le_right]
  have hle : (P.map N.mkQ) â‰¤ I â€¢ P.map N.mkQ := by
    conv_lhs => rw [h2]
    simp [â† h1]
  obtain âŸ¨r, hmem, hrâŸ© := exists_sub_one_mem_and_smul_eq_zero_of_fg_of_le_smul I _
    (h1 â–¸ hN'.map _) hle
  refine âŸ¨r, hmem, fun x hx â†¦ ?_âŸ©
  induction hx using Submodule.smul_inductionOn_pointwise with
  | smulâ‚€ p hp =>
    rw [â† Submodule.Quotient.mk_eq_zero, Quotient.mk_smul]
    exact hr _ âŸ¨p, hp, rflâŸ©
  | smulâ‚ _ _ _ h => exact N.smul_mem _ h
  | add _ _ _ _ hx hy => exact N.add_mem hx hy
  | zero => exact N.zero_mem
","lemma exists_sub_one_mem_and_smul_le_of_fg_of_le_sup {I : Ideal R}
    {N N' P : Submodule R M} (hN' : N'.FG) (hN'le : N' â‰¤ P) (hNN' : P â‰¤ N âŠ” I â€¢ N') :
    âˆƒ r : R, r - 1 âˆˆ I âˆ§ r â€¢ P â‰¤ N ","Proof.\n      Proof of (1). Choose generators $y_1, \\ldots , y_ m$ of $M$ over $R$. For each $i$ we can write $y_ i = \\sum z_{ij} y_ j$ with $z_{ij} \\in I$ (since $M = IM$). In other words $\\sum _ j (\\delta _{ij} - z_{ij})y_ j = 0$. Let $f$ be the determinant of the $m \\times m$ matrix $A = (\\delta _{ij} - z_{ij})$. Note that $f \\in 1 + I$ (since the matrix $A$ is entrywise congruent to the $m \\times m$ identity matrix modulo $I$). By Lemma 10.15.5 [[\n  Lemma 10.15.5. Let $R$ be a ring. Let $n \\geq m$. Let $A$ be an $n \\times m$ matrix with coefficients in $R$. Let $J \\subset R$ be the ideal generated by the $m \\times m$ minors of $A$. \n  \n  \nFor any $f \\in J$ there exists a $m \\times n$ matrix $B$ such that $BA = f 1_{m \\times m}$. \n\n\nIf $f \\in R$ and $BA = f 1_{m \\times m}$ for some $m \\times n$ matrix $B$, then $f^ m \\in J$. \n\n\n\n\n    \n]] (1), there exists an $m \\times m$ matrix $B$ such that $BA = f 1_{m \\times m}$. Writing out we see that $\\sum _{i} b_{hi} a_{ij} = f \\delta _{hj}$ for all $h$ and $j$; hence, $\\sum _{i, j} b_{hi} a_{ij} y_ j = \\sum _{j} f \\delta _{hj} y_ j = f y_ h$ for every $h$. In other words, $0 = f y_ h$ for every $h$ (since each $i$ satisfies $\\sum _ j a_{ij} y_ j = 0$). This implies that $f$ annihilates $M$. \n    \n      By Lemma 10.19.1 [[\n  Lemma 10.19.1. Let $R$ be a ring with Jacobson radical $\\text{rad}(R)$. Let $I \\subset R$ be an ideal. The following are equivalent \n  \n  \n$I \\subset \\text{rad}(R)$, and \n\n\nevery element of $1 + I$ is a unit in $R$. \n\n\n\n   In this case every element of $R$ which maps to a unit of $R/I$ is a unit. \n\n    \n]] an element of $1 + \\text{rad}(R)$ is invertible element of $R$. Hence we see that (1) implies (2). We obtain (3) by applying (1) to $M/N$ which is finite as $N\'$ is finite. We obtain (4) by applying (2) to $M/N$ which is finite as $N\'$ is finite. We obtain (5) by applying (3) to $M$ and the submodules $\\mathop{\\mathrm{Im}}(N \\to M)$ and $M$. We obtain (6) by applying (4) to $M$ and the submodules $\\mathop{\\mathrm{Im}}(N \\to M)$ and $M$. We obtain (7) by applying (5) to the map $R^{\\oplus n} \\to M$, $(a_1, \\ldots , a_ n) \\mapsto a_1x_1 + \\ldots + a_ nx_ n$. We obtain (8) by applying (6) to the map $R^{\\oplus n} \\to M$, $(a_1, \\ldots , a_ n) \\mapsto a_1x_1 + \\ldots + a_ nx_ n$. \n    \n      Part (9) holds because if $M = IM$ then $M = I^ nM$ for all $n \\geq 0$ and $I$ being nilpotent means $I^ n = 0$ for some $n \\gg 0$. Parts (10), (11), and (12) follow from (9) by the arguments used above. \n      $\\square$\n    \n"
232,00DV,"theorem exists_injOn_mkQ_image_span_eq_of_span_eq_map_mkQ_of_le_jacobson_bot
    {I : Ideal R} {N : Submodule R M} (s : Set (M â§¸ (I â€¢ N)))
    (hN : N.FG) (hIjac : I â‰¤ jacobson âŠ¥) (hsspan : span R s = map (I â€¢ N).mkQ N) :
    âˆƒ (t : Set M), t.InjOn (I â€¢ N).mkQ âˆ§ (I â€¢ N).mkQ '' t = s âˆ§ span R t = N := by
  use Quotient.out '' s
  split_ands
  Â· simp [Set.InjOn]
  Â· simp [Set.image_image]
  Â· symm; apply eq_of_map_mkQ_eq_map_mkQ_of_le_jacobson_bot hN hIjac
    simp [â† hsspan, map_span, Set.image_image]
",Formal Proof of Stacks Project Tag 00DV,(8),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Nakayama.lean#L220-L229,Q27041,Nakayama's lemma,10.20.1,lemma,3.0,"['07RC', '00AO', '0ELQ']","\n        \n      \n      \n  Lemma 10.20.1 (Nakayama\'s lemma). Let $R$ be a ring with Jacobson radical $\\text{rad}(R)$. Let $M$ be an $R$-module. Let $I \\subset R$ be an ideal. \n  \n  \n If $IM = M$ and $M$ is finite, then there exists an $f \\in 1 + I$ such that $fM = 0$. \n\n\nIf $IM = M$, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $M = 0$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, and $N\'$ is finite, then there exists an $f \\in 1 + I$ such that $fM \\subset N$ and $M_ f = N_ f$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, $N\'$ is finite, and $I \\subset \\text{rad}(R)$, then $M = N$. \n\n\nIf $N \\to M$ is a module map, $N/IN \\to M/IM$ is surjective, and $M$ is finite, then there exists an $f \\in 1 + I$ such that $N_ f \\to M_ f$ is surjective. \n\n\nIf $N \\to M$ is a module map, $N/IN \\to M/IM$ is surjective, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $N \\to M$ is surjective. \n\n\nIf $x_1, \\ldots , x_ n \\in M$ generate $M/IM$ and $M$ is finite, then there exists an $f \\in 1 + I$ such that $x_1, \\ldots , x_ n$ generate $M_ f$ over $R_ f$. \n\n\nIf $x_1, \\ldots , x_ n \\in M$ generate $M/IM$, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $M$ is generated by $x_1, \\ldots , x_ n$. \n\n\nIf $IM = M$, $I$ is nilpotent, then $M = 0$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, and $I$ is nilpotent then $M = N$. \n\n\nIf $N \\to M$ is a module map, $I$ is nilpotent, and $N/IN \\to M/IM$ is surjective, then $N \\to M$ is surjective. \n\n\nIf $\\{ x_\\alpha \\} _{\\alpha \\in A}$ is a set of elements of $M$ which generate $M/IM$ and $I$ is nilpotent, then $M$ is generated by the $x_\\alpha $. \n\n\n\n\n    \n      Proof.\n      Proof of (1). Choose generators $y_1, \\ldots , y_ m$ of $M$ over $R$. For each $i$ we can write $y_ i = \\sum z_{ij} y_ j$ with $z_{ij} \\in I$ (since $M = IM$). In other words $\\sum _ j (\\delta _{ij} - z_{ij})y_ j = 0$. Let $f$ be the determinant of the $m \\times m$ matrix $A = (\\delta _{ij} - z_{ij})$. Note that $f \\in 1 + I$ (since the matrix $A$ is entrywise congruent to the $m \\times m$ identity matrix modulo $I$). By Lemma 10.15.5 (1), there exists an $m \\times m$ matrix $B$ such that $BA = f 1_{m \\times m}$. Writing out we see that $\\sum _{i} b_{hi} a_{ij} = f \\delta _{hj}$ for all $h$ and $j$; hence, $\\sum _{i, j} b_{hi} a_{ij} y_ j = \\sum _{j} f \\delta _{hj} y_ j = f y_ h$ for every $h$. In other words, $0 = f y_ h$ for every $h$ (since each $i$ satisfies $\\sum _ j a_{ij} y_ j = 0$). This implies that $f$ annihilates $M$. \n    \n      By Lemma 10.19.1 an element of $1 + \\text{rad}(R)$ is invertible element of $R$. Hence we see that (1) implies (2). We obtain (3) by applying (1) to $M/N$ which is finite as $N\'$ is finite. We obtain (4) by applying (2) to $M/N$ which is finite as $N\'$ is finite. We obtain (5) by applying (3) to $M$ and the submodules $\\mathop{\\mathrm{Im}}(N \\to M)$ and $M$. We obtain (6) by applying (4) to $M$ and the submodules $\\mathop{\\mathrm{Im}}(N \\to M)$ and $M$. We obtain (7) by applying (5) to the map $R^{\\oplus n} \\to M$, $(a_1, \\ldots , a_ n) \\mapsto a_1x_1 + \\ldots + a_ nx_ n$. We obtain (8) by applying (6) to the map $R^{\\oplus n} \\to M$, $(a_1, \\ldots , a_ n) \\mapsto a_1x_1 + \\ldots + a_ nx_ n$. \n    \n      Part (9) holds because if $M = IM$ then $M = I^ nM$ for all $n \\geq 0$ and $I$ being nilpotent means $I^ n = 0$ for some $n \\gg 0$. Parts (10), (11), and (12) follow from (9) by the arguments used above. \n      $\\square$\n    \n","\n        \n      \n      \n  Lemma 10.20.1 (Nakayama\'s lemma). Let $R$ be a ring with Jacobson radical $\\text{rad}(R)$. Let $M$ be an $R$-module. Let $I \\subset R$ be an ideal. \n  \n  \n If $IM = M$ and $M$ is finite, then there exists an $f \\in 1 + I$ such that $fM = 0$. \n\n\nIf $IM = M$, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $M = 0$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, and $N\'$ is finite, then there exists an $f \\in 1 + I$ such that $fM \\subset N$ and $M_ f = N_ f$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, $N\'$ is finite, and $I \\subset \\text{rad}(R)$, then $M = N$. \n\n\nIf $N \\to M$ is a module map, $N/IN \\to M/IM$ is surjective, and $M$ is finite, then there exists an $f \\in 1 + I$ such that $N_ f \\to M_ f$ is surjective. \n\n\nIf $N \\to M$ is a module map, $N/IN \\to M/IM$ is surjective, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $N \\to M$ is surjective. \n\n\nIf $x_1, \\ldots , x_ n \\in M$ generate $M/IM$ and $M$ is finite, then there exists an $f \\in 1 + I$ such that $x_1, \\ldots , x_ n$ generate $M_ f$ over $R_ f$. \n\n\nIf $x_1, \\ldots , x_ n \\in M$ generate $M/IM$, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $M$ is generated by $x_1, \\ldots , x_ n$. \n\n\nIf $IM = M$, $I$ is nilpotent, then $M = 0$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, and $I$ is nilpotent then $M = N$. \n\n\nIf $N \\to M$ is a module map, $I$ is nilpotent, and $N/IN \\to M/IM$ is surjective, then $N \\to M$ is surjective. \n\n\nIf $\\{ x_\\alpha \\} _{\\alpha \\in A}$ is a set of elements of $M$ which generate $M/IM$ and $I$ is nilpotent, then $M$ is generated by the $x_\\alpha $. \n\n\n\n\n    \n","Proof.\n      Proof of (1). Choose generators $y_1, \\ldots , y_ m$ of $M$ over $R$. For each $i$ we can write $y_ i = \\sum z_{ij} y_ j$ with $z_{ij} \\in I$ (since $M = IM$). In other words $\\sum _ j (\\delta _{ij} - z_{ij})y_ j = 0$. Let $f$ be the determinant of the $m \\times m$ matrix $A = (\\delta _{ij} - z_{ij})$. Note that $f \\in 1 + I$ (since the matrix $A$ is entrywise congruent to the $m \\times m$ identity matrix modulo $I$). By Lemma 10.15.5 (1), there exists an $m \\times m$ matrix $B$ such that $BA = f 1_{m \\times m}$. Writing out we see that $\\sum _{i} b_{hi} a_{ij} = f \\delta _{hj}$ for all $h$ and $j$; hence, $\\sum _{i, j} b_{hi} a_{ij} y_ j = \\sum _{j} f \\delta _{hj} y_ j = f y_ h$ for every $h$. In other words, $0 = f y_ h$ for every $h$ (since each $i$ satisfies $\\sum _ j a_{ij} y_ j = 0$). This implies that $f$ annihilates $M$. \n    \n      By Lemma 10.19.1 an element of $1 + \\text{rad}(R)$ is invertible element of $R$. Hence we see that (1) implies (2). We obtain (3) by applying (1) to $M/N$ which is finite as $N\'$ is finite. We obtain (4) by applying (2) to $M/N$ which is finite as $N\'$ is finite. We obtain (5) by applying (3) to $M$ and the submodules $\\mathop{\\mathrm{Im}}(N \\to M)$ and $M$. We obtain (6) by applying (4) to $M$ and the submodules $\\mathop{\\mathrm{Im}}(N \\to M)$ and $M$. We obtain (7) by applying (5) to the map $R^{\\oplus n} \\to M$, $(a_1, \\ldots , a_ n) \\mapsto a_1x_1 + \\ldots + a_ nx_ n$. We obtain (8) by applying (6) to the map $R^{\\oplus n} \\to M$, $(a_1, \\ldots , a_ n) \\mapsto a_1x_1 + \\ldots + a_ nx_ n$. \n    \n      Part (9) holds because if $M = IM$ then $M = I^ nM$ for all $n \\geq 0$ and $I$ being nilpotent means $I^ n = 0$ for some $n \\gg 0$. Parts (10), (11), and (12) follow from (9) by the arguments used above. \n      $\\square$\n    \n"," by
  use Quotient.out '' s
  split_ands
  Â· simp [Set.InjOn]
  Â· simp [Set.image_image]
  Â· symm; apply eq_of_map_mkQ_eq_map_mkQ_of_le_jacobson_bot hN hIjac
    simp [â† hsspan, map_span, Set.image_image]
","theorem exists_injOn_mkQ_image_span_eq_of_span_eq_map_mkQ_of_le_jacobson_bot
    {I : Ideal R} {N : Submodule R M} (s : Set (M â§¸ (I â€¢ N)))
    (hN : N.FG) (hIjac : I â‰¤ jacobson âŠ¥) (hsspan : span R s = map (I â€¢ N).mkQ N) :
    âˆƒ (t : Set M), t.InjOn (I â€¢ N).mkQ âˆ§ (I â€¢ N).mkQ '' t = s âˆ§ span R t = N ","Proof.\n      Proof of (1). Choose generators $y_1, \\ldots , y_ m$ of $M$ over $R$. For each $i$ we can write $y_ i = \\sum z_{ij} y_ j$ with $z_{ij} \\in I$ (since $M = IM$). In other words $\\sum _ j (\\delta _{ij} - z_{ij})y_ j = 0$. Let $f$ be the determinant of the $m \\times m$ matrix $A = (\\delta _{ij} - z_{ij})$. Note that $f \\in 1 + I$ (since the matrix $A$ is entrywise congruent to the $m \\times m$ identity matrix modulo $I$). By Lemma 10.15.5 [[\n  Lemma 10.15.5. Let $R$ be a ring. Let $n \\geq m$. Let $A$ be an $n \\times m$ matrix with coefficients in $R$. Let $J \\subset R$ be the ideal generated by the $m \\times m$ minors of $A$. \n  \n  \nFor any $f \\in J$ there exists a $m \\times n$ matrix $B$ such that $BA = f 1_{m \\times m}$. \n\n\nIf $f \\in R$ and $BA = f 1_{m \\times m}$ for some $m \\times n$ matrix $B$, then $f^ m \\in J$. \n\n\n\n\n    \n]] (1), there exists an $m \\times m$ matrix $B$ such that $BA = f 1_{m \\times m}$. Writing out we see that $\\sum _{i} b_{hi} a_{ij} = f \\delta _{hj}$ for all $h$ and $j$; hence, $\\sum _{i, j} b_{hi} a_{ij} y_ j = \\sum _{j} f \\delta _{hj} y_ j = f y_ h$ for every $h$. In other words, $0 = f y_ h$ for every $h$ (since each $i$ satisfies $\\sum _ j a_{ij} y_ j = 0$). This implies that $f$ annihilates $M$. \n    \n      By Lemma 10.19.1 [[\n  Lemma 10.19.1. Let $R$ be a ring with Jacobson radical $\\text{rad}(R)$. Let $I \\subset R$ be an ideal. The following are equivalent \n  \n  \n$I \\subset \\text{rad}(R)$, and \n\n\nevery element of $1 + I$ is a unit in $R$. \n\n\n\n   In this case every element of $R$ which maps to a unit of $R/I$ is a unit. \n\n    \n]] an element of $1 + \\text{rad}(R)$ is invertible element of $R$. Hence we see that (1) implies (2). We obtain (3) by applying (1) to $M/N$ which is finite as $N\'$ is finite. We obtain (4) by applying (2) to $M/N$ which is finite as $N\'$ is finite. We obtain (5) by applying (3) to $M$ and the submodules $\\mathop{\\mathrm{Im}}(N \\to M)$ and $M$. We obtain (6) by applying (4) to $M$ and the submodules $\\mathop{\\mathrm{Im}}(N \\to M)$ and $M$. We obtain (7) by applying (5) to the map $R^{\\oplus n} \\to M$, $(a_1, \\ldots , a_ n) \\mapsto a_1x_1 + \\ldots + a_ nx_ n$. We obtain (8) by applying (6) to the map $R^{\\oplus n} \\to M$, $(a_1, \\ldots , a_ n) \\mapsto a_1x_1 + \\ldots + a_ nx_ n$. \n    \n      Part (9) holds because if $M = IM$ then $M = I^ nM$ for all $n \\geq 0$ and $I$ being nilpotent means $I^ n = 0$ for some $n \\gg 0$. Parts (10), (11), and (12) follow from (9) by the arguments used above. \n      $\\square$\n    \n"
233,00OW,"theorem exists_integral_inj_algHom_of_fg : âˆƒ s, âˆƒ g : (MvPolynomial (Fin s) k) â†’â‚[k] R,
    Function.Injective g âˆ§ g.IsIntegral := by
  obtain âŸ¨n, f, fsurjâŸ© := Algebra.FiniteType.iff_quotient_mvPolynomial''.mp fin
  set Ï• := quotientKerAlgEquivOfSurjective fsurj
  obtain âŸ¨s, _, g, injg, intgâŸ© := exists_integral_inj_algHom_of_quotient (ker f) (ker_ne_top _)
  use s, Ï•.toAlgHom.comp g
  simp only [AlgEquiv.toAlgHom_eq_coe, AlgHom.coe_comp, AlgHom.coe_coe,
    EmbeddingLike.comp_injective, AlgHom.toRingHom_eq_coe]
  exact âŸ¨injg, intg.trans _ _ (isIntegral_of_surjective _ Ï•.surjective)âŸ©
",Formal Proof of Stacks Project Tag 00OW,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/NoetherNormalization.lean#L275-L283,Q27041,Noether normalization,10.115,section,2.0,"['00AO', '0ELQ']","10.115 Noether normalization\n\n\nIn this section we prove variants of the Noether normalization lemma. The key ingredient we will use is contained in the following two lemmas. \n\n\n\n  Lemma 10.115.1. Let $n \\in \\mathbf{N}$. Let $N$ be a finite nonempty set of multi-indices $\\nu = (\\nu _1, \\ldots , \\nu _ n)$. Given $e = (e_1, \\ldots , e_ n)$ we set $e \\cdot \\nu = \\sum e_ i\\nu _ i$. Then for $e_1 \\gg e_2 \\gg \\ldots \\gg e_{n-1} \\gg e_ n$ we have: If $\\nu , \\nu \' \\in N$ then \n  \n  \\[  (e \\cdot \\nu = e \\cdot \\nu \') \\Leftrightarrow (\\nu = \\nu \')  \\]\n\n \n\n\n    \n      Proof.\n      Say $N = \\{ \\nu _ j\\} $ with $\\nu _ j = (\\nu _{j1}, \\ldots , \\nu _{jn})$. Let $A_ i = \\max _ j \\nu _{ji} - \\min _ j \\nu _{ji}$. If for each $i$ we have $e_{i - 1} > A_ ie_ i + A_{i + 1}e_{i + 1} + \\ldots + A_ ne_ n$ then the lemma holds. For suppose that $e \\cdot (\\nu - \\nu \') = 0$. Then for $n \\ge 2$, \n    \n      \n  \\[  e_1(\\nu _1 - \\nu \'_1) = \\sum \\nolimits _{i = 2}^ n e_ i(\\nu \'_ i - \\nu _ i).  \\]\n\n    \n       We may assume that $(\\nu _1 - \\nu \'_1) \\ge 0$. If $(\\nu _1 - \\nu \'_1) > 0$, then \n    \n      \n  \\[  e_1(\\nu _1 - \\nu \'_1) \\ge e_1 > A_2e_2 + \\ldots + A_ ne_ n \\ge \\sum \\nolimits _{i = 2}^ n e_ i|\\nu \'_ i - \\nu _ i| \\ge \\sum \\nolimits _{i = 2}^ n e_ i(\\nu \'_ i - \\nu _ i).  \\]\n\n    \n       This contradiction implies that $\\nu \'_1 = \\nu _1$. By induction, $\\nu \'_ i = \\nu _ i$ for $2 \\le i \\le n$. \n      $\\square$\n    \n\n\n\n  Lemma 10.115.2. Let $R$ be a ring. Let $g \\in R[x_1, \\ldots , x_ n]$ be an element which is nonconstant, i.e., $g \\not\\in R$. For $e_1 \\gg e_2 \\gg \\ldots \\gg e_{n-1} \\gg e_ n = 1$ the polynomial \n  \n  \\[  g(x_1 + x_ n^{e_1}, x_2 + x_ n^{e_2}, \\ldots , x_{n - 1} + x_ n^{e_{n - 1}}, x_ n) = ax_ n^ d + \\text{lower order terms in }x_ n  \\]\n\n   where $d > 0$ and $a \\in R$ is one of the nonzero coefficients of $g$. \n \n\n\n    \n      Proof.\n      Write $g = \\sum _{\\nu \\in N} a_\\nu x^\\nu $ with $a_\\nu \\in R$ not zero. Here $N$ is a finite set of multi-indices as in Lemma 10.115.1 and $x^\\nu = x_1^{\\nu _1} \\ldots x_ n^{\\nu _ n}$. Note that the leading term in \n    \n      \n  \\[  (x_1 + x_ n^{e_1})^{\\nu _1} \\ldots (x_{n-1} + x_ n^{e_{n-1}})^{\\nu _{n-1}} x_ n^{\\nu _ n} \\quad \\text{is}\\quad x_ n^{e_1\\nu _1 + \\ldots + e_{n-1}\\nu _{n-1} + \\nu _ n}.  \\]\n\n    \n       Hence the lemma follows from Lemma 10.115.1 which guarantees that there is exactly one nonzero term $a_\\nu x^\\nu $ of $g$ which gives rise to the leading term of $g(x_1 + x_ n^{e_1}, x_2 + x_ n^{e_2}, \\ldots , x_{n - 1} + x_ n^{e_{n - 1}}, x_ n)$, i.e., $a = a_\\nu $ for the unique $\\nu \\in N$ such that $e \\cdot \\nu $ is maximal. \n      $\\square$\n    \n\n\n\n  Lemma 10.115.3. Let $k$ be a field. Let $S = k[x_1, \\ldots , x_ n]/I$ for some proper ideal $I$. If $I \\not= 0$, then there exist $y_1, \\ldots , y_{n-1} \\in k[x_1, \\ldots , x_ n]$ such that $S$ is finite over $k[y_1, \\ldots , y_{n-1}]$. Moreover we may choose $y_ i$ to be in the $\\mathbf{Z}$-subalgebra of $k[x_1, \\ldots , x_ n]$ generated by $x_1, \\ldots , x_ n$. \n \n\n\n    \n      Proof.\n      Pick $f \\in I$, $f\\not= 0$. It suffices to show the lemma for $k[x_1, \\ldots , x_ n]/(f)$ since $S$ is a quotient of that ring. We will take $y_ i = x_ i - x_ n^{e_ i}$, $i = 1, \\ldots , n-1$ for suitable integers $e_ i$. When does this work? It suffices to show that $\\overline{x_ n} \\in k[x_1, \\ldots , x_ n]/(f)$ is integral over the ring $k[y_1, \\ldots , y_{n-1}]$. The equation for $\\overline{x_ n}$ over this ring is \n    \n      \n  \\[  f(y_1 + x_ n^{e_1}, \\ldots , y_{n-1} + x_ n^{e_{n-1}}, x_ n) = 0.  \\]\n\n    \n       Hence we are done if we can show there exists integers $e_ i$ such that the leading coefficient with respect to $x_ n$ of the equation above is a nonzero element of $k$. This can be achieved for example by choosing $e_1 \\gg e_2 \\gg \\ldots \\gg e_{n-1}$, see Lemma 10.115.2. \n      $\\square$\n    \n\n\n\n       \n      \n  Lemma 10.115.4. Let $k$ be a field. Let $S = k[x_1, \\ldots , x_ n]/I$ for some ideal $I$. If $I \\neq (1)$, there exist $r\\geq 0$, and $y_1, \\ldots , y_ r \\in k[x_1, \\ldots , x_ n]$ such that (a) the map $k[y_1, \\ldots , y_ r] \\to S$ is injective where the source is the polynomial ring on $y_1, \\ldots , y_ r$, and (b) the map $k[y_1, \\ldots , y_ r] \\to S$ is finite. In this case the integer $r$ is the dimension of $S$. Moreover we may choose $y_ i$ to be in the $\\mathbf{Z}$-subalgebra of $k[x_1, \\ldots , x_ n]$ generated by $x_1, \\ldots , x_ n$. \n \n\n\n    \n      Proof.\n      By induction on $n$, with $n = 0$ being trivial. If $I = 0$, then take $r = n$ and $y_ i = x_ i$. If $I \\not= 0$, then choose $y_1, \\ldots , y_{n-1}$ as in Lemma 10.115.3. Let $S\' \\subset S$ be the subring generated by the images of the $y_ i$. By induction we can choose $r$ and $z_1, \\ldots , z_ r \\in k[y_1, \\ldots , y_{n-1}]$ such that (a), (b) hold for $k[z_1, \\ldots , z_ r] \\to S\'$. Since $S\' \\to S$ is injective and finite we see (a), (b) hold for $k[z_1, \\ldots , z_ r] \\to S$. The last assertion follows from Lemma 10.112.4. \n      $\\square$\n    \n\n\n\n  Lemma 10.115.5. Let $k$ be a field. Let $S$ be a finite type $k$ algebra and denote $X = \\mathop{\\mathrm{Spec}}(S)$. Let $\\mathfrak q$ be a prime of $S$, and let $x \\in X$ be the corresponding point. There exists a $g \\in S$, $g \\not\\in \\mathfrak q$ such that $\\dim (S_ g) = \\dim _ x(X) =: d$ and such that there exists a finite injective map $k[y_1, \\ldots , y_ d] \\to S_ g$. \n \n\n\n    \n      Proof.\n      Note that by definition $\\dim _ x(X)$ is the minimum of the dimensions of $S_ g$ for $g \\in S$, $g \\not\\in \\mathfrak q$, i.e., the minimum is attained. Thus the lemma follows from Lemma 10.115.4. \n      $\\square$\n    \n\n\n\n  Lemma 10.115.6. Let $k$ be a field. Let $\\mathfrak q \\subset k[x_1, \\ldots , x_ n]$ be a prime ideal. Set $r = \\text{trdeg}_ k\\  \\kappa (\\mathfrak q)$. Then there exists a finite ring map $\\varphi : k[y_1, \\ldots , y_ n] \\to k[x_1, \\ldots , x_ n]$ such that $\\varphi ^{-1}(\\mathfrak q) = (y_{r + 1}, \\ldots , y_ n)$. \n \n\n\n    \n      Proof.\n      By induction on $n$. The case $n = 0$ is clear. Assume $n > 0$. If $r = n$, then $\\mathfrak q = (0)$ and the result is clear. Choose a nonzero $f \\in \\mathfrak q$. Of course $f$ is nonconstant. After applying an automorphism of the form \n    \n      \n  \\[  k[x_1, \\ldots , x_ n] \\longrightarrow k[x_1, \\ldots , x_ n], \\quad x_ n \\mapsto x_ n, \\quad x_ i \\mapsto x_ i + x_ n^{e_ i}\\  (i < n)  \\]\n\n    \n       we may assume that $f$ is monic in $x_ n$ over $k[x_1, \\ldots , x_ n]$, see Lemma 10.115.2. Hence the ring map \n    \n      \n  \\[  k[y_1, \\ldots , y_ n] \\longrightarrow k[x_1, \\ldots , x_ n], \\quad y_ n \\mapsto f, \\quad y_ i \\mapsto x_ i\\  (i < n)  \\]\n\n    \n       is finite. Moreover $y_ n \\in \\mathfrak q \\cap k[y_1, \\ldots , y_ n]$ by construction. Thus $\\mathfrak q \\cap k[y_1, \\ldots , y_ n] = \\mathfrak pk[y_1, \\ldots , y_ n] + (y_ n)$ where $\\mathfrak p \\subset k[y_1, \\ldots , y_{n - 1}]$ is a prime ideal. Note that $\\kappa (\\mathfrak p) \\subset \\kappa (\\mathfrak q)$ is finite, and hence $r = \\text{trdeg}_ k\\  \\kappa (\\mathfrak p)$. Apply the induction hypothesis to the pair $(k[y_1, \\ldots , y_{n - 1}], \\mathfrak p)$ and we obtain a finite ring map $k[z_1, \\ldots , z_{n - 1}] \\to k[y_1, \\ldots , y_{n - 1}]$ such that $\\mathfrak p \\cap k[z_1, \\ldots , z_{n - 1}] = (z_{r + 1}, \\ldots , z_{n - 1})$. We extend the ring map $k[z_1, \\ldots , z_{n - 1}] \\to k[y_1, \\ldots , y_{n - 1}]$ to a ring map $k[z_1, \\ldots , z_ n] \\to k[y_1, \\ldots , y_ n]$ by mapping $z_ n$ to $y_ n$. The composition of the ring maps \n    \n      \n  \\[  k[z_1, \\ldots , z_ n] \\to k[y_1, \\ldots , y_ n] \\to k[x_1, \\ldots , x_ n]  \\]\n\n    \n       solves the problem. \n      $\\square$\n    \n\n\n\n  Lemma 10.115.7. Let $R \\to S$ be an injective finite type ring map. Assume $R$ is a domain. Then there exists an integer $d$ and a factorization \n  \n  \\[  R \\to R[y_1, \\ldots , y_ d] \\to S\' \\to S  \\]\n\n   by injective maps such that $S\'$ is finite over $R[y_1, \\ldots , y_ d]$ and such that $S\'_ f \\cong S_ f$ for some nonzero $f \\in R$. \n \n\n\n    \n      Proof.\n      Pick $x_1, \\ldots , x_ n \\in S$ which generate $S$ over $R$. Let $K$ be the fraction field of $R$ and $S_ K = S \\otimes _ R K$. By Lemma 10.115.4 we can find $y_1, \\ldots , y_ d \\in S$ such that $K[y_1, \\ldots , y_ d] \\to S_ K$ is a finite injective map. Note that $y_ i \\in S$ because we may pick the $y_ j$ in the $\\mathbf{Z}$-algebra generated by $x_1, \\ldots , x_ n$. As a finite ring map is integral (see Lemma 10.36.3) we can find monic $P_ i \\in K[y_1, \\ldots , y_ d][T]$ such that $P_ i(x_ i) = 0$ in $S_ K$. Let $f \\in R$ be a nonzero element such that $fP_ i \\in R[y_1, \\ldots , y_ d][T]$ for all $i$. Then $fP_ i(x_ i)$ maps to zero in $S_ K$. Hence after replacing $f$ by another nonzero element of $R$ we may also assume $fP_ i(x_ i)$ is zero in $S$. Set $x_ i\' = fx_ i$ and let $S\' \\subset S$ be the $R$-subalgebra generated by $y_1, \\ldots , y_ d$ and $x\'_1, \\ldots , x\'_ n$. Note that $x\'_ i$ is integral over $R[y_1, \\ldots , y_ d]$ as we have $Q_ i(x_ i\') = 0$ where $Q_ i = f^{\\deg _ T(P_ i)}P_ i(T/f)$ which is a monic polynomial in $T$ with coefficients in $R[y_1, \\ldots , y_ d]$ by our choice of $f$. Hence $R[y_1, \\ldots , y_ d] \\subset S\'$ is finite by Lemma 10.36.5. Since $S\' \\subset S$ we have $S\'_ f \\subset S_ f$ (localization is exact). On the other hand, the elements $x_ i = x\'_ i/f$ in $S\'_ f$ generate $S_ f$ over $R_ f$ and hence $S\'_ f \\to S_ f$ is surjective. Whence $S\'_ f \\cong S_ f$ and we win. \n      $\\square$\n    \n\n","10.115 Noether normalization\n\n\nIn this section we prove variants of the Noether normalization lemma. The key ingredient we will use is contained in the following two lemmas. \n\n\n\n  Lemma 10.115.1. Let $n \\in \\mathbf{N}$. Let $N$ be a finite nonempty set of multi-indices $\\nu = (\\nu _1, \\ldots , \\nu _ n)$. Given $e = (e_1, \\ldots , e_ n)$ we set $e \\cdot \\nu = \\sum e_ i\\nu _ i$. Then for $e_1 \\gg e_2 \\gg \\ldots \\gg e_{n-1} \\gg e_ n$ we have: If $\\nu , \\nu \' \\in N$ then \n  \n  \\[  (e \\cdot \\nu = e \\cdot \\nu \') \\Leftrightarrow (\\nu = \\nu \')  \\]\n\n \n\n\n    \n","Proof.\n      Say $N = \\{ \\nu _ j\\} $ with $\\nu _ j = (\\nu _{j1}, \\ldots , \\nu _{jn})$. Let $A_ i = \\max _ j \\nu _{ji} - \\min _ j \\nu _{ji}$. If for each $i$ we have $e_{i - 1} > A_ ie_ i + A_{i + 1}e_{i + 1} + \\ldots + A_ ne_ n$ then the lemma holds. For suppose that $e \\cdot (\\nu - \\nu \') = 0$. Then for $n \\ge 2$, \n    \n      \n  \\[  e_1(\\nu _1 - \\nu \'_1) = \\sum \\nolimits _{i = 2}^ n e_ i(\\nu \'_ i - \\nu _ i).  \\]\n\n    \n       We may assume that $(\\nu _1 - \\nu \'_1) \\ge 0$. If $(\\nu _1 - \\nu \'_1) > 0$, then \n    \n      \n  \\[  e_1(\\nu _1 - \\nu \'_1) \\ge e_1 > A_2e_2 + \\ldots + A_ ne_ n \\ge \\sum \\nolimits _{i = 2}^ n e_ i|\\nu \'_ i - \\nu _ i| \\ge \\sum \\nolimits _{i = 2}^ n e_ i(\\nu \'_ i - \\nu _ i).  \\]\n\n    \n       This contradiction implies that $\\nu \'_1 = \\nu _1$. By induction, $\\nu \'_ i = \\nu _ i$ for $2 \\le i \\le n$. \n      $\\square$\n    \n\n\n\n  Lemma 10.115.2. Let $R$ be a ring. Let $g \\in R[x_1, \\ldots , x_ n]$ be an element which is nonconstant, i.e., $g \\not\\in R$. For $e_1 \\gg e_2 \\gg \\ldots \\gg e_{n-1} \\gg e_ n = 1$ the polynomial \n  \n  \\[  g(x_1 + x_ n^{e_1}, x_2 + x_ n^{e_2}, \\ldots , x_{n - 1} + x_ n^{e_{n - 1}}, x_ n) = ax_ n^ d + \\text{lower order terms in }x_ n  \\]\n\n   where $d > 0$ and $a \\in R$ is one of the nonzero coefficients of $g$. \n \n\n\n    \n      Proof.\n      Write $g = \\sum _{\\nu \\in N} a_\\nu x^\\nu $ with $a_\\nu \\in R$ not zero. Here $N$ is a finite set of multi-indices as in Lemma 10.115.1 and $x^\\nu = x_1^{\\nu _1} \\ldots x_ n^{\\nu _ n}$. Note that the leading term in \n    \n      \n  \\[  (x_1 + x_ n^{e_1})^{\\nu _1} \\ldots (x_{n-1} + x_ n^{e_{n-1}})^{\\nu _{n-1}} x_ n^{\\nu _ n} \\quad \\text{is}\\quad x_ n^{e_1\\nu _1 + \\ldots + e_{n-1}\\nu _{n-1} + \\nu _ n}.  \\]\n\n    \n       Hence the lemma follows from Lemma 10.115.1 which guarantees that there is exactly one nonzero term $a_\\nu x^\\nu $ of $g$ which gives rise to the leading term of $g(x_1 + x_ n^{e_1}, x_2 + x_ n^{e_2}, \\ldots , x_{n - 1} + x_ n^{e_{n - 1}}, x_ n)$, i.e., $a = a_\\nu $ for the unique $\\nu \\in N$ such that $e \\cdot \\nu $ is maximal. \n      $\\square$\n    \n\n\n\n  Lemma 10.115.3. Let $k$ be a field. Let $S = k[x_1, \\ldots , x_ n]/I$ for some proper ideal $I$. If $I \\not= 0$, then there exist $y_1, \\ldots , y_{n-1} \\in k[x_1, \\ldots , x_ n]$ such that $S$ is finite over $k[y_1, \\ldots , y_{n-1}]$. Moreover we may choose $y_ i$ to be in the $\\mathbf{Z}$-subalgebra of $k[x_1, \\ldots , x_ n]$ generated by $x_1, \\ldots , x_ n$. \n \n\n\n    \n      Proof.\n      Pick $f \\in I$, $f\\not= 0$. It suffices to show the lemma for $k[x_1, \\ldots , x_ n]/(f)$ since $S$ is a quotient of that ring. We will take $y_ i = x_ i - x_ n^{e_ i}$, $i = 1, \\ldots , n-1$ for suitable integers $e_ i$. When does this work? It suffices to show that $\\overline{x_ n} \\in k[x_1, \\ldots , x_ n]/(f)$ is integral over the ring $k[y_1, \\ldots , y_{n-1}]$. The equation for $\\overline{x_ n}$ over this ring is \n    \n      \n  \\[  f(y_1 + x_ n^{e_1}, \\ldots , y_{n-1} + x_ n^{e_{n-1}}, x_ n) = 0.  \\]\n\n    \n       Hence we are done if we can show there exists integers $e_ i$ such that the leading coefficient with respect to $x_ n$ of the equation above is a nonzero element of $k$. This can be achieved for example by choosing $e_1 \\gg e_2 \\gg \\ldots \\gg e_{n-1}$, see Lemma 10.115.2. \n      $\\square$\n    \n\n\n\n       \n      \n  Lemma 10.115.4. Let $k$ be a field. Let $S = k[x_1, \\ldots , x_ n]/I$ for some ideal $I$. If $I \\neq (1)$, there exist $r\\geq 0$, and $y_1, \\ldots , y_ r \\in k[x_1, \\ldots , x_ n]$ such that (a) the map $k[y_1, \\ldots , y_ r] \\to S$ is injective where the source is the polynomial ring on $y_1, \\ldots , y_ r$, and (b) the map $k[y_1, \\ldots , y_ r] \\to S$ is finite. In this case the integer $r$ is the dimension of $S$. Moreover we may choose $y_ i$ to be in the $\\mathbf{Z}$-subalgebra of $k[x_1, \\ldots , x_ n]$ generated by $x_1, \\ldots , x_ n$. \n \n\n\n    \n      Proof.\n      By induction on $n$, with $n = 0$ being trivial. If $I = 0$, then take $r = n$ and $y_ i = x_ i$. If $I \\not= 0$, then choose $y_1, \\ldots , y_{n-1}$ as in Lemma 10.115.3. Let $S\' \\subset S$ be the subring generated by the images of the $y_ i$. By induction we can choose $r$ and $z_1, \\ldots , z_ r \\in k[y_1, \\ldots , y_{n-1}]$ such that (a), (b) hold for $k[z_1, \\ldots , z_ r] \\to S\'$. Since $S\' \\to S$ is injective and finite we see (a), (b) hold for $k[z_1, \\ldots , z_ r] \\to S$. The last assertion follows from Lemma 10.112.4. \n      $\\square$\n    \n\n\n\n  Lemma 10.115.5. Let $k$ be a field. Let $S$ be a finite type $k$ algebra and denote $X = \\mathop{\\mathrm{Spec}}(S)$. Let $\\mathfrak q$ be a prime of $S$, and let $x \\in X$ be the corresponding point. There exists a $g \\in S$, $g \\not\\in \\mathfrak q$ such that $\\dim (S_ g) = \\dim _ x(X) =: d$ and such that there exists a finite injective map $k[y_1, \\ldots , y_ d] \\to S_ g$. \n \n\n\n    \n      Proof.\n      Note that by definition $\\dim _ x(X)$ is the minimum of the dimensions of $S_ g$ for $g \\in S$, $g \\not\\in \\mathfrak q$, i.e., the minimum is attained. Thus the lemma follows from Lemma 10.115.4. \n      $\\square$\n    \n\n\n\n  Lemma 10.115.6. Let $k$ be a field. Let $\\mathfrak q \\subset k[x_1, \\ldots , x_ n]$ be a prime ideal. Set $r = \\text{trdeg}_ k\\  \\kappa (\\mathfrak q)$. Then there exists a finite ring map $\\varphi : k[y_1, \\ldots , y_ n] \\to k[x_1, \\ldots , x_ n]$ such that $\\varphi ^{-1}(\\mathfrak q) = (y_{r + 1}, \\ldots , y_ n)$. \n \n\n\n    \n      Proof.\n      By induction on $n$. The case $n = 0$ is clear. Assume $n > 0$. If $r = n$, then $\\mathfrak q = (0)$ and the result is clear. Choose a nonzero $f \\in \\mathfrak q$. Of course $f$ is nonconstant. After applying an automorphism of the form \n    \n      \n  \\[  k[x_1, \\ldots , x_ n] \\longrightarrow k[x_1, \\ldots , x_ n], \\quad x_ n \\mapsto x_ n, \\quad x_ i \\mapsto x_ i + x_ n^{e_ i}\\  (i < n)  \\]\n\n    \n       we may assume that $f$ is monic in $x_ n$ over $k[x_1, \\ldots , x_ n]$, see Lemma 10.115.2. Hence the ring map \n    \n      \n  \\[  k[y_1, \\ldots , y_ n] \\longrightarrow k[x_1, \\ldots , x_ n], \\quad y_ n \\mapsto f, \\quad y_ i \\mapsto x_ i\\  (i < n)  \\]\n\n    \n       is finite. Moreover $y_ n \\in \\mathfrak q \\cap k[y_1, \\ldots , y_ n]$ by construction. Thus $\\mathfrak q \\cap k[y_1, \\ldots , y_ n] = \\mathfrak pk[y_1, \\ldots , y_ n] + (y_ n)$ where $\\mathfrak p \\subset k[y_1, \\ldots , y_{n - 1}]$ is a prime ideal. Note that $\\kappa (\\mathfrak p) \\subset \\kappa (\\mathfrak q)$ is finite, and hence $r = \\text{trdeg}_ k\\  \\kappa (\\mathfrak p)$. Apply the induction hypothesis to the pair $(k[y_1, \\ldots , y_{n - 1}], \\mathfrak p)$ and we obtain a finite ring map $k[z_1, \\ldots , z_{n - 1}] \\to k[y_1, \\ldots , y_{n - 1}]$ such that $\\mathfrak p \\cap k[z_1, \\ldots , z_{n - 1}] = (z_{r + 1}, \\ldots , z_{n - 1})$. We extend the ring map $k[z_1, \\ldots , z_{n - 1}] \\to k[y_1, \\ldots , y_{n - 1}]$ to a ring map $k[z_1, \\ldots , z_ n] \\to k[y_1, \\ldots , y_ n]$ by mapping $z_ n$ to $y_ n$. The composition of the ring maps \n    \n      \n  \\[  k[z_1, \\ldots , z_ n] \\to k[y_1, \\ldots , y_ n] \\to k[x_1, \\ldots , x_ n]  \\]\n\n    \n       solves the problem. \n      $\\square$\n    \n\n\n\n  Lemma 10.115.7. Let $R \\to S$ be an injective finite type ring map. Assume $R$ is a domain. Then there exists an integer $d$ and a factorization \n  \n  \\[  R \\to R[y_1, \\ldots , y_ d] \\to S\' \\to S  \\]\n\n   by injective maps such that $S\'$ is finite over $R[y_1, \\ldots , y_ d]$ and such that $S\'_ f \\cong S_ f$ for some nonzero $f \\in R$. \n \n\n\n    \n      Proof.\n      Pick $x_1, \\ldots , x_ n \\in S$ which generate $S$ over $R$. Let $K$ be the fraction field of $R$ and $S_ K = S \\otimes _ R K$. By Lemma 10.115.4 we can find $y_1, \\ldots , y_ d \\in S$ such that $K[y_1, \\ldots , y_ d] \\to S_ K$ is a finite injective map. Note that $y_ i \\in S$ because we may pick the $y_ j$ in the $\\mathbf{Z}$-algebra generated by $x_1, \\ldots , x_ n$. As a finite ring map is integral (see Lemma 10.36.3) we can find monic $P_ i \\in K[y_1, \\ldots , y_ d][T]$ such that $P_ i(x_ i) = 0$ in $S_ K$. Let $f \\in R$ be a nonzero element such that $fP_ i \\in R[y_1, \\ldots , y_ d][T]$ for all $i$. Then $fP_ i(x_ i)$ maps to zero in $S_ K$. Hence after replacing $f$ by another nonzero element of $R$ we may also assume $fP_ i(x_ i)$ is zero in $S$. Set $x_ i\' = fx_ i$ and let $S\' \\subset S$ be the $R$-subalgebra generated by $y_1, \\ldots , y_ d$ and $x\'_1, \\ldots , x\'_ n$. Note that $x\'_ i$ is integral over $R[y_1, \\ldots , y_ d]$ as we have $Q_ i(x_ i\') = 0$ where $Q_ i = f^{\\deg _ T(P_ i)}P_ i(T/f)$ which is a monic polynomial in $T$ with coefficients in $R[y_1, \\ldots , y_ d]$ by our choice of $f$. Hence $R[y_1, \\ldots , y_ d] \\subset S\'$ is finite by Lemma 10.36.5. Since $S\' \\subset S$ we have $S\'_ f \\subset S_ f$ (localization is exact). On the other hand, the elements $x_ i = x\'_ i/f$ in $S\'_ f$ generate $S_ f$ over $R_ f$ and hence $S\'_ f \\to S_ f$ is surjective. Whence $S\'_ f \\cong S_ f$ and we win. \n      $\\square$\n    \n\n"," by
  obtain âŸ¨n, f, fsurjâŸ© := Algebra.FiniteType.iff_quotient_mvPolynomial''.mp fin
  set Ï• := quotientKerAlgEquivOfSurjective fsurj
  obtain âŸ¨s, _, g, injg, intgâŸ© := exists_integral_inj_algHom_of_quotient (ker f) (ker_ne_top _)
  use s, Ï•.toAlgHom.comp g
  simp only [AlgEquiv.toAlgHom_eq_coe, AlgHom.coe_comp, AlgHom.coe_coe,
    EmbeddingLike.comp_injective, AlgHom.toRingHom_eq_coe]
  exact âŸ¨injg, intg.trans _ _ (isIntegral_of_surjective _ Ï•.surjective)âŸ©
","theorem exists_integral_inj_algHom_of_fg : âˆƒ s, âˆƒ g : (MvPolynomial (Fin s) k) â†’â‚[k] R,
    Function.Injective g âˆ§ g.IsIntegral ","Proof.\n      Say $N = \\{ \\nu _ j\\} $ with $\\nu _ j = (\\nu _{j1}, \\ldots , \\nu _{jn})$. Let $A_ i = \\max _ j \\nu _{ji} - \\min _ j \\nu _{ji}$. If for each $i$ we have $e_{i - 1} > A_ ie_ i + A_{i + 1}e_{i + 1} + \\ldots + A_ ne_ n$ then the lemma holds. For suppose that $e \\cdot (\\nu - \\nu \') = 0$. Then for $n \\ge 2$, \n    \n      \n  \\[  e_1(\\nu _1 - \\nu \'_1) = \\sum \\nolimits _{i = 2}^ n e_ i(\\nu \'_ i - \\nu _ i).  \\]\n\n    \n       We may assume that $(\\nu _1 - \\nu \'_1) \\ge 0$. If $(\\nu _1 - \\nu \'_1) > 0$, then \n    \n      \n  \\[  e_1(\\nu _1 - \\nu \'_1) \\ge e_1 > A_2e_2 + \\ldots + A_ ne_ n \\ge \\sum \\nolimits _{i = 2}^ n e_ i|\\nu \'_ i - \\nu _ i| \\ge \\sum \\nolimits _{i = 2}^ n e_ i(\\nu \'_ i - \\nu _ i).  \\]\n\n    \n       This contradiction implies that $\\nu \'_1 = \\nu _1$. By induction, $\\nu \'_ i = \\nu _ i$ for $2 \\le i \\le n$. \n      $\\square$\n    \n\n\n\n  Lemma 10.115.2 [[\n  Lemma 10.115.2. Let $R$ be a ring. Let $g \\in R[x_1, \\ldots , x_ n]$ be an element which is nonconstant, i.e., $g \\not\\in R$. For $e_1 \\gg e_2 \\gg \\ldots \\gg e_{n-1} \\gg e_ n = 1$ the polynomial \n  \n  \\[  g(x_1 + x_ n^{e_1}, x_2 + x_ n^{e_2}, \\ldots , x_{n - 1} + x_ n^{e_{n - 1}}, x_ n) = ax_ n^ d + \\text{lower order terms in }x_ n  \\]\n\n   where $d > 0$ and $a \\in R$ is one of the nonzero coefficients of $g$. \n\n    \n]]. Let $R$ be a ring. Let $g \\in R[x_1, \\ldots , x_ n]$ be an element which is nonconstant, i.e., $g \\not\\in R$. For $e_1 \\gg e_2 \\gg \\ldots \\gg e_{n-1} \\gg e_ n = 1$ the polynomial \n  \n  \\[  g(x_1 + x_ n^{e_1}, x_2 + x_ n^{e_2}, \\ldots , x_{n - 1} + x_ n^{e_{n - 1}}, x_ n) = ax_ n^ d + \\text{lower order terms in }x_ n  \\]\n\n   where $d > 0$ and $a \\in R$ is one of the nonzero coefficients of $g$. \n \n\n\n    \n      Proof.\n      Write $g = \\sum _{\\nu \\in N} a_\\nu x^\\nu $ with $a_\\nu \\in R$ not zero. Here $N$ is a finite set of multi-indices as in Lemma 10.115.1 [[\n  Lemma 10.115.1. Let $n \\in \\mathbf{N}$. Let $N$ be a finite nonempty set of multi-indices $\\nu = (\\nu _1, \\ldots , \\nu _ n)$. Given $e = (e_1, \\ldots , e_ n)$ we set $e \\cdot \\nu = \\sum e_ i\\nu _ i$. Then for $e_1 \\gg e_2 \\gg \\ldots \\gg e_{n-1} \\gg e_ n$ we have: If $\\nu , \\nu \' \\in N$ then \n  \n  \\[  (e \\cdot \\nu = e \\cdot \\nu \') \\Leftrightarrow (\\nu = \\nu \')  \\]\n\n\n    \n]] and $x^\\nu = x_1^{\\nu _1} \\ldots x_ n^{\\nu _ n}$. Note that the leading term in \n    \n      \n  \\[  (x_1 + x_ n^{e_1})^{\\nu _1} \\ldots (x_{n-1} + x_ n^{e_{n-1}})^{\\nu _{n-1}} x_ n^{\\nu _ n} \\quad \\text{is}\\quad x_ n^{e_1\\nu _1 + \\ldots + e_{n-1}\\nu _{n-1} + \\nu _ n}.  \\]\n\n    \n       Hence the lemma follows from Lemma 10.115.1 [[\n  Lemma 10.115.1. Let $n \\in \\mathbf{N}$. Let $N$ be a finite nonempty set of multi-indices $\\nu = (\\nu _1, \\ldots , \\nu _ n)$. Given $e = (e_1, \\ldots , e_ n)$ we set $e \\cdot \\nu = \\sum e_ i\\nu _ i$. Then for $e_1 \\gg e_2 \\gg \\ldots \\gg e_{n-1} \\gg e_ n$ we have: If $\\nu , \\nu \' \\in N$ then \n  \n  \\[  (e \\cdot \\nu = e \\cdot \\nu \') \\Leftrightarrow (\\nu = \\nu \')  \\]\n\n\n    \n]] which guarantees that there is exactly one nonzero term $a_\\nu x^\\nu $ of $g$ which gives rise to the leading term of $g(x_1 + x_ n^{e_1}, x_2 + x_ n^{e_2}, \\ldots , x_{n - 1} + x_ n^{e_{n - 1}}, x_ n)$, i.e., $a = a_\\nu $ for the unique $\\nu \\in N$ such that $e \\cdot \\nu $ is maximal. \n      $\\square$\n    \n\n\n\n  Lemma 10.115.3 [[\n  Lemma 10.115.3. Let $k$ be a field. Let $S = k[x_1, \\ldots , x_ n]/I$ for some proper ideal $I$. If $I \\not= 0$, then there exist $y_1, \\ldots , y_{n-1} \\in k[x_1, \\ldots , x_ n]$ such that $S$ is finite over $k[y_1, \\ldots , y_{n-1}]$. Moreover we may choose $y_ i$ to be in the $\\mathbf{Z}$-subalgebra of $k[x_1, \\ldots , x_ n]$ generated by $x_1, \\ldots , x_ n$. \n\n    \n]]. Let $k$ be a field. Let $S = k[x_1, \\ldots , x_ n]/I$ for some proper ideal $I$. If $I \\not= 0$, then there exist $y_1, \\ldots , y_{n-1} \\in k[x_1, \\ldots , x_ n]$ such that $S$ is finite over $k[y_1, \\ldots , y_{n-1}]$. Moreover we may choose $y_ i$ to be in the $\\mathbf{Z}$-subalgebra of $k[x_1, \\ldots , x_ n]$ generated by $x_1, \\ldots , x_ n$. \n \n\n\n    \n      Proof.\n      Pick $f \\in I$, $f\\not= 0$. It suffices to show the lemma for $k[x_1, \\ldots , x_ n]/(f)$ since $S$ is a quotient of that ring. We will take $y_ i = x_ i - x_ n^{e_ i}$, $i = 1, \\ldots , n-1$ for suitable integers $e_ i$. When does this work? It suffices to show that $\\overline{x_ n} \\in k[x_1, \\ldots , x_ n]/(f)$ is integral over the ring $k[y_1, \\ldots , y_{n-1}]$. The equation for $\\overline{x_ n}$ over this ring is \n    \n      \n  \\[  f(y_1 + x_ n^{e_1}, \\ldots , y_{n-1} + x_ n^{e_{n-1}}, x_ n) = 0.  \\]\n\n    \n       Hence we are done if we can show there exists integers $e_ i$ such that the leading coefficient with respect to $x_ n$ of the equation above is a nonzero element of $k$. This can be achieved for example by choosing $e_1 \\gg e_2 \\gg \\ldots \\gg e_{n-1}$, see Lemma 10.115.2 [[\n  Lemma 10.115.2. Let $R$ be a ring. Let $g \\in R[x_1, \\ldots , x_ n]$ be an element which is nonconstant, i.e., $g \\not\\in R$. For $e_1 \\gg e_2 \\gg \\ldots \\gg e_{n-1} \\gg e_ n = 1$ the polynomial \n  \n  \\[  g(x_1 + x_ n^{e_1}, x_2 + x_ n^{e_2}, \\ldots , x_{n - 1} + x_ n^{e_{n - 1}}, x_ n) = ax_ n^ d + \\text{lower order terms in }x_ n  \\]\n\n   where $d > 0$ and $a \\in R$ is one of the nonzero coefficients of $g$. \n\n    \n]]. \n      $\\square$\n    \n\n\n\n       \n      \n  Lemma 10.115.4 [[\n       \n      \n  Lemma 10.115.4. Let $k$ be a field. Let $S = k[x_1, \\ldots , x_ n]/I$ for some ideal $I$. If $I \\neq (1)$, there exist $r\\geq 0$, and $y_1, \\ldots , y_ r \\in k[x_1, \\ldots , x_ n]$ such that (a) the map $k[y_1, \\ldots , y_ r] \\to S$ is injective where the source is the polynomial ring on $y_1, \\ldots , y_ r$, and (b) the map $k[y_1, \\ldots , y_ r] \\to S$ is finite. In this case the integer $r$ is the dimension of $S$. Moreover we may choose $y_ i$ to be in the $\\mathbf{Z}$-subalgebra of $k[x_1, \\ldots , x_ n]$ generated by $x_1, \\ldots , x_ n$. \n\n    \n]]. Let $k$ be a field. Let $S = k[x_1, \\ldots , x_ n]/I$ for some ideal $I$. If $I \\neq (1)$, there exist $r\\geq 0$, and $y_1, \\ldots , y_ r \\in k[x_1, \\ldots , x_ n]$ such that (a) the map $k[y_1, \\ldots , y_ r] \\to S$ is injective where the source is the polynomial ring on $y_1, \\ldots , y_ r$, and (b) the map $k[y_1, \\ldots , y_ r] \\to S$ is finite. In this case the integer $r$ is the dimension of $S$. Moreover we may choose $y_ i$ to be in the $\\mathbf{Z}$-subalgebra of $k[x_1, \\ldots , x_ n]$ generated by $x_1, \\ldots , x_ n$. \n \n\n\n    \n      Proof.\n      By induction on $n$, with $n = 0$ being trivial. If $I = 0$, then take $r = n$ and $y_ i = x_ i$. If $I \\not= 0$, then choose $y_1, \\ldots , y_{n-1}$ as in Lemma 10.115.3 [[\n  Lemma 10.115.3. Let $k$ be a field. Let $S = k[x_1, \\ldots , x_ n]/I$ for some proper ideal $I$. If $I \\not= 0$, then there exist $y_1, \\ldots , y_{n-1} \\in k[x_1, \\ldots , x_ n]$ such that $S$ is finite over $k[y_1, \\ldots , y_{n-1}]$. Moreover we may choose $y_ i$ to be in the $\\mathbf{Z}$-subalgebra of $k[x_1, \\ldots , x_ n]$ generated by $x_1, \\ldots , x_ n$. \n\n    \n]]. Let $S\' \\subset S$ be the subring generated by the images of the $y_ i$. By induction we can choose $r$ and $z_1, \\ldots , z_ r \\in k[y_1, \\ldots , y_{n-1}]$ such that (a), (b) hold for $k[z_1, \\ldots , z_ r] \\to S\'$. Since $S\' \\to S$ is injective and finite we see (a), (b) hold for $k[z_1, \\ldots , z_ r] \\to S$. The last assertion follows from Lemma 10.112.4 [[\n  Lemma 10.112.4. Suppose $R \\subset S$ and $S$ integral over $R$. Then $\\dim (R) = \\dim (S)$. \n\n    \n]]. \n      $\\square$\n    \n\n\n\n  Lemma 10.115.5 [[\n  Lemma 10.115.5. Let $k$ be a field. Let $S$ be a finite type $k$ algebra and denote $X = \\mathop{\\mathrm{Spec}}(S)$. Let $\\mathfrak q$ be a prime of $S$, and let $x \\in X$ be the corresponding point. There exists a $g \\in S$, $g \\not\\in \\mathfrak q$ such that $\\dim (S_ g) = \\dim _ x(X) =: d$ and such that there exists a finite injective map $k[y_1, \\ldots , y_ d] \\to S_ g$. \n\n    \n]]. Let $k$ be a field. Let $S$ be a finite type $k$ algebra and denote $X = \\mathop{\\mathrm{Spec}}(S)$. Let $\\mathfrak q$ be a prime of $S$, and let $x \\in X$ be the corresponding point. There exists a $g \\in S$, $g \\not\\in \\mathfrak q$ such that $\\dim (S_ g) = \\dim _ x(X) =: d$ and such that there exists a finite injective map $k[y_1, \\ldots , y_ d] \\to S_ g$. \n \n\n\n    \n      Proof.\n      Note that by definition $\\dim _ x(X)$ is the minimum of the dimensions of $S_ g$ for $g \\in S$, $g \\not\\in \\mathfrak q$, i.e., the minimum is attained. Thus the lemma follows from Lemma 10.115.4 [[\n       \n      \n  Lemma 10.115.4. Let $k$ be a field. Let $S = k[x_1, \\ldots , x_ n]/I$ for some ideal $I$. If $I \\neq (1)$, there exist $r\\geq 0$, and $y_1, \\ldots , y_ r \\in k[x_1, \\ldots , x_ n]$ such that (a) the map $k[y_1, \\ldots , y_ r] \\to S$ is injective where the source is the polynomial ring on $y_1, \\ldots , y_ r$, and (b) the map $k[y_1, \\ldots , y_ r] \\to S$ is finite. In this case the integer $r$ is the dimension of $S$. Moreover we may choose $y_ i$ to be in the $\\mathbf{Z}$-subalgebra of $k[x_1, \\ldots , x_ n]$ generated by $x_1, \\ldots , x_ n$. \n\n    \n]]. \n      $\\square$\n    \n\n\n\n  Lemma 10.115.6 [[\n  Lemma 10.115.6. Let $k$ be a field. Let $\\mathfrak q \\subset k[x_1, \\ldots , x_ n]$ be a prime ideal. Set $r = \\text{trdeg}_ k\\  \\kappa (\\mathfrak q)$. Then there exists a finite ring map $\\varphi : k[y_1, \\ldots , y_ n] \\to k[x_1, \\ldots , x_ n]$ such that $\\varphi ^{-1}(\\mathfrak q) = (y_{r + 1}, \\ldots , y_ n)$. \n\n    \n]]. Let $k$ be a field. Let $\\mathfrak q \\subset k[x_1, \\ldots , x_ n]$ be a prime ideal. Set $r = \\text{trdeg}_ k\\  \\kappa (\\mathfrak q)$. Then there exists a finite ring map $\\varphi : k[y_1, \\ldots , y_ n] \\to k[x_1, \\ldots , x_ n]$ such that $\\varphi ^{-1}(\\mathfrak q) = (y_{r + 1}, \\ldots , y_ n)$. \n \n\n\n    \n      Proof.\n      By induction on $n$. The case $n = 0$ is clear. Assume $n > 0$. If $r = n$, then $\\mathfrak q = (0)$ and the result is clear. Choose a nonzero $f \\in \\mathfrak q$. Of course $f$ is nonconstant. After applying an automorphism of the form \n    \n      \n  \\[  k[x_1, \\ldots , x_ n] \\longrightarrow k[x_1, \\ldots , x_ n], \\quad x_ n \\mapsto x_ n, \\quad x_ i \\mapsto x_ i + x_ n^{e_ i}\\  (i < n)  \\]\n\n    \n       we may assume that $f$ is monic in $x_ n$ over $k[x_1, \\ldots , x_ n]$, see Lemma 10.115.2 [[\n  Lemma 10.115.2. Let $R$ be a ring. Let $g \\in R[x_1, \\ldots , x_ n]$ be an element which is nonconstant, i.e., $g \\not\\in R$. For $e_1 \\gg e_2 \\gg \\ldots \\gg e_{n-1} \\gg e_ n = 1$ the polynomial \n  \n  \\[  g(x_1 + x_ n^{e_1}, x_2 + x_ n^{e_2}, \\ldots , x_{n - 1} + x_ n^{e_{n - 1}}, x_ n) = ax_ n^ d + \\text{lower order terms in }x_ n  \\]\n\n   where $d > 0$ and $a \\in R$ is one of the nonzero coefficients of $g$. \n\n    \n]]. Hence the ring map \n    \n      \n  \\[  k[y_1, \\ldots , y_ n] \\longrightarrow k[x_1, \\ldots , x_ n], \\quad y_ n \\mapsto f, \\quad y_ i \\mapsto x_ i\\  (i < n)  \\]\n\n    \n       is finite. Moreover $y_ n \\in \\mathfrak q \\cap k[y_1, \\ldots , y_ n]$ by construction. Thus $\\mathfrak q \\cap k[y_1, \\ldots , y_ n] = \\mathfrak pk[y_1, \\ldots , y_ n] + (y_ n)$ where $\\mathfrak p \\subset k[y_1, \\ldots , y_{n - 1}]$ is a prime ideal. Note that $\\kappa (\\mathfrak p) \\subset \\kappa (\\mathfrak q)$ is finite, and hence $r = \\text{trdeg}_ k\\  \\kappa (\\mathfrak p)$. Apply the induction hypothesis to the pair $(k[y_1, \\ldots , y_{n - 1}], \\mathfrak p)$ and we obtain a finite ring map $k[z_1, \\ldots , z_{n - 1}] \\to k[y_1, \\ldots , y_{n - 1}]$ such that $\\mathfrak p \\cap k[z_1, \\ldots , z_{n - 1}] = (z_{r + 1}, \\ldots , z_{n - 1})$. We extend the ring map $k[z_1, \\ldots , z_{n - 1}] \\to k[y_1, \\ldots , y_{n - 1}]$ to a ring map $k[z_1, \\ldots , z_ n] \\to k[y_1, \\ldots , y_ n]$ by mapping $z_ n$ to $y_ n$. The composition of the ring maps \n    \n      \n  \\[  k[z_1, \\ldots , z_ n] \\to k[y_1, \\ldots , y_ n] \\to k[x_1, \\ldots , x_ n]  \\]\n\n    \n       solves the problem. \n      $\\square$\n    \n\n\n\n  Lemma 10.115.7 [[\n  Lemma 10.115.7. Let $R \\to S$ be an injective finite type ring map. Assume $R$ is a domain. Then there exists an integer $d$ and a factorization \n  \n  \\[  R \\to R[y_1, \\ldots , y_ d] \\to S\' \\to S  \\]\n\n   by injective maps such that $S\'$ is finite over $R[y_1, \\ldots , y_ d]$ and such that $S\'_ f \\cong S_ f$ for some nonzero $f \\in R$. \n\n    \n]]. Let $R \\to S$ be an injective finite type ring map. Assume $R$ is a domain. Then there exists an integer $d$ and a factorization \n  \n  \\[  R \\to R[y_1, \\ldots , y_ d] \\to S\' \\to S  \\]\n\n   by injective maps such that $S\'$ is finite over $R[y_1, \\ldots , y_ d]$ and such that $S\'_ f \\cong S_ f$ for some nonzero $f \\in R$. \n \n\n\n    \n      Proof.\n      Pick $x_1, \\ldots , x_ n \\in S$ which generate $S$ over $R$. Let $K$ be the fraction field of $R$ and $S_ K = S \\otimes _ R K$. By Lemma 10.115.4 [[\n       \n      \n  Lemma 10.115.4. Let $k$ be a field. Let $S = k[x_1, \\ldots , x_ n]/I$ for some ideal $I$. If $I \\neq (1)$, there exist $r\\geq 0$, and $y_1, \\ldots , y_ r \\in k[x_1, \\ldots , x_ n]$ such that (a) the map $k[y_1, \\ldots , y_ r] \\to S$ is injective where the source is the polynomial ring on $y_1, \\ldots , y_ r$, and (b) the map $k[y_1, \\ldots , y_ r] \\to S$ is finite. In this case the integer $r$ is the dimension of $S$. Moreover we may choose $y_ i$ to be in the $\\mathbf{Z}$-subalgebra of $k[x_1, \\ldots , x_ n]$ generated by $x_1, \\ldots , x_ n$. \n\n    \n]] we can find $y_1, \\ldots , y_ d \\in S$ such that $K[y_1, \\ldots , y_ d] \\to S_ K$ is a finite injective map. Note that $y_ i \\in S$ because we may pick the $y_ j$ in the $\\mathbf{Z}$-algebra generated by $x_1, \\ldots , x_ n$. As a finite ring map is integral (see Lemma 10.36.3 [[\n  Lemma 10.36.3. A finite ring map is integral. \n\n    \n]]) we can find monic $P_ i \\in K[y_1, \\ldots , y_ d][T]$ such that $P_ i(x_ i) = 0$ in $S_ K$. Let $f \\in R$ be a nonzero element such that $fP_ i \\in R[y_1, \\ldots , y_ d][T]$ for all $i$. Then $fP_ i(x_ i)$ maps to zero in $S_ K$. Hence after replacing $f$ by another nonzero element of $R$ we may also assume $fP_ i(x_ i)$ is zero in $S$. Set $x_ i\' = fx_ i$ and let $S\' \\subset S$ be the $R$-subalgebra generated by $y_1, \\ldots , y_ d$ and $x\'_1, \\ldots , x\'_ n$. Note that $x\'_ i$ is integral over $R[y_1, \\ldots , y_ d]$ as we have $Q_ i(x_ i\') = 0$ where $Q_ i = f^{\\deg _ T(P_ i)}P_ i(T/f)$ which is a monic polynomial in $T$ with coefficients in $R[y_1, \\ldots , y_ d]$ by our choice of $f$. Hence $R[y_1, \\ldots , y_ d] \\subset S\'$ is finite by Lemma 10.36.5 [[\n  Lemma 10.36.5. Let $R \\to S$ be a ring map. The following are equivalent \n  \n  \n$R \\to S$ is finite, \n\n\n$R \\to S$ is integral and of finite type, and \n\n\nthere exist $x_1, \\ldots , x_ n \\in S$ which generate $S$ as an algebra over $R$ such that each $x_ i$ is integral over $R$. \n\n\n\n\n    \n]]. Since $S\' \\subset S$ we have $S\'_ f \\subset S_ f$ (localization is exact). On the other hand, the elements $x_ i = x\'_ i/f$ in $S\'_ f$ generate $S_ f$ over $R_ f$ and hence $S\'_ f \\to S_ f$ is surjective. Whence $S\'_ f \\cong S_ f$ and we win. \n      $\\square$\n    \n\n"
234,02MD,"noncomputable
def ordFrac : K â†’*â‚€ â„¤áµâ° :=
  letI f := (toLocalizationMap (nonZeroDivisors R) K).liftâ‚€ (ordMonoidWithZeroHom R)
  haveI : âˆ€ (y : â†¥(nonZeroDivisors R)), IsUnit (ordMonoidWithZeroHom R â†‘y) := by
    intro y
    simp only [isUnit_iff_ne_zero, ne_eq]
    simp [ordMonoidWithZeroHom, ord]
    have := Module.length_ne_top_iff.mpr <| isFiniteLength_quotient_span_singleton R y.2
    have : âˆ€ k,
      (WithZero.map' (AddMonoidHom.toMultiplicative (Nat.castAddMonoidHom â„¤))) k = 0 â†” k = 0 := by
        intro k
        cases k
        all_goals simp
    simpa [this]
  f this
",Formal Proof of Stacks Project Tag 02MD,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/OrderOfVanishing.lean#L172-L186,Q27041,,10.121.2,definition,3.0,"['02MB', '00AO', '0ELQ']","\n  Definition 10.121.2. Suppose that $K$ is a field, and $R \\subset K$ is a local1 Noetherian subring of dimension $1$ with fraction field $K$. In this case we define the order of vanishing along $R$ \n  \n  \\[  \\text{ord}_ R : K^* \\longrightarrow \\mathbf{Z}  \\]\n\n   by the rule \n  \n  \\[  \\text{ord}_ R(x) = \\text{length}_ R(R/(x))  \\]\n\n   if $x \\in R$ and we set $\\text{ord}_ R(x/y) = \\text{ord}_ R(x) - \\text{ord}_ R(y)$ for $x, y \\in R$ both nonzero. \n","\n  Definition 10.121.2. Suppose that $K$ is a field, and $R \\subset K$ is a local1 Noetherian subring of dimension $1$ with fraction field $K$. In this case we define the order of vanishing along $R$ \n  \n  \\[  \\text{ord}_ R : K^* \\longrightarrow \\mathbf{Z}  \\]\n\n   by the rule \n  \n  \\[  \\text{ord}_ R(x) = \\text{length}_ R(R/(x))  \\]\n\n   if $x \\in R$ and we set $\\text{ord}_ R(x/y) = \\text{ord}_ R(x) - \\text{ord}_ R(y)$ for $x, y \\in R$ both nonzero. \n",,"
  letI f := (toLocalizationMap (nonZeroDivisors R) K).liftâ‚€ (ordMonoidWithZeroHom R)
  haveI : âˆ€ (y : â†¥(nonZeroDivisors R)), IsUnit (ordMonoidWithZeroHom R â†‘y) := by
    intro y
    simp only [isUnit_iff_ne_zero, ne_eq]
    simp [ordMonoidWithZeroHom, ord]
    have := Module.length_ne_top_iff.mpr <| isFiniteLength_quotient_span_singleton R y.2
    have : âˆ€ k,
      (WithZero.map' (AddMonoidHom.toMultiplicative (Nat.castAddMonoidHom â„¤))) k = 0 â†” k = 0 := by
        intro k
        cases k
        all_goals simp
    simpa [this]
  f this
","noncomputable
def ordFrac : K â†’*â‚€ â„¤áµâ° ",
235,00L1,"def Module.support : Set (PrimeSpectrum R) :=
  { p | Nontrivial (LocalizedModule p.asIdeal.primeCompl M) }
",Formal Proof of Stacks Project Tag 00L1,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Support.lean#L47-L48,Q27041,,10.40.1,definition,3.0,"['080S', '00AO', '0ELQ']",\n  Definition 10.40.1. Let $R$ be a ring and let $M$ be an $R$-module. The support of $M$ is the set \n  \n  \\[  \\text{Supp}(M) = \\{  \\mathfrak p \\in \\mathop{\\mathrm{Spec}}(R) \\mid M_{\\mathfrak p} \\not= 0 \\}   \\]\n\n,\n  Definition 10.40.1. Let $R$ be a ring and let $M$ be an $R$-module. The support of $M$ is the set \n  \n  \\[  \\text{Supp}(M) = \\{  \\mathfrak p \\in \\mathop{\\mathrm{Spec}}(R) \\mid M_{\\mathfrak p} \\not= 0 \\}   \\]\n\n,,"
  { p | Nontrivial (LocalizedModule p.asIdeal.primeCompl M) }
",def Module.support : Set (PrimeSpectrum R) ,
236,00L3,"lemma Module.support_subset_of_injective (hf : Function.Injective f) :
    Module.support R M âŠ† Module.support R N := by
  simp_rw [Set.subset_def, mem_support_iff']
  rintro x âŸ¨m, hmâŸ©
  exact âŸ¨f m, fun r hr â†¦ by simpa using hf.ne (hm r hr)âŸ©
",Formal Proof of Stacks Project Tag 00L3,(2),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Support.lean#L154-L158,Q27041,,10.40.9,lemma,3.0,"['080S', '00AO', '0ELQ']","\n  Lemma 10.40.9. Let $R$ be a ring and let $M$ be an $R$-module. \n  \n  \nIf $M$ is finite then the support of $M/IM$ is $\\text{Supp}(M) \\cap V(I)$. \n\n\nIf $N \\subset M$, then $\\text{Supp}(N) \\subset \\text{Supp}(M)$. \n\n\nIf $Q$ is a quotient module of $M$ then $\\text{Supp}(Q) \\subset \\text{Supp}(M)$. \n\n\nIf $0 \\to N \\to M \\to Q \\to 0$ is a short exact sequence then $\\text{Supp}(M) = \\text{Supp}(Q) \\cup \\text{Supp}(N)$. \n\n\n\n\n    \n      Proof.\n      The functors $M \\mapsto M_{\\mathfrak p}$ are exact. This immediately implies all but the first assertion. For the first assertion we need to show that $M_\\mathfrak p \\not= 0$ and $I \\subset \\mathfrak p$ implies $(M/IM)_{\\mathfrak p} = M_\\mathfrak p/IM_\\mathfrak p \\not= 0$. This follows from Nakayama\'s Lemma 10.20.1. \n      $\\square$\n    \n","\n  Lemma 10.40.9. Let $R$ be a ring and let $M$ be an $R$-module. \n  \n  \nIf $M$ is finite then the support of $M/IM$ is $\\text{Supp}(M) \\cap V(I)$. \n\n\nIf $N \\subset M$, then $\\text{Supp}(N) \\subset \\text{Supp}(M)$. \n\n\nIf $Q$ is a quotient module of $M$ then $\\text{Supp}(Q) \\subset \\text{Supp}(M)$. \n\n\nIf $0 \\to N \\to M \\to Q \\to 0$ is a short exact sequence then $\\text{Supp}(M) = \\text{Supp}(Q) \\cup \\text{Supp}(N)$. \n\n\n\n\n    \n",Proof.\n      The functors $M \\mapsto M_{\\mathfrak p}$ are exact. This immediately implies all but the first assertion. For the first assertion we need to show that $M_\\mathfrak p \\not= 0$ and $I \\subset \\mathfrak p$ implies $(M/IM)_{\\mathfrak p} = M_\\mathfrak p/IM_\\mathfrak p \\not= 0$. This follows from Nakayama\'s Lemma 10.20.1. \n      $\\square$\n    \n," by
  simp_rw [Set.subset_def, mem_support_iff']
  rintro x âŸ¨m, hmâŸ©
  exact âŸ¨f m, fun r hr â†¦ by simpa using hf.ne (hm r hr)âŸ©
","lemma Module.support_subset_of_injective (hf : Function.Injective f) :
    Module.support R M âŠ† Module.support R N ","Proof.\n      The functors $M \\mapsto M_{\\mathfrak p}$ are exact. This immediately implies all but the first assertion. For the first assertion we need to show that $M_\\mathfrak p \\not= 0$ and $I \\subset \\mathfrak p$ implies $(M/IM)_{\\mathfrak p} = M_\\mathfrak p/IM_\\mathfrak p \\not= 0$. This follows from Nakayama\'s Lemma 10.20.1 [[\n        \n      \n      \n  Lemma 10.20.1 (Nakayama\'s lemma). Let $R$ be a ring with Jacobson radical $\\text{rad}(R)$. Let $M$ be an $R$-module. Let $I \\subset R$ be an ideal. \n  \n  \n If $IM = M$ and $M$ is finite, then there exists an $f \\in 1 + I$ such that $fM = 0$. \n\n\nIf $IM = M$, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $M = 0$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, and $N\'$ is finite, then there exists an $f \\in 1 + I$ such that $fM \\subset N$ and $M_ f = N_ f$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, $N\'$ is finite, and $I \\subset \\text{rad}(R)$, then $M = N$. \n\n\nIf $N \\to M$ is a module map, $N/IN \\to M/IM$ is surjective, and $M$ is finite, then there exists an $f \\in 1 + I$ such that $N_ f \\to M_ f$ is surjective. \n\n\nIf $N \\to M$ is a module map, $N/IN \\to M/IM$ is surjective, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $N \\to M$ is surjective. \n\n\nIf $x_1, \\ldots , x_ n \\in M$ generate $M/IM$ and $M$ is finite, then there exists an $f \\in 1 + I$ such that $x_1, \\ldots , x_ n$ generate $M_ f$ over $R_ f$. \n\n\nIf $x_1, \\ldots , x_ n \\in M$ generate $M/IM$, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $M$ is generated by $x_1, \\ldots , x_ n$. \n\n\nIf $IM = M$, $I$ is nilpotent, then $M = 0$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, and $I$ is nilpotent then $M = N$. \n\n\nIf $N \\to M$ is a module map, $I$ is nilpotent, and $N/IN \\to M/IM$ is surjective, then $N \\to M$ is surjective. \n\n\nIf $\\{ x_\\alpha \\} _{\\alpha \\in A}$ is a set of elements of $M$ which generate $M/IM$ and $I$ is nilpotent, then $M$ is generated by the $x_\\alpha $. \n\n\n\n\n    \n]]. \n      $\\square$\n    \n"
237,00L3,"lemma Module.support_subset_of_surjective (hf : Function.Surjective f) :
    Module.support R N âŠ† Module.support R M := by
  simp_rw [Set.subset_def, mem_support_iff']
  rintro x âŸ¨m, hmâŸ©
  obtain âŸ¨m, rflâŸ© := hf m
  exact âŸ¨m, fun r hr e â†¦ hm r hr (by simpa using congr(f $e))âŸ©
",Formal Proof of Stacks Project Tag 00L3,(3),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Support.lean#L161-L166,Q27041,,10.40.9,lemma,3.0,"['080S', '00AO', '0ELQ']","\n  Lemma 10.40.9. Let $R$ be a ring and let $M$ be an $R$-module. \n  \n  \nIf $M$ is finite then the support of $M/IM$ is $\\text{Supp}(M) \\cap V(I)$. \n\n\nIf $N \\subset M$, then $\\text{Supp}(N) \\subset \\text{Supp}(M)$. \n\n\nIf $Q$ is a quotient module of $M$ then $\\text{Supp}(Q) \\subset \\text{Supp}(M)$. \n\n\nIf $0 \\to N \\to M \\to Q \\to 0$ is a short exact sequence then $\\text{Supp}(M) = \\text{Supp}(Q) \\cup \\text{Supp}(N)$. \n\n\n\n\n    \n      Proof.\n      The functors $M \\mapsto M_{\\mathfrak p}$ are exact. This immediately implies all but the first assertion. For the first assertion we need to show that $M_\\mathfrak p \\not= 0$ and $I \\subset \\mathfrak p$ implies $(M/IM)_{\\mathfrak p} = M_\\mathfrak p/IM_\\mathfrak p \\not= 0$. This follows from Nakayama\'s Lemma 10.20.1. \n      $\\square$\n    \n","\n  Lemma 10.40.9. Let $R$ be a ring and let $M$ be an $R$-module. \n  \n  \nIf $M$ is finite then the support of $M/IM$ is $\\text{Supp}(M) \\cap V(I)$. \n\n\nIf $N \\subset M$, then $\\text{Supp}(N) \\subset \\text{Supp}(M)$. \n\n\nIf $Q$ is a quotient module of $M$ then $\\text{Supp}(Q) \\subset \\text{Supp}(M)$. \n\n\nIf $0 \\to N \\to M \\to Q \\to 0$ is a short exact sequence then $\\text{Supp}(M) = \\text{Supp}(Q) \\cup \\text{Supp}(N)$. \n\n\n\n\n    \n",Proof.\n      The functors $M \\mapsto M_{\\mathfrak p}$ are exact. This immediately implies all but the first assertion. For the first assertion we need to show that $M_\\mathfrak p \\not= 0$ and $I \\subset \\mathfrak p$ implies $(M/IM)_{\\mathfrak p} = M_\\mathfrak p/IM_\\mathfrak p \\not= 0$. This follows from Nakayama\'s Lemma 10.20.1. \n      $\\square$\n    \n," by
  simp_rw [Set.subset_def, mem_support_iff']
  rintro x âŸ¨m, hmâŸ©
  obtain âŸ¨m, rflâŸ© := hf m
  exact âŸ¨m, fun r hr e â†¦ hm r hr (by simpa using congr(f $e))âŸ©
","lemma Module.support_subset_of_surjective (hf : Function.Surjective f) :
    Module.support R N âŠ† Module.support R M ","Proof.\n      The functors $M \\mapsto M_{\\mathfrak p}$ are exact. This immediately implies all but the first assertion. For the first assertion we need to show that $M_\\mathfrak p \\not= 0$ and $I \\subset \\mathfrak p$ implies $(M/IM)_{\\mathfrak p} = M_\\mathfrak p/IM_\\mathfrak p \\not= 0$. This follows from Nakayama\'s Lemma 10.20.1 [[\n        \n      \n      \n  Lemma 10.20.1 (Nakayama\'s lemma). Let $R$ be a ring with Jacobson radical $\\text{rad}(R)$. Let $M$ be an $R$-module. Let $I \\subset R$ be an ideal. \n  \n  \n If $IM = M$ and $M$ is finite, then there exists an $f \\in 1 + I$ such that $fM = 0$. \n\n\nIf $IM = M$, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $M = 0$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, and $N\'$ is finite, then there exists an $f \\in 1 + I$ such that $fM \\subset N$ and $M_ f = N_ f$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, $N\'$ is finite, and $I \\subset \\text{rad}(R)$, then $M = N$. \n\n\nIf $N \\to M$ is a module map, $N/IN \\to M/IM$ is surjective, and $M$ is finite, then there exists an $f \\in 1 + I$ such that $N_ f \\to M_ f$ is surjective. \n\n\nIf $N \\to M$ is a module map, $N/IN \\to M/IM$ is surjective, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $N \\to M$ is surjective. \n\n\nIf $x_1, \\ldots , x_ n \\in M$ generate $M/IM$ and $M$ is finite, then there exists an $f \\in 1 + I$ such that $x_1, \\ldots , x_ n$ generate $M_ f$ over $R_ f$. \n\n\nIf $x_1, \\ldots , x_ n \\in M$ generate $M/IM$, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $M$ is generated by $x_1, \\ldots , x_ n$. \n\n\nIf $IM = M$, $I$ is nilpotent, then $M = 0$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, and $I$ is nilpotent then $M = N$. \n\n\nIf $N \\to M$ is a module map, $I$ is nilpotent, and $N/IN \\to M/IM$ is surjective, then $N \\to M$ is surjective. \n\n\nIf $\\{ x_\\alpha \\} _{\\alpha \\in A}$ is a set of elements of $M$ which generate $M/IM$ and $I$ is nilpotent, then $M$ is generated by the $x_\\alpha $. \n\n\n\n\n    \n]]. \n      $\\square$\n    \n"
238,00L3,"lemma Module.support_of_exact (h : Function.Exact f g)
    (hf : Function.Injective f) (hg : Function.Surjective g) :
    Module.support R N = Module.support R M âˆª Module.support R P := by
  refine subset_antisymm ?_ (Set.union_subset (Module.support_subset_of_injective f hf)
    (Module.support_subset_of_surjective g hg))
  intro x
  contrapose
  simp only [Set.mem_union, not_or, and_imp, notMem_support_iff']
  intro Hâ‚ Hâ‚‚ m
  obtain âŸ¨r, hr, eâ‚âŸ© := Hâ‚‚ (g m)
  rw [â† map_smul, h] at eâ‚
  obtain âŸ¨m', hm'âŸ© := eâ‚
  obtain âŸ¨s, hs, eâ‚âŸ© := Hâ‚ m'
  exact âŸ¨_, x.asIdeal.primeCompl.mul_mem hs hr, by rw [mul_smul, â† hm', â† map_smul, eâ‚, map_zero]âŸ©
",Formal Proof of Stacks Project Tag 00L3,(4),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Support.lean#L171-L184,Q27041,,10.40.9,lemma,3.0,"['080S', '00AO', '0ELQ']","\n  Lemma 10.40.9. Let $R$ be a ring and let $M$ be an $R$-module. \n  \n  \nIf $M$ is finite then the support of $M/IM$ is $\\text{Supp}(M) \\cap V(I)$. \n\n\nIf $N \\subset M$, then $\\text{Supp}(N) \\subset \\text{Supp}(M)$. \n\n\nIf $Q$ is a quotient module of $M$ then $\\text{Supp}(Q) \\subset \\text{Supp}(M)$. \n\n\nIf $0 \\to N \\to M \\to Q \\to 0$ is a short exact sequence then $\\text{Supp}(M) = \\text{Supp}(Q) \\cup \\text{Supp}(N)$. \n\n\n\n\n    \n      Proof.\n      The functors $M \\mapsto M_{\\mathfrak p}$ are exact. This immediately implies all but the first assertion. For the first assertion we need to show that $M_\\mathfrak p \\not= 0$ and $I \\subset \\mathfrak p$ implies $(M/IM)_{\\mathfrak p} = M_\\mathfrak p/IM_\\mathfrak p \\not= 0$. This follows from Nakayama\'s Lemma 10.20.1. \n      $\\square$\n    \n","\n  Lemma 10.40.9. Let $R$ be a ring and let $M$ be an $R$-module. \n  \n  \nIf $M$ is finite then the support of $M/IM$ is $\\text{Supp}(M) \\cap V(I)$. \n\n\nIf $N \\subset M$, then $\\text{Supp}(N) \\subset \\text{Supp}(M)$. \n\n\nIf $Q$ is a quotient module of $M$ then $\\text{Supp}(Q) \\subset \\text{Supp}(M)$. \n\n\nIf $0 \\to N \\to M \\to Q \\to 0$ is a short exact sequence then $\\text{Supp}(M) = \\text{Supp}(Q) \\cup \\text{Supp}(N)$. \n\n\n\n\n    \n",Proof.\n      The functors $M \\mapsto M_{\\mathfrak p}$ are exact. This immediately implies all but the first assertion. For the first assertion we need to show that $M_\\mathfrak p \\not= 0$ and $I \\subset \\mathfrak p$ implies $(M/IM)_{\\mathfrak p} = M_\\mathfrak p/IM_\\mathfrak p \\not= 0$. This follows from Nakayama\'s Lemma 10.20.1. \n      $\\square$\n    \n," by
  refine subset_antisymm ?_ (Set.union_subset (Module.support_subset_of_injective f hf)
    (Module.support_subset_of_surjective g hg))
  intro x
  contrapose
  simp only [Set.mem_union, not_or, and_imp, notMem_support_iff']
  intro Hâ‚ Hâ‚‚ m
  obtain âŸ¨r, hr, eâ‚âŸ© := Hâ‚‚ (g m)
  rw [â† map_smul, h] at eâ‚
  obtain âŸ¨m', hm'âŸ© := eâ‚
  obtain âŸ¨s, hs, eâ‚âŸ© := Hâ‚ m'
  exact âŸ¨_, x.asIdeal.primeCompl.mul_mem hs hr, by rw [mul_smul, â† hm', â† map_smul, eâ‚, map_zero]âŸ©
","lemma Module.support_of_exact (h : Function.Exact f g)
    (hf : Function.Injective f) (hg : Function.Surjective g) :
    Module.support R N = Module.support R M âˆª Module.support R P ","Proof.\n      The functors $M \\mapsto M_{\\mathfrak p}$ are exact. This immediately implies all but the first assertion. For the first assertion we need to show that $M_\\mathfrak p \\not= 0$ and $I \\subset \\mathfrak p$ implies $(M/IM)_{\\mathfrak p} = M_\\mathfrak p/IM_\\mathfrak p \\not= 0$. This follows from Nakayama\'s Lemma 10.20.1 [[\n        \n      \n      \n  Lemma 10.20.1 (Nakayama\'s lemma). Let $R$ be a ring with Jacobson radical $\\text{rad}(R)$. Let $M$ be an $R$-module. Let $I \\subset R$ be an ideal. \n  \n  \n If $IM = M$ and $M$ is finite, then there exists an $f \\in 1 + I$ such that $fM = 0$. \n\n\nIf $IM = M$, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $M = 0$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, and $N\'$ is finite, then there exists an $f \\in 1 + I$ such that $fM \\subset N$ and $M_ f = N_ f$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, $N\'$ is finite, and $I \\subset \\text{rad}(R)$, then $M = N$. \n\n\nIf $N \\to M$ is a module map, $N/IN \\to M/IM$ is surjective, and $M$ is finite, then there exists an $f \\in 1 + I$ such that $N_ f \\to M_ f$ is surjective. \n\n\nIf $N \\to M$ is a module map, $N/IN \\to M/IM$ is surjective, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $N \\to M$ is surjective. \n\n\nIf $x_1, \\ldots , x_ n \\in M$ generate $M/IM$ and $M$ is finite, then there exists an $f \\in 1 + I$ such that $x_1, \\ldots , x_ n$ generate $M_ f$ over $R_ f$. \n\n\nIf $x_1, \\ldots , x_ n \\in M$ generate $M/IM$, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $M$ is generated by $x_1, \\ldots , x_ n$. \n\n\nIf $IM = M$, $I$ is nilpotent, then $M = 0$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, and $I$ is nilpotent then $M = N$. \n\n\nIf $N \\to M$ is a module map, $I$ is nilpotent, and $N/IN \\to M/IM$ is surjective, then $N \\to M$ is surjective. \n\n\nIf $\\{ x_\\alpha \\} _{\\alpha \\in A}$ is a set of elements of $M$ which generate $M/IM$ and $I$ is nilpotent, then $M$ is generated by the $x_\\alpha $. \n\n\n\n\n    \n]]. \n      $\\square$\n    \n"
239,00L2,"lemma Module.support_eq_zeroLocus :
    Module.support R M = zeroLocus (Module.annihilator R M) :=
  Set.ext fun _ â†¦ mem_support_iff_of_finite
",Formal Proof of Stacks Project Tag 00L2,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Support.lean#L214-L216,Q27041,,10.40.5,lemma,3.0,"['080S', '00AO', '0ELQ']","\n  Lemma 10.40.5. Let $R$ be a ring and let $M$ be an $R$-module. If $M$ is finite, then $\\text{Supp}(M)$ is closed. More precisely, if $I = \\text{Ann}(M)$ is the annihilator of $M$, then $V(I) = \\text{Supp}(M)$. \n\n    \n      Proof.\n      We will show that $V(I) = \\text{Supp}(M)$. \n    \n      Suppose $\\mathfrak p \\in \\text{Supp}(M)$. Then $M_{\\mathfrak p} \\not= 0$. Choose an element $m \\in M$ whose image in $M_\\mathfrak p$ is nonzero. Then the annihilator of $m$ is contained in $\\mathfrak p$ by construction of the localization $M_\\mathfrak p$. Hence a fortiori $I = \\text{Ann}(M)$ must be contained in $\\mathfrak p$. \n    \n      Conversely, suppose that $\\mathfrak p \\not\\in \\text{Supp}(M)$. Then $M_{\\mathfrak p} = 0$. Let $x_1, \\ldots , x_ r \\in M$ be generators. By Lemma 10.9.9 there exists an $f \\in R$, $f\\not\\in \\mathfrak p$ such that $x_ i/1 = 0$ in $M_ f$. Hence $f^{n_ i} x_ i = 0$ for some $n_ i \\geq 1$. Hence $f^ nM = 0$ for $n = \\max \\{ n_ i\\} $ as desired. \n      $\\square$\n    \n","\n  Lemma 10.40.5. Let $R$ be a ring and let $M$ be an $R$-module. If $M$ is finite, then $\\text{Supp}(M)$ is closed. More precisely, if $I = \\text{Ann}(M)$ is the annihilator of $M$, then $V(I) = \\text{Supp}(M)$. \n\n    \n","Proof.\n      We will show that $V(I) = \\text{Supp}(M)$. \n    \n      Suppose $\\mathfrak p \\in \\text{Supp}(M)$. Then $M_{\\mathfrak p} \\not= 0$. Choose an element $m \\in M$ whose image in $M_\\mathfrak p$ is nonzero. Then the annihilator of $m$ is contained in $\\mathfrak p$ by construction of the localization $M_\\mathfrak p$. Hence a fortiori $I = \\text{Ann}(M)$ must be contained in $\\mathfrak p$. \n    \n      Conversely, suppose that $\\mathfrak p \\not\\in \\text{Supp}(M)$. Then $M_{\\mathfrak p} = 0$. Let $x_1, \\ldots , x_ r \\in M$ be generators. By Lemma 10.9.9 there exists an $f \\in R$, $f\\not\\in \\mathfrak p$ such that $x_ i/1 = 0$ in $M_ f$. Hence $f^{n_ i} x_ i = 0$ for some $n_ i \\geq 1$. Hence $f^ nM = 0$ for $n = \\max \\{ n_ i\\} $ as desired. \n      $\\square$\n    \n","
  Set.ext fun _ â†¦ mem_support_iff_of_finite
","lemma Module.support_eq_zeroLocus :
    Module.support R M = zeroLocus (Module.annihilator R M) ","Proof.\n      We will show that $V(I) = \\text{Supp}(M)$. \n    \n      Suppose $\\mathfrak p \\in \\text{Supp}(M)$. Then $M_{\\mathfrak p} \\not= 0$. Choose an element $m \\in M$ whose image in $M_\\mathfrak p$ is nonzero. Then the annihilator of $m$ is contained in $\\mathfrak p$ by construction of the localization $M_\\mathfrak p$. Hence a fortiori $I = \\text{Ann}(M)$ must be contained in $\\mathfrak p$. \n    \n      Conversely, suppose that $\\mathfrak p \\not\\in \\text{Supp}(M)$. Then $M_{\\mathfrak p} = 0$. Let $x_1, \\ldots , x_ r \\in M$ be generators. By Lemma 10.9.9 [[\n  Lemma 10.9.9. Let $R$ be a ring. Let $S \\subset R$ be a multiplicative subset. Let $M$ be an $R$-module. Then \n  \n  \\[  S^{-1}M = \\mathop{\\mathrm{colim}}\\nolimits _{f \\in S} M_ f  \\]\n\n   where the preorder on $S$ is given by $f \\geq f\' \\Leftrightarrow f = f\'f\'\'$ for some $f\'\' \\in R$ in which case the map $M_{f\'} \\to M_ f$ is given by $m/(f\')^ e \\mapsto m(f\'\')^ e/f^ e$. \n\n    \n]] there exists an $f \\in R$, $f\\not\\in \\mathfrak p$ such that $x_ i/1 = 0$ in $M_ f$. Hence $f^{n_ i} x_ i = 0$ for some $n_ i \\geq 1$. Hence $f^ nM = 0$ for $n = \\max \\{ n_ i\\} $ as desired. \n      $\\square$\n    \n"
240,00L3,"theorem Module.support_quotient (I : Ideal R) :
    support R (M â§¸ (I â€¢ âŠ¤ : Submodule R M)) = support R M âˆ© zeroLocus I := by
  apply subset_antisymm
  Â· refine Set.subset_inter ?_ ?_
    Â· exact Module.support_subset_of_surjective _ (Submodule.mkQ_surjective _)
    Â· rw [support_eq_zeroLocus]
      apply PrimeSpectrum.zeroLocus_anti_mono_ideal
      rw [Submodule.annihilator_quotient]
      exact fun x hx â†¦ Submodule.mem_colon.mpr fun p hp â†¦ Submodule.smul_mem_smul hx hp
  Â· rintro p âŸ¨hpâ‚, hpâ‚‚âŸ©
    rw [Module.mem_support_iff] at hpâ‚ âŠ¢
    let Râ‚š := Localization.AtPrime p.asIdeal
    let Mâ‚š := LocalizedModule p.asIdeal.primeCompl M
    set Mâ‚š' := LocalizedModule p.asIdeal.primeCompl (M â§¸ (I â€¢ âŠ¤ : Submodule R M))
    let Mâ‚š'' := Mâ‚š â§¸ I.map (algebraMap R Râ‚š) â€¢ (âŠ¤ : Submodule Râ‚š Mâ‚š)
    let e : Mâ‚š' â‰ƒâ‚—[Râ‚š] Mâ‚š'' := (localizedQuotientEquiv _ _).symm â‰ªâ‰«â‚—
      Submodule.quotEquivOfEq _ _ (by rw [Submodule.localized,
        Submodule.localized'_smul, Ideal.localized'_eq_map, Submodule.localized'_top])
    have : Nontrivial Mâ‚š'' := by
      rw [Submodule.Quotient.nontrivial_iff, ne_comm]
      apply Submodule.top_ne_ideal_smul_of_le_jacobson_annihilator
      refine trans ?_ (IsLocalRing.maximalIdeal_le_jacobson _)
      rw [â† Localization.AtPrime.map_eq_maximalIdeal]
      exact Ideal.map_mono hpâ‚‚
    exact e.nontrivial
",Formal Proof of Stacks Project Tag 00L3,(1),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Support.lean#L241-L265,Q27041,,10.40.9,lemma,3.0,"['080S', '00AO', '0ELQ']","\n  Lemma 10.40.9. Let $R$ be a ring and let $M$ be an $R$-module. \n  \n  \nIf $M$ is finite then the support of $M/IM$ is $\\text{Supp}(M) \\cap V(I)$. \n\n\nIf $N \\subset M$, then $\\text{Supp}(N) \\subset \\text{Supp}(M)$. \n\n\nIf $Q$ is a quotient module of $M$ then $\\text{Supp}(Q) \\subset \\text{Supp}(M)$. \n\n\nIf $0 \\to N \\to M \\to Q \\to 0$ is a short exact sequence then $\\text{Supp}(M) = \\text{Supp}(Q) \\cup \\text{Supp}(N)$. \n\n\n\n\n    \n      Proof.\n      The functors $M \\mapsto M_{\\mathfrak p}$ are exact. This immediately implies all but the first assertion. For the first assertion we need to show that $M_\\mathfrak p \\not= 0$ and $I \\subset \\mathfrak p$ implies $(M/IM)_{\\mathfrak p} = M_\\mathfrak p/IM_\\mathfrak p \\not= 0$. This follows from Nakayama\'s Lemma 10.20.1. \n      $\\square$\n    \n","\n  Lemma 10.40.9. Let $R$ be a ring and let $M$ be an $R$-module. \n  \n  \nIf $M$ is finite then the support of $M/IM$ is $\\text{Supp}(M) \\cap V(I)$. \n\n\nIf $N \\subset M$, then $\\text{Supp}(N) \\subset \\text{Supp}(M)$. \n\n\nIf $Q$ is a quotient module of $M$ then $\\text{Supp}(Q) \\subset \\text{Supp}(M)$. \n\n\nIf $0 \\to N \\to M \\to Q \\to 0$ is a short exact sequence then $\\text{Supp}(M) = \\text{Supp}(Q) \\cup \\text{Supp}(N)$. \n\n\n\n\n    \n",Proof.\n      The functors $M \\mapsto M_{\\mathfrak p}$ are exact. This immediately implies all but the first assertion. For the first assertion we need to show that $M_\\mathfrak p \\not= 0$ and $I \\subset \\mathfrak p$ implies $(M/IM)_{\\mathfrak p} = M_\\mathfrak p/IM_\\mathfrak p \\not= 0$. This follows from Nakayama\'s Lemma 10.20.1. \n      $\\square$\n    \n," by
  apply subset_antisymm
  Â· refine Set.subset_inter ?_ ?_
    Â· exact Module.support_subset_of_surjective _ (Submodule.mkQ_surjective _)
    Â· rw [support_eq_zeroLocus]
      apply PrimeSpectrum.zeroLocus_anti_mono_ideal
      rw [Submodule.annihilator_quotient]
      exact fun x hx â†¦ Submodule.mem_colon.mpr fun p hp â†¦ Submodule.smul_mem_smul hx hp
  Â· rintro p âŸ¨hpâ‚, hpâ‚‚âŸ©
    rw [Module.mem_support_iff] at hpâ‚ âŠ¢
    let Râ‚š := Localization.AtPrime p.asIdeal
    let Mâ‚š := LocalizedModule p.asIdeal.primeCompl M
    set Mâ‚š' := LocalizedModule p.asIdeal.primeCompl (M â§¸ (I â€¢ âŠ¤ : Submodule R M))
    let Mâ‚š'' := Mâ‚š â§¸ I.map (algebraMap R Râ‚š) â€¢ (âŠ¤ : Submodule Râ‚š Mâ‚š)
    let e : Mâ‚š' â‰ƒâ‚—[Râ‚š] Mâ‚š'' := (localizedQuotientEquiv _ _).symm â‰ªâ‰«â‚—
      Submodule.quotEquivOfEq _ _ (by rw [Submodule.localized,
        Submodule.localized'_smul, Ideal.localized'_eq_map, Submodule.localized'_top])
    have : Nontrivial Mâ‚š'' := by
      rw [Submodule.Quotient.nontrivial_iff, ne_comm]
      apply Submodule.top_ne_ideal_smul_of_le_jacobson_annihilator
      refine trans ?_ (IsLocalRing.maximalIdeal_le_jacobson _)
      rw [â† Localization.AtPrime.map_eq_maximalIdeal]
      exact Ideal.map_mono hpâ‚‚
    exact e.nontrivial
","theorem Module.support_quotient (I : Ideal R) :
    support R (M â§¸ (I â€¢ âŠ¤ : Submodule R M)) = support R M âˆ© zeroLocus I ","Proof.\n      The functors $M \\mapsto M_{\\mathfrak p}$ are exact. This immediately implies all but the first assertion. For the first assertion we need to show that $M_\\mathfrak p \\not= 0$ and $I \\subset \\mathfrak p$ implies $(M/IM)_{\\mathfrak p} = M_\\mathfrak p/IM_\\mathfrak p \\not= 0$. This follows from Nakayama\'s Lemma 10.20.1 [[\n        \n      \n      \n  Lemma 10.20.1 (Nakayama\'s lemma). Let $R$ be a ring with Jacobson radical $\\text{rad}(R)$. Let $M$ be an $R$-module. Let $I \\subset R$ be an ideal. \n  \n  \n If $IM = M$ and $M$ is finite, then there exists an $f \\in 1 + I$ such that $fM = 0$. \n\n\nIf $IM = M$, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $M = 0$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, and $N\'$ is finite, then there exists an $f \\in 1 + I$ such that $fM \\subset N$ and $M_ f = N_ f$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, $N\'$ is finite, and $I \\subset \\text{rad}(R)$, then $M = N$. \n\n\nIf $N \\to M$ is a module map, $N/IN \\to M/IM$ is surjective, and $M$ is finite, then there exists an $f \\in 1 + I$ such that $N_ f \\to M_ f$ is surjective. \n\n\nIf $N \\to M$ is a module map, $N/IN \\to M/IM$ is surjective, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $N \\to M$ is surjective. \n\n\nIf $x_1, \\ldots , x_ n \\in M$ generate $M/IM$ and $M$ is finite, then there exists an $f \\in 1 + I$ such that $x_1, \\ldots , x_ n$ generate $M_ f$ over $R_ f$. \n\n\nIf $x_1, \\ldots , x_ n \\in M$ generate $M/IM$, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $M$ is generated by $x_1, \\ldots , x_ n$. \n\n\nIf $IM = M$, $I$ is nilpotent, then $M = 0$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, and $I$ is nilpotent then $M = N$. \n\n\nIf $N \\to M$ is a module map, $I$ is nilpotent, and $N/IN \\to M/IM$ is surjective, then $N \\to M$ is surjective. \n\n\nIf $\\{ x_\\alpha \\} _{\\alpha \\in A}$ is a set of elements of $M$ which generate $M/IM$ and $I$ is nilpotent, then $M$ is generated by the $x_\\alpha $. \n\n\n\n\n    \n]]. \n      $\\square$\n    \n"
241,00IS,"theorem fg_of_fg_of_fg [IsNoetherianRing A] (hAC : (âŠ¤ : Subalgebra A C).FG)
    (hBC : (âŠ¤ : Submodule B C).FG) (hBCi : Function.Injective (algebraMap B C)) :
    (âŠ¤ : Subalgebra A B).FG :=
  let âŸ¨Bâ‚€, hABâ‚€, hBâ‚€CâŸ© := exists_subalgebra_of_fg A B C hAC hBC
  Algebra.fg_trans' (Bâ‚€.fg_top.2 hABâ‚€) <|
    Subalgebra.fg_of_submodule_fg <|
      have : IsNoetherianRing Bâ‚€ := isNoetherianRing_of_fg hABâ‚€
      have : Module.Finite Bâ‚€ C := âŸ¨hBâ‚€CâŸ©
      fg_of_injective (IsScalarTower.toAlgHom Bâ‚€ B C).toLinearMap hBCi
",Formal Proof of Stacks Project Tag 00IS,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Adjoin/Tower.lean#L150-L158,Q27041,Artin-Tate,10.51.7,lemma,3.0,"['00IJ', '00AO', '0ELQ']","\n  Lemma 10.51.7 (Artin-Tate).  Let $R$ be a Noetherian ring. Let $S$ be a finitely generated $R$-algebra. If $T \\subset S$ is an $R$-subalgebra such that $S$ is finitely generated as a $T$-module, then $T$ is of finite type over $R$. \n\n    \n      Proof.\n      Choose elements $x_1, \\ldots , x_ n \\in S$ which generate $S$ as an $R$-algebra. Choose $y_1, \\ldots , y_ m$ in $S$ which generate $S$ as a $T$-module. Thus there exist $a_{ij} \\in T$ such that $x_ i = \\sum a_{ij} y_ j$. There also exist $b_{ijk} \\in T$ such that $y_ i y_ j = \\sum b_{ijk} y_ k$. Let $T\' \\subset T$ be the sub $R$-algebra generated by $a_{ij}$ and $b_{ijk}$. This is a finitely generated $R$-algebra, hence Noetherian. Consider the algebra \n    \n      \n  \\[  S\' = T\'[Y_1, \\ldots , Y_ m]/(Y_ i Y_ j - \\sum b_{ijk} Y_ k).  \\]\n\n    \n       Note that $S\'$ is finite over $T\'$, namely as a $T\'$-module it is generated by the classes of $1, Y_1, \\ldots , Y_ m$. Consider the $T\'$-algebra homomorphism $S\' \\to S$ which maps $Y_ i$ to $y_ i$. Because $a_{ij} \\in T\'$ we see that $x_ j$ is in the image of this map. Thus $S\' \\to S$ is surjective. Therefore $S$ is finite over $T\'$ as well. Since $T\'$ is Noetherian we conclude that $T \\subset S$ is finite over $T\'$ and we win. \n      $\\square$\n    \n","\n  Lemma 10.51.7 (Artin-Tate).  Let $R$ be a Noetherian ring. Let $S$ be a finitely generated $R$-algebra. If $T \\subset S$ is an $R$-subalgebra such that $S$ is finitely generated as a $T$-module, then $T$ is of finite type over $R$. \n\n    \n","Proof.\n      Choose elements $x_1, \\ldots , x_ n \\in S$ which generate $S$ as an $R$-algebra. Choose $y_1, \\ldots , y_ m$ in $S$ which generate $S$ as a $T$-module. Thus there exist $a_{ij} \\in T$ such that $x_ i = \\sum a_{ij} y_ j$. There also exist $b_{ijk} \\in T$ such that $y_ i y_ j = \\sum b_{ijk} y_ k$. Let $T\' \\subset T$ be the sub $R$-algebra generated by $a_{ij}$ and $b_{ijk}$. This is a finitely generated $R$-algebra, hence Noetherian. Consider the algebra \n    \n      \n  \\[  S\' = T\'[Y_1, \\ldots , Y_ m]/(Y_ i Y_ j - \\sum b_{ijk} Y_ k).  \\]\n\n    \n       Note that $S\'$ is finite over $T\'$, namely as a $T\'$-module it is generated by the classes of $1, Y_1, \\ldots , Y_ m$. Consider the $T\'$-algebra homomorphism $S\' \\to S$ which maps $Y_ i$ to $y_ i$. Because $a_{ij} \\in T\'$ we see that $x_ j$ is in the image of this map. Thus $S\' \\to S$ is surjective. Therefore $S$ is finite over $T\'$ as well. Since $T\'$ is Noetherian we conclude that $T \\subset S$ is finite over $T\'$ and we win. \n      $\\square$\n    \n","
  let âŸ¨Bâ‚€, hABâ‚€, hBâ‚€CâŸ© := exists_subalgebra_of_fg A B C hAC hBC
  Algebra.fg_trans' (Bâ‚€.fg_top.2 hABâ‚€) <|
    Subalgebra.fg_of_submodule_fg <|
      have : IsNoetherianRing Bâ‚€ := isNoetherianRing_of_fg hABâ‚€
      have : Module.Finite Bâ‚€ C := âŸ¨hBâ‚€CâŸ©
      fg_of_injective (IsScalarTower.toAlgHom Bâ‚€ B C).toLinearMap hBCi
","theorem fg_of_fg_of_fg [IsNoetherianRing A] (hAC : (âŠ¤ : Subalgebra A C).FG)
    (hBC : (âŠ¤ : Submodule B C).FG) (hBCi : Function.Injective (algebraMap B C)) :
    (âŠ¤ : Subalgebra A B).FG ","Proof.\n      Choose elements $x_1, \\ldots , x_ n \\in S$ which generate $S$ as an $R$-algebra. Choose $y_1, \\ldots , y_ m$ in $S$ which generate $S$ as a $T$-module. Thus there exist $a_{ij} \\in T$ such that $x_ i = \\sum a_{ij} y_ j$. There also exist $b_{ijk} \\in T$ such that $y_ i y_ j = \\sum b_{ijk} y_ k$. Let $T\' \\subset T$ be the sub $R$-algebra generated by $a_{ij}$ and $b_{ijk}$. This is a finitely generated $R$-algebra, hence Noetherian. Consider the algebra \n    \n      \n  \\[  S\' = T\'[Y_1, \\ldots , Y_ m]/(Y_ i Y_ j - \\sum b_{ijk} Y_ k).  \\]\n\n    \n       Note that $S\'$ is finite over $T\'$, namely as a $T\'$-module it is generated by the classes of $1, Y_1, \\ldots , Y_ m$. Consider the $T\'$-algebra homomorphism $S\' \\to S$ which maps $Y_ i$ to $y_ i$. Because $a_{ij} \\in T\'$ we see that $x_ j$ is in the image of this map. Thus $S\' \\to S$ is surjective. Therefore $S$ is finite over $T\'$ as well. Since $T\'$ is Noetherian we conclude that $T \\subset S$ is finite over $T\'$ and we win. \n      $\\square$\n    \n"
242,09GF,"theorem IsAlgebraic.tower_top {x : A} (A_alg : IsAlgebraic K x) :
    IsAlgebraic L x :=
  A_alg.extendScalars (algebraMap K L).injective
",Formal Proof of Stacks Project Tag 09GF,part one,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Algebraic/Basic.lean#L450-L452,Q27041,,9.8.4,lemma,3.0,"['09GB', '09FA', '0ELQ']","\n  Lemma 9.8.4. Let $K/E/F$ be a tower of field extensions. \n  \n  \nIf $\\alpha \\in K$ is algebraic over $F$, then $\\alpha $ is algebraic over $E$. \n\n\nIf $K$ is algebraic over $F$, then $K$ is algebraic over $E$. \n\n\n\n\n    \n      Proof.\n      This is immediate from the definitions. \n      $\\square$\n    \n","\n  Lemma 9.8.4. Let $K/E/F$ be a tower of field extensions. \n  \n  \nIf $\\alpha \\in K$ is algebraic over $F$, then $\\alpha $ is algebraic over $E$. \n\n\nIf $K$ is algebraic over $F$, then $K$ is algebraic over $E$. \n\n\n\n\n    \n",Proof.\n      This is immediate from the definitions. \n      $\\square$\n    \n,"
  A_alg.extendScalars (algebraMap K L).injective
","theorem IsAlgebraic.tower_top {x : A} (A_alg : IsAlgebraic K x) :
    IsAlgebraic L x ",Proof.\n      This is immediate from the definitions. \n      $\\square$\n    \n
243,09GF,"theorem Algebra.IsAlgebraic.tower_top [Algebra.IsAlgebraic K A] : Algebra.IsAlgebraic L A :=
  Algebra.IsAlgebraic.extendScalars (algebraMap K L).injective
",Formal Proof of Stacks Project Tag 09GF,part two,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Algebraic/Basic.lean#L462-L463,Q27041,,9.8.4,lemma,3.0,"['09GB', '09FA', '0ELQ']","\n  Lemma 9.8.4. Let $K/E/F$ be a tower of field extensions. \n  \n  \nIf $\\alpha \\in K$ is algebraic over $F$, then $\\alpha $ is algebraic over $E$. \n\n\nIf $K$ is algebraic over $F$, then $K$ is algebraic over $E$. \n\n\n\n\n    \n      Proof.\n      This is immediate from the definitions. \n      $\\square$\n    \n","\n  Lemma 9.8.4. Let $K/E/F$ be a tower of field extensions. \n  \n  \nIf $\\alpha \\in K$ is algebraic over $F$, then $\\alpha $ is algebraic over $E$. \n\n\nIf $K$ is algebraic over $F$, then $K$ is algebraic over $E$. \n\n\n\n\n    \n",Proof.\n      This is immediate from the definitions. \n      $\\square$\n    \n,"
  Algebra.IsAlgebraic.extendScalars (algebraMap K L).injective
",theorem Algebra.IsAlgebraic.tower_top [Algebra.IsAlgebraic K A] : Algebra.IsAlgebraic L A ,Proof.\n      This is immediate from the definitions. \n      $\\square$\n    \n
244,0BID,"theorem Subalgebra.isField_of_algebraic [Algebra.IsAlgebraic K L] : IsField A :=
  { show Nontrivial A by infer_instance, Subalgebra.toCommRing A with
    mul_inv_cancel := fun {a} ha =>
      âŸ¨âŸ¨aâ»Â¹, A.inv_mem_of_algebraic (Algebra.IsAlgebraic.isAlgebraic (a : L))âŸ©,
        Subtype.ext (mul_inv_cancelâ‚€ (mt (Subalgebra.coe_eq_zero _).mp ha))âŸ© }
",Formal Proof of Stacks Project Tag 0BID,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Algebraic/Basic.lean#L648-L652,Q27041,,9.8.10,lemma,3.0,"['09GB', '09FA', '0ELQ']","\n  Lemma 9.8.10. Let $E/F$ be a finite or more generally an algebraic extension of fields. Any subring $F \\subset R \\subset E$ is a field. \n\n    \n      Proof.\n      Let $\\alpha \\in R$ be nonzero. Then $1, \\alpha , \\alpha ^2, \\ldots $ are contained in $R$. By Lemma 9.8.5 we find a nontrivial relation $a_0 + a_1 \\alpha + \\ldots + a_ d \\alpha ^ d = 0$ with $a_ i \\in F$. We may assume $a_0 \\not= 0$ because if not we can divide the relation by $\\alpha $ to decrease $d$. Then we see that \n    \n      \n  \\[  a_0 = \\alpha (- a_1 - \\ldots - a_ d \\alpha ^{d - 1})  \\]\n\n    \n       which proves that the inverse of $\\alpha $ is the element $a_0^{-1} (- a_1 - \\ldots - a_ d \\alpha ^{d - 1})$ of $R$. \n      $\\square$\n    \n",\n  Lemma 9.8.10. Let $E/F$ be a finite or more generally an algebraic extension of fields. Any subring $F \\subset R \\subset E$ is a field. \n\n    \n,"Proof.\n      Let $\\alpha \\in R$ be nonzero. Then $1, \\alpha , \\alpha ^2, \\ldots $ are contained in $R$. By Lemma 9.8.5 we find a nontrivial relation $a_0 + a_1 \\alpha + \\ldots + a_ d \\alpha ^ d = 0$ with $a_ i \\in F$. We may assume $a_0 \\not= 0$ because if not we can divide the relation by $\\alpha $ to decrease $d$. Then we see that \n    \n      \n  \\[  a_0 = \\alpha (- a_1 - \\ldots - a_ d \\alpha ^{d - 1})  \\]\n\n    \n       which proves that the inverse of $\\alpha $ is the element $a_0^{-1} (- a_1 - \\ldots - a_ d \\alpha ^{d - 1})$ of $R$. \n      $\\square$\n    \n","
  { show Nontrivial A by infer_instance, Subalgebra.toCommRing A with
    mul_inv_cancel := fun {a} ha =>
      âŸ¨âŸ¨aâ»Â¹, A.inv_mem_of_algebraic (Algebra.IsAlgebraic.isAlgebraic (a : L))âŸ©,
        Subtype.ext (mul_inv_cancelâ‚€ (mt (Subalgebra.coe_eq_zero _).mp ha))âŸ© }
",theorem Subalgebra.isField_of_algebraic [Algebra.IsAlgebraic K L] : IsField A ,"Proof.\n      Let $\\alpha \\in R$ be nonzero. Then $1, \\alpha , \\alpha ^2, \\ldots $ are contained in $R$. By Lemma 9.8.5 [[\n  Lemma 9.8.5. A finite extension is algebraic. In fact, an extension $E/k$ is algebraic if and only if every subextension $k(\\alpha )/k$ generated by some $\\alpha \\in E$ is finite. \n\n    \n]] we find a nontrivial relation $a_0 + a_1 \\alpha + \\ldots + a_ d \\alpha ^ d = 0$ with $a_ i \\in F$. We may assume $a_0 \\not= 0$ because if not we can divide the relation by $\\alpha $ to decrease $d$. Then we see that \n    \n      \n  \\[  a_0 = \\alpha (- a_1 - \\ldots - a_ d \\alpha ^{d - 1})  \\]\n\n    \n       which proves that the inverse of $\\alpha $ is the element $a_0^{-1} (- a_1 - \\ldots - a_ d \\alpha ^{d - 1})$ of $R$. \n      $\\square$\n    \n"
245,09GC,"def IsAlgebraic (x : A) : Prop :=
  âˆƒ p : R[X], p â‰  0 âˆ§ aeval x p = 0
",Formal Proof of Stacks Project Tag 09GC,Algebraic elements,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Algebraic/Defs.lean#L45-L46,Q27041,,9.8.1,definition,3.0,"['09GB', '09FA', '0ELQ']",\n  Definition 9.8.1. Consider a field extension $F/E$. An element $\\alpha \\in F$ is said to be algebraic over $E$ if $\\alpha $ is the root of some nonzero polynomial with coefficients in $E$. If all elements of $F$ are algebraic then $F$ is said to be an algebraic extension of $E$. \n,\n  Definition 9.8.1. Consider a field extension $F/E$. An element $\\alpha \\in F$ is said to be algebraic over $E$ if $\\alpha $ is the root of some nonzero polynomial with coefficients in $E$. If all elements of $F$ are algebraic then $F$ is said to be an algebraic extension of $E$. \n,,"
  âˆƒ p : R[X], p â‰  0 âˆ§ aeval x p = 0
",def IsAlgebraic (x : A) : Prop ,
246,09GC,"protected class Algebra.IsAlgebraic : Prop where
  isAlgebraic : âˆ€ x : A, IsAlgebraic R x
",Formal Proof of Stacks Project Tag 09GC,Algebraic extensions,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Algebraic/Defs.lean#L68-L69,Q27041,,9.8.1,definition,3.0,"['09GB', '09FA', '0ELQ']",\n  Definition 9.8.1. Consider a field extension $F/E$. An element $\\alpha \\in F$ is said to be algebraic over $E$ if $\\alpha $ is the root of some nonzero polynomial with coefficients in $E$. If all elements of $F$ are algebraic then $F$ is said to be an algebraic extension of $E$. \n,\n  Definition 9.8.1. Consider a field extension $F/E$. An element $\\alpha \\in F$ is said to be algebraic over $E$ if $\\alpha $ is the root of some nonzero polynomial with coefficients in $E$. If all elements of $F$ are algebraic then $F$ is said to be an algebraic extension of $E$. \n,,,"protected class Algebra.IsAlgebraic : Prop where
  isAlgebraic : âˆ€ x : A, IsAlgebraic R x
",
247,09GG,"instance Algebra.IsAlgebraic.of_finite [Module.Finite R A] : Algebra.IsAlgebraic R A :=
  (IsIntegral.of_finite R A).isAlgebraic
",Formal Proof of Stacks Project Tag 09GG,first part,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Algebraic/Integral.lean#L107-L108,Q27041,,9.8.5,lemma,3.0,"['09GB', '09FA', '0ELQ']","\n  Lemma 9.8.5. A finite extension is algebraic. In fact, an extension $E/k$ is algebraic if and only if every subextension $k(\\alpha )/k$ generated by some $\\alpha \\in E$ is finite. \n\n    \n      Proof.\n      Let $E/k$ be finite, say of degree $n$. Choose $\\alpha \\in E$. Then the elements $1, \\alpha , \\ldots , \\alpha ^ n$ are linearly dependent over $k$, or we would necessarily have $[E : k] > n$. A relation of linear dependence now gives the desired polynomial that $\\alpha $ must satisfy. \n    \n      For the last assertion, note that a monogenic extension $k(\\alpha )/k$ is finite if and only if $\\alpha $ is algebraic over $k$, by Examples 9.7.4 and 9.7.6. So if $E/k$ is algebraic, then each $k(\\alpha )/k$, $\\alpha \\in E$, is a finite extension, and conversely. \n      $\\square$\n    \n","\n  Lemma 9.8.5. A finite extension is algebraic. In fact, an extension $E/k$ is algebraic if and only if every subextension $k(\\alpha )/k$ generated by some $\\alpha \\in E$ is finite. \n\n    \n","Proof.\n      Let $E/k$ be finite, say of degree $n$. Choose $\\alpha \\in E$. Then the elements $1, \\alpha , \\ldots , \\alpha ^ n$ are linearly dependent over $k$, or we would necessarily have $[E : k] > n$. A relation of linear dependence now gives the desired polynomial that $\\alpha $ must satisfy. \n    \n      For the last assertion, note that a monogenic extension $k(\\alpha )/k$ is finite if and only if $\\alpha $ is algebraic over $k$, by Examples 9.7.4 and 9.7.6. So if $E/k$ is algebraic, then each $k(\\alpha )/k$, $\\alpha \\in E$, is a finite extension, and conversely. \n      $\\square$\n    \n","
  (IsIntegral.of_finite R A).isAlgebraic
",instance Algebra.IsAlgebraic.of_finite [Module.Finite R A] : Algebra.IsAlgebraic R A ,"Proof.\n      Let $E/k$ be finite, say of degree $n$. Choose $\\alpha \\in E$. Then the elements $1, \\alpha , \\ldots , \\alpha ^ n$ are linearly dependent over $k$, or we would necessarily have $[E : k] > n$. A relation of linear dependence now gives the desired polynomial that $\\alpha $ must satisfy. \n    \n      For the last assertion, note that a monogenic extension $k(\\alpha )/k$ is finite if and only if $\\alpha $ is algebraic over $k$, by Examples 9.7.4 [[\n  Example 9.7.4 (Degree of a rational function field).  If $k$ is any field, then the rational function field $k(t)$ is not a finite extension. For example the elements $\\left\\{ t^ n, n \\in \\mathbf{Z}\\right\\} $ are linearly independent over $k$. \n  In fact, if $k$ is uncountable, then $k(t)$ is uncountably dimensional as a $k$-vector space. To show this, we claim that the family of elements $\\{ 1/(t- \\alpha ), \\alpha \\in k\\}  \\subset k(t)$ is linearly independent over $k$. A nontrivial relation between them would lead to a contradiction: for instance, if one works over $\\mathbf{C}$, then this follows because $\\frac{1}{t-\\alpha }$, when considered as a meromorphic function on $\\mathbf{C}$, has a pole at $\\alpha $ and nowhere else. Consequently any sum $\\sum c_ i \\frac{1}{t - \\alpha _ i}$ for the $c_ i \\in k^*$, and $\\alpha _ i \\in k$ distinct, would have poles at each of the $\\alpha _ i$. In particular, it could not be zero. \n  Amusingly, this leads to a quick proof of the Hilbert Nullstellensatz over the complex numbers. For a slightly more general result, see Algebra, Theorem 10.35.11. \n]] and 9.7.6 [[\n  Example 9.7.6 (Degree of a simple algebraic extension).  Consider a monogenic field extension $E/k$ of the form discussed in Example 9.6.4. In other words, $E = k[t]/(P)$ for $P \\in k[t]$ an irreducible polynomial. Then the degree $[E : k]$ is just the degree $d = \\deg (P)$ of the polynomial $P$. Indeed, say \n  \n    9.7.6.1\n  \\begin{equation}  \\label{fields-equation-P} P = a_ d t^ d + a_{d - 1} t^{d - 1} + \\ldots + a_0. \\end{equation}\n\n   with $a_ d \\not= 0$. Then the images of $1, t, \\ldots , t^{d - 1}$ in $k[t]/(P)$ are linearly independent over $k$, because any relation involving them would have degree strictly smaller than that of $P$, and $P$ is the element of smallest degree in the ideal $(P)$. \n  Conversely, the set $S = \\{ 1, t, \\ldots , t^{d - 1}\\} $ (or more properly their images) spans $k[t]/(P)$ as a vector space. Indeed, we have by (9.7.6.1) that $a_ d t^ d$ lies in the span of $S$. Since $a_ d$ is invertible, we see that $t^ d$ is in the span of $S$. Similarly, the relation $t P(t) = 0$ shows that the image of $t^{d + 1}$ lies in the span of $\\{ 1, t, \\ldots , t^ d\\} $ \xe2\x80\x94 by what was just shown, thus in the span of $S$. Working upward inductively, we find that the image of $t^ n$ for $n \\geq d$ lies in the span of $S$. \n]]. So if $E/k$ is algebraic, then each $k(\\alpha )/k$, $\\alpha \\in E$, is a finite extension, and conversely. \n      $\\square$\n    \n"
248,09GJ,"    Algebra.IsAlgebraic R A :=
  âŸ¨fun _ â†¦ (alg.1 _).restrictScalars _âŸ©
",Formal Proof of Stacks Project Tag 09GJ, theorem IsAlgebraic.trans [Algebra.IsAlgebraic R S] [alg : Algebra.IsAlgebraic S A] ,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Algebraic/Integral.lean#L324-L325,Q27041,,9.8.8,lemma,3.0,"['09GB', '09FA', '0ELQ']","\n  Lemma 9.8.8. Let $E/k$ and $F/E$ be algebraic extensions of fields. Then $F/k$ is an algebraic extension of fields. \n\n    \n      Proof.\n      Choose $\\alpha \\in F$. Then $\\alpha $ is algebraic over $E$. The key observation is that $\\alpha $ is algebraic over a finitely generated subextension of $k$. That is, there is a finite set $S \\subset E$ such that $\\alpha $ is algebraic over $k(S)$: this is clear because being algebraic means that a certain polynomial in $E[x]$ that $\\alpha $ satisfies exists, and as $S$ we can take the coefficients of this polynomial. It follows that $\\alpha $ is algebraic over $k(S)$. In particular, the extension $k(S, \\alpha )/ k(S)$ is finite. Since $S$ is a finite set, and $k(S)/k$ is algebraic, Lemma 9.8.6 shows that $k(S)/k$ is finite. Using multiplicativity (Lemma 9.7.7) we find that $k(S,\\alpha )/k$ is finite, so $\\alpha $ is algebraic over $k$. \n      $\\square$\n    \n",\n  Lemma 9.8.8. Let $E/k$ and $F/E$ be algebraic extensions of fields. Then $F/k$ is an algebraic extension of fields. \n\n    \n,"Proof.\n      Choose $\\alpha \\in F$. Then $\\alpha $ is algebraic over $E$. The key observation is that $\\alpha $ is algebraic over a finitely generated subextension of $k$. That is, there is a finite set $S \\subset E$ such that $\\alpha $ is algebraic over $k(S)$: this is clear because being algebraic means that a certain polynomial in $E[x]$ that $\\alpha $ satisfies exists, and as $S$ we can take the coefficients of this polynomial. It follows that $\\alpha $ is algebraic over $k(S)$. In particular, the extension $k(S, \\alpha )/ k(S)$ is finite. Since $S$ is a finite set, and $k(S)/k$ is algebraic, Lemma 9.8.6 shows that $k(S)/k$ is finite. Using multiplicativity (Lemma 9.7.7) we find that $k(S,\\alpha )/k$ is finite, so $\\alpha $ is algebraic over $k$. \n      $\\square$\n    \n","
  âŸ¨fun _ â†¦ (alg.1 _).restrictScalars _âŸ©
",    Algebra.IsAlgebraic R A ,"Proof.\n      Choose $\\alpha \\in F$. Then $\\alpha $ is algebraic over $E$. The key observation is that $\\alpha $ is algebraic over a finitely generated subextension of $k$. That is, there is a finite set $S \\subset E$ such that $\\alpha $ is algebraic over $k(S)$: this is clear because being algebraic means that a certain polynomial in $E[x]$ that $\\alpha $ satisfies exists, and as $S$ we can take the coefficients of this polynomial. It follows that $\\alpha $ is algebraic over $k(S)$. In particular, the extension $k(S, \\alpha )/ k(S)$ is finite. Since $S$ is a finite set, and $k(S)/k$ is algebraic, Lemma 9.8.6 [[\n       \n      \n  Lemma 9.8.6. Let $k$ be a field, and let $\\alpha _1, \\alpha _2, \\ldots , \\alpha _ n$ be elements of some extension field such that each $\\alpha _ i$ is algebraic over $k$. Then the extension $k(\\alpha _1, \\ldots , \\alpha _ n)/k$ is finite. That is, a finitely generated algebraic extension is finite. \n\n    \n]] shows that $k(S)/k$ is finite. Using multiplicativity (Lemma 9.7.7 [[\n  Lemma 9.7.7 (Multiplicativity).  Suppose given a tower of fields $F/E/k$. Then \n  \n  \\[  [F:k] = [F:E][E:k]  \\]\n\n\n    \n]]) we find that $k(S,\\alpha )/k$ is finite, so $\\alpha $ is algebraic over $k$. \n      $\\square$\n    \n"
249,0G1M,"    Module.rank (FractionRing R[X]) (FractionRing S[X]) = Module.rank R S := by
  have := (FaithfulSMul.algebraMap_injective R S).isDomain
  rw [rank_fractionRing, rank_polynomial_polynomial]
",Formal Proof of Stacks Project Tag 0G1M, theorem rank_fractionRing_polynomial ,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Algebraic/Integral.lean#L631-L633,Q27041,,9.26.10,lemma,3.0,"['030D', '09FA', '0ELQ']","\n  Lemma 9.26.10. Let $k\'/k$ be a finite extension of fields. Let $k\'(x_1, \\ldots , x_ r)/k(x_1, \\ldots , x_ r)$ be the induced extension of purely transcendental extensions. Then $[k\'(x_1, \\ldots , x_ r) : k(x_1, \\ldots , x_ r)] = [k\' : k] < \\infty $. \n\n    \n      Proof.\n      By multiplicativity of degrees of extensions (Lemma 9.7.7) it suffices to prove this when $k\'$ is generated by a single element $\\alpha \\in k\'$ over $k$. Let $f \\in k[T]$ be the minimal polynomial of $\\alpha $ over $k$. Then $k\'(x_1, \\ldots , x_ r)$ is generated by $\\alpha , x_1, \\ldots , x_ r$ over $k$ and hence $k\'(x_1, \\ldots , x_ r)$ is generated by $\\alpha $ over $k(x_1, \\ldots , x_ r)$. Thus it suffices to show that $f$ is still irreducible as an element of $k(x_1, \\ldots , x_ r)[T]$. We only sketch the proof. It is clear that $f$ is irreducible as an element of $k[x_1, \\ldots , x_ r, T]$ for example because $f$ is monic as a polynomial in $T$ and any putative factorization in $k[x_1, \\ldots , x_ r, T]$ would lead to a factorization in $k[T]$ by setting $x_ i$ equal to $0$. By Gauss\' lemma we conclude. \n      $\\square$\n    \n","\n  Lemma 9.26.10. Let $k\'/k$ be a finite extension of fields. Let $k\'(x_1, \\ldots , x_ r)/k(x_1, \\ldots , x_ r)$ be the induced extension of purely transcendental extensions. Then $[k\'(x_1, \\ldots , x_ r) : k(x_1, \\ldots , x_ r)] = [k\' : k] < \\infty $. \n\n    \n","Proof.\n      By multiplicativity of degrees of extensions (Lemma 9.7.7) it suffices to prove this when $k\'$ is generated by a single element $\\alpha \\in k\'$ over $k$. Let $f \\in k[T]$ be the minimal polynomial of $\\alpha $ over $k$. Then $k\'(x_1, \\ldots , x_ r)$ is generated by $\\alpha , x_1, \\ldots , x_ r$ over $k$ and hence $k\'(x_1, \\ldots , x_ r)$ is generated by $\\alpha $ over $k(x_1, \\ldots , x_ r)$. Thus it suffices to show that $f$ is still irreducible as an element of $k(x_1, \\ldots , x_ r)[T]$. We only sketch the proof. It is clear that $f$ is irreducible as an element of $k[x_1, \\ldots , x_ r, T]$ for example because $f$ is monic as a polynomial in $T$ and any putative factorization in $k[x_1, \\ldots , x_ r, T]$ would lead to a factorization in $k[T]$ by setting $x_ i$ equal to $0$. By Gauss\' lemma we conclude. \n      $\\square$\n    \n"," by
  have := (FaithfulSMul.algebraMap_injective R S).isDomain
  rw [rank_fractionRing, rank_polynomial_polynomial]
",    Module.rank (FractionRing R[X]) (FractionRing S[X]) = Module.rank R S ,"Proof.\n      By multiplicativity of degrees of extensions (Lemma 9.7.7 [[\n  Lemma 9.7.7 (Multiplicativity).  Suppose given a tower of fields $F/E/k$. Then \n  \n  \\[  [F:k] = [F:E][E:k]  \\]\n\n\n    \n]]) it suffices to prove this when $k\'$ is generated by a single element $\\alpha \\in k\'$ over $k$. Let $f \\in k[T]$ be the minimal polynomial of $\\alpha $ over $k$. Then $k\'(x_1, \\ldots , x_ r)$ is generated by $\\alpha , x_1, \\ldots , x_ r$ over $k$ and hence $k\'(x_1, \\ldots , x_ r)$ is generated by $\\alpha $ over $k(x_1, \\ldots , x_ r)$. Thus it suffices to show that $f$ is still irreducible as an element of $k(x_1, \\ldots , x_ r)[T]$. We only sketch the proof. It is clear that $f$ is irreducible as an element of $k[x_1, \\ldots , x_ r, T]$ for example because $f$ is monic as a polynomial in $T$ and any putative factorization in $k[x_1, \\ldots , x_ r, T]$ would lead to a factorization in $k[T]$ by setting $x_ i$ equal to $0$. By Gauss\' lemma we conclude. \n      $\\square$\n    \n"
250,0G1M,"    Module.rank (FractionRing (MvPolynomial Ïƒ R)) (FractionRing (MvPolynomial Ïƒ S)) =
    lift.{u} (Module.rank R S) := by
  have := (FaithfulSMul.algebraMap_injective R S).isDomain
  rw [rank_fractionRing, rank_mvPolynomial_mvPolynomial]
",Formal Proof of Stacks Project Tag 0G1M, theorem rank_fractionRing_mvPolynomial (Ïƒ : Type u) ,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Algebraic/Integral.lean#L637-L640,Q27041,,9.26.10,lemma,3.0,"['030D', '09FA', '0ELQ']","\n  Lemma 9.26.10. Let $k\'/k$ be a finite extension of fields. Let $k\'(x_1, \\ldots , x_ r)/k(x_1, \\ldots , x_ r)$ be the induced extension of purely transcendental extensions. Then $[k\'(x_1, \\ldots , x_ r) : k(x_1, \\ldots , x_ r)] = [k\' : k] < \\infty $. \n\n    \n      Proof.\n      By multiplicativity of degrees of extensions (Lemma 9.7.7) it suffices to prove this when $k\'$ is generated by a single element $\\alpha \\in k\'$ over $k$. Let $f \\in k[T]$ be the minimal polynomial of $\\alpha $ over $k$. Then $k\'(x_1, \\ldots , x_ r)$ is generated by $\\alpha , x_1, \\ldots , x_ r$ over $k$ and hence $k\'(x_1, \\ldots , x_ r)$ is generated by $\\alpha $ over $k(x_1, \\ldots , x_ r)$. Thus it suffices to show that $f$ is still irreducible as an element of $k(x_1, \\ldots , x_ r)[T]$. We only sketch the proof. It is clear that $f$ is irreducible as an element of $k[x_1, \\ldots , x_ r, T]$ for example because $f$ is monic as a polynomial in $T$ and any putative factorization in $k[x_1, \\ldots , x_ r, T]$ would lead to a factorization in $k[T]$ by setting $x_ i$ equal to $0$. By Gauss\' lemma we conclude. \n      $\\square$\n    \n","\n  Lemma 9.26.10. Let $k\'/k$ be a finite extension of fields. Let $k\'(x_1, \\ldots , x_ r)/k(x_1, \\ldots , x_ r)$ be the induced extension of purely transcendental extensions. Then $[k\'(x_1, \\ldots , x_ r) : k(x_1, \\ldots , x_ r)] = [k\' : k] < \\infty $. \n\n    \n","Proof.\n      By multiplicativity of degrees of extensions (Lemma 9.7.7) it suffices to prove this when $k\'$ is generated by a single element $\\alpha \\in k\'$ over $k$. Let $f \\in k[T]$ be the minimal polynomial of $\\alpha $ over $k$. Then $k\'(x_1, \\ldots , x_ r)$ is generated by $\\alpha , x_1, \\ldots , x_ r$ over $k$ and hence $k\'(x_1, \\ldots , x_ r)$ is generated by $\\alpha $ over $k(x_1, \\ldots , x_ r)$. Thus it suffices to show that $f$ is still irreducible as an element of $k(x_1, \\ldots , x_ r)[T]$. We only sketch the proof. It is clear that $f$ is irreducible as an element of $k[x_1, \\ldots , x_ r, T]$ for example because $f$ is monic as a polynomial in $T$ and any putative factorization in $k[x_1, \\ldots , x_ r, T]$ would lead to a factorization in $k[T]$ by setting $x_ i$ equal to $0$. By Gauss\' lemma we conclude. \n      $\\square$\n    \n"," by
  have := (FaithfulSMul.algebraMap_injective R S).isDomain
  rw [rank_fractionRing, rank_mvPolynomial_mvPolynomial]
","    Module.rank (FractionRing (MvPolynomial Ïƒ R)) (FractionRing (MvPolynomial Ïƒ S)) =
    lift.{u} (Module.rank R S) ","Proof.\n      By multiplicativity of degrees of extensions (Lemma 9.7.7 [[\n  Lemma 9.7.7 (Multiplicativity).  Suppose given a tower of fields $F/E/k$. Then \n  \n  \\[  [F:k] = [F:E][E:k]  \\]\n\n\n    \n]]) it suffices to prove this when $k\'$ is generated by a single element $\\alpha \\in k\'$ over $k$. Let $f \\in k[T]$ be the minimal polynomial of $\\alpha $ over $k$. Then $k\'(x_1, \\ldots , x_ r)$ is generated by $\\alpha , x_1, \\ldots , x_ r$ over $k$ and hence $k\'(x_1, \\ldots , x_ r)$ is generated by $\\alpha $ over $k(x_1, \\ldots , x_ r)$. Thus it suffices to show that $f$ is still irreducible as an element of $k(x_1, \\ldots , x_ r)[T]$. We only sketch the proof. It is clear that $f$ is irreducible as an element of $k[x_1, \\ldots , x_ r, T]$ for example because $f$ is monic as a polynomial in $T$ and any putative factorization in $k[x_1, \\ldots , x_ r, T]$ would lead to a factorization in $k[T]$ by setting $x_ i$ equal to $0$. By Gauss\' lemma we conclude. \n      $\\square$\n    \n"
251,00PZ,"def IsStronglyTranscendental (x : S) : Prop :=
  âˆ€ u : S, âˆ€ p : R[X], p.aeval x * u = 0 â†’ p.map (algebraMap R S) * C u = 0
",Formal Proof of Stacks Project Tag 00PZ,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Algebraic/StronglyTranscendental.lean#L37-L38,Q27041,,10.123.7,definition,3.0,"['00PI', '00AO', '0ELQ']","\n  Definition 10.123.7. Given an inclusion of rings $R \\subset S$ and an element $x \\in S$ we say that $x$ is strongly transcendental over $R$ if whenever $u(a_0 + a_1 x + \\ldots + a_ k x^ k) = 0$ with $u \\in S$ and $a_ i \\in R$, then we have $ua_ i = 0$ for all $i$. \n","\n  Definition 10.123.7. Given an inclusion of rings $R \\subset S$ and an element $x \\in S$ we say that $x$ is strongly transcendental over $R$ if whenever $u(a_0 + a_1 x + \\ldots + a_ k x^ k) = 0$ with $u \\in S$ and $a_ i \\in R$, then we have $ua_ i = 0$ for all $i$. \n",,"
  âˆ€ u : S, âˆ€ p : R[X], p.aeval x * u = 0 â†’ p.map (algebraMap R S) * C u = 0
",def IsStronglyTranscendental (x : S) : Prop ,
252,00Q0,"lemma isStronglyTranscendental_mk_of_mem_minimalPrimes [IsReduced S]
    {x : S} (hx : IsStronglyTranscendental R x) (q : Ideal S) (hq : q âˆˆ minimalPrimes S) :
    IsStronglyTranscendental R (Ideal.Quotient.mk q x) := by
  refine Ideal.Quotient.mk_surjective.forall.mpr fun u p e â†¦ ?_
  rw [â† Ideal.Quotient.algebraMap_eq, aeval_algebraMap_apply, Ideal.Quotient.algebraMap_eq,
    â† map_mul, Ideal.Quotient.eq_zero_iff_mem] at e
  have := hq.1.1
  have : Ring.KrullDimLE 0 (Localization.AtPrime q) := .of_isLocalization _ hq _
  let : Field (Localization.AtPrime q) := Ring.KrullDimLE.isField_of_isReduced.toField
  obtain âŸ¨âŸ¨m, hmqâŸ©, hmâŸ© := (IsLocalization.map_eq_zero_iff q.primeCompl (Localization.AtPrime q)
    (aeval x p * u)).mp (by rw [â† Ideal.mem_bot, â† IsLocalRing.maximalIdeal_eq_bot,
      â† Localization.AtPrime.map_eq_maximalIdeal]; exact Ideal.mem_map_of_mem _ e)
  ext i
  simp only [coeff_mul_C, coeff_map, coeff_zero, â† Ideal.Quotient.mk_algebraMap, â† map_mul,
    Ideal.Quotient.eq_zero_iff_mem]
  have : algebraMap R S (p.coeff i) * u * m = 0 := by
    simpa [â† mul_assoc] using congr(($(hx (u * m) p (by linear_combination hm))).coeff i)
  exact (Ideal.IsPrime.mem_or_mem_of_mul_eq_zero â€¹_â€º (by linear_combination this)).resolve_left hmq
",Formal Proof of Stacks Project Tag 00Q0,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Algebraic/StronglyTranscendental.lean#L123,Q27041,,10.123.8,lemma,3.0,"['00PI', '00AO', '0ELQ']","\n  Lemma 10.123.8. Suppose $R \\subset S$ is an inclusion of reduced rings and suppose that $x \\in S$ is strongly transcendental over $R$. Let $\\mathfrak q \\subset S$ be a minimal prime and let $\\mathfrak p = R \\cap \\mathfrak q$. Then the image of $x$ in $S/\\mathfrak q$ is strongly transcendental over the subring $R/\\mathfrak p$. \n\n    \n      Proof.\n      Suppose $u(a_0 + a_1x + \\ldots + a_ k x^ k) \\in \\mathfrak q$. By Lemma 10.25.1 the local ring $S_{\\mathfrak q}$ is a field, and hence $u(a_0 + a_1x + \\ldots + a_ k x^ k) $ is zero in $S_{\\mathfrak q}$. Thus $uu\'(a_0 + a_1x + \\ldots + a_ k x^ k) = 0$ for some $u\' \\in S$, $u\' \\not\\in \\mathfrak q$. Since $x$ is strongly transcendental over $R$ we get $uu\'a_ i = 0$ for all $i$. This in turn implies that $ua_ i \\in \\mathfrak q$. \n      $\\square$\n    \n",\n  Lemma 10.123.8. Suppose $R \\subset S$ is an inclusion of reduced rings and suppose that $x \\in S$ is strongly transcendental over $R$. Let $\\mathfrak q \\subset S$ be a minimal prime and let $\\mathfrak p = R \\cap \\mathfrak q$. Then the image of $x$ in $S/\\mathfrak q$ is strongly transcendental over the subring $R/\\mathfrak p$. \n\n    \n,"Proof.\n      Suppose $u(a_0 + a_1x + \\ldots + a_ k x^ k) \\in \\mathfrak q$. By Lemma 10.25.1 the local ring $S_{\\mathfrak q}$ is a field, and hence $u(a_0 + a_1x + \\ldots + a_ k x^ k) $ is zero in $S_{\\mathfrak q}$. Thus $uu\'(a_0 + a_1x + \\ldots + a_ k x^ k) = 0$ for some $u\' \\in S$, $u\' \\not\\in \\mathfrak q$. Since $x$ is strongly transcendental over $R$ we get $uu\'a_ i = 0$ for all $i$. This in turn implies that $ua_ i \\in \\mathfrak q$. \n      $\\square$\n    \n"," by
  refine Ideal.Quotient.mk_surjective.forall.mpr fun u p e â†¦ ?_
  rw [â† Ideal.Quotient.algebraMap_eq, aeval_algebraMap_apply, Ideal.Quotient.algebraMap_eq,
    â† map_mul, Ideal.Quotient.eq_zero_iff_mem] at e
  have := hq.1.1
  have : Ring.KrullDimLE 0 (Localization.AtPrime q) := .of_isLocalization _ hq _
  let : Field (Localization.AtPrime q) := Ring.KrullDimLE.isField_of_isReduced.toField
  obtain âŸ¨âŸ¨m, hmqâŸ©, hmâŸ© := (IsLocalization.map_eq_zero_iff q.primeCompl (Localization.AtPrime q)
    (aeval x p * u)).mp (by rw [â† Ideal.mem_bot, â† IsLocalRing.maximalIdeal_eq_bot,
      â† Localization.AtPrime.map_eq_maximalIdeal]; exact Ideal.mem_map_of_mem _ e)
  ext i
  simp only [coeff_mul_C, coeff_map, coeff_zero, â† Ideal.Quotient.mk_algebraMap, â† map_mul,
    Ideal.Quotient.eq_zero_iff_mem]
  have : algebraMap R S (p.coeff i) * u * m = 0 := by
    simpa [â† mul_assoc] using congr(($(hx (u * m) p (by linear_combination hm))).coeff i)
  exact (Ideal.IsPrime.mem_or_mem_of_mul_eq_zero â€¹_â€º (by linear_combination this)).resolve_left hmq
","lemma isStronglyTranscendental_mk_of_mem_minimalPrimes [IsReduced S]
    {x : S} (hx : IsStronglyTranscendental R x) (q : Ideal S) (hq : q âˆˆ minimalPrimes S) :
    IsStronglyTranscendental R (Ideal.Quotient.mk q x) ","Proof.\n      Suppose $u(a_0 + a_1x + \\ldots + a_ k x^ k) \\in \\mathfrak q$. By Lemma 10.25.1 [[\n  Lemma 10.25.1. Let $\\mathfrak p$ be a minimal prime of a ring $R$. Every element of the maximal ideal of $R_{\\mathfrak p}$ is nilpotent. If $R$ is reduced then $R_{\\mathfrak p}$ is a field. \n\n    \n]] the local ring $S_{\\mathfrak q}$ is a field, and hence $u(a_0 + a_1x + \\ldots + a_ k x^ k) $ is zero in $S_{\\mathfrak q}$. Thus $uu\'(a_0 + a_1x + \\ldots + a_ k x^ k) = 0$ for some $u\' \\in S$, $u\' \\not\\in \\mathfrak q$. Since $x$ is strongly transcendental over $R$ we get $uu\'a_ i = 0$ for all $i$. This in turn implies that $ua_ i \\in \\mathfrak q$. \n      $\\square$\n    \n"
253,030G,"  â¨† Î¹ : { s : Set A // AlgebraicIndepOn R _root_.id s }, Cardinal.mk Î¹.1
",Formal Proof of Stacks Project Tag 030G, def Algebra.trdeg : Cardinal.{v} :,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/AlgebraicIndependent/Basic.lean#L46-L46,Q27041,,9.26.4,definition,3.0,"['030D', '09FA', '0ELQ']",\n  Definition 9.26.4. Let $K/k$ be a field extension. The transcendence degree of $K$ over $k$ is the cardinality of a transcendence basis of $K$ over $k$. It is denoted $\\text{trdeg}_ k(K)$. \n,\n  Definition 9.26.4. Let $K/k$ be a field extension. The transcendence degree of $K$ over $k$ is the cardinality of a transcendence basis of $K$ over $k$. It is denoted $\\text{trdeg}_ k(K)$. \n,,,"  â¨† Î¹ : { s : Set A // AlgebraicIndepOn R _root_.id s }, Cardinal.mk Î¹.1
",
254,030E,"  Injective (MvPolynomial.aeval x : MvPolynomial Î¹ R â†’â‚[R] A)
",Formal Proof of Stacks Project Tag 030E,(1)] def AlgebraicIndependent : Prop :,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/AlgebraicIndependent/Defs.lean#L55-L55,Q27041,,9.26.1,definition,3.0,"['030D', '09FA', '0ELQ']",\n  Definition 9.26.1. Let $K/k$ be a field extension. \n  \n  \nA collection of elements $\\{ x_ i\\} _{i \\in I}$ of $K$ is called algebraically independent over $k$ if the map \n\n\n  \\[  k[X_ i; i\\in I] \\longrightarrow K  \\]\n\n\n which maps $X_ i$ to $x_ i$ is injective. \n\n\nThe field of fractions of a polynomial ring $k[x_ i; i \\in I]$ is denoted $k(x_ i; i\\in I)$. \n\n\nA purely transcendental extension of $k$ is any field extension $K/k$ isomorphic to the field of fractions of a polynomial ring over $k$. \n\n\nA transcendence basis of $K/k$ is a collection of elements $\\{ x_ i\\} _{i \\in I}$ which are algebraically independent over $k$ and such that the extension $K/k(x_ i; i\\in I)$ is algebraic. \n\n\n\n,\n  Definition 9.26.1. Let $K/k$ be a field extension. \n  \n  \nA collection of elements $\\{ x_ i\\} _{i \\in I}$ of $K$ is called algebraically independent over $k$ if the map \n\n\n  \\[  k[X_ i; i\\in I] \\longrightarrow K  \\]\n\n\n which maps $X_ i$ to $x_ i$ is injective. \n\n\nThe field of fractions of a polynomial ring $k[x_ i; i \\in I]$ is denoted $k(x_ i; i\\in I)$. \n\n\nA purely transcendental extension of $k$ is any field extension $K/k$ isomorphic to the field of fractions of a polynomial ring over $k$. \n\n\nA transcendence basis of $K/k$ is a collection of elements $\\{ x_ i\\} _{i \\in I}$ which are algebraically independent over $k$ and such that the extension $K/k(x_ i; i\\in I)$ is algebraic. \n\n\n\n,,,"  Injective (MvPolynomial.aeval x : MvPolynomial Î¹ R â†’â‚[R] A)
",
255,030E,"  AlgebraicIndependent R x âˆ§
    âˆ€ (s : Set A) (_ : AlgebraicIndepOn R id s) (_ : range x âŠ† s), range x = s
",Formal Proof of Stacks Project Tag 030E,(4)] def IsTranscendenceBasis (x : Î¹ â†’ A) : Prop :,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/AlgebraicIndependent/Defs.lean#L175-L176,Q27041,,9.26.1,definition,3.0,"['030D', '09FA', '0ELQ']",\n  Definition 9.26.1. Let $K/k$ be a field extension. \n  \n  \nA collection of elements $\\{ x_ i\\} _{i \\in I}$ of $K$ is called algebraically independent over $k$ if the map \n\n\n  \\[  k[X_ i; i\\in I] \\longrightarrow K  \\]\n\n\n which maps $X_ i$ to $x_ i$ is injective. \n\n\nThe field of fractions of a polynomial ring $k[x_ i; i \\in I]$ is denoted $k(x_ i; i\\in I)$. \n\n\nA purely transcendental extension of $k$ is any field extension $K/k$ isomorphic to the field of fractions of a polynomial ring over $k$. \n\n\nA transcendence basis of $K/k$ is a collection of elements $\\{ x_ i\\} _{i \\in I}$ which are algebraically independent over $k$ and such that the extension $K/k(x_ i; i\\in I)$ is algebraic. \n\n\n\n,\n  Definition 9.26.1. Let $K/k$ be a field extension. \n  \n  \nA collection of elements $\\{ x_ i\\} _{i \\in I}$ of $K$ is called algebraically independent over $k$ if the map \n\n\n  \\[  k[X_ i; i\\in I] \\longrightarrow K  \\]\n\n\n which maps $X_ i$ to $x_ i$ is injective. \n\n\nThe field of fractions of a polynomial ring $k[x_ i; i \\in I]$ is denoted $k(x_ i; i\\in I)$. \n\n\nA purely transcendental extension of $k$ is any field extension $K/k$ isomorphic to the field of fractions of a polynomial ring over $k$. \n\n\nA transcendence basis of $K/k$ is a collection of elements $\\{ x_ i\\} _{i \\in I}$ which are algebraically independent over $k$ and such that the extension $K/k(x_ i; i\\in I)$ is algebraic. \n\n\n\n,,,"  AlgebraicIndependent R x âˆ§
    âˆ€ (s : Set A) (_ : AlgebraicIndepOn R id s) (_ : range x âŠ† s), range x = s
",
256,030F,"theorem lift_cardinalMk_eq (hx : IsTranscendenceBasis R x) (hy : IsTranscendenceBasis R y) :
    lift.{u'} #Î¹ = lift.{u} #Î¹' := by
  rw [â† lift_inj.{_, w}, lift_lift, lift_lift, â† lift_lift.{w, u'}, hx.lift_cardinalMk_eq_trdeg,
    â† lift_lift.{w, u}, hy.lift_cardinalMk_eq_trdeg, lift_lift, lift_lift]
",Formal Proof of Stacks Project Tag 030F,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/AlgebraicIndependent/TranscendenceBasis.lean#L431-L434,Q27041,,9.26.3,lemma,3.0,"['030D', '09FA', '0ELQ']","\n  Lemma 9.26.3. Let $E/F$ be a field extension. A transcendence basis of $E$ over $F$ exists. Any two transcendence bases have the same cardinality. \n\n    \n      Proof.\n      Let $A$ be an algebraically independent subset of $E$. Let $G$ be a subset of $E$ containing $A$ that generates $E/F$. We claim we can find a transcendence basis $B$ such that $A \\subset B \\subset G$. To prove this, consider the collection $\\mathcal{B}$ of algebraically independent subsets whose members are subsets of $G$ that contain $A$. Define a partial ordering on $\\mathcal{B}$ using inclusion. Then $\\mathcal{B}$ contains at least one element $A$. The union of the elements of a totally ordered subset $T$ of $\\mathcal{B}$ is an algebraically independent subset of $E$ over $F$ since any algebraic dependence relation would have occurred in one of the elements of $T$ (since polynomials only involve finitely many variables). The union also contains $A$ and is contained in $G$. By Zorn\'s lemma, there is a maximal element $B \\in \\mathcal{B}$. Now we claim $E$ is algebraic over $F(B)$. This is because if it wasn\'t then there would be an element $f \\in G$ transcendental over $F(B)$ since $F(G) = E$. Then $B \\cup \\{ f\\} $ would be algebraically independent contradicting the maximality of $B$. Thus $B$ is our transcendence basis. \n    \n      Let $B$ and $B\'$ be two transcendence bases. Without loss of generality, we can assume that $|B\'| \\leq |B|$. Now we divide the proof into two cases: the first case is that $B$ is an infinite set. Then for each $\\alpha \\in B\'$, there is a finite set $B_{\\alpha } \\subset B$ such that $\\alpha $ is algebraic over $F(B_{\\alpha })$ since any algebraic dependence relation only uses finitely many indeterminates. Then we define $B^* = \\bigcup _{\\alpha \\in B\'} B_{\\alpha }$. By construction, $B^* \\subset B$, but we claim that in fact the two sets are equal. To see this, suppose that they are not equal, say there is an element $\\beta \\in B \\setminus B^*$. We know $\\beta $ is algebraic over $F(B\')$ which is algebraic over $F(B^*)$. Therefore $\\beta $ is algebraic over $F(B^*)$, a contradiction. So $|B| \\leq |\\bigcup _{\\alpha \\in B\'} B_{\\alpha }|$. Now if $B\'$ is finite, then so is $B$ so we can assume $B\'$ is infinite; this means \n    \n      \n  \\[  |B| \\leq |\\bigcup \\nolimits _{\\alpha \\in B\'} B_{\\alpha }| = |B\'|  \\]\n\n    \n       because each $B_\\alpha $ is finite and $B\'$ is infinite. Therefore in the infinite case, $|B| = |B\'|$. \n    \n      Now we need to look at the case where $B$ is finite. In this case, $B\'$ is also finite, so suppose $B = \\{ \\alpha _1, \\ldots , \\alpha _ n\\} $ and $B\' = \\{ \\beta _1, \\ldots , \\beta _ m\\} $ with $m \\leq n$. We perform induction on $m$: if $m = 0$ then $E/F$ is algebraic so $B = \\emptyset $ so $n = 0$. If $m > 0$, there is an irreducible polynomial $f \\in F[x, y_1, \\ldots , y_ n]$ such that $f(\\beta _1, \\alpha _1, \\ldots , \\alpha _ n) = 0$ and such that $x$ occurs in $f$. Since $\\beta _1$ is not algebraic over $F$, $f$ must involve some $y_ i$ so without loss of generality, assume $f$ uses $y_1$. Let $B^* = \\{ \\beta _1, \\alpha _2, \\ldots , \\alpha _ n\\} $. We claim that $B^*$ is a basis for $E/F$. To prove this claim, we see that we have a tower of algebraic extensions \n    \n      \n  \\[  E/ F(B^*, \\alpha _1) / F(B^*)  \\]\n\n    \n       since $\\alpha _1$ is algebraic over $F(B^*)$. Now we claim that $B^*$ (counting multiplicity of elements) is algebraically independent over $F$ because if it weren\'t, then there would be an irreducible $g\\in F[x, y_2, \\ldots , y_ n]$ such that $g(\\beta _1, \\alpha _2, \\ldots , \\alpha _ n) = 0$ which must involve $x$ making $\\beta _1$ algebraic over $F(\\alpha _2, \\ldots , \\alpha _ n)$ which would make $\\alpha _1$ algebraic over $F(\\alpha _2, \\ldots , \\alpha _ n)$ which is impossible. So this means that $\\{ \\alpha _2, \\ldots , \\alpha _ n\\} $ and $\\{ \\beta _2, \\ldots , \\beta _ m\\} $ are bases for $E$ over $F(\\beta _1)$ which means by induction, $m = n$. \n      $\\square$\n    \n",\n  Lemma 9.26.3. Let $E/F$ be a field extension. A transcendence basis of $E$ over $F$ exists. Any two transcendence bases have the same cardinality. \n\n    \n,"Proof.\n      Let $A$ be an algebraically independent subset of $E$. Let $G$ be a subset of $E$ containing $A$ that generates $E/F$. We claim we can find a transcendence basis $B$ such that $A \\subset B \\subset G$. To prove this, consider the collection $\\mathcal{B}$ of algebraically independent subsets whose members are subsets of $G$ that contain $A$. Define a partial ordering on $\\mathcal{B}$ using inclusion. Then $\\mathcal{B}$ contains at least one element $A$. The union of the elements of a totally ordered subset $T$ of $\\mathcal{B}$ is an algebraically independent subset of $E$ over $F$ since any algebraic dependence relation would have occurred in one of the elements of $T$ (since polynomials only involve finitely many variables). The union also contains $A$ and is contained in $G$. By Zorn\'s lemma, there is a maximal element $B \\in \\mathcal{B}$. Now we claim $E$ is algebraic over $F(B)$. This is because if it wasn\'t then there would be an element $f \\in G$ transcendental over $F(B)$ since $F(G) = E$. Then $B \\cup \\{ f\\} $ would be algebraically independent contradicting the maximality of $B$. Thus $B$ is our transcendence basis. \n    \n      Let $B$ and $B\'$ be two transcendence bases. Without loss of generality, we can assume that $|B\'| \\leq |B|$. Now we divide the proof into two cases: the first case is that $B$ is an infinite set. Then for each $\\alpha \\in B\'$, there is a finite set $B_{\\alpha } \\subset B$ such that $\\alpha $ is algebraic over $F(B_{\\alpha })$ since any algebraic dependence relation only uses finitely many indeterminates. Then we define $B^* = \\bigcup _{\\alpha \\in B\'} B_{\\alpha }$. By construction, $B^* \\subset B$, but we claim that in fact the two sets are equal. To see this, suppose that they are not equal, say there is an element $\\beta \\in B \\setminus B^*$. We know $\\beta $ is algebraic over $F(B\')$ which is algebraic over $F(B^*)$. Therefore $\\beta $ is algebraic over $F(B^*)$, a contradiction. So $|B| \\leq |\\bigcup _{\\alpha \\in B\'} B_{\\alpha }|$. Now if $B\'$ is finite, then so is $B$ so we can assume $B\'$ is infinite; this means \n    \n      \n  \\[  |B| \\leq |\\bigcup \\nolimits _{\\alpha \\in B\'} B_{\\alpha }| = |B\'|  \\]\n\n    \n       because each $B_\\alpha $ is finite and $B\'$ is infinite. Therefore in the infinite case, $|B| = |B\'|$. \n    \n      Now we need to look at the case where $B$ is finite. In this case, $B\'$ is also finite, so suppose $B = \\{ \\alpha _1, \\ldots , \\alpha _ n\\} $ and $B\' = \\{ \\beta _1, \\ldots , \\beta _ m\\} $ with $m \\leq n$. We perform induction on $m$: if $m = 0$ then $E/F$ is algebraic so $B = \\emptyset $ so $n = 0$. If $m > 0$, there is an irreducible polynomial $f \\in F[x, y_1, \\ldots , y_ n]$ such that $f(\\beta _1, \\alpha _1, \\ldots , \\alpha _ n) = 0$ and such that $x$ occurs in $f$. Since $\\beta _1$ is not algebraic over $F$, $f$ must involve some $y_ i$ so without loss of generality, assume $f$ uses $y_1$. Let $B^* = \\{ \\beta _1, \\alpha _2, \\ldots , \\alpha _ n\\} $. We claim that $B^*$ is a basis for $E/F$. To prove this claim, we see that we have a tower of algebraic extensions \n    \n      \n  \\[  E/ F(B^*, \\alpha _1) / F(B^*)  \\]\n\n    \n       since $\\alpha _1$ is algebraic over $F(B^*)$. Now we claim that $B^*$ (counting multiplicity of elements) is algebraically independent over $F$ because if it weren\'t, then there would be an irreducible $g\\in F[x, y_2, \\ldots , y_ n]$ such that $g(\\beta _1, \\alpha _2, \\ldots , \\alpha _ n) = 0$ which must involve $x$ making $\\beta _1$ algebraic over $F(\\alpha _2, \\ldots , \\alpha _ n)$ which would make $\\alpha _1$ algebraic over $F(\\alpha _2, \\ldots , \\alpha _ n)$ which is impossible. So this means that $\\{ \\alpha _2, \\ldots , \\alpha _ n\\} $ and $\\{ \\beta _2, \\ldots , \\beta _ m\\} $ are bases for $E$ over $F(\\beta _1)$ which means by induction, $m = n$. \n      $\\square$\n    \n"," by
  rw [â† lift_inj.{_, w}, lift_lift, lift_lift, â† lift_lift.{w, u'}, hx.lift_cardinalMk_eq_trdeg,
    â† lift_lift.{w, u}, hy.lift_cardinalMk_eq_trdeg, lift_lift, lift_lift]
","theorem lift_cardinalMk_eq (hx : IsTranscendenceBasis R x) (hy : IsTranscendenceBasis R y) :
    lift.{u'} #Î¹ = lift.{u} #Î¹' ","Proof.\n      Let $A$ be an algebraically independent subset of $E$. Let $G$ be a subset of $E$ containing $A$ that generates $E/F$. We claim we can find a transcendence basis $B$ such that $A \\subset B \\subset G$. To prove this, consider the collection $\\mathcal{B}$ of algebraically independent subsets whose members are subsets of $G$ that contain $A$. Define a partial ordering on $\\mathcal{B}$ using inclusion. Then $\\mathcal{B}$ contains at least one element $A$. The union of the elements of a totally ordered subset $T$ of $\\mathcal{B}$ is an algebraically independent subset of $E$ over $F$ since any algebraic dependence relation would have occurred in one of the elements of $T$ (since polynomials only involve finitely many variables). The union also contains $A$ and is contained in $G$. By Zorn\'s lemma, there is a maximal element $B \\in \\mathcal{B}$. Now we claim $E$ is algebraic over $F(B)$. This is because if it wasn\'t then there would be an element $f \\in G$ transcendental over $F(B)$ since $F(G) = E$. Then $B \\cup \\{ f\\} $ would be algebraically independent contradicting the maximality of $B$. Thus $B$ is our transcendence basis. \n    \n      Let $B$ and $B\'$ be two transcendence bases. Without loss of generality, we can assume that $|B\'| \\leq |B|$. Now we divide the proof into two cases: the first case is that $B$ is an infinite set. Then for each $\\alpha \\in B\'$, there is a finite set $B_{\\alpha } \\subset B$ such that $\\alpha $ is algebraic over $F(B_{\\alpha })$ since any algebraic dependence relation only uses finitely many indeterminates. Then we define $B^* = \\bigcup _{\\alpha \\in B\'} B_{\\alpha }$. By construction, $B^* \\subset B$, but we claim that in fact the two sets are equal. To see this, suppose that they are not equal, say there is an element $\\beta \\in B \\setminus B^*$. We know $\\beta $ is algebraic over $F(B\')$ which is algebraic over $F(B^*)$. Therefore $\\beta $ is algebraic over $F(B^*)$, a contradiction. So $|B| \\leq |\\bigcup _{\\alpha \\in B\'} B_{\\alpha }|$. Now if $B\'$ is finite, then so is $B$ so we can assume $B\'$ is infinite; this means \n    \n      \n  \\[  |B| \\leq |\\bigcup \\nolimits _{\\alpha \\in B\'} B_{\\alpha }| = |B\'|  \\]\n\n    \n       because each $B_\\alpha $ is finite and $B\'$ is infinite. Therefore in the infinite case, $|B| = |B\'|$. \n    \n      Now we need to look at the case where $B$ is finite. In this case, $B\'$ is also finite, so suppose $B = \\{ \\alpha _1, \\ldots , \\alpha _ n\\} $ and $B\' = \\{ \\beta _1, \\ldots , \\beta _ m\\} $ with $m \\leq n$. We perform induction on $m$: if $m = 0$ then $E/F$ is algebraic so $B = \\emptyset $ so $n = 0$. If $m > 0$, there is an irreducible polynomial $f \\in F[x, y_1, \\ldots , y_ n]$ such that $f(\\beta _1, \\alpha _1, \\ldots , \\alpha _ n) = 0$ and such that $x$ occurs in $f$. Since $\\beta _1$ is not algebraic over $F$, $f$ must involve some $y_ i$ so without loss of generality, assume $f$ uses $y_1$. Let $B^* = \\{ \\beta _1, \\alpha _2, \\ldots , \\alpha _ n\\} $. We claim that $B^*$ is a basis for $E/F$. To prove this claim, we see that we have a tower of algebraic extensions \n    \n      \n  \\[  E/ F(B^*, \\alpha _1) / F(B^*)  \\]\n\n    \n       since $\\alpha _1$ is algebraic over $F(B^*)$. Now we claim that $B^*$ (counting multiplicity of elements) is algebraically independent over $F$ because if it weren\'t, then there would be an irreducible $g\\in F[x, y_2, \\ldots , y_ n]$ such that $g(\\beta _1, \\alpha _2, \\ldots , \\alpha _ n) = 0$ which must involve $x$ making $\\beta _1$ algebraic over $F(\\alpha _2, \\ldots , \\alpha _ n)$ which would make $\\alpha _1$ algebraic over $F(\\alpha _2, \\ldots , \\alpha _ n)$ which is impossible. So this means that $\\{ \\alpha _2, \\ldots , \\alpha _ n\\} $ and $\\{ \\beta _2, \\ldots , \\beta _ m\\} $ are bases for $E$ over $F(\\beta _1)$ which means by induction, $m = n$. \n      $\\square$\n    \n"
257,030F,"    (hx : IsTranscendenceBasis R x) (hy : IsTranscendenceBasis R y) :
    #Î¹ = #Î¹' := by
  rw [â† lift_id #Î¹, lift_cardinalMk_eq hx hy, lift_id]
",Formal Proof of Stacks Project Tag 030F, theorem cardinalMk_eq {Î¹' : Type u} {y : Î¹' â†’ A,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/AlgebraicIndependent/TranscendenceBasis.lean#L437-L439,Q27041,,9.26.3,lemma,3.0,"['030D', '09FA', '0ELQ']","\n  Lemma 9.26.3. Let $E/F$ be a field extension. A transcendence basis of $E$ over $F$ exists. Any two transcendence bases have the same cardinality. \n\n    \n      Proof.\n      Let $A$ be an algebraically independent subset of $E$. Let $G$ be a subset of $E$ containing $A$ that generates $E/F$. We claim we can find a transcendence basis $B$ such that $A \\subset B \\subset G$. To prove this, consider the collection $\\mathcal{B}$ of algebraically independent subsets whose members are subsets of $G$ that contain $A$. Define a partial ordering on $\\mathcal{B}$ using inclusion. Then $\\mathcal{B}$ contains at least one element $A$. The union of the elements of a totally ordered subset $T$ of $\\mathcal{B}$ is an algebraically independent subset of $E$ over $F$ since any algebraic dependence relation would have occurred in one of the elements of $T$ (since polynomials only involve finitely many variables). The union also contains $A$ and is contained in $G$. By Zorn\'s lemma, there is a maximal element $B \\in \\mathcal{B}$. Now we claim $E$ is algebraic over $F(B)$. This is because if it wasn\'t then there would be an element $f \\in G$ transcendental over $F(B)$ since $F(G) = E$. Then $B \\cup \\{ f\\} $ would be algebraically independent contradicting the maximality of $B$. Thus $B$ is our transcendence basis. \n    \n      Let $B$ and $B\'$ be two transcendence bases. Without loss of generality, we can assume that $|B\'| \\leq |B|$. Now we divide the proof into two cases: the first case is that $B$ is an infinite set. Then for each $\\alpha \\in B\'$, there is a finite set $B_{\\alpha } \\subset B$ such that $\\alpha $ is algebraic over $F(B_{\\alpha })$ since any algebraic dependence relation only uses finitely many indeterminates. Then we define $B^* = \\bigcup _{\\alpha \\in B\'} B_{\\alpha }$. By construction, $B^* \\subset B$, but we claim that in fact the two sets are equal. To see this, suppose that they are not equal, say there is an element $\\beta \\in B \\setminus B^*$. We know $\\beta $ is algebraic over $F(B\')$ which is algebraic over $F(B^*)$. Therefore $\\beta $ is algebraic over $F(B^*)$, a contradiction. So $|B| \\leq |\\bigcup _{\\alpha \\in B\'} B_{\\alpha }|$. Now if $B\'$ is finite, then so is $B$ so we can assume $B\'$ is infinite; this means \n    \n      \n  \\[  |B| \\leq |\\bigcup \\nolimits _{\\alpha \\in B\'} B_{\\alpha }| = |B\'|  \\]\n\n    \n       because each $B_\\alpha $ is finite and $B\'$ is infinite. Therefore in the infinite case, $|B| = |B\'|$. \n    \n      Now we need to look at the case where $B$ is finite. In this case, $B\'$ is also finite, so suppose $B = \\{ \\alpha _1, \\ldots , \\alpha _ n\\} $ and $B\' = \\{ \\beta _1, \\ldots , \\beta _ m\\} $ with $m \\leq n$. We perform induction on $m$: if $m = 0$ then $E/F$ is algebraic so $B = \\emptyset $ so $n = 0$. If $m > 0$, there is an irreducible polynomial $f \\in F[x, y_1, \\ldots , y_ n]$ such that $f(\\beta _1, \\alpha _1, \\ldots , \\alpha _ n) = 0$ and such that $x$ occurs in $f$. Since $\\beta _1$ is not algebraic over $F$, $f$ must involve some $y_ i$ so without loss of generality, assume $f$ uses $y_1$. Let $B^* = \\{ \\beta _1, \\alpha _2, \\ldots , \\alpha _ n\\} $. We claim that $B^*$ is a basis for $E/F$. To prove this claim, we see that we have a tower of algebraic extensions \n    \n      \n  \\[  E/ F(B^*, \\alpha _1) / F(B^*)  \\]\n\n    \n       since $\\alpha _1$ is algebraic over $F(B^*)$. Now we claim that $B^*$ (counting multiplicity of elements) is algebraically independent over $F$ because if it weren\'t, then there would be an irreducible $g\\in F[x, y_2, \\ldots , y_ n]$ such that $g(\\beta _1, \\alpha _2, \\ldots , \\alpha _ n) = 0$ which must involve $x$ making $\\beta _1$ algebraic over $F(\\alpha _2, \\ldots , \\alpha _ n)$ which would make $\\alpha _1$ algebraic over $F(\\alpha _2, \\ldots , \\alpha _ n)$ which is impossible. So this means that $\\{ \\alpha _2, \\ldots , \\alpha _ n\\} $ and $\\{ \\beta _2, \\ldots , \\beta _ m\\} $ are bases for $E$ over $F(\\beta _1)$ which means by induction, $m = n$. \n      $\\square$\n    \n",\n  Lemma 9.26.3. Let $E/F$ be a field extension. A transcendence basis of $E$ over $F$ exists. Any two transcendence bases have the same cardinality. \n\n    \n,"Proof.\n      Let $A$ be an algebraically independent subset of $E$. Let $G$ be a subset of $E$ containing $A$ that generates $E/F$. We claim we can find a transcendence basis $B$ such that $A \\subset B \\subset G$. To prove this, consider the collection $\\mathcal{B}$ of algebraically independent subsets whose members are subsets of $G$ that contain $A$. Define a partial ordering on $\\mathcal{B}$ using inclusion. Then $\\mathcal{B}$ contains at least one element $A$. The union of the elements of a totally ordered subset $T$ of $\\mathcal{B}$ is an algebraically independent subset of $E$ over $F$ since any algebraic dependence relation would have occurred in one of the elements of $T$ (since polynomials only involve finitely many variables). The union also contains $A$ and is contained in $G$. By Zorn\'s lemma, there is a maximal element $B \\in \\mathcal{B}$. Now we claim $E$ is algebraic over $F(B)$. This is because if it wasn\'t then there would be an element $f \\in G$ transcendental over $F(B)$ since $F(G) = E$. Then $B \\cup \\{ f\\} $ would be algebraically independent contradicting the maximality of $B$. Thus $B$ is our transcendence basis. \n    \n      Let $B$ and $B\'$ be two transcendence bases. Without loss of generality, we can assume that $|B\'| \\leq |B|$. Now we divide the proof into two cases: the first case is that $B$ is an infinite set. Then for each $\\alpha \\in B\'$, there is a finite set $B_{\\alpha } \\subset B$ such that $\\alpha $ is algebraic over $F(B_{\\alpha })$ since any algebraic dependence relation only uses finitely many indeterminates. Then we define $B^* = \\bigcup _{\\alpha \\in B\'} B_{\\alpha }$. By construction, $B^* \\subset B$, but we claim that in fact the two sets are equal. To see this, suppose that they are not equal, say there is an element $\\beta \\in B \\setminus B^*$. We know $\\beta $ is algebraic over $F(B\')$ which is algebraic over $F(B^*)$. Therefore $\\beta $ is algebraic over $F(B^*)$, a contradiction. So $|B| \\leq |\\bigcup _{\\alpha \\in B\'} B_{\\alpha }|$. Now if $B\'$ is finite, then so is $B$ so we can assume $B\'$ is infinite; this means \n    \n      \n  \\[  |B| \\leq |\\bigcup \\nolimits _{\\alpha \\in B\'} B_{\\alpha }| = |B\'|  \\]\n\n    \n       because each $B_\\alpha $ is finite and $B\'$ is infinite. Therefore in the infinite case, $|B| = |B\'|$. \n    \n      Now we need to look at the case where $B$ is finite. In this case, $B\'$ is also finite, so suppose $B = \\{ \\alpha _1, \\ldots , \\alpha _ n\\} $ and $B\' = \\{ \\beta _1, \\ldots , \\beta _ m\\} $ with $m \\leq n$. We perform induction on $m$: if $m = 0$ then $E/F$ is algebraic so $B = \\emptyset $ so $n = 0$. If $m > 0$, there is an irreducible polynomial $f \\in F[x, y_1, \\ldots , y_ n]$ such that $f(\\beta _1, \\alpha _1, \\ldots , \\alpha _ n) = 0$ and such that $x$ occurs in $f$. Since $\\beta _1$ is not algebraic over $F$, $f$ must involve some $y_ i$ so without loss of generality, assume $f$ uses $y_1$. Let $B^* = \\{ \\beta _1, \\alpha _2, \\ldots , \\alpha _ n\\} $. We claim that $B^*$ is a basis for $E/F$. To prove this claim, we see that we have a tower of algebraic extensions \n    \n      \n  \\[  E/ F(B^*, \\alpha _1) / F(B^*)  \\]\n\n    \n       since $\\alpha _1$ is algebraic over $F(B^*)$. Now we claim that $B^*$ (counting multiplicity of elements) is algebraically independent over $F$ because if it weren\'t, then there would be an irreducible $g\\in F[x, y_2, \\ldots , y_ n]$ such that $g(\\beta _1, \\alpha _2, \\ldots , \\alpha _ n) = 0$ which must involve $x$ making $\\beta _1$ algebraic over $F(\\alpha _2, \\ldots , \\alpha _ n)$ which would make $\\alpha _1$ algebraic over $F(\\alpha _2, \\ldots , \\alpha _ n)$ which is impossible. So this means that $\\{ \\alpha _2, \\ldots , \\alpha _ n\\} $ and $\\{ \\beta _2, \\ldots , \\beta _ m\\} $ are bases for $E$ over $F(\\beta _1)$ which means by induction, $m = n$. \n      $\\square$\n    \n"," by
  rw [â† lift_id #Î¹, lift_cardinalMk_eq hx hy, lift_id]
","    (hx : IsTranscendenceBasis R x) (hy : IsTranscendenceBasis R y) :
    #Î¹ = #Î¹' ","Proof.\n      Let $A$ be an algebraically independent subset of $E$. Let $G$ be a subset of $E$ containing $A$ that generates $E/F$. We claim we can find a transcendence basis $B$ such that $A \\subset B \\subset G$. To prove this, consider the collection $\\mathcal{B}$ of algebraically independent subsets whose members are subsets of $G$ that contain $A$. Define a partial ordering on $\\mathcal{B}$ using inclusion. Then $\\mathcal{B}$ contains at least one element $A$. The union of the elements of a totally ordered subset $T$ of $\\mathcal{B}$ is an algebraically independent subset of $E$ over $F$ since any algebraic dependence relation would have occurred in one of the elements of $T$ (since polynomials only involve finitely many variables). The union also contains $A$ and is contained in $G$. By Zorn\'s lemma, there is a maximal element $B \\in \\mathcal{B}$. Now we claim $E$ is algebraic over $F(B)$. This is because if it wasn\'t then there would be an element $f \\in G$ transcendental over $F(B)$ since $F(G) = E$. Then $B \\cup \\{ f\\} $ would be algebraically independent contradicting the maximality of $B$. Thus $B$ is our transcendence basis. \n    \n      Let $B$ and $B\'$ be two transcendence bases. Without loss of generality, we can assume that $|B\'| \\leq |B|$. Now we divide the proof into two cases: the first case is that $B$ is an infinite set. Then for each $\\alpha \\in B\'$, there is a finite set $B_{\\alpha } \\subset B$ such that $\\alpha $ is algebraic over $F(B_{\\alpha })$ since any algebraic dependence relation only uses finitely many indeterminates. Then we define $B^* = \\bigcup _{\\alpha \\in B\'} B_{\\alpha }$. By construction, $B^* \\subset B$, but we claim that in fact the two sets are equal. To see this, suppose that they are not equal, say there is an element $\\beta \\in B \\setminus B^*$. We know $\\beta $ is algebraic over $F(B\')$ which is algebraic over $F(B^*)$. Therefore $\\beta $ is algebraic over $F(B^*)$, a contradiction. So $|B| \\leq |\\bigcup _{\\alpha \\in B\'} B_{\\alpha }|$. Now if $B\'$ is finite, then so is $B$ so we can assume $B\'$ is infinite; this means \n    \n      \n  \\[  |B| \\leq |\\bigcup \\nolimits _{\\alpha \\in B\'} B_{\\alpha }| = |B\'|  \\]\n\n    \n       because each $B_\\alpha $ is finite and $B\'$ is infinite. Therefore in the infinite case, $|B| = |B\'|$. \n    \n      Now we need to look at the case where $B$ is finite. In this case, $B\'$ is also finite, so suppose $B = \\{ \\alpha _1, \\ldots , \\alpha _ n\\} $ and $B\' = \\{ \\beta _1, \\ldots , \\beta _ m\\} $ with $m \\leq n$. We perform induction on $m$: if $m = 0$ then $E/F$ is algebraic so $B = \\emptyset $ so $n = 0$. If $m > 0$, there is an irreducible polynomial $f \\in F[x, y_1, \\ldots , y_ n]$ such that $f(\\beta _1, \\alpha _1, \\ldots , \\alpha _ n) = 0$ and such that $x$ occurs in $f$. Since $\\beta _1$ is not algebraic over $F$, $f$ must involve some $y_ i$ so without loss of generality, assume $f$ uses $y_1$. Let $B^* = \\{ \\beta _1, \\alpha _2, \\ldots , \\alpha _ n\\} $. We claim that $B^*$ is a basis for $E/F$. To prove this claim, we see that we have a tower of algebraic extensions \n    \n      \n  \\[  E/ F(B^*, \\alpha _1) / F(B^*)  \\]\n\n    \n       since $\\alpha _1$ is algebraic over $F(B^*)$. Now we claim that $B^*$ (counting multiplicity of elements) is algebraically independent over $F$ because if it weren\'t, then there would be an irreducible $g\\in F[x, y_2, \\ldots , y_ n]$ such that $g(\\beta _1, \\alpha _2, \\ldots , \\alpha _ n) = 0$ which must involve $x$ making $\\beta _1$ algebraic over $F(\\alpha _2, \\ldots , \\alpha _ n)$ which would make $\\alpha _1$ algebraic over $F(\\alpha _2, \\ldots , \\alpha _ n)$ which is impossible. So this means that $\\{ \\alpha _2, \\ldots , \\alpha _ n\\} $ and $\\{ \\beta _2, \\ldots , \\beta _ m\\} $ are bases for $E$ over $F(\\beta _1)$ which means by induction, $m = n$. \n      $\\square$\n    \n"
258,030H,"    [FaithfulSMul S A] : lift.{w} (trdeg R S) + lift.{v} (trdeg S A) = lift.{v} (trdeg R A) := by
  have âŸ¨s, hsâŸ© := exists_isTranscendenceBasis R S
  have âŸ¨t, htâŸ© := exists_isTranscendenceBasis S A
  have := (FaithfulSMul.algebraMap_injective S A).noZeroDivisors _ (map_zero _) (map_mul _)
  have := (FaithfulSMul.algebraMap_injective R S).nontrivial
  rw [â† hs.cardinalMk_eq_trdeg, â† ht.cardinalMk_eq_trdeg, â† lift_umax.{w}, add_comm,
    â† (hs.sumElim_comp ht).lift_cardinalMk_eq_trdeg, mk_sum, lift_add, lift_lift, lift_lift]
",Formal Proof of Stacks Project Tag 030H, theorem lift_trdeg_add_eq [Nontrivial R] [NoZeroDivisors A] [FaithfulSMul R S,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/AlgebraicIndependent/TranscendenceBasis.lean#L540-L546,Q27041,,9.26.5,lemma,3.0,"['030D', '09FA', '0ELQ']",\n  Lemma 9.26.5. Let $L/K/k$ be field extensions. Then \n  \n  \\[  \\text{trdeg}_ k(L) = \\text{trdeg}_ K(L) + \\text{trdeg}_ k(K).  \\]\n\n\n    \n      Proof.\n      Choose a transcendence basis $A \\subset K$ of $K$ over $k$. Choose a transcendence basis $B \\subset L$ of $L$ over $K$. Then it is straightforward to see that $A \\cup B$ is a transcendence basis of $L$ over $k$. \n      $\\square$\n    \n,\n  Lemma 9.26.5. Let $L/K/k$ be field extensions. Then \n  \n  \\[  \\text{trdeg}_ k(L) = \\text{trdeg}_ K(L) + \\text{trdeg}_ k(K).  \\]\n\n\n    \n,Proof.\n      Choose a transcendence basis $A \\subset K$ of $K$ over $k$. Choose a transcendence basis $B \\subset L$ of $L$ over $K$. Then it is straightforward to see that $A \\cup B$ is a transcendence basis of $L$ over $k$. \n      $\\square$\n    \n," by
  have âŸ¨s, hsâŸ© := exists_isTranscendenceBasis R S
  have âŸ¨t, htâŸ© := exists_isTranscendenceBasis S A
  have := (FaithfulSMul.algebraMap_injective S A).noZeroDivisors _ (map_zero _) (map_mul _)
  have := (FaithfulSMul.algebraMap_injective R S).nontrivial
  rw [â† hs.cardinalMk_eq_trdeg, â† ht.cardinalMk_eq_trdeg, â† lift_umax.{w}, add_comm,
    â† (hs.sumElim_comp ht).lift_cardinalMk_eq_trdeg, mk_sum, lift_add, lift_lift, lift_lift]
",    [FaithfulSMul S A] : lift.{w} (trdeg R S) + lift.{v} (trdeg S A) = lift.{v} (trdeg R A) ,Proof.\n      Choose a transcendence basis $A \\subset K$ of $K$ over $k$. Choose a transcendence basis $B \\subset L$ of $L$ over $K$. Then it is straightforward to see that $A \\cup B$ is a transcendence basis of $L$ over $k$. \n      $\\square$\n    \n
259,030H,"    [Algebra R A] [Algebra S A] [FaithfulSMul R S] [FaithfulSMul S A] [IsScalarTower R S A] :
    trdeg R S + trdeg S A = trdeg R A := by
  rw [â† (trdeg R S).lift_id, â† (trdeg S A).lift_id, â† (trdeg R A).lift_id]
  exact lift_trdeg_add_eq R S A
",Formal Proof of Stacks Project Tag 030H, theorem trdeg_add_eq [Nontrivial R] {A : Type v} [CommRing A] [NoZeroDivisors A,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/AlgebraicIndependent/TranscendenceBasis.lean#L549-L552,Q27041,,9.26.5,lemma,3.0,"['030D', '09FA', '0ELQ']",\n  Lemma 9.26.5. Let $L/K/k$ be field extensions. Then \n  \n  \\[  \\text{trdeg}_ k(L) = \\text{trdeg}_ K(L) + \\text{trdeg}_ k(K).  \\]\n\n\n    \n      Proof.\n      Choose a transcendence basis $A \\subset K$ of $K$ over $k$. Choose a transcendence basis $B \\subset L$ of $L$ over $K$. Then it is straightforward to see that $A \\cup B$ is a transcendence basis of $L$ over $k$. \n      $\\square$\n    \n,\n  Lemma 9.26.5. Let $L/K/k$ be field extensions. Then \n  \n  \\[  \\text{trdeg}_ k(L) = \\text{trdeg}_ K(L) + \\text{trdeg}_ k(K).  \\]\n\n\n    \n,Proof.\n      Choose a transcendence basis $A \\subset K$ of $K$ over $k$. Choose a transcendence basis $B \\subset L$ of $L$ over $K$. Then it is straightforward to see that $A \\cup B$ is a transcendence basis of $L$ over $k$. \n      $\\square$\n    \n," by
  rw [â† (trdeg R S).lift_id, â† (trdeg S A).lift_id, â† (trdeg R A).lift_id]
  exact lift_trdeg_add_eq R S A
","    [Algebra R A] [Algebra S A] [FaithfulSMul R S] [FaithfulSMul S A] [IsScalarTower R S A] :
    trdeg R S + trdeg S A = trdeg R A ",Proof.\n      Choose a transcendence basis $A \\subset K$ of $K$ over $k$. Choose a transcendence basis $B \\subset L$ of $L$ over $K$. Then it is straightforward to see that $A \\cup B$ is a transcendence basis of $L$ over $k$. \n      $\\square$\n    \n
260,00J5,"abbrev IsArtinianRing (R) [Semiring R] :=
  IsArtinian R R
",Formal Proof of Stacks Project Tag 00J5,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Artinian/Module.lean#L405-L406,Q27041,,10.53.1,definition,3.0,"['00J4', '00AO', '0ELQ']",\n  Definition 10.53.1. A ring $R$ is Artinian if it satisfies the descending chain condition for ideals. \n,\n  Definition 10.53.1. A ring $R$ is Artinian if it satisfies the descending chain condition for ideals. \n,,"
  IsArtinian R R
",abbrev IsArtinianRing (R) [Semiring R] ,
261,00J7,"lemma setOf_isMaximal_finite : {I : Ideal R | I.IsMaximal}.Finite := by
  have âŸ¨s, HâŸ© := Finset.exists_inf_le (Subtype.val (p := fun I : Ideal R â†¦ I.IsMaximal))
  refine Set.finite_def.2 âŸ¨s, fun p â†¦ ?_âŸ©
  have âŸ¨q, hq1, hq2âŸ© := p.2.isPrime.inf_le'.mp (H p)
  rwa [â† Subtype.ext <| q.2.eq_of_le p.2.ne_top hq2]
",Formal Proof of Stacks Project Tag 00J7,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Artinian/Module.lean#L556-L560,Q27041,,10.53.3,lemma,3.0,"['00J4', '00AO', '0ELQ']","\n  Lemma 10.53.3. If $R$ is Artinian then $R$ has only finitely many maximal ideals. \n\n    \n      Proof.\n      Suppose that $\\mathfrak m_ i$, $i = 1, 2, 3, \\ldots $ are pairwise distinct maximal ideals. Then $\\mathfrak m_1 \\supset \\mathfrak m_1\\cap \\mathfrak m_2 \\supset \\mathfrak m_1 \\cap \\mathfrak m_2 \\cap \\mathfrak m_3 \\supset \\ldots $ is an infinite descending sequence (because by the Chinese remainder theorem all the maps $R \\to \\oplus _{i = 1}^ n R/\\mathfrak m_ i$ are surjective). \n      $\\square$\n    \n",\n  Lemma 10.53.3. If $R$ is Artinian then $R$ has only finitely many maximal ideals. \n\n    \n,"Proof.\n      Suppose that $\\mathfrak m_ i$, $i = 1, 2, 3, \\ldots $ are pairwise distinct maximal ideals. Then $\\mathfrak m_1 \\supset \\mathfrak m_1\\cap \\mathfrak m_2 \\supset \\mathfrak m_1 \\cap \\mathfrak m_2 \\cap \\mathfrak m_3 \\supset \\ldots $ is an infinite descending sequence (because by the Chinese remainder theorem all the maps $R \\to \\oplus _{i = 1}^ n R/\\mathfrak m_ i$ are surjective). \n      $\\square$\n    \n"," by
  have âŸ¨s, HâŸ© := Finset.exists_inf_le (Subtype.val (p := fun I : Ideal R â†¦ I.IsMaximal))
  refine Set.finite_def.2 âŸ¨s, fun p â†¦ ?_âŸ©
  have âŸ¨q, hq1, hq2âŸ© := p.2.isPrime.inf_le'.mp (H p)
  rwa [â† Subtype.ext <| q.2.eq_of_le p.2.ne_top hq2]
",lemma setOf_isMaximal_finite : {I : Ideal R | I.IsMaximal}.Finite ,"Proof.\n      Suppose that $\\mathfrak m_ i$, $i = 1, 2, 3, \\ldots $ are pairwise distinct maximal ideals. Then $\\mathfrak m_1 \\supset \\mathfrak m_1\\cap \\mathfrak m_2 \\supset \\mathfrak m_1 \\cap \\mathfrak m_2 \\cap \\mathfrak m_3 \\supset \\ldots $ is an infinite descending sequence (because by the Chinese remainder theorem all the maps $R \\to \\oplus _{i = 1}^ n R/\\mathfrak m_ i$ are surjective). \n      $\\square$\n    \n"
262,00J8,"theorem isNilpotent_jacobson_bot {R} [Ring R] [IsArtinianRing R] :
    IsNilpotent (Ideal.jacobson (âŠ¥ : Ideal R)) :=
  Ideal.jacobson_bot (R := R) â–¸ IsSemiprimaryRing.isNilpotent
",Formal Proof of Stacks Project Tag 00J8,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Artinian/Ring.lean#L54-L56,Q27041,,10.53.4,lemma,3.0,"['00J4', '00AO', '0ELQ']","\n  Lemma 10.53.4. Let $R$ be Artinian. The Jacobson radical of $R$ is a nilpotent ideal. \n\n    \n      Proof.\n      Let $I \\subset R$ be the Jacobson radical. Note that $I \\supset I^2 \\supset I^3 \\supset \\ldots $ is a descending sequence. Thus $I^ n = I^{n + 1}$ for some $n$. Set $J = \\{  x\\in R \\mid xI^ n = 0\\} $. We have to show $J = R$. If not, choose an ideal $J\' \\not= J$, $J \\subset J\'$ minimal (possible by the Artinian property). Then $J\' = J + Rx$ for some $x \\in R$. By minimality we have $J + IJ\' = J$ or $J + IJ\' = J\'$. In the latter case we get $J\' = J + Ix$ and by Lemma 10.20.1 we obtain $J = J\'$ a contradiction. Hence $xI^{n + 1} \\subset xI \\cdot I^ n \\subset J \\cdot I^ n = 0$. Since $I^{n + 1} = I^ n$ we conclude $x \\in J$. Contradiction. \n      $\\square$\n    \n",\n  Lemma 10.53.4. Let $R$ be Artinian. The Jacobson radical of $R$ is a nilpotent ideal. \n\n    \n,"Proof.\n      Let $I \\subset R$ be the Jacobson radical. Note that $I \\supset I^2 \\supset I^3 \\supset \\ldots $ is a descending sequence. Thus $I^ n = I^{n + 1}$ for some $n$. Set $J = \\{  x\\in R \\mid xI^ n = 0\\} $. We have to show $J = R$. If not, choose an ideal $J\' \\not= J$, $J \\subset J\'$ minimal (possible by the Artinian property). Then $J\' = J + Rx$ for some $x \\in R$. By minimality we have $J + IJ\' = J$ or $J + IJ\' = J\'$. In the latter case we get $J\' = J + Ix$ and by Lemma 10.20.1 we obtain $J = J\'$ a contradiction. Hence $xI^{n + 1} \\subset xI \\cdot I^ n \\subset J \\cdot I^ n = 0$. Since $I^{n + 1} = I^ n$ we conclude $x \\in J$. Contradiction. \n      $\\square$\n    \n","
  Ideal.jacobson_bot (R := R) â–¸ IsSemiprimaryRing.isNilpotent
","theorem isNilpotent_jacobson_bot {R} [Ring R] [IsArtinianRing R] :
    IsNilpotent (Ideal.jacobson (âŠ¥ : Ideal R)) ","Proof.\n      Let $I \\subset R$ be the Jacobson radical. Note that $I \\supset I^2 \\supset I^3 \\supset \\ldots $ is a descending sequence. Thus $I^ n = I^{n + 1}$ for some $n$. Set $J = \\{  x\\in R \\mid xI^ n = 0\\} $. We have to show $J = R$. If not, choose an ideal $J\' \\not= J$, $J \\subset J\'$ minimal (possible by the Artinian property). Then $J\' = J + Rx$ for some $x \\in R$. By minimality we have $J + IJ\' = J$ or $J + IJ\' = J\'$. In the latter case we get $J\' = J + Ix$ and by Lemma 10.20.1 [[\n        \n      \n      \n  Lemma 10.20.1 (Nakayama\'s lemma). Let $R$ be a ring with Jacobson radical $\\text{rad}(R)$. Let $M$ be an $R$-module. Let $I \\subset R$ be an ideal. \n  \n  \n If $IM = M$ and $M$ is finite, then there exists an $f \\in 1 + I$ such that $fM = 0$. \n\n\nIf $IM = M$, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $M = 0$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, and $N\'$ is finite, then there exists an $f \\in 1 + I$ such that $fM \\subset N$ and $M_ f = N_ f$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, $N\'$ is finite, and $I \\subset \\text{rad}(R)$, then $M = N$. \n\n\nIf $N \\to M$ is a module map, $N/IN \\to M/IM$ is surjective, and $M$ is finite, then there exists an $f \\in 1 + I$ such that $N_ f \\to M_ f$ is surjective. \n\n\nIf $N \\to M$ is a module map, $N/IN \\to M/IM$ is surjective, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $N \\to M$ is surjective. \n\n\nIf $x_1, \\ldots , x_ n \\in M$ generate $M/IM$ and $M$ is finite, then there exists an $f \\in 1 + I$ such that $x_1, \\ldots , x_ n$ generate $M_ f$ over $R_ f$. \n\n\nIf $x_1, \\ldots , x_ n \\in M$ generate $M/IM$, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $M$ is generated by $x_1, \\ldots , x_ n$. \n\n\nIf $IM = M$, $I$ is nilpotent, then $M = 0$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, and $I$ is nilpotent then $M = N$. \n\n\nIf $N \\to M$ is a module map, $I$ is nilpotent, and $N/IN \\to M/IM$ is surjective, then $N \\to M$ is surjective. \n\n\nIf $\\{ x_\\alpha \\} _{\\alpha \\in A}$ is a set of elements of $M$ which generate $M/IM$ and $I$ is nilpotent, then $M$ is generated by the $x_\\alpha $. \n\n\n\n\n    \n]] we obtain $J = J\'$ a contradiction. Hence $xI^{n + 1} \\subset xI \\cdot I^ n \\subset J \\cdot I^ n = 0$. Since $I^{n + 1} = I^ n$ we conclude $x \\in J$. Contradiction. \n      $\\square$\n    \n"
263,00U1,"<https://stacks.math.columbia.edu/tag/00UR> shows that it is equivalent to the definition here.""]
class Etale : Prop where
  formallyEtale : FormallyEtale R A := by infer_instance
  finitePresentation : FinitePresentation R A := by infer_instance
",Formal Proof of Stacks Project Tag 00U1,"Note that this is a different definition from this Stacks entry, bu",https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Etale/Basic.lean#L208-L211,Q27041,,10.143.1,definition,3.0,"['00U0', '00AO', '0ELQ']","\n  Definition 10.143.1. Let $R \\to S$ be a ring map. We say $R \\to S$ is \xc3\xa9tale if it is of finite presentation and the naive cotangent complex $\\mathop{N\\! L}\\nolimits _{S/R}$ is quasi-isomorphic to zero: this means that $H_1(\\mathop{N\\! L}\\nolimits _{S/R}) = 0$ and $\\Omega _{S/R} = 0$. Given a prime $\\mathfrak q$ of $S$ we say that $R \\to S$ is \xc3\xa9tale at $\\mathfrak q$ if there exists a $g \\in S$, $g \\not\\in \\mathfrak q$ such that $R \\to S_ g$ is \xc3\xa9tale. \n","\n  Definition 10.143.1. Let $R \\to S$ be a ring map. We say $R \\to S$ is \xc3\xa9tale if it is of finite presentation and the naive cotangent complex $\\mathop{N\\! L}\\nolimits _{S/R}$ is quasi-isomorphic to zero: this means that $H_1(\\mathop{N\\! L}\\nolimits _{S/R}) = 0$ and $\\Omega _{S/R} = 0$. Given a prime $\\mathfrak q$ of $S$ we say that $R \\to S$ is \xc3\xa9tale at $\\mathfrak q$ if there exists a $g \\in S$, $g \\not\\in \\mathfrak q$ such that $R \\to S_ g$ is \xc3\xa9tale. \n",," by infer_instance
  finitePresentation : FinitePresentation R A := by infer_instance
","<https://stacks.math.columbia.edu/tag/00UR> shows that it is equivalent to the definition here.""]
class Etale : Prop where
  formallyEtale : FormallyEtale R A ",
264,00UJ,"lemma Algebra.exists_etale_isIdempotentElem_forall_liesOver_eq [Module.Finite R S]
    (p : Ideal R) [p.IsPrime] (q : Ideal S) [q.IsPrime] [q.LiesOver p] :
    âˆƒ (R' : Type u) (_ : CommRing R') (_ : Algebra R R') (_ : Algebra.Etale R R') (P : Ideal R')
      (_ : P.IsPrime) (_ : P.LiesOver p) (e : R' âŠ—[R] S) (_ : IsIdempotentElem e)
      (P' : Ideal (R' âŠ—[R] S)) (_ : P'.IsPrime) (_ : P'.LiesOver P), P'.comap
        Algebra.TensorProduct.includeRight.toRingHom = q âˆ§ e âˆ‰ P' âˆ§
      Function.Bijective (Ideal.ResidueField.mapâ‚ p P (Algebra.ofId _ _) (P.over_def p)) âˆ§
      âˆ€ P'' : Ideal (R' âŠ—[R] S), P''.IsPrime â†’ P''.LiesOver P â†’ e âˆ‰ P'' â†’ P'' = P' := by
  classical
  obtain âŸ¨s, hsq, hsâŸ© := Ideal.exists_not_mem_forall_mem_of_ne_of_liesOver p q
  obtain âŸ¨m, f, b, hfm, hbm, hab, hfab, hfâŸ© : âˆƒ (m : â„•) (f : R[X])
      (b : p.ResidueField[X]), f.Monic âˆ§ b.Monic âˆ§ IsCoprime (X ^ (m + 1)) b âˆ§
        f.map (algebraMap _ _) = X ^ (m + 1) * b âˆ§ aeval s f = 0 := by
    have hs := Algebra.IsIntegral.isIntegral (R := R) s
    let f := X * minpoly R s
    obtain âŸ¨q, hq, hq'âŸ© := exists_eq_pow_rootMultiplicity_mul_and_not_dvd
      ((minpoly R s).map (algebraMap R p.ResidueField)) ((minpoly.monic hs).map _).ne_zero 0
    have hqm : q.Monic := by
      simpa [((minpoly.monic hs).map _).leadingCoeff] using congr(leadingCoeff $hq).symm
    set m' := rootMultiplicity 0 ((minpoly R s).map (algebraMap R p.ResidueField))
    refine âŸ¨m', f, q, monic_X.mul (minpoly.monic hs), hqm, ?_,
      by simp [f, hq, pow_succ', mul_assoc], by simp [f]âŸ©
    simpa [IsCoprime.pow_left_iff,
      (prime_X (R := p.ResidueField)).irreducible.coprime_iff_not_dvd] using hq'
  obtain âŸ¨R', _, _, _, P, _, _, a', b', hP, ha'm, hb'm, hfab', âŸ¨c, d, hcdâŸ©, ha', hb'âŸ© :=
    exists_etale_bijective_residueFieldMap_and_map_eq_mul_and_isCoprime p f
      (X ^ (m + 1)) b hfm (monic_X.pow _) hbm hfab hab
  let s' : R' âŠ—[R] S := 1 âŠ—â‚œ s
  have hs'f : aeval s' f = 0 :=
    show aeval (Algebra.TensorProduct.includeRight s) f = 0 by rw [aeval_algHom_apply, hf, map_zero]
  let e := aeval s' (c * a')
  have he : IsIdempotentElem e := by
    dsimp only [e, IsIdempotentElem]
    nth_rw 2 [eq_sub_iff_add_eq.mpr hcd]
    rw [â† map_mul, mul_sub, mul_one, mul_mul_mul_comm, â† hfab']
    simp only [map_mul, map_sub, aeval_map_algebraMap, hs'f, mul_zero, sub_zero]
  let P' := (Ideal.fiberIsoOfBijectiveResidueField hP).symm âŸ¨q, â€¹_â€º, â€¹_â€ºâŸ©
  have hP'q : P'.1.comap Algebra.TensorProduct.includeRight.toRingHom = q :=
    Ideal.comap_fiberIsoOfBijectiveResidueField_symm ..
  have hs'P' : s' âˆ‰ P'.1 := mt (fun h â†¦ hP'q.le h) hsq
  have ha'P' : aeval s' a' âˆ‰ P'.1 := by
    simpa using show IsScalarTower.toAlgHom R' _ P'.1.ResidueField (aeval s' a') â‰  0 by
      rw [â† aeval_algHom_apply, â† aeval_map_algebraMap P.ResidueField, â† ha']; simpa
  have hb'P' : aeval s' b' âˆˆ P'.1 := by
    rw [â† Ideal.IsPrime.mul_mem_left_iff ha'P', â† map_mul, â† hfab']
    simp [hs'f]
  have heP' : e âˆ‰ P'.1 := by
    intro H
    have := P'.1.mul_mem_left (aeval s' d) hb'P'
    rw [â† map_mul, eq_sub_iff_add_eq'.mpr hcd, map_sub, Submodule.sub_mem_iff_left _ H,
      map_one] at this
    exact Ideal.one_notMem _ this
  refine âŸ¨_, inferInstance, inferInstance, inferInstance, P, â€¹_â€º, â€¹_â€º,
    e, he, P', inferInstance, P'.2.2, hP'q, heP', hP, fun P'' _ _ H â†¦ ?_âŸ©
  apply Ideal.eq_of_comap_eq_comap_of_bijective_residueFieldMap hP
  rw [hP'q]
  contrapose! H
  have : s' âˆˆ P'' := hs _ inferInstance H (by simp [Ideal.liesOver_iff, Ideal.under,
    Ideal.comap_comap, Ideal.over_def P p, Ideal.over_def P'' P, â† IsScalarTower.algebraMap_eq])
  rw [â† Ideal.algebraMap_residueField_eq_zero, â† aeval_algebraMap_apply,
    Ideal.algebraMap_residueField_eq_zero.mpr this, â† eval_map_algebraMap, Polynomial.map_mul,
    mul_comm, â† (Ideal.ResidueField.mapâ‚ P P'' (Algebra.ofId _ _) (P''.over_def P)).comp_algebraMap,
    â† Polynomial.map_map, â† ha']
  simp
",Formal Proof of Stacks Project Tag 00UJ,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Etale/QuasiFinite.lean#L115-L178,Q27041,,10.145.2,lemma,3.0,"['0G1B', '00AO', '0ELQ']","\n  Lemma 10.145.2. Let $R \\to S$ be a ring map. Let $\\mathfrak q \\subset S$ be a prime lying over the prime $\\mathfrak p \\subset R$. Assume $R \\to S$ finite type and quasi-finite at $\\mathfrak q$. Then there exists \n  \n  \nan \xc3\xa9tale ring map $R \\to R\'$, \n\n\na prime $\\mathfrak p\' \\subset R\'$ lying over $\\mathfrak p$, \n\n\na product decomposition \n\n\n  \\[  R\' \\otimes _ R S = A \\times B  \\]\n\n\n\n   with the following properties \n  \n  \n$\\kappa (\\mathfrak p) = \\kappa (\\mathfrak p\')$, \n\n\n$R\' \\to A$ is finite, \n\n\n$A$ has exactly one prime $\\mathfrak r$ lying over $\\mathfrak p\'$, \n\n\n$\\mathfrak r$ lies over $\\mathfrak q$, and \n\n\n$B$ does not have a prime lying over $\\mathfrak q$ and $\\mathfrak p\'$. \n\n\n\n\n    \n      Proof.\n      Let $S\' \\subset S$ be the integral closure of $R$ in $S$. Let $\\mathfrak q\' = S\' \\cap \\mathfrak q$. By Zariski\'s Main Theorem 10.123.12 there exists a $g \\in S\'$, $g \\not\\in \\mathfrak q\'$ such that $S\'_ g \\cong S_ g$. Consider the fibre rings $F = S \\otimes _ R \\kappa (\\mathfrak p)$ and $F\' = S\' \\otimes _ R \\kappa (\\mathfrak p)$. Denote $\\overline{\\mathfrak q}\'$ the prime of $F\'$ corresponding to $\\mathfrak q\'$. Since $F\'$ is integral over $\\kappa (\\mathfrak p)$ we see that $\\overline{\\mathfrak q}\'$ is a closed point of $\\mathop{\\mathrm{Spec}}(F\')$, see Lemma 10.36.19. Note that $\\mathfrak q$ defines an isolated closed point $\\overline{\\mathfrak q}$ of $\\mathop{\\mathrm{Spec}}(F)$ (see Definition 10.122.3). Since $S\'_ g \\cong S_ g$ we have $F\'_ g \\cong F_ g$, so $\\overline{\\mathfrak q}$ and $\\overline{\\mathfrak q}\'$ have isomorphic open neighbourhoods in $\\mathop{\\mathrm{Spec}}(F)$ and $\\mathop{\\mathrm{Spec}}(F\')$. We conclude the set $\\{ \\overline{\\mathfrak q}\'\\}  \\subset \\mathop{\\mathrm{Spec}}(F\')$ is open. Combined with $\\mathfrak q\'$ being closed (shown above) we conclude that $\\overline{\\mathfrak q}\'$ defines an isolated closed point of $\\mathop{\\mathrm{Spec}}(F\')$ as well. \n    \n      An additional small remark is that under the map $\\mathop{\\mathrm{Spec}}(F) \\to \\mathop{\\mathrm{Spec}}(F\')$ the point $\\overline{\\mathfrak q}$ is the only point mapping to $\\overline{\\mathfrak q}\'$. This follows from the discussion above. \n    \n      By Lemma 10.24.3 we may write $F\' = F\'_1 \\times F\'_2$ with $\\mathop{\\mathrm{Spec}}(F\'_1) = \\{ \\overline{\\mathfrak q}\'\\} $. Since $F\' = S\' \\otimes _ R \\kappa (\\mathfrak p)$, there exists an $s\' \\in S\'$ which maps to the element $(r, 0) \\in F\'_1 \\times F\'_2 = F\'$ for some $r \\in R$, $r \\not\\in \\mathfrak p$. In fact, what we will use about $s\'$ is that it is an element of $S\'$, not contained in $\\mathfrak q\'$, and contained in any other prime lying over $\\mathfrak p$. \n    \n      Let $f(x) \\in R[x]$ be a monic polynomial such that $f(s\') = 0$. Denote $\\overline{f} \\in \\kappa (\\mathfrak p)[x]$ the image. We can factor it as $\\overline{f} = x^ e \\overline{h}$ where $\\overline{h}(0) \\not= 0$. After replacing $f$ by $x f$ if necessary, we may assume $e \\geq 1$. By Lemma 10.143.13 we can find an \xc3\xa9tale ring extension $R \\to R\'$, a prime $\\mathfrak p\'$ lying over $\\mathfrak p$, and a factorization $f = h i$ in $R\'[x]$ such that $\\kappa (\\mathfrak p) = \\kappa (\\mathfrak p\')$, $\\overline{h} = h \\bmod \\mathfrak p\'$, $x^ e = i \\bmod \\mathfrak p\'$, and we can write $a h + b i = 1$ in $R\'[x]$ (for suitable $a, b$). \n    \n      Consider the elements $h(s\'), i(s\') \\in R\' \\otimes _ R S\'$. By construction we have $h(s\')i(s\') = f(s\') = 0$. On the other hand they generate the unit ideal since $a(s\')h(s\') + b(s\')i(s\') = 1$. Thus we see that $R\' \\otimes _ R S\'$ is the product of the localizations at these elements: \n    \n      \n  \\[  R\' \\otimes _ R S\' = (R\' \\otimes _ R S\')_{i(s\')} \\times (R\' \\otimes _ R S\')_{h(s\')} = S\'_1 \\times S\'_2  \\]\n\n    \n       Moreover this product decomposition is compatible with the product decomposition we found for the fibre ring $F\'$; this comes from our choices of $s\', i, h$ which guarantee that $\\overline{\\mathfrak q}\'$ is the only prime of $F\'$ which does not contain the image of $i(s\')$ in $F\'$. Here we use that the fibre ring of $R\'\\otimes _ R S\'$ over $R\'$ at $\\mathfrak p\'$ is the same as $F\'$ due to the fact that $\\kappa (\\mathfrak p) = \\kappa (\\mathfrak p\')$. It follows that $S\'_1$ has exactly one prime, say $\\mathfrak r\'$, lying over $\\mathfrak p\'$ and that this prime lies over $\\mathfrak q\'$. Hence the element $g \\in S\'$ maps to an element of $S\'_1$ not contained in $\\mathfrak r\'$. \n    \n      The base change $R\'\\otimes _ R S$ inherits a similar product decomposition \n    \n      \n  \\[  R\' \\otimes _ R S = (R\' \\otimes _ R S)_{i(s\')} \\times (R\' \\otimes _ R S)_{h(s\')} = S_1 \\times S_2  \\]\n\n    \n       It follows from the above that $S_1$ has exactly one prime, say $\\mathfrak r$, lying over $\\mathfrak p\'$ (consider the fibre ring as above), and that this prime lies over $\\mathfrak q$. \n    \n      Now we may apply Lemma 10.145.1 to the ring maps $R\' \\to S\'_1 \\to S_1$, the prime $\\mathfrak p\'$ and the element $g$ to see that after replacing $R\'$ by a principal localization we can assume that $S_1$ is finite over $R\'$ as desired. \n      $\\square$\n    \n","\n  Lemma 10.145.2. Let $R \\to S$ be a ring map. Let $\\mathfrak q \\subset S$ be a prime lying over the prime $\\mathfrak p \\subset R$. Assume $R \\to S$ finite type and quasi-finite at $\\mathfrak q$. Then there exists \n  \n  \nan \xc3\xa9tale ring map $R \\to R\'$, \n\n\na prime $\\mathfrak p\' \\subset R\'$ lying over $\\mathfrak p$, \n\n\na product decomposition \n\n\n  \\[  R\' \\otimes _ R S = A \\times B  \\]\n\n\n\n   with the following properties \n  \n  \n$\\kappa (\\mathfrak p) = \\kappa (\\mathfrak p\')$, \n\n\n$R\' \\to A$ is finite, \n\n\n$A$ has exactly one prime $\\mathfrak r$ lying over $\\mathfrak p\'$, \n\n\n$\\mathfrak r$ lies over $\\mathfrak q$, and \n\n\n$B$ does not have a prime lying over $\\mathfrak q$ and $\\mathfrak p\'$. \n\n\n\n\n    \n","Proof.\n      Let $S\' \\subset S$ be the integral closure of $R$ in $S$. Let $\\mathfrak q\' = S\' \\cap \\mathfrak q$. By Zariski\'s Main Theorem 10.123.12 there exists a $g \\in S\'$, $g \\not\\in \\mathfrak q\'$ such that $S\'_ g \\cong S_ g$. Consider the fibre rings $F = S \\otimes _ R \\kappa (\\mathfrak p)$ and $F\' = S\' \\otimes _ R \\kappa (\\mathfrak p)$. Denote $\\overline{\\mathfrak q}\'$ the prime of $F\'$ corresponding to $\\mathfrak q\'$. Since $F\'$ is integral over $\\kappa (\\mathfrak p)$ we see that $\\overline{\\mathfrak q}\'$ is a closed point of $\\mathop{\\mathrm{Spec}}(F\')$, see Lemma 10.36.19. Note that $\\mathfrak q$ defines an isolated closed point $\\overline{\\mathfrak q}$ of $\\mathop{\\mathrm{Spec}}(F)$ (see Definition 10.122.3). Since $S\'_ g \\cong S_ g$ we have $F\'_ g \\cong F_ g$, so $\\overline{\\mathfrak q}$ and $\\overline{\\mathfrak q}\'$ have isomorphic open neighbourhoods in $\\mathop{\\mathrm{Spec}}(F)$ and $\\mathop{\\mathrm{Spec}}(F\')$. We conclude the set $\\{ \\overline{\\mathfrak q}\'\\}  \\subset \\mathop{\\mathrm{Spec}}(F\')$ is open. Combined with $\\mathfrak q\'$ being closed (shown above) we conclude that $\\overline{\\mathfrak q}\'$ defines an isolated closed point of $\\mathop{\\mathrm{Spec}}(F\')$ as well. \n    \n      An additional small remark is that under the map $\\mathop{\\mathrm{Spec}}(F) \\to \\mathop{\\mathrm{Spec}}(F\')$ the point $\\overline{\\mathfrak q}$ is the only point mapping to $\\overline{\\mathfrak q}\'$. This follows from the discussion above. \n    \n      By Lemma 10.24.3 we may write $F\' = F\'_1 \\times F\'_2$ with $\\mathop{\\mathrm{Spec}}(F\'_1) = \\{ \\overline{\\mathfrak q}\'\\} $. Since $F\' = S\' \\otimes _ R \\kappa (\\mathfrak p)$, there exists an $s\' \\in S\'$ which maps to the element $(r, 0) \\in F\'_1 \\times F\'_2 = F\'$ for some $r \\in R$, $r \\not\\in \\mathfrak p$. In fact, what we will use about $s\'$ is that it is an element of $S\'$, not contained in $\\mathfrak q\'$, and contained in any other prime lying over $\\mathfrak p$. \n    \n      Let $f(x) \\in R[x]$ be a monic polynomial such that $f(s\') = 0$. Denote $\\overline{f} \\in \\kappa (\\mathfrak p)[x]$ the image. We can factor it as $\\overline{f} = x^ e \\overline{h}$ where $\\overline{h}(0) \\not= 0$. After replacing $f$ by $x f$ if necessary, we may assume $e \\geq 1$. By Lemma 10.143.13 we can find an \xc3\xa9tale ring extension $R \\to R\'$, a prime $\\mathfrak p\'$ lying over $\\mathfrak p$, and a factorization $f = h i$ in $R\'[x]$ such that $\\kappa (\\mathfrak p) = \\kappa (\\mathfrak p\')$, $\\overline{h} = h \\bmod \\mathfrak p\'$, $x^ e = i \\bmod \\mathfrak p\'$, and we can write $a h + b i = 1$ in $R\'[x]$ (for suitable $a, b$). \n    \n      Consider the elements $h(s\'), i(s\') \\in R\' \\otimes _ R S\'$. By construction we have $h(s\')i(s\') = f(s\') = 0$. On the other hand they generate the unit ideal since $a(s\')h(s\') + b(s\')i(s\') = 1$. Thus we see that $R\' \\otimes _ R S\'$ is the product of the localizations at these elements: \n    \n      \n  \\[  R\' \\otimes _ R S\' = (R\' \\otimes _ R S\')_{i(s\')} \\times (R\' \\otimes _ R S\')_{h(s\')} = S\'_1 \\times S\'_2  \\]\n\n    \n       Moreover this product decomposition is compatible with the product decomposition we found for the fibre ring $F\'$; this comes from our choices of $s\', i, h$ which guarantee that $\\overline{\\mathfrak q}\'$ is the only prime of $F\'$ which does not contain the image of $i(s\')$ in $F\'$. Here we use that the fibre ring of $R\'\\otimes _ R S\'$ over $R\'$ at $\\mathfrak p\'$ is the same as $F\'$ due to the fact that $\\kappa (\\mathfrak p) = \\kappa (\\mathfrak p\')$. It follows that $S\'_1$ has exactly one prime, say $\\mathfrak r\'$, lying over $\\mathfrak p\'$ and that this prime lies over $\\mathfrak q\'$. Hence the element $g \\in S\'$ maps to an element of $S\'_1$ not contained in $\\mathfrak r\'$. \n    \n      The base change $R\'\\otimes _ R S$ inherits a similar product decomposition \n    \n      \n  \\[  R\' \\otimes _ R S = (R\' \\otimes _ R S)_{i(s\')} \\times (R\' \\otimes _ R S)_{h(s\')} = S_1 \\times S_2  \\]\n\n    \n       It follows from the above that $S_1$ has exactly one prime, say $\\mathfrak r$, lying over $\\mathfrak p\'$ (consider the fibre ring as above), and that this prime lies over $\\mathfrak q$. \n    \n      Now we may apply Lemma 10.145.1 to the ring maps $R\' \\to S\'_1 \\to S_1$, the prime $\\mathfrak p\'$ and the element $g$ to see that after replacing $R\'$ by a principal localization we can assume that $S_1$ is finite over $R\'$ as desired. \n      $\\square$\n    \n"," by
  classical
  obtain âŸ¨s, hsq, hsâŸ© := Ideal.exists_not_mem_forall_mem_of_ne_of_liesOver p q
  obtain âŸ¨m, f, b, hfm, hbm, hab, hfab, hfâŸ© : âˆƒ (m : â„•) (f : R[X])
      (b : p.ResidueField[X]), f.Monic âˆ§ b.Monic âˆ§ IsCoprime (X ^ (m + 1)) b âˆ§
        f.map (algebraMap _ _) = X ^ (m + 1) * b âˆ§ aeval s f = 0 := by
    have hs := Algebra.IsIntegral.isIntegral (R := R) s
    let f := X * minpoly R s
    obtain âŸ¨q, hq, hq'âŸ© := exists_eq_pow_rootMultiplicity_mul_and_not_dvd
      ((minpoly R s).map (algebraMap R p.ResidueField)) ((minpoly.monic hs).map _).ne_zero 0
    have hqm : q.Monic := by
      simpa [((minpoly.monic hs).map _).leadingCoeff] using congr(leadingCoeff $hq).symm
    set m' := rootMultiplicity 0 ((minpoly R s).map (algebraMap R p.ResidueField))
    refine âŸ¨m', f, q, monic_X.mul (minpoly.monic hs), hqm, ?_,
      by simp [f, hq, pow_succ', mul_assoc], by simp [f]âŸ©
    simpa [IsCoprime.pow_left_iff,
      (prime_X (R := p.ResidueField)).irreducible.coprime_iff_not_dvd] using hq'
  obtain âŸ¨R', _, _, _, P, _, _, a', b', hP, ha'm, hb'm, hfab', âŸ¨c, d, hcdâŸ©, ha', hb'âŸ© :=
    exists_etale_bijective_residueFieldMap_and_map_eq_mul_and_isCoprime p f
      (X ^ (m + 1)) b hfm (monic_X.pow _) hbm hfab hab
  let s' : R' âŠ—[R] S := 1 âŠ—â‚œ s
  have hs'f : aeval s' f = 0 :=
    show aeval (Algebra.TensorProduct.includeRight s) f = 0 by rw [aeval_algHom_apply, hf, map_zero]
  let e := aeval s' (c * a')
  have he : IsIdempotentElem e := by
    dsimp only [e, IsIdempotentElem]
    nth_rw 2 [eq_sub_iff_add_eq.mpr hcd]
    rw [â† map_mul, mul_sub, mul_one, mul_mul_mul_comm, â† hfab']
    simp only [map_mul, map_sub, aeval_map_algebraMap, hs'f, mul_zero, sub_zero]
  let P' := (Ideal.fiberIsoOfBijectiveResidueField hP).symm âŸ¨q, â€¹_â€º, â€¹_â€ºâŸ©
  have hP'q : P'.1.comap Algebra.TensorProduct.includeRight.toRingHom = q :=
    Ideal.comap_fiberIsoOfBijectiveResidueField_symm ..
  have hs'P' : s' âˆ‰ P'.1 := mt (fun h â†¦ hP'q.le h) hsq
  have ha'P' : aeval s' a' âˆ‰ P'.1 := by
    simpa using show IsScalarTower.toAlgHom R' _ P'.1.ResidueField (aeval s' a') â‰  0 by
      rw [â† aeval_algHom_apply, â† aeval_map_algebraMap P.ResidueField, â† ha']; simpa
  have hb'P' : aeval s' b' âˆˆ P'.1 := by
    rw [â† Ideal.IsPrime.mul_mem_left_iff ha'P', â† map_mul, â† hfab']
    simp [hs'f]
  have heP' : e âˆ‰ P'.1 := by
    intro H
    have := P'.1.mul_mem_left (aeval s' d) hb'P'
    rw [â† map_mul, eq_sub_iff_add_eq'.mpr hcd, map_sub, Submodule.sub_mem_iff_left _ H,
      map_one] at this
    exact Ideal.one_notMem _ this
  refine âŸ¨_, inferInstance, inferInstance, inferInstance, P, â€¹_â€º, â€¹_â€º,
    e, he, P', inferInstance, P'.2.2, hP'q, heP', hP, fun P'' _ _ H â†¦ ?_âŸ©
  apply Ideal.eq_of_comap_eq_comap_of_bijective_residueFieldMap hP
  rw [hP'q]
  contrapose! H
  have : s' âˆˆ P'' := hs _ inferInstance H (by simp [Ideal.liesOver_iff, Ideal.under,
    Ideal.comap_comap, Ideal.over_def P p, Ideal.over_def P'' P, â† IsScalarTower.algebraMap_eq])
  rw [â† Ideal.algebraMap_residueField_eq_zero, â† aeval_algebraMap_apply,
    Ideal.algebraMap_residueField_eq_zero.mpr this, â† eval_map_algebraMap, Polynomial.map_mul,
    mul_comm, â† (Ideal.ResidueField.mapâ‚ P P'' (Algebra.ofId _ _) (P''.over_def P)).comp_algebraMap,
    â† Polynomial.map_map, â† ha']
  simp
","lemma Algebra.exists_etale_isIdempotentElem_forall_liesOver_eq [Module.Finite R S]
    (p : Ideal R) [p.IsPrime] (q : Ideal S) [q.IsPrime] [q.LiesOver p] :
    âˆƒ (R' : Type u) (_ : CommRing R') (_ : Algebra R R') (_ : Algebra.Etale R R') (P : Ideal R')
      (_ : P.IsPrime) (_ : P.LiesOver p) (e : R' âŠ—[R] S) (_ : IsIdempotentElem e)
      (P' : Ideal (R' âŠ—[R] S)) (_ : P'.IsPrime) (_ : P'.LiesOver P), P'.comap
        Algebra.TensorProduct.includeRight.toRingHom = q âˆ§ e âˆ‰ P' âˆ§
      Function.Bijective (Ideal.ResidueField.mapâ‚ p P (Algebra.ofId _ _) (P.over_def p)) âˆ§
      âˆ€ P'' : Ideal (R' âŠ—[R] S), P''.IsPrime â†’ P''.LiesOver P â†’ e âˆ‰ P'' â†’ P'' = P' ","Proof.\n      Let $S\' \\subset S$ be the integral closure of $R$ in $S$. Let $\\mathfrak q\' = S\' \\cap \\mathfrak q$. By Zariski\'s Main Theorem 10.123.12 [[\n  Theorem 10.123.12 (Zariski\'s Main Theorem).  Let $R$ be a ring. Let $R \\to S$ be a finite type $R$-algebra. Let $S\' \\subset S$ be the integral closure of $R$ in $S$. Let $\\mathfrak q \\subset S$ be a prime of $S$. If $R \\to S$ is quasi-finite at $\\mathfrak q$ then there exists a $g \\in S\'$, $g \\not\\in \\mathfrak q$ such that $S\'_ g \\cong S_ g$. \n\n    \n]] there exists a $g \\in S\'$, $g \\not\\in \\mathfrak q\'$ such that $S\'_ g \\cong S_ g$. Consider the fibre rings $F = S \\otimes _ R \\kappa (\\mathfrak p)$ and $F\' = S\' \\otimes _ R \\kappa (\\mathfrak p)$. Denote $\\overline{\\mathfrak q}\'$ the prime of $F\'$ corresponding to $\\mathfrak q\'$. Since $F\'$ is integral over $\\kappa (\\mathfrak p)$ we see that $\\overline{\\mathfrak q}\'$ is a closed point of $\\mathop{\\mathrm{Spec}}(F\')$, see Lemma 10.36.19 [[\n  Lemma 10.36.19. Let $k$ be a field. Let $S$ be a $k$-algebra over $k$. \n  \n  \nIf $S$ is a domain and finite dimensional over $k$, then $S$ is a field. \n\n\nIf $S$ is integral over $k$ and a domain, then $S$ is a field. \n\n\nIf $S$ is integral over $k$ then every prime of $S$ is a maximal ideal (see Lemma 10.26.5 for more consequences). \n\n\n\n\n    \n]]. Note that $\\mathfrak q$ defines an isolated closed point $\\overline{\\mathfrak q}$ of $\\mathop{\\mathrm{Spec}}(F)$ (see Definition 10.122.3 [[\n  Definition 10.122.3. Let $R \\to S$ be a finite type ring map. Let $\\mathfrak q \\subset S$ be a prime. \n  \n  \nIf the equivalent conditions of Lemma 10.122.2 are satisfied then we say $R \\to S$ is quasi-finite at $\\mathfrak q$. \n\n\nWe say a ring map $A \\to B$ is quasi-finite if it is of finite type and quasi-finite at all primes of $B$. \n\n\n\n]]). Since $S\'_ g \\cong S_ g$ we have $F\'_ g \\cong F_ g$, so $\\overline{\\mathfrak q}$ and $\\overline{\\mathfrak q}\'$ have isomorphic open neighbourhoods in $\\mathop{\\mathrm{Spec}}(F)$ and $\\mathop{\\mathrm{Spec}}(F\')$. We conclude the set $\\{ \\overline{\\mathfrak q}\'\\}  \\subset \\mathop{\\mathrm{Spec}}(F\')$ is open. Combined with $\\mathfrak q\'$ being closed (shown above) we conclude that $\\overline{\\mathfrak q}\'$ defines an isolated closed point of $\\mathop{\\mathrm{Spec}}(F\')$ as well. \n    \n      An additional small remark is that under the map $\\mathop{\\mathrm{Spec}}(F) \\to \\mathop{\\mathrm{Spec}}(F\')$ the point $\\overline{\\mathfrak q}$ is the only point mapping to $\\overline{\\mathfrak q}\'$. This follows from the discussion above. \n    \n      By Lemma 10.24.3 [[\n  Lemma 10.24.3. Let $R$ be a ring. If $\\mathop{\\mathrm{Spec}}(R) = U \\amalg V$ with both $U$ and $V$ open then $R \\cong R_1 \\times R_2$ with $U \\cong \\mathop{\\mathrm{Spec}}(R_1)$ and $V \\cong \\mathop{\\mathrm{Spec}}(R_2)$ via the maps in Lemma 10.21.2. Moreover, both $R_1$ and $R_2$ are localizations as well as quotients of the ring $R$. \n\n    \n]] we may write $F\' = F\'_1 \\times F\'_2$ with $\\mathop{\\mathrm{Spec}}(F\'_1) = \\{ \\overline{\\mathfrak q}\'\\} $. Since $F\' = S\' \\otimes _ R \\kappa (\\mathfrak p)$, there exists an $s\' \\in S\'$ which maps to the element $(r, 0) \\in F\'_1 \\times F\'_2 = F\'$ for some $r \\in R$, $r \\not\\in \\mathfrak p$. In fact, what we will use about $s\'$ is that it is an element of $S\'$, not contained in $\\mathfrak q\'$, and contained in any other prime lying over $\\mathfrak p$. \n    \n      Let $f(x) \\in R[x]$ be a monic polynomial such that $f(s\') = 0$. Denote $\\overline{f} \\in \\kappa (\\mathfrak p)[x]$ the image. We can factor it as $\\overline{f} = x^ e \\overline{h}$ where $\\overline{h}(0) \\not= 0$. After replacing $f$ by $x f$ if necessary, we may assume $e \\geq 1$. By Lemma 10.143.13 [[\n  Lemma 10.143.13. Let $R$ be a ring. Let $f \\in R[x]$ be a monic polynomial. Let $\\mathfrak p$ be a prime of $R$. Let $f \\bmod \\mathfrak p = \\overline{g} \\overline{h}$ be a factorization of the image of $f$ in $\\kappa (\\mathfrak p)[x]$. If $\\gcd (\\overline{g}, \\overline{h}) = 1$, then there exist \n  \n  \nan \xc3\xa9tale ring map $R \\to R\'$, \n\n\na prime $\\mathfrak p\' \\subset R\'$ lying over $\\mathfrak p$, and \n\n\na factorization $f = g h$ in $R\'[x]$ \n\n\n\n   such that \n  \n  \n$\\kappa (\\mathfrak p) = \\kappa (\\mathfrak p\')$, \n\n\n$\\overline{g} = g \\bmod \\mathfrak p\'$, $\\overline{h} = h \\bmod \\mathfrak p\'$, and \n\n\nthe polynomials $g, h$ generate the unit ideal in $R\'[x]$. \n\n\n\n\n    \n]] we can find an \xc3\xa9tale ring extension $R \\to R\'$, a prime $\\mathfrak p\'$ lying over $\\mathfrak p$, and a factorization $f = h i$ in $R\'[x]$ such that $\\kappa (\\mathfrak p) = \\kappa (\\mathfrak p\')$, $\\overline{h} = h \\bmod \\mathfrak p\'$, $x^ e = i \\bmod \\mathfrak p\'$, and we can write $a h + b i = 1$ in $R\'[x]$ (for suitable $a, b$). \n    \n      Consider the elements $h(s\'), i(s\') \\in R\' \\otimes _ R S\'$. By construction we have $h(s\')i(s\') = f(s\') = 0$. On the other hand they generate the unit ideal since $a(s\')h(s\') + b(s\')i(s\') = 1$. Thus we see that $R\' \\otimes _ R S\'$ is the product of the localizations at these elements: \n    \n      \n  \\[  R\' \\otimes _ R S\' = (R\' \\otimes _ R S\')_{i(s\')} \\times (R\' \\otimes _ R S\')_{h(s\')} = S\'_1 \\times S\'_2  \\]\n\n    \n       Moreover this product decomposition is compatible with the product decomposition we found for the fibre ring $F\'$; this comes from our choices of $s\', i, h$ which guarantee that $\\overline{\\mathfrak q}\'$ is the only prime of $F\'$ which does not contain the image of $i(s\')$ in $F\'$. Here we use that the fibre ring of $R\'\\otimes _ R S\'$ over $R\'$ at $\\mathfrak p\'$ is the same as $F\'$ due to the fact that $\\kappa (\\mathfrak p) = \\kappa (\\mathfrak p\')$. It follows that $S\'_1$ has exactly one prime, say $\\mathfrak r\'$, lying over $\\mathfrak p\'$ and that this prime lies over $\\mathfrak q\'$. Hence the element $g \\in S\'$ maps to an element of $S\'_1$ not contained in $\\mathfrak r\'$. \n    \n      The base change $R\'\\otimes _ R S$ inherits a similar product decomposition \n    \n      \n  \\[  R\' \\otimes _ R S = (R\' \\otimes _ R S)_{i(s\')} \\times (R\' \\otimes _ R S)_{h(s\')} = S_1 \\times S_2  \\]\n\n    \n       It follows from the above that $S_1$ has exactly one prime, say $\\mathfrak r$, lying over $\\mathfrak p\'$ (consider the fibre ring as above), and that this prime lies over $\\mathfrak q$. \n    \n      Now we may apply Lemma 10.145.1 [[\n  Lemma 10.145.1. Let $R \\to S\' \\to S$ be ring maps. Let $\\mathfrak p \\subset R$ be a prime. Let $g \\in S\'$ be an element. Assume \n  \n  \n$R \\to S\'$ is integral, \n\n\n$R \\to S$ is finite type, \n\n\n$S\'_ g \\cong S_ g$, and \n\n\n$g$ invertible in $S\' \\otimes _ R \\kappa (\\mathfrak p)$. \n\n\n\n   Then there exists a $f \\in R$, $f \\not\\in \\mathfrak p$ such that $R_ f \\to S_ f$ is finite. \n\n    \n]] to the ring maps $R\' \\to S\'_1 \\to S_1$, the prime $\\mathfrak p\'$ and the element $g$ to see that after replacing $R\'$ by a principal localization we can assume that $S_1$ is finite over $R\'$ as desired. \n      $\\square$\n    \n"
265,07CF,"public lemma exists_presentation_of_free_cotangent [Algebra.FinitePresentation R S]
    {Î± : Type*} (P : Generators R S Î±) [Finite Î±]
    [Module.Free S P.toExtension.Cotangent] :
    âˆƒ (P' : Presentation R S (Unit âŠ• Î±) (Unit âŠ• Fin (Module.finrank S P.toExtension.Cotangent)))
      (b : Module.Basis (Unit âŠ• Fin (Module.finrank S P.toExtension.Cotangent))
        S P'.toExtension.Cotangent),
      P'.val âˆ˜ Sum.inr = P.val âˆ§
      âˆ€ r, b r = Extension.Cotangent.mk âŸ¨P'.relation r, P'.relation_mem_ker râŸ© := by
  cases subsingleton_or_nontrivial S
  Â· let P' : Presentation R S (Unit âŠ• Î±) (Unit âŠ• Fin (Module.finrank S P.toExtension.Cotangent)) :=
      { toGenerators := .ofSurjective (fun i : Unit âŠ• Î± â†¦ 0) (Function.surjective_to_subsingleton _)
        relation _ := 1
        span_range_relation_eq_ker := by simpa using (RingHom.ker_eq_top_of_subsingleton _).symm }
    have : Subsingleton P'.toExtension.Cotangent := Module.subsingleton S _
    exact âŸ¨P', default, by subsingleton, by subsingletonâŸ©
  have : Module.Finite S P.toExtension.Cotangent :=
    Algebra.Extension.Cotangent.finite P.fg_ker_of_finitePresentation
  exact exists_presentation_of_basis_cotangent _ <| Module.finBasis S P.toExtension.Cotangent
",Formal Proof of Stacks Project Tag 07CF,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Extension/Cotangent/Basis.lean#L302-L319,Q27041,,10.136.6,lemma,3.0,"['00SK', '00AO', '0ELQ']","\n  Lemma 10.136.6. Let $S$ be a finitely presented $R$-algebra which has a presentation $S = R[x_1, \\ldots , x_ n]/I$ such that $I/I^2$ is free over $S$. Then $S$ has a presentation $S = R[y_1, \\ldots , y_ m]/(f_1, \\ldots , f_ c)$ such that $(f_1, \\ldots , f_ c)/(f_1, \\ldots , f_ c)^2$ is free with basis given by the classes of $f_1, \\ldots , f_ c$. \n\n    \n      Proof.\n      Note that $I$ is a finitely generated ideal by Lemma 10.6.3. Let $f_1, \\ldots , f_ c \\in I$ be elements which map to a basis of $I/I^2$. By Nakayama\'s lemma (Lemma 10.20.1) there exists a $g \\in 1 + I$ such that \n    \n      \n  \\[  g \\cdot I \\subset (f_1, \\ldots , f_ c)  \\]\n\n    \n       and $I_ g \\cong (f_1, \\ldots , f_ c)_ g$. Hence we see that \n    \n      \n  \\[  S \\cong R[x_1, \\ldots , x_ n]/(f_1, \\ldots , f_ c)[1/g] \\cong R[x_1, \\ldots , x_ n, x_{n + 1}]/(f_1, \\ldots , f_ c, gx_{n + 1} - 1)  \\]\n\n    \n       as desired. It follows that $f_1, \\ldots , f_ c,gx_{n + 1} - 1$ form a basis for $(f_1, \\ldots , f_ c, gx_{n + 1} - 1)/(f_1, \\ldots , f_ c, gx_{n + 1} - 1)^2$ for example by applying Lemma 10.134.12. \n      $\\square$\n    \n","\n  Lemma 10.136.6. Let $S$ be a finitely presented $R$-algebra which has a presentation $S = R[x_1, \\ldots , x_ n]/I$ such that $I/I^2$ is free over $S$. Then $S$ has a presentation $S = R[y_1, \\ldots , y_ m]/(f_1, \\ldots , f_ c)$ such that $(f_1, \\ldots , f_ c)/(f_1, \\ldots , f_ c)^2$ is free with basis given by the classes of $f_1, \\ldots , f_ c$. \n\n    \n","Proof.\n      Note that $I$ is a finitely generated ideal by Lemma 10.6.3. Let $f_1, \\ldots , f_ c \\in I$ be elements which map to a basis of $I/I^2$. By Nakayama\'s lemma (Lemma 10.20.1) there exists a $g \\in 1 + I$ such that \n    \n      \n  \\[  g \\cdot I \\subset (f_1, \\ldots , f_ c)  \\]\n\n    \n       and $I_ g \\cong (f_1, \\ldots , f_ c)_ g$. Hence we see that \n    \n      \n  \\[  S \\cong R[x_1, \\ldots , x_ n]/(f_1, \\ldots , f_ c)[1/g] \\cong R[x_1, \\ldots , x_ n, x_{n + 1}]/(f_1, \\ldots , f_ c, gx_{n + 1} - 1)  \\]\n\n    \n       as desired. It follows that $f_1, \\ldots , f_ c,gx_{n + 1} - 1$ form a basis for $(f_1, \\ldots , f_ c, gx_{n + 1} - 1)/(f_1, \\ldots , f_ c, gx_{n + 1} - 1)^2$ for example by applying Lemma 10.134.12. \n      $\\square$\n    \n"," by
  cases subsingleton_or_nontrivial S
  Â· let P' : Presentation R S (Unit âŠ• Î±) (Unit âŠ• Fin (Module.finrank S P.toExtension.Cotangent)) :=
      { toGenerators := .ofSurjective (fun i : Unit âŠ• Î± â†¦ 0) (Function.surjective_to_subsingleton _)
        relation _ := 1
        span_range_relation_eq_ker := by simpa using (RingHom.ker_eq_top_of_subsingleton _).symm }
    have : Subsingleton P'.toExtension.Cotangent := Module.subsingleton S _
    exact âŸ¨P', default, by subsingleton, by subsingletonâŸ©
  have : Module.Finite S P.toExtension.Cotangent :=
    Algebra.Extension.Cotangent.finite P.fg_ker_of_finitePresentation
  exact exists_presentation_of_basis_cotangent _ <| Module.finBasis S P.toExtension.Cotangent
","public lemma exists_presentation_of_free_cotangent [Algebra.FinitePresentation R S]
    {Î± : Type*} (P : Generators R S Î±) [Finite Î±]
    [Module.Free S P.toExtension.Cotangent] :
    âˆƒ (P' : Presentation R S (Unit âŠ• Î±) (Unit âŠ• Fin (Module.finrank S P.toExtension.Cotangent)))
      (b : Module.Basis (Unit âŠ• Fin (Module.finrank S P.toExtension.Cotangent))
        S P'.toExtension.Cotangent),
      P'.val âˆ˜ Sum.inr = P.val âˆ§
      âˆ€ r, b r = Extension.Cotangent.mk âŸ¨P'.relation r, P'.relation_mem_ker râŸ© ","Proof.\n      Note that $I$ is a finitely generated ideal by Lemma 10.6.3 [[\n  Lemma 10.6.3. Let $R \\to S$ be a ring map of finite presentation. For any surjection $\\alpha : R[x_1, \\ldots , x_ n] \\to S$ the kernel of $\\alpha $ is a finitely generated ideal in $R[x_1, \\ldots , x_ n]$. \n\n    \n]]. Let $f_1, \\ldots , f_ c \\in I$ be elements which map to a basis of $I/I^2$. By Nakayama\'s lemma (Lemma 10.20.1 [[\n        \n      \n      \n  Lemma 10.20.1 (Nakayama\'s lemma). Let $R$ be a ring with Jacobson radical $\\text{rad}(R)$. Let $M$ be an $R$-module. Let $I \\subset R$ be an ideal. \n  \n  \n If $IM = M$ and $M$ is finite, then there exists an $f \\in 1 + I$ such that $fM = 0$. \n\n\nIf $IM = M$, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $M = 0$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, and $N\'$ is finite, then there exists an $f \\in 1 + I$ such that $fM \\subset N$ and $M_ f = N_ f$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, $N\'$ is finite, and $I \\subset \\text{rad}(R)$, then $M = N$. \n\n\nIf $N \\to M$ is a module map, $N/IN \\to M/IM$ is surjective, and $M$ is finite, then there exists an $f \\in 1 + I$ such that $N_ f \\to M_ f$ is surjective. \n\n\nIf $N \\to M$ is a module map, $N/IN \\to M/IM$ is surjective, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $N \\to M$ is surjective. \n\n\nIf $x_1, \\ldots , x_ n \\in M$ generate $M/IM$ and $M$ is finite, then there exists an $f \\in 1 + I$ such that $x_1, \\ldots , x_ n$ generate $M_ f$ over $R_ f$. \n\n\nIf $x_1, \\ldots , x_ n \\in M$ generate $M/IM$, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $M$ is generated by $x_1, \\ldots , x_ n$. \n\n\nIf $IM = M$, $I$ is nilpotent, then $M = 0$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, and $I$ is nilpotent then $M = N$. \n\n\nIf $N \\to M$ is a module map, $I$ is nilpotent, and $N/IN \\to M/IM$ is surjective, then $N \\to M$ is surjective. \n\n\nIf $\\{ x_\\alpha \\} _{\\alpha \\in A}$ is a set of elements of $M$ which generate $M/IM$ and $I$ is nilpotent, then $M$ is generated by the $x_\\alpha $. \n\n\n\n\n    \n]]) there exists a $g \\in 1 + I$ such that \n    \n      \n  \\[  g \\cdot I \\subset (f_1, \\ldots , f_ c)  \\]\n\n    \n       and $I_ g \\cong (f_1, \\ldots , f_ c)_ g$. Hence we see that \n    \n      \n  \\[  S \\cong R[x_1, \\ldots , x_ n]/(f_1, \\ldots , f_ c)[1/g] \\cong R[x_1, \\ldots , x_ n, x_{n + 1}]/(f_1, \\ldots , f_ c, gx_{n + 1} - 1)  \\]\n\n    \n       as desired. It follows that $f_1, \\ldots , f_ c,gx_{n + 1} - 1$ form a basis for $(f_1, \\ldots , f_ c, gx_{n + 1} - 1)/(f_1, \\ldots , f_ c, gx_{n + 1} - 1)^2$ for example by applying Lemma 10.134.12 [[\n       \n      \n  Lemma 10.134.12. Let $A \\to B$ be a ring map. Let $g \\in B$. Suppose $\\alpha : P \\to B$ is a presentation with kernel $I$. Then a presentation of $B_ g$ over $A$ is the map \n  \n  \\[  \\beta : P[x] \\longrightarrow B_ g  \\]\n\n   extending $\\alpha $ and sending $x$ to $1/g$. The kernel $J$ of $\\beta $ is generated by $I$ and the element $f x - 1$ where $f \\in P$ is an element mapped to $g \\in B$ by $\\alpha $. In this situation we have \n  \n  \n$J/J^2 = (I/I^2)_ g \\oplus B_ g (f x - 1)$, \n\n\n$\\Omega _{P[x]/A} \\otimes _{P[x]} B_ g = \\Omega _{P/A} \\otimes _ P B_ g \\oplus B_ g \\text{d}x$, \n\n\n$\\mathop{N\\! L}\\nolimits (\\beta ) \\cong \\mathop{N\\! L}\\nolimits (\\alpha ) \\otimes _ B B_ g \\oplus (B_ g \\xrightarrow {g} B_ g)$ \n\n\n\n   Hence the canonical map $\\mathop{N\\! L}\\nolimits _{B/A} \\otimes _ B B_ g \\to \\mathop{N\\! L}\\nolimits _{B_ g/A}$ is a homotopy equivalence. \n\n    \n]]. \n      $\\square$\n    \n"
266,08JZ,"lemma liftBaseChange_injective_of_isLocalizationAway :
    Function.Injective (LinearMap.liftBaseChange T
      (Extension.Cotangent.map
        ((Generators.localizationAway T g).toComp P).toExtensionHom)) := by
  set Q := Generators.localizationAway T g
  algebraize [((Generators.localizationAway T g).toComp P).toAlgHom.toRingHom]
  let f : P.Ring â§¸ P.ker ^ 2 := P.Ïƒ g
  let Ï€ := compLocalizationAwayAlgHom T g P
  refine IsLocalizedModule.injective_of_map_zero (Submonoid.powers g)
    (TensorProduct.mk S T P.toExtension.Cotangent 1) (fun x hx â†¦ ?_)
  obtain âŸ¨x, rflâŸ© := Algebra.Extension.Cotangent.mk_surjective x
  suffices h : algebraMap P.Ring (Localization.Away f) x.val = 0 by
    rw [IsScalarTower.algebraMap_apply _ (P.Ring â§¸ P.ker ^ 2) _,
      IsLocalization.map_eq_zero_iff (Submonoid.powers f) (Localization.Away f)] at h
    obtain âŸ¨âŸ¨m, âŸ¨n, rflâŸ©âŸ©, hmâŸ© := h
    rw [IsLocalizedModule.eq_zero_iff (Submonoid.powers g)]
    use âŸ¨g ^ n, n, rflâŸ©
    dsimp [f] at hm
    rw [â† map_pow, â† map_mul, Ideal.Quotient.eq_zero_iff_mem] at hm
    simp only [Submonoid.smul_def]
    rw [show g = algebraMap P.Ring S (P.Ïƒ g) by simp, â† map_pow, algebraMap_smul, â† map_smul,
      Extension.Cotangent.mk_eq_zero_iff]
    simpa using hm
  rw [â† compLocalizationAwayAlgHom_toAlgHom_toComp (T := T)]
  apply sq_ker_comp_le_ker_compLocalizationAwayAlgHom
  simpa only [LinearEquiv.coe_coe, LinearMap.ringLmapEquivSelf_symm_apply,
    mk_apply, lift.tmul, LinearMap.coe_restrictScalars, LinearMap.coe_smulRight,
    Module.End.one_apply, LinearMap.smul_apply, one_smul, Algebra.Extension.Cotangent.map_mk,
    Extension.Cotangent.mk_eq_zero_iff] using hx
",Formal Proof of Stacks Project Tag 08JZ,part of (1),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Extension/Cotangent/LocalizationAway.lean#L126-L154,Q27041,,10.134.12,lemma,3.0,"['00S0', '00AO', '0ELQ']","\n       \n      \n  Lemma 10.134.12. Let $A \\to B$ be a ring map. Let $g \\in B$. Suppose $\\alpha : P \\to B$ is a presentation with kernel $I$. Then a presentation of $B_ g$ over $A$ is the map \n  \n  \\[  \\beta : P[x] \\longrightarrow B_ g  \\]\n\n   extending $\\alpha $ and sending $x$ to $1/g$. The kernel $J$ of $\\beta $ is generated by $I$ and the element $f x - 1$ where $f \\in P$ is an element mapped to $g \\in B$ by $\\alpha $. In this situation we have \n  \n  \n$J/J^2 = (I/I^2)_ g \\oplus B_ g (f x - 1)$, \n\n\n$\\Omega _{P[x]/A} \\otimes _{P[x]} B_ g = \\Omega _{P/A} \\otimes _ P B_ g \\oplus B_ g \\text{d}x$, \n\n\n$\\mathop{N\\! L}\\nolimits (\\beta ) \\cong \\mathop{N\\! L}\\nolimits (\\alpha ) \\otimes _ B B_ g \\oplus (B_ g \\xrightarrow {g} B_ g)$ \n\n\n\n   Hence the canonical map $\\mathop{N\\! L}\\nolimits _{B/A} \\otimes _ B B_ g \\to \\mathop{N\\! L}\\nolimits _{B_ g/A}$ is a homotopy equivalence. \n\n    \n      Proof.\n      Since $P[x]/(I, fx - 1) = B[x]/(gx - 1) = B_ g$ we get the statement about $I$ and $fx - 1$ generating $J$. Consider the commutative diagram \n    \n      \n  \\[  \\xymatrix{ 0 \\ar[r] &  \\Omega _{P/A} \\otimes B_ g \\ar[r] &  \\Omega _{P[x]/A} \\otimes B_ g \\ar[r] &  \\Omega _{B[x]/B} \\otimes B_ g \\ar[r] &  0 \\\\  &  (I/I^2)_ g \\ar[r] \\ar[u] &  J/J^2 \\ar[r] \\ar[u] &  (gx - 1)/(gx - 1)^2 \\ar[r] \\ar[u] &  0 }  \\]\n\n    \n       with exact rows of Lemma 10.134.4. The $B_ g$-module $\\Omega _{B[x]/B} \\otimes B_ g$ is free of rank $1$ on $\\text{d}x$. The element $\\text{d}x$ in the $B_ g$-module $\\Omega _{P[x]/A} \\otimes B_ g$ provides a splitting for the top row. The element $gx - 1 \\in (gx - 1)/(gx - 1)^2$ is mapped to $g\\text{d}x$ in $\\Omega _{B[x]/B} \\otimes B_ g$ and hence $(gx - 1)/(gx - 1)^2$ is free of rank $1$ over $B_ g$. (This can also be seen by arguing that $gx - 1$ is a nonzerodivisor in $B[x]$ because it is a polynomial with invertible constant term and any nonzerodivisor gives a quasi-regular sequence of length $1$ by Lemma 10.69.2.) \n    \n      Let us prove $(I/I^2)_ g \\to J/J^2$ injective. Consider the $P$-algebra map \n    \n      \n  \\[  \\pi : P[x] \\to (P/I^2)_ f = P_ f/I_ f^2  \\]\n\n    \n       sending $x$ to $1/f$. Since $J$ is generated by $I$ and $fx - 1$ we see that $\\pi (J) \\subset (I/I^2)_ f = (I/I^2)_ g$. Since this is an ideal of square zero we see that $\\pi (J^2) = 0$. If $a \\in I$ maps to an element of $J^2$ in $J$, then $\\pi (a) = 0$, which implies that $a$ maps to zero in $I_ f/I_ f^2$. This proves the desired injectivity. \n    \n      Thus we have a short exact sequence of two term complexes \n    \n      \n  \\[  0 \\to \\mathop{N\\! L}\\nolimits (\\alpha ) \\otimes _ B B_ g \\to \\mathop{N\\! L}\\nolimits (\\beta ) \\to (B_ g \\xrightarrow {g} B_ g) \\to 0  \\]\n\n    \n       Such a short exact sequence can always be split in the category of complexes. In our particular case we can take as splittings \n    \n      \n  \\[  J/J^2 = (I/I^2)_ g \\oplus B_ g (fx - 1)\\quad \\text{and}\\quad \\Omega _{P[x]/A} \\otimes B_ g = \\Omega _{P/A} \\otimes B_ g \\oplus B_ g (g^{-2}\\text{d}f + \\text{d}x)  \\]\n\n    \n       This works because $\\text{d}(fx - 1) = x\\text{d}f + f \\text{d}x = g(g^{-2}\\text{d}f + \\text{d}x)$ in $\\Omega _{P[x]/A} \\otimes B_ g$. \n      $\\square$\n    \n","\n       \n      \n  Lemma 10.134.12. Let $A \\to B$ be a ring map. Let $g \\in B$. Suppose $\\alpha : P \\to B$ is a presentation with kernel $I$. Then a presentation of $B_ g$ over $A$ is the map \n  \n  \\[  \\beta : P[x] \\longrightarrow B_ g  \\]\n\n   extending $\\alpha $ and sending $x$ to $1/g$. The kernel $J$ of $\\beta $ is generated by $I$ and the element $f x - 1$ where $f \\in P$ is an element mapped to $g \\in B$ by $\\alpha $. In this situation we have \n  \n  \n$J/J^2 = (I/I^2)_ g \\oplus B_ g (f x - 1)$, \n\n\n$\\Omega _{P[x]/A} \\otimes _{P[x]} B_ g = \\Omega _{P/A} \\otimes _ P B_ g \\oplus B_ g \\text{d}x$, \n\n\n$\\mathop{N\\! L}\\nolimits (\\beta ) \\cong \\mathop{N\\! L}\\nolimits (\\alpha ) \\otimes _ B B_ g \\oplus (B_ g \\xrightarrow {g} B_ g)$ \n\n\n\n   Hence the canonical map $\\mathop{N\\! L}\\nolimits _{B/A} \\otimes _ B B_ g \\to \\mathop{N\\! L}\\nolimits _{B_ g/A}$ is a homotopy equivalence. \n\n    \n","Proof.\n      Since $P[x]/(I, fx - 1) = B[x]/(gx - 1) = B_ g$ we get the statement about $I$ and $fx - 1$ generating $J$. Consider the commutative diagram \n    \n      \n  \\[  \\xymatrix{ 0 \\ar[r] &  \\Omega _{P/A} \\otimes B_ g \\ar[r] &  \\Omega _{P[x]/A} \\otimes B_ g \\ar[r] &  \\Omega _{B[x]/B} \\otimes B_ g \\ar[r] &  0 \\\\  &  (I/I^2)_ g \\ar[r] \\ar[u] &  J/J^2 \\ar[r] \\ar[u] &  (gx - 1)/(gx - 1)^2 \\ar[r] \\ar[u] &  0 }  \\]\n\n    \n       with exact rows of Lemma 10.134.4. The $B_ g$-module $\\Omega _{B[x]/B} \\otimes B_ g$ is free of rank $1$ on $\\text{d}x$. The element $\\text{d}x$ in the $B_ g$-module $\\Omega _{P[x]/A} \\otimes B_ g$ provides a splitting for the top row. The element $gx - 1 \\in (gx - 1)/(gx - 1)^2$ is mapped to $g\\text{d}x$ in $\\Omega _{B[x]/B} \\otimes B_ g$ and hence $(gx - 1)/(gx - 1)^2$ is free of rank $1$ over $B_ g$. (This can also be seen by arguing that $gx - 1$ is a nonzerodivisor in $B[x]$ because it is a polynomial with invertible constant term and any nonzerodivisor gives a quasi-regular sequence of length $1$ by Lemma 10.69.2.) \n    \n      Let us prove $(I/I^2)_ g \\to J/J^2$ injective. Consider the $P$-algebra map \n    \n      \n  \\[  \\pi : P[x] \\to (P/I^2)_ f = P_ f/I_ f^2  \\]\n\n    \n       sending $x$ to $1/f$. Since $J$ is generated by $I$ and $fx - 1$ we see that $\\pi (J) \\subset (I/I^2)_ f = (I/I^2)_ g$. Since this is an ideal of square zero we see that $\\pi (J^2) = 0$. If $a \\in I$ maps to an element of $J^2$ in $J$, then $\\pi (a) = 0$, which implies that $a$ maps to zero in $I_ f/I_ f^2$. This proves the desired injectivity. \n    \n      Thus we have a short exact sequence of two term complexes \n    \n      \n  \\[  0 \\to \\mathop{N\\! L}\\nolimits (\\alpha ) \\otimes _ B B_ g \\to \\mathop{N\\! L}\\nolimits (\\beta ) \\to (B_ g \\xrightarrow {g} B_ g) \\to 0  \\]\n\n    \n       Such a short exact sequence can always be split in the category of complexes. In our particular case we can take as splittings \n    \n      \n  \\[  J/J^2 = (I/I^2)_ g \\oplus B_ g (fx - 1)\\quad \\text{and}\\quad \\Omega _{P[x]/A} \\otimes B_ g = \\Omega _{P/A} \\otimes B_ g \\oplus B_ g (g^{-2}\\text{d}f + \\text{d}x)  \\]\n\n    \n       This works because $\\text{d}(fx - 1) = x\\text{d}f + f \\text{d}x = g(g^{-2}\\text{d}f + \\text{d}x)$ in $\\Omega _{P[x]/A} \\otimes B_ g$. \n      $\\square$\n    \n"," by
  set Q := Generators.localizationAway T g
  algebraize [((Generators.localizationAway T g).toComp P).toAlgHom.toRingHom]
  let f : P.Ring â§¸ P.ker ^ 2 := P.Ïƒ g
  let Ï€ := compLocalizationAwayAlgHom T g P
  refine IsLocalizedModule.injective_of_map_zero (Submonoid.powers g)
    (TensorProduct.mk S T P.toExtension.Cotangent 1) (fun x hx â†¦ ?_)
  obtain âŸ¨x, rflâŸ© := Algebra.Extension.Cotangent.mk_surjective x
  suffices h : algebraMap P.Ring (Localization.Away f) x.val = 0 by
    rw [IsScalarTower.algebraMap_apply _ (P.Ring â§¸ P.ker ^ 2) _,
      IsLocalization.map_eq_zero_iff (Submonoid.powers f) (Localization.Away f)] at h
    obtain âŸ¨âŸ¨m, âŸ¨n, rflâŸ©âŸ©, hmâŸ© := h
    rw [IsLocalizedModule.eq_zero_iff (Submonoid.powers g)]
    use âŸ¨g ^ n, n, rflâŸ©
    dsimp [f] at hm
    rw [â† map_pow, â† map_mul, Ideal.Quotient.eq_zero_iff_mem] at hm
    simp only [Submonoid.smul_def]
    rw [show g = algebraMap P.Ring S (P.Ïƒ g) by simp, â† map_pow, algebraMap_smul, â† map_smul,
      Extension.Cotangent.mk_eq_zero_iff]
    simpa using hm
  rw [â† compLocalizationAwayAlgHom_toAlgHom_toComp (T := T)]
  apply sq_ker_comp_le_ker_compLocalizationAwayAlgHom
  simpa only [LinearEquiv.coe_coe, LinearMap.ringLmapEquivSelf_symm_apply,
    mk_apply, lift.tmul, LinearMap.coe_restrictScalars, LinearMap.coe_smulRight,
    Module.End.one_apply, LinearMap.smul_apply, one_smul, Algebra.Extension.Cotangent.map_mk,
    Extension.Cotangent.mk_eq_zero_iff] using hx
","lemma liftBaseChange_injective_of_isLocalizationAway :
    Function.Injective (LinearMap.liftBaseChange T
      (Extension.Cotangent.map
        ((Generators.localizationAway T g).toComp P).toExtensionHom)) ","Proof.\n      Since $P[x]/(I, fx - 1) = B[x]/(gx - 1) = B_ g$ we get the statement about $I$ and $fx - 1$ generating $J$. Consider the commutative diagram \n    \n      \n  \\[  \\xymatrix{ 0 \\ar[r] &  \\Omega _{P/A} \\otimes B_ g \\ar[r] &  \\Omega _{P[x]/A} \\otimes B_ g \\ar[r] &  \\Omega _{B[x]/B} \\otimes B_ g \\ar[r] &  0 \\\\  &  (I/I^2)_ g \\ar[r] \\ar[u] &  J/J^2 \\ar[r] \\ar[u] &  (gx - 1)/(gx - 1)^2 \\ar[r] \\ar[u] &  0 }  \\]\n\n    \n       with exact rows of Lemma 10.134.4 [[\n  Lemma 10.134.4 (Jacobi-Zariski sequence).  Let $A \\to B \\to C$ be ring maps. Choose a presentation $\\alpha : A[x_ s, s \\in S] \\to B$ with kernel $I$. Choose a presentation $\\beta : B[y_ t, t \\in T] \\to C$ with kernel $J$. Let $\\gamma : A[x_ s, y_ t] \\to C$ be the induced presentation of $C$ with kernel $K$. Then we get a canonical commutative diagram \n  \n  \\[  \\xymatrix{ 0 \\ar[r] &  \\Omega _{A[x_ s]/A} \\otimes C \\ar[r] &  \\Omega _{A[x_ s, y_ t]/A} \\otimes C \\ar[r] &  \\Omega _{B[y_ t]/B} \\otimes C \\ar[r] &  0 \\\\  &  I/I^2 \\otimes C \\ar[r] \\ar[u] &  K/K^2 \\ar[r] \\ar[u] &  J/J^2 \\ar[r] \\ar[u] &  0 }  \\]\n\n   with exact rows. We get the following exact sequence of homology groups \n  \n  \\[  H_1(\\mathop{N\\! L}\\nolimits _{B/A} \\otimes _ B C) \\to H_1(L_{C/A}) \\to H_1(L_{C/B}) \\to C \\otimes _ B \\Omega _{B/A} \\to \\Omega _{C/A} \\to \\Omega _{C/B} \\to 0  \\]\n\n   of $C$-modules extending the sequence of Lemma 10.131.7. If $\\text{Tor}_1^ B(\\Omega _{B/A}, C) = 0$ and $\\text{Tor}_2^ B(\\Omega _{B/A}, C) = 0$, then $H_1(\\mathop{N\\! L}\\nolimits _{B/A} \\otimes _ B C) = H_1(L_{B/A}) \\otimes _ B C$. \n\n    \n]]. The $B_ g$-module $\\Omega _{B[x]/B} \\otimes B_ g$ is free of rank $1$ on $\\text{d}x$. The element $\\text{d}x$ in the $B_ g$-module $\\Omega _{P[x]/A} \\otimes B_ g$ provides a splitting for the top row. The element $gx - 1 \\in (gx - 1)/(gx - 1)^2$ is mapped to $g\\text{d}x$ in $\\Omega _{B[x]/B} \\otimes B_ g$ and hence $(gx - 1)/(gx - 1)^2$ is free of rank $1$ over $B_ g$. (This can also be seen by arguing that $gx - 1$ is a nonzerodivisor in $B[x]$ because it is a polynomial with invertible constant term and any nonzerodivisor gives a quasi-regular sequence of length $1$ by Lemma 10.69.2 [[\n  Lemma 10.69.2. Let $R$ be a ring. \n  \n  \nA regular sequence $f_1, \\ldots , f_ c$ of $R$ is a quasi-regular sequence. \n\n\nSuppose that $M$ is an $R$-module and that $f_1, \\ldots , f_ c$ is an $M$-regular sequence. Then $f_1, \\ldots , f_ c$ is an $M$-quasi-regular sequence. \n\n\n\n\n    \n]].) \n    \n      Let us prove $(I/I^2)_ g \\to J/J^2$ injective. Consider the $P$-algebra map \n    \n      \n  \\[  \\pi : P[x] \\to (P/I^2)_ f = P_ f/I_ f^2  \\]\n\n    \n       sending $x$ to $1/f$. Since $J$ is generated by $I$ and $fx - 1$ we see that $\\pi (J) \\subset (I/I^2)_ f = (I/I^2)_ g$. Since this is an ideal of square zero we see that $\\pi (J^2) = 0$. If $a \\in I$ maps to an element of $J^2$ in $J$, then $\\pi (a) = 0$, which implies that $a$ maps to zero in $I_ f/I_ f^2$. This proves the desired injectivity. \n    \n      Thus we have a short exact sequence of two term complexes \n    \n      \n  \\[  0 \\to \\mathop{N\\! L}\\nolimits (\\alpha ) \\otimes _ B B_ g \\to \\mathop{N\\! L}\\nolimits (\\beta ) \\to (B_ g \\xrightarrow {g} B_ g) \\to 0  \\]\n\n    \n       Such a short exact sequence can always be split in the category of complexes. In our particular case we can take as splittings \n    \n      \n  \\[  J/J^2 = (I/I^2)_ g \\oplus B_ g (fx - 1)\\quad \\text{and}\\quad \\Omega _{P[x]/A} \\otimes B_ g = \\Omega _{P/A} \\otimes B_ g \\oplus B_ g (g^{-2}\\text{d}f + \\text{d}x)  \\]\n\n    \n       This works because $\\text{d}(fx - 1) = x\\text{d}f + f \\text{d}x = g(g^{-2}\\text{d}f + \\text{d}x)$ in $\\Omega _{P[x]/A} \\otimes B_ g$. \n      $\\square$\n    \n"
267,08JZ,"noncomputable
def cotangentCompLocalizationAwayEquiv :
    ((localizationAway T g).comp P).toExtension.Cotangent â‰ƒâ‚—[T]
      T âŠ—[S] P.toExtension.Cotangent Ã— (Generators.localizationAway T g).toExtension.Cotangent :=
  ((Cotangent.exact (localizationAway g (S := T)) P).splitSurjectiveEquiv
    (liftBaseChange_injective_of_isLocalizationAway _ P)
    âŸ¨cotangentCompAwaySec g P x, map_comp_cotangentCompAwaySec g P hxâŸ©).1
",Formal Proof of Stacks Project Tag 08JZ,(1),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Extension/Cotangent/LocalizationAway.lean#L197-L203,Q27041,,10.134.12,lemma,3.0,"['00S0', '00AO', '0ELQ']","\n       \n      \n  Lemma 10.134.12. Let $A \\to B$ be a ring map. Let $g \\in B$. Suppose $\\alpha : P \\to B$ is a presentation with kernel $I$. Then a presentation of $B_ g$ over $A$ is the map \n  \n  \\[  \\beta : P[x] \\longrightarrow B_ g  \\]\n\n   extending $\\alpha $ and sending $x$ to $1/g$. The kernel $J$ of $\\beta $ is generated by $I$ and the element $f x - 1$ where $f \\in P$ is an element mapped to $g \\in B$ by $\\alpha $. In this situation we have \n  \n  \n$J/J^2 = (I/I^2)_ g \\oplus B_ g (f x - 1)$, \n\n\n$\\Omega _{P[x]/A} \\otimes _{P[x]} B_ g = \\Omega _{P/A} \\otimes _ P B_ g \\oplus B_ g \\text{d}x$, \n\n\n$\\mathop{N\\! L}\\nolimits (\\beta ) \\cong \\mathop{N\\! L}\\nolimits (\\alpha ) \\otimes _ B B_ g \\oplus (B_ g \\xrightarrow {g} B_ g)$ \n\n\n\n   Hence the canonical map $\\mathop{N\\! L}\\nolimits _{B/A} \\otimes _ B B_ g \\to \\mathop{N\\! L}\\nolimits _{B_ g/A}$ is a homotopy equivalence. \n\n    \n      Proof.\n      Since $P[x]/(I, fx - 1) = B[x]/(gx - 1) = B_ g$ we get the statement about $I$ and $fx - 1$ generating $J$. Consider the commutative diagram \n    \n      \n  \\[  \\xymatrix{ 0 \\ar[r] &  \\Omega _{P/A} \\otimes B_ g \\ar[r] &  \\Omega _{P[x]/A} \\otimes B_ g \\ar[r] &  \\Omega _{B[x]/B} \\otimes B_ g \\ar[r] &  0 \\\\  &  (I/I^2)_ g \\ar[r] \\ar[u] &  J/J^2 \\ar[r] \\ar[u] &  (gx - 1)/(gx - 1)^2 \\ar[r] \\ar[u] &  0 }  \\]\n\n    \n       with exact rows of Lemma 10.134.4. The $B_ g$-module $\\Omega _{B[x]/B} \\otimes B_ g$ is free of rank $1$ on $\\text{d}x$. The element $\\text{d}x$ in the $B_ g$-module $\\Omega _{P[x]/A} \\otimes B_ g$ provides a splitting for the top row. The element $gx - 1 \\in (gx - 1)/(gx - 1)^2$ is mapped to $g\\text{d}x$ in $\\Omega _{B[x]/B} \\otimes B_ g$ and hence $(gx - 1)/(gx - 1)^2$ is free of rank $1$ over $B_ g$. (This can also be seen by arguing that $gx - 1$ is a nonzerodivisor in $B[x]$ because it is a polynomial with invertible constant term and any nonzerodivisor gives a quasi-regular sequence of length $1$ by Lemma 10.69.2.) \n    \n      Let us prove $(I/I^2)_ g \\to J/J^2$ injective. Consider the $P$-algebra map \n    \n      \n  \\[  \\pi : P[x] \\to (P/I^2)_ f = P_ f/I_ f^2  \\]\n\n    \n       sending $x$ to $1/f$. Since $J$ is generated by $I$ and $fx - 1$ we see that $\\pi (J) \\subset (I/I^2)_ f = (I/I^2)_ g$. Since this is an ideal of square zero we see that $\\pi (J^2) = 0$. If $a \\in I$ maps to an element of $J^2$ in $J$, then $\\pi (a) = 0$, which implies that $a$ maps to zero in $I_ f/I_ f^2$. This proves the desired injectivity. \n    \n      Thus we have a short exact sequence of two term complexes \n    \n      \n  \\[  0 \\to \\mathop{N\\! L}\\nolimits (\\alpha ) \\otimes _ B B_ g \\to \\mathop{N\\! L}\\nolimits (\\beta ) \\to (B_ g \\xrightarrow {g} B_ g) \\to 0  \\]\n\n    \n       Such a short exact sequence can always be split in the category of complexes. In our particular case we can take as splittings \n    \n      \n  \\[  J/J^2 = (I/I^2)_ g \\oplus B_ g (fx - 1)\\quad \\text{and}\\quad \\Omega _{P[x]/A} \\otimes B_ g = \\Omega _{P/A} \\otimes B_ g \\oplus B_ g (g^{-2}\\text{d}f + \\text{d}x)  \\]\n\n    \n       This works because $\\text{d}(fx - 1) = x\\text{d}f + f \\text{d}x = g(g^{-2}\\text{d}f + \\text{d}x)$ in $\\Omega _{P[x]/A} \\otimes B_ g$. \n      $\\square$\n    \n","\n       \n      \n  Lemma 10.134.12. Let $A \\to B$ be a ring map. Let $g \\in B$. Suppose $\\alpha : P \\to B$ is a presentation with kernel $I$. Then a presentation of $B_ g$ over $A$ is the map \n  \n  \\[  \\beta : P[x] \\longrightarrow B_ g  \\]\n\n   extending $\\alpha $ and sending $x$ to $1/g$. The kernel $J$ of $\\beta $ is generated by $I$ and the element $f x - 1$ where $f \\in P$ is an element mapped to $g \\in B$ by $\\alpha $. In this situation we have \n  \n  \n$J/J^2 = (I/I^2)_ g \\oplus B_ g (f x - 1)$, \n\n\n$\\Omega _{P[x]/A} \\otimes _{P[x]} B_ g = \\Omega _{P/A} \\otimes _ P B_ g \\oplus B_ g \\text{d}x$, \n\n\n$\\mathop{N\\! L}\\nolimits (\\beta ) \\cong \\mathop{N\\! L}\\nolimits (\\alpha ) \\otimes _ B B_ g \\oplus (B_ g \\xrightarrow {g} B_ g)$ \n\n\n\n   Hence the canonical map $\\mathop{N\\! L}\\nolimits _{B/A} \\otimes _ B B_ g \\to \\mathop{N\\! L}\\nolimits _{B_ g/A}$ is a homotopy equivalence. \n\n    \n","Proof.\n      Since $P[x]/(I, fx - 1) = B[x]/(gx - 1) = B_ g$ we get the statement about $I$ and $fx - 1$ generating $J$. Consider the commutative diagram \n    \n      \n  \\[  \\xymatrix{ 0 \\ar[r] &  \\Omega _{P/A} \\otimes B_ g \\ar[r] &  \\Omega _{P[x]/A} \\otimes B_ g \\ar[r] &  \\Omega _{B[x]/B} \\otimes B_ g \\ar[r] &  0 \\\\  &  (I/I^2)_ g \\ar[r] \\ar[u] &  J/J^2 \\ar[r] \\ar[u] &  (gx - 1)/(gx - 1)^2 \\ar[r] \\ar[u] &  0 }  \\]\n\n    \n       with exact rows of Lemma 10.134.4. The $B_ g$-module $\\Omega _{B[x]/B} \\otimes B_ g$ is free of rank $1$ on $\\text{d}x$. The element $\\text{d}x$ in the $B_ g$-module $\\Omega _{P[x]/A} \\otimes B_ g$ provides a splitting for the top row. The element $gx - 1 \\in (gx - 1)/(gx - 1)^2$ is mapped to $g\\text{d}x$ in $\\Omega _{B[x]/B} \\otimes B_ g$ and hence $(gx - 1)/(gx - 1)^2$ is free of rank $1$ over $B_ g$. (This can also be seen by arguing that $gx - 1$ is a nonzerodivisor in $B[x]$ because it is a polynomial with invertible constant term and any nonzerodivisor gives a quasi-regular sequence of length $1$ by Lemma 10.69.2.) \n    \n      Let us prove $(I/I^2)_ g \\to J/J^2$ injective. Consider the $P$-algebra map \n    \n      \n  \\[  \\pi : P[x] \\to (P/I^2)_ f = P_ f/I_ f^2  \\]\n\n    \n       sending $x$ to $1/f$. Since $J$ is generated by $I$ and $fx - 1$ we see that $\\pi (J) \\subset (I/I^2)_ f = (I/I^2)_ g$. Since this is an ideal of square zero we see that $\\pi (J^2) = 0$. If $a \\in I$ maps to an element of $J^2$ in $J$, then $\\pi (a) = 0$, which implies that $a$ maps to zero in $I_ f/I_ f^2$. This proves the desired injectivity. \n    \n      Thus we have a short exact sequence of two term complexes \n    \n      \n  \\[  0 \\to \\mathop{N\\! L}\\nolimits (\\alpha ) \\otimes _ B B_ g \\to \\mathop{N\\! L}\\nolimits (\\beta ) \\to (B_ g \\xrightarrow {g} B_ g) \\to 0  \\]\n\n    \n       Such a short exact sequence can always be split in the category of complexes. In our particular case we can take as splittings \n    \n      \n  \\[  J/J^2 = (I/I^2)_ g \\oplus B_ g (fx - 1)\\quad \\text{and}\\quad \\Omega _{P[x]/A} \\otimes B_ g = \\Omega _{P/A} \\otimes B_ g \\oplus B_ g (g^{-2}\\text{d}f + \\text{d}x)  \\]\n\n    \n       This works because $\\text{d}(fx - 1) = x\\text{d}f + f \\text{d}x = g(g^{-2}\\text{d}f + \\text{d}x)$ in $\\Omega _{P[x]/A} \\otimes B_ g$. \n      $\\square$\n    \n","
  ((Cotangent.exact (localizationAway g (S := T)) P).splitSurjectiveEquiv
    (liftBaseChange_injective_of_isLocalizationAway _ P)
    âŸ¨cotangentCompAwaySec g P x, map_comp_cotangentCompAwaySec g P hxâŸ©).1
","noncomputable
def cotangentCompLocalizationAwayEquiv :
    ((localizationAway T g).comp P).toExtension.Cotangent â‰ƒâ‚—[T]
      T âŠ—[S] P.toExtension.Cotangent Ã— (Generators.localizationAway T g).toExtension.Cotangent ","Proof.\n      Since $P[x]/(I, fx - 1) = B[x]/(gx - 1) = B_ g$ we get the statement about $I$ and $fx - 1$ generating $J$. Consider the commutative diagram \n    \n      \n  \\[  \\xymatrix{ 0 \\ar[r] &  \\Omega _{P/A} \\otimes B_ g \\ar[r] &  \\Omega _{P[x]/A} \\otimes B_ g \\ar[r] &  \\Omega _{B[x]/B} \\otimes B_ g \\ar[r] &  0 \\\\  &  (I/I^2)_ g \\ar[r] \\ar[u] &  J/J^2 \\ar[r] \\ar[u] &  (gx - 1)/(gx - 1)^2 \\ar[r] \\ar[u] &  0 }  \\]\n\n    \n       with exact rows of Lemma 10.134.4 [[\n  Lemma 10.134.4 (Jacobi-Zariski sequence).  Let $A \\to B \\to C$ be ring maps. Choose a presentation $\\alpha : A[x_ s, s \\in S] \\to B$ with kernel $I$. Choose a presentation $\\beta : B[y_ t, t \\in T] \\to C$ with kernel $J$. Let $\\gamma : A[x_ s, y_ t] \\to C$ be the induced presentation of $C$ with kernel $K$. Then we get a canonical commutative diagram \n  \n  \\[  \\xymatrix{ 0 \\ar[r] &  \\Omega _{A[x_ s]/A} \\otimes C \\ar[r] &  \\Omega _{A[x_ s, y_ t]/A} \\otimes C \\ar[r] &  \\Omega _{B[y_ t]/B} \\otimes C \\ar[r] &  0 \\\\  &  I/I^2 \\otimes C \\ar[r] \\ar[u] &  K/K^2 \\ar[r] \\ar[u] &  J/J^2 \\ar[r] \\ar[u] &  0 }  \\]\n\n   with exact rows. We get the following exact sequence of homology groups \n  \n  \\[  H_1(\\mathop{N\\! L}\\nolimits _{B/A} \\otimes _ B C) \\to H_1(L_{C/A}) \\to H_1(L_{C/B}) \\to C \\otimes _ B \\Omega _{B/A} \\to \\Omega _{C/A} \\to \\Omega _{C/B} \\to 0  \\]\n\n   of $C$-modules extending the sequence of Lemma 10.131.7. If $\\text{Tor}_1^ B(\\Omega _{B/A}, C) = 0$ and $\\text{Tor}_2^ B(\\Omega _{B/A}, C) = 0$, then $H_1(\\mathop{N\\! L}\\nolimits _{B/A} \\otimes _ B C) = H_1(L_{B/A}) \\otimes _ B C$. \n\n    \n]]. The $B_ g$-module $\\Omega _{B[x]/B} \\otimes B_ g$ is free of rank $1$ on $\\text{d}x$. The element $\\text{d}x$ in the $B_ g$-module $\\Omega _{P[x]/A} \\otimes B_ g$ provides a splitting for the top row. The element $gx - 1 \\in (gx - 1)/(gx - 1)^2$ is mapped to $g\\text{d}x$ in $\\Omega _{B[x]/B} \\otimes B_ g$ and hence $(gx - 1)/(gx - 1)^2$ is free of rank $1$ over $B_ g$. (This can also be seen by arguing that $gx - 1$ is a nonzerodivisor in $B[x]$ because it is a polynomial with invertible constant term and any nonzerodivisor gives a quasi-regular sequence of length $1$ by Lemma 10.69.2 [[\n  Lemma 10.69.2. Let $R$ be a ring. \n  \n  \nA regular sequence $f_1, \\ldots , f_ c$ of $R$ is a quasi-regular sequence. \n\n\nSuppose that $M$ is an $R$-module and that $f_1, \\ldots , f_ c$ is an $M$-regular sequence. Then $f_1, \\ldots , f_ c$ is an $M$-quasi-regular sequence. \n\n\n\n\n    \n]].) \n    \n      Let us prove $(I/I^2)_ g \\to J/J^2$ injective. Consider the $P$-algebra map \n    \n      \n  \\[  \\pi : P[x] \\to (P/I^2)_ f = P_ f/I_ f^2  \\]\n\n    \n       sending $x$ to $1/f$. Since $J$ is generated by $I$ and $fx - 1$ we see that $\\pi (J) \\subset (I/I^2)_ f = (I/I^2)_ g$. Since this is an ideal of square zero we see that $\\pi (J^2) = 0$. If $a \\in I$ maps to an element of $J^2$ in $J$, then $\\pi (a) = 0$, which implies that $a$ maps to zero in $I_ f/I_ f^2$. This proves the desired injectivity. \n    \n      Thus we have a short exact sequence of two term complexes \n    \n      \n  \\[  0 \\to \\mathop{N\\! L}\\nolimits (\\alpha ) \\otimes _ B B_ g \\to \\mathop{N\\! L}\\nolimits (\\beta ) \\to (B_ g \\xrightarrow {g} B_ g) \\to 0  \\]\n\n    \n       Such a short exact sequence can always be split in the category of complexes. In our particular case we can take as splittings \n    \n      \n  \\[  J/J^2 = (I/I^2)_ g \\oplus B_ g (fx - 1)\\quad \\text{and}\\quad \\Omega _{P[x]/A} \\otimes B_ g = \\Omega _{P/A} \\otimes B_ g \\oplus B_ g (g^{-2}\\text{d}f + \\text{d}x)  \\]\n\n    \n       This works because $\\text{d}(fx - 1) = x\\text{d}f + f \\text{d}x = g(g^{-2}\\text{d}f + \\text{d}x)$ in $\\Omega _{P[x]/A} \\otimes B_ g$. \n      $\\square$\n    \n"
268,0564,"lemma Module.FinitePresentation.of_finite_of_finitePresentation
    [Module.Finite R S] [Algebra.FinitePresentation R S] :
    Module.FinitePresentation R S := by
  classical
  obtain âŸ¨R', _, _, _, _, _, f, hfâŸ© := Module.Finite.exists_free_surjective R S
  letI := f.toRingHom.toAlgebra
  have : IsScalarTower R R' S := .of_algebraMap_eq' f.comp_algebraMap.symm
  have : Module.FinitePresentation R R' :=
    Module.finitePresentation_of_projective R R'
  have : Module.FinitePresentation R' S :=
    Module.finitePresentation_of_surjective (Algebra.linearMap R' S) hf
      (Algebra.FinitePresentation.ker_fG_of_surjective f hf)
  exact .trans R S R'
",Formal Proof of Stacks Project Tag 0564,The case M = S,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Finiteness/ModuleFinitePresentation.lean#L80-L92,Q27041,,10.36.23,lemma,3.0,"['00GH', '00AO', '0ELQ']","\n  Lemma 10.36.23. Let $R \\to S$ be a finite and finitely presented ring map. Let $M$ be an $S$-module. Then $M$ is finitely presented as an $R$-module if and only if $M$ is finitely presented as an $S$-module. \n\n    \n      Proof.\n      One of the implications follows from Lemma 10.6.4. To see the other assume that $M$ is finitely presented as an $S$-module. Pick a presentation \n    \n      \n  \\[  S^{\\oplus m} \\longrightarrow S^{\\oplus n} \\longrightarrow M \\longrightarrow 0  \\]\n\n    \n       As $S$ is finite as an $R$-module, the kernel of $S^{\\oplus n} \\to M$ is a finite $R$-module. Thus from Lemma 10.5.3 we see that it suffices to prove that $S$ is finitely presented as an $R$-module. \n    \n      Pick $y_1, \\ldots , y_ n \\in S$ such that $y_1, \\ldots , y_ n$ generate $S$ as an $R$-module. By Lemma 10.36.2 each $y_ i$ is integral over $R$. Choose monic polynomials $P_ i(x) \\in R[x]$ with $P_ i(y_ i) = 0$. Consider the ring \n    \n      \n  \\[  S\' = R[x_1, \\ldots , x_ n]/(P_1(x_1), \\ldots , P_ n(x_ n))  \\]\n\n    \n       Then we see that $S$ is of finite presentation as an $S\'$-algebra by Lemma 10.6.2. Since $S\' \\to S$ is surjective, the kernel $J = \\mathop{\\mathrm{Ker}}(S\' \\to S)$ is finitely generated as an ideal by Lemma 10.6.3. Hence $J$ is a finite $S\'$-module (immediate from the definitions). Thus $S = \\mathop{\\mathrm{Coker}}(J \\to S\')$ is of finite presentation as an $S\'$-module by Lemma 10.5.3. Hence, arguing as in the first paragraph, it suffices to show that $S\'$ is of finite presentation as an $R$-module. Actually, $S\'$ is free as an $R$-module with basis the monomials $x_1^{e_1} \\ldots x_ n^{e_ n}$ for $0 \\leq e_ i < \\deg (P_ i)$. Namely, write $R \\to S\'$ as the composition \n    \n      \n  \\[  R \\to R[x_1]/(P_1(x_1)) \\to R[x_1, x_2]/(P_1(x_1), P_2(x_2)) \\to \\ldots \\to S\'  \\]\n\n    \n       This shows that the $i$th ring in this sequence is free as a module over the $(i - 1)$st one with basis $1, x_ i, \\ldots , x_ i^{\\deg (P_ i) - 1}$. The result follows easily from this by induction. Some details omitted. \n      $\\square$\n    \n",\n  Lemma 10.36.23. Let $R \\to S$ be a finite and finitely presented ring map. Let $M$ be an $S$-module. Then $M$ is finitely presented as an $R$-module if and only if $M$ is finitely presented as an $S$-module. \n\n    \n,"Proof.\n      One of the implications follows from Lemma 10.6.4. To see the other assume that $M$ is finitely presented as an $S$-module. Pick a presentation \n    \n      \n  \\[  S^{\\oplus m} \\longrightarrow S^{\\oplus n} \\longrightarrow M \\longrightarrow 0  \\]\n\n    \n       As $S$ is finite as an $R$-module, the kernel of $S^{\\oplus n} \\to M$ is a finite $R$-module. Thus from Lemma 10.5.3 we see that it suffices to prove that $S$ is finitely presented as an $R$-module. \n    \n      Pick $y_1, \\ldots , y_ n \\in S$ such that $y_1, \\ldots , y_ n$ generate $S$ as an $R$-module. By Lemma 10.36.2 each $y_ i$ is integral over $R$. Choose monic polynomials $P_ i(x) \\in R[x]$ with $P_ i(y_ i) = 0$. Consider the ring \n    \n      \n  \\[  S\' = R[x_1, \\ldots , x_ n]/(P_1(x_1), \\ldots , P_ n(x_ n))  \\]\n\n    \n       Then we see that $S$ is of finite presentation as an $S\'$-algebra by Lemma 10.6.2. Since $S\' \\to S$ is surjective, the kernel $J = \\mathop{\\mathrm{Ker}}(S\' \\to S)$ is finitely generated as an ideal by Lemma 10.6.3. Hence $J$ is a finite $S\'$-module (immediate from the definitions). Thus $S = \\mathop{\\mathrm{Coker}}(J \\to S\')$ is of finite presentation as an $S\'$-module by Lemma 10.5.3. Hence, arguing as in the first paragraph, it suffices to show that $S\'$ is of finite presentation as an $R$-module. Actually, $S\'$ is free as an $R$-module with basis the monomials $x_1^{e_1} \\ldots x_ n^{e_ n}$ for $0 \\leq e_ i < \\deg (P_ i)$. Namely, write $R \\to S\'$ as the composition \n    \n      \n  \\[  R \\to R[x_1]/(P_1(x_1)) \\to R[x_1, x_2]/(P_1(x_1), P_2(x_2)) \\to \\ldots \\to S\'  \\]\n\n    \n       This shows that the $i$th ring in this sequence is free as a module over the $(i - 1)$st one with basis $1, x_ i, \\ldots , x_ i^{\\deg (P_ i) - 1}$. The result follows easily from this by induction. Some details omitted. \n      $\\square$\n    \n"," by
  classical
  obtain âŸ¨R', _, _, _, _, _, f, hfâŸ© := Module.Finite.exists_free_surjective R S
  letI := f.toRingHom.toAlgebra
  have : IsScalarTower R R' S := .of_algebraMap_eq' f.comp_algebraMap.symm
  have : Module.FinitePresentation R R' :=
    Module.finitePresentation_of_projective R R'
  have : Module.FinitePresentation R' S :=
    Module.finitePresentation_of_surjective (Algebra.linearMap R' S) hf
      (Algebra.FinitePresentation.ker_fG_of_surjective f hf)
  exact .trans R S R'
","lemma Module.FinitePresentation.of_finite_of_finitePresentation
    [Module.Finite R S] [Algebra.FinitePresentation R S] :
    Module.FinitePresentation R S ","Proof.\n      One of the implications follows from Lemma 10.6.4 [[\n  Lemma 10.6.4. Let $R \\to S$ be a ring map. Let $M$ be an $S$-module. Assume $R \\to S$ is of finite type and $M$ is finitely presented as an $R$-module. Then $M$ is finitely presented as an $S$-module. \n\n    \n]]. To see the other assume that $M$ is finitely presented as an $S$-module. Pick a presentation \n    \n      \n  \\[  S^{\\oplus m} \\longrightarrow S^{\\oplus n} \\longrightarrow M \\longrightarrow 0  \\]\n\n    \n       As $S$ is finite as an $R$-module, the kernel of $S^{\\oplus n} \\to M$ is a finite $R$-module. Thus from Lemma 10.5.3 [[\n  Lemma 10.5.3. Let $R$ be a ring. Let \n  \n  \\[  0 \\to M_1 \\to M_2 \\to M_3 \\to 0  \\]\n\n   be a short exact sequence of $R$-modules. \n  \n  \nIf $M_1$ and $M_3$ are finite $R$-modules, then $M_2$ is a finite $R$-module. \n\n\nIf $M_1$ and $M_3$ are finitely presented $R$-modules, then $M_2$ is a finitely presented $R$-module. \n\n\nIf $M_2$ is a finite $R$-module, then $M_3$ is a finite $R$-module. \n\n\nIf $M_2$ is a finitely presented $R$-module and $M_1$ is a finite $R$-module, then $M_3$ is a finitely presented $R$-module. \n\n\nIf $M_3$ is a finitely presented $R$-module and $M_2$ is a finite $R$-module, then $M_1$ is a finite $R$-module. \n\n\n\n\n    \n]] we see that it suffices to prove that $S$ is finitely presented as an $R$-module. \n    \n      Pick $y_1, \\ldots , y_ n \\in S$ such that $y_1, \\ldots , y_ n$ generate $S$ as an $R$-module. By Lemma 10.36.2 [[\n  Lemma 10.36.2. Let $\\varphi : R \\to S$ be a ring map. Let $y \\in S$. If there exists a finite $R$-submodule $M$ of $S$ such that $1 \\in M$ and $yM \\subset M$, then $y$ is integral over $R$. \n\n    \n]] each $y_ i$ is integral over $R$. Choose monic polynomials $P_ i(x) \\in R[x]$ with $P_ i(y_ i) = 0$. Consider the ring \n    \n      \n  \\[  S\' = R[x_1, \\ldots , x_ n]/(P_1(x_1), \\ldots , P_ n(x_ n))  \\]\n\n    \n       Then we see that $S$ is of finite presentation as an $S\'$-algebra by Lemma 10.6.2 [[\n  Lemma 10.6.2. The notions finite type and finite presentation have the following permanence properties. \n  \n  \nA composition of ring maps of finite type is of finite type. \n\n\nA composition of ring maps of finite presentation is of finite presentation. \n\n\nGiven $R \\to S\' \\to S$ with $R \\to S$ of finite type, then $S\' \\to S$ is of finite type. \n\n\nGiven $R \\to S\' \\to S$, with $R \\to S$ of finite presentation, and $R \\to S\'$ of finite type, then $S\' \\to S$ is of finite presentation. \n\n\n\n\n    \n]]. Since $S\' \\to S$ is surjective, the kernel $J = \\mathop{\\mathrm{Ker}}(S\' \\to S)$ is finitely generated as an ideal by Lemma 10.6.3 [[\n  Lemma 10.6.3. Let $R \\to S$ be a ring map of finite presentation. For any surjection $\\alpha : R[x_1, \\ldots , x_ n] \\to S$ the kernel of $\\alpha $ is a finitely generated ideal in $R[x_1, \\ldots , x_ n]$. \n\n    \n]]. Hence $J$ is a finite $S\'$-module (immediate from the definitions). Thus $S = \\mathop{\\mathrm{Coker}}(J \\to S\')$ is of finite presentation as an $S\'$-module by Lemma 10.5.3 [[\n  Lemma 10.5.3. Let $R$ be a ring. Let \n  \n  \\[  0 \\to M_1 \\to M_2 \\to M_3 \\to 0  \\]\n\n   be a short exact sequence of $R$-modules. \n  \n  \nIf $M_1$ and $M_3$ are finite $R$-modules, then $M_2$ is a finite $R$-module. \n\n\nIf $M_1$ and $M_3$ are finitely presented $R$-modules, then $M_2$ is a finitely presented $R$-module. \n\n\nIf $M_2$ is a finite $R$-module, then $M_3$ is a finite $R$-module. \n\n\nIf $M_2$ is a finitely presented $R$-module and $M_1$ is a finite $R$-module, then $M_3$ is a finitely presented $R$-module. \n\n\nIf $M_3$ is a finitely presented $R$-module and $M_2$ is a finite $R$-module, then $M_1$ is a finite $R$-module. \n\n\n\n\n    \n]]. Hence, arguing as in the first paragraph, it suffices to show that $S\'$ is of finite presentation as an $R$-module. Actually, $S\'$ is free as an $R$-module with basis the monomials $x_1^{e_1} \\ldots x_ n^{e_ n}$ for $0 \\leq e_ i < \\deg (P_ i)$. Namely, write $R \\to S\'$ as the composition \n    \n      \n  \\[  R \\to R[x_1]/(P_1(x_1)) \\to R[x_1, x_2]/(P_1(x_1), P_2(x_2)) \\to \\ldots \\to S\'  \\]\n\n    \n       This shows that the $i$th ring in this sequence is free as a module over the $(i - 1)$st one with basis $1, x_ i, \\ldots , x_ i^{\\deg (P_ i) - 1}$. The result follows easily from this by induction. Some details omitted. \n      $\\square$\n    \n"
269,00DV,"theorem exists_sub_one_mem_and_smul_eq_zero_of_fg_of_le_smul {R : Type*} [CommRing R] {M : Type*}
    [AddCommGroup M] [Module R M] (I : Ideal R) (N : Submodule R M) (hn : N.FG) (hin : N â‰¤ I â€¢ N) :
    âˆƒ r : R, r - 1 âˆˆ I âˆ§ âˆ€ n âˆˆ N, r â€¢ n = (0 : M) := by
  rw [fg_def] at hn
  rcases hn with âŸ¨s, hfs, hsâŸ©
  have H : âˆƒ r : R, r - 1 âˆˆ I âˆ§ N â‰¤ (I â€¢ span R s).comap (LinearMap.lsmul R M r) âˆ§ s âŠ† N := by
    refine âŸ¨1, ?_, ?_, ?_âŸ©
    Â· rw [sub_self]
      exact I.zero_mem
    Â· rw [hs]
      intro n hn
      rw [mem_comap]
      change (1 : R) â€¢ n âˆˆ I â€¢ N
      rw [one_smul]
      exact hin hn
    Â· rw [â† span_le, hs]
  clear hin hs
  induction s, hfs using Set.Finite.induction_on with
  | empty =>
    rcases H with âŸ¨r, hr1, hrn, _âŸ©
    refine âŸ¨r, hr1, fun n hn => ?_âŸ©
    specialize hrn hn
    rwa [mem_comap, span_empty, smul_bot, mem_bot] at hrn
  | @insert i s _ _ ih =>
  apply ih
  rcases H with âŸ¨r, hr1, hrn, hsâŸ©
  rw [â† Set.singleton_union, span_union, smul_sup] at hrn
  rw [Set.insert_subset_iff] at hs
  have : âˆƒ c : R, c - 1 âˆˆ I âˆ§ c â€¢ i âˆˆ I â€¢ span R s := by
    specialize hrn hs.1
    rw [mem_comap, mem_sup] at hrn
    rcases hrn with âŸ¨y, hy, z, hz, hyzâŸ©
    dsimp at hyz
    rw [mem_smul_span_singleton] at hy
    rcases hy with âŸ¨c, hci, rflâŸ©
    use r - c
    constructor
    Â· rw [sub_right_comm]
      exact I.sub_mem hr1 hci
    Â· rw [sub_smul, â† hyz, add_sub_cancel_left]
      exact hz
  rcases this with âŸ¨c, hc1, hciâŸ©
  refine âŸ¨c * r, ?_, ?_, hs.2âŸ©
  Â· simpa only [mul_sub, mul_one, sub_add_sub_cancel] using I.add_mem (I.mul_mem_left c hr1) hc1
  Â· intro n hn
    specialize hrn hn
    rw [mem_comap, mem_sup] at hrn
    rcases hrn with âŸ¨y, hy, z, hz, hyzâŸ©
    dsimp at hyz
    rw [mem_smul_span_singleton] at hy
    rcases hy with âŸ¨d, _, rflâŸ©
    simp only [mem_comap, LinearMap.lsmul_apply]
    rw [mul_smul, â† hyz, smul_add, smul_smul, mul_comm, mul_smul]
    exact add_mem (smul_mem _ _ hci) (smul_mem _ _ hz)
",Formal Proof of Stacks Project Tag 00DV,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Finiteness/Nakayama.lean#L28-L81,Q27041,Nakayama's lemma,10.20.1,lemma,3.0,"['07RC', '00AO', '0ELQ']","\n        \n      \n      \n  Lemma 10.20.1 (Nakayama\'s lemma). Let $R$ be a ring with Jacobson radical $\\text{rad}(R)$. Let $M$ be an $R$-module. Let $I \\subset R$ be an ideal. \n  \n  \n If $IM = M$ and $M$ is finite, then there exists an $f \\in 1 + I$ such that $fM = 0$. \n\n\nIf $IM = M$, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $M = 0$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, and $N\'$ is finite, then there exists an $f \\in 1 + I$ such that $fM \\subset N$ and $M_ f = N_ f$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, $N\'$ is finite, and $I \\subset \\text{rad}(R)$, then $M = N$. \n\n\nIf $N \\to M$ is a module map, $N/IN \\to M/IM$ is surjective, and $M$ is finite, then there exists an $f \\in 1 + I$ such that $N_ f \\to M_ f$ is surjective. \n\n\nIf $N \\to M$ is a module map, $N/IN \\to M/IM$ is surjective, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $N \\to M$ is surjective. \n\n\nIf $x_1, \\ldots , x_ n \\in M$ generate $M/IM$ and $M$ is finite, then there exists an $f \\in 1 + I$ such that $x_1, \\ldots , x_ n$ generate $M_ f$ over $R_ f$. \n\n\nIf $x_1, \\ldots , x_ n \\in M$ generate $M/IM$, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $M$ is generated by $x_1, \\ldots , x_ n$. \n\n\nIf $IM = M$, $I$ is nilpotent, then $M = 0$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, and $I$ is nilpotent then $M = N$. \n\n\nIf $N \\to M$ is a module map, $I$ is nilpotent, and $N/IN \\to M/IM$ is surjective, then $N \\to M$ is surjective. \n\n\nIf $\\{ x_\\alpha \\} _{\\alpha \\in A}$ is a set of elements of $M$ which generate $M/IM$ and $I$ is nilpotent, then $M$ is generated by the $x_\\alpha $. \n\n\n\n\n    \n      Proof.\n      Proof of (1). Choose generators $y_1, \\ldots , y_ m$ of $M$ over $R$. For each $i$ we can write $y_ i = \\sum z_{ij} y_ j$ with $z_{ij} \\in I$ (since $M = IM$). In other words $\\sum _ j (\\delta _{ij} - z_{ij})y_ j = 0$. Let $f$ be the determinant of the $m \\times m$ matrix $A = (\\delta _{ij} - z_{ij})$. Note that $f \\in 1 + I$ (since the matrix $A$ is entrywise congruent to the $m \\times m$ identity matrix modulo $I$). By Lemma 10.15.5 (1), there exists an $m \\times m$ matrix $B$ such that $BA = f 1_{m \\times m}$. Writing out we see that $\\sum _{i} b_{hi} a_{ij} = f \\delta _{hj}$ for all $h$ and $j$; hence, $\\sum _{i, j} b_{hi} a_{ij} y_ j = \\sum _{j} f \\delta _{hj} y_ j = f y_ h$ for every $h$. In other words, $0 = f y_ h$ for every $h$ (since each $i$ satisfies $\\sum _ j a_{ij} y_ j = 0$). This implies that $f$ annihilates $M$. \n    \n      By Lemma 10.19.1 an element of $1 + \\text{rad}(R)$ is invertible element of $R$. Hence we see that (1) implies (2). We obtain (3) by applying (1) to $M/N$ which is finite as $N\'$ is finite. We obtain (4) by applying (2) to $M/N$ which is finite as $N\'$ is finite. We obtain (5) by applying (3) to $M$ and the submodules $\\mathop{\\mathrm{Im}}(N \\to M)$ and $M$. We obtain (6) by applying (4) to $M$ and the submodules $\\mathop{\\mathrm{Im}}(N \\to M)$ and $M$. We obtain (7) by applying (5) to the map $R^{\\oplus n} \\to M$, $(a_1, \\ldots , a_ n) \\mapsto a_1x_1 + \\ldots + a_ nx_ n$. We obtain (8) by applying (6) to the map $R^{\\oplus n} \\to M$, $(a_1, \\ldots , a_ n) \\mapsto a_1x_1 + \\ldots + a_ nx_ n$. \n    \n      Part (9) holds because if $M = IM$ then $M = I^ nM$ for all $n \\geq 0$ and $I$ being nilpotent means $I^ n = 0$ for some $n \\gg 0$. Parts (10), (11), and (12) follow from (9) by the arguments used above. \n      $\\square$\n    \n","\n        \n      \n      \n  Lemma 10.20.1 (Nakayama\'s lemma). Let $R$ be a ring with Jacobson radical $\\text{rad}(R)$. Let $M$ be an $R$-module. Let $I \\subset R$ be an ideal. \n  \n  \n If $IM = M$ and $M$ is finite, then there exists an $f \\in 1 + I$ such that $fM = 0$. \n\n\nIf $IM = M$, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $M = 0$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, and $N\'$ is finite, then there exists an $f \\in 1 + I$ such that $fM \\subset N$ and $M_ f = N_ f$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, $N\'$ is finite, and $I \\subset \\text{rad}(R)$, then $M = N$. \n\n\nIf $N \\to M$ is a module map, $N/IN \\to M/IM$ is surjective, and $M$ is finite, then there exists an $f \\in 1 + I$ such that $N_ f \\to M_ f$ is surjective. \n\n\nIf $N \\to M$ is a module map, $N/IN \\to M/IM$ is surjective, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $N \\to M$ is surjective. \n\n\nIf $x_1, \\ldots , x_ n \\in M$ generate $M/IM$ and $M$ is finite, then there exists an $f \\in 1 + I$ such that $x_1, \\ldots , x_ n$ generate $M_ f$ over $R_ f$. \n\n\nIf $x_1, \\ldots , x_ n \\in M$ generate $M/IM$, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $M$ is generated by $x_1, \\ldots , x_ n$. \n\n\nIf $IM = M$, $I$ is nilpotent, then $M = 0$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, and $I$ is nilpotent then $M = N$. \n\n\nIf $N \\to M$ is a module map, $I$ is nilpotent, and $N/IN \\to M/IM$ is surjective, then $N \\to M$ is surjective. \n\n\nIf $\\{ x_\\alpha \\} _{\\alpha \\in A}$ is a set of elements of $M$ which generate $M/IM$ and $I$ is nilpotent, then $M$ is generated by the $x_\\alpha $. \n\n\n\n\n    \n","Proof.\n      Proof of (1). Choose generators $y_1, \\ldots , y_ m$ of $M$ over $R$. For each $i$ we can write $y_ i = \\sum z_{ij} y_ j$ with $z_{ij} \\in I$ (since $M = IM$). In other words $\\sum _ j (\\delta _{ij} - z_{ij})y_ j = 0$. Let $f$ be the determinant of the $m \\times m$ matrix $A = (\\delta _{ij} - z_{ij})$. Note that $f \\in 1 + I$ (since the matrix $A$ is entrywise congruent to the $m \\times m$ identity matrix modulo $I$). By Lemma 10.15.5 (1), there exists an $m \\times m$ matrix $B$ such that $BA = f 1_{m \\times m}$. Writing out we see that $\\sum _{i} b_{hi} a_{ij} = f \\delta _{hj}$ for all $h$ and $j$; hence, $\\sum _{i, j} b_{hi} a_{ij} y_ j = \\sum _{j} f \\delta _{hj} y_ j = f y_ h$ for every $h$. In other words, $0 = f y_ h$ for every $h$ (since each $i$ satisfies $\\sum _ j a_{ij} y_ j = 0$). This implies that $f$ annihilates $M$. \n    \n      By Lemma 10.19.1 an element of $1 + \\text{rad}(R)$ is invertible element of $R$. Hence we see that (1) implies (2). We obtain (3) by applying (1) to $M/N$ which is finite as $N\'$ is finite. We obtain (4) by applying (2) to $M/N$ which is finite as $N\'$ is finite. We obtain (5) by applying (3) to $M$ and the submodules $\\mathop{\\mathrm{Im}}(N \\to M)$ and $M$. We obtain (6) by applying (4) to $M$ and the submodules $\\mathop{\\mathrm{Im}}(N \\to M)$ and $M$. We obtain (7) by applying (5) to the map $R^{\\oplus n} \\to M$, $(a_1, \\ldots , a_ n) \\mapsto a_1x_1 + \\ldots + a_ nx_ n$. We obtain (8) by applying (6) to the map $R^{\\oplus n} \\to M$, $(a_1, \\ldots , a_ n) \\mapsto a_1x_1 + \\ldots + a_ nx_ n$. \n    \n      Part (9) holds because if $M = IM$ then $M = I^ nM$ for all $n \\geq 0$ and $I$ being nilpotent means $I^ n = 0$ for some $n \\gg 0$. Parts (10), (11), and (12) follow from (9) by the arguments used above. \n      $\\square$\n    \n"," by
  rw [fg_def] at hn
  rcases hn with âŸ¨s, hfs, hsâŸ©
  have H : âˆƒ r : R, r - 1 âˆˆ I âˆ§ N â‰¤ (I â€¢ span R s).comap (LinearMap.lsmul R M r) âˆ§ s âŠ† N := by
    refine âŸ¨1, ?_, ?_, ?_âŸ©
    Â· rw [sub_self]
      exact I.zero_mem
    Â· rw [hs]
      intro n hn
      rw [mem_comap]
      change (1 : R) â€¢ n âˆˆ I â€¢ N
      rw [one_smul]
      exact hin hn
    Â· rw [â† span_le, hs]
  clear hin hs
  induction s, hfs using Set.Finite.induction_on with
  | empty =>
    rcases H with âŸ¨r, hr1, hrn, _âŸ©
    refine âŸ¨r, hr1, fun n hn => ?_âŸ©
    specialize hrn hn
    rwa [mem_comap, span_empty, smul_bot, mem_bot] at hrn
  | @insert i s _ _ ih =>
  apply ih
  rcases H with âŸ¨r, hr1, hrn, hsâŸ©
  rw [â† Set.singleton_union, span_union, smul_sup] at hrn
  rw [Set.insert_subset_iff] at hs
  have : âˆƒ c : R, c - 1 âˆˆ I âˆ§ c â€¢ i âˆˆ I â€¢ span R s := by
    specialize hrn hs.1
    rw [mem_comap, mem_sup] at hrn
    rcases hrn with âŸ¨y, hy, z, hz, hyzâŸ©
    dsimp at hyz
    rw [mem_smul_span_singleton] at hy
    rcases hy with âŸ¨c, hci, rflâŸ©
    use r - c
    constructor
    Â· rw [sub_right_comm]
      exact I.sub_mem hr1 hci
    Â· rw [sub_smul, â† hyz, add_sub_cancel_left]
      exact hz
  rcases this with âŸ¨c, hc1, hciâŸ©
  refine âŸ¨c * r, ?_, ?_, hs.2âŸ©
  Â· simpa only [mul_sub, mul_one, sub_add_sub_cancel] using I.add_mem (I.mul_mem_left c hr1) hc1
  Â· intro n hn
    specialize hrn hn
    rw [mem_comap, mem_sup] at hrn
    rcases hrn with âŸ¨y, hy, z, hz, hyzâŸ©
    dsimp at hyz
    rw [mem_smul_span_singleton] at hy
    rcases hy with âŸ¨d, _, rflâŸ©
    simp only [mem_comap, LinearMap.lsmul_apply]
    rw [mul_smul, â† hyz, smul_add, smul_smul, mul_comm, mul_smul]
    exact add_mem (smul_mem _ _ hci) (smul_mem _ _ hz)
","theorem exists_sub_one_mem_and_smul_eq_zero_of_fg_of_le_smul {R : Type*} [CommRing R] {M : Type*}
    [AddCommGroup M] [Module R M] (I : Ideal R) (N : Submodule R M) (hn : N.FG) (hin : N â‰¤ I â€¢ N) :
    âˆƒ r : R, r - 1 âˆˆ I âˆ§ âˆ€ n âˆˆ N, r â€¢ n = (0 : M) ","Proof.\n      Proof of (1). Choose generators $y_1, \\ldots , y_ m$ of $M$ over $R$. For each $i$ we can write $y_ i = \\sum z_{ij} y_ j$ with $z_{ij} \\in I$ (since $M = IM$). In other words $\\sum _ j (\\delta _{ij} - z_{ij})y_ j = 0$. Let $f$ be the determinant of the $m \\times m$ matrix $A = (\\delta _{ij} - z_{ij})$. Note that $f \\in 1 + I$ (since the matrix $A$ is entrywise congruent to the $m \\times m$ identity matrix modulo $I$). By Lemma 10.15.5 [[\n  Lemma 10.15.5. Let $R$ be a ring. Let $n \\geq m$. Let $A$ be an $n \\times m$ matrix with coefficients in $R$. Let $J \\subset R$ be the ideal generated by the $m \\times m$ minors of $A$. \n  \n  \nFor any $f \\in J$ there exists a $m \\times n$ matrix $B$ such that $BA = f 1_{m \\times m}$. \n\n\nIf $f \\in R$ and $BA = f 1_{m \\times m}$ for some $m \\times n$ matrix $B$, then $f^ m \\in J$. \n\n\n\n\n    \n]] (1), there exists an $m \\times m$ matrix $B$ such that $BA = f 1_{m \\times m}$. Writing out we see that $\\sum _{i} b_{hi} a_{ij} = f \\delta _{hj}$ for all $h$ and $j$; hence, $\\sum _{i, j} b_{hi} a_{ij} y_ j = \\sum _{j} f \\delta _{hj} y_ j = f y_ h$ for every $h$. In other words, $0 = f y_ h$ for every $h$ (since each $i$ satisfies $\\sum _ j a_{ij} y_ j = 0$). This implies that $f$ annihilates $M$. \n    \n      By Lemma 10.19.1 [[\n  Lemma 10.19.1. Let $R$ be a ring with Jacobson radical $\\text{rad}(R)$. Let $I \\subset R$ be an ideal. The following are equivalent \n  \n  \n$I \\subset \\text{rad}(R)$, and \n\n\nevery element of $1 + I$ is a unit in $R$. \n\n\n\n   In this case every element of $R$ which maps to a unit of $R/I$ is a unit. \n\n    \n]] an element of $1 + \\text{rad}(R)$ is invertible element of $R$. Hence we see that (1) implies (2). We obtain (3) by applying (1) to $M/N$ which is finite as $N\'$ is finite. We obtain (4) by applying (2) to $M/N$ which is finite as $N\'$ is finite. We obtain (5) by applying (3) to $M$ and the submodules $\\mathop{\\mathrm{Im}}(N \\to M)$ and $M$. We obtain (6) by applying (4) to $M$ and the submodules $\\mathop{\\mathrm{Im}}(N \\to M)$ and $M$. We obtain (7) by applying (5) to the map $R^{\\oplus n} \\to M$, $(a_1, \\ldots , a_ n) \\mapsto a_1x_1 + \\ldots + a_ nx_ n$. We obtain (8) by applying (6) to the map $R^{\\oplus n} \\to M$, $(a_1, \\ldots , a_ n) \\mapsto a_1x_1 + \\ldots + a_ nx_ n$. \n    \n      Part (9) holds because if $M = IM$ then $M = I^ nM$ for all $n \\geq 0$ and $I$ being nilpotent means $I^ n = 0$ for some $n \\gg 0$. Parts (10), (11), and (12) follow from (9) by the arguments used above. \n      $\\square$\n    \n"
270,00HK,"theorem tfae_equational_criterion : List.TFAE [
    Flat R M,
    âˆ€ I : Ideal R, Function.Injective (rTensor M I.subtype),
    âˆ€ {l : â„•} {f : Fin l â†’ R} {x : Fin l â†’ M}, âˆ‘ i, f i âŠ—â‚œ x i = (0 : R âŠ—[R] M) â†’
      VanishesTrivially R f x,
    âˆ€ {l : â„•} {f : Fin l â†’ R} {x : Fin l â†’ M}, âˆ‘ i, f i â€¢ x i = 0 â†’ IsTrivialRelation f x,
    âˆ€ {l : â„•} {f : Fin l â†’â‚€ R} {x : (Fin l â†’â‚€ R) â†’â‚—[R] M}, x f = 0 â†’
      âˆƒ (k : â„•) (a : (Fin l â†’â‚€ R) â†’â‚—[R] (Fin k â†’â‚€ R)) (y : (Fin k â†’â‚€ R) â†’â‚—[R] M),
        x = y âˆ˜â‚— a âˆ§ a f = 0] := by
  classical
  tfae_have 1 â†” 2 := iff_rTensor_injective'
  tfae_have 3 â†” 2 := forall_vanishesTrivially_iff_forall_rTensor_injective R
  tfae_have 3 â†” 4 := by
    simp [(TensorProduct.lid R M).injective.eq_iff.symm, isTrivialRelation_iff_vanishesTrivially]
  tfae_have 4 â†’ 5
  | hâ‚„, l, f, x, hfx => by
    let f' : Fin l â†’ R := f
    let x' : Fin l â†’ M := fun i â†¦ x (single i 1)
    have := calc
      âˆ‘ i, f' i â€¢ x' i
      _ = âˆ‘ i, f i â€¢ x (single i 1) := rfl
      _ = x (âˆ‘ i, f i â€¢ Finsupp.single i 1) := by simp_rw [map_sum, map_smul]
      _ = x f := by simp_rw [smul_single, smul_eq_mul, mul_one, univ_sum_single]
      _ = 0 := hfx
    obtain âŸ¨k, a', y', âŸ¨ha'y', ha'âŸ©âŸ© := hâ‚„ this
    use k
    use Finsupp.linearCombination R (fun i â†¦ equivFunOnFinite.symm (a' i))
    use Finsupp.linearCombination R y'
    constructor
    Â· apply Finsupp.basisSingleOne.ext
      intro i
      simpa [linearCombination_apply, sum_fintype, Finsupp.single_apply] using ha'y' i
    Â· ext j
      simp only [linearCombination_apply, zero_smul, implies_true, sum_fintype, finset_sum_apply]
      exact ha' j
  tfae_have 5 â†’ 4
  | hâ‚…, l, f, x, hfx => by
    let f' : Fin l â†’â‚€ R := equivFunOnFinite.symm f
    let x' : (Fin l â†’â‚€ R) â†’â‚—[R] M := Finsupp.linearCombination R x
    have : x' f' = 0 := by simpa [x', f', linearCombination_apply, sum_fintype] using hfx
    obtain âŸ¨k, a', y', ha'y', ha'âŸ© := hâ‚… this
    refine âŸ¨k, fun i â†¦ a' (single i 1), fun j â†¦ y' (single j 1), fun i â†¦ ?_, fun j â†¦ ?_âŸ©
    Â· simpa [x', â† map_smul, â† map_sum, smul_single] using
        LinearMap.congr_fun ha'y' (Finsupp.single i 1)
    Â· simp_rw [â† smul_eq_mul, â† Finsupp.smul_apply, â† map_smul, â† finset_sum_apply, â† map_sum,
        smul_single, smul_eq_mul, mul_one,
        â† (fun _ â†¦ equivFunOnFinite_symm_apply_apply _ _ : âˆ€ x, f' x = f x), univ_sum_single]
      simpa using DFunLike.congr_fun ha' j
  tfae_finish
",Formal Proof of Stacks Project Tag 00HK, stacks 058D (1) â†” (2),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Flat/EquationalCriterion.lean#L117-L165,Q27041,Equational criterion of flatness,10.39.11,lemma,3.0,"['00H9', '00AO', '0ELQ']","\n  Lemma 10.39.11 (Equational criterion of flatness).  A module $M$ over $R$ is flat if and only if every relation in $M$ is trivial. \n\n    \n      Proof.\n      Assume $M$ is flat and let $\\sum f_ i x_ i = 0$ be a relation in $M$. Let $I = (f_1, \\ldots , f_ n)$, and let $K = \\mathop{\\mathrm{Ker}}(R^ n \\to I, (a_1, \\ldots , a_ n) \\mapsto \\sum _ i a_ i f_ i)$. So we have the short exact sequence $0 \\to K \\to R^ n \\to I \\to 0$. Then $\\sum f_ i \\otimes x_ i$ is an element of $I \\otimes _ R M$ which maps to zero in $R \\otimes _ R M = M$. By flatness $\\sum f_ i \\otimes x_ i$ is zero in $I \\otimes _ R M$. Thus there exists an element of $K \\otimes _ R M$ mapping to $\\sum e_ i \\otimes x_ i \\in R^ n \\otimes _ R M$ where $e_ i$ is the $i$th basis element of $R^ n$. Write this element as $\\sum k_ j \\otimes y_ j$ and then write the image of $k_ j$ in $R^ n$ as $\\sum a_{ij} e_ i$ to get the result. \n    \n      Assume every relation is trivial, let $I$ be a finitely generated ideal, and let $x = \\sum f_ i \\otimes x_ i$ be an element of $I \\otimes _ R M$ mapping to zero in $R \\otimes _ R M = M$. This just means exactly that $\\sum f_ i x_ i$ is a relation in $M$. And the fact that it is trivial implies easily that $x$ is zero, because \n    \n      \n  \\[  x = \\sum f_ i \\otimes x_ i = \\sum f_ i \\otimes \\left(\\sum a_{ij}y_ j\\right) = \\sum \\left(\\sum f_ i a_{ij}\\right) \\otimes y_ j = 0  \\]\n\n      $\\square$\n    \n",\n  Lemma 10.39.11 (Equational criterion of flatness).  A module $M$ over $R$ is flat if and only if every relation in $M$ is trivial. \n\n    \n,"Proof.\n      Assume $M$ is flat and let $\\sum f_ i x_ i = 0$ be a relation in $M$. Let $I = (f_1, \\ldots , f_ n)$, and let $K = \\mathop{\\mathrm{Ker}}(R^ n \\to I, (a_1, \\ldots , a_ n) \\mapsto \\sum _ i a_ i f_ i)$. So we have the short exact sequence $0 \\to K \\to R^ n \\to I \\to 0$. Then $\\sum f_ i \\otimes x_ i$ is an element of $I \\otimes _ R M$ which maps to zero in $R \\otimes _ R M = M$. By flatness $\\sum f_ i \\otimes x_ i$ is zero in $I \\otimes _ R M$. Thus there exists an element of $K \\otimes _ R M$ mapping to $\\sum e_ i \\otimes x_ i \\in R^ n \\otimes _ R M$ where $e_ i$ is the $i$th basis element of $R^ n$. Write this element as $\\sum k_ j \\otimes y_ j$ and then write the image of $k_ j$ in $R^ n$ as $\\sum a_{ij} e_ i$ to get the result. \n    \n      Assume every relation is trivial, let $I$ be a finitely generated ideal, and let $x = \\sum f_ i \\otimes x_ i$ be an element of $I \\otimes _ R M$ mapping to zero in $R \\otimes _ R M = M$. This just means exactly that $\\sum f_ i x_ i$ is a relation in $M$. And the fact that it is trivial implies easily that $x$ is zero, because \n    \n      \n  \\[  x = \\sum f_ i \\otimes x_ i = \\sum f_ i \\otimes \\left(\\sum a_{ij}y_ j\\right) = \\sum \\left(\\sum f_ i a_{ij}\\right) \\otimes y_ j = 0  \\]\n\n      $\\square$\n    \n"," by
  classical
  tfae_have 1 â†” 2 := iff_rTensor_injective'
  tfae_have 3 â†” 2 := forall_vanishesTrivially_iff_forall_rTensor_injective R
  tfae_have 3 â†” 4 := by
    simp [(TensorProduct.lid R M).injective.eq_iff.symm, isTrivialRelation_iff_vanishesTrivially]
  tfae_have 4 â†’ 5
  | hâ‚„, l, f, x, hfx => by
    let f' : Fin l â†’ R := f
    let x' : Fin l â†’ M := fun i â†¦ x (single i 1)
    have := calc
      âˆ‘ i, f' i â€¢ x' i
      _ = âˆ‘ i, f i â€¢ x (single i 1) := rfl
      _ = x (âˆ‘ i, f i â€¢ Finsupp.single i 1) := by simp_rw [map_sum, map_smul]
      _ = x f := by simp_rw [smul_single, smul_eq_mul, mul_one, univ_sum_single]
      _ = 0 := hfx
    obtain âŸ¨k, a', y', âŸ¨ha'y', ha'âŸ©âŸ© := hâ‚„ this
    use k
    use Finsupp.linearCombination R (fun i â†¦ equivFunOnFinite.symm (a' i))
    use Finsupp.linearCombination R y'
    constructor
    Â· apply Finsupp.basisSingleOne.ext
      intro i
      simpa [linearCombination_apply, sum_fintype, Finsupp.single_apply] using ha'y' i
    Â· ext j
      simp only [linearCombination_apply, zero_smul, implies_true, sum_fintype, finset_sum_apply]
      exact ha' j
  tfae_have 5 â†’ 4
  | hâ‚…, l, f, x, hfx => by
    let f' : Fin l â†’â‚€ R := equivFunOnFinite.symm f
    let x' : (Fin l â†’â‚€ R) â†’â‚—[R] M := Finsupp.linearCombination R x
    have : x' f' = 0 := by simpa [x', f', linearCombination_apply, sum_fintype] using hfx
    obtain âŸ¨k, a', y', ha'y', ha'âŸ© := hâ‚… this
    refine âŸ¨k, fun i â†¦ a' (single i 1), fun j â†¦ y' (single j 1), fun i â†¦ ?_, fun j â†¦ ?_âŸ©
    Â· simpa [x', â† map_smul, â† map_sum, smul_single] using
        LinearMap.congr_fun ha'y' (Finsupp.single i 1)
    Â· simp_rw [â† smul_eq_mul, â† Finsupp.smul_apply, â† map_smul, â† finset_sum_apply, â† map_sum,
        smul_single, smul_eq_mul, mul_one,
        â† (fun _ â†¦ equivFunOnFinite_symm_apply_apply _ _ : âˆ€ x, f' x = f x), univ_sum_single]
      simpa using DFunLike.congr_fun ha' j
  tfae_finish
","theorem tfae_equational_criterion : List.TFAE [
    Flat R M,
    âˆ€ I : Ideal R, Function.Injective (rTensor M I.subtype),
    âˆ€ {l : â„•} {f : Fin l â†’ R} {x : Fin l â†’ M}, âˆ‘ i, f i âŠ—â‚œ x i = (0 : R âŠ—[R] M) â†’
      VanishesTrivially R f x,
    âˆ€ {l : â„•} {f : Fin l â†’ R} {x : Fin l â†’ M}, âˆ‘ i, f i â€¢ x i = 0 â†’ IsTrivialRelation f x,
    âˆ€ {l : â„•} {f : Fin l â†’â‚€ R} {x : (Fin l â†’â‚€ R) â†’â‚—[R] M}, x f = 0 â†’
      âˆƒ (k : â„•) (a : (Fin l â†’â‚€ R) â†’â‚—[R] (Fin k â†’â‚€ R)) (y : (Fin k â†’â‚€ R) â†’â‚—[R] M),
        x = y âˆ˜â‚— a âˆ§ a f = 0] ","Proof.\n      Assume $M$ is flat and let $\\sum f_ i x_ i = 0$ be a relation in $M$. Let $I = (f_1, \\ldots , f_ n)$, and let $K = \\mathop{\\mathrm{Ker}}(R^ n \\to I, (a_1, \\ldots , a_ n) \\mapsto \\sum _ i a_ i f_ i)$. So we have the short exact sequence $0 \\to K \\to R^ n \\to I \\to 0$. Then $\\sum f_ i \\otimes x_ i$ is an element of $I \\otimes _ R M$ which maps to zero in $R \\otimes _ R M = M$. By flatness $\\sum f_ i \\otimes x_ i$ is zero in $I \\otimes _ R M$. Thus there exists an element of $K \\otimes _ R M$ mapping to $\\sum e_ i \\otimes x_ i \\in R^ n \\otimes _ R M$ where $e_ i$ is the $i$th basis element of $R^ n$. Write this element as $\\sum k_ j \\otimes y_ j$ and then write the image of $k_ j$ in $R^ n$ as $\\sum a_{ij} e_ i$ to get the result. \n    \n      Assume every relation is trivial, let $I$ be a finitely generated ideal, and let $x = \\sum f_ i \\otimes x_ i$ be an element of $I \\otimes _ R M$ mapping to zero in $R \\otimes _ R M = M$. This just means exactly that $\\sum f_ i x_ i$ is a relation in $M$. And the fact that it is trivial implies easily that $x$ is zero, because \n    \n      \n  \\[  x = \\sum f_ i \\otimes x_ i = \\sum f_ i \\otimes \\left(\\sum a_{ij}y_ j\\right) = \\sum \\left(\\sum f_ i a_{ij}\\right) \\otimes y_ j = 0  \\]\n\n      $\\square$\n    \n"
271,00HK,"theorem of_forall_isTrivialRelation (hfx : âˆ€ {l : â„•} {f : Fin l â†’ R} {x : Fin l â†’ M},
    âˆ‘ i, f i â€¢ x i = 0 â†’ IsTrivialRelation f x) : Flat R M :=
  iff_forall_isTrivialRelation.mpr hfx
",Formal Proof of Stacks Project Tag 00HK,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Flat/EquationalCriterion.lean#L187-L189,Q27041,Equational criterion of flatness,10.39.11,lemma,3.0,"['00H9', '00AO', '0ELQ']","\n  Lemma 10.39.11 (Equational criterion of flatness).  A module $M$ over $R$ is flat if and only if every relation in $M$ is trivial. \n\n    \n      Proof.\n      Assume $M$ is flat and let $\\sum f_ i x_ i = 0$ be a relation in $M$. Let $I = (f_1, \\ldots , f_ n)$, and let $K = \\mathop{\\mathrm{Ker}}(R^ n \\to I, (a_1, \\ldots , a_ n) \\mapsto \\sum _ i a_ i f_ i)$. So we have the short exact sequence $0 \\to K \\to R^ n \\to I \\to 0$. Then $\\sum f_ i \\otimes x_ i$ is an element of $I \\otimes _ R M$ which maps to zero in $R \\otimes _ R M = M$. By flatness $\\sum f_ i \\otimes x_ i$ is zero in $I \\otimes _ R M$. Thus there exists an element of $K \\otimes _ R M$ mapping to $\\sum e_ i \\otimes x_ i \\in R^ n \\otimes _ R M$ where $e_ i$ is the $i$th basis element of $R^ n$. Write this element as $\\sum k_ j \\otimes y_ j$ and then write the image of $k_ j$ in $R^ n$ as $\\sum a_{ij} e_ i$ to get the result. \n    \n      Assume every relation is trivial, let $I$ be a finitely generated ideal, and let $x = \\sum f_ i \\otimes x_ i$ be an element of $I \\otimes _ R M$ mapping to zero in $R \\otimes _ R M = M$. This just means exactly that $\\sum f_ i x_ i$ is a relation in $M$. And the fact that it is trivial implies easily that $x$ is zero, because \n    \n      \n  \\[  x = \\sum f_ i \\otimes x_ i = \\sum f_ i \\otimes \\left(\\sum a_{ij}y_ j\\right) = \\sum \\left(\\sum f_ i a_{ij}\\right) \\otimes y_ j = 0  \\]\n\n      $\\square$\n    \n",\n  Lemma 10.39.11 (Equational criterion of flatness).  A module $M$ over $R$ is flat if and only if every relation in $M$ is trivial. \n\n    \n,"Proof.\n      Assume $M$ is flat and let $\\sum f_ i x_ i = 0$ be a relation in $M$. Let $I = (f_1, \\ldots , f_ n)$, and let $K = \\mathop{\\mathrm{Ker}}(R^ n \\to I, (a_1, \\ldots , a_ n) \\mapsto \\sum _ i a_ i f_ i)$. So we have the short exact sequence $0 \\to K \\to R^ n \\to I \\to 0$. Then $\\sum f_ i \\otimes x_ i$ is an element of $I \\otimes _ R M$ which maps to zero in $R \\otimes _ R M = M$. By flatness $\\sum f_ i \\otimes x_ i$ is zero in $I \\otimes _ R M$. Thus there exists an element of $K \\otimes _ R M$ mapping to $\\sum e_ i \\otimes x_ i \\in R^ n \\otimes _ R M$ where $e_ i$ is the $i$th basis element of $R^ n$. Write this element as $\\sum k_ j \\otimes y_ j$ and then write the image of $k_ j$ in $R^ n$ as $\\sum a_{ij} e_ i$ to get the result. \n    \n      Assume every relation is trivial, let $I$ be a finitely generated ideal, and let $x = \\sum f_ i \\otimes x_ i$ be an element of $I \\otimes _ R M$ mapping to zero in $R \\otimes _ R M = M$. This just means exactly that $\\sum f_ i x_ i$ is a relation in $M$. And the fact that it is trivial implies easily that $x$ is zero, because \n    \n      \n  \\[  x = \\sum f_ i \\otimes x_ i = \\sum f_ i \\otimes \\left(\\sum a_{ij}y_ j\\right) = \\sum \\left(\\sum f_ i a_{ij}\\right) \\otimes y_ j = 0  \\]\n\n      $\\square$\n    \n","
  iff_forall_isTrivialRelation.mpr hfx
","theorem of_forall_isTrivialRelation (hfx : âˆ€ {l : â„•} {f : Fin l â†’ R} {x : Fin l â†’ M},
    âˆ‘ i, f i â€¢ x i = 0 â†’ IsTrivialRelation f x) : Flat R M ","Proof.\n      Assume $M$ is flat and let $\\sum f_ i x_ i = 0$ be a relation in $M$. Let $I = (f_1, \\ldots , f_ n)$, and let $K = \\mathop{\\mathrm{Ker}}(R^ n \\to I, (a_1, \\ldots , a_ n) \\mapsto \\sum _ i a_ i f_ i)$. So we have the short exact sequence $0 \\to K \\to R^ n \\to I \\to 0$. Then $\\sum f_ i \\otimes x_ i$ is an element of $I \\otimes _ R M$ which maps to zero in $R \\otimes _ R M = M$. By flatness $\\sum f_ i \\otimes x_ i$ is zero in $I \\otimes _ R M$. Thus there exists an element of $K \\otimes _ R M$ mapping to $\\sum e_ i \\otimes x_ i \\in R^ n \\otimes _ R M$ where $e_ i$ is the $i$th basis element of $R^ n$. Write this element as $\\sum k_ j \\otimes y_ j$ and then write the image of $k_ j$ in $R^ n$ as $\\sum a_{ij} e_ i$ to get the result. \n    \n      Assume every relation is trivial, let $I$ be a finitely generated ideal, and let $x = \\sum f_ i \\otimes x_ i$ be an element of $I \\otimes _ R M$ mapping to zero in $R \\otimes _ R M = M$. This just means exactly that $\\sum f_ i x_ i$ is a relation in $M$. And the fact that it is trivial implies easily that $x$ is zero, because \n    \n      \n  \\[  x = \\sum f_ i \\otimes x_ i = \\sum f_ i \\otimes \\left(\\sum a_{ij}y_ j\\right) = \\sum \\left(\\sum f_ i a_{ij}\\right) \\otimes y_ j = 0  \\]\n\n      $\\square$\n    \n"
272,058D,"theorem iff_forall_exists_factorization : Flat R M â†”
    âˆ€ {l : â„•} {f : Fin l â†’â‚€ R} {x : (Fin l â†’â‚€ R) â†’â‚—[R] M}, x f = 0 â†’
      âˆƒ (k : â„•) (a : (Fin l â†’â‚€ R) â†’â‚—[R] (Fin k â†’â‚€ R)) (y : (Fin k â†’â‚€ R) â†’â‚—[R] M),
        x = y âˆ˜â‚— a âˆ§ a f = 0 := (tfae_equational_criterion R M).out 0 4
",Formal Proof of Stacks Project Tag 058D,(1) â†” (2),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Flat/EquationalCriterion.lean#L198-L201,Q27041,,10.81.1,lemma,3.0,"['058C', '00AO', '0ELQ']","\n  Lemma 10.81.1. Let $M$ be an $R$-module. The following are equivalent: \n  \n  \n$M$ is flat. \n\n\nIf $f: R^ n \\to M$ is a module map and $x \\in \\mathop{\\mathrm{Ker}}(f)$, then there are module maps $h: R^ n \\to R^ m$ and $g: R^ m \\to M$ such that $f = g \\circ h$ and $x \\in \\mathop{\\mathrm{Ker}}(h)$. \n\n\nSuppose $f: R^ n \\to M$ is a module map, $N \\subset \\mathop{\\mathrm{Ker}}(f)$ any submodule, and $h: R^ n \\to R^{m}$ a map such that $N \\subset \\mathop{\\mathrm{Ker}}(h)$ and $f$ factors through $h$. Then given any $x \\in \\mathop{\\mathrm{Ker}}(f)$ we can find a map $h\': R^ n \\to R^{m\'}$ such that $N + Rx \\subset \\mathop{\\mathrm{Ker}}(h\')$ and $f$ factors through $h\'$. \n\n\nIf $f: R^ n \\to M$ is a module map and $N \\subset \\mathop{\\mathrm{Ker}}(f)$ is a finitely generated submodule, then there are module maps $h: R^ n \\to R^ m$ and $g: R^ m \\to M$ such that $f = g \\circ h$ and $N \\subset \\mathop{\\mathrm{Ker}}(h)$. \n\n\n\n\n    \n      Proof.\n      That (1) is equivalent to (2) is just a reformulation of the equational criterion for flatness1. To show (2) implies (3), let $g: R^ m \\to M$ be the map such that $f$ factors as $f = g \\circ h$. By (2) find $h\'\': R^ m \\to R^{m\'}$ such that $h\'\'$ kills $h(x)$ and $g: R^ m \\to M$ factors through $h\'\'$. Then taking $h\' = h\'\' \\circ h$ works. (3) implies (4) by induction on the number of generators of $N \\subset \\mathop{\\mathrm{Ker}}(f)$ in (4). Clearly (4) implies (2). \n      $\\square$\n    \n","\n  Lemma 10.81.1. Let $M$ be an $R$-module. The following are equivalent: \n  \n  \n$M$ is flat. \n\n\nIf $f: R^ n \\to M$ is a module map and $x \\in \\mathop{\\mathrm{Ker}}(f)$, then there are module maps $h: R^ n \\to R^ m$ and $g: R^ m \\to M$ such that $f = g \\circ h$ and $x \\in \\mathop{\\mathrm{Ker}}(h)$. \n\n\nSuppose $f: R^ n \\to M$ is a module map, $N \\subset \\mathop{\\mathrm{Ker}}(f)$ any submodule, and $h: R^ n \\to R^{m}$ a map such that $N \\subset \\mathop{\\mathrm{Ker}}(h)$ and $f$ factors through $h$. Then given any $x \\in \\mathop{\\mathrm{Ker}}(f)$ we can find a map $h\': R^ n \\to R^{m\'}$ such that $N + Rx \\subset \\mathop{\\mathrm{Ker}}(h\')$ and $f$ factors through $h\'$. \n\n\nIf $f: R^ n \\to M$ is a module map and $N \\subset \\mathop{\\mathrm{Ker}}(f)$ is a finitely generated submodule, then there are module maps $h: R^ n \\to R^ m$ and $g: R^ m \\to M$ such that $f = g \\circ h$ and $N \\subset \\mathop{\\mathrm{Ker}}(h)$. \n\n\n\n\n    \n","Proof.\n      That (1) is equivalent to (2) is just a reformulation of the equational criterion for flatness1. To show (2) implies (3), let $g: R^ m \\to M$ be the map such that $f$ factors as $f = g \\circ h$. By (2) find $h\'\': R^ m \\to R^{m\'}$ such that $h\'\'$ kills $h(x)$ and $g: R^ m \\to M$ factors through $h\'\'$. Then taking $h\' = h\'\' \\circ h$ works. (3) implies (4) by induction on the number of generators of $N \\subset \\mathop{\\mathrm{Ker}}(f)$ in (4). Clearly (4) implies (2). \n      $\\square$\n    \n"," (tfae_equational_criterion R M).out 0 4
","theorem iff_forall_exists_factorization : Flat R M â†”
    âˆ€ {l : â„•} {f : Fin l â†’â‚€ R} {x : (Fin l â†’â‚€ R) â†’â‚—[R] M}, x f = 0 â†’
      âˆƒ (k : â„•) (a : (Fin l â†’â‚€ R) â†’â‚—[R] (Fin k â†’â‚€ R)) (y : (Fin k â†’â‚€ R) â†’â‚—[R] M),
        x = y âˆ˜â‚— a âˆ§ a f = 0 ","Proof.\n      That (1) is equivalent to (2) is just a reformulation of the equational criterion for flatness1. To show (2) implies (3), let $g: R^ m \\to M$ be the map such that $f$ factors as $f = g \\circ h$. By (2) find $h\'\': R^ m \\to R^{m\'}$ such that $h\'\'$ kills $h(x)$ and $g: R^ m \\to M$ factors through $h\'\'$. Then taking $h\' = h\'\' \\circ h$ works. (3) implies (4) by induction on the number of generators of $N \\subset \\mathop{\\mathrm{Ker}}(f)$ in (4). Clearly (4) implies (2). \n      $\\square$\n    \n"
273,058D,"theorem of_forall_exists_factorization
    (h : âˆ€ {l : â„•} {f : Fin l â†’â‚€ R} {x : (Fin l â†’â‚€ R) â†’â‚—[R] M}, x f = 0 â†’
      âˆƒ (k : â„•) (a : (Fin l â†’â‚€ R) â†’â‚—[R] (Fin k â†’â‚€ R)) (y : (Fin k â†’â‚€ R) â†’â‚—[R] M),
      x = y âˆ˜â‚— a âˆ§ a f = 0) : Flat R M := iff_forall_exists_factorization.mpr h
",Formal Proof of Stacks Project Tag 058D,(2) â†’ (1),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Flat/EquationalCriterion.lean#L210-L213,Q27041,,10.81.1,lemma,3.0,"['058C', '00AO', '0ELQ']","\n  Lemma 10.81.1. Let $M$ be an $R$-module. The following are equivalent: \n  \n  \n$M$ is flat. \n\n\nIf $f: R^ n \\to M$ is a module map and $x \\in \\mathop{\\mathrm{Ker}}(f)$, then there are module maps $h: R^ n \\to R^ m$ and $g: R^ m \\to M$ such that $f = g \\circ h$ and $x \\in \\mathop{\\mathrm{Ker}}(h)$. \n\n\nSuppose $f: R^ n \\to M$ is a module map, $N \\subset \\mathop{\\mathrm{Ker}}(f)$ any submodule, and $h: R^ n \\to R^{m}$ a map such that $N \\subset \\mathop{\\mathrm{Ker}}(h)$ and $f$ factors through $h$. Then given any $x \\in \\mathop{\\mathrm{Ker}}(f)$ we can find a map $h\': R^ n \\to R^{m\'}$ such that $N + Rx \\subset \\mathop{\\mathrm{Ker}}(h\')$ and $f$ factors through $h\'$. \n\n\nIf $f: R^ n \\to M$ is a module map and $N \\subset \\mathop{\\mathrm{Ker}}(f)$ is a finitely generated submodule, then there are module maps $h: R^ n \\to R^ m$ and $g: R^ m \\to M$ such that $f = g \\circ h$ and $N \\subset \\mathop{\\mathrm{Ker}}(h)$. \n\n\n\n\n    \n      Proof.\n      That (1) is equivalent to (2) is just a reformulation of the equational criterion for flatness1. To show (2) implies (3), let $g: R^ m \\to M$ be the map such that $f$ factors as $f = g \\circ h$. By (2) find $h\'\': R^ m \\to R^{m\'}$ such that $h\'\'$ kills $h(x)$ and $g: R^ m \\to M$ factors through $h\'\'$. Then taking $h\' = h\'\' \\circ h$ works. (3) implies (4) by induction on the number of generators of $N \\subset \\mathop{\\mathrm{Ker}}(f)$ in (4). Clearly (4) implies (2). \n      $\\square$\n    \n","\n  Lemma 10.81.1. Let $M$ be an $R$-module. The following are equivalent: \n  \n  \n$M$ is flat. \n\n\nIf $f: R^ n \\to M$ is a module map and $x \\in \\mathop{\\mathrm{Ker}}(f)$, then there are module maps $h: R^ n \\to R^ m$ and $g: R^ m \\to M$ such that $f = g \\circ h$ and $x \\in \\mathop{\\mathrm{Ker}}(h)$. \n\n\nSuppose $f: R^ n \\to M$ is a module map, $N \\subset \\mathop{\\mathrm{Ker}}(f)$ any submodule, and $h: R^ n \\to R^{m}$ a map such that $N \\subset \\mathop{\\mathrm{Ker}}(h)$ and $f$ factors through $h$. Then given any $x \\in \\mathop{\\mathrm{Ker}}(f)$ we can find a map $h\': R^ n \\to R^{m\'}$ such that $N + Rx \\subset \\mathop{\\mathrm{Ker}}(h\')$ and $f$ factors through $h\'$. \n\n\nIf $f: R^ n \\to M$ is a module map and $N \\subset \\mathop{\\mathrm{Ker}}(f)$ is a finitely generated submodule, then there are module maps $h: R^ n \\to R^ m$ and $g: R^ m \\to M$ such that $f = g \\circ h$ and $N \\subset \\mathop{\\mathrm{Ker}}(h)$. \n\n\n\n\n    \n","Proof.\n      That (1) is equivalent to (2) is just a reformulation of the equational criterion for flatness1. To show (2) implies (3), let $g: R^ m \\to M$ be the map such that $f$ factors as $f = g \\circ h$. By (2) find $h\'\': R^ m \\to R^{m\'}$ such that $h\'\'$ kills $h(x)$ and $g: R^ m \\to M$ factors through $h\'\'$. Then taking $h\' = h\'\' \\circ h$ works. (3) implies (4) by induction on the number of generators of $N \\subset \\mathop{\\mathrm{Ker}}(f)$ in (4). Clearly (4) implies (2). \n      $\\square$\n    \n"," iff_forall_exists_factorization.mpr h
","theorem of_forall_exists_factorization
    (h : âˆ€ {l : â„•} {f : Fin l â†’â‚€ R} {x : (Fin l â†’â‚€ R) â†’â‚—[R] M}, x f = 0 â†’
      âˆƒ (k : â„•) (a : (Fin l â†’â‚€ R) â†’â‚—[R] (Fin k â†’â‚€ R)) (y : (Fin k â†’â‚€ R) â†’â‚—[R] M),
      x = y âˆ˜â‚— a âˆ§ a f = 0) : Flat R M ","Proof.\n      That (1) is equivalent to (2) is just a reformulation of the equational criterion for flatness1. To show (2) implies (3), let $g: R^ m \\to M$ be the map such that $f$ factors as $f = g \\circ h$. By (2) find $h\'\': R^ m \\to R^{m\'}$ such that $h\'\'$ kills $h(x)$ and $g: R^ m \\to M$ factors through $h\'\'$. Then taking $h\' = h\'\' \\circ h$ works. (3) implies (4) by induction on the number of generators of $N \\subset \\mathop{\\mathrm{Ker}}(f)$ in (4). Clearly (4) implies (2). \n      $\\square$\n    \n"
274,058D,"theorem exists_factorization_of_apply_eq_zero_of_free [Flat R M] {N : Type*} [AddCommGroup N]
    [Module R N] [Free R N] [Module.Finite R N] {f : N} {x : N â†’â‚—[R] M} (h : x f = 0) :
    âˆƒ (k : â„•) (a : N â†’â‚—[R] (Fin k â†’â‚€ R)) (y : (Fin k â†’â‚€ R) â†’â‚—[R] M), x = y âˆ˜â‚— a âˆ§ a f = 0 :=
  have e := ((Module.Free.chooseBasis R N).reindex (Fintype.equivFin _)).repr.symm
  have âŸ¨k, a, y, hya, hafâŸ© := iff_forall_exists_factorization.mp â€¹Flat R Mâ€º
    (f := e.symm f) (x := x âˆ˜â‚— e) (by simpa using h)
  âŸ¨k, a âˆ˜â‚— e.symm, y, by rwa [â† comp_assoc, LinearEquiv.eq_comp_toLinearMap_symm], hafâŸ©
",Formal Proof of Stacks Project Tag 058D,(1) â†’ (2),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Flat/EquationalCriterion.lean#L222-L228,Q27041,,10.81.1,lemma,3.0,"['058C', '00AO', '0ELQ']","\n  Lemma 10.81.1. Let $M$ be an $R$-module. The following are equivalent: \n  \n  \n$M$ is flat. \n\n\nIf $f: R^ n \\to M$ is a module map and $x \\in \\mathop{\\mathrm{Ker}}(f)$, then there are module maps $h: R^ n \\to R^ m$ and $g: R^ m \\to M$ such that $f = g \\circ h$ and $x \\in \\mathop{\\mathrm{Ker}}(h)$. \n\n\nSuppose $f: R^ n \\to M$ is a module map, $N \\subset \\mathop{\\mathrm{Ker}}(f)$ any submodule, and $h: R^ n \\to R^{m}$ a map such that $N \\subset \\mathop{\\mathrm{Ker}}(h)$ and $f$ factors through $h$. Then given any $x \\in \\mathop{\\mathrm{Ker}}(f)$ we can find a map $h\': R^ n \\to R^{m\'}$ such that $N + Rx \\subset \\mathop{\\mathrm{Ker}}(h\')$ and $f$ factors through $h\'$. \n\n\nIf $f: R^ n \\to M$ is a module map and $N \\subset \\mathop{\\mathrm{Ker}}(f)$ is a finitely generated submodule, then there are module maps $h: R^ n \\to R^ m$ and $g: R^ m \\to M$ such that $f = g \\circ h$ and $N \\subset \\mathop{\\mathrm{Ker}}(h)$. \n\n\n\n\n    \n      Proof.\n      That (1) is equivalent to (2) is just a reformulation of the equational criterion for flatness1. To show (2) implies (3), let $g: R^ m \\to M$ be the map such that $f$ factors as $f = g \\circ h$. By (2) find $h\'\': R^ m \\to R^{m\'}$ such that $h\'\'$ kills $h(x)$ and $g: R^ m \\to M$ factors through $h\'\'$. Then taking $h\' = h\'\' \\circ h$ works. (3) implies (4) by induction on the number of generators of $N \\subset \\mathop{\\mathrm{Ker}}(f)$ in (4). Clearly (4) implies (2). \n      $\\square$\n    \n","\n  Lemma 10.81.1. Let $M$ be an $R$-module. The following are equivalent: \n  \n  \n$M$ is flat. \n\n\nIf $f: R^ n \\to M$ is a module map and $x \\in \\mathop{\\mathrm{Ker}}(f)$, then there are module maps $h: R^ n \\to R^ m$ and $g: R^ m \\to M$ such that $f = g \\circ h$ and $x \\in \\mathop{\\mathrm{Ker}}(h)$. \n\n\nSuppose $f: R^ n \\to M$ is a module map, $N \\subset \\mathop{\\mathrm{Ker}}(f)$ any submodule, and $h: R^ n \\to R^{m}$ a map such that $N \\subset \\mathop{\\mathrm{Ker}}(h)$ and $f$ factors through $h$. Then given any $x \\in \\mathop{\\mathrm{Ker}}(f)$ we can find a map $h\': R^ n \\to R^{m\'}$ such that $N + Rx \\subset \\mathop{\\mathrm{Ker}}(h\')$ and $f$ factors through $h\'$. \n\n\nIf $f: R^ n \\to M$ is a module map and $N \\subset \\mathop{\\mathrm{Ker}}(f)$ is a finitely generated submodule, then there are module maps $h: R^ n \\to R^ m$ and $g: R^ m \\to M$ such that $f = g \\circ h$ and $N \\subset \\mathop{\\mathrm{Ker}}(h)$. \n\n\n\n\n    \n","Proof.\n      That (1) is equivalent to (2) is just a reformulation of the equational criterion for flatness1. To show (2) implies (3), let $g: R^ m \\to M$ be the map such that $f$ factors as $f = g \\circ h$. By (2) find $h\'\': R^ m \\to R^{m\'}$ such that $h\'\'$ kills $h(x)$ and $g: R^ m \\to M$ factors through $h\'\'$. Then taking $h\' = h\'\' \\circ h$ works. (3) implies (4) by induction on the number of generators of $N \\subset \\mathop{\\mathrm{Ker}}(f)$ in (4). Clearly (4) implies (2). \n      $\\square$\n    \n","
  have e := ((Module.Free.chooseBasis R N).reindex (Fintype.equivFin _)).repr.symm
  have âŸ¨k, a, y, hya, hafâŸ© := iff_forall_exists_factorization.mp â€¹Flat R Mâ€º
    (f := e.symm f) (x := x âˆ˜â‚— e) (by simpa using h)
  âŸ¨k, a âˆ˜â‚— e.symm, y, by rwa [â† comp_assoc, LinearEquiv.eq_comp_toLinearMap_symm], hafâŸ©
","theorem exists_factorization_of_apply_eq_zero_of_free [Flat R M] {N : Type*} [AddCommGroup N]
    [Module R N] [Free R N] [Module.Finite R N] {f : N} {x : N â†’â‚—[R] M} (h : x f = 0) :
    âˆƒ (k : â„•) (a : N â†’â‚—[R] (Fin k â†’â‚€ R)) (y : (Fin k â†’â‚€ R) â†’â‚—[R] M), x = y âˆ˜â‚— a âˆ§ a f = 0 ","Proof.\n      That (1) is equivalent to (2) is just a reformulation of the equational criterion for flatness1. To show (2) implies (3), let $g: R^ m \\to M$ be the map such that $f$ factors as $f = g \\circ h$. By (2) find $h\'\': R^ m \\to R^{m\'}$ such that $h\'\'$ kills $h(x)$ and $g: R^ m \\to M$ factors through $h\'\'$. Then taking $h\' = h\'\' \\circ h$ works. (3) implies (4) by induction on the number of generators of $N \\subset \\mathop{\\mathrm{Ker}}(f)$ in (4). Clearly (4) implies (2). \n      $\\square$\n    \n"
275,058D,"theorem exists_factorization_of_comp_eq_zero_of_free [Flat R M] {K N : Type*} [AddCommGroup K]
    [Module R K] [Module.Finite R K] [AddCommGroup N] [Module R N] [Free R N] [Module.Finite R N]
    {f : K â†’â‚—[R] N} {x : N â†’â‚—[R] M} (h : x âˆ˜â‚— f = 0) :
    âˆƒ (k : â„•) (a : N â†’â‚—[R] (Fin k â†’â‚€ R)) (y : (Fin k â†’â‚€ R) â†’â‚—[R] M),
      x = y âˆ˜â‚— a âˆ§ a âˆ˜â‚— f = 0 :=
  have e := ((Module.Free.chooseBasis R N).reindex (Fintype.equivFin _)).repr.symm
  have âŸ¨k, a, y, hya, hafâŸ© := exists_factorization_of_comp_eq_zero_of_free_aux
    (f := e.symm âˆ˜â‚— f) (x := x âˆ˜â‚— e.toLinearMap) (by ext; simpa [comp_assoc] using congr($h _))
  âŸ¨k, a âˆ˜â‚— e.symm, y, by rwa [â† comp_assoc, LinearEquiv.eq_comp_toLinearMap_symm], by
    rwa [comp_assoc]âŸ©
",Formal Proof of Stacks Project Tag 058D,(1) â†’ (4),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Flat/EquationalCriterion.lean#L258-L267,Q27041,,10.81.1,lemma,3.0,"['058C', '00AO', '0ELQ']","\n  Lemma 10.81.1. Let $M$ be an $R$-module. The following are equivalent: \n  \n  \n$M$ is flat. \n\n\nIf $f: R^ n \\to M$ is a module map and $x \\in \\mathop{\\mathrm{Ker}}(f)$, then there are module maps $h: R^ n \\to R^ m$ and $g: R^ m \\to M$ such that $f = g \\circ h$ and $x \\in \\mathop{\\mathrm{Ker}}(h)$. \n\n\nSuppose $f: R^ n \\to M$ is a module map, $N \\subset \\mathop{\\mathrm{Ker}}(f)$ any submodule, and $h: R^ n \\to R^{m}$ a map such that $N \\subset \\mathop{\\mathrm{Ker}}(h)$ and $f$ factors through $h$. Then given any $x \\in \\mathop{\\mathrm{Ker}}(f)$ we can find a map $h\': R^ n \\to R^{m\'}$ such that $N + Rx \\subset \\mathop{\\mathrm{Ker}}(h\')$ and $f$ factors through $h\'$. \n\n\nIf $f: R^ n \\to M$ is a module map and $N \\subset \\mathop{\\mathrm{Ker}}(f)$ is a finitely generated submodule, then there are module maps $h: R^ n \\to R^ m$ and $g: R^ m \\to M$ such that $f = g \\circ h$ and $N \\subset \\mathop{\\mathrm{Ker}}(h)$. \n\n\n\n\n    \n      Proof.\n      That (1) is equivalent to (2) is just a reformulation of the equational criterion for flatness1. To show (2) implies (3), let $g: R^ m \\to M$ be the map such that $f$ factors as $f = g \\circ h$. By (2) find $h\'\': R^ m \\to R^{m\'}$ such that $h\'\'$ kills $h(x)$ and $g: R^ m \\to M$ factors through $h\'\'$. Then taking $h\' = h\'\' \\circ h$ works. (3) implies (4) by induction on the number of generators of $N \\subset \\mathop{\\mathrm{Ker}}(f)$ in (4). Clearly (4) implies (2). \n      $\\square$\n    \n","\n  Lemma 10.81.1. Let $M$ be an $R$-module. The following are equivalent: \n  \n  \n$M$ is flat. \n\n\nIf $f: R^ n \\to M$ is a module map and $x \\in \\mathop{\\mathrm{Ker}}(f)$, then there are module maps $h: R^ n \\to R^ m$ and $g: R^ m \\to M$ such that $f = g \\circ h$ and $x \\in \\mathop{\\mathrm{Ker}}(h)$. \n\n\nSuppose $f: R^ n \\to M$ is a module map, $N \\subset \\mathop{\\mathrm{Ker}}(f)$ any submodule, and $h: R^ n \\to R^{m}$ a map such that $N \\subset \\mathop{\\mathrm{Ker}}(h)$ and $f$ factors through $h$. Then given any $x \\in \\mathop{\\mathrm{Ker}}(f)$ we can find a map $h\': R^ n \\to R^{m\'}$ such that $N + Rx \\subset \\mathop{\\mathrm{Ker}}(h\')$ and $f$ factors through $h\'$. \n\n\nIf $f: R^ n \\to M$ is a module map and $N \\subset \\mathop{\\mathrm{Ker}}(f)$ is a finitely generated submodule, then there are module maps $h: R^ n \\to R^ m$ and $g: R^ m \\to M$ such that $f = g \\circ h$ and $N \\subset \\mathop{\\mathrm{Ker}}(h)$. \n\n\n\n\n    \n","Proof.\n      That (1) is equivalent to (2) is just a reformulation of the equational criterion for flatness1. To show (2) implies (3), let $g: R^ m \\to M$ be the map such that $f$ factors as $f = g \\circ h$. By (2) find $h\'\': R^ m \\to R^{m\'}$ such that $h\'\'$ kills $h(x)$ and $g: R^ m \\to M$ factors through $h\'\'$. Then taking $h\' = h\'\' \\circ h$ works. (3) implies (4) by induction on the number of generators of $N \\subset \\mathop{\\mathrm{Ker}}(f)$ in (4). Clearly (4) implies (2). \n      $\\square$\n    \n","
  have e := ((Module.Free.chooseBasis R N).reindex (Fintype.equivFin _)).repr.symm
  have âŸ¨k, a, y, hya, hafâŸ© := exists_factorization_of_comp_eq_zero_of_free_aux
    (f := e.symm âˆ˜â‚— f) (x := x âˆ˜â‚— e.toLinearMap) (by ext; simpa [comp_assoc] using congr($h _))
  âŸ¨k, a âˆ˜â‚— e.symm, y, by rwa [â† comp_assoc, LinearEquiv.eq_comp_toLinearMap_symm], by
    rwa [comp_assoc]âŸ©
","theorem exists_factorization_of_comp_eq_zero_of_free [Flat R M] {K N : Type*} [AddCommGroup K]
    [Module R K] [Module.Finite R K] [AddCommGroup N] [Module R N] [Free R N] [Module.Finite R N]
    {f : K â†’â‚—[R] N} {x : N â†’â‚—[R] M} (h : x âˆ˜â‚— f = 0) :
    âˆƒ (k : â„•) (a : N â†’â‚—[R] (Fin k â†’â‚€ R)) (y : (Fin k â†’â‚€ R) â†’â‚—[R] M),
      x = y âˆ˜â‚— a âˆ§ a âˆ˜â‚— f = 0 ","Proof.\n      That (1) is equivalent to (2) is just a reformulation of the equational criterion for flatness1. To show (2) implies (3), let $g: R^ m \\to M$ be the map such that $f$ factors as $f = g \\circ h$. By (2) find $h\'\': R^ m \\to R^{m\'}$ such that $h\'\'$ kills $h(x)$ and $g: R^ m \\to M$ factors through $h\'\'$. Then taking $h\' = h\'\' \\circ h$ works. (3) implies (4) by induction on the number of generators of $N \\subset \\mathop{\\mathrm{Ker}}(f)$ in (4). Clearly (4) implies (2). \n      $\\square$\n    \n"
276,058E,"theorem exists_factorization_of_isFinitelyPresented [Flat R M] {P : Type*} [AddCommGroup P]
    [Module R P] [FinitePresentation R P] (hâ‚ : P â†’â‚—[R] M) :
      âˆƒ (k : â„•) (hâ‚‚ : P â†’â‚—[R] (Fin k â†’â‚€ R)) (hâ‚ƒ : (Fin k â†’â‚€ R) â†’â‚—[R] M), hâ‚ = hâ‚ƒ âˆ˜â‚— hâ‚‚ := by
  have âŸ¨_, K, Ï•, hKâŸ© := FinitePresentation.exists_fin R P
  haveI : Module.Finite R K := .of_fg hK
  have : (hâ‚ âˆ˜â‚— Ï•.symm âˆ˜â‚— K.mkQ) âˆ˜â‚— K.subtype = 0 := by
    simp_rw [comp_assoc, (LinearMap.exact_subtype_mkQ K).linearMap_comp_eq_zero, comp_zero]
  obtain âŸ¨k, a, y, hay, haâŸ© := exists_factorization_of_comp_eq_zero_of_free this
  use k, (K.liftQ a (by rwa [â† range_le_ker_iff, Submodule.range_subtype] at ha)) âˆ˜â‚— Ï•, y
  apply (cancel_right Ï•.symm.surjective).mp
  apply (cancel_right K.mkQ_surjective).mp
  simpa [comp_assoc]
",Formal Proof of Stacks Project Tag 058E,only if,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Flat/EquationalCriterion.lean#L272-L283,Q27041,,10.81.2,lemma,3.0,"['058C', '00AO', '0ELQ']","\n  Lemma 10.81.2. Let $M$ be an $R$-module. Then $M$ is flat if and only if the following condition holds: if $P$ is a finitely presented $R$-module and $f: P \\to M$ a module map, then there is a free finite $R$-module $F$ and module maps $h: P \\to F$ and $g: F \\to M$ such that $f = g \\circ h$. \n\n    \n      Proof.\n      This is just a reformulation of condition (4) from Lemma 10.81.1. \n      $\\square$\n    \n","\n  Lemma 10.81.2. Let $M$ be an $R$-module. Then $M$ is flat if and only if the following condition holds: if $P$ is a finitely presented $R$-module and $f: P \\to M$ a module map, then there is a free finite $R$-module $F$ and module maps $h: P \\to F$ and $g: F \\to M$ such that $f = g \\circ h$. \n\n    \n",Proof.\n      This is just a reformulation of condition (4) from Lemma 10.81.1. \n      $\\square$\n    \n," by
  have âŸ¨_, K, Ï•, hKâŸ© := FinitePresentation.exists_fin R P
  haveI : Module.Finite R K := .of_fg hK
  have : (hâ‚ âˆ˜â‚— Ï•.symm âˆ˜â‚— K.mkQ) âˆ˜â‚— K.subtype = 0 := by
    simp_rw [comp_assoc, (LinearMap.exact_subtype_mkQ K).linearMap_comp_eq_zero, comp_zero]
  obtain âŸ¨k, a, y, hay, haâŸ© := exists_factorization_of_comp_eq_zero_of_free this
  use k, (K.liftQ a (by rwa [â† range_le_ker_iff, Submodule.range_subtype] at ha)) âˆ˜â‚— Ï•, y
  apply (cancel_right Ï•.symm.surjective).mp
  apply (cancel_right K.mkQ_surjective).mp
  simpa [comp_assoc]
","theorem exists_factorization_of_isFinitelyPresented [Flat R M] {P : Type*} [AddCommGroup P]
    [Module R P] [FinitePresentation R P] (hâ‚ : P â†’â‚—[R] M) :
      âˆƒ (k : â„•) (hâ‚‚ : P â†’â‚—[R] (Fin k â†’â‚€ R)) (hâ‚ƒ : (Fin k â†’â‚€ R) â†’â‚—[R] M), hâ‚ = hâ‚ƒ âˆ˜â‚— hâ‚‚ ","Proof.\n      This is just a reformulation of condition (4) from Lemma 10.81.1 [[\n  Lemma 10.81.1. Let $M$ be an $R$-module. The following are equivalent: \n  \n  \n$M$ is flat. \n\n\nIf $f: R^ n \\to M$ is a module map and $x \\in \\mathop{\\mathrm{Ker}}(f)$, then there are module maps $h: R^ n \\to R^ m$ and $g: R^ m \\to M$ such that $f = g \\circ h$ and $x \\in \\mathop{\\mathrm{Ker}}(h)$. \n\n\nSuppose $f: R^ n \\to M$ is a module map, $N \\subset \\mathop{\\mathrm{Ker}}(f)$ any submodule, and $h: R^ n \\to R^{m}$ a map such that $N \\subset \\mathop{\\mathrm{Ker}}(h)$ and $f$ factors through $h$. Then given any $x \\in \\mathop{\\mathrm{Ker}}(f)$ we can find a map $h\': R^ n \\to R^{m\'}$ such that $N + Rx \\subset \\mathop{\\mathrm{Ker}}(h\')$ and $f$ factors through $h\'$. \n\n\nIf $f: R^ n \\to M$ is a module map and $N \\subset \\mathop{\\mathrm{Ker}}(f)$ is a finitely generated submodule, then there are module maps $h: R^ n \\to R^ m$ and $g: R^ m \\to M$ such that $f = g \\circ h$ and $N \\subset \\mathop{\\mathrm{Ker}}(h)$. \n\n\n\n\n    \n]]. \n      $\\square$\n    \n"
277,00NX,"theorem projective_of_finitePresentation [Flat R M] [FinitePresentation R M] : Projective R M :=
  have âŸ¨_, f, g, eqâŸ© := exists_factorization_of_isFinitelyPresented (.id (R := R) (M := M))
  .of_split f g eq.symm
",Formal Proof of Stacks Project Tag 00NX,(1) â†’ (2),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Flat/EquationalCriterion.lean#L286-L288,Q27041,,10.78.2,lemma,3.0,"['00NV', '00AO', '0ELQ']","\n  Lemma 10.78.2. Let $R$ be a ring and let $M$ be an $R$-module. The following are equivalent \n  \n  \n$M$ is finitely presented and $R$-flat, \n\n\n$M$ is finite projective, \n\n\n$M$ is a direct summand of a finite free $R$-module, \n\n\n$M$ is finitely presented and for all $\\mathfrak p \\in \\mathop{\\mathrm{Spec}}(R)$ the localization $M_{\\mathfrak p}$ is free, \n\n\n$M$ is finitely presented and for all maximal ideals $\\mathfrak m \\subset R$ the localization $M_{\\mathfrak m}$ is free, \n\n\n$M$ is finite and locally free, \n\n\n$M$ is finite locally free, and \n\n\n$M$ is finite, for every prime $\\mathfrak p$ the module $M_{\\mathfrak p}$ is free, and the function \n\n\n  \\[  \\rho _ M : \\mathop{\\mathrm{Spec}}(R) \\to \\mathbf{Z}, \\quad \\mathfrak p \\longmapsto \\dim _{\\kappa (\\mathfrak p)} M \\otimes _ R \\kappa (\\mathfrak p)  \\]\n\n\n is locally constant in the Zariski topology. \n\n\n\n\n    \n      Proof.\n      First suppose $M$ is finite projective, i.e., (2) holds. Take a surjection $R^ n \\to M$ and let $K$ be the kernel. Since $M$ is projective, $0 \\to K \\to R^ n \\to M \\to 0$ splits. Hence (2) $\\Rightarrow $ (3). The implication (3) $\\Rightarrow $ (2) follows from the fact that a direct summand of a projective is projective, see Lemma 10.77.2. \n    \n      Assume (3), so we can write $K \\oplus M \\cong R^{\\oplus n}$. So $K$ is a direct summand of $R^ n$ and thus finitely generated. This shows $M = R^{\\oplus n}/K$ is finitely presented. In other words, (3) $\\Rightarrow $ (1). \n    \n      Assume $M$ is finitely presented and flat, i.e., (1) holds. We will prove that (7) holds. Pick any prime $\\mathfrak p$ and $x_1, \\ldots , x_ r \\in M$ which map to a basis of $M \\otimes _ R \\kappa (\\mathfrak p)$. By Nakayama\'s lemma (in the form of Lemma 10.20.2) these elements generate $M_ g$ for some $g \\in R$, $g \\not\\in \\mathfrak p$. The corresponding surjection $\\varphi : R_ g^{\\oplus r} \\to M_ g$ has the following two properties: (a) $\\mathop{\\mathrm{Ker}}(\\varphi )$ is a finite $R_ g$-module (see Lemma 10.5.3) and (b) $\\mathop{\\mathrm{Ker}}(\\varphi ) \\otimes \\kappa (\\mathfrak p) = 0$ by flatness of $M_ g$ over $R_ g$ (see Lemma 10.39.12). Hence by Nakayama\'s lemma again there exists a $g\' \\in R_ g$ such that $\\mathop{\\mathrm{Ker}}(\\varphi )_{g\'} = 0$. In other words, $M_{gg\'}$ is free. \n    \n      A finite locally free module is a finite module, see Lemma 10.23.2, hence (7) $\\Rightarrow $ (6). It is clear that (6) $\\Rightarrow $ (7) and that (7) $\\Rightarrow $ (8). \n    \n      A finite locally free module is a finitely presented module, see Lemma 10.23.2, hence (7) $\\Rightarrow $ (4). Of course (4) implies (5). Since we may check flatness locally (see Lemma 10.39.18) we conclude that (5) implies (1). At this point we have \n    \n      \n  \\[  \\xymatrix{ (2) \\ar@{<=>}[r] &  (3) \\ar@{=>}[r] &  (1) \\ar@{=>}[r] &  (7) \\ar@{<=>}[r] \\ar@{=>}[rd] \\ar@{=>}[d] &  (6) \\\\  &  &  (5) \\ar@{=>}[u] &  (4) \\ar@{=>}[l] &  (8) }  \\]\n\n    \n      Suppose that $M$ satisfies (1), (4), (5), (6), and (7). We will prove that (3) holds. It suffices to show that $M$ is projective. We have to show that $\\mathop{\\mathrm{Hom}}\\nolimits _ R(M, -)$ is exact. Let $0 \\to N\'\' \\to N \\to N\'\\to 0$ be a short exact sequence of $R$-module. We have to show that $0 \\to \\mathop{\\mathrm{Hom}}\\nolimits _ R(M, N\'\') \\to \\mathop{\\mathrm{Hom}}\\nolimits _ R(M, N) \\to \\mathop{\\mathrm{Hom}}\\nolimits _ R(M, N\') \\to 0$ is exact. As $M$ is finite locally free there exist a covering $\\mathop{\\mathrm{Spec}}(R) = \\bigcup D(f_ i)$ such that $M_{f_ i}$ is finite free. By Lemma 10.10.2 we see that \n    \n      \n  \\[  0 \\to \\mathop{\\mathrm{Hom}}\\nolimits _ R(M, N\'\')_{f_ i} \\to \\mathop{\\mathrm{Hom}}\\nolimits _ R(M, N)_{f_ i} \\to \\mathop{\\mathrm{Hom}}\\nolimits _ R(M, N\')_{f_ i} \\to 0  \\]\n\n    \n       is equal to $0 \\to \\mathop{\\mathrm{Hom}}\\nolimits _{R_{f_ i}}(M_{f_ i}, N\'\'_{f_ i}) \\to \\mathop{\\mathrm{Hom}}\\nolimits _{R_{f_ i}}(M_{f_ i}, N_{f_ i}) \\to \\mathop{\\mathrm{Hom}}\\nolimits _{R_{f_ i}}(M_{f_ i}, N\'_{f_ i}) \\to 0$ which is exact as $M_{f_ i}$ is free and as the localization $0 \\to N\'\'_{f_ i} \\to N_{f_ i} \\to N\'_{f_ i} \\to 0$ is exact (as localization is exact). Whence we see that $0 \\to \\mathop{\\mathrm{Hom}}\\nolimits _ R(M, N\'\') \\to \\mathop{\\mathrm{Hom}}\\nolimits _ R(M, N) \\to \\mathop{\\mathrm{Hom}}\\nolimits _ R(M, N\') \\to 0$ is exact by Lemma 10.23.2. \n    \n      Finally, assume that (8) holds. Pick a maximal ideal $\\mathfrak m \\subset R$. Pick $x_1, \\ldots , x_ r \\in M$ which map to a $\\kappa (\\mathfrak m)$-basis of $M \\otimes _ R \\kappa (\\mathfrak m) = M/\\mathfrak mM$. In particular $\\rho _ M(\\mathfrak m) = r$. By Nakayama\'s Lemma 10.20.1 there exists an $f \\in R$, $f \\not\\in \\mathfrak m$ such that $x_1, \\ldots , x_ r$ generate $M_ f$ over $R_ f$. By the assumption that $\\rho _ M$ is locally constant there exists a $g \\in R$, $g \\not\\in \\mathfrak m$ such that $\\rho _ M$ is constant equal to $r$ on $D(g)$. We claim that \n    \n      \n  \\[  \\Psi : R_{fg}^{\\oplus r} \\longrightarrow M_{fg}, \\quad (a_1, \\ldots , a_ r) \\longmapsto \\sum a_ i x_ i  \\]\n\n    \n       is an isomorphism. This claim will show that $M$ is finite locally free, i.e., that (7) holds. To see the claim it suffices to show that the induced map on localizations $\\Psi _{\\mathfrak p} : R_{\\mathfrak p}^{\\oplus r} \\to M_{\\mathfrak p}$ is an isomorphism for all $\\mathfrak p \\in D(fg)$, see Lemma 10.23.1. By our choice of $f$ the map $\\Psi _{\\mathfrak p}$ is surjective. By assumption (8) we have $M_{\\mathfrak p} \\cong R_{\\mathfrak p}^{\\oplus \\rho _ M(\\mathfrak p)}$ and by our choice of $g$ we have $\\rho _ M(\\mathfrak p) = r$. Hence $\\Psi _{\\mathfrak p}$ determines a surjection $R_{\\mathfrak p}^{\\oplus r} \\to M_{\\mathfrak p} \\cong R_{\\mathfrak p}^{\\oplus r}$ whence is an isomorphism by Lemma 10.16.4. (Of course this last fact follows from a simple matrix argument also.) \n      $\\square$\n    \n","\n  Lemma 10.78.2. Let $R$ be a ring and let $M$ be an $R$-module. The following are equivalent \n  \n  \n$M$ is finitely presented and $R$-flat, \n\n\n$M$ is finite projective, \n\n\n$M$ is a direct summand of a finite free $R$-module, \n\n\n$M$ is finitely presented and for all $\\mathfrak p \\in \\mathop{\\mathrm{Spec}}(R)$ the localization $M_{\\mathfrak p}$ is free, \n\n\n$M$ is finitely presented and for all maximal ideals $\\mathfrak m \\subset R$ the localization $M_{\\mathfrak m}$ is free, \n\n\n$M$ is finite and locally free, \n\n\n$M$ is finite locally free, and \n\n\n$M$ is finite, for every prime $\\mathfrak p$ the module $M_{\\mathfrak p}$ is free, and the function \n\n\n  \\[  \\rho _ M : \\mathop{\\mathrm{Spec}}(R) \\to \\mathbf{Z}, \\quad \\mathfrak p \\longmapsto \\dim _{\\kappa (\\mathfrak p)} M \\otimes _ R \\kappa (\\mathfrak p)  \\]\n\n\n is locally constant in the Zariski topology. \n\n\n\n\n    \n","Proof.\n      First suppose $M$ is finite projective, i.e., (2) holds. Take a surjection $R^ n \\to M$ and let $K$ be the kernel. Since $M$ is projective, $0 \\to K \\to R^ n \\to M \\to 0$ splits. Hence (2) $\\Rightarrow $ (3). The implication (3) $\\Rightarrow $ (2) follows from the fact that a direct summand of a projective is projective, see Lemma 10.77.2. \n    \n      Assume (3), so we can write $K \\oplus M \\cong R^{\\oplus n}$. So $K$ is a direct summand of $R^ n$ and thus finitely generated. This shows $M = R^{\\oplus n}/K$ is finitely presented. In other words, (3) $\\Rightarrow $ (1). \n    \n      Assume $M$ is finitely presented and flat, i.e., (1) holds. We will prove that (7) holds. Pick any prime $\\mathfrak p$ and $x_1, \\ldots , x_ r \\in M$ which map to a basis of $M \\otimes _ R \\kappa (\\mathfrak p)$. By Nakayama\'s lemma (in the form of Lemma 10.20.2) these elements generate $M_ g$ for some $g \\in R$, $g \\not\\in \\mathfrak p$. The corresponding surjection $\\varphi : R_ g^{\\oplus r} \\to M_ g$ has the following two properties: (a) $\\mathop{\\mathrm{Ker}}(\\varphi )$ is a finite $R_ g$-module (see Lemma 10.5.3) and (b) $\\mathop{\\mathrm{Ker}}(\\varphi ) \\otimes \\kappa (\\mathfrak p) = 0$ by flatness of $M_ g$ over $R_ g$ (see Lemma 10.39.12). Hence by Nakayama\'s lemma again there exists a $g\' \\in R_ g$ such that $\\mathop{\\mathrm{Ker}}(\\varphi )_{g\'} = 0$. In other words, $M_{gg\'}$ is free. \n    \n      A finite locally free module is a finite module, see Lemma 10.23.2, hence (7) $\\Rightarrow $ (6). It is clear that (6) $\\Rightarrow $ (7) and that (7) $\\Rightarrow $ (8). \n    \n      A finite locally free module is a finitely presented module, see Lemma 10.23.2, hence (7) $\\Rightarrow $ (4). Of course (4) implies (5). Since we may check flatness locally (see Lemma 10.39.18) we conclude that (5) implies (1). At this point we have \n    \n      \n  \\[  \\xymatrix{ (2) \\ar@{<=>}[r] &  (3) \\ar@{=>}[r] &  (1) \\ar@{=>}[r] &  (7) \\ar@{<=>}[r] \\ar@{=>}[rd] \\ar@{=>}[d] &  (6) \\\\  &  &  (5) \\ar@{=>}[u] &  (4) \\ar@{=>}[l] &  (8) }  \\]\n\n    \n      Suppose that $M$ satisfies (1), (4), (5), (6), and (7). We will prove that (3) holds. It suffices to show that $M$ is projective. We have to show that $\\mathop{\\mathrm{Hom}}\\nolimits _ R(M, -)$ is exact. Let $0 \\to N\'\' \\to N \\to N\'\\to 0$ be a short exact sequence of $R$-module. We have to show that $0 \\to \\mathop{\\mathrm{Hom}}\\nolimits _ R(M, N\'\') \\to \\mathop{\\mathrm{Hom}}\\nolimits _ R(M, N) \\to \\mathop{\\mathrm{Hom}}\\nolimits _ R(M, N\') \\to 0$ is exact. As $M$ is finite locally free there exist a covering $\\mathop{\\mathrm{Spec}}(R) = \\bigcup D(f_ i)$ such that $M_{f_ i}$ is finite free. By Lemma 10.10.2 we see that \n    \n      \n  \\[  0 \\to \\mathop{\\mathrm{Hom}}\\nolimits _ R(M, N\'\')_{f_ i} \\to \\mathop{\\mathrm{Hom}}\\nolimits _ R(M, N)_{f_ i} \\to \\mathop{\\mathrm{Hom}}\\nolimits _ R(M, N\')_{f_ i} \\to 0  \\]\n\n    \n       is equal to $0 \\to \\mathop{\\mathrm{Hom}}\\nolimits _{R_{f_ i}}(M_{f_ i}, N\'\'_{f_ i}) \\to \\mathop{\\mathrm{Hom}}\\nolimits _{R_{f_ i}}(M_{f_ i}, N_{f_ i}) \\to \\mathop{\\mathrm{Hom}}\\nolimits _{R_{f_ i}}(M_{f_ i}, N\'_{f_ i}) \\to 0$ which is exact as $M_{f_ i}$ is free and as the localization $0 \\to N\'\'_{f_ i} \\to N_{f_ i} \\to N\'_{f_ i} \\to 0$ is exact (as localization is exact). Whence we see that $0 \\to \\mathop{\\mathrm{Hom}}\\nolimits _ R(M, N\'\') \\to \\mathop{\\mathrm{Hom}}\\nolimits _ R(M, N) \\to \\mathop{\\mathrm{Hom}}\\nolimits _ R(M, N\') \\to 0$ is exact by Lemma 10.23.2. \n    \n      Finally, assume that (8) holds. Pick a maximal ideal $\\mathfrak m \\subset R$. Pick $x_1, \\ldots , x_ r \\in M$ which map to a $\\kappa (\\mathfrak m)$-basis of $M \\otimes _ R \\kappa (\\mathfrak m) = M/\\mathfrak mM$. In particular $\\rho _ M(\\mathfrak m) = r$. By Nakayama\'s Lemma 10.20.1 there exists an $f \\in R$, $f \\not\\in \\mathfrak m$ such that $x_1, \\ldots , x_ r$ generate $M_ f$ over $R_ f$. By the assumption that $\\rho _ M$ is locally constant there exists a $g \\in R$, $g \\not\\in \\mathfrak m$ such that $\\rho _ M$ is constant equal to $r$ on $D(g)$. We claim that \n    \n      \n  \\[  \\Psi : R_{fg}^{\\oplus r} \\longrightarrow M_{fg}, \\quad (a_1, \\ldots , a_ r) \\longmapsto \\sum a_ i x_ i  \\]\n\n    \n       is an isomorphism. This claim will show that $M$ is finite locally free, i.e., that (7) holds. To see the claim it suffices to show that the induced map on localizations $\\Psi _{\\mathfrak p} : R_{\\mathfrak p}^{\\oplus r} \\to M_{\\mathfrak p}$ is an isomorphism for all $\\mathfrak p \\in D(fg)$, see Lemma 10.23.1. By our choice of $f$ the map $\\Psi _{\\mathfrak p}$ is surjective. By assumption (8) we have $M_{\\mathfrak p} \\cong R_{\\mathfrak p}^{\\oplus \\rho _ M(\\mathfrak p)}$ and by our choice of $g$ we have $\\rho _ M(\\mathfrak p) = r$. Hence $\\Psi _{\\mathfrak p}$ determines a surjection $R_{\\mathfrak p}^{\\oplus r} \\to M_{\\mathfrak p} \\cong R_{\\mathfrak p}^{\\oplus r}$ whence is an isomorphism by Lemma 10.16.4. (Of course this last fact follows from a simple matrix argument also.) \n      $\\square$\n    \n","
  have âŸ¨_, f, g, eqâŸ© := exists_factorization_of_isFinitelyPresented (.id (R := R) (M := M))
  .of_split f g eq.symm
",theorem projective_of_finitePresentation [Flat R M] [FinitePresentation R M] : Projective R M ,"Proof.\n      First suppose $M$ is finite projective, i.e., (2) holds. Take a surjection $R^ n \\to M$ and let $K$ be the kernel. Since $M$ is projective, $0 \\to K \\to R^ n \\to M \\to 0$ splits. Hence (2) $\\Rightarrow $ (3). The implication (3) $\\Rightarrow $ (2) follows from the fact that a direct summand of a projective is projective, see Lemma 10.77.2 [[\n  Lemma 10.77.2. Let $R$ be a ring. Let $P$ be an $R$-module. The following are equivalent \n  \n  \n$P$ is projective, \n\n\n$P$ is a direct summand of a free $R$-module, and \n\n\n$\\mathop{\\mathrm{Ext}}\\nolimits ^1_ R(P, M) = 0$ for every $R$-module $M$. \n\n\n\n\n    \n]]. \n    \n      Assume (3), so we can write $K \\oplus M \\cong R^{\\oplus n}$. So $K$ is a direct summand of $R^ n$ and thus finitely generated. This shows $M = R^{\\oplus n}/K$ is finitely presented. In other words, (3) $\\Rightarrow $ (1). \n    \n      Assume $M$ is finitely presented and flat, i.e., (1) holds. We will prove that (7) holds. Pick any prime $\\mathfrak p$ and $x_1, \\ldots , x_ r \\in M$ which map to a basis of $M \\otimes _ R \\kappa (\\mathfrak p)$. By Nakayama\'s lemma (in the form of Lemma 10.20.2 [[\n  Lemma 10.20.2. Let $R$ be a ring, let $S \\subset R$ be a multiplicative subset, let $I \\subset R$ be an ideal, and let $M$ be a finite $R$-module. If $x_1, \\ldots , x_ r \\in M$ generate $S^{-1}(M/IM)$ as an $S^{-1}(R/I)$-module, then there exists an $f \\in S + I$ such that $x_1, \\ldots , x_ r$ generate $M_ f$ as an $R_ f$-module.1 \n\n    \n]]) these elements generate $M_ g$ for some $g \\in R$, $g \\not\\in \\mathfrak p$. The corresponding surjection $\\varphi : R_ g^{\\oplus r} \\to M_ g$ has the following two properties: (a) $\\mathop{\\mathrm{Ker}}(\\varphi )$ is a finite $R_ g$-module (see Lemma 10.5.3 [[\n  Lemma 10.5.3. Let $R$ be a ring. Let \n  \n  \\[  0 \\to M_1 \\to M_2 \\to M_3 \\to 0  \\]\n\n   be a short exact sequence of $R$-modules. \n  \n  \nIf $M_1$ and $M_3$ are finite $R$-modules, then $M_2$ is a finite $R$-module. \n\n\nIf $M_1$ and $M_3$ are finitely presented $R$-modules, then $M_2$ is a finitely presented $R$-module. \n\n\nIf $M_2$ is a finite $R$-module, then $M_3$ is a finite $R$-module. \n\n\nIf $M_2$ is a finitely presented $R$-module and $M_1$ is a finite $R$-module, then $M_3$ is a finitely presented $R$-module. \n\n\nIf $M_3$ is a finitely presented $R$-module and $M_2$ is a finite $R$-module, then $M_1$ is a finite $R$-module. \n\n\n\n\n    \n]]) and (b) $\\mathop{\\mathrm{Ker}}(\\varphi ) \\otimes \\kappa (\\mathfrak p) = 0$ by flatness of $M_ g$ over $R_ g$ (see Lemma 10.39.12 [[\n  Lemma 10.39.12. Suppose that $R$ is a ring, $0 \\to M\'\' \\to M\' \\to M \\to 0$ a short exact sequence, and $N$ an $R$-module. If $M$ is flat then $N \\otimes _ R M\'\' \\to N \\otimes _ R M\'$ is injective, i.e., the sequence \n  \n  \\[  0 \\to N \\otimes _ R M\'\' \\to N \\otimes _ R M\' \\to N \\otimes _ R M \\to 0  \\]\n\n   is a short exact sequence. \n\n    \n]]). Hence by Nakayama\'s lemma again there exists a $g\' \\in R_ g$ such that $\\mathop{\\mathrm{Ker}}(\\varphi )_{g\'} = 0$. In other words, $M_{gg\'}$ is free. \n    \n      A finite locally free module is a finite module, see Lemma 10.23.2 [[\n       \n      \n  Lemma 10.23.2. Let $R$ be a ring. Let $M$ be an $R$-module. Let $S$ be an $R$-algebra. Suppose that $f_1, \\ldots , f_ n$ is a finite list of elements of $R$ such that $\\bigcup D(f_ i) = \\mathop{\\mathrm{Spec}}(R)$, in other words $(f_1, \\ldots , f_ n) = R$. \n  \n  \nIf each $M_{f_ i} = 0$ then $M = 0$. \n\n\nIf each $M_{f_ i}$ is a finite $R_{f_ i}$-module, then $M$ is a finite $R$-module. \n\n\nIf each $M_{f_ i}$ is a finitely presented $R_{f_ i}$-module, then $M$ is a finitely presented $R$-module. \n\n\nLet $M \\to N$ be a map of $R$-modules. If $M_{f_ i} \\to N_{f_ i}$ is an isomorphism for each $i$ then $M \\to N$ is an isomorphism. \n\n\nLet $0 \\to M\'\' \\to M \\to M\' \\to 0$ be a complex of $R$-modules. If $0 \\to M\'\'_{f_ i} \\to M_{f_ i} \\to M\'_{f_ i} \\to 0$ is exact for each $i$, then $0 \\to M\'\' \\to M \\to M\' \\to 0$ is exact. \n\n\nIf each $R_{f_ i}$ is Noetherian, then $R$ is Noetherian. \n\n\nIf each $S_{f_ i}$ is a finite type $R_{f_ i}$-algebra, then $S$ is a finite type $R$-algebra. \n\n\nIf each $S_{f_ i}$ is of finite presentation over $R_{f_ i}$, then $S$ is a finitely presented $R$-algebra. \n\n\n\n\n    \n]], hence (7) $\\Rightarrow $ (6). It is clear that (6) $\\Rightarrow $ (7) and that (7) $\\Rightarrow $ (8). \n    \n      A finite locally free module is a finitely presented module, see Lemma 10.23.2 [[\n       \n      \n  Lemma 10.23.2. Let $R$ be a ring. Let $M$ be an $R$-module. Let $S$ be an $R$-algebra. Suppose that $f_1, \\ldots , f_ n$ is a finite list of elements of $R$ such that $\\bigcup D(f_ i) = \\mathop{\\mathrm{Spec}}(R)$, in other words $(f_1, \\ldots , f_ n) = R$. \n  \n  \nIf each $M_{f_ i} = 0$ then $M = 0$. \n\n\nIf each $M_{f_ i}$ is a finite $R_{f_ i}$-module, then $M$ is a finite $R$-module. \n\n\nIf each $M_{f_ i}$ is a finitely presented $R_{f_ i}$-module, then $M$ is a finitely presented $R$-module. \n\n\nLet $M \\to N$ be a map of $R$-modules. If $M_{f_ i} \\to N_{f_ i}$ is an isomorphism for each $i$ then $M \\to N$ is an isomorphism. \n\n\nLet $0 \\to M\'\' \\to M \\to M\' \\to 0$ be a complex of $R$-modules. If $0 \\to M\'\'_{f_ i} \\to M_{f_ i} \\to M\'_{f_ i} \\to 0$ is exact for each $i$, then $0 \\to M\'\' \\to M \\to M\' \\to 0$ is exact. \n\n\nIf each $R_{f_ i}$ is Noetherian, then $R$ is Noetherian. \n\n\nIf each $S_{f_ i}$ is a finite type $R_{f_ i}$-algebra, then $S$ is a finite type $R$-algebra. \n\n\nIf each $S_{f_ i}$ is of finite presentation over $R_{f_ i}$, then $S$ is a finitely presented $R$-algebra. \n\n\n\n\n    \n]], hence (7) $\\Rightarrow $ (4). Of course (4) implies (5). Since we may check flatness locally (see Lemma 10.39.18 [[\n  Lemma 10.39.18. Let $R$ be a ring. Let $S \\subset R$ be a multiplicative subset. \n  \n  \nThe localization $S^{-1}R$ is a flat $R$-algebra. \n\n\nIf $M$ is an $S^{-1}R$-module, then $M$ is a flat $R$-module if and only if $M$ is a flat $S^{-1}R$-module. \n\n\nSuppose $M$ is an $R$-module. Then $M$ is a flat $R$-module if and only if $M_{\\mathfrak p}$ is a flat $R_{\\mathfrak p}$-module for all primes $\\mathfrak p$ of $R$. \n\n\nSuppose $M$ is an $R$-module. Then $M$ is a flat $R$-module if and only if $M_{\\mathfrak m}$ is a flat $R_{\\mathfrak m}$-module for all maximal ideals $\\mathfrak m$ of $R$. \n\n\nSuppose $R \\to A$ is a ring map, $M$ is an $A$-module, and $g_1, \\ldots , g_ m \\in A$ are elements generating the unit ideal of $A$. Then $M$ is flat over $R$ if and only if each localization $M_{g_ i}$ is flat over $R$. \n\n\nSuppose $R \\to A$ is a ring map, and $M$ is an $A$-module. Then $M$ is a flat $R$-module if and only if the localization $M_{\\mathfrak q}$ is a flat $R_{\\mathfrak p}$-module (with $\\mathfrak p$ the prime of $R$ lying under $\\mathfrak q$) for all primes $\\mathfrak q$ of $A$. \n\n\nSuppose $R \\to A$ is a ring map, and $M$ is an $A$-module. Then $M$ is a flat $R$-module if and only if the localization $M_{\\mathfrak m}$ is a flat $R_{\\mathfrak p}$-module (with $\\mathfrak p = R \\cap \\mathfrak m$) for all maximal ideals $\\mathfrak m$ of $A$. \n\n\n\n\n    \n]]) we conclude that (5) implies (1). At this point we have \n    \n      \n  \\[  \\xymatrix{ (2) \\ar@{<=>}[r] &  (3) \\ar@{=>}[r] &  (1) \\ar@{=>}[r] &  (7) \\ar@{<=>}[r] \\ar@{=>}[rd] \\ar@{=>}[d] &  (6) \\\\  &  &  (5) \\ar@{=>}[u] &  (4) \\ar@{=>}[l] &  (8) }  \\]\n\n    \n      Suppose that $M$ satisfies (1), (4), (5), (6), and (7). We will prove that (3) holds. It suffices to show that $M$ is projective. We have to show that $\\mathop{\\mathrm{Hom}}\\nolimits _ R(M, -)$ is exact. Let $0 \\to N\'\' \\to N \\to N\'\\to 0$ be a short exact sequence of $R$-module. We have to show that $0 \\to \\mathop{\\mathrm{Hom}}\\nolimits _ R(M, N\'\') \\to \\mathop{\\mathrm{Hom}}\\nolimits _ R(M, N) \\to \\mathop{\\mathrm{Hom}}\\nolimits _ R(M, N\') \\to 0$ is exact. As $M$ is finite locally free there exist a covering $\\mathop{\\mathrm{Spec}}(R) = \\bigcup D(f_ i)$ such that $M_{f_ i}$ is finite free. By Lemma 10.10.2 [[\n  Lemma 10.10.2. Let $R$ be a ring. Let $M$ be a finitely presented $R$-module. Let $N$ be an $R$-module. \n  \n  \nFor $f \\in R$ we have $\\mathop{\\mathrm{Hom}}\\nolimits _ R(M, N)_ f = \\mathop{\\mathrm{Hom}}\\nolimits _{R_ f}(M_ f, N_ f) = \\mathop{\\mathrm{Hom}}\\nolimits _ R(M_ f, N_ f)$, \n\n\nfor a multiplicative subset $S$ of $R$ we have \n\n\n  \\[  S^{-1}\\mathop{\\mathrm{Hom}}\\nolimits _ R(M, N) = \\mathop{\\mathrm{Hom}}\\nolimits _{S^{-1}R}(S^{-1}M, S^{-1}N) = \\mathop{\\mathrm{Hom}}\\nolimits _ R(S^{-1}M, S^{-1}N).  \\]\n\n\n\n\n    \n]] we see that \n    \n      \n  \\[  0 \\to \\mathop{\\mathrm{Hom}}\\nolimits _ R(M, N\'\')_{f_ i} \\to \\mathop{\\mathrm{Hom}}\\nolimits _ R(M, N)_{f_ i} \\to \\mathop{\\mathrm{Hom}}\\nolimits _ R(M, N\')_{f_ i} \\to 0  \\]\n\n    \n       is equal to $0 \\to \\mathop{\\mathrm{Hom}}\\nolimits _{R_{f_ i}}(M_{f_ i}, N\'\'_{f_ i}) \\to \\mathop{\\mathrm{Hom}}\\nolimits _{R_{f_ i}}(M_{f_ i}, N_{f_ i}) \\to \\mathop{\\mathrm{Hom}}\\nolimits _{R_{f_ i}}(M_{f_ i}, N\'_{f_ i}) \\to 0$ which is exact as $M_{f_ i}$ is free and as the localization $0 \\to N\'\'_{f_ i} \\to N_{f_ i} \\to N\'_{f_ i} \\to 0$ is exact (as localization is exact). Whence we see that $0 \\to \\mathop{\\mathrm{Hom}}\\nolimits _ R(M, N\'\') \\to \\mathop{\\mathrm{Hom}}\\nolimits _ R(M, N) \\to \\mathop{\\mathrm{Hom}}\\nolimits _ R(M, N\') \\to 0$ is exact by Lemma 10.23.2 [[\n       \n      \n  Lemma 10.23.2. Let $R$ be a ring. Let $M$ be an $R$-module. Let $S$ be an $R$-algebra. Suppose that $f_1, \\ldots , f_ n$ is a finite list of elements of $R$ such that $\\bigcup D(f_ i) = \\mathop{\\mathrm{Spec}}(R)$, in other words $(f_1, \\ldots , f_ n) = R$. \n  \n  \nIf each $M_{f_ i} = 0$ then $M = 0$. \n\n\nIf each $M_{f_ i}$ is a finite $R_{f_ i}$-module, then $M$ is a finite $R$-module. \n\n\nIf each $M_{f_ i}$ is a finitely presented $R_{f_ i}$-module, then $M$ is a finitely presented $R$-module. \n\n\nLet $M \\to N$ be a map of $R$-modules. If $M_{f_ i} \\to N_{f_ i}$ is an isomorphism for each $i$ then $M \\to N$ is an isomorphism. \n\n\nLet $0 \\to M\'\' \\to M \\to M\' \\to 0$ be a complex of $R$-modules. If $0 \\to M\'\'_{f_ i} \\to M_{f_ i} \\to M\'_{f_ i} \\to 0$ is exact for each $i$, then $0 \\to M\'\' \\to M \\to M\' \\to 0$ is exact. \n\n\nIf each $R_{f_ i}$ is Noetherian, then $R$ is Noetherian. \n\n\nIf each $S_{f_ i}$ is a finite type $R_{f_ i}$-algebra, then $S$ is a finite type $R$-algebra. \n\n\nIf each $S_{f_ i}$ is of finite presentation over $R_{f_ i}$, then $S$ is a finitely presented $R$-algebra. \n\n\n\n\n    \n]]. \n    \n      Finally, assume that (8) holds. Pick a maximal ideal $\\mathfrak m \\subset R$. Pick $x_1, \\ldots , x_ r \\in M$ which map to a $\\kappa (\\mathfrak m)$-basis of $M \\otimes _ R \\kappa (\\mathfrak m) = M/\\mathfrak mM$. In particular $\\rho _ M(\\mathfrak m) = r$. By Nakayama\'s Lemma 10.20.1 [[\n        \n      \n      \n  Lemma 10.20.1 (Nakayama\'s lemma). Let $R$ be a ring with Jacobson radical $\\text{rad}(R)$. Let $M$ be an $R$-module. Let $I \\subset R$ be an ideal. \n  \n  \n If $IM = M$ and $M$ is finite, then there exists an $f \\in 1 + I$ such that $fM = 0$. \n\n\nIf $IM = M$, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $M = 0$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, and $N\'$ is finite, then there exists an $f \\in 1 + I$ such that $fM \\subset N$ and $M_ f = N_ f$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, $N\'$ is finite, and $I \\subset \\text{rad}(R)$, then $M = N$. \n\n\nIf $N \\to M$ is a module map, $N/IN \\to M/IM$ is surjective, and $M$ is finite, then there exists an $f \\in 1 + I$ such that $N_ f \\to M_ f$ is surjective. \n\n\nIf $N \\to M$ is a module map, $N/IN \\to M/IM$ is surjective, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $N \\to M$ is surjective. \n\n\nIf $x_1, \\ldots , x_ n \\in M$ generate $M/IM$ and $M$ is finite, then there exists an $f \\in 1 + I$ such that $x_1, \\ldots , x_ n$ generate $M_ f$ over $R_ f$. \n\n\nIf $x_1, \\ldots , x_ n \\in M$ generate $M/IM$, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $M$ is generated by $x_1, \\ldots , x_ n$. \n\n\nIf $IM = M$, $I$ is nilpotent, then $M = 0$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, and $I$ is nilpotent then $M = N$. \n\n\nIf $N \\to M$ is a module map, $I$ is nilpotent, and $N/IN \\to M/IM$ is surjective, then $N \\to M$ is surjective. \n\n\nIf $\\{ x_\\alpha \\} _{\\alpha \\in A}$ is a set of elements of $M$ which generate $M/IM$ and $I$ is nilpotent, then $M$ is generated by the $x_\\alpha $. \n\n\n\n\n    \n]] there exists an $f \\in R$, $f \\not\\in \\mathfrak m$ such that $x_1, \\ldots , x_ r$ generate $M_ f$ over $R_ f$. By the assumption that $\\rho _ M$ is locally constant there exists a $g \\in R$, $g \\not\\in \\mathfrak m$ such that $\\rho _ M$ is constant equal to $r$ on $D(g)$. We claim that \n    \n      \n  \\[  \\Psi : R_{fg}^{\\oplus r} \\longrightarrow M_{fg}, \\quad (a_1, \\ldots , a_ r) \\longmapsto \\sum a_ i x_ i  \\]\n\n    \n       is an isomorphism. This claim will show that $M$ is finite locally free, i.e., that (7) holds. To see the claim it suffices to show that the induced map on localizations $\\Psi _{\\mathfrak p} : R_{\\mathfrak p}^{\\oplus r} \\to M_{\\mathfrak p}$ is an isomorphism for all $\\mathfrak p \\in D(fg)$, see Lemma 10.23.1 [[\n  Lemma 10.23.1. Let $R$ be a ring. \n  \n  \nFor an element $x$ of an $R$-module $M$ the following are equivalent \n\n\n  \n$x = 0$, \n\n\n$x$ maps to zero in $M_\\mathfrak p$ for all $\\mathfrak p \\in \\mathop{\\mathrm{Spec}}(R)$, \n\n\n$x$ maps to zero in $M_{\\mathfrak m}$ for all maximal ideals $\\mathfrak m$ of $R$. \n\n\n\n\n In other words, the map $M \\to \\prod _{\\mathfrak m} M_{\\mathfrak m}$ is injective. \n\n\nGiven an $R$-module $M$ the following are equivalent \n\n\n  \n$M$ is zero, \n\n\n$M_{\\mathfrak p}$ is zero for all $\\mathfrak p \\in \\mathop{\\mathrm{Spec}}(R)$, \n\n\n$M_{\\mathfrak m}$ is zero for all maximal ideals $\\mathfrak m$ of $R$. \n\n\n\n\nGiven a complex $M_1 \\to M_2 \\to M_3$ of $R$-modules the following are equivalent \n\n\n  \n$M_1 \\to M_2 \\to M_3$ is exact, \n\n\nfor every prime $\\mathfrak p$ of $R$ the localization $M_{1, \\mathfrak p} \\to M_{2, \\mathfrak p} \\to M_{3, \\mathfrak p}$ is exact, \n\n\nfor every maximal ideal $\\mathfrak m$ of $R$ the localization $M_{1, \\mathfrak m} \\to M_{2, \\mathfrak m} \\to M_{3, \\mathfrak m}$ is exact. \n\n\n\n\nGiven a map $f : M \\to M\'$ of $R$-modules the following are equivalent \n\n\n  \n$f$ is injective, \n\n\n$f_{\\mathfrak p} : M_\\mathfrak p \\to M\'_\\mathfrak p$ is injective for all primes $\\mathfrak p$ of $R$, \n\n\n$f_{\\mathfrak m} : M_\\mathfrak m \\to M\'_\\mathfrak m$ is injective for all maximal ideals $\\mathfrak m$ of $R$. \n\n\n\n\nGiven a map $f : M \\to M\'$ of $R$-modules the following are equivalent \n\n\n  \n$f$ is surjective, \n\n\n$f_{\\mathfrak p} : M_\\mathfrak p \\to M\'_\\mathfrak p$ is surjective for all primes $\\mathfrak p$ of $R$, \n\n\n$f_{\\mathfrak m} : M_\\mathfrak m \\to M\'_\\mathfrak m$ is surjective for all maximal ideals $\\mathfrak m$ of $R$. \n\n\n\n\nGiven a map $f : M \\to M\'$ of $R$-modules the following are equivalent \n\n\n  \n$f$ is bijective, \n\n\n$f_{\\mathfrak p} : M_\\mathfrak p \\to M\'_\\mathfrak p$ is bijective for all primes $\\mathfrak p$ of $R$, \n\n\n$f_{\\mathfrak m} : M_\\mathfrak m \\to M\'_\\mathfrak m$ is bijective for all maximal ideals $\\mathfrak m$ of $R$. \n\n\n\n\n\n\n    \n]]. By our choice of $f$ the map $\\Psi _{\\mathfrak p}$ is surjective. By assumption (8) we have $M_{\\mathfrak p} \\cong R_{\\mathfrak p}^{\\oplus \\rho _ M(\\mathfrak p)}$ and by our choice of $g$ we have $\\rho _ M(\\mathfrak p) = r$. Hence $\\Psi _{\\mathfrak p}$ determines a surjection $R_{\\mathfrak p}^{\\oplus r} \\to M_{\\mathfrak p} \\cong R_{\\mathfrak p}^{\\oplus r}$ whence is an isomorphism by Lemma 10.16.4 [[\n  Lemma 10.16.4. Let $R$ be a ring. Let $M$ be a finite $R$-module. Let $\\varphi : M \\to M$ be a surjective $R$-module map. Then $\\varphi $ is an isomorphism. \n\n    \n      First proof.\n       Write $R\' = R[x]$ and think of $M$ as a finite $R\'$-module with $x$ acting via $\\varphi $. Set $I = (x) \\subset R\'$. By our assumption that $\\varphi $ is surjective we have $IM = M$. Hence we may apply Lemma 10.16.3 to $M$ as an $R\'$-module, the ideal $I$ and the endomorphism $\\text{id}_ M$. We conclude that $(1 + a_1 + \\ldots + a_ n)\\text{id}_ M = 0$ with $a_ j \\in I$. Write $a_ j = b_ j(x)x$ for some $b_ j(x) \\in R[x]$. Translating back into $\\varphi $ we see that $\\text{id}_ M = -(\\sum _{j = 1, \\ldots , n} b_ j(\\varphi )) \\varphi $, and hence $\\varphi $ is invertible. \n      $\\square$\n    \n\n    \n      Second proof.\n       We perform induction on the number of generators of $M$ over $R$. If $M$ is generated by one element, then $M \\cong R/I$ for some ideal $I \\subset R$. In this case we may replace $R$ by $R/I$ so that $M = R$. In this case $\\varphi : R \\to R$ is given by multiplication on $M$ by an element $r \\in R$. The surjectivity of $\\varphi $ forces $r$ invertible, since $\\varphi $ must hit $1$, which implies that $\\varphi $ is invertible. \n    \n      Now assume that we have proven the lemma in the case of modules generated by $n - 1$ elements, and are examining a module $M$ generated by $n$ elements. Let $A$ mean the ring $R[t]$, and regard the module $M$ as an $A$-module by letting $t$ act via $\\varphi $; since $M$ is finite over $R$, it is finite over $R[t]$ as well, and since we\'re trying to prove $\\varphi $ injective, a set-theoretic property, we might as well prove the endomorphism $t : M \\to M$ over $A$ injective. We have reduced our problem to the case our endomorphism is multiplication by an element of the ground ring. Let $M\' \\subset M$ denote the sub-$A$-module generated by the first $n - 1$ of the generators of $M$, and consider the diagram \n    \n      \n  \\[  \\xymatrix{ 0 \\ar[r] &  M\' \\ar[r]\\ar[d]^{\\varphi \\mid _{M\'}} &  M\\ar[d]^\\varphi \\ar[r] &  M/M\' \\ar[d]^{\\varphi \\bmod M\'} \\ar[r] &  0 \\\\  0 \\ar[r] &  M\' \\ar[r] &  M \\ar[r] &  M/M\' \\ar[r] &  0, }  \\]\n\n    \n       where the restriction of $\\varphi $ to $M\'$ and the map induced by $\\varphi $ on the quotient $M/M\'$ are well-defined since $\\varphi $ is multiplication by an element in the base, and $M\'$ and $M/M\'$ are $A$-modules in their own right. By the case $n = 1$ the map $M/M\' \\to M/M\'$ is an isomorphism. A diagram chase implies that $\\varphi |_{M\'}$ is surjective hence by induction $\\varphi |_{M\'}$ is an isomorphism. This forces the middle column to be an isomorphism by the snake lemma. \n      $\\square$\n    \n]]. (Of course this last fact follows from a simple matrix argument also.) \n      $\\square$\n    \n"
278,0539,"theorem flat_iff_torsion_eq_bot_of_isBezout [IsBezout R] [IsDomain R] :
    Flat R M â†” torsion R M = âŠ¥ := by
  -- one way is true in general
  refine âŸ¨fun _ â†¦ torsion_eq_bot, ?_âŸ©
  -- now assume R is a Bezout domain and M is a torsionfree R-module
  intro htors
  -- we need to show that if I is an ideal of R then the natural map I âŠ— M â†’ M is injective
  rw [iff_lift_lsmul_comp_subtype_injective]
  rintro I hFG
  -- If I = 0 this is obvious because I âŠ— M is a subsingleton (i.e. has â‰¤1 element)
  obtain (rfl | h) := eq_or_ne I âŠ¥
  Â· rintro x y -
    apply Subsingleton.elim
  Â· -- If I â‰  0 then I â‰… R because R is Bezout and I is finitely generated
    have hprinc : I.IsPrincipal := IsBezout.isPrincipal_of_FG I hFG
    have : IsPrincipal.generator I â‰  0 := by
      rwa [ne_eq, â† IsPrincipal.eq_bot_iff_generator_eq_zero]
    apply Function.Injective.of_comp_right _
      (LinearEquiv.rTensor M (Ideal.isoBaseOfIsPrincipal h)).surjective
    rw [â† LinearEquiv.coe_toLinearMap, â† LinearMap.coe_comp, LinearEquiv.coe_rTensor, rTensor,
      lift_comp_map, LinearMap.complâ‚‚_id, LinearMap.comp_assoc,
      Ideal.subtype_isoBaseOfIsPrincipal_eq_mul, LinearMap.lift_lsmul_mul_eq_lsmul_lift_lsmul,
      LinearMap.coe_comp]
    rw [â† Submodule.isTorsionFree_iff_torsion_eq_bot] at htors
    refine Function.Injective.comp (LinearMap.lsmul_injective this) ?_
    rw [â† Equiv.injective_comp (TensorProduct.lid R M).symm.toEquiv]
    convert Function.injective_id
    ext
    simp
",Formal Proof of Stacks Project Tag 0539,Generalized valuation ring to Bezout domain,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Flat/TorsionFree.lean#L90-L118,Q27041,,15.22.10,lemma,3.0,"['0549', '05E3', '0ELQ']","\n  Lemma 15.22.10. Let $A$ be a valuation ring. An $A$-module $M$ is flat over $A$ if and only if $M$ is torsion free. \n\n    \n      Proof.\n      The implication \xe2\x80\x9cflat $\\Rightarrow $ torsion free\xe2\x80\x9d is Lemma 15.22.9. For the converse, assume $M$ is torsion free. By the equational criterion of flatness (see Algebra, Lemma 10.39.11) we have to show that every relation in $M$ is trivial. To do this assume that $\\sum _{i = 1, \\ldots , n} a_ i x_ i = 0$ with $x_ i \\in M$ and $a_ i \\in A$. After renumbering we may assume that $v(a_1) \\leq v(a_ i)$ for all $i$. Hence we can write $a_ i = a\'_ i a_1$ for some $a\'_ i \\in A$. Note that $a\'_1 = 1$. As $M$ is torsion free we see that $x_1 = - \\sum _{i \\geq 2} a\'_ i x_ i$. Thus, if we choose $y_ i = x_ i$, $i = 2, \\ldots , n$ then \n    \n      \n  \\[  x_1 = \\sum \\nolimits _{j \\geq 2} -a\'_ j y_ j, \\quad x_ i = y_ i, (i \\geq 2)\\quad 0 = a_1 \\cdot (-a\'_ j) + a_ j \\cdot 1 (j \\geq 2)  \\]\n\n    \n       shows that the relation was trivial (to be explicit the elements $a_{ij}$ are defined by setting $a_{11} = 0$, $a_{1j} = -a\'_ j$ for $j > 1$, and $a_{ij} = \\delta _{ij}$ for $i, j \\geq 2$). \n      $\\square$\n    \n",\n  Lemma 15.22.10. Let $A$ be a valuation ring. An $A$-module $M$ is flat over $A$ if and only if $M$ is torsion free. \n\n    \n,"Proof.\n      The implication \xe2\x80\x9cflat $\\Rightarrow $ torsion free\xe2\x80\x9d is Lemma 15.22.9. For the converse, assume $M$ is torsion free. By the equational criterion of flatness (see Algebra, Lemma 10.39.11) we have to show that every relation in $M$ is trivial. To do this assume that $\\sum _{i = 1, \\ldots , n} a_ i x_ i = 0$ with $x_ i \\in M$ and $a_ i \\in A$. After renumbering we may assume that $v(a_1) \\leq v(a_ i)$ for all $i$. Hence we can write $a_ i = a\'_ i a_1$ for some $a\'_ i \\in A$. Note that $a\'_1 = 1$. As $M$ is torsion free we see that $x_1 = - \\sum _{i \\geq 2} a\'_ i x_ i$. Thus, if we choose $y_ i = x_ i$, $i = 2, \\ldots , n$ then \n    \n      \n  \\[  x_1 = \\sum \\nolimits _{j \\geq 2} -a\'_ j y_ j, \\quad x_ i = y_ i, (i \\geq 2)\\quad 0 = a_1 \\cdot (-a\'_ j) + a_ j \\cdot 1 (j \\geq 2)  \\]\n\n    \n       shows that the relation was trivial (to be explicit the elements $a_{ij}$ are defined by setting $a_{11} = 0$, $a_{1j} = -a\'_ j$ for $j > 1$, and $a_{ij} = \\delta _{ij}$ for $i, j \\geq 2$). \n      $\\square$\n    \n"," by
  -- one way is true in general
  refine âŸ¨fun _ â†¦ torsion_eq_bot, ?_âŸ©
  -- now assume R is a Bezout domain and M is a torsionfree R-module
  intro htors
  -- we need to show that if I is an ideal of R then the natural map I âŠ— M â†’ M is injective
  rw [iff_lift_lsmul_comp_subtype_injective]
  rintro I hFG
  -- If I = 0 this is obvious because I âŠ— M is a subsingleton (i.e. has â‰¤1 element)
  obtain (rfl | h) := eq_or_ne I âŠ¥
  Â· rintro x y -
    apply Subsingleton.elim
  Â· -- If I â‰  0 then I â‰… R because R is Bezout and I is finitely generated
    have hprinc : I.IsPrincipal := IsBezout.isPrincipal_of_FG I hFG
    have : IsPrincipal.generator I â‰  0 := by
      rwa [ne_eq, â† IsPrincipal.eq_bot_iff_generator_eq_zero]
    apply Function.Injective.of_comp_right _
      (LinearEquiv.rTensor M (Ideal.isoBaseOfIsPrincipal h)).surjective
    rw [â† LinearEquiv.coe_toLinearMap, â† LinearMap.coe_comp, LinearEquiv.coe_rTensor, rTensor,
      lift_comp_map, LinearMap.complâ‚‚_id, LinearMap.comp_assoc,
      Ideal.subtype_isoBaseOfIsPrincipal_eq_mul, LinearMap.lift_lsmul_mul_eq_lsmul_lift_lsmul,
      LinearMap.coe_comp]
    rw [â† Submodule.isTorsionFree_iff_torsion_eq_bot] at htors
    refine Function.Injective.comp (LinearMap.lsmul_injective this) ?_
    rw [â† Equiv.injective_comp (TensorProduct.lid R M).symm.toEquiv]
    convert Function.injective_id
    ext
    simp
","theorem flat_iff_torsion_eq_bot_of_isBezout [IsBezout R] [IsDomain R] :
    Flat R M â†” torsion R M = âŠ¥ ","Proof.\n      The implication \xe2\x80\x9cflat $\\Rightarrow $ torsion free\xe2\x80\x9d is Lemma 15.22.9 [[\n  Lemma 15.22.9. Let $R$ be a domain. Any flat $R$-module is torsion free. \n\n    \n]]. For the converse, assume $M$ is torsion free. By the equational criterion of flatness (see Algebra, Lemma 10.39.11 [[\n  Lemma 10.39.11 (Equational criterion of flatness).  A module $M$ over $R$ is flat if and only if every relation in $M$ is trivial. \n\n    \n]]) we have to show that every relation in $M$ is trivial. To do this assume that $\\sum _{i = 1, \\ldots , n} a_ i x_ i = 0$ with $x_ i \\in M$ and $a_ i \\in A$. After renumbering we may assume that $v(a_1) \\leq v(a_ i)$ for all $i$. Hence we can write $a_ i = a\'_ i a_1$ for some $a\'_ i \\in A$. Note that $a\'_1 = 1$. As $M$ is torsion free we see that $x_1 = - \\sum _{i \\geq 2} a\'_ i x_ i$. Thus, if we choose $y_ i = x_ i$, $i = 2, \\ldots , n$ then \n    \n      \n  \\[  x_1 = \\sum \\nolimits _{j \\geq 2} -a\'_ j y_ j, \\quad x_ i = y_ i, (i \\geq 2)\\quad 0 = a_1 \\cdot (-a\'_ j) + a_ j \\cdot 1 (j \\geq 2)  \\]\n\n    \n       shows that the relation was trivial (to be explicit the elements $a_{ij}$ are defined by setting $a_{11} = 0$, $a_{1j} = -a\'_ j$ for $j > 1$, and $a_{ij} = \\delta _{ij}$ for $i, j \\geq 2$). \n      $\\square$\n    \n"
279,0AUW,"theorem _root_.IsDedekindDomain.flat_iff_torsion_eq_bot [IsDedekindDomain R] :
    Flat R M â†” torsion R M = âŠ¥ := by
  apply flat_iff_torsion_eq_bot_of_valuationRing_localization_isMaximal
  exact fun P â†¦ inferInstance
",Formal Proof of Stacks Project Tag 0AUW,(1),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Flat/TorsionFree.lean#L135-L138,Q27041,,15.22.11,lemma,3.0,"['0549', '05E3', '0ELQ']","\n  Lemma 15.22.11. Let $A$ be a Dedekind domain (for example a discrete valuation ring or more generally a PID). \n  \n  \nAn $A$-module is flat if and only if it is torsion free. \n\n\nA finite torsion free $A$-module is finite locally free. \n\n\nA finite torsion free $A$-module is finite free if $A$ is a PID. \n\n\n\n\n    \n      Proof.\n      (For the parenthetical remark in the statement of the lemma, see Algebra, Lemma 10.120.15.) Proof of (1). By Lemma 15.22.6 and Algebra, Lemma 10.39.18 it suffices to check the statement over $A_\\mathfrak m$ for $\\mathfrak m \\subset A$ maximal. Since $A_\\mathfrak m$ is a discrete valuation ring (Algebra, Lemma 10.120.17) we win by Lemma 15.22.10. \n    \n      Proof of (2). Follows from Algebra, Lemma 10.78.2 and (1). \n    \n      Proof of (3). Let $A$ be a PID and let $M$ be a finite torsion free module. By Lemma 15.22.7 we see that $M \\subset A^{\\oplus n}$ for some $n$. We argue that $M$ is free by induction on $n$. The case $n = 1$ expresses exactly the fact that $A$ is a PID. If $n > 1$ let $M\' \\subset A^{\\oplus n - 1}$ be the image of the projection onto the last $n - 1$ summands of $A^{\\oplus n}$. Then we obtain a short exact sequence $0 \\to I \\to M \\to M\' \\to 0$ where $I$ is the intersection of $M$ with the first summand $A$ of $A^{\\oplus n}$. By induction we see that $M$ is an extension of finite free $A$-modules, whence finite free. \n      $\\square$\n    \n",\n  Lemma 15.22.11. Let $A$ be a Dedekind domain (for example a discrete valuation ring or more generally a PID). \n  \n  \nAn $A$-module is flat if and only if it is torsion free. \n\n\nA finite torsion free $A$-module is finite locally free. \n\n\nA finite torsion free $A$-module is finite free if $A$ is a PID. \n\n\n\n\n    \n,"Proof.\n      (For the parenthetical remark in the statement of the lemma, see Algebra, Lemma 10.120.15.) Proof of (1). By Lemma 15.22.6 and Algebra, Lemma 10.39.18 it suffices to check the statement over $A_\\mathfrak m$ for $\\mathfrak m \\subset A$ maximal. Since $A_\\mathfrak m$ is a discrete valuation ring (Algebra, Lemma 10.120.17) we win by Lemma 15.22.10. \n    \n      Proof of (2). Follows from Algebra, Lemma 10.78.2 and (1). \n    \n      Proof of (3). Let $A$ be a PID and let $M$ be a finite torsion free module. By Lemma 15.22.7 we see that $M \\subset A^{\\oplus n}$ for some $n$. We argue that $M$ is free by induction on $n$. The case $n = 1$ expresses exactly the fact that $A$ is a PID. If $n > 1$ let $M\' \\subset A^{\\oplus n - 1}$ be the image of the projection onto the last $n - 1$ summands of $A^{\\oplus n}$. Then we obtain a short exact sequence $0 \\to I \\to M \\to M\' \\to 0$ where $I$ is the intersection of $M$ with the first summand $A$ of $A^{\\oplus n}$. By induction we see that $M$ is an extension of finite free $A$-modules, whence finite free. \n      $\\square$\n    \n"," by
  apply flat_iff_torsion_eq_bot_of_valuationRing_localization_isMaximal
  exact fun P â†¦ inferInstance
","theorem _root_.IsDedekindDomain.flat_iff_torsion_eq_bot [IsDedekindDomain R] :
    Flat R M â†” torsion R M = âŠ¥ ","Proof.\n      (For the parenthetical remark in the statement of the lemma, see Algebra, Lemma 10.120.15 [[\n  Lemma 10.120.15. A PID is a Dedekind domain. \n\n    \n]].) Proof of (1). By Lemma 15.22.6 [[\n  Lemma 15.22.6. Let $R$ be a domain. Let $M$ be an $R$-module. Then $M$ is torsion free if and only if $M_\\mathfrak m$ is a torsion free $R_\\mathfrak m$-module for all maximal ideals $\\mathfrak m$ of $R$. \n\n    \n]] and Algebra, Lemma 10.39.18 [[\n  Lemma 10.39.18. Let $R$ be a ring. Let $S \\subset R$ be a multiplicative subset. \n  \n  \nThe localization $S^{-1}R$ is a flat $R$-algebra. \n\n\nIf $M$ is an $S^{-1}R$-module, then $M$ is a flat $R$-module if and only if $M$ is a flat $S^{-1}R$-module. \n\n\nSuppose $M$ is an $R$-module. Then $M$ is a flat $R$-module if and only if $M_{\\mathfrak p}$ is a flat $R_{\\mathfrak p}$-module for all primes $\\mathfrak p$ of $R$. \n\n\nSuppose $M$ is an $R$-module. Then $M$ is a flat $R$-module if and only if $M_{\\mathfrak m}$ is a flat $R_{\\mathfrak m}$-module for all maximal ideals $\\mathfrak m$ of $R$. \n\n\nSuppose $R \\to A$ is a ring map, $M$ is an $A$-module, and $g_1, \\ldots , g_ m \\in A$ are elements generating the unit ideal of $A$. Then $M$ is flat over $R$ if and only if each localization $M_{g_ i}$ is flat over $R$. \n\n\nSuppose $R \\to A$ is a ring map, and $M$ is an $A$-module. Then $M$ is a flat $R$-module if and only if the localization $M_{\\mathfrak q}$ is a flat $R_{\\mathfrak p}$-module (with $\\mathfrak p$ the prime of $R$ lying under $\\mathfrak q$) for all primes $\\mathfrak q$ of $A$. \n\n\nSuppose $R \\to A$ is a ring map, and $M$ is an $A$-module. Then $M$ is a flat $R$-module if and only if the localization $M_{\\mathfrak m}$ is a flat $R_{\\mathfrak p}$-module (with $\\mathfrak p = R \\cap \\mathfrak m$) for all maximal ideals $\\mathfrak m$ of $A$. \n\n\n\n\n    \n]] it suffices to check the statement over $A_\\mathfrak m$ for $\\mathfrak m \\subset A$ maximal. Since $A_\\mathfrak m$ is a discrete valuation ring (Algebra, Lemma 10.120.17 [[\n  Lemma 10.120.17. Let $R$ be a ring. The following are equivalent \n  \n  \n$R$ is a Dedekind domain, \n\n\n$R$ is a Noetherian domain and for every nonzero maximal ideal $\\mathfrak m$ the local ring $R_{\\mathfrak m}$ is a discrete valuation ring, and \n\n\n$R$ is a Noetherian, normal domain, and $\\dim (R) \\leq 1$. \n\n\n\n\n    \n]]) we win by Lemma 15.22.10 [[\n  Lemma 15.22.10. Let $A$ be a valuation ring. An $A$-module $M$ is flat over $A$ if and only if $M$ is torsion free. \n\n    \n]]. \n    \n      Proof of (2). Follows from Algebra, Lemma 10.78.2 [[\n  Lemma 10.78.2. Let $R$ be a ring and let $M$ be an $R$-module. The following are equivalent \n  \n  \n$M$ is finitely presented and $R$-flat, \n\n\n$M$ is finite projective, \n\n\n$M$ is a direct summand of a finite free $R$-module, \n\n\n$M$ is finitely presented and for all $\\mathfrak p \\in \\mathop{\\mathrm{Spec}}(R)$ the localization $M_{\\mathfrak p}$ is free, \n\n\n$M$ is finitely presented and for all maximal ideals $\\mathfrak m \\subset R$ the localization $M_{\\mathfrak m}$ is free, \n\n\n$M$ is finite and locally free, \n\n\n$M$ is finite locally free, and \n\n\n$M$ is finite, for every prime $\\mathfrak p$ the module $M_{\\mathfrak p}$ is free, and the function \n\n\n  \\[  \\rho _ M : \\mathop{\\mathrm{Spec}}(R) \\to \\mathbf{Z}, \\quad \\mathfrak p \\longmapsto \\dim _{\\kappa (\\mathfrak p)} M \\otimes _ R \\kappa (\\mathfrak p)  \\]\n\n\n is locally constant in the Zariski topology. \n\n\n\n\n    \n]] and (1). \n    \n      Proof of (3). Let $A$ be a PID and let $M$ be a finite torsion free module. By Lemma 15.22.7 [[\n  Lemma 15.22.7. Let $R$ be a domain. Let $M$ be a finite $R$-module. Then $M$ is torsion free if and only if $M$ is a submodule of a finite free module. \n\n    \n]] we see that $M \\subset A^{\\oplus n}$ for some $n$. We argue that $M$ is free by induction on $n$. The case $n = 1$ expresses exactly the fact that $A$ is a PID. If $n > 1$ let $M\' \\subset A^{\\oplus n - 1}$ be the image of the projection onto the last $n - 1$ summands of $A^{\\oplus n}$. Then we obtain a short exact sequence $0 \\to I \\to M \\to M\' \\to 0$ where $I$ is the intersection of $M$ with the first summand $A$ of $A^{\\oplus n}$. By induction we see that $M$ is an extension of finite free $A$-modules, whence finite free. \n      $\\square$\n    \n"
280,00HV,"class Algebra.HasGoingDown (R S : Type*) [CommRing R] [CommRing S] [Algebra R S] : Prop where
  exists_ideal_le_liesOver_of_lt {p : Ideal R} [p.IsPrime] (Q : Ideal S) [Q.IsPrime] :
    p < Q.under R â†’ âˆƒ P â‰¤ Q, P.IsPrime âˆ§ P.LiesOver p
",Formal Proof of Stacks Project Tag 00HV,(2),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Ideal/GoingDown.lean#L44-L46,Q27041,,10.41.1,definition,3.0,"['00HU', '00AO', '0ELQ']","\n  Definition 10.41.1. Let $\\varphi : R \\to S$ be a ring map. \n  \n  \nWe say a $\\varphi : R \\to S$ satisfies going up if given primes $\\mathfrak p \\subset \\mathfrak p\'$ in $R$ and a prime $\\mathfrak q$ in $S$ lying over $\\mathfrak p$ there exists a prime $\\mathfrak q\'$ of $S$ such that (a) $\\mathfrak q \\subset \\mathfrak q\'$, and (b) $\\mathfrak q\'$ lies over $\\mathfrak p\'$. \n\n\nWe say a $\\varphi : R \\to S$ satisfies going down if given primes $\\mathfrak p \\subset \\mathfrak p\'$ in $R$ and a prime $\\mathfrak q\'$ in $S$ lying over $\\mathfrak p\'$ there exists a prime $\\mathfrak q$ of $S$ such that (a) $\\mathfrak q \\subset \\mathfrak q\'$, and (b) $\\mathfrak q$ lies over $\\mathfrak p$. \n\n\n\n","\n  Definition 10.41.1. Let $\\varphi : R \\to S$ be a ring map. \n  \n  \nWe say a $\\varphi : R \\to S$ satisfies going up if given primes $\\mathfrak p \\subset \\mathfrak p\'$ in $R$ and a prime $\\mathfrak q$ in $S$ lying over $\\mathfrak p$ there exists a prime $\\mathfrak q\'$ of $S$ such that (a) $\\mathfrak q \\subset \\mathfrak q\'$, and (b) $\\mathfrak q\'$ lies over $\\mathfrak p\'$. \n\n\nWe say a $\\varphi : R \\to S$ satisfies going down if given primes $\\mathfrak p \\subset \\mathfrak p\'$ in $R$ and a prime $\\mathfrak q\'$ in $S$ lying over $\\mathfrak p\'$ there exists a prime $\\mathfrak q$ of $S$ such that (a) $\\mathfrak q \\subset \\mathfrak q\'$, and (b) $\\mathfrak q$ lies over $\\mathfrak p$. \n\n\n\n",,,"class Algebra.HasGoingDown (R S : Type*) [CommRing R] [CommRing S] [Algebra R S] : Prop where
  exists_ideal_le_liesOver_of_lt {p : Ideal R} [p.IsPrime] (Q : Ideal S) [Q.IsPrime] :
    p < Q.under R â†’ âˆƒ P â‰¤ Q, P.IsPrime âˆ§ P.LiesOver p
",
281,00HW,"lemma iff_generalizingMap_primeSpectrumComap :
    Algebra.HasGoingDown R S â†”
      GeneralizingMap (PrimeSpectrum.comap (algebraMap R S)) := by
  refine âŸ¨?_, fun h â†¦ âŸ¨fun {p} hp Q hQ hlt â†¦ ?_âŸ©âŸ©
  Â· intro h Q p hp
    rw [â† PrimeSpectrum.le_iff_specializes] at hp
    obtain âŸ¨P, hle, hP, hâŸ© := Q.asIdeal.exists_ideal_le_liesOver_of_le (p := p.asIdeal)
      (q := Q.asIdeal.under R) hp
    refine âŸ¨âŸ¨P, hPâŸ©, (PrimeSpectrum.le_iff_specializes _ Q).mp hle, ?_âŸ©
    ext : 1
    exact h.over.symm
  Â· have : (âŸ¨p, hpâŸ© : PrimeSpectrum R) â¤³ (PrimeSpectrum.comap (algebraMap R S) âŸ¨Q, hQâŸ©) :=
      (PrimeSpectrum.le_iff_specializes _ _).mp hlt.le
    obtain âŸ¨P, hs, heqâŸ© := h this
    refine âŸ¨P.asIdeal, (PrimeSpectrum.le_iff_specializes _ _).mpr hs, P.2, âŸ¨?_âŸ©âŸ©
    simpa [PrimeSpectrum.ext_iff] using heq.symm
",Formal Proof of Stacks Project Tag 00HW,(1),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Ideal/GoingDown.lean#L106-L121,Q27041,,10.41.3,lemma,3.0,"['00HU', '00AO', '0ELQ']","\n  Lemma 10.41.3. Let $R \\to S$ be a ring map. \n  \n  \n$R \\to S$ satisfies going down if and only if generalizations lift along the map $\\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R)$, see Topology, Definition 5.19.4. \n\n\n$R \\to S$ satisfies going up if and only if specializations lift along the map $\\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R)$, see Topology, Definition 5.19.4. \n\n\n\n\n    \n      Proof.\n      Omitted. \n      $\\square$\n    \n","\n  Lemma 10.41.3. Let $R \\to S$ be a ring map. \n  \n  \n$R \\to S$ satisfies going down if and only if generalizations lift along the map $\\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R)$, see Topology, Definition 5.19.4. \n\n\n$R \\to S$ satisfies going up if and only if specializations lift along the map $\\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R)$, see Topology, Definition 5.19.4. \n\n\n\n\n    \n",Proof.\n      Omitted. \n      $\\square$\n    \n," by
  refine âŸ¨?_, fun h â†¦ âŸ¨fun {p} hp Q hQ hlt â†¦ ?_âŸ©âŸ©
  Â· intro h Q p hp
    rw [â† PrimeSpectrum.le_iff_specializes] at hp
    obtain âŸ¨P, hle, hP, hâŸ© := Q.asIdeal.exists_ideal_le_liesOver_of_le (p := p.asIdeal)
      (q := Q.asIdeal.under R) hp
    refine âŸ¨âŸ¨P, hPâŸ©, (PrimeSpectrum.le_iff_specializes _ Q).mp hle, ?_âŸ©
    ext : 1
    exact h.over.symm
  Â· have : (âŸ¨p, hpâŸ© : PrimeSpectrum R) â¤³ (PrimeSpectrum.comap (algebraMap R S) âŸ¨Q, hQâŸ©) :=
      (PrimeSpectrum.le_iff_specializes _ _).mp hlt.le
    obtain âŸ¨P, hs, heqâŸ© := h this
    refine âŸ¨P.asIdeal, (PrimeSpectrum.le_iff_specializes _ _).mpr hs, P.2, âŸ¨?_âŸ©âŸ©
    simpa [PrimeSpectrum.ext_iff] using heq.symm
","lemma iff_generalizingMap_primeSpectrumComap :
    Algebra.HasGoingDown R S â†”
      GeneralizingMap (PrimeSpectrum.comap (algebraMap R S)) ",Proof.\n      Omitted. \n      $\\square$\n    \n
282,00HX,"lemma trans (T : Type*) [CommRing T] [Algebra R T] [Algebra S T] [IsScalarTower R S T]
    [Algebra.HasGoingDown R S] [Algebra.HasGoingDown S T] :
    Algebra.HasGoingDown R T := by
  rw [iff_generalizingMap_primeSpectrumComap, IsScalarTower.algebraMap_eq R S T]
  simp only [PrimeSpectrum.comap_comp]
  apply GeneralizingMap.comp
  Â· rwa [â† iff_generalizingMap_primeSpectrumComap]
  Â· rwa [â† iff_generalizingMap_primeSpectrumComap]
",Formal Proof of Stacks Project Tag 00HX,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Ideal/GoingDown.lean#L125-L132,Q27041,,10.41.4,lemma,3.0,"['00HU', '00AO', '0ELQ']","\n  Lemma 10.41.4. Suppose $R \\to S$ and $S \\to T$ are ring maps satisfying going down. Then so does $R \\to T$. Similarly for going up. \n\n    \n      Proof.\n      According to Lemma 10.41.3 this follows from Topology, Lemma 5.19.5 \n      $\\square$\n    \n",\n  Lemma 10.41.4. Suppose $R \\to S$ and $S \\to T$ are ring maps satisfying going down. Then so does $R \\to T$. Similarly for going up. \n\n    \n,"Proof.\n      According to Lemma 10.41.3 this follows from Topology, Lemma 5.19.5 \n      $\\square$\n    \n"," by
  rw [iff_generalizingMap_primeSpectrumComap, IsScalarTower.algebraMap_eq R S T]
  simp only [PrimeSpectrum.comap_comp]
  apply GeneralizingMap.comp
  Â· rwa [â† iff_generalizingMap_primeSpectrumComap]
  Â· rwa [â† iff_generalizingMap_primeSpectrumComap]
","lemma trans (T : Type*) [CommRing T] [Algebra R T] [Algebra S T] [IsScalarTower R S T]
    [Algebra.HasGoingDown R S] [Algebra.HasGoingDown S T] :
    Algebra.HasGoingDown R T ","Proof.\n      According to Lemma 10.41.3 [[\n  Lemma 10.41.3. Let $R \\to S$ be a ring map. \n  \n  \n$R \\to S$ satisfies going down if and only if generalizations lift along the map $\\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R)$, see Topology, Definition 5.19.4. \n\n\n$R \\to S$ satisfies going up if and only if specializations lift along the map $\\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R)$, see Topology, Definition 5.19.4. \n\n\n\n\n    \n]] this follows from Topology, Lemma 5.19.5 [[\n  Lemma 5.19.5. Suppose $f : X \\to Y$ and $g : Y \\to Z$ are continuous maps of topological spaces. If specializations lift along both $f$ and $g$ then specializations lift along $g \\circ f$. Similarly for \xe2\x80\x9cgeneralizations lift along\xe2\x80\x9d. \n\n    \n]] \n      $\\square$\n    \n"
283,00HS,"instance of_flat [Module.Flat R S] : Algebra.HasGoingDown R S := by
  apply of_comap_localRingHom_surjective
  intro P hP
  have : IsLocalHom (algebraMap (Localization.AtPrime <| P.under R) (Localization.AtPrime P)) := by
    rw [RingHom.algebraMap_toAlgebra]
    exact Localization.isLocalHom_localRingHom (P.under R) P (algebraMap R S) Ideal.LiesOver.over
  have : Module.FaithfullyFlat (Localization.AtPrime (P.under R)) (Localization.AtPrime P) :=
    Module.FaithfullyFlat.of_flat_of_isLocalHom
  apply PrimeSpectrum.comap_surjective_of_faithfullyFlat
",Formal Proof of Stacks Project Tag 00HS,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Ideal/GoingDown.lean#L153-L161,Q27041,,10.39.19,lemma,3.0,"['00H9', '00AO', '0ELQ']",\n  Lemma 10.39.19. Let $R \\to S$ be flat. Let $\\mathfrak p \\subset \\mathfrak p\'$ be primes of $R$. Let $\\mathfrak q\' \\subset S$ be a prime of $S$ mapping to $\\mathfrak p\'$. Then there exists a prime $\\mathfrak q \\subset \\mathfrak q\'$ mapping to $\\mathfrak p$. \n\n    \n      Proof.\n      By Lemma 10.39.18 the local ring map $R_{\\mathfrak p\'} \\to S_{\\mathfrak q\'}$ is flat. By Lemma 10.39.17 this local ring map is faithfully flat. By Lemma 10.39.16 there is a prime mapping to $\\mathfrak p R_{\\mathfrak p\'}$. The inverse image of this prime in $S$ does the job. \n      $\\square$\n    \n,\n  Lemma 10.39.19. Let $R \\to S$ be flat. Let $\\mathfrak p \\subset \\mathfrak p\'$ be primes of $R$. Let $\\mathfrak q\' \\subset S$ be a prime of $S$ mapping to $\\mathfrak p\'$. Then there exists a prime $\\mathfrak q \\subset \\mathfrak q\'$ mapping to $\\mathfrak p$. \n\n    \n,Proof.\n      By Lemma 10.39.18 the local ring map $R_{\\mathfrak p\'} \\to S_{\\mathfrak q\'}$ is flat. By Lemma 10.39.17 this local ring map is faithfully flat. By Lemma 10.39.16 there is a prime mapping to $\\mathfrak p R_{\\mathfrak p\'}$. The inverse image of this prime in $S$ does the job. \n      $\\square$\n    \n," by
  apply of_comap_localRingHom_surjective
  intro P hP
  have : IsLocalHom (algebraMap (Localization.AtPrime <| P.under R) (Localization.AtPrime P)) := by
    rw [RingHom.algebraMap_toAlgebra]
    exact Localization.isLocalHom_localRingHom (P.under R) P (algebraMap R S) Ideal.LiesOver.over
  have : Module.FaithfullyFlat (Localization.AtPrime (P.under R)) (Localization.AtPrime P) :=
    Module.FaithfullyFlat.of_flat_of_isLocalHom
  apply PrimeSpectrum.comap_surjective_of_faithfullyFlat
",instance of_flat [Module.Flat R S] : Algebra.HasGoingDown R S ,"Proof.\n      By Lemma 10.39.18 [[\n  Lemma 10.39.18. Let $R$ be a ring. Let $S \\subset R$ be a multiplicative subset. \n  \n  \nThe localization $S^{-1}R$ is a flat $R$-algebra. \n\n\nIf $M$ is an $S^{-1}R$-module, then $M$ is a flat $R$-module if and only if $M$ is a flat $S^{-1}R$-module. \n\n\nSuppose $M$ is an $R$-module. Then $M$ is a flat $R$-module if and only if $M_{\\mathfrak p}$ is a flat $R_{\\mathfrak p}$-module for all primes $\\mathfrak p$ of $R$. \n\n\nSuppose $M$ is an $R$-module. Then $M$ is a flat $R$-module if and only if $M_{\\mathfrak m}$ is a flat $R_{\\mathfrak m}$-module for all maximal ideals $\\mathfrak m$ of $R$. \n\n\nSuppose $R \\to A$ is a ring map, $M$ is an $A$-module, and $g_1, \\ldots , g_ m \\in A$ are elements generating the unit ideal of $A$. Then $M$ is flat over $R$ if and only if each localization $M_{g_ i}$ is flat over $R$. \n\n\nSuppose $R \\to A$ is a ring map, and $M$ is an $A$-module. Then $M$ is a flat $R$-module if and only if the localization $M_{\\mathfrak q}$ is a flat $R_{\\mathfrak p}$-module (with $\\mathfrak p$ the prime of $R$ lying under $\\mathfrak q$) for all primes $\\mathfrak q$ of $A$. \n\n\nSuppose $R \\to A$ is a ring map, and $M$ is an $A$-module. Then $M$ is a flat $R$-module if and only if the localization $M_{\\mathfrak m}$ is a flat $R_{\\mathfrak p}$-module (with $\\mathfrak p = R \\cap \\mathfrak m$) for all maximal ideals $\\mathfrak m$ of $A$. \n\n\n\n\n    \n]] the local ring map $R_{\\mathfrak p\'} \\to S_{\\mathfrak q\'}$ is flat. By Lemma 10.39.17 [[\n  Lemma 10.39.17. A flat local ring homomorphism of local rings is faithfully flat. \n\n    \n]] this local ring map is faithfully flat. By Lemma 10.39.16 [[\n  Lemma 10.39.16. Let $R \\to S$ be a flat ring map. The following are equivalent: \n  \n  \n$R \\to S$ is faithfully flat, \n\n\nthe induced map on $\\mathop{\\mathrm{Spec}}$ is surjective, and \n\n\nany closed point $x \\in \\mathop{\\mathrm{Spec}}(R)$ is in the image of the map $\\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R)$. \n\n\n\n\n    \n]] there is a prime mapping to $\\mathfrak p R_{\\mathfrak p\'}$. The inverse image of this prime in $S$ does the job. \n      $\\square$\n    \n"
284,00OM,"lemma Ideal.height_le_height_add_of_liesOver [IsNoetherianRing S] (p : Ideal R) [p.IsPrime]
      (P : Ideal S) [P.IsPrime] [P.LiesOver p] :
    P.height â‰¤ p.height +
      (P.map (Ideal.Quotient.mk <| p.map (algebraMap R S))).height := by
  classical
  obtain âŸ¨s, hp, heqâŸ© := p.exists_finset_card_eq_height_of_isNoetherianRing
  let P' := P.map (Ideal.Quotient.mk <| p.map (algebraMap R S))
  obtain âŸ¨s', hP', heq'âŸ© := P'.exists_finset_card_eq_height_of_isNoetherianRing
  have hsP'sub : (s' : Set <| S â§¸ (Ideal.map (algebraMap R S) p)) âŠ† (P' : Set <| S â§¸ _) :=
    fun x hx â†¦ hP'.1.2 (Ideal.subset_span hx)
  have : Set.SurjOn (Ideal.Quotient.mk (p.map (algebraMap R S))) P s' := by
    refine Set.SurjOn.mono subset_rfl hsP'sub fun x hx â†¦ ?_
    obtain âŸ¨y, rflâŸ© := Ideal.Quotient.mk_surjective x
    rw [SetLike.mem_coe, Ideal.mem_quotient_iff_mem] at hx
    Â· use y, hx
    Â· rw [Ideal.map_le_iff_le_comap, Ideal.LiesOver.over (p := p) (P := P)]
  obtain âŸ¨o, ho, hinj, himgoâŸ© := s'.exists_subset_injOn_image_eq_of_surjOn (P : Set S) this
  let t : Finset S := Finset.image (algebraMap R S) s âˆª o
  suffices h : P.height â‰¤ t.card by
    rw [â† heq, â† heq']
    apply le_trans h
    norm_cast
    refine le_trans (Finset.card_union_le _ _) (add_le_add Finset.card_image_le ?_)
    rw [â† himgo, Finset.card_image_of_injOn hinj]
  refine Ideal.height_le_card_of_mem_minimalPrimes_span_finset ?_
  have : Ideal.span t = Ideal.map (algebraMap R S) (.span s) âŠ” .span o := by
    simp [t, Ideal.span_union, Ideal.map_span]
  refine this â–¸ map_sup_mem_minimalPrimes_of_map_quotientMk_mem_minimalPrimes hp (span_le.mpr ho) ?_
  convert hP'
  simp [Ideal.map_span, â† himgo]
",Formal Proof of Stacks Project Tag 00OM,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Ideal/KrullsHeightTheorem.lean#L323-L352,Q27041,,10.112.6,lemma,3.0,"['00OG', '00AO', '0ELQ']","\n  Lemma 10.112.6. Let $R \\to S$ be a homomorphism of Noetherian rings. Let $\\mathfrak q \\subset S$ be a prime lying over the prime $\\mathfrak p$. Then \n  \n  \\[  \\dim (S_{\\mathfrak q}) \\leq \\dim (R_{\\mathfrak p}) + \\dim (S_{\\mathfrak q}/\\mathfrak pS_{\\mathfrak q}).  \\]\n\n\n    \n      Proof.\n      We use the characterization of dimension of Proposition 10.60.9. Let $x_1, \\ldots , x_ d$ be elements of $\\mathfrak p$ generating an ideal of definition of $R_{\\mathfrak p}$ with $d = \\dim (R_{\\mathfrak p})$. Let $y_1, \\ldots , y_ e$ be elements of $\\mathfrak q$ generating an ideal of definition of $S_{\\mathfrak q}/\\mathfrak pS_{\\mathfrak q}$ with $e = \\dim (S_{\\mathfrak q}/\\mathfrak pS_{\\mathfrak q})$. It is clear that $S_{\\mathfrak q}/(x_1, \\ldots , x_ d, y_1, \\ldots , y_ e)$ has a nilpotent maximal ideal. Hence $x_1, \\ldots , x_ d, y_1, \\ldots , y_ e$ generate an ideal of definition of $S_{\\mathfrak q}$. \n      $\\square$\n    \n",\n  Lemma 10.112.6. Let $R \\to S$ be a homomorphism of Noetherian rings. Let $\\mathfrak q \\subset S$ be a prime lying over the prime $\\mathfrak p$. Then \n  \n  \\[  \\dim (S_{\\mathfrak q}) \\leq \\dim (R_{\\mathfrak p}) + \\dim (S_{\\mathfrak q}/\\mathfrak pS_{\\mathfrak q}).  \\]\n\n\n    \n,"Proof.\n      We use the characterization of dimension of Proposition 10.60.9. Let $x_1, \\ldots , x_ d$ be elements of $\\mathfrak p$ generating an ideal of definition of $R_{\\mathfrak p}$ with $d = \\dim (R_{\\mathfrak p})$. Let $y_1, \\ldots , y_ e$ be elements of $\\mathfrak q$ generating an ideal of definition of $S_{\\mathfrak q}/\\mathfrak pS_{\\mathfrak q}$ with $e = \\dim (S_{\\mathfrak q}/\\mathfrak pS_{\\mathfrak q})$. It is clear that $S_{\\mathfrak q}/(x_1, \\ldots , x_ d, y_1, \\ldots , y_ e)$ has a nilpotent maximal ideal. Hence $x_1, \\ldots , x_ d, y_1, \\ldots , y_ e$ generate an ideal of definition of $S_{\\mathfrak q}$. \n      $\\square$\n    \n"," by
  classical
  obtain âŸ¨s, hp, heqâŸ© := p.exists_finset_card_eq_height_of_isNoetherianRing
  let P' := P.map (Ideal.Quotient.mk <| p.map (algebraMap R S))
  obtain âŸ¨s', hP', heq'âŸ© := P'.exists_finset_card_eq_height_of_isNoetherianRing
  have hsP'sub : (s' : Set <| S â§¸ (Ideal.map (algebraMap R S) p)) âŠ† (P' : Set <| S â§¸ _) :=
    fun x hx â†¦ hP'.1.2 (Ideal.subset_span hx)
  have : Set.SurjOn (Ideal.Quotient.mk (p.map (algebraMap R S))) P s' := by
    refine Set.SurjOn.mono subset_rfl hsP'sub fun x hx â†¦ ?_
    obtain âŸ¨y, rflâŸ© := Ideal.Quotient.mk_surjective x
    rw [SetLike.mem_coe, Ideal.mem_quotient_iff_mem] at hx
    Â· use y, hx
    Â· rw [Ideal.map_le_iff_le_comap, Ideal.LiesOver.over (p := p) (P := P)]
  obtain âŸ¨o, ho, hinj, himgoâŸ© := s'.exists_subset_injOn_image_eq_of_surjOn (P : Set S) this
  let t : Finset S := Finset.image (algebraMap R S) s âˆª o
  suffices h : P.height â‰¤ t.card by
    rw [â† heq, â† heq']
    apply le_trans h
    norm_cast
    refine le_trans (Finset.card_union_le _ _) (add_le_add Finset.card_image_le ?_)
    rw [â† himgo, Finset.card_image_of_injOn hinj]
  refine Ideal.height_le_card_of_mem_minimalPrimes_span_finset ?_
  have : Ideal.span t = Ideal.map (algebraMap R S) (.span s) âŠ” .span o := by
    simp [t, Ideal.span_union, Ideal.map_span]
  refine this â–¸ map_sup_mem_minimalPrimes_of_map_quotientMk_mem_minimalPrimes hp (span_le.mpr ho) ?_
  convert hP'
  simp [Ideal.map_span, â† himgo]
","lemma Ideal.height_le_height_add_of_liesOver [IsNoetherianRing S] (p : Ideal R) [p.IsPrime]
      (P : Ideal S) [P.IsPrime] [P.LiesOver p] :
    P.height â‰¤ p.height +
      (P.map (Ideal.Quotient.mk <| p.map (algebraMap R S))).height ","Proof.\n      We use the characterization of dimension of Proposition 10.60.9 [[\n  Proposition 10.60.9. Let $R$ be a local Noetherian ring. Let $d \\geq 0$ be an integer. The following are equivalent: \n  \n  \n $\\dim (R) = d$, \n\n\n $d(R) = d$, \n\n\n there exists an ideal of definition generated by $d$ elements, and no ideal of definition is generated by fewer than $d$ elements. \n\n\n\n\n    \n]]. Let $x_1, \\ldots , x_ d$ be elements of $\\mathfrak p$ generating an ideal of definition of $R_{\\mathfrak p}$ with $d = \\dim (R_{\\mathfrak p})$. Let $y_1, \\ldots , y_ e$ be elements of $\\mathfrak q$ generating an ideal of definition of $S_{\\mathfrak q}/\\mathfrak pS_{\\mathfrak q}$ with $e = \\dim (S_{\\mathfrak q}/\\mathfrak pS_{\\mathfrak q})$. It is clear that $S_{\\mathfrak q}/(x_1, \\ldots , x_ d, y_1, \\ldots , y_ e)$ has a nilpotent maximal ideal. Hence $x_1, \\ldots , x_ d, y_1, \\ldots , y_ e$ generate an ideal of definition of $S_{\\mathfrak q}$. \n      $\\square$\n    \n"
285,00ON,"lemma Ideal.height_eq_height_add_of_liesOver_of_hasGoingDown [IsNoetherianRing S]
    [Algebra.HasGoingDown R S] (p : Ideal R) [p.IsPrime] (P : Ideal S) [P.IsPrime] [P.LiesOver p] :
    P.height = p.height +
      (P.map (Ideal.Quotient.mk <| p.map (algebraMap R S))).height := by
  refine le_antisymm (height_le_height_add_of_liesOver p P) ?_
  obtain âŸ¨lp, hlp, hlenpâŸ© := p.exists_ltSeries_length_eq_height
  obtain âŸ¨lq, hlq, hlenqâŸ© :=
    (P.map (Quotient.mk (p.map (algebraMap R S)))).exists_ltSeries_length_eq_height
  let l' : LTSeries (PrimeSpectrum S) :=
    lq.map (PrimeSpectrum.comap (Quotient.mk (p.map (algebraMap R S))))
      (RingHom.strictMono_comap_of_surjective Quotient.mk_surjective)
  have : l'.head.asIdeal.LiesOver lp.last.asIdeal := by
    simp only [LTSeries.head_map, hlp, l']
    refine âŸ¨?_âŸ©
    refine le_antisymm ?_ ?_
    Â· rw [â† map_le_iff_le_comap, PrimeSpectrum.comap_asIdeal, â† map_le_iff_le_comap]
      simp
    Â· conv_rhs => rw [LiesOver.over (p := p) (P := P), under_def]
      refine comap_mono (le_trans (comap_mono (lq.head_le_last)) ?_)
      simp [hlq, map_le_iff_le_comap, LiesOver.over (p := p) (P := P)]
  obtain âŸ¨lp', hlp'len, hlp', _âŸ© := exists_ltSeries_of_hasGoingDown lp l'.head.asIdeal
  have : (lp'.smash l' hlp').length = lp.length + lq.length := by simp [hlp'len, l']
  rw [â† hlenp, â† hlenq, â† Nat.cast_add, â† this, height_eq_primeHeight]
  apply Order.length_le_height
  simp [hlq, l', â† PrimeSpectrum.asIdeal_le_asIdeal, map_le_iff_le_comap,
    LiesOver.over (p := p) (P := P)]
",Formal Proof of Stacks Project Tag 00ON,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Ideal/KrullsHeightTheorem.lean#L360-L385,Q27041,,10.112.7,lemma,3.0,"['00OG', '00AO', '0ELQ']","\n  Lemma 10.112.7. Let $R \\to S$ be a homomorphism of Noetherian rings. Let $\\mathfrak q \\subset S$ be a prime lying over the prime $\\mathfrak p$. Assume the going down property holds for $R \\to S$ (for example if $R \\to S$ is flat, see Lemma 10.39.19). Then \n  \n  \\[  \\dim (S_{\\mathfrak q}) = \\dim (R_{\\mathfrak p}) + \\dim (S_{\\mathfrak q}/\\mathfrak pS_{\\mathfrak q}).  \\]\n\n\n    \n      Proof.\n      By Lemma 10.112.6 we have an inequality $\\dim (S_{\\mathfrak q}) \\leq \\dim (R_{\\mathfrak p}) + \\dim (S_{\\mathfrak q}/\\mathfrak pS_{\\mathfrak q})$. To get equality, choose a chain of primes $\\mathfrak pS \\subset \\mathfrak q_0 \\subset \\mathfrak q_1 \\subset \\ldots \\subset \\mathfrak q_ d = \\mathfrak q$ with $d = \\dim (S_{\\mathfrak q}/\\mathfrak pS_{\\mathfrak q})$. On the other hand, choose a chain of primes $\\mathfrak p_0 \\subset \\mathfrak p_1 \\subset \\ldots \\subset \\mathfrak p_ e = \\mathfrak p$ with $e = \\dim (R_{\\mathfrak p})$. By the going down theorem we may choose $\\mathfrak q_{-1} \\subset \\mathfrak q_0$ lying over $\\mathfrak p_{e-1}$. And then we may choose $\\mathfrak q_{-2} \\subset \\mathfrak q_{-1}$ lying over $\\mathfrak p_{e-2}$. Inductively we keep going until we get a chain $\\mathfrak q_{-e} \\subset \\ldots \\subset \\mathfrak q_ d$ of length $e + d$. \n      $\\square$\n    \n","\n  Lemma 10.112.7. Let $R \\to S$ be a homomorphism of Noetherian rings. Let $\\mathfrak q \\subset S$ be a prime lying over the prime $\\mathfrak p$. Assume the going down property holds for $R \\to S$ (for example if $R \\to S$ is flat, see Lemma 10.39.19). Then \n  \n  \\[  \\dim (S_{\\mathfrak q}) = \\dim (R_{\\mathfrak p}) + \\dim (S_{\\mathfrak q}/\\mathfrak pS_{\\mathfrak q}).  \\]\n\n\n    \n","Proof.\n      By Lemma 10.112.6 we have an inequality $\\dim (S_{\\mathfrak q}) \\leq \\dim (R_{\\mathfrak p}) + \\dim (S_{\\mathfrak q}/\\mathfrak pS_{\\mathfrak q})$. To get equality, choose a chain of primes $\\mathfrak pS \\subset \\mathfrak q_0 \\subset \\mathfrak q_1 \\subset \\ldots \\subset \\mathfrak q_ d = \\mathfrak q$ with $d = \\dim (S_{\\mathfrak q}/\\mathfrak pS_{\\mathfrak q})$. On the other hand, choose a chain of primes $\\mathfrak p_0 \\subset \\mathfrak p_1 \\subset \\ldots \\subset \\mathfrak p_ e = \\mathfrak p$ with $e = \\dim (R_{\\mathfrak p})$. By the going down theorem we may choose $\\mathfrak q_{-1} \\subset \\mathfrak q_0$ lying over $\\mathfrak p_{e-1}$. And then we may choose $\\mathfrak q_{-2} \\subset \\mathfrak q_{-1}$ lying over $\\mathfrak p_{e-2}$. Inductively we keep going until we get a chain $\\mathfrak q_{-e} \\subset \\ldots \\subset \\mathfrak q_ d$ of length $e + d$. \n      $\\square$\n    \n"," by
  refine le_antisymm (height_le_height_add_of_liesOver p P) ?_
  obtain âŸ¨lp, hlp, hlenpâŸ© := p.exists_ltSeries_length_eq_height
  obtain âŸ¨lq, hlq, hlenqâŸ© :=
    (P.map (Quotient.mk (p.map (algebraMap R S)))).exists_ltSeries_length_eq_height
  let l' : LTSeries (PrimeSpectrum S) :=
    lq.map (PrimeSpectrum.comap (Quotient.mk (p.map (algebraMap R S))))
      (RingHom.strictMono_comap_of_surjective Quotient.mk_surjective)
  have : l'.head.asIdeal.LiesOver lp.last.asIdeal := by
    simp only [LTSeries.head_map, hlp, l']
    refine âŸ¨?_âŸ©
    refine le_antisymm ?_ ?_
    Â· rw [â† map_le_iff_le_comap, PrimeSpectrum.comap_asIdeal, â† map_le_iff_le_comap]
      simp
    Â· conv_rhs => rw [LiesOver.over (p := p) (P := P), under_def]
      refine comap_mono (le_trans (comap_mono (lq.head_le_last)) ?_)
      simp [hlq, map_le_iff_le_comap, LiesOver.over (p := p) (P := P)]
  obtain âŸ¨lp', hlp'len, hlp', _âŸ© := exists_ltSeries_of_hasGoingDown lp l'.head.asIdeal
  have : (lp'.smash l' hlp').length = lp.length + lq.length := by simp [hlp'len, l']
  rw [â† hlenp, â† hlenq, â† Nat.cast_add, â† this, height_eq_primeHeight]
  apply Order.length_le_height
  simp [hlq, l', â† PrimeSpectrum.asIdeal_le_asIdeal, map_le_iff_le_comap,
    LiesOver.over (p := p) (P := P)]
","lemma Ideal.height_eq_height_add_of_liesOver_of_hasGoingDown [IsNoetherianRing S]
    [Algebra.HasGoingDown R S] (p : Ideal R) [p.IsPrime] (P : Ideal S) [P.IsPrime] [P.LiesOver p] :
    P.height = p.height +
      (P.map (Ideal.Quotient.mk <| p.map (algebraMap R S))).height ","Proof.\n      By Lemma 10.112.6 [[\n  Lemma 10.112.6. Let $R \\to S$ be a homomorphism of Noetherian rings. Let $\\mathfrak q \\subset S$ be a prime lying over the prime $\\mathfrak p$. Then \n  \n  \\[  \\dim (S_{\\mathfrak q}) \\leq \\dim (R_{\\mathfrak p}) + \\dim (S_{\\mathfrak q}/\\mathfrak pS_{\\mathfrak q}).  \\]\n\n\n    \n]] we have an inequality $\\dim (S_{\\mathfrak q}) \\leq \\dim (R_{\\mathfrak p}) + \\dim (S_{\\mathfrak q}/\\mathfrak pS_{\\mathfrak q})$. To get equality, choose a chain of primes $\\mathfrak pS \\subset \\mathfrak q_0 \\subset \\mathfrak q_1 \\subset \\ldots \\subset \\mathfrak q_ d = \\mathfrak q$ with $d = \\dim (S_{\\mathfrak q}/\\mathfrak pS_{\\mathfrak q})$. On the other hand, choose a chain of primes $\\mathfrak p_0 \\subset \\mathfrak p_1 \\subset \\ldots \\subset \\mathfrak p_ e = \\mathfrak p$ with $e = \\dim (R_{\\mathfrak p})$. By the going down theorem we may choose $\\mathfrak q_{-1} \\subset \\mathfrak q_0$ lying over $\\mathfrak p_{e-1}$. And then we may choose $\\mathfrak q_{-2} \\subset \\mathfrak q_{-1}$ lying over $\\mathfrak p_{e-2}$. Inductively we keep going until we get a chain $\\mathfrak q_{-e} \\subset \\ldots \\subset \\mathfrak q_ d$ of length $e + d$. \n      $\\square$\n    \n"
286,05K9,"structure IsOka (P : Ideal R â†’ Prop) : Prop where
  top : P âŠ¤
  oka {I : Ideal R} {a : R} : P (I âŠ” span {a}) â†’ P (I.colon (span {a})) â†’ P I
",Formal Proof of Stacks Project Tag 05K9,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Ideal/Oka.lean#L38-L40,Q27041,,10.28.2,definition,3.0,"['05K7', '00AO', '0ELQ']","\n  Definition 10.28.2. Let $R$ be a ring. Let $\\mathcal{F}$ be a set of ideals of $R$. We say $\\mathcal{F}$ is an Oka family if $R \\in \\mathcal{F}$ and whenever $I \\subset R$ is an ideal and $(I : a), (I, a) \\in \\mathcal{F}$ for some $a \\in R$, then $I \\in \\mathcal{F}$. \n","\n  Definition 10.28.2. Let $R$ be a ring. Let $\\mathcal{F}$ be a set of ideals of $R$. We say $\\mathcal{F}$ is an Oka family if $R \\in \\mathcal{F}$ and whenever $I \\subset R$ is an ideal and $(I : a), (I, a) \\in \\mathcal{F}$ for some $a \\in R$, then $I \\in \\mathcal{F}$. \n",,,"structure IsOka (P : Ideal R â†’ Prop) : Prop where
  top : P âŠ¤
  oka {I : Ideal R} {a : R} : P (I âŠ” span {a}) â†’ P (I.colon (span {a})) â†’ P I
",
287,05KE,"theorem isPrime_of_maximal_not {I : Ideal R} (hI : Maximal (Â¬P Â·) I) : I.IsPrime where
  ne_top' hI' := hI.prop (hI' â–¸ hP.top)
  mem_or_mem' := by
    by_contra! âŸ¨a, b, hab, ha, hbâŸ©
    have hâ‚ : P (I âŠ” span {a}) := of_not_not <| hI.not_prop_of_gt (Submodule.lt_sup_iff_notMem.2 ha)
    have hâ‚‚ : P (I.colon (span {a})) := of_not_not <| hI.not_prop_of_gt <| lt_of_le_of_ne le_colon
      (fun H â†¦ hb <| H â–¸ mem_colon_span_singleton.2 (mul_comm a b â–¸ hab))
    exact hI.prop (hP.oka hâ‚ hâ‚‚)
",Formal Proof of Stacks Project Tag 05KE,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Ideal/Oka.lean#L49-L56,Q27041,,10.28.8,proposition,3.0,"['05K7', '00AO', '0ELQ']","\n  Proposition 10.28.8. If $\\mathcal{F}$ is an Oka family of ideals, then any maximal element of the complement of $\\mathcal{F}$ is prime. \n\n    \n      Proof.\n      Suppose $I \\not\\in \\mathcal{F}$ is maximal with respect to not being in $\\mathcal{F}$ but $I$ is not prime. Note that $I \\not= R$ because $R \\in \\mathcal{F}$. Since $I$ is not prime we can find $a, b \\in R - I$ with $ab \\in I$. It follows that $(I, a) \\neq I$ and $(I : a)$ contains $b \\not\\in I$ so also $(I : a) \\neq I$. Thus $(I : a), (I, a)$ both strictly contain $I$, so they must belong to $\\mathcal{F}$. By the Oka condition, we have $I \\in \\mathcal{F}$, a contradiction. \n      $\\square$\n    \n","\n  Proposition 10.28.8. If $\\mathcal{F}$ is an Oka family of ideals, then any maximal element of the complement of $\\mathcal{F}$ is prime. \n\n    \n","Proof.\n      Suppose $I \\not\\in \\mathcal{F}$ is maximal with respect to not being in $\\mathcal{F}$ but $I$ is not prime. Note that $I \\not= R$ because $R \\in \\mathcal{F}$. Since $I$ is not prime we can find $a, b \\in R - I$ with $ab \\in I$. It follows that $(I, a) \\neq I$ and $(I : a)$ contains $b \\not\\in I$ so also $(I : a) \\neq I$. Thus $(I : a), (I, a)$ both strictly contain $I$, so they must belong to $\\mathcal{F}$. By the Oka condition, we have $I \\in \\mathcal{F}$, a contradiction. \n      $\\square$\n    \n"," hI.prop (hI' â–¸ hP.top)
  mem_or_mem' := by
    by_contra! âŸ¨a, b, hab, ha, hbâŸ©
    have hâ‚ : P (I âŠ” span {a}) := of_not_not <| hI.not_prop_of_gt (Submodule.lt_sup_iff_notMem.2 ha)
    have hâ‚‚ : P (I.colon (span {a})) := of_not_not <| hI.not_prop_of_gt <| lt_of_le_of_ne le_colon
      (fun H â†¦ hb <| H â–¸ mem_colon_span_singleton.2 (mul_comm a b â–¸ hab))
    exact hI.prop (hP.oka hâ‚ hâ‚‚)
","theorem isPrime_of_maximal_not {I : Ideal R} (hI : Maximal (Â¬P Â·) I) : I.IsPrime where
  ne_top' hI' ","Proof.\n      Suppose $I \\not\\in \\mathcal{F}$ is maximal with respect to not being in $\\mathcal{F}$ but $I$ is not prime. Note that $I \\not= R$ because $R \\in \\mathcal{F}$. Since $I$ is not prime we can find $a, b \\in R - I$ with $ab \\in I$. It follows that $(I, a) \\neq I$ and $(I : a)$ contains $b \\not\\in I$ so also $(I : a) \\neq I$. Thus $(I : a), (I, a)$ both strictly contain $I$, so they must belong to $\\mathcal{F}$. By the Oka condition, we have $I \\in \\mathcal{F}$, a contradiction. \n      $\\square$\n    \n"
288,00DS,"theorem subset_union_prime {R : Type u} [CommRing R] {s : Finset Î¹} {f : Î¹ â†’ Ideal R} (a b : Î¹)
    (hp : âˆ€ i âˆˆ s, i â‰  a â†’ i â‰  b â†’ IsPrime (f i)) {I : Ideal R} :
    ((I : Set R) âŠ† â‹ƒ i âˆˆ (â†‘s : Set Î¹), f i) â†” âˆƒ i âˆˆ s, I â‰¤ f i :=
  suffices ((I : Set R) âŠ† â‹ƒ i âˆˆ (â†‘s : Set Î¹), f i) â†’ âˆƒ i, i âˆˆ s âˆ§ I â‰¤ f i by
    have aux := fun h => (bex_def.2 <| this h)
    simp_rw [exists_prop] at aux
    refine âŸ¨aux, fun âŸ¨i, his, hiâŸ© â†¦ Set.Subset.trans hi ?_âŸ©
    apply Set.subset_biUnion_of_mem (show i âˆˆ (â†‘s : Set Î¹) from his)
  fun h : (I : Set R) âŠ† â‹ƒ i âˆˆ (â†‘s : Set Î¹), f i => by
  classical
    by_cases has : a âˆˆ s
    Â· obtain âŸ¨t, hat, rflâŸ© : âˆƒ t, a âˆ‰ t âˆ§ insert a t = s :=
        âŸ¨s.erase a, Finset.notMem_erase a s, Finset.insert_erase hasâŸ©
      by_cases hbt : b âˆˆ t
      Â· obtain âŸ¨u, hbu, rflâŸ© : âˆƒ u, b âˆ‰ u âˆ§ insert b u = t :=
          âŸ¨t.erase b, Finset.notMem_erase b t, Finset.insert_erase hbtâŸ©
        have hp' : âˆ€ i âˆˆ u, IsPrime (f i) := by
          intro i hiu
          refine hp i (Finset.mem_insert_of_mem (Finset.mem_insert_of_mem hiu)) ?_ ?_ <;>
              rintro rfl <;>
            solve_by_elim only [Finset.mem_insert_of_mem, *]
        rw [Finset.coe_insert, Finset.coe_insert, Set.biUnion_insert, Set.biUnion_insert, â†
          Set.union_assoc, subset_union_prime' hp'] at h
        rwa [Finset.exists_mem_insert, Finset.exists_mem_insert]
      Â· have hp' : âˆ€ j âˆˆ t, IsPrime (f j) := by
          intro j hj
          refine hp j (Finset.mem_insert_of_mem hj) ?_ ?_ <;> rintro rfl <;>
            solve_by_elim only [Finset.mem_insert_of_mem, *]
        rw [Finset.coe_insert, Set.biUnion_insert, â† Set.union_self (f a : Set R),
          subset_union_prime' hp', â† or_assoc, or_self_iff] at h
        rwa [Finset.exists_mem_insert]
    Â· by_cases hbs : b âˆˆ s
      Â· obtain âŸ¨t, hbt, rflâŸ© : âˆƒ t, b âˆ‰ t âˆ§ insert b t = s :=
          âŸ¨s.erase b, Finset.notMem_erase b s, Finset.insert_erase hbsâŸ©
        have hp' : âˆ€ j âˆˆ t, IsPrime (f j) := by
          intro j hj
          refine hp j (Finset.mem_insert_of_mem hj) ?_ ?_ <;> rintro rfl <;>
            solve_by_elim only [Finset.mem_insert_of_mem, *]
        rw [Finset.coe_insert, Set.biUnion_insert, â† Set.union_self (f b : Set R),
          subset_union_prime' hp', â† or_assoc, or_self_iff] at h
        rwa [Finset.exists_mem_insert]
      rcases s.eq_empty_or_nonempty with hse | hsne
      Â· subst hse
        rw [Finset.coe_empty, Set.biUnion_empty] at h
        exact (h I.zero_mem).elim
      Â· obtain âŸ¨i, hisâŸ© := hsne
        obtain âŸ¨t, _, rflâŸ© : âˆƒ t, i âˆ‰ t âˆ§ insert i t = s :=
          âŸ¨s.erase i, Finset.notMem_erase i s, Finset.insert_erase hisâŸ©
        have hp' : âˆ€ j âˆˆ t, IsPrime (f j) := by
          intro j hj
          refine hp j (Finset.mem_insert_of_mem hj) ?_ ?_ <;> rintro rfl <;>
            solve_by_elim only [Finset.mem_insert_of_mem, *]
        rw [Finset.coe_insert, Set.biUnion_insert, â† Set.union_self (f i : Set R),
          subset_union_prime' hp', â† or_assoc, or_self_iff] at h
        rwa [Finset.exists_mem_insert]
",Formal Proof of Stacks Project Tag 00DS,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Ideal/Operations.lean#L1137-L1191,Q27041,Prime avoidance,10.15.2,lemma,3.0,"['00DR', '00AO', '0ELQ']","\n        \n      \n  Lemma 10.15.2 (Prime avoidance). Let $R$ be a ring. Let $I_ i \\subset R$, $i = 1, \\ldots , r$, and $J \\subset R$ be ideals. Assume \n  \n  \n$J \\not\\subset I_ i$ for $i = 1, \\ldots , r$, and \n\n\nall but two of $I_ i$ are prime ideals. \n\n\n\n   Then there exists an $x \\in J$, $x\\not\\in I_ i$ for all $i$. \n\n    \n      Proof.\n      The result is true for $r = 1$. If $r = 2$, then let $x, y \\in J$ with $x \\not\\in I_1$ and $y \\not\\in I_2$. We are done unless $x \\in I_2$ and $y \\in I_1$. Then the element $x + y$ cannot be in $I_1$ (since that would mean $x + y - y \\in I_1$) and it also cannot be in $I_2$. \n    \n      For $r \\geq 3$, assume the result holds for $r - 1$. After renumbering we may assume that $I_ r$ is prime. We may also assume there are no inclusions among the $I_ i$. Pick $x \\in J$, $x \\not\\in I_ i$ for all $i = 1, \\ldots , r - 1$. If $x \\not\\in I_ r$ we are done. So assume $x \\in I_ r$. If $J I_1 \\ldots I_{r - 1} \\subset I_ r$ then $J \\subset I_ r$ (by Lemma 10.15.1) a contradiction. Pick $y \\in J I_1 \\ldots I_{r - 1}$, $y \\not\\in I_ r$. Then $x + y$ works. \n      $\\square$\n    \n","\n        \n      \n  Lemma 10.15.2 (Prime avoidance). Let $R$ be a ring. Let $I_ i \\subset R$, $i = 1, \\ldots , r$, and $J \\subset R$ be ideals. Assume \n  \n  \n$J \\not\\subset I_ i$ for $i = 1, \\ldots , r$, and \n\n\nall but two of $I_ i$ are prime ideals. \n\n\n\n   Then there exists an $x \\in J$, $x\\not\\in I_ i$ for all $i$. \n\n    \n","Proof.\n      The result is true for $r = 1$. If $r = 2$, then let $x, y \\in J$ with $x \\not\\in I_1$ and $y \\not\\in I_2$. We are done unless $x \\in I_2$ and $y \\in I_1$. Then the element $x + y$ cannot be in $I_1$ (since that would mean $x + y - y \\in I_1$) and it also cannot be in $I_2$. \n    \n      For $r \\geq 3$, assume the result holds for $r - 1$. After renumbering we may assume that $I_ r$ is prime. We may also assume there are no inclusions among the $I_ i$. Pick $x \\in J$, $x \\not\\in I_ i$ for all $i = 1, \\ldots , r - 1$. If $x \\not\\in I_ r$ we are done. So assume $x \\in I_ r$. If $J I_1 \\ldots I_{r - 1} \\subset I_ r$ then $J \\subset I_ r$ (by Lemma 10.15.1) a contradiction. Pick $y \\in J I_1 \\ldots I_{r - 1}$, $y \\not\\in I_ r$. Then $x + y$ works. \n      $\\square$\n    \n","
  suffices ((I : Set R) âŠ† â‹ƒ i âˆˆ (â†‘s : Set Î¹), f i) â†’ âˆƒ i, i âˆˆ s âˆ§ I â‰¤ f i by
    have aux := fun h => (bex_def.2 <| this h)
    simp_rw [exists_prop] at aux
    refine âŸ¨aux, fun âŸ¨i, his, hiâŸ© â†¦ Set.Subset.trans hi ?_âŸ©
    apply Set.subset_biUnion_of_mem (show i âˆˆ (â†‘s : Set Î¹) from his)
  fun h : (I : Set R) âŠ† â‹ƒ i âˆˆ (â†‘s : Set Î¹), f i => by
  classical
    by_cases has : a âˆˆ s
    Â· obtain âŸ¨t, hat, rflâŸ© : âˆƒ t, a âˆ‰ t âˆ§ insert a t = s :=
        âŸ¨s.erase a, Finset.notMem_erase a s, Finset.insert_erase hasâŸ©
      by_cases hbt : b âˆˆ t
      Â· obtain âŸ¨u, hbu, rflâŸ© : âˆƒ u, b âˆ‰ u âˆ§ insert b u = t :=
          âŸ¨t.erase b, Finset.notMem_erase b t, Finset.insert_erase hbtâŸ©
        have hp' : âˆ€ i âˆˆ u, IsPrime (f i) := by
          intro i hiu
          refine hp i (Finset.mem_insert_of_mem (Finset.mem_insert_of_mem hiu)) ?_ ?_ <;>
              rintro rfl <;>
            solve_by_elim only [Finset.mem_insert_of_mem, *]
        rw [Finset.coe_insert, Finset.coe_insert, Set.biUnion_insert, Set.biUnion_insert, â†
          Set.union_assoc, subset_union_prime' hp'] at h
        rwa [Finset.exists_mem_insert, Finset.exists_mem_insert]
      Â· have hp' : âˆ€ j âˆˆ t, IsPrime (f j) := by
          intro j hj
          refine hp j (Finset.mem_insert_of_mem hj) ?_ ?_ <;> rintro rfl <;>
            solve_by_elim only [Finset.mem_insert_of_mem, *]
        rw [Finset.coe_insert, Set.biUnion_insert, â† Set.union_self (f a : Set R),
          subset_union_prime' hp', â† or_assoc, or_self_iff] at h
        rwa [Finset.exists_mem_insert]
    Â· by_cases hbs : b âˆˆ s
      Â· obtain âŸ¨t, hbt, rflâŸ© : âˆƒ t, b âˆ‰ t âˆ§ insert b t = s :=
          âŸ¨s.erase b, Finset.notMem_erase b s, Finset.insert_erase hbsâŸ©
        have hp' : âˆ€ j âˆˆ t, IsPrime (f j) := by
          intro j hj
          refine hp j (Finset.mem_insert_of_mem hj) ?_ ?_ <;> rintro rfl <;>
            solve_by_elim only [Finset.mem_insert_of_mem, *]
        rw [Finset.coe_insert, Set.biUnion_insert, â† Set.union_self (f b : Set R),
          subset_union_prime' hp', â† or_assoc, or_self_iff] at h
        rwa [Finset.exists_mem_insert]
      rcases s.eq_empty_or_nonempty with hse | hsne
      Â· subst hse
        rw [Finset.coe_empty, Set.biUnion_empty] at h
        exact (h I.zero_mem).elim
      Â· obtain âŸ¨i, hisâŸ© := hsne
        obtain âŸ¨t, _, rflâŸ© : âˆƒ t, i âˆ‰ t âˆ§ insert i t = s :=
          âŸ¨s.erase i, Finset.notMem_erase i s, Finset.insert_erase hisâŸ©
        have hp' : âˆ€ j âˆˆ t, IsPrime (f j) := by
          intro j hj
          refine hp j (Finset.mem_insert_of_mem hj) ?_ ?_ <;> rintro rfl <;>
            solve_by_elim only [Finset.mem_insert_of_mem, *]
        rw [Finset.coe_insert, Set.biUnion_insert, â† Set.union_self (f i : Set R),
          subset_union_prime' hp', â† or_assoc, or_self_iff] at h
        rwa [Finset.exists_mem_insert]
","theorem subset_union_prime {R : Type u} [CommRing R] {s : Finset Î¹} {f : Î¹ â†’ Ideal R} (a b : Î¹)
    (hp : âˆ€ i âˆˆ s, i â‰  a â†’ i â‰  b â†’ IsPrime (f i)) {I : Ideal R} :
    ((I : Set R) âŠ† â‹ƒ i âˆˆ (â†‘s : Set Î¹), f i) â†” âˆƒ i âˆˆ s, I â‰¤ f i ","Proof.\n      The result is true for $r = 1$. If $r = 2$, then let $x, y \\in J$ with $x \\not\\in I_1$ and $y \\not\\in I_2$. We are done unless $x \\in I_2$ and $y \\in I_1$. Then the element $x + y$ cannot be in $I_1$ (since that would mean $x + y - y \\in I_1$) and it also cannot be in $I_2$. \n    \n      For $r \\geq 3$, assume the result holds for $r - 1$. After renumbering we may assume that $I_ r$ is prime. We may also assume there are no inclusions among the $I_ i$. Pick $x \\in J$, $x \\not\\in I_ i$ for all $i = 1, \\ldots , r - 1$. If $x \\not\\in I_ r$ we are done. So assume $x \\in I_ r$. If $J I_1 \\ldots I_{r - 1} \\subset I_ r$ then $J \\subset I_ r$ (by Lemma 10.15.1 [[\n  Lemma 10.15.1. Let $R$ be a ring, $I$ and $J$ two ideals and $\\mathfrak p$ a prime ideal containing the product $IJ$. Then $\\mathfrak {p}$ contains $I$ or $J$. \n\n    \n]]) a contradiction. Pick $y \\in J I_1 \\ldots I_{r - 1}$, $y \\not\\in I_ r$. Then $x + y$ works. \n      $\\square$\n    \n"
289,02M3,"theorem subset_of_injective (hf : Function.Injective f) :
    associatedPrimes R M âŠ† associatedPrimes R M' := fun _I h => h.map_of_injective f hf
",Formal Proof of Stacks Project Tag 02M3,first part,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Ideal/AssociatedPrime/Basic.lean#L103-L104,Q27041,,10.63.3,lemma,3.0,"['00L9', '00AO', '0ELQ']","\n  Lemma 10.63.3. Let $R$ be a ring. Let $0 \\to M\' \\to M \\to M\'\' \\to 0$ be a short exact sequence of $R$-modules. Then $\\text{Ass}(M\') \\subset \\text{Ass}(M)$ and $\\text{Ass}(M) \\subset \\text{Ass}(M\') \\cup \\text{Ass}(M\'\')$. Also $\\text{Ass}(M\' \\oplus M\'\') = \\text{Ass}(M\') \\cup \\text{Ass}(M\'\')$. \n\n    \n      Proof.\n      If $m\' \\in M\'$, then the annihilator of $m\'$ viewed as an element of $M\'$ is the same as the annihilator of $m\'$ viewed as an element of $M$. Hence the inclusion $\\text{Ass}(M\') \\subset \\text{Ass}(M)$. Let $m \\in M$ be an element whose annihilator is a prime ideal $\\mathfrak p$. If there exists a $g \\in R$, $g \\not\\in \\mathfrak p$ such that $m\' = gm \\in M\'$ then the annihilator of $m\'$ is $\\mathfrak p$. If there does not exist a $g \\in R$, $g \\not\\in \\mathfrak p$ such that $gm \\in M\'$, then the annilator of the image $m\'\' \\in M\'\'$ of $m$ is $\\mathfrak p$. This proves the inclusion $\\text{Ass}(M) \\subset \\text{Ass}(M\') \\cup \\text{Ass}(M\'\')$. We omit the proof of the final statement. \n      $\\square$\n    \n",\n  Lemma 10.63.3. Let $R$ be a ring. Let $0 \\to M\' \\to M \\to M\'\' \\to 0$ be a short exact sequence of $R$-modules. Then $\\text{Ass}(M\') \\subset \\text{Ass}(M)$ and $\\text{Ass}(M) \\subset \\text{Ass}(M\') \\cup \\text{Ass}(M\'\')$. Also $\\text{Ass}(M\' \\oplus M\'\') = \\text{Ass}(M\') \\cup \\text{Ass}(M\'\')$. \n\n    \n,"Proof.\n      If $m\' \\in M\'$, then the annihilator of $m\'$ viewed as an element of $M\'$ is the same as the annihilator of $m\'$ viewed as an element of $M$. Hence the inclusion $\\text{Ass}(M\') \\subset \\text{Ass}(M)$. Let $m \\in M$ be an element whose annihilator is a prime ideal $\\mathfrak p$. If there exists a $g \\in R$, $g \\not\\in \\mathfrak p$ such that $m\' = gm \\in M\'$ then the annihilator of $m\'$ is $\\mathfrak p$. If there does not exist a $g \\in R$, $g \\not\\in \\mathfrak p$ such that $gm \\in M\'$, then the annilator of the image $m\'\' \\in M\'\'$ of $m$ is $\\mathfrak p$. This proves the inclusion $\\text{Ass}(M) \\subset \\text{Ass}(M\') \\cup \\text{Ass}(M\'\')$. We omit the proof of the final statement. \n      $\\square$\n    \n"," fun _I h => h.map_of_injective f hf
","theorem subset_of_injective (hf : Function.Injective f) :
    associatedPrimes R M âŠ† associatedPrimes R M' ","Proof.\n      If $m\' \\in M\'$, then the annihilator of $m\'$ viewed as an element of $M\'$ is the same as the annihilator of $m\'$ viewed as an element of $M$. Hence the inclusion $\\text{Ass}(M\') \\subset \\text{Ass}(M)$. Let $m \\in M$ be an element whose annihilator is a prime ideal $\\mathfrak p$. If there exists a $g \\in R$, $g \\not\\in \\mathfrak p$ such that $m\' = gm \\in M\'$ then the annihilator of $m\'$ is $\\mathfrak p$. If there does not exist a $g \\in R$, $g \\not\\in \\mathfrak p$ such that $gm \\in M\'$, then the annilator of the image $m\'\' \\in M\'\'$ of $m$ is $\\mathfrak p$. This proves the inclusion $\\text{Ass}(M) \\subset \\text{Ass}(M\') \\cup \\text{Ass}(M\'\')$. We omit the proof of the final statement. \n      $\\square$\n    \n"
290,02M3,"theorem subset_union_of_exact (hf : Function.Injective f) (hfg : Function.Exact f g) :
    associatedPrimes R M' âŠ† associatedPrimes R M âˆª associatedPrimes R M'' := by
  rintro p âŸ¨_, x, hxâŸ©
  by_cases! h : âˆƒ a âˆˆ p.primeCompl, âˆƒ y : M, f y = a â€¢ x
  Â· obtain âŸ¨a, ha, y, hâŸ© := h
    left
    refine âŸ¨â€¹_â€º, y, le_antisymm (fun b hb â†¦ ?_) (fun b hb â†¦ ?_)âŸ©
    Â· rw [hx] at hb
      rw [mem_colon_singleton, mem_bot] at hb âŠ¢
      apply_fun _ using hf
      rw [map_smul, map_zero, h, smul_comm, hb, smul_zero]
    Â· rw [mem_colon_singleton, mem_bot] at hb
      apply_fun f at hb
      rw [map_smul, map_zero, h, â† mul_smul, â† mem_bot R, â† mem_colon_singleton, â† hx] at hb
      contrapose hb
      exact p.primeCompl.mul_mem hb ha
  Â· right
    refine âŸ¨â€¹_â€º, g x, le_antisymm (fun b hb â†¦ ?_) (fun b hb â†¦ ?_)âŸ©
    Â· rw [hx] at hb
      rw [mem_colon_singleton, mem_bot] at hb âŠ¢
      rw [â† map_smul, hb, map_zero]
    Â· rw [mem_colon_singleton, mem_bot, â† map_smul, â† LinearMap.mem_ker,
        hfg.linearMap_ker_eq] at hb
      obtain âŸ¨y, hyâŸ© := hb
      by_contra H
      exact h b H y hy
",Formal Proof of Stacks Project Tag 02M3,second part,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Ideal/AssociatedPrime/Basic.lean#L109-L134,Q27041,,10.63.3,lemma,3.0,"['00L9', '00AO', '0ELQ']","\n  Lemma 10.63.3. Let $R$ be a ring. Let $0 \\to M\' \\to M \\to M\'\' \\to 0$ be a short exact sequence of $R$-modules. Then $\\text{Ass}(M\') \\subset \\text{Ass}(M)$ and $\\text{Ass}(M) \\subset \\text{Ass}(M\') \\cup \\text{Ass}(M\'\')$. Also $\\text{Ass}(M\' \\oplus M\'\') = \\text{Ass}(M\') \\cup \\text{Ass}(M\'\')$. \n\n    \n      Proof.\n      If $m\' \\in M\'$, then the annihilator of $m\'$ viewed as an element of $M\'$ is the same as the annihilator of $m\'$ viewed as an element of $M$. Hence the inclusion $\\text{Ass}(M\') \\subset \\text{Ass}(M)$. Let $m \\in M$ be an element whose annihilator is a prime ideal $\\mathfrak p$. If there exists a $g \\in R$, $g \\not\\in \\mathfrak p$ such that $m\' = gm \\in M\'$ then the annihilator of $m\'$ is $\\mathfrak p$. If there does not exist a $g \\in R$, $g \\not\\in \\mathfrak p$ such that $gm \\in M\'$, then the annilator of the image $m\'\' \\in M\'\'$ of $m$ is $\\mathfrak p$. This proves the inclusion $\\text{Ass}(M) \\subset \\text{Ass}(M\') \\cup \\text{Ass}(M\'\')$. We omit the proof of the final statement. \n      $\\square$\n    \n",\n  Lemma 10.63.3. Let $R$ be a ring. Let $0 \\to M\' \\to M \\to M\'\' \\to 0$ be a short exact sequence of $R$-modules. Then $\\text{Ass}(M\') \\subset \\text{Ass}(M)$ and $\\text{Ass}(M) \\subset \\text{Ass}(M\') \\cup \\text{Ass}(M\'\')$. Also $\\text{Ass}(M\' \\oplus M\'\') = \\text{Ass}(M\') \\cup \\text{Ass}(M\'\')$. \n\n    \n,"Proof.\n      If $m\' \\in M\'$, then the annihilator of $m\'$ viewed as an element of $M\'$ is the same as the annihilator of $m\'$ viewed as an element of $M$. Hence the inclusion $\\text{Ass}(M\') \\subset \\text{Ass}(M)$. Let $m \\in M$ be an element whose annihilator is a prime ideal $\\mathfrak p$. If there exists a $g \\in R$, $g \\not\\in \\mathfrak p$ such that $m\' = gm \\in M\'$ then the annihilator of $m\'$ is $\\mathfrak p$. If there does not exist a $g \\in R$, $g \\not\\in \\mathfrak p$ such that $gm \\in M\'$, then the annilator of the image $m\'\' \\in M\'\'$ of $m$ is $\\mathfrak p$. This proves the inclusion $\\text{Ass}(M) \\subset \\text{Ass}(M\') \\cup \\text{Ass}(M\'\')$. We omit the proof of the final statement. \n      $\\square$\n    \n"," by
  rintro p âŸ¨_, x, hxâŸ©
  by_cases! h : âˆƒ a âˆˆ p.primeCompl, âˆƒ y : M, f y = a â€¢ x
  Â· obtain âŸ¨a, ha, y, hâŸ© := h
    left
    refine âŸ¨â€¹_â€º, y, le_antisymm (fun b hb â†¦ ?_) (fun b hb â†¦ ?_)âŸ©
    Â· rw [hx] at hb
      rw [mem_colon_singleton, mem_bot] at hb âŠ¢
      apply_fun _ using hf
      rw [map_smul, map_zero, h, smul_comm, hb, smul_zero]
    Â· rw [mem_colon_singleton, mem_bot] at hb
      apply_fun f at hb
      rw [map_smul, map_zero, h, â† mul_smul, â† mem_bot R, â† mem_colon_singleton, â† hx] at hb
      contrapose hb
      exact p.primeCompl.mul_mem hb ha
  Â· right
    refine âŸ¨â€¹_â€º, g x, le_antisymm (fun b hb â†¦ ?_) (fun b hb â†¦ ?_)âŸ©
    Â· rw [hx] at hb
      rw [mem_colon_singleton, mem_bot] at hb âŠ¢
      rw [â† map_smul, hb, map_zero]
    Â· rw [mem_colon_singleton, mem_bot, â† map_smul, â† LinearMap.mem_ker,
        hfg.linearMap_ker_eq] at hb
      obtain âŸ¨y, hyâŸ© := hb
      by_contra H
      exact h b H y hy
","theorem subset_union_of_exact (hf : Function.Injective f) (hfg : Function.Exact f g) :
    associatedPrimes R M' âŠ† associatedPrimes R M âˆª associatedPrimes R M'' ","Proof.\n      If $m\' \\in M\'$, then the annihilator of $m\'$ viewed as an element of $M\'$ is the same as the annihilator of $m\'$ viewed as an element of $M$. Hence the inclusion $\\text{Ass}(M\') \\subset \\text{Ass}(M)$. Let $m \\in M$ be an element whose annihilator is a prime ideal $\\mathfrak p$. If there exists a $g \\in R$, $g \\not\\in \\mathfrak p$ such that $m\' = gm \\in M\'$ then the annihilator of $m\'$ is $\\mathfrak p$. If there does not exist a $g \\in R$, $g \\not\\in \\mathfrak p$ such that $gm \\in M\'$, then the annilator of the image $m\'\' \\in M\'\'$ of $m$ is $\\mathfrak p$. This proves the inclusion $\\text{Ass}(M) \\subset \\text{Ass}(M\') \\cup \\text{Ass}(M\'\')$. We omit the proof of the final statement. \n      $\\square$\n    \n"
291,02M3,"theorem prod : associatedPrimes R (M Ã— M') = associatedPrimes R M âˆª associatedPrimes R M' :=
  (subset_union_of_exact LinearMap.inl_injective .inl_snd).antisymm (Set.union_subset_iff.2
    âŸ¨subset_of_injective LinearMap.inl_injective, subset_of_injective LinearMap.inr_injectiveâŸ©)
",Formal Proof of Stacks Project Tag 02M3,third part,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Ideal/AssociatedPrime/Basic.lean#L140-L142,Q27041,,10.63.3,lemma,3.0,"['00L9', '00AO', '0ELQ']","\n  Lemma 10.63.3. Let $R$ be a ring. Let $0 \\to M\' \\to M \\to M\'\' \\to 0$ be a short exact sequence of $R$-modules. Then $\\text{Ass}(M\') \\subset \\text{Ass}(M)$ and $\\text{Ass}(M) \\subset \\text{Ass}(M\') \\cup \\text{Ass}(M\'\')$. Also $\\text{Ass}(M\' \\oplus M\'\') = \\text{Ass}(M\') \\cup \\text{Ass}(M\'\')$. \n\n    \n      Proof.\n      If $m\' \\in M\'$, then the annihilator of $m\'$ viewed as an element of $M\'$ is the same as the annihilator of $m\'$ viewed as an element of $M$. Hence the inclusion $\\text{Ass}(M\') \\subset \\text{Ass}(M)$. Let $m \\in M$ be an element whose annihilator is a prime ideal $\\mathfrak p$. If there exists a $g \\in R$, $g \\not\\in \\mathfrak p$ such that $m\' = gm \\in M\'$ then the annihilator of $m\'$ is $\\mathfrak p$. If there does not exist a $g \\in R$, $g \\not\\in \\mathfrak p$ such that $gm \\in M\'$, then the annilator of the image $m\'\' \\in M\'\'$ of $m$ is $\\mathfrak p$. This proves the inclusion $\\text{Ass}(M) \\subset \\text{Ass}(M\') \\cup \\text{Ass}(M\'\')$. We omit the proof of the final statement. \n      $\\square$\n    \n",\n  Lemma 10.63.3. Let $R$ be a ring. Let $0 \\to M\' \\to M \\to M\'\' \\to 0$ be a short exact sequence of $R$-modules. Then $\\text{Ass}(M\') \\subset \\text{Ass}(M)$ and $\\text{Ass}(M) \\subset \\text{Ass}(M\') \\cup \\text{Ass}(M\'\')$. Also $\\text{Ass}(M\' \\oplus M\'\') = \\text{Ass}(M\') \\cup \\text{Ass}(M\'\')$. \n\n    \n,"Proof.\n      If $m\' \\in M\'$, then the annihilator of $m\'$ viewed as an element of $M\'$ is the same as the annihilator of $m\'$ viewed as an element of $M$. Hence the inclusion $\\text{Ass}(M\') \\subset \\text{Ass}(M)$. Let $m \\in M$ be an element whose annihilator is a prime ideal $\\mathfrak p$. If there exists a $g \\in R$, $g \\not\\in \\mathfrak p$ such that $m\' = gm \\in M\'$ then the annihilator of $m\'$ is $\\mathfrak p$. If there does not exist a $g \\in R$, $g \\not\\in \\mathfrak p$ such that $gm \\in M\'$, then the annilator of the image $m\'\' \\in M\'\'$ of $m$ is $\\mathfrak p$. This proves the inclusion $\\text{Ass}(M) \\subset \\text{Ass}(M\') \\cup \\text{Ass}(M\'\')$. We omit the proof of the final statement. \n      $\\square$\n    \n","
  (subset_union_of_exact LinearMap.inl_injective .inl_snd).antisymm (Set.union_subset_iff.2
    âŸ¨subset_of_injective LinearMap.inl_injective, subset_of_injective LinearMap.inr_injectiveâŸ©)
",theorem prod : associatedPrimes R (M Ã— M') = associatedPrimes R M âˆª associatedPrimes R M' ,"Proof.\n      If $m\' \\in M\'$, then the annihilator of $m\'$ viewed as an element of $M\'$ is the same as the annihilator of $m\'$ viewed as an element of $M$. Hence the inclusion $\\text{Ass}(M\') \\subset \\text{Ass}(M)$. Let $m \\in M$ be an element whose annihilator is a prime ideal $\\mathfrak p$. If there exists a $g \\in R$, $g \\not\\in \\mathfrak p$ such that $m\' = gm \\in M\'$ then the annihilator of $m\'$ is $\\mathfrak p$. If there does not exist a $g \\in R$, $g \\not\\in \\mathfrak p$ such that $gm \\in M\'$, then the annilator of the image $m\'\' \\in M\'\'$ of $m$ is $\\mathfrak p$. This proves the inclusion $\\text{Ass}(M) \\subset \\text{Ass}(M\') \\cup \\text{Ass}(M\'\')$. We omit the proof of the final statement. \n      $\\square$\n    \n"
292,00L0,"theorem IsNoetherianRing.exists_relSeries_isQuotientEquivQuotientPrime :
    âˆƒ s : RelSeries {(Nâ‚, Nâ‚‚) | Submodule.IsQuotientEquivQuotientPrime (A := A) (M := M) Nâ‚ Nâ‚‚},
      s.head = âŠ¥ âˆ§ s.last = âŠ¤ := by
  refine WellFoundedGT.induction_top âŸ¨âŠ¥, .singleton _ âŠ¥, rfl, rflâŸ© ?_
  rintro N hN âŸ¨s, hsâ‚, hsâ‚‚âŸ©
  have := Submodule.Quotient.nontrivial_iff.mpr hN
  obtain âŸ¨p, hp, x, rflâŸ© := associatedPrimes.nonempty A (M â§¸ N)
  obtain âŸ¨x, rflâŸ© := Submodule.mkQ_surjective _ x
  have hxN : x âˆ‰ N := fun h â†¦ hp.ne_top (by rw [show N.mkQ x = 0 by simpa]; simp)
  have := Submodule.isQuotientEquivQuotientPrime_iff.mpr âŸ¨x, hp, rflâŸ©
  refine âŸ¨_, by simpa [hsâ‚‚], s.snoc _ (hsâ‚‚ â–¸ this), by simpa, rflâŸ©
",Formal Proof of Stacks Project Tag 00L0,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Ideal/AssociatedPrime/Finiteness.lean#L91-L101,Q27041,,10.62.1,lemma,3.0,"['00KY', '00AO', '0ELQ']","\n  Lemma 10.62.1. Let $R$ be a Noetherian ring, and let $M$ be a finite $R$-module. There exists a filtration by $R$-submodules \n  \n  \\[  0 = M_0 \\subset M_1 \\subset \\ldots \\subset M_ n = M  \\]\n\n   such that each quotient $M_ i/M_{i-1}$ is isomorphic to $R/\\mathfrak p_ i$ for some prime ideal $\\mathfrak p_ i$ of $R$. \n\n    \n      Second proof.\n       For an $R$-module $M$ we say $P(M)$ holds if there exists a filtration as in the statement of the lemma. Observe that $P$ is stable under extensions and holds for $0$. By Lemma 10.5.4 it suffices to prove $P(R/I)$ holds for every ideal $I$. If not then because $R$ is Noetherian, there is a maximal counter example $J$. By Example 10.28.7 and Proposition 10.28.8 the ideal $J$ is prime which is a contradiction. \n      $\\square$\n    \n\n    \n      First proof.\n       By Lemma 10.5.4 it suffices to do the case $M = R/I$ for some ideal $I$. Consider the set $S$ of ideals $J$ such that the lemma does not hold for the module $R/J$, and order it by inclusion. To arrive at a contradiction, assume that $S$ is not empty. Because $R$ is Noetherian, $S$ has a maximal element $J$. By definition of $S$, the ideal $J$ cannot be prime. Pick $a, b\\in R$ such that $ab \\in J$, but neither $a \\in J$ nor $b\\in J$. Consider the filtration $0 \\subset aR/(J \\cap aR) \\subset R/J$. Note that both the submodule $aR/(J \\cap aR)$ and the quotient module $(R/J)/(aR/(J \\cap aR))$ are cyclic modules; write them as $R/J\'$ and $R/J\'\'$ so we have a short exact sequence $0 \\to R/J\' \\to R/J \\to R/J\'\' \\to 0$. The inclusion $J \\subset J\'$ is strict as $b \\in J\'$ and the inclusion $J \\subset J\'\'$ is strict as $a \\in J\'\'$. Hence by maximality of $J$, both $R/J\'$ and $R/J\'\'$ have a filtration as above and hence so does $R/J$. Contradiction. \n      $\\square$\n    \n","\n  Lemma 10.62.1. Let $R$ be a Noetherian ring, and let $M$ be a finite $R$-module. There exists a filtration by $R$-submodules \n  \n  \\[  0 = M_0 \\subset M_1 \\subset \\ldots \\subset M_ n = M  \\]\n\n   such that each quotient $M_ i/M_{i-1}$ is isomorphic to $R/\\mathfrak p_ i$ for some prime ideal $\\mathfrak p_ i$ of $R$. \n\n    \n      Second proof.\n       For an $R$-module $M$ we say $P(M)$ holds if there exists a filtration as in the statement of the lemma. Observe that $P$ is stable under extensions and holds for $0$. By Lemma 10.5.4 it suffices to prove $P(R/I)$ holds for every ideal $I$. If not then because $R$ is Noetherian, there is a maximal counter example $J$. By Example 10.28.7 and Proposition 10.28.8 the ideal $J$ is prime which is a contradiction. \n      $\\square$\n    \n\n    \n      First proof.\n       By Lemma 10.5.4 it suffices to do the case $M = R/I$ for some ideal $I$. Consider the set $S$ of ideals $J$ such that the lemma does not hold for the module $R/J$, and order it by inclusion. To arrive at a contradiction, assume that $S$ is not empty. Because $R$ is Noetherian, $S$ has a maximal element $J$. By definition of $S$, the ideal $J$ cannot be prime. Pick $a, b\\in R$ such that $ab \\in J$, but neither $a \\in J$ nor $b\\in J$. Consider the filtration $0 \\subset aR/(J \\cap aR) \\subset R/J$. Note that both the submodule $aR/(J \\cap aR)$ and the quotient module $(R/J)/(aR/(J \\cap aR))$ are cyclic modules; write them as $R/J\'$ and $R/J\'\'$ so we have a short exact sequence $0 \\to R/J\' \\to R/J \\to R/J\'\' \\to 0$. The inclusion $J \\subset J\'$ is strict as $b \\in J\'$ and the inclusion $J \\subset J\'\'$ is strict as $a \\in J\'\'$. Hence by maximality of $J$, both $R/J\'$ and $R/J\'\'$ have a filtration as above and hence so does $R/J$. Contradiction. \n      $\\square$\n    \n",," A) (M := M) Nâ‚ Nâ‚‚},
      s.head = âŠ¥ âˆ§ s.last = âŠ¤ := by
  refine WellFoundedGT.induction_top âŸ¨âŠ¥, .singleton _ âŠ¥, rfl, rflâŸ© ?_
  rintro N hN âŸ¨s, hsâ‚, hsâ‚‚âŸ©
  have := Submodule.Quotient.nontrivial_iff.mpr hN
  obtain âŸ¨p, hp, x, rflâŸ© := associatedPrimes.nonempty A (M â§¸ N)
  obtain âŸ¨x, rflâŸ© := Submodule.mkQ_surjective _ x
  have hxN : x âˆ‰ N := fun h â†¦ hp.ne_top (by rw [show N.mkQ x = 0 by simpa]; simp)
  have := Submodule.isQuotientEquivQuotientPrime_iff.mpr âŸ¨x, hp, rflâŸ©
  refine âŸ¨_, by simpa [hsâ‚‚], s.snoc _ (hsâ‚‚ â–¸ this), by simpa, rflâŸ©
","theorem IsNoetherianRing.exists_relSeries_isQuotientEquivQuotientPrime :
    âˆƒ s : RelSeries {(Nâ‚, Nâ‚‚) | Submodule.IsQuotientEquivQuotientPrime (A ",
293,00LC,"theorem associatedPrimes.finite : (associatedPrimes A M).Finite := by
  induction â€¹Module.Finite A Mâ€º using
    IsNoetherianRing.induction_on_isQuotientEquivQuotientPrime A with
  | subsingleton N => simp [associatedPrimes.eq_empty_of_subsingleton]
  | quotient N p f =>
    have := associatedPrimes.eq_singleton_of_isPrimary p.2.isPrimary
    simp [LinearEquiv.AssociatedPrimes.eq f, this]
  | exact Nâ‚ Nâ‚‚ Nâ‚ƒ f g hf _ hfg hâ‚ hâ‚ƒ =>
    exact (hâ‚.union hâ‚ƒ).subset (associatedPrimes.subset_union_of_exact hf hfg)
",Formal Proof of Stacks Project Tag 00LC,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Ideal/AssociatedPrime/Finiteness.lean#L155-L163,Q27041,,10.63.5,lemma,3.0,"['00L9', '00AO', '0ELQ']",\n  Lemma 10.63.5. Let $R$ be a Noetherian ring. Let $M$ be a finite $R$-module. Then $\\text{Ass}(M)$ is finite. \n\n    \n      Proof.\n      Immediate from Lemma 10.63.4 and Lemma 10.62.1. \n      $\\square$\n    \n,\n  Lemma 10.63.5. Let $R$ be a Noetherian ring. Let $M$ be a finite $R$-module. Then $\\text{Ass}(M)$ is finite. \n\n    \n,Proof.\n      Immediate from Lemma 10.63.4 and Lemma 10.62.1. \n      $\\square$\n    \n," by
  induction â€¹Module.Finite A Mâ€º using
    IsNoetherianRing.induction_on_isQuotientEquivQuotientPrime A with
  | subsingleton N => simp [associatedPrimes.eq_empty_of_subsingleton]
  | quotient N p f =>
    have := associatedPrimes.eq_singleton_of_isPrimary p.2.isPrimary
    simp [LinearEquiv.AssociatedPrimes.eq f, this]
  | exact Nâ‚ Nâ‚‚ Nâ‚ƒ f g hf _ hfg hâ‚ hâ‚ƒ =>
    exact (hâ‚.union hâ‚ƒ).subset (associatedPrimes.subset_union_of_exact hf hfg)
",theorem associatedPrimes.finite : (associatedPrimes A M).Finite ,"Proof.\n      Immediate from Lemma 10.63.4 [[\n  Lemma 10.63.4. Let $R$ be a ring, and $M$ an $R$-module. Suppose there exists a filtration by $R$-submodules \n  \n  \\[  0 = M_0 \\subset M_1 \\subset \\ldots \\subset M_ n = M  \\]\n\n   such that each quotient $M_ i/M_{i-1}$ is isomorphic to $R/\\mathfrak p_ i$ for some prime ideal $\\mathfrak p_ i$ of $R$. Then $\\text{Ass}(M) \\subset \\{ \\mathfrak p_1, \\ldots , \\mathfrak p_ n\\} $. \n\n    \n]] and Lemma 10.62.1 [[\n  Lemma 10.62.1. Let $R$ be a Noetherian ring, and let $M$ be a finite $R$-module. There exists a filtration by $R$-submodules \n  \n  \\[  0 = M_0 \\subset M_1 \\subset \\ldots \\subset M_ n = M  \\]\n\n   such that each quotient $M_ i/M_{i-1}$ is isomorphic to $R/\\mathfrak p_ i$ for some prime ideal $\\mathfrak p_ i$ of $R$. \n\n    \n      Second proof.\n       For an $R$-module $M$ we say $P(M)$ holds if there exists a filtration as in the statement of the lemma. Observe that $P$ is stable under extensions and holds for $0$. By Lemma 10.5.4 it suffices to prove $P(R/I)$ holds for every ideal $I$. If not then because $R$ is Noetherian, there is a maximal counter example $J$. By Example 10.28.7 and Proposition 10.28.8 the ideal $J$ is prime which is a contradiction. \n      $\\square$\n    \n\n    \n      First proof.\n       By Lemma 10.5.4 it suffices to do the case $M = R/I$ for some ideal $I$. Consider the set $S$ of ideals $J$ such that the lemma does not hold for the module $R/J$, and order it by inclusion. To arrive at a contradiction, assume that $S$ is not empty. Because $R$ is Noetherian, $S$ has a maximal element $J$. By definition of $S$, the ideal $J$ cannot be prime. Pick $a, b\\in R$ such that $ab \\in J$, but neither $a \\in J$ nor $b\\in J$. Consider the filtration $0 \\subset aR/(J \\cap aR) \\subset R/J$. Note that both the submodule $aR/(J \\cap aR)$ and the quotient module $(R/J)/(aR/(J \\cap aR))$ are cyclic modules; write them as $R/J\'$ and $R/J\'\'$ so we have a short exact sequence $0 \\to R/J\' \\to R/J \\to R/J\'\' \\to 0$. The inclusion $J \\subset J\'$ is strict as $b \\in J\'$ and the inclusion $J \\subset J\'\'$ is strict as $a \\in J\'\'$. Hence by maximality of $J$, both $R/J\'$ and $R/J\'\'$ have a filtration as above and hence so does $R/J$. Contradiction. \n      $\\square$\n    \n]]. \n      $\\square$\n    \n"
294,0310,"lemma mem_associatedPrimes_of_comap_mem_associatedPrimes_of_isLocalizedModule
    (p : Ideal R') (ass : p.comap (algebraMap R R') âˆˆ associatedPrimes R M) :
    p âˆˆ associatedPrimes R' M' := by
  rcases ass with âŸ¨hp, x, hxâŸ©
  constructor
  Â· refine (IsLocalization.isPrime_iff_isPrime_disjoint S _ _).mpr
      âŸ¨hp, (IsLocalization.disjoint_comap_iff S R' p).mpr ?_âŸ©
    by_contra eqtop
    simp [eqtop, Ideal.comap_top, Ideal.isPrime_iff] at hp
  Â· use f x
    ext t
    rcases IsLocalization.exists_mk'_eq S t with âŸ¨r, s, hrsâŸ©
    rw [â† IsLocalizedModule.mk'_one S, â† hrs, mem_colon_singleton, mem_bot,
      IsLocalizedModule.mk'_smul_mk', mul_one, IsLocalizedModule.mk'_eq_zero']
    refine âŸ¨fun h â†¦ ?_, fun âŸ¨t, htâŸ© â†¦ ?_âŸ©
    Â· use 1
      simp only [â† mem_colon_singleton, one_smul, â† mem_bot R, â† hx, Ideal.mem_comap]
      have : (algebraMap R R') r =
        IsLocalization.mk' R' r s * IsLocalization.mk' R' s.1 (1 : S) := by
        rw [â† IsLocalization.mk'_one (M := S) R', â† sub_eq_zero, â† IsLocalization.mk'_mul,
          â† IsLocalization.mk'_sub]
        simp
      rw [this]
      exact Ideal.IsTwoSided.mul_mem_of_left _ h
    Â· have : t â€¢ r â€¢ x = (t.1 * r) â€¢ x := smul_smul t.1 r x
      rw [this, â† mem_bot R, â† mem_colon_singleton, â† hx, Ideal.mem_comap,
        â† IsLocalization.mk'_one (M := S) R'] at ht
      have : IsLocalization.mk' R' r s =
        IsLocalization.mk' (M := S) R' (t.1 * r) 1 * IsLocalization.mk' R' 1 (t * s) := by
        rw [â† IsLocalization.mk'_mul, mul_one, one_mul, â† sub_eq_zero, â† IsLocalization.mk'_sub,
          Submonoid.coe_mul]
        simp [â† mul_assoc, mul_comm r t.1, IsLocalization.mk'_zero]
      simpa [this] using Ideal.IsTwoSided.mul_mem_of_left _ ht
",Formal Proof of Stacks Project Tag 0310,(1),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Ideal/AssociatedPrime/Localization.lean#L40-L72,Q27041,,10.63.15,lemma,3.0,"['00L9', '00AO', '0ELQ']","\n  Lemma 10.63.15. Let $R$ be a ring. Let $M$ be an $R$-module. Let $\\mathfrak p \\subset R$ be a prime. \n  \n  \nIf $\\mathfrak p \\in \\text{Ass}(M)$ then $\\mathfrak pR_{\\mathfrak p} \\in \\text{Ass}(M_{\\mathfrak p})$. \n\n\nIf $\\mathfrak p$ is finitely generated then the converse holds as well. \n\n\n\n\n    \n      Proof.\n      If $\\mathfrak p \\in \\text{Ass}(M)$ there exists an element $m \\in M$ whose annihilator is $\\mathfrak p$. As localization is exact (Proposition 10.9.12) we see that the annihilator of $m/1$ in $M_{\\mathfrak p}$ is $\\mathfrak pR_{\\mathfrak p}$ hence (1) holds. Assume $\\mathfrak pR_{\\mathfrak p} \\in \\text{Ass}(M_{\\mathfrak p})$ and $\\mathfrak p = (f_1, \\ldots , f_ n)$. Let $m/g$ be an element of $M_{\\mathfrak p}$ whose annihilator is $\\mathfrak pR_{\\mathfrak p}$. This implies that the annihilator of $m$ is contained in $\\mathfrak p$. As $f_ i m/g = 0$ in $M_{\\mathfrak p}$ we see there exists a $g_ i \\in R$, $g_ i \\not\\in \\mathfrak p$ such that $g_ i f_ i m = 0$ in $M$. Combined we see the annihilator of $g_1\\ldots g_ nm$ is $\\mathfrak p$. Hence $\\mathfrak p \\in \\text{Ass}(M)$. \n      $\\square$\n    \n",\n  Lemma 10.63.15. Let $R$ be a ring. Let $M$ be an $R$-module. Let $\\mathfrak p \\subset R$ be a prime. \n  \n  \nIf $\\mathfrak p \\in \\text{Ass}(M)$ then $\\mathfrak pR_{\\mathfrak p} \\in \\text{Ass}(M_{\\mathfrak p})$. \n\n\nIf $\\mathfrak p$ is finitely generated then the converse holds as well. \n\n\n\n\n    \n,"Proof.\n      If $\\mathfrak p \\in \\text{Ass}(M)$ there exists an element $m \\in M$ whose annihilator is $\\mathfrak p$. As localization is exact (Proposition 10.9.12) we see that the annihilator of $m/1$ in $M_{\\mathfrak p}$ is $\\mathfrak pR_{\\mathfrak p}$ hence (1) holds. Assume $\\mathfrak pR_{\\mathfrak p} \\in \\text{Ass}(M_{\\mathfrak p})$ and $\\mathfrak p = (f_1, \\ldots , f_ n)$. Let $m/g$ be an element of $M_{\\mathfrak p}$ whose annihilator is $\\mathfrak pR_{\\mathfrak p}$. This implies that the annihilator of $m$ is contained in $\\mathfrak p$. As $f_ i m/g = 0$ in $M_{\\mathfrak p}$ we see there exists a $g_ i \\in R$, $g_ i \\not\\in \\mathfrak p$ such that $g_ i f_ i m = 0$ in $M$. Combined we see the annihilator of $g_1\\ldots g_ nm$ is $\\mathfrak p$. Hence $\\mathfrak p \\in \\text{Ass}(M)$. \n      $\\square$\n    \n"," by
  rcases ass with âŸ¨hp, x, hxâŸ©
  constructor
  Â· refine (IsLocalization.isPrime_iff_isPrime_disjoint S _ _).mpr
      âŸ¨hp, (IsLocalization.disjoint_comap_iff S R' p).mpr ?_âŸ©
    by_contra eqtop
    simp [eqtop, Ideal.comap_top, Ideal.isPrime_iff] at hp
  Â· use f x
    ext t
    rcases IsLocalization.exists_mk'_eq S t with âŸ¨r, s, hrsâŸ©
    rw [â† IsLocalizedModule.mk'_one S, â† hrs, mem_colon_singleton, mem_bot,
      IsLocalizedModule.mk'_smul_mk', mul_one, IsLocalizedModule.mk'_eq_zero']
    refine âŸ¨fun h â†¦ ?_, fun âŸ¨t, htâŸ© â†¦ ?_âŸ©
    Â· use 1
      simp only [â† mem_colon_singleton, one_smul, â† mem_bot R, â† hx, Ideal.mem_comap]
      have : (algebraMap R R') r =
        IsLocalization.mk' R' r s * IsLocalization.mk' R' s.1 (1 : S) := by
        rw [â† IsLocalization.mk'_one (M := S) R', â† sub_eq_zero, â† IsLocalization.mk'_mul,
          â† IsLocalization.mk'_sub]
        simp
      rw [this]
      exact Ideal.IsTwoSided.mul_mem_of_left _ h
    Â· have : t â€¢ r â€¢ x = (t.1 * r) â€¢ x := smul_smul t.1 r x
      rw [this, â† mem_bot R, â† mem_colon_singleton, â† hx, Ideal.mem_comap,
        â† IsLocalization.mk'_one (M := S) R'] at ht
      have : IsLocalization.mk' R' r s =
        IsLocalization.mk' (M := S) R' (t.1 * r) 1 * IsLocalization.mk' R' 1 (t * s) := by
        rw [â† IsLocalization.mk'_mul, mul_one, one_mul, â† sub_eq_zero, â† IsLocalization.mk'_sub,
          Submonoid.coe_mul]
        simp [â† mul_assoc, mul_comm r t.1, IsLocalization.mk'_zero]
      simpa [this] using Ideal.IsTwoSided.mul_mem_of_left _ ht
","lemma mem_associatedPrimes_of_comap_mem_associatedPrimes_of_isLocalizedModule
    (p : Ideal R') (ass : p.comap (algebraMap R R') âˆˆ associatedPrimes R M) :
    p âˆˆ associatedPrimes R' M' ","Proof.\n      If $\\mathfrak p \\in \\text{Ass}(M)$ there exists an element $m \\in M$ whose annihilator is $\\mathfrak p$. As localization is exact (Proposition 10.9.12 [[\n       \n      \n  Proposition 10.9.12. Let $L\\xrightarrow {u} M\\xrightarrow {v} N$ be an exact sequence of $R$-modules. Then $S^{-1}L \\to S^{-1}M \\to S^{-1}N$ is also exact. \n\n    \n]]) we see that the annihilator of $m/1$ in $M_{\\mathfrak p}$ is $\\mathfrak pR_{\\mathfrak p}$ hence (1) holds. Assume $\\mathfrak pR_{\\mathfrak p} \\in \\text{Ass}(M_{\\mathfrak p})$ and $\\mathfrak p = (f_1, \\ldots , f_ n)$. Let $m/g$ be an element of $M_{\\mathfrak p}$ whose annihilator is $\\mathfrak pR_{\\mathfrak p}$. This implies that the annihilator of $m$ is contained in $\\mathfrak p$. As $f_ i m/g = 0$ in $M_{\\mathfrak p}$ we see there exists a $g_ i \\in R$, $g_ i \\not\\in \\mathfrak p$ such that $g_ i f_ i m = 0$ in $M$. Combined we see the annihilator of $g_1\\ldots g_ nm$ is $\\mathfrak p$. Hence $\\mathfrak p \\in \\text{Ass}(M)$. \n      $\\square$\n    \n"
295,0310,"lemma comap_mem_associatedPrimes_of_mem_associatedPrimes_of_isLocalizedModule_of_fg (p : Ideal R')
    (ass : p âˆˆ associatedPrimes R' M') (fg : (p.comap (algebraMap R R')).FG) :
    p.comap (algebraMap R R') âˆˆ associatedPrimes R M := by
  rcases ass with âŸ¨hp, x, hxâŸ©
  rcases fg with âŸ¨T, hTâŸ©
  rcases IsLocalizedModule.mk'_surjective S f x with âŸ¨âŸ¨m, sâŸ©, rflâŸ©
  simp only [Function.uncurry_apply_pair] at hx
  have mem (a : T) : algebraMap R R' a âˆˆ p := by
    simpa [â† Ideal.mem_comap, â† hT] using Ideal.subset_span a.2
  simp only [hx, mem_bot, mem_colon_singleton, algebraMap_smul,
    â† IsLocalizedModule.mk'_smul, IsLocalizedModule.mk'_eq_zero' f] at mem
  choose g hg using mem
  refine âŸ¨.under R p, (âˆ a, g a).1 â€¢ m, le_antisymm ?_ fun r hr â†¦ ?_âŸ©
  Â· rw [â† hT, Ideal.span_le]
    intro a ha
    simp only [SetLike.mem_coe, mem_bot, mem_colon_singleton]
    obtain âŸ¨u, huâŸ© : g âŸ¨a, haâŸ© âˆ£ (âˆ a, g a) := by
      apply Finset.dvd_prod_of_mem g (Finset.mem_univ âŸ¨a, haâŸ©)
    rw [hu, Submonoid.coe_mul, smul_smul, â† mul_assoc, mul_comm, â† smul_smul, mul_comm, â† smul_smul]
    exact smul_eq_zero_of_right u.1 (hg âŸ¨a, haâŸ©)
  Â· simp only [mem_bot, mem_colon_singleton, smul_smul] at hr
    have mem : r * (âˆ a, g a).1 âˆˆ Ideal.comap (algebraMap R R') p := by
      simpa only [hx, Ideal.mem_comap, mem_bot, mem_colon_singleton, algebraMap_smul,
        â† IsLocalizedModule.mk'_smul, hr] using IsLocalizedModule.mk'_zero f s
    have := Set.disjoint_left.mp ((IsLocalization.disjoint_comap_iff S R' p).mpr hp.1) (âˆ a, g a).2
    have := (Ideal.IsPrime.under R p).mul_mem_iff_mem_or_mem.mp mem
    tauto
",Formal Proof of Stacks Project Tag 0310,(2),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Ideal/AssociatedPrime/Localization.lean#L92-L118,Q27041,,10.63.15,lemma,3.0,"['00L9', '00AO', '0ELQ']","\n  Lemma 10.63.15. Let $R$ be a ring. Let $M$ be an $R$-module. Let $\\mathfrak p \\subset R$ be a prime. \n  \n  \nIf $\\mathfrak p \\in \\text{Ass}(M)$ then $\\mathfrak pR_{\\mathfrak p} \\in \\text{Ass}(M_{\\mathfrak p})$. \n\n\nIf $\\mathfrak p$ is finitely generated then the converse holds as well. \n\n\n\n\n    \n      Proof.\n      If $\\mathfrak p \\in \\text{Ass}(M)$ there exists an element $m \\in M$ whose annihilator is $\\mathfrak p$. As localization is exact (Proposition 10.9.12) we see that the annihilator of $m/1$ in $M_{\\mathfrak p}$ is $\\mathfrak pR_{\\mathfrak p}$ hence (1) holds. Assume $\\mathfrak pR_{\\mathfrak p} \\in \\text{Ass}(M_{\\mathfrak p})$ and $\\mathfrak p = (f_1, \\ldots , f_ n)$. Let $m/g$ be an element of $M_{\\mathfrak p}$ whose annihilator is $\\mathfrak pR_{\\mathfrak p}$. This implies that the annihilator of $m$ is contained in $\\mathfrak p$. As $f_ i m/g = 0$ in $M_{\\mathfrak p}$ we see there exists a $g_ i \\in R$, $g_ i \\not\\in \\mathfrak p$ such that $g_ i f_ i m = 0$ in $M$. Combined we see the annihilator of $g_1\\ldots g_ nm$ is $\\mathfrak p$. Hence $\\mathfrak p \\in \\text{Ass}(M)$. \n      $\\square$\n    \n",\n  Lemma 10.63.15. Let $R$ be a ring. Let $M$ be an $R$-module. Let $\\mathfrak p \\subset R$ be a prime. \n  \n  \nIf $\\mathfrak p \\in \\text{Ass}(M)$ then $\\mathfrak pR_{\\mathfrak p} \\in \\text{Ass}(M_{\\mathfrak p})$. \n\n\nIf $\\mathfrak p$ is finitely generated then the converse holds as well. \n\n\n\n\n    \n,"Proof.\n      If $\\mathfrak p \\in \\text{Ass}(M)$ there exists an element $m \\in M$ whose annihilator is $\\mathfrak p$. As localization is exact (Proposition 10.9.12) we see that the annihilator of $m/1$ in $M_{\\mathfrak p}$ is $\\mathfrak pR_{\\mathfrak p}$ hence (1) holds. Assume $\\mathfrak pR_{\\mathfrak p} \\in \\text{Ass}(M_{\\mathfrak p})$ and $\\mathfrak p = (f_1, \\ldots , f_ n)$. Let $m/g$ be an element of $M_{\\mathfrak p}$ whose annihilator is $\\mathfrak pR_{\\mathfrak p}$. This implies that the annihilator of $m$ is contained in $\\mathfrak p$. As $f_ i m/g = 0$ in $M_{\\mathfrak p}$ we see there exists a $g_ i \\in R$, $g_ i \\not\\in \\mathfrak p$ such that $g_ i f_ i m = 0$ in $M$. Combined we see the annihilator of $g_1\\ldots g_ nm$ is $\\mathfrak p$. Hence $\\mathfrak p \\in \\text{Ass}(M)$. \n      $\\square$\n    \n"," by
  rcases ass with âŸ¨hp, x, hxâŸ©
  rcases fg with âŸ¨T, hTâŸ©
  rcases IsLocalizedModule.mk'_surjective S f x with âŸ¨âŸ¨m, sâŸ©, rflâŸ©
  simp only [Function.uncurry_apply_pair] at hx
  have mem (a : T) : algebraMap R R' a âˆˆ p := by
    simpa [â† Ideal.mem_comap, â† hT] using Ideal.subset_span a.2
  simp only [hx, mem_bot, mem_colon_singleton, algebraMap_smul,
    â† IsLocalizedModule.mk'_smul, IsLocalizedModule.mk'_eq_zero' f] at mem
  choose g hg using mem
  refine âŸ¨.under R p, (âˆ a, g a).1 â€¢ m, le_antisymm ?_ fun r hr â†¦ ?_âŸ©
  Â· rw [â† hT, Ideal.span_le]
    intro a ha
    simp only [SetLike.mem_coe, mem_bot, mem_colon_singleton]
    obtain âŸ¨u, huâŸ© : g âŸ¨a, haâŸ© âˆ£ (âˆ a, g a) := by
      apply Finset.dvd_prod_of_mem g (Finset.mem_univ âŸ¨a, haâŸ©)
    rw [hu, Submonoid.coe_mul, smul_smul, â† mul_assoc, mul_comm, â† smul_smul, mul_comm, â† smul_smul]
    exact smul_eq_zero_of_right u.1 (hg âŸ¨a, haâŸ©)
  Â· simp only [mem_bot, mem_colon_singleton, smul_smul] at hr
    have mem : r * (âˆ a, g a).1 âˆˆ Ideal.comap (algebraMap R R') p := by
      simpa only [hx, Ideal.mem_comap, mem_bot, mem_colon_singleton, algebraMap_smul,
        â† IsLocalizedModule.mk'_smul, hr] using IsLocalizedModule.mk'_zero f s
    have := Set.disjoint_left.mp ((IsLocalization.disjoint_comap_iff S R' p).mpr hp.1) (âˆ a, g a).2
    have := (Ideal.IsPrime.under R p).mul_mem_iff_mem_or_mem.mp mem
    tauto
","lemma comap_mem_associatedPrimes_of_mem_associatedPrimes_of_isLocalizedModule_of_fg (p : Ideal R')
    (ass : p âˆˆ associatedPrimes R' M') (fg : (p.comap (algebraMap R R')).FG) :
    p.comap (algebraMap R R') âˆˆ associatedPrimes R M ","Proof.\n      If $\\mathfrak p \\in \\text{Ass}(M)$ there exists an element $m \\in M$ whose annihilator is $\\mathfrak p$. As localization is exact (Proposition 10.9.12 [[\n       \n      \n  Proposition 10.9.12. Let $L\\xrightarrow {u} M\\xrightarrow {v} N$ be an exact sequence of $R$-modules. Then $S^{-1}L \\to S^{-1}M \\to S^{-1}N$ is also exact. \n\n    \n]]) we see that the annihilator of $m/1$ in $M_{\\mathfrak p}$ is $\\mathfrak pR_{\\mathfrak p}$ hence (1) holds. Assume $\\mathfrak pR_{\\mathfrak p} \\in \\text{Ass}(M_{\\mathfrak p})$ and $\\mathfrak p = (f_1, \\ldots , f_ n)$. Let $m/g$ be an element of $M_{\\mathfrak p}$ whose annihilator is $\\mathfrak pR_{\\mathfrak p}$. This implies that the annihilator of $m$ is contained in $\\mathfrak p$. As $f_ i m/g = 0$ in $M_{\\mathfrak p}$ we see there exists a $g_ i \\in R$, $g_ i \\not\\in \\mathfrak p$ such that $g_ i f_ i m = 0$ in $M$. Combined we see the annihilator of $g_1\\ldots g_ nm$ is $\\mathfrak p$. Hence $\\mathfrak p \\in \\text{Ass}(M)$. \n      $\\square$\n    \n"
296,0310,"lemma preimage_comap_associatedPrimes_eq_associatedPrimes_of_isLocalizedModule
    [IsNoetherianRing R] :
    (Ideal.comap (algebraMap R R')) â»Â¹' (associatedPrimes R M) = associatedPrimes R' M' := by
  ext p
  exact âŸ¨mem_associatedPrimes_of_comap_mem_associatedPrimes_of_isLocalizedModule S f p,
    fun h â†¦ comap_mem_associatedPrimes_of_mem_associatedPrimes_of_isLocalizedModule_of_fg S f p h
    ((isNoetherianRing_iff_ideal_fg R).mp â€¹_â€º _)âŸ©
",Formal Proof of Stacks Project Tag 0310,(3),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Ideal/AssociatedPrime/Localization.lean#L125-L131,Q27041,,10.63.15,lemma,3.0,"['00L9', '00AO', '0ELQ']","\n  Lemma 10.63.15. Let $R$ be a ring. Let $M$ be an $R$-module. Let $\\mathfrak p \\subset R$ be a prime. \n  \n  \nIf $\\mathfrak p \\in \\text{Ass}(M)$ then $\\mathfrak pR_{\\mathfrak p} \\in \\text{Ass}(M_{\\mathfrak p})$. \n\n\nIf $\\mathfrak p$ is finitely generated then the converse holds as well. \n\n\n\n\n    \n      Proof.\n      If $\\mathfrak p \\in \\text{Ass}(M)$ there exists an element $m \\in M$ whose annihilator is $\\mathfrak p$. As localization is exact (Proposition 10.9.12) we see that the annihilator of $m/1$ in $M_{\\mathfrak p}$ is $\\mathfrak pR_{\\mathfrak p}$ hence (1) holds. Assume $\\mathfrak pR_{\\mathfrak p} \\in \\text{Ass}(M_{\\mathfrak p})$ and $\\mathfrak p = (f_1, \\ldots , f_ n)$. Let $m/g$ be an element of $M_{\\mathfrak p}$ whose annihilator is $\\mathfrak pR_{\\mathfrak p}$. This implies that the annihilator of $m$ is contained in $\\mathfrak p$. As $f_ i m/g = 0$ in $M_{\\mathfrak p}$ we see there exists a $g_ i \\in R$, $g_ i \\not\\in \\mathfrak p$ such that $g_ i f_ i m = 0$ in $M$. Combined we see the annihilator of $g_1\\ldots g_ nm$ is $\\mathfrak p$. Hence $\\mathfrak p \\in \\text{Ass}(M)$. \n      $\\square$\n    \n",\n  Lemma 10.63.15. Let $R$ be a ring. Let $M$ be an $R$-module. Let $\\mathfrak p \\subset R$ be a prime. \n  \n  \nIf $\\mathfrak p \\in \\text{Ass}(M)$ then $\\mathfrak pR_{\\mathfrak p} \\in \\text{Ass}(M_{\\mathfrak p})$. \n\n\nIf $\\mathfrak p$ is finitely generated then the converse holds as well. \n\n\n\n\n    \n,"Proof.\n      If $\\mathfrak p \\in \\text{Ass}(M)$ there exists an element $m \\in M$ whose annihilator is $\\mathfrak p$. As localization is exact (Proposition 10.9.12) we see that the annihilator of $m/1$ in $M_{\\mathfrak p}$ is $\\mathfrak pR_{\\mathfrak p}$ hence (1) holds. Assume $\\mathfrak pR_{\\mathfrak p} \\in \\text{Ass}(M_{\\mathfrak p})$ and $\\mathfrak p = (f_1, \\ldots , f_ n)$. Let $m/g$ be an element of $M_{\\mathfrak p}$ whose annihilator is $\\mathfrak pR_{\\mathfrak p}$. This implies that the annihilator of $m$ is contained in $\\mathfrak p$. As $f_ i m/g = 0$ in $M_{\\mathfrak p}$ we see there exists a $g_ i \\in R$, $g_ i \\not\\in \\mathfrak p$ such that $g_ i f_ i m = 0$ in $M$. Combined we see the annihilator of $g_1\\ldots g_ nm$ is $\\mathfrak p$. Hence $\\mathfrak p \\in \\text{Ass}(M)$. \n      $\\square$\n    \n"," by
  ext p
  exact âŸ¨mem_associatedPrimes_of_comap_mem_associatedPrimes_of_isLocalizedModule S f p,
    fun h â†¦ comap_mem_associatedPrimes_of_mem_associatedPrimes_of_isLocalizedModule_of_fg S f p h
    ((isNoetherianRing_iff_ideal_fg R).mp â€¹_â€º _)âŸ©
","lemma preimage_comap_associatedPrimes_eq_associatedPrimes_of_isLocalizedModule
    [IsNoetherianRing R] :
    (Ideal.comap (algebraMap R R')) â»Â¹' (associatedPrimes R M) = associatedPrimes R' M' ","Proof.\n      If $\\mathfrak p \\in \\text{Ass}(M)$ there exists an element $m \\in M$ whose annihilator is $\\mathfrak p$. As localization is exact (Proposition 10.9.12 [[\n       \n      \n  Proposition 10.9.12. Let $L\\xrightarrow {u} M\\xrightarrow {v} N$ be an exact sequence of $R$-modules. Then $S^{-1}L \\to S^{-1}M \\to S^{-1}N$ is also exact. \n\n    \n]]) we see that the annihilator of $m/1$ in $M_{\\mathfrak p}$ is $\\mathfrak pR_{\\mathfrak p}$ hence (1) holds. Assume $\\mathfrak pR_{\\mathfrak p} \\in \\text{Ass}(M_{\\mathfrak p})$ and $\\mathfrak p = (f_1, \\ldots , f_ n)$. Let $m/g$ be an element of $M_{\\mathfrak p}$ whose annihilator is $\\mathfrak pR_{\\mathfrak p}$. This implies that the annihilator of $m$ is contained in $\\mathfrak p$. As $f_ i m/g = 0$ in $M_{\\mathfrak p}$ we see there exists a $g_ i \\in R$, $g_ i \\not\\in \\mathfrak p$ such that $g_ i f_ i m = 0$ in $M$. Combined we see the annihilator of $g_1\\ldots g_ nm$ is $\\mathfrak p$. Hence $\\mathfrak p \\in \\text{Ass}(M)$. \n      $\\square$\n    \n"
297,00FK,"    (hf : Function.Injective f) (p) (H : p âˆˆ minimalPrimes R) :
    âˆƒ p' : Ideal S, p'.IsPrime âˆ§ p'.comap f = p :=
  have âŸ¨p', hp', _, eqâŸ© := exists_comap_eq_of_mem_minimalPrimes f (I := âŠ¥) p <| by
    rwa [comap_bot_of_injective f hf]
  âŸ¨p', hp', eqâŸ©
",Formal Proof of Stacks Project Tag 00FK, theorem Ideal.exists_comap_eq_of_mem_minimalPrimes_of_injective {f : R â†’+* S,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Ideal/MinimalPrime/Localization.lean#L105-L109,Q27041,,10.30.5,lemma,3.0,"['00FF', '00AO', '0ELQ']","\n  Lemma 10.30.5. Let $R \\subset S$ be an injective ring map. Then $\\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R)$ hits all the minimal primes. \n\n    \n      Proof.\n      Let $\\mathfrak p \\subset R$ be a minimal prime. In this case $R_{\\mathfrak p}$ has a unique prime ideal. Hence it suffices to show that $S_{\\mathfrak p}$ is not zero. And this follows from the fact that localization is exact, see Proposition 10.9.12. \n      $\\square$\n    \n",\n  Lemma 10.30.5. Let $R \\subset S$ be an injective ring map. Then $\\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R)$ hits all the minimal primes. \n\n    \n,"Proof.\n      Let $\\mathfrak p \\subset R$ be a minimal prime. In this case $R_{\\mathfrak p}$ has a unique prime ideal. Hence it suffices to show that $S_{\\mathfrak p}$ is not zero. And this follows from the fact that localization is exact, see Proposition 10.9.12. \n      $\\square$\n    \n","
  have âŸ¨p', hp', _, eqâŸ© := exists_comap_eq_of_mem_minimalPrimes f (I := âŠ¥) p <| by
    rwa [comap_bot_of_injective f hf]
  âŸ¨p', hp', eqâŸ©
","    (hf : Function.Injective f) (p) (H : p âˆˆ minimalPrimes R) :
    âˆƒ p' : Ideal S, p'.IsPrime âˆ§ p'.comap f = p ","Proof.\n      Let $\\mathfrak p \\subset R$ be a minimal prime. In this case $R_{\\mathfrak p}$ has a unique prime ideal. Hence it suffices to show that $S_{\\mathfrak p}$ is not zero. And this follows from the fact that localization is exact, see Proposition 10.9.12 [[\n       \n      \n  Proposition 10.9.12. Let $L\\xrightarrow {u} M\\xrightarrow {v} N$ be an exact sequence of $R$-modules. Then $S^{-1}L \\to S^{-1}M \\to S^{-1}N$ is also exact. \n\n    \n]]. \n      $\\square$\n    \n"
298,00H8,"instance [IsDomain S] [FaithfulSMul R S] [Algebra.IsIntegral R S] [IsIntegrallyClosed R] :
    Algebra.HasGoingDown R S := by
  have := (FaithfulSMul.algebraMap_injective R S).isDomain
  constructor
  intro p _ Q _ hpQ
  let SQ := Localization.AtPrime Q
  suffices (p.map (algebraMap _ SQ)).comap (algebraMap _ SQ) â‰¤ p by
    obtain âŸ¨P, hP, eâŸ© :=
      (Ideal.comap_map_eq_self_iff_of_isPrime _).mp (this.antisymm Ideal.le_comap_map)
    refine âŸ¨P.under S, ?_, inferInstance, âŸ¨by rw [Ideal.under_under, â† e]âŸ©âŸ©
    exact (Ideal.comap_mono (IsLocalRing.le_maximalIdeal_of_isPrime P)).trans_eq
      Localization.AtPrime.comap_maximalIdeal
  intro x hx
  obtain âŸ¨a, ha, haQâŸ© : âˆƒ a, x â€¢ a âˆˆ Ideal.map (algebraMap R S) p âˆ§ a âˆ‰ Q := by
    simpa [Algebra.smul_def, IsScalarTower.algebraMap_eq R S SQ, â† Ideal.map_map,
      IsLocalization.mem_map_algebraMap_iff Q.primeCompl, â† map_mul] using hx
  obtain âŸ¨f, hfm, hfa, hfâŸ© := exists_monic_aeval_eq_zero_forall_mem_of_mem_map ha
  obtain âŸ¨i, hi, hipâŸ© : âˆƒ i â‰  (minpoly R a).natDegree, (minpoly R a).coeff i âˆ‰ p := by
    set g := minpoly R a
    by_contra! H
    have : g.map (Ideal.Quotient.mk p) = X ^ g.natDegree := by
      ext i
      obtain hi | rfl | hi := lt_trichotomy i g.natDegree
      Â· simpa [hi.ne, Ideal.Quotient.eq_zero_iff_mem] using H _ hi.ne
      Â· simp [g, minpoly.monic (Algebra.IsIntegral.isIntegral _)]
      Â· simp [coeff_eq_zero_of_natDegree_lt hi, hi.ne']
    have : Ideal.Quotient.mk (Ideal.map (algebraMap R S) p) (a ^ (minpoly R a).natDegree) = 0 := by
      simpa [â† Ideal.Quotient.algebraMap_eq, aeval_algebraMap_apply, g] using
        congr(aeval (Ideal.Quotient.mk (Ideal.map (algebraMap R S) p) a) $this).symm
    exact haQ (â€¹Q.IsPrimeâ€º.mem_of_pow_mem _
      (Ideal.map_le_iff_le_comap.mpr hpQ.le (Ideal.Quotient.eq_zero_iff_mem.mp this)))
  by_cases hx0 : x = 0; Â· simp [hx0]
  have := Polynomial.coeff_mem_radical_span_coeff_of_dvd _ _ hfm
    (minpoly.monic (Algebra.IsIntegral.isIntegral _))
    (minpoly.isIntegrallyClosed_dvd (Algebra.IsIntegral.isIntegral _) hfa)
  simp only [IsIntegrallyClosed.minpoly_smul hx0 (Algebra.IsIntegral.isIntegral _),
    natDegree_scaleRoots, coeff_scaleRoots, Ideal.radical_eq_sInf, Submodule.mem_sInf,
    Set.mem_setOf_eq, and_imp] at this
  refine â€¹p.IsPrimeâ€º.mem_of_pow_mem _ ((â€¹p.IsPrimeâ€º.mem_or_mem
    (this i hi p ?_ inferInstance)).resolve_left hip)
  simp +contextual [Ideal.span_le, Set.subset_def, LT.lt.ne, hf]
",Formal Proof of Stacks Project Tag 00H8,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/IntegralClosure/GoingDown.lean#L48,Q27041,,10.38.7,proposition,3.0,"['037E', '00AO', '0ELQ']","\n  Proposition 10.38.7. Let $R \\subset S$ be an inclusion of domains. Assume $R$ is normal and $S$ integral over $R$. Let $\\mathfrak p \\subset \\mathfrak p\' \\subset R$ be primes. Let $\\mathfrak q\'$ be a prime of $S$ with $\\mathfrak p\' = R \\cap \\mathfrak q\'$. Then there exists a prime $\\mathfrak q$ with $\\mathfrak q \\subset \\mathfrak q\'$ such that $\\mathfrak p = R \\cap \\mathfrak q$. In other words: the going down property holds for $R \\to S$, see Definition 10.41.1. \n\n    \n      Proof.\n      Let $\\mathfrak p$, $\\mathfrak p\'$ and $\\mathfrak q\'$ be as in the statement. We have to show there is a prime $\\mathfrak q$, with $\\mathfrak q \\subset \\mathfrak q\'$ and $R \\cap \\mathfrak q = \\mathfrak p$. This is the same as finding a prime of $S_{\\mathfrak q\'}$ mapping to $\\mathfrak p$. According to Lemma 10.18.6 we have to show that $\\mathfrak p S_{\\mathfrak q\'} \\cap R = \\mathfrak p$. Pick $z \\in \\mathfrak p S_{\\mathfrak q\'} \\cap R$. We may write $z = y/g$ with $y \\in \\mathfrak pS$ and $g \\in S$, $g \\not\\in \\mathfrak q\'$. Written differently we have $zg = y$. \n    \n      By Lemma 10.38.4 there exists a monic polynomial $P = x^ m + b_{m-1} x^{m-1} + \\ldots + b_0$ with $b_ i \\in \\mathfrak p$ such that $P(y) = 0$. \n    \n      By Lemma 10.38.6 the minimal polynomial of $g$ over $K$ has coefficients in $R$. Write it as $Q = x^ n + a_{n-1} x^{n-1} + \\ldots + a_0$. Note that not all $a_ i$, $i = n-1, \\ldots , 0$ are in $\\mathfrak p$ since that would imply $g^ n = \\sum _{j < n} a_ j g^ j \\in \\mathfrak pS \\subset \\mathfrak p\'S \\subset \\mathfrak q\'$ which is a contradiction. \n    \n      Since $y = zg$ we see immediately from the above that $Q\' = x^ n + za_{n-1} x^{n-1} + \\ldots + z^{n}a_0$ is the minimal polynomial for $y$. Hence $Q\'$ divides $P$ and by Lemma 10.38.5 we see that $z^ ja_{n - j} \\in \\sqrt{(b_0, \\ldots , b_{m-1})} \\subset \\mathfrak p$, $j = 1, \\ldots , n$. Because not all $a_ i$, $i = n-1, \\ldots , 0$ are in $\\mathfrak p$ we conclude $z \\in \\mathfrak p$ as desired. \n      $\\square$\n    \n","\n  Proposition 10.38.7. Let $R \\subset S$ be an inclusion of domains. Assume $R$ is normal and $S$ integral over $R$. Let $\\mathfrak p \\subset \\mathfrak p\' \\subset R$ be primes. Let $\\mathfrak q\'$ be a prime of $S$ with $\\mathfrak p\' = R \\cap \\mathfrak q\'$. Then there exists a prime $\\mathfrak q$ with $\\mathfrak q \\subset \\mathfrak q\'$ such that $\\mathfrak p = R \\cap \\mathfrak q$. In other words: the going down property holds for $R \\to S$, see Definition 10.41.1. \n\n    \n","Proof.\n      Let $\\mathfrak p$, $\\mathfrak p\'$ and $\\mathfrak q\'$ be as in the statement. We have to show there is a prime $\\mathfrak q$, with $\\mathfrak q \\subset \\mathfrak q\'$ and $R \\cap \\mathfrak q = \\mathfrak p$. This is the same as finding a prime of $S_{\\mathfrak q\'}$ mapping to $\\mathfrak p$. According to Lemma 10.18.6 we have to show that $\\mathfrak p S_{\\mathfrak q\'} \\cap R = \\mathfrak p$. Pick $z \\in \\mathfrak p S_{\\mathfrak q\'} \\cap R$. We may write $z = y/g$ with $y \\in \\mathfrak pS$ and $g \\in S$, $g \\not\\in \\mathfrak q\'$. Written differently we have $zg = y$. \n    \n      By Lemma 10.38.4 there exists a monic polynomial $P = x^ m + b_{m-1} x^{m-1} + \\ldots + b_0$ with $b_ i \\in \\mathfrak p$ such that $P(y) = 0$. \n    \n      By Lemma 10.38.6 the minimal polynomial of $g$ over $K$ has coefficients in $R$. Write it as $Q = x^ n + a_{n-1} x^{n-1} + \\ldots + a_0$. Note that not all $a_ i$, $i = n-1, \\ldots , 0$ are in $\\mathfrak p$ since that would imply $g^ n = \\sum _{j < n} a_ j g^ j \\in \\mathfrak pS \\subset \\mathfrak p\'S \\subset \\mathfrak q\'$ which is a contradiction. \n    \n      Since $y = zg$ we see immediately from the above that $Q\' = x^ n + za_{n-1} x^{n-1} + \\ldots + z^{n}a_0$ is the minimal polynomial for $y$. Hence $Q\'$ divides $P$ and by Lemma 10.38.5 we see that $z^ ja_{n - j} \\in \\sqrt{(b_0, \\ldots , b_{m-1})} \\subset \\mathfrak p$, $j = 1, \\ldots , n$. Because not all $a_ i$, $i = n-1, \\ldots , 0$ are in $\\mathfrak p$ we conclude $z \\in \\mathfrak p$ as desired. \n      $\\square$\n    \n"," by
  have := (FaithfulSMul.algebraMap_injective R S).isDomain
  constructor
  intro p _ Q _ hpQ
  let SQ := Localization.AtPrime Q
  suffices (p.map (algebraMap _ SQ)).comap (algebraMap _ SQ) â‰¤ p by
    obtain âŸ¨P, hP, eâŸ© :=
      (Ideal.comap_map_eq_self_iff_of_isPrime _).mp (this.antisymm Ideal.le_comap_map)
    refine âŸ¨P.under S, ?_, inferInstance, âŸ¨by rw [Ideal.under_under, â† e]âŸ©âŸ©
    exact (Ideal.comap_mono (IsLocalRing.le_maximalIdeal_of_isPrime P)).trans_eq
      Localization.AtPrime.comap_maximalIdeal
  intro x hx
  obtain âŸ¨a, ha, haQâŸ© : âˆƒ a, x â€¢ a âˆˆ Ideal.map (algebraMap R S) p âˆ§ a âˆ‰ Q := by
    simpa [Algebra.smul_def, IsScalarTower.algebraMap_eq R S SQ, â† Ideal.map_map,
      IsLocalization.mem_map_algebraMap_iff Q.primeCompl, â† map_mul] using hx
  obtain âŸ¨f, hfm, hfa, hfâŸ© := exists_monic_aeval_eq_zero_forall_mem_of_mem_map ha
  obtain âŸ¨i, hi, hipâŸ© : âˆƒ i â‰  (minpoly R a).natDegree, (minpoly R a).coeff i âˆ‰ p := by
    set g := minpoly R a
    by_contra! H
    have : g.map (Ideal.Quotient.mk p) = X ^ g.natDegree := by
      ext i
      obtain hi | rfl | hi := lt_trichotomy i g.natDegree
      Â· simpa [hi.ne, Ideal.Quotient.eq_zero_iff_mem] using H _ hi.ne
      Â· simp [g, minpoly.monic (Algebra.IsIntegral.isIntegral _)]
      Â· simp [coeff_eq_zero_of_natDegree_lt hi, hi.ne']
    have : Ideal.Quotient.mk (Ideal.map (algebraMap R S) p) (a ^ (minpoly R a).natDegree) = 0 := by
      simpa [â† Ideal.Quotient.algebraMap_eq, aeval_algebraMap_apply, g] using
        congr(aeval (Ideal.Quotient.mk (Ideal.map (algebraMap R S) p) a) $this).symm
    exact haQ (â€¹Q.IsPrimeâ€º.mem_of_pow_mem _
      (Ideal.map_le_iff_le_comap.mpr hpQ.le (Ideal.Quotient.eq_zero_iff_mem.mp this)))
  by_cases hx0 : x = 0; Â· simp [hx0]
  have := Polynomial.coeff_mem_radical_span_coeff_of_dvd _ _ hfm
    (minpoly.monic (Algebra.IsIntegral.isIntegral _))
    (minpoly.isIntegrallyClosed_dvd (Algebra.IsIntegral.isIntegral _) hfa)
  simp only [IsIntegrallyClosed.minpoly_smul hx0 (Algebra.IsIntegral.isIntegral _),
    natDegree_scaleRoots, coeff_scaleRoots, Ideal.radical_eq_sInf, Submodule.mem_sInf,
    Set.mem_setOf_eq, and_imp] at this
  refine â€¹p.IsPrimeâ€º.mem_of_pow_mem _ ((â€¹p.IsPrimeâ€º.mem_or_mem
    (this i hi p ?_ inferInstance)).resolve_left hip)
  simp +contextual [Ideal.span_le, Set.subset_def, LT.lt.ne, hf]
","instance [IsDomain S] [FaithfulSMul R S] [Algebra.IsIntegral R S] [IsIntegrallyClosed R] :
    Algebra.HasGoingDown R S ","Proof.\n      Let $\\mathfrak p$, $\\mathfrak p\'$ and $\\mathfrak q\'$ be as in the statement. We have to show there is a prime $\\mathfrak q$, with $\\mathfrak q \\subset \\mathfrak q\'$ and $R \\cap \\mathfrak q = \\mathfrak p$. This is the same as finding a prime of $S_{\\mathfrak q\'}$ mapping to $\\mathfrak p$. According to Lemma 10.18.6 [[\n  Lemma 10.18.6. Let $\\varphi : R \\to S$ be a ring map. Let $\\mathfrak p$ be a prime of $R$. The following are equivalent \n  \n  \n$\\mathfrak p$ is in the image of $\\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R)$, \n\n\n$S \\otimes _ R \\kappa (\\mathfrak p) \\not= 0$, \n\n\n$S_{\\mathfrak p}/\\mathfrak p S_{\\mathfrak p} \\not= 0$, \n\n\n$(S/\\mathfrak pS)_{\\mathfrak p} \\not= 0$, and \n\n\n$\\mathfrak p = \\varphi ^{-1}(\\mathfrak pS)$. \n\n\n\n\n    \n]] we have to show that $\\mathfrak p S_{\\mathfrak q\'} \\cap R = \\mathfrak p$. Pick $z \\in \\mathfrak p S_{\\mathfrak q\'} \\cap R$. We may write $z = y/g$ with $y \\in \\mathfrak pS$ and $g \\in S$, $g \\not\\in \\mathfrak q\'$. Written differently we have $zg = y$. \n    \n      By Lemma 10.38.4 [[\n  Lemma 10.38.4. Suppose $\\varphi : R \\to S$ is integral. Suppose $I \\subset R$ is an ideal. Then every element of $IS$ is integral over $I$. \n\n    \n]] there exists a monic polynomial $P = x^ m + b_{m-1} x^{m-1} + \\ldots + b_0$ with $b_ i \\in \\mathfrak p$ such that $P(y) = 0$. \n    \n      By Lemma 10.38.6 [[\n  Lemma 10.38.6. Let $R \\subset S$ be an inclusion of domains. Assume $R$ is normal. Let $g \\in S$ be integral over $R$. Then the minimal polynomial of $g$ has coefficients in $R$. \n\n    \n]] the minimal polynomial of $g$ over $K$ has coefficients in $R$. Write it as $Q = x^ n + a_{n-1} x^{n-1} + \\ldots + a_0$. Note that not all $a_ i$, $i = n-1, \\ldots , 0$ are in $\\mathfrak p$ since that would imply $g^ n = \\sum _{j < n} a_ j g^ j \\in \\mathfrak pS \\subset \\mathfrak p\'S \\subset \\mathfrak q\'$ which is a contradiction. \n    \n      Since $y = zg$ we see immediately from the above that $Q\' = x^ n + za_{n-1} x^{n-1} + \\ldots + z^{n}a_0$ is the minimal polynomial for $y$. Hence $Q\'$ divides $P$ and by Lemma 10.38.5 [[\n  Lemma 10.38.5. Let $K$ be a field. Let $n, m \\in \\mathbf{N}$ and $a_0, \\ldots , a_{n - 1}, b_0, \\ldots , b_{m - 1} \\in K$. If the polynomial $x^ n + a_{n - 1}x^{n - 1} + \\ldots + a_0$ divides the polynomial $x^ m + b_{m - 1} x^{m - 1} + \\ldots + b_0$ in $K[x]$ then \n  \n  \n$a_0, \\ldots , a_{n - 1}$ are integral over any subring $R_0$ of $K$ containing the elements $b_0, \\ldots , b_{m - 1}$, and \n\n\neach $a_ i$ lies in $\\sqrt{(b_0, \\ldots , b_{m-1})R}$ for any subring $R \\subset K$ containing the elements $a_0, \\ldots , a_{n - 1}, b_0, \\ldots , b_{m - 1}$. \n\n\n\n\n    \n]] we see that $z^ ja_{n - j} \\in \\sqrt{(b_0, \\ldots , b_{m-1})} \\subset \\mathfrak p$, $j = 1, \\ldots , n$. Because not all $a_ i$, $i = n-1, \\ldots , 0$ are in $\\mathfrak p$ we conclude $z \\in \\mathfrak p$ as desired. \n      $\\square$\n    \n"
299,00GK,"theorem RingHom.Finite.to_isIntegral (h : f.Finite) : f.IsIntegral :=
  letI := f.toAlgebra
  fun _ â†¦ IsIntegral.of_mem_of_fg âŠ¤ h.1 _ trivial
",Formal Proof of Stacks Project Tag 00GK,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/IntegralClosure/Algebra/Basic.lean#L127-L129,Q27041,,10.36.3,lemma,3.0,"['00GH', '00AO', '0ELQ']",\n  Lemma 10.36.3. A finite ring map is integral. \n\n    \n      Proof.\n      Let $R \\to S$ be finite. Let $y \\in S$. Apply Lemma 10.36.2 to $M = S$ to see that $y$ is integral over $R$. \n      $\\square$\n    \n,\n  Lemma 10.36.3. A finite ring map is integral. \n\n    \n,Proof.\n      Let $R \\to S$ be finite. Let $y \\in S$. Apply Lemma 10.36.2 to $M = S$ to see that $y$ is integral over $R$. \n      $\\square$\n    \n,"
  letI := f.toAlgebra
  fun _ â†¦ IsIntegral.of_mem_of_fg âŠ¤ h.1 _ trivial
",theorem RingHom.Finite.to_isIntegral (h : f.Finite) : f.IsIntegral ,"Proof.\n      Let $R \\to S$ be finite. Let $y \\in S$. Apply Lemma 10.36.2 [[\n  Lemma 10.36.2. Let $\\varphi : R \\to S$ be a ring map. Let $y \\in S$. If there exists a finite $R$-submodule $M$ of $S$ such that $1 \\in M$ and $yM \\subset M$, then $y$ is integral over $R$. \n\n    \n]] to $M = S$ to see that $y$ is integral over $R$. \n      $\\square$\n    \n"
300,00H5,"lemma exists_monic_aeval_eq_zero_forall_mem_of_mem_map [Algebra.IsIntegral R S]
    {I : Ideal R} {x : S} (hx : x âˆˆ I.map (algebraMap R S)) :
    âˆƒ p : R[X], p.Monic âˆ§ aeval x p = 0 âˆ§ âˆ€ i â‰  p.natDegree, p.coeff i âˆˆ I := by
  obtain âŸ¨p, hp, e, hâŸ© := exists_monic_aeval_eq_zero_forall_mem_pow_of_mem_map hx
  refine âŸ¨p, hp, e, fun i hi â†¦ ?_âŸ©
  obtain hi | hi := hi.lt_or_gt
  Â· exact Ideal.pow_le_self (by lia) (h _)
  Â· simp [coeff_eq_zero_of_natDegree_lt hi]
",Formal Proof of Stacks Project Tag 00H5,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/IntegralClosure/Algebra/Ideal.lean#L93-L100,Q27041,,10.38.4,lemma,3.0,"['037E', '00AO', '0ELQ']",\n  Lemma 10.38.4. Suppose $\\varphi : R \\to S$ is integral. Suppose $I \\subset R$ is an ideal. Then every element of $IS$ is integral over $I$. \n\n    \n      Proof.\n      Immediate from Lemma 10.38.3. \n      $\\square$\n    \n,\n  Lemma 10.38.4. Suppose $\\varphi : R \\to S$ is integral. Suppose $I \\subset R$ is an ideal. Then every element of $IS$ is integral over $I$. \n\n    \n,Proof.\n      Immediate from Lemma 10.38.3. \n      $\\square$\n    \n," by
  obtain âŸ¨p, hp, e, hâŸ© := exists_monic_aeval_eq_zero_forall_mem_pow_of_mem_map hx
  refine âŸ¨p, hp, e, fun i hi â†¦ ?_âŸ©
  obtain hi | hi := hi.lt_or_gt
  Â· exact Ideal.pow_le_self (by lia) (h _)
  Â· simp [coeff_eq_zero_of_natDegree_lt hi]
","lemma exists_monic_aeval_eq_zero_forall_mem_of_mem_map [Algebra.IsIntegral R S]
    {I : Ideal R} {x : S} (hx : x âˆˆ I.map (algebraMap R S)) :
    âˆƒ p : R[X], p.Monic âˆ§ aeval x p = 0 âˆ§ âˆ€ i â‰  p.natDegree, p.coeff i âˆˆ I ","Proof.\n      Immediate from Lemma 10.38.3 [[\n  Lemma 10.38.3. Let $\\varphi : R \\to S$ be a ring map. Let $I \\subset R$ be an ideal. The set of elements of $S$ which are integral over $I$ form a $R$-submodule of $S$. Furthermore, if $s \\in S$ is integral over $R$, and $s\'$ is integral over $I$, then $ss\'$ is integral over $I$. \n\n    \n]]. \n      $\\square$\n    \n"
301,00GW,"def IsAlmostIntegral (s : S) : Prop := âˆƒ r âˆˆ Râ°, âˆ€ n, r â€¢ s ^ n âˆˆ (algebraMap R S).range
",Formal Proof of Stacks Project Tag 00GW,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/IntegralClosure/IsIntegral/AlmostIntegral.lean#L26-L26,Q27041,,10.37.3,definition,3.0,"['037B', '00AO', '0ELQ']","\n  Definition 10.37.3. Let $R$ be a domain. \n  \n  \nAn element $g$ of the fraction field of $R$ is called almost integral over $R$ if there exists an element $r \\in R$, $r\\not= 0$ such that $rg^ n \\in R$ for all $n \\geq 0$. \n\n\nThe domain $R$ is called completely normal if every almost integral element of the fraction field of $R$ is contained in $R$. \n\n\n\n","\n  Definition 10.37.3. Let $R$ be a domain. \n  \n  \nAn element $g$ of the fraction field of $R$ is called almost integral over $R$ if there exists an element $r \\in R$, $r\\not= 0$ such that $rg^ n \\in R$ for all $n \\geq 0$. \n\n\nThe domain $R$ is called completely normal if every almost integral element of the fraction field of $R$ is contained in $R$. \n\n\n\n",," âˆƒ r âˆˆ Râ°, âˆ€ n, r â€¢ s ^ n âˆˆ (algebraMap R S).range
",def IsAlmostIntegral (s : S) : Prop ,
302,00GX,"def completeIntegralClosure : Subalgebra R S where
  carrier := { s | IsAlmostIntegral R s }
  mul_mem' := by
    rintro a b âŸ¨r, hr, hr'âŸ© âŸ¨s, hs, hs'âŸ©
    refine âŸ¨r * s, mul_mem hr hs, fun n â†¦ ?_âŸ©
    rw [mul_pow, mul_smul_mul_comm]
    exact mul_mem (hr' _) (hs' _)
  add_mem' := by
    rintro a b âŸ¨r, hr, hr'âŸ© âŸ¨s, hs, hs'âŸ©
    refine âŸ¨r * s, mul_mem hr hs, fun n â†¦ ?_âŸ©
    simp only [add_pow, Finset.smul_sum, â† smul_mul_assoc _ (_ * _),
      â† smul_mul_smul_comm _ (a ^ _)]
    exact sum_mem fun i _ â†¦ mul_mem (mul_mem (hr' _) (hs' _)) (by simp)
  algebraMap_mem' r := âŸ¨1, one_mem _, by simp [â† map_pow]âŸ©
",Formal Proof of Stacks Project Tag 00GX,Part 1,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/IntegralClosure/IsIntegral/AlmostIntegral.lean#L31-L44,Q27041,,10.37.4,lemma,3.0,"['037B', '00AO', '0ELQ']","\n  Lemma 10.37.4. Let $R$ be a domain with fraction field $K$. If $u, v \\in K$ are almost integral over $R$, then so are $u + v$ and $uv$. Any element $g \\in K$ which is integral over $R$ is almost integral over $R$. If $R$ is Noetherian then the converse holds as well. \n\n    \n      Proof.\n      If $ru^ n \\in R$ for all $n \\geq 0$ and $v^ nr\' \\in R$ for all $n \\geq 0$, then $(uv)^ nrr\'$ and $(u + v)^ nrr\'$ are in $R$ for all $n \\geq 0$. Hence the first assertion. Suppose $g \\in K$ is integral over $R$. In this case there exists an $d > 0$ such that the ring $R[g]$ is generated by $1, g, \\ldots , g^ d$ as an $R$-module. Let $r \\in R$ be a common denominator of the elements $1, g, \\ldots , g^ d \\in K$. It follows that $rR[g] \\subset R$, and hence $g$ is almost integral over $R$. \n    \n      Suppose $R$ is Noetherian and $g \\in K$ is almost integral over $R$. Let $r \\in R$, $r\\not= 0$ be as in the definition. Then $R[g] \\subset \\frac{1}{r}R$ as an $R$-module. Since $R$ is Noetherian this implies that $R[g]$ is finite over $R$. Hence $g$ is integral over $R$, see Lemma 10.36.3. \n      $\\square$\n    \n","\n  Lemma 10.37.4. Let $R$ be a domain with fraction field $K$. If $u, v \\in K$ are almost integral over $R$, then so are $u + v$ and $uv$. Any element $g \\in K$ which is integral over $R$ is almost integral over $R$. If $R$ is Noetherian then the converse holds as well. \n\n    \n","Proof.\n      If $ru^ n \\in R$ for all $n \\geq 0$ and $v^ nr\' \\in R$ for all $n \\geq 0$, then $(uv)^ nrr\'$ and $(u + v)^ nrr\'$ are in $R$ for all $n \\geq 0$. Hence the first assertion. Suppose $g \\in K$ is integral over $R$. In this case there exists an $d > 0$ such that the ring $R[g]$ is generated by $1, g, \\ldots , g^ d$ as an $R$-module. Let $r \\in R$ be a common denominator of the elements $1, g, \\ldots , g^ d \\in K$. It follows that $rR[g] \\subset R$, and hence $g$ is almost integral over $R$. \n    \n      Suppose $R$ is Noetherian and $g \\in K$ is almost integral over $R$. Let $r \\in R$, $r\\not= 0$ be as in the definition. Then $R[g] \\subset \\frac{1}{r}R$ as an $R$-module. Since $R$ is Noetherian this implies that $R[g]$ is finite over $R$. Hence $g$ is integral over $R$, see Lemma 10.36.3. \n      $\\square$\n    \n"," { s | IsAlmostIntegral R s }
  mul_mem' := by
    rintro a b âŸ¨r, hr, hr'âŸ© âŸ¨s, hs, hs'âŸ©
    refine âŸ¨r * s, mul_mem hr hs, fun n â†¦ ?_âŸ©
    rw [mul_pow, mul_smul_mul_comm]
    exact mul_mem (hr' _) (hs' _)
  add_mem' := by
    rintro a b âŸ¨r, hr, hr'âŸ© âŸ¨s, hs, hs'âŸ©
    refine âŸ¨r * s, mul_mem hr hs, fun n â†¦ ?_âŸ©
    simp only [add_pow, Finset.smul_sum, â† smul_mul_assoc _ (_ * _),
      â† smul_mul_smul_comm _ (a ^ _)]
    exact sum_mem fun i _ â†¦ mul_mem (mul_mem (hr' _) (hs' _)) (by simp)
  algebraMap_mem' r := âŸ¨1, one_mem _, by simp [â† map_pow]âŸ©
","def completeIntegralClosure : Subalgebra R S where
  carrier ","Proof.\n      If $ru^ n \\in R$ for all $n \\geq 0$ and $v^ nr\' \\in R$ for all $n \\geq 0$, then $(uv)^ nrr\'$ and $(u + v)^ nrr\'$ are in $R$ for all $n \\geq 0$. Hence the first assertion. Suppose $g \\in K$ is integral over $R$. In this case there exists an $d > 0$ such that the ring $R[g]$ is generated by $1, g, \\ldots , g^ d$ as an $R$-module. Let $r \\in R$ be a common denominator of the elements $1, g, \\ldots , g^ d \\in K$. It follows that $rR[g] \\subset R$, and hence $g$ is almost integral over $R$. \n    \n      Suppose $R$ is Noetherian and $g \\in K$ is almost integral over $R$. Let $r \\in R$, $r\\not= 0$ be as in the definition. Then $R[g] \\subset \\frac{1}{r}R$ as an $R$-module. Since $R$ is Noetherian this implies that $R[g]$ is finite over $R$. Hence $g$ is integral over $R$, see Lemma 10.36.3 [[\n  Lemma 10.36.3. A finite ring map is integral. \n\n    \n]]. \n      $\\square$\n    \n"
303,00GX,"lemma IsIntegral.isAlmostIntegral [IsFractionRing R S]
    {s : S} (H : IsIntegral R s) : IsAlmostIntegral R s :=
  H.isAlmostIntegral_of_isLocalization _ le_rfl
",Formal Proof of Stacks Project Tag 00GX,Part 2,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/IntegralClosure/IsIntegral/AlmostIntegral.lean#L78-L80,Q27041,,10.37.4,lemma,3.0,"['037B', '00AO', '0ELQ']","\n  Lemma 10.37.4. Let $R$ be a domain with fraction field $K$. If $u, v \\in K$ are almost integral over $R$, then so are $u + v$ and $uv$. Any element $g \\in K$ which is integral over $R$ is almost integral over $R$. If $R$ is Noetherian then the converse holds as well. \n\n    \n      Proof.\n      If $ru^ n \\in R$ for all $n \\geq 0$ and $v^ nr\' \\in R$ for all $n \\geq 0$, then $(uv)^ nrr\'$ and $(u + v)^ nrr\'$ are in $R$ for all $n \\geq 0$. Hence the first assertion. Suppose $g \\in K$ is integral over $R$. In this case there exists an $d > 0$ such that the ring $R[g]$ is generated by $1, g, \\ldots , g^ d$ as an $R$-module. Let $r \\in R$ be a common denominator of the elements $1, g, \\ldots , g^ d \\in K$. It follows that $rR[g] \\subset R$, and hence $g$ is almost integral over $R$. \n    \n      Suppose $R$ is Noetherian and $g \\in K$ is almost integral over $R$. Let $r \\in R$, $r\\not= 0$ be as in the definition. Then $R[g] \\subset \\frac{1}{r}R$ as an $R$-module. Since $R$ is Noetherian this implies that $R[g]$ is finite over $R$. Hence $g$ is integral over $R$, see Lemma 10.36.3. \n      $\\square$\n    \n","\n  Lemma 10.37.4. Let $R$ be a domain with fraction field $K$. If $u, v \\in K$ are almost integral over $R$, then so are $u + v$ and $uv$. Any element $g \\in K$ which is integral over $R$ is almost integral over $R$. If $R$ is Noetherian then the converse holds as well. \n\n    \n","Proof.\n      If $ru^ n \\in R$ for all $n \\geq 0$ and $v^ nr\' \\in R$ for all $n \\geq 0$, then $(uv)^ nrr\'$ and $(u + v)^ nrr\'$ are in $R$ for all $n \\geq 0$. Hence the first assertion. Suppose $g \\in K$ is integral over $R$. In this case there exists an $d > 0$ such that the ring $R[g]$ is generated by $1, g, \\ldots , g^ d$ as an $R$-module. Let $r \\in R$ be a common denominator of the elements $1, g, \\ldots , g^ d \\in K$. It follows that $rR[g] \\subset R$, and hence $g$ is almost integral over $R$. \n    \n      Suppose $R$ is Noetherian and $g \\in K$ is almost integral over $R$. Let $r \\in R$, $r\\not= 0$ be as in the definition. Then $R[g] \\subset \\frac{1}{r}R$ as an $R$-module. Since $R$ is Noetherian this implies that $R[g]$ is finite over $R$. Hence $g$ is integral over $R$, see Lemma 10.36.3. \n      $\\square$\n    \n","
  H.isAlmostIntegral_of_isLocalization _ le_rfl
","lemma IsIntegral.isAlmostIntegral [IsFractionRing R S]
    {s : S} (H : IsIntegral R s) : IsAlmostIntegral R s ","Proof.\n      If $ru^ n \\in R$ for all $n \\geq 0$ and $v^ nr\' \\in R$ for all $n \\geq 0$, then $(uv)^ nrr\'$ and $(u + v)^ nrr\'$ are in $R$ for all $n \\geq 0$. Hence the first assertion. Suppose $g \\in K$ is integral over $R$. In this case there exists an $d > 0$ such that the ring $R[g]$ is generated by $1, g, \\ldots , g^ d$ as an $R$-module. Let $r \\in R$ be a common denominator of the elements $1, g, \\ldots , g^ d \\in K$. It follows that $rR[g] \\subset R$, and hence $g$ is almost integral over $R$. \n    \n      Suppose $R$ is Noetherian and $g \\in K$ is almost integral over $R$. Let $r \\in R$, $r\\not= 0$ be as in the definition. Then $R[g] \\subset \\frac{1}{r}R$ as an $R$-module. Since $R$ is Noetherian this implies that $R[g]$ is finite over $R$. Hence $g$ is integral over $R$, see Lemma 10.36.3 [[\n  Lemma 10.36.3. A finite ring map is integral. \n\n    \n]]. \n      $\\square$\n    \n"
304,00GX,"lemma IsAlmostIntegral.isIntegral [IsNoetherianRing R] [IsDomain S] [FaithfulSMul R S]
    {s : S} (H : IsAlmostIntegral R s) : IsIntegral R s := by
  have : IsDomain R := (FaithfulSMul.algebraMap_injective R S).isDomain
  exact H.isIntegral_of_nonZeroDivisors_le_comap fun _ â†¦ by simp
",Formal Proof of Stacks Project Tag 00GX,Part 3,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/IntegralClosure/IsIntegral/AlmostIntegral.lean#L115-L118,Q27041,,10.37.4,lemma,3.0,"['037B', '00AO', '0ELQ']","\n  Lemma 10.37.4. Let $R$ be a domain with fraction field $K$. If $u, v \\in K$ are almost integral over $R$, then so are $u + v$ and $uv$. Any element $g \\in K$ which is integral over $R$ is almost integral over $R$. If $R$ is Noetherian then the converse holds as well. \n\n    \n      Proof.\n      If $ru^ n \\in R$ for all $n \\geq 0$ and $v^ nr\' \\in R$ for all $n \\geq 0$, then $(uv)^ nrr\'$ and $(u + v)^ nrr\'$ are in $R$ for all $n \\geq 0$. Hence the first assertion. Suppose $g \\in K$ is integral over $R$. In this case there exists an $d > 0$ such that the ring $R[g]$ is generated by $1, g, \\ldots , g^ d$ as an $R$-module. Let $r \\in R$ be a common denominator of the elements $1, g, \\ldots , g^ d \\in K$. It follows that $rR[g] \\subset R$, and hence $g$ is almost integral over $R$. \n    \n      Suppose $R$ is Noetherian and $g \\in K$ is almost integral over $R$. Let $r \\in R$, $r\\not= 0$ be as in the definition. Then $R[g] \\subset \\frac{1}{r}R$ as an $R$-module. Since $R$ is Noetherian this implies that $R[g]$ is finite over $R$. Hence $g$ is integral over $R$, see Lemma 10.36.3. \n      $\\square$\n    \n","\n  Lemma 10.37.4. Let $R$ be a domain with fraction field $K$. If $u, v \\in K$ are almost integral over $R$, then so are $u + v$ and $uv$. Any element $g \\in K$ which is integral over $R$ is almost integral over $R$. If $R$ is Noetherian then the converse holds as well. \n\n    \n","Proof.\n      If $ru^ n \\in R$ for all $n \\geq 0$ and $v^ nr\' \\in R$ for all $n \\geq 0$, then $(uv)^ nrr\'$ and $(u + v)^ nrr\'$ are in $R$ for all $n \\geq 0$. Hence the first assertion. Suppose $g \\in K$ is integral over $R$. In this case there exists an $d > 0$ such that the ring $R[g]$ is generated by $1, g, \\ldots , g^ d$ as an $R$-module. Let $r \\in R$ be a common denominator of the elements $1, g, \\ldots , g^ d \\in K$. It follows that $rR[g] \\subset R$, and hence $g$ is almost integral over $R$. \n    \n      Suppose $R$ is Noetherian and $g \\in K$ is almost integral over $R$. Let $r \\in R$, $r\\not= 0$ be as in the definition. Then $R[g] \\subset \\frac{1}{r}R$ as an $R$-module. Since $R$ is Noetherian this implies that $R[g]$ is finite over $R$. Hence $g$ is integral over $R$, see Lemma 10.36.3. \n      $\\square$\n    \n"," by
  have : IsDomain R := (FaithfulSMul.algebraMap_injective R S).isDomain
  exact H.isIntegral_of_nonZeroDivisors_le_comap fun _ â†¦ by simp
","lemma IsAlmostIntegral.isIntegral [IsNoetherianRing R] [IsDomain S] [FaithfulSMul R S]
    {s : S} (H : IsAlmostIntegral R s) : IsIntegral R s ","Proof.\n      If $ru^ n \\in R$ for all $n \\geq 0$ and $v^ nr\' \\in R$ for all $n \\geq 0$, then $(uv)^ nrr\'$ and $(u + v)^ nrr\'$ are in $R$ for all $n \\geq 0$. Hence the first assertion. Suppose $g \\in K$ is integral over $R$. In this case there exists an $d > 0$ such that the ring $R[g]$ is generated by $1, g, \\ldots , g^ d$ as an $R$-module. Let $r \\in R$ be a common denominator of the elements $1, g, \\ldots , g^ d \\in K$. It follows that $rR[g] \\subset R$, and hence $g$ is almost integral over $R$. \n    \n      Suppose $R$ is Noetherian and $g \\in K$ is almost integral over $R$. Let $r \\in R$, $r\\not= 0$ be as in the definition. Then $R[g] \\subset \\frac{1}{r}R$ as an $R$-module. Since $R$ is Noetherian this implies that $R[g]$ is finite over $R$. Hence $g$ is integral over $R$, see Lemma 10.36.3 [[\n  Lemma 10.36.3. A finite ring map is integral. \n\n    \n]]. \n      $\\square$\n    \n"
305,09GH,"theorem fg_adjoin_of_finite {s : Set A} (hfs : s.Finite) (his : âˆ€ x âˆˆ s, IsIntegral R x) :
    (Algebra.adjoin R s).toSubmodule.FG := by
  induction s, hfs using Set.Finite.induction_on with
  | empty =>
    refine âŸ¨{1}, Submodule.ext fun x => ?_âŸ©
    rw [Algebra.adjoin_empty, Finset.coe_singleton, â† one_eq_span, Algebra.toSubmodule_bot]
  | @insert a s _ _ ih =>
    rw [â† Set.union_singleton, Algebra.adjoin_union_coe_submodule]
    exact FG.mul
      (ih fun i hi => his i <| Set.mem_insert_of_mem a hi)
      (his a <| Set.mem_insert a s).fg_adjoin_singleton
",Formal Proof of Stacks Project Tag 09GH,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/IntegralClosure/IsIntegral/Basic.lean#L214-L224,Q27041,,9.8.6,lemma,3.0,"['09GB', '09FA', '0ELQ']","\n       \n      \n  Lemma 9.8.6. Let $k$ be a field, and let $\\alpha _1, \\alpha _2, \\ldots , \\alpha _ n$ be elements of some extension field such that each $\\alpha _ i$ is algebraic over $k$. Then the extension $k(\\alpha _1, \\ldots , \\alpha _ n)/k$ is finite. That is, a finitely generated algebraic extension is finite. \n\n    \n      Proof.\n      Indeed, each extension $k(\\alpha _{1}, \\ldots , \\alpha _{i+1})/k(\\alpha _1, \\ldots , \\alpha _{i})$ is generated by one element and algebraic, hence finite. By multiplicativity of degree (Lemma 9.7.7) we obtain the result. \n      $\\square$\n    \n","\n       \n      \n  Lemma 9.8.6. Let $k$ be a field, and let $\\alpha _1, \\alpha _2, \\ldots , \\alpha _ n$ be elements of some extension field such that each $\\alpha _ i$ is algebraic over $k$. Then the extension $k(\\alpha _1, \\ldots , \\alpha _ n)/k$ is finite. That is, a finitely generated algebraic extension is finite. \n\n    \n","Proof.\n      Indeed, each extension $k(\\alpha _{1}, \\ldots , \\alpha _{i+1})/k(\\alpha _1, \\ldots , \\alpha _{i})$ is generated by one element and algebraic, hence finite. By multiplicativity of degree (Lemma 9.7.7) we obtain the result. \n      $\\square$\n    \n"," by
  induction s, hfs using Set.Finite.induction_on with
  | empty =>
    refine âŸ¨{1}, Submodule.ext fun x => ?_âŸ©
    rw [Algebra.adjoin_empty, Finset.coe_singleton, â† one_eq_span, Algebra.toSubmodule_bot]
  | @insert a s _ _ ih =>
    rw [â† Set.union_singleton, Algebra.adjoin_union_coe_submodule]
    exact FG.mul
      (ih fun i hi => his i <| Set.mem_insert_of_mem a hi)
      (his a <| Set.mem_insert a s).fg_adjoin_singleton
","theorem fg_adjoin_of_finite {s : Set A} (hfs : s.Finite) (his : âˆ€ x âˆˆ s, IsIntegral R x) :
    (Algebra.adjoin R s).toSubmodule.FG ","Proof.\n      Indeed, each extension $k(\\alpha _{1}, \\ldots , \\alpha _{i+1})/k(\\alpha _1, \\ldots , \\alpha _{i})$ is generated by one element and algebraic, hence finite. By multiplicativity of degree (Lemma 9.7.7 [[\n  Lemma 9.7.7 (Multiplicativity).  Suppose given a tower of fields $F/E/k$. Then \n  \n  \\[  [F:k] = [F:E][E:k]  \\]\n\n\n    \n]]) we obtain the result. \n      $\\square$\n    \n"
306,0CY7,"lemma finite_of_finite_type_of_isJacobsonRing (R S : Type*) [CommRing R] [Field S]
    [Algebra R S] [IsJacobsonRing R] [Algebra.FiniteType R S] :
    Module.Finite R S := by
  obtain âŸ¨Î¹, hÎ¹, f, hfâŸ© := Algebra.FiniteType.iff_quotient_mvPolynomial'.mp â€¹_â€º
  have : (algebraMap R S).IsIntegral := by
    rw [â† f.comp_algebraMap]
    -- We need to write `f.toRingHom` instead of just `f`, to avoid unification issues.
    exact MvPolynomial.comp_C_integral_of_surjective_of_isJacobsonRing f.toRingHom hf
  have : Algebra.IsIntegral R S := Algebra.isIntegral_def.mpr this
  exact Algebra.IsIntegral.finite
",Formal Proof of Stacks Project Tag 0CY7,See also https://en.wikipedia.org/wiki/Zariski%27s_lemma.,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Jacobson/Ring.lean#L681-L690,Q27041,,10.35.18,lemma,3.0,"['00FZ', '00AO', '0ELQ']",\n  Lemma 10.35.18. Let $R$ be a Jacobson ring. Let $K$ be a field. Let $R \\subset K$ and $K$ is of finite type over $R$. Then $R$ is a field and $K/R$ is a finite field extension. \n\n    \n      Proof.\n      First note that $R$ is a domain. By Lemma 10.34.2 we see that $R_ f$ is a field and $K/R_ f$ is a finite field extension for some nonzero $f \\in R$. Hence $(0)$ is a maximal ideal of $R_ f$ and by Lemma 10.35.14 we conclude $(0)$ is a maximal ideal of $R$. \n      $\\square$\n    \n,\n  Lemma 10.35.18. Let $R$ be a Jacobson ring. Let $K$ be a field. Let $R \\subset K$ and $K$ is of finite type over $R$. Then $R$ is a field and $K/R$ is a finite field extension. \n\n    \n,Proof.\n      First note that $R$ is a domain. By Lemma 10.34.2 we see that $R_ f$ is a field and $K/R_ f$ is a finite field extension for some nonzero $f \\in R$. Hence $(0)$ is a maximal ideal of $R_ f$ and by Lemma 10.35.14 we conclude $(0)$ is a maximal ideal of $R$. \n      $\\square$\n    \n," by
  obtain âŸ¨Î¹, hÎ¹, f, hfâŸ© := Algebra.FiniteType.iff_quotient_mvPolynomial'.mp â€¹_â€º
  have : (algebraMap R S).IsIntegral := by
    rw [â† f.comp_algebraMap]
    -- We need to write `f.toRingHom` instead of just `f`, to avoid unification issues.
    exact MvPolynomial.comp_C_integral_of_surjective_of_isJacobsonRing f.toRingHom hf
  have : Algebra.IsIntegral R S := Algebra.isIntegral_def.mpr this
  exact Algebra.IsIntegral.finite
","lemma finite_of_finite_type_of_isJacobsonRing (R S : Type*) [CommRing R] [Field S]
    [Algebra R S] [IsJacobsonRing R] [Algebra.FiniteType R S] :
    Module.Finite R S ","Proof.\n      First note that $R$ is a domain. By Lemma 10.34.2 [[\n  Lemma 10.34.2. Let $R$ be a ring. Let $K$ be a field. If $R \\subset K$ and $K$ is of finite type over $R$, then there exists an $f \\in R$ such that $R_ f$ is a field, and $K/R_ f$ is a finite field extension. \n\n    \n]] we see that $R_ f$ is a field and $K/R_ f$ is a finite field extension for some nonzero $f \\in R$. Hence $(0)$ is a maximal ideal of $R_ f$ and by Lemma 10.35.14 [[\n  Lemma 10.35.14. Let $R$ be a Jacobson ring. Let $f \\in R$. The ring $R_ f$ is Jacobson and maximal ideals of $R_ f$ correspond to maximal ideals of $R$ not containing $f$. \n\n    \n]] we conclude $(0)$ is a maximal ideal of $R$. \n      $\\square$\n    \n"
307,0B52,"theorem supportDim_le_supportDim_quotSMulTop_succ {x : R} (hx : x âˆˆ maximalIdeal R) :
    supportDim R M â‰¤ supportDim R (QuotSMulTop x M) + 1 :=
  supportDim_le_supportDim_quotSMulTop_succ_of_mem_jacobson ((maximalIdeal_le_jacobson _) hx)
",Formal Proof of Stacks Project Tag 0B52,the second inequality,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/KrullDimension/Regular.lean#L132-L134,Q27041,,10.63.10,lemma,3.0,"['00L9', '00AO', '0ELQ']","\n  Lemma 10.63.10. Let $R$ is a Noetherian local ring, $M$ a finite $R$-module, and $f \\in \\mathfrak m$ an element of the maximal ideal of $R$. Then \n  \n  \\[  \\dim (\\text{Supp}(M/fM)) \\leq \\dim (\\text{Supp}(M)) \\leq \\dim (\\text{Supp}(M/fM)) + 1  \\]\n\n   If $f$ is not in any of the minimal primes of the support of $M$ (for example if $f$ is a nonzerodivisor on $M$), then equality holds for the right inequality. \n\n    \n      Proof.\n      (The parenthetical statement follows from Lemma 10.63.9.) The first inequality follows from $\\text{Supp}(M/fM) \\subset \\text{Supp}(M)$, see Lemma 10.40.9. For the second inequality, note that $\\text{Supp}(M/fM) = \\text{Supp}(M) \\cap V(f)$, see Lemma 10.40.9. It follows, for example by Lemma 10.62.2 and elementary properties of dimension, that it suffices to show $\\dim V(\\mathfrak p) \\leq \\dim (V(\\mathfrak p) \\cap V(f)) + 1$ for primes $\\mathfrak p$ of $R$. This is a consequence of Lemma 10.60.13. Finally, if $f$ is not contained in any minimal prime of the support of $M$, then the chains of primes in $\\text{Supp}(M/fM)$ all give rise to chains in $\\text{Supp}(M)$ which are at least one step away from being maximal. \n      $\\square$\n    \n","\n  Lemma 10.63.10. Let $R$ is a Noetherian local ring, $M$ a finite $R$-module, and $f \\in \\mathfrak m$ an element of the maximal ideal of $R$. Then \n  \n  \\[  \\dim (\\text{Supp}(M/fM)) \\leq \\dim (\\text{Supp}(M)) \\leq \\dim (\\text{Supp}(M/fM)) + 1  \\]\n\n   If $f$ is not in any of the minimal primes of the support of $M$ (for example if $f$ is a nonzerodivisor on $M$), then equality holds for the right inequality. \n\n    \n","Proof.\n      (The parenthetical statement follows from Lemma 10.63.9.) The first inequality follows from $\\text{Supp}(M/fM) \\subset \\text{Supp}(M)$, see Lemma 10.40.9. For the second inequality, note that $\\text{Supp}(M/fM) = \\text{Supp}(M) \\cap V(f)$, see Lemma 10.40.9. It follows, for example by Lemma 10.62.2 and elementary properties of dimension, that it suffices to show $\\dim V(\\mathfrak p) \\leq \\dim (V(\\mathfrak p) \\cap V(f)) + 1$ for primes $\\mathfrak p$ of $R$. This is a consequence of Lemma 10.60.13. Finally, if $f$ is not contained in any minimal prime of the support of $M$, then the chains of primes in $\\text{Supp}(M/fM)$ all give rise to chains in $\\text{Supp}(M)$ which are at least one step away from being maximal. \n      $\\square$\n    \n","
  supportDim_le_supportDim_quotSMulTop_succ_of_mem_jacobson ((maximalIdeal_le_jacobson _) hx)
","theorem supportDim_le_supportDim_quotSMulTop_succ {x : R} (hx : x âˆˆ maximalIdeal R) :
    supportDim R M â‰¤ supportDim R (QuotSMulTop x M) + 1 ","Proof.\n      (The parenthetical statement follows from Lemma 10.63.9 [[\n  Lemma 10.63.9. Let $R$ be a Noetherian ring. Let $M$ be an $R$-module. The union $\\bigcup _{\\mathfrak q \\in \\text{Ass}(M)} \\mathfrak q$ is the set of elements of $R$ which are zerodivisors on $M$. \n\n    \n]].) The first inequality follows from $\\text{Supp}(M/fM) \\subset \\text{Supp}(M)$, see Lemma 10.40.9 [[\n  Lemma 10.40.9. Let $R$ be a ring and let $M$ be an $R$-module. \n  \n  \nIf $M$ is finite then the support of $M/IM$ is $\\text{Supp}(M) \\cap V(I)$. \n\n\nIf $N \\subset M$, then $\\text{Supp}(N) \\subset \\text{Supp}(M)$. \n\n\nIf $Q$ is a quotient module of $M$ then $\\text{Supp}(Q) \\subset \\text{Supp}(M)$. \n\n\nIf $0 \\to N \\to M \\to Q \\to 0$ is a short exact sequence then $\\text{Supp}(M) = \\text{Supp}(Q) \\cup \\text{Supp}(N)$. \n\n\n\n\n    \n]]. For the second inequality, note that $\\text{Supp}(M/fM) = \\text{Supp}(M) \\cap V(f)$, see Lemma 10.40.9 [[\n  Lemma 10.40.9. Let $R$ be a ring and let $M$ be an $R$-module. \n  \n  \nIf $M$ is finite then the support of $M/IM$ is $\\text{Supp}(M) \\cap V(I)$. \n\n\nIf $N \\subset M$, then $\\text{Supp}(N) \\subset \\text{Supp}(M)$. \n\n\nIf $Q$ is a quotient module of $M$ then $\\text{Supp}(Q) \\subset \\text{Supp}(M)$. \n\n\nIf $0 \\to N \\to M \\to Q \\to 0$ is a short exact sequence then $\\text{Supp}(M) = \\text{Supp}(Q) \\cup \\text{Supp}(N)$. \n\n\n\n\n    \n]]. It follows, for example by Lemma 10.62.2 [[\n  Lemma 10.62.2. Let $R$, $M$, $M_ i$, $\\mathfrak p_ i$ as in Lemma 10.62.1. Then $\\text{Supp}(M) = \\bigcup V(\\mathfrak p_ i)$ and in particular $\\mathfrak p_ i \\in \\text{Supp}(M)$. \n\n    \n]] and elementary properties of dimension, that it suffices to show $\\dim V(\\mathfrak p) \\leq \\dim (V(\\mathfrak p) \\cap V(f)) + 1$ for primes $\\mathfrak p$ of $R$. This is a consequence of Lemma 10.60.13 [[\n  Lemma 10.60.13. Suppose that $R$ is a Noetherian local ring and $x\\in \\mathfrak m$ an element of its maximal ideal. Then $\\dim R \\leq \\dim R/xR + 1$. If $x$ is not contained in any of the minimal primes of $R$ then equality holds. (For example if $x$ is a nonzerodivisor.) \n\n    \n]]. Finally, if $f$ is not contained in any minimal prime of the support of $M$, then the chains of primes in $\\text{Supp}(M/fM)$ all give rise to chains in $\\text{Supp}(M)$ which are at least one step away from being maximal. \n      $\\square$\n    \n"
308,0B52,"theorem supportDim_quotSMulTop_succ_eq_of_notMem_minimalPrimes_of_mem_maximalIdeal {x : R}
    (hn : âˆ€ p âˆˆ (annihilator R M).minimalPrimes, x âˆ‰ p) (hx : x âˆˆ maximalIdeal R) :
    supportDim R (QuotSMulTop x M) + 1 = supportDim R M :=
  supportDim_quotSMulTop_succ_eq_of_notMem_minimalPrimes_of_mem_jacobson hn <|
    (maximalIdeal_le_jacobson _) hx
",Formal Proof of Stacks Project Tag 0B52,the equality case,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/KrullDimension/Regular.lean#L189-L193,Q27041,,10.63.10,lemma,3.0,"['00L9', '00AO', '0ELQ']","\n  Lemma 10.63.10. Let $R$ is a Noetherian local ring, $M$ a finite $R$-module, and $f \\in \\mathfrak m$ an element of the maximal ideal of $R$. Then \n  \n  \\[  \\dim (\\text{Supp}(M/fM)) \\leq \\dim (\\text{Supp}(M)) \\leq \\dim (\\text{Supp}(M/fM)) + 1  \\]\n\n   If $f$ is not in any of the minimal primes of the support of $M$ (for example if $f$ is a nonzerodivisor on $M$), then equality holds for the right inequality. \n\n    \n      Proof.\n      (The parenthetical statement follows from Lemma 10.63.9.) The first inequality follows from $\\text{Supp}(M/fM) \\subset \\text{Supp}(M)$, see Lemma 10.40.9. For the second inequality, note that $\\text{Supp}(M/fM) = \\text{Supp}(M) \\cap V(f)$, see Lemma 10.40.9. It follows, for example by Lemma 10.62.2 and elementary properties of dimension, that it suffices to show $\\dim V(\\mathfrak p) \\leq \\dim (V(\\mathfrak p) \\cap V(f)) + 1$ for primes $\\mathfrak p$ of $R$. This is a consequence of Lemma 10.60.13. Finally, if $f$ is not contained in any minimal prime of the support of $M$, then the chains of primes in $\\text{Supp}(M/fM)$ all give rise to chains in $\\text{Supp}(M)$ which are at least one step away from being maximal. \n      $\\square$\n    \n","\n  Lemma 10.63.10. Let $R$ is a Noetherian local ring, $M$ a finite $R$-module, and $f \\in \\mathfrak m$ an element of the maximal ideal of $R$. Then \n  \n  \\[  \\dim (\\text{Supp}(M/fM)) \\leq \\dim (\\text{Supp}(M)) \\leq \\dim (\\text{Supp}(M/fM)) + 1  \\]\n\n   If $f$ is not in any of the minimal primes of the support of $M$ (for example if $f$ is a nonzerodivisor on $M$), then equality holds for the right inequality. \n\n    \n","Proof.\n      (The parenthetical statement follows from Lemma 10.63.9.) The first inequality follows from $\\text{Supp}(M/fM) \\subset \\text{Supp}(M)$, see Lemma 10.40.9. For the second inequality, note that $\\text{Supp}(M/fM) = \\text{Supp}(M) \\cap V(f)$, see Lemma 10.40.9. It follows, for example by Lemma 10.62.2 and elementary properties of dimension, that it suffices to show $\\dim V(\\mathfrak p) \\leq \\dim (V(\\mathfrak p) \\cap V(f)) + 1$ for primes $\\mathfrak p$ of $R$. This is a consequence of Lemma 10.60.13. Finally, if $f$ is not contained in any minimal prime of the support of $M$, then the chains of primes in $\\text{Supp}(M/fM)$ all give rise to chains in $\\text{Supp}(M)$ which are at least one step away from being maximal. \n      $\\square$\n    \n","
  supportDim_quotSMulTop_succ_eq_of_notMem_minimalPrimes_of_mem_jacobson hn <|
    (maximalIdeal_le_jacobson _) hx
","theorem supportDim_quotSMulTop_succ_eq_of_notMem_minimalPrimes_of_mem_maximalIdeal {x : R}
    (hn : âˆ€ p âˆˆ (annihilator R M).minimalPrimes, x âˆ‰ p) (hx : x âˆˆ maximalIdeal R) :
    supportDim R (QuotSMulTop x M) + 1 = supportDim R M ","Proof.\n      (The parenthetical statement follows from Lemma 10.63.9 [[\n  Lemma 10.63.9. Let $R$ be a Noetherian ring. Let $M$ be an $R$-module. The union $\\bigcup _{\\mathfrak q \\in \\text{Ass}(M)} \\mathfrak q$ is the set of elements of $R$ which are zerodivisors on $M$. \n\n    \n]].) The first inequality follows from $\\text{Supp}(M/fM) \\subset \\text{Supp}(M)$, see Lemma 10.40.9 [[\n  Lemma 10.40.9. Let $R$ be a ring and let $M$ be an $R$-module. \n  \n  \nIf $M$ is finite then the support of $M/IM$ is $\\text{Supp}(M) \\cap V(I)$. \n\n\nIf $N \\subset M$, then $\\text{Supp}(N) \\subset \\text{Supp}(M)$. \n\n\nIf $Q$ is a quotient module of $M$ then $\\text{Supp}(Q) \\subset \\text{Supp}(M)$. \n\n\nIf $0 \\to N \\to M \\to Q \\to 0$ is a short exact sequence then $\\text{Supp}(M) = \\text{Supp}(Q) \\cup \\text{Supp}(N)$. \n\n\n\n\n    \n]]. For the second inequality, note that $\\text{Supp}(M/fM) = \\text{Supp}(M) \\cap V(f)$, see Lemma 10.40.9 [[\n  Lemma 10.40.9. Let $R$ be a ring and let $M$ be an $R$-module. \n  \n  \nIf $M$ is finite then the support of $M/IM$ is $\\text{Supp}(M) \\cap V(I)$. \n\n\nIf $N \\subset M$, then $\\text{Supp}(N) \\subset \\text{Supp}(M)$. \n\n\nIf $Q$ is a quotient module of $M$ then $\\text{Supp}(Q) \\subset \\text{Supp}(M)$. \n\n\nIf $0 \\to N \\to M \\to Q \\to 0$ is a short exact sequence then $\\text{Supp}(M) = \\text{Supp}(Q) \\cup \\text{Supp}(N)$. \n\n\n\n\n    \n]]. It follows, for example by Lemma 10.62.2 [[\n  Lemma 10.62.2. Let $R$, $M$, $M_ i$, $\\mathfrak p_ i$ as in Lemma 10.62.1. Then $\\text{Supp}(M) = \\bigcup V(\\mathfrak p_ i)$ and in particular $\\mathfrak p_ i \\in \\text{Supp}(M)$. \n\n    \n]] and elementary properties of dimension, that it suffices to show $\\dim V(\\mathfrak p) \\leq \\dim (V(\\mathfrak p) \\cap V(f)) + 1$ for primes $\\mathfrak p$ of $R$. This is a consequence of Lemma 10.60.13 [[\n  Lemma 10.60.13. Suppose that $R$ is a Noetherian local ring and $x\\in \\mathfrak m$ an element of its maximal ideal. Then $\\dim R \\leq \\dim R/xR + 1$. If $x$ is not contained in any of the minimal primes of $R$ then equality holds. (For example if $x$ is a nonzerodivisor.) \n\n    \n]]. Finally, if $f$ is not contained in any minimal prime of the support of $M$, then the chains of primes in $\\text{Supp}(M/fM)$ all give rise to chains in $\\text{Supp}(M)$ which are at least one step away from being maximal. \n      $\\square$\n    \n"
309,00KW,"lemma _root_.ringKrullDim_quotient_span_singleton_succ_eq_ringKrullDim_of_mem_nonZeroDivisors
    {x : R} (reg : x âˆˆ Râ°) (hx : x âˆˆ maximalIdeal R) :
    ringKrullDim (R â§¸ span {x}) + 1 = ringKrullDim R :=
  ringKrullDim_quotient_span_singleton_succ_eq_ringKrullDim
    (Module.Flat.isSMulRegular_of_nonZeroDivisors reg) hx
",Formal Proof of Stacks Project Tag 00KW,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/KrullDimension/Regular.lean#L212-L216,Q27041,,10.60.13,lemma,3.0,"['00KD', '00AO', '0ELQ']","\n  Lemma 10.60.13. Suppose that $R$ is a Noetherian local ring and $x\\in \\mathfrak m$ an element of its maximal ideal. Then $\\dim R \\leq \\dim R/xR + 1$. If $x$ is not contained in any of the minimal primes of $R$ then equality holds. (For example if $x$ is a nonzerodivisor.) \n\n    \n      Proof.\n      If $x_1, \\ldots , x_{\\dim R/xR} \\in R$ map to elements of $R/xR$ which generate an ideal of definition for $R/xR$, then $x, x_1, \\ldots , x_{\\dim R/xR}$ generate an ideal of definition for $R$. Hence the inequality by Proposition 10.60.9. On the other hand, if $x$ is not contained in any minimal prime of $R$, then the chains of primes in $R/xR$ all give rise to chains in $R$ which are at least one step away from being maximal. \n      $\\square$\n    \n",\n  Lemma 10.60.13. Suppose that $R$ is a Noetherian local ring and $x\\in \\mathfrak m$ an element of its maximal ideal. Then $\\dim R \\leq \\dim R/xR + 1$. If $x$ is not contained in any of the minimal primes of $R$ then equality holds. (For example if $x$ is a nonzerodivisor.) \n\n    \n,"Proof.\n      If $x_1, \\ldots , x_{\\dim R/xR} \\in R$ map to elements of $R/xR$ which generate an ideal of definition for $R/xR$, then $x, x_1, \\ldots , x_{\\dim R/xR}$ generate an ideal of definition for $R$. Hence the inequality by Proposition 10.60.9. On the other hand, if $x$ is not contained in any minimal prime of $R$, then the chains of primes in $R/xR$ all give rise to chains in $R$ which are at least one step away from being maximal. \n      $\\square$\n    \n","
  ringKrullDim_quotient_span_singleton_succ_eq_ringKrullDim
    (Module.Flat.isSMulRegular_of_nonZeroDivisors reg) hx
","lemma _root_.ringKrullDim_quotient_span_singleton_succ_eq_ringKrullDim_of_mem_nonZeroDivisors
    {x : R} (reg : x âˆˆ Râ°) (hx : x âˆˆ maximalIdeal R) :
    ringKrullDim (R â§¸ span {x}) + 1 = ringKrullDim R ","Proof.\n      If $x_1, \\ldots , x_{\\dim R/xR} \\in R$ map to elements of $R/xR$ which generate an ideal of definition for $R/xR$, then $x, x_1, \\ldots , x_{\\dim R/xR}$ generate an ideal of definition for $R$. Hence the inequality by Proposition 10.60.9 [[\n  Proposition 10.60.9. Let $R$ be a local Noetherian ring. Let $d \\geq 0$ be an integer. The following are equivalent: \n  \n  \n $\\dim (R) = d$, \n\n\n $d(R) = d$, \n\n\n there exists an ideal of definition generated by $d$ elements, and no ideal of definition is generated by fewer than $d$ elements. \n\n\n\n\n    \n]]. On the other hand, if $x$ is not contained in any minimal prime of $R$, then the chains of primes in $R/xR$ all give rise to chains in $R$ which are at least one step away from being maximal. \n      $\\square$\n    \n"
310,09FJ,"noncomputable abbrev toField : Field K where
  __ := IsFractionRing.isDomain A
  inv := IsFractionRing.inv A
  mul_inv_cancel := IsFractionRing.mul_inv_cancel A
  inv_zero := show IsFractionRing.inv A (0 : K) = 0 by rw [IsFractionRing.inv]; exact dif_pos rfl
  nnqsmul := _
  nnqsmul_def := fun _ _ => rfl
  qsmul := _
  qsmul_def := fun _ _ => rfl
",Formal Proof of Stacks Project Tag 09FJ,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Localization/FractionRing.lean#L211-L219,Q27041,Quotient fields,9.3.4,example,3.0,"['09FF', '09FA', '0ELQ']","\n  Example 9.3.4 (Quotient fields).  Recall that, given a domain $A$, there is an imbedding $A \\to F$ into a field $F$ constructed from $A$ in exactly the same manner that $\\mathbf{Q}$ is constructed from $\\mathbf{Z}$. Formally the elements of $F$ are (equivalence classes of) fractions $a/b$, $a, b \\in A$, $b \\not= 0$. As usual $a/b = a\'/b\'$ if and only if $ab\' = ba\'$. The field $F$ is called the quotient field, or field of fractions, or fraction field of $A$. The quotient field has the following universal property: given an injective ring map $\\varphi : A \\to K$ to a field $K$, there is a unique map $\\psi : F \\to K$ making \n  \n  \\[  \\xymatrix{ F \\ar[r]_\\psi &  K \\\\  A \\ar[u] \\ar[ru]_\\varphi }  \\]\n\n   commute. Indeed, it is clear how to define such a map: we set $\\psi (a/b) = \\varphi (a)\\varphi (b)^{-1}$ where injectivity of $\\varphi $ assures that $\\varphi (b) \\not= 0$ if $ b \\not= 0$. \n","\n  Example 9.3.4 (Quotient fields).  Recall that, given a domain $A$, there is an imbedding $A \\to F$ into a field $F$ constructed from $A$ in exactly the same manner that $\\mathbf{Q}$ is constructed from $\\mathbf{Z}$. Formally the elements of $F$ are (equivalence classes of) fractions $a/b$, $a, b \\in A$, $b \\not= 0$. As usual $a/b = a\'/b\'$ if and only if $ab\' = ba\'$. The field $F$ is called the quotient field, or field of fractions, or fraction field of $A$. The quotient field has the following universal property: given an injective ring map $\\varphi : A \\to K$ to a field $K$, there is a unique map $\\psi : F \\to K$ making \n  \n  \\[  \\xymatrix{ F \\ar[r]_\\psi &  K \\\\  A \\ar[u] \\ar[ru]_\\varphi }  \\]\n\n   commute. Indeed, it is clear how to define such a map: we set $\\psi (a/b) = \\varphi (a)\\varphi (b)^{-1}$ where injectivity of $\\varphi $ assures that $\\varphi (b) \\not= 0$ if $ b \\not= 0$. \n",," IsFractionRing.isDomain A
  inv := IsFractionRing.inv A
  mul_inv_cancel := IsFractionRing.mul_inv_cancel A
  inv_zero := show IsFractionRing.inv A (0 : K) = 0 by rw [IsFractionRing.inv]; exact dif_pos rfl
  nnqsmul := _
  nnqsmul_def := fun _ _ => rfl
  qsmul := _
  qsmul_def := fun _ _ => rfl
","noncomputable abbrev toField : Field K where
  __ ",
311,00I9,"instance : PartialOrder (LocalSubring R) where
  le A B := âˆƒ h : A.1 â‰¤ B.1, IsLocalHom (Subring.inclusion h)
  le_refl a := âŸ¨le_rfl, âŸ¨fun _ â†¦ idâŸ©âŸ©
  le_trans A B C hâ‚ hâ‚‚ := âŸ¨hâ‚.1.trans hâ‚‚.1, @RingHom.isLocalHom_comp _ _ _ _ _ _ _ _ hâ‚‚.2 hâ‚.2âŸ©
  le_antisymm A B hâ‚ hâ‚‚ := toSubring_injective (le_antisymm hâ‚.1 hâ‚‚.1)
",Formal Proof of Stacks Project Tag 00I9,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/LocalRing/LocalSubring.lean#L69-L73,Q27041,,10.50.1,definition,3.0,"['00I8', '00AO', '0ELQ']","\n  Definition 10.50.1. Valuation rings. \n  \n  \nLet $K$ be a field. Let $A$, $B$ be local rings contained in $K$. We say that $B$ dominates $A$ if $A \\subset B$ and $\\mathfrak m_ A = A \\cap \\mathfrak m_ B$. \n\n\nLet $A$ be a ring. We say $A$ is a valuation ring if $A$ is a local domain and if $A$ is maximal for the relation of domination among local rings contained in the fraction field of $A$. \n\n\nLet $A$ be a valuation ring with fraction field $K$. If $R \\subset K$ is a subring of $K$, then we say $A$ is centered on $R$ if $R \\subset A$. \n\n\n\n","\n  Definition 10.50.1. Valuation rings. \n  \n  \nLet $K$ be a field. Let $A$, $B$ be local rings contained in $K$. We say that $B$ dominates $A$ if $A \\subset B$ and $\\mathfrak m_ A = A \\cap \\mathfrak m_ B$. \n\n\nLet $A$ be a ring. We say $A$ is a valuation ring if $A$ is a local domain and if $A$ is maximal for the relation of domination among local rings contained in the fraction field of $A$. \n\n\nLet $A$ be a valuation ring with fraction field $K$. If $R \\subset K$ is a subring of $K$, then we say $A$ is centered on $R$ if $R \\subset A$. \n\n\n\n",," âˆƒ h : A.1 â‰¤ B.1, IsLocalHom (Subring.inclusion h)
  le_refl a := âŸ¨le_rfl, âŸ¨fun _ â†¦ idâŸ©âŸ©
  le_trans A B C hâ‚ hâ‚‚ := âŸ¨hâ‚.1.trans hâ‚‚.1, @RingHom.isLocalHom_comp _ _ _ _ _ _ _ _ hâ‚‚.2 hâ‚.2âŸ©
  le_antisymm A B hâ‚ hâ‚‚ := toSubring_injective (le_antisymm hâ‚.1 hâ‚‚.1)
","instance : PartialOrder (LocalSubring R) where
  le A B ",
312,00NZ,"theorem free_of_flat_of_isLocalRing [Module.Finite R P] [Flat R P] : Free R P :=
  let w := Free.chooseBasis k (k âŠ—[R] P)
  have âŸ¨v, eqâŸ© := (TensorProduct.mk_surjective R P k Quotient.mk_surjective).comp_left w
  .of_basis <| .mk (IsLocalRing.linearIndependent_of_flat _ (eq â–¸ w.linearIndependent)) <| by
    exact (span_eq_top_of_tmul_eq_basis _ w <| congr_fun eq).ge
",Formal Proof of Stacks Project Tag 00NZ,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/LocalRing/Module.lean#L300-L304,Q27041,,10.78.5,lemma,3.0,"['00NV', '00AO', '0ELQ']","\n  Lemma 10.78.5. (Warning: see Remark 10.78.4.) Suppose $R$ is a local ring, and $M$ is a finite flat $R$-module. Then $M$ is finite free. \n\n    \n      Proof.\n      Follows from the equational criterion of flatness, see Lemma 10.39.11. Namely, suppose that $x_1, \\ldots , x_ r \\in M$ map to a basis of $M/\\mathfrak mM$. By Nakayama\'s Lemma 10.20.1 these elements generate $M$. We want to show there is no relation among the $x_ i$. Instead, we will show by induction on $n$ that if $x_1, \\ldots , x_ n \\in M$ are linearly independent in the vector space $M/\\mathfrak mM$ then they are independent over $R$. \n    \n      The base case of the induction is where we have $x \\in M$, $x \\not\\in \\mathfrak mM$ and a relation $fx = 0$. By the equational criterion there exist $y_ j \\in M$ and $a_ j \\in R$ such that $x = \\sum a_ j y_ j$ and $fa_ j = 0$ for all $j$. Since $x \\not\\in \\mathfrak mM$ we see that at least one $a_ j$ is a unit and hence $f = 0 $. \n    \n      Suppose that $\\sum f_ i x_ i$ is a relation among $x_1, \\ldots , x_ n$. By our choice of $x_ i$ we have $f_ i \\in \\mathfrak m$. According to the equational criterion of flatness there exist $a_{ij} \\in R$ and $y_ j \\in M$ such that $x_ i = \\sum a_{ij} y_ j$ and $\\sum f_ i a_{ij} = 0$. Since $x_ n \\not\\in \\mathfrak mM$ we see that $a_{nj}\\not\\in \\mathfrak m$ for at least one $j$. Since $\\sum f_ i a_{ij} = 0$ we get $f_ n = \\sum _{i = 1}^{n-1} (-a_{ij}/a_{nj}) f_ i$. The relation $\\sum f_ i x_ i = 0$ now can be rewritten as $\\sum _{i = 1}^{n-1} f_ i( x_ i + (-a_{ij}/a_{nj}) x_ n) = 0$. Note that the elements $x_ i + (-a_{ij}/a_{nj}) x_ n$ map to $n-1$ linearly independent elements of $M/\\mathfrak mM$. By induction assumption we get that all the $f_ i$, $i \\leq n-1$ have to be zero, and also $f_ n = \\sum _{i = 1}^{n-1} (-a_{ij}/a_{nj}) f_ i$. This proves the induction step. \n      $\\square$\n    \n","\n  Lemma 10.78.5. (Warning: see Remark 10.78.4.) Suppose $R$ is a local ring, and $M$ is a finite flat $R$-module. Then $M$ is finite free. \n\n    \n","Proof.\n      Follows from the equational criterion of flatness, see Lemma 10.39.11. Namely, suppose that $x_1, \\ldots , x_ r \\in M$ map to a basis of $M/\\mathfrak mM$. By Nakayama\'s Lemma 10.20.1 these elements generate $M$. We want to show there is no relation among the $x_ i$. Instead, we will show by induction on $n$ that if $x_1, \\ldots , x_ n \\in M$ are linearly independent in the vector space $M/\\mathfrak mM$ then they are independent over $R$. \n    \n      The base case of the induction is where we have $x \\in M$, $x \\not\\in \\mathfrak mM$ and a relation $fx = 0$. By the equational criterion there exist $y_ j \\in M$ and $a_ j \\in R$ such that $x = \\sum a_ j y_ j$ and $fa_ j = 0$ for all $j$. Since $x \\not\\in \\mathfrak mM$ we see that at least one $a_ j$ is a unit and hence $f = 0 $. \n    \n      Suppose that $\\sum f_ i x_ i$ is a relation among $x_1, \\ldots , x_ n$. By our choice of $x_ i$ we have $f_ i \\in \\mathfrak m$. According to the equational criterion of flatness there exist $a_{ij} \\in R$ and $y_ j \\in M$ such that $x_ i = \\sum a_{ij} y_ j$ and $\\sum f_ i a_{ij} = 0$. Since $x_ n \\not\\in \\mathfrak mM$ we see that $a_{nj}\\not\\in \\mathfrak m$ for at least one $j$. Since $\\sum f_ i a_{ij} = 0$ we get $f_ n = \\sum _{i = 1}^{n-1} (-a_{ij}/a_{nj}) f_ i$. The relation $\\sum f_ i x_ i = 0$ now can be rewritten as $\\sum _{i = 1}^{n-1} f_ i( x_ i + (-a_{ij}/a_{nj}) x_ n) = 0$. Note that the elements $x_ i + (-a_{ij}/a_{nj}) x_ n$ map to $n-1$ linearly independent elements of $M/\\mathfrak mM$. By induction assumption we get that all the $f_ i$, $i \\leq n-1$ have to be zero, and also $f_ n = \\sum _{i = 1}^{n-1} (-a_{ij}/a_{nj}) f_ i$. This proves the induction step. \n      $\\square$\n    \n","
  let w := Free.chooseBasis k (k âŠ—[R] P)
  have âŸ¨v, eqâŸ© := (TensorProduct.mk_surjective R P k Quotient.mk_surjective).comp_left w
  .of_basis <| .mk (IsLocalRing.linearIndependent_of_flat _ (eq â–¸ w.linearIndependent)) <| by
    exact (span_eq_top_of_tmul_eq_basis _ w <| congr_fun eq).ge
",theorem free_of_flat_of_isLocalRing [Module.Finite R P] [Flat R P] : Free R P ,"Proof.\n      Follows from the equational criterion of flatness, see Lemma 10.39.11 [[\n  Lemma 10.39.11 (Equational criterion of flatness).  A module $M$ over $R$ is flat if and only if every relation in $M$ is trivial. \n\n    \n]]. Namely, suppose that $x_1, \\ldots , x_ r \\in M$ map to a basis of $M/\\mathfrak mM$. By Nakayama\'s Lemma 10.20.1 [[\n        \n      \n      \n  Lemma 10.20.1 (Nakayama\'s lemma). Let $R$ be a ring with Jacobson radical $\\text{rad}(R)$. Let $M$ be an $R$-module. Let $I \\subset R$ be an ideal. \n  \n  \n If $IM = M$ and $M$ is finite, then there exists an $f \\in 1 + I$ such that $fM = 0$. \n\n\nIf $IM = M$, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $M = 0$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, and $N\'$ is finite, then there exists an $f \\in 1 + I$ such that $fM \\subset N$ and $M_ f = N_ f$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, $N\'$ is finite, and $I \\subset \\text{rad}(R)$, then $M = N$. \n\n\nIf $N \\to M$ is a module map, $N/IN \\to M/IM$ is surjective, and $M$ is finite, then there exists an $f \\in 1 + I$ such that $N_ f \\to M_ f$ is surjective. \n\n\nIf $N \\to M$ is a module map, $N/IN \\to M/IM$ is surjective, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $N \\to M$ is surjective. \n\n\nIf $x_1, \\ldots , x_ n \\in M$ generate $M/IM$ and $M$ is finite, then there exists an $f \\in 1 + I$ such that $x_1, \\ldots , x_ n$ generate $M_ f$ over $R_ f$. \n\n\nIf $x_1, \\ldots , x_ n \\in M$ generate $M/IM$, $M$ is finite, and $I \\subset \\text{rad}(R)$, then $M$ is generated by $x_1, \\ldots , x_ n$. \n\n\nIf $IM = M$, $I$ is nilpotent, then $M = 0$. \n\n\nIf $N, N\' \\subset M$, $M = N + IN\'$, and $I$ is nilpotent then $M = N$. \n\n\nIf $N \\to M$ is a module map, $I$ is nilpotent, and $N/IN \\to M/IM$ is surjective, then $N \\to M$ is surjective. \n\n\nIf $\\{ x_\\alpha \\} _{\\alpha \\in A}$ is a set of elements of $M$ which generate $M/IM$ and $I$ is nilpotent, then $M$ is generated by the $x_\\alpha $. \n\n\n\n\n    \n]] these elements generate $M$. We want to show there is no relation among the $x_ i$. Instead, we will show by induction on $n$ that if $x_1, \\ldots , x_ n \\in M$ are linearly independent in the vector space $M/\\mathfrak mM$ then they are independent over $R$. \n    \n      The base case of the induction is where we have $x \\in M$, $x \\not\\in \\mathfrak mM$ and a relation $fx = 0$. By the equational criterion there exist $y_ j \\in M$ and $a_ j \\in R$ such that $x = \\sum a_ j y_ j$ and $fa_ j = 0$ for all $j$. Since $x \\not\\in \\mathfrak mM$ we see that at least one $a_ j$ is a unit and hence $f = 0 $. \n    \n      Suppose that $\\sum f_ i x_ i$ is a relation among $x_1, \\ldots , x_ n$. By our choice of $x_ i$ we have $f_ i \\in \\mathfrak m$. According to the equational criterion of flatness there exist $a_{ij} \\in R$ and $y_ j \\in M$ such that $x_ i = \\sum a_{ij} y_ j$ and $\\sum f_ i a_{ij} = 0$. Since $x_ n \\not\\in \\mathfrak mM$ we see that $a_{nj}\\not\\in \\mathfrak m$ for at least one $j$. Since $\\sum f_ i a_{ij} = 0$ we get $f_ n = \\sum _{i = 1}^{n-1} (-a_{ij}/a_{nj}) f_ i$. The relation $\\sum f_ i x_ i = 0$ now can be rewritten as $\\sum _{i = 1}^{n-1} f_ i( x_ i + (-a_{ij}/a_{nj}) x_ n) = 0$. Note that the elements $x_ i + (-a_{ij}/a_{nj}) x_ n$ map to $n-1$ linearly independent elements of $M/\\mathfrak mM$. By induction assumption we get that all the $f_ i$, $i \\leq n-1$ have to be zero, and also $f_ n = \\sum _{i = 1}^{n-1} (-a_{ij}/a_{nj}) f_ i$. This proves the induction step. \n      $\\square$\n    \n"
313,02M9,"    (n : â„•) (rk : âˆ€ P : MaximalSpectrum R, finrank (R â§¸ P.1) ((R â§¸ P.1) âŠ—[R] M) = n) :
    Nonempty (Basis (Fin n) R M) := by
  let := @Quotient.field
  /- For every maximal ideal `P`, `Râ§¸P âŠ—[R] M` is an `n`-dimensional vector space over the field
    `Râ§¸P` by assumption, so we can choose a basis `b' P` indexed by `Fin n`. -/
  have b' (P) := Module.finBasisOfFinrankEq _ _ (rk P)
  /- By Chinese remainder theorem for modules, there exist `n` elements `b i : M` that reduces
    to `b' P i` modulo each maximal ideal `P`. -/
  choose b hb using fun i â†¦ pi_tensorProductMk_quotient_surjective M _
    (fun _ _ ne â†¦ isCoprime_of_isMaximal (MaximalSpectrum.ext_iff.ne.mp ne)) (b' Â· i)
  /- It suffices to show the linear map `Râ¿ â†’ M` induced by `b` is bijective, for which
    it suffices to show `Râ‚šâ¿ â†’ Râ‚š âŠ—[R] M` is bijective for each maximal ideal `P`. -/
  refine âŸ¨âŸ¨.symm <| .ofBijective (Finsupp.linearCombination R b) <| bijective_of_isLocalized_maximal
    _ (fun P _ â†¦ Finsupp.mapRange.linearMap (Algebra.linearMap R (Localization P.primeCompl)))
    _ (fun P _ â†¦ TensorProduct.mk R (Localization P.primeCompl) M 1) _ fun P _ â†¦ ?_âŸ©âŸ©
  rw [IsLocalizedModule.map_linearCombination, LinearMap.coe_restrictScalars]
  /- Since `M` is finite flat, it suffices to show
    `(Râ‚šâ§¸PRâ‚š)â¿ â†’ Râ‚šâ§¸PRâ‚š âŠ—[Râ‚š] Râ‚š âŠ—[R] M â‰ƒ Râ‚šâ§¸PRâ‚š âŠ—[Râ§¸P] Râ§¸P âŠ—[R] M` is bijective,
    which follows from that `(Râ§¸P)â¿ â†’ Râ§¸P âŠ—[R] M` is bijective. -/
  apply IsLocalRing.linearCombination_bijective_of_flat
  rw [â† (AlgebraTensorModule.cancelBaseChange _ _ P.ResidueField ..).comp_bijective,
    â† (AlgebraTensorModule.cancelBaseChange R (R â§¸ P) P.ResidueField ..).symm.comp_bijective]
  convert ((b' âŸ¨P, â€¹_â€ºâŸ©).repr.lTensor _ â‰ªâ‰«â‚— finsuppScalarRight _ _ P.ResidueField _).symm.bijective
  refine funext fun r â†¦ Finsupp.induction_linear r (by simp) (by simp +contextual) fun _ _ â†¦ ?_
  simp [smul_tmul', â† funext_iff.mp (hb _)]
",Formal Proof of Stacks Project Tag 02M9, theorem nonempty_basis_of_flat_of_finrank_eq [Module.Finite R M] [Flat R M,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/LocalRing/Module.lean#L392-L416,Q27041,,10.78.7,lemma,3.0,"['00NV', '00AO', '0ELQ']","\n  Lemma 10.78.7. Let $R$ be a semi-local ring. Let $M$ be a finite locally free module. If $M$ has constant rank, then $M$ is free. In particular, if $R$ has connected spectrum, then $M$ is free. \n\n    \n      Proof.\n      Omitted. Hints: First show that $M/\\mathfrak m_ iM$ has the same dimension $d$ for all maximal ideal $\\mathfrak m_1, \\ldots , \\mathfrak m_ n$ of $R$ using the rank is constant. Next, show that there exist elements $x_1, \\ldots , x_ d \\in M$ which form a basis for each $M/\\mathfrak m_ iM$ by the Chinese remainder theorem. Finally show that $x_1, \\ldots , x_ d$ is a basis for $M$. \n      $\\square$\n    \n","\n  Lemma 10.78.7. Let $R$ be a semi-local ring. Let $M$ be a finite locally free module. If $M$ has constant rank, then $M$ is free. In particular, if $R$ has connected spectrum, then $M$ is free. \n\n    \n","Proof.\n      Omitted. Hints: First show that $M/\\mathfrak m_ iM$ has the same dimension $d$ for all maximal ideal $\\mathfrak m_1, \\ldots , \\mathfrak m_ n$ of $R$ using the rank is constant. Next, show that there exist elements $x_1, \\ldots , x_ d \\in M$ which form a basis for each $M/\\mathfrak m_ iM$ by the Chinese remainder theorem. Finally show that $x_1, \\ldots , x_ d$ is a basis for $M$. \n      $\\square$\n    \n"," by
  let := @Quotient.field
  /- For every maximal ideal `P`, `Râ§¸P âŠ—[R] M` is an `n`-dimensional vector space over the field
    `Râ§¸P` by assumption, so we can choose a basis `b' P` indexed by `Fin n`. -/
  have b' (P) := Module.finBasisOfFinrankEq _ _ (rk P)
  /- By Chinese remainder theorem for modules, there exist `n` elements `b i : M` that reduces
    to `b' P i` modulo each maximal ideal `P`. -/
  choose b hb using fun i â†¦ pi_tensorProductMk_quotient_surjective M _
    (fun _ _ ne â†¦ isCoprime_of_isMaximal (MaximalSpectrum.ext_iff.ne.mp ne)) (b' Â· i)
  /- It suffices to show the linear map `Râ¿ â†’ M` induced by `b` is bijective, for which
    it suffices to show `Râ‚šâ¿ â†’ Râ‚š âŠ—[R] M` is bijective for each maximal ideal `P`. -/
  refine âŸ¨âŸ¨.symm <| .ofBijective (Finsupp.linearCombination R b) <| bijective_of_isLocalized_maximal
    _ (fun P _ â†¦ Finsupp.mapRange.linearMap (Algebra.linearMap R (Localization P.primeCompl)))
    _ (fun P _ â†¦ TensorProduct.mk R (Localization P.primeCompl) M 1) _ fun P _ â†¦ ?_âŸ©âŸ©
  rw [IsLocalizedModule.map_linearCombination, LinearMap.coe_restrictScalars]
  /- Since `M` is finite flat, it suffices to show
    `(Râ‚šâ§¸PRâ‚š)â¿ â†’ Râ‚šâ§¸PRâ‚š âŠ—[Râ‚š] Râ‚š âŠ—[R] M â‰ƒ Râ‚šâ§¸PRâ‚š âŠ—[Râ§¸P] Râ§¸P âŠ—[R] M` is bijective,
    which follows from that `(Râ§¸P)â¿ â†’ Râ§¸P âŠ—[R] M` is bijective. -/
  apply IsLocalRing.linearCombination_bijective_of_flat
  rw [â† (AlgebraTensorModule.cancelBaseChange _ _ P.ResidueField ..).comp_bijective,
    â† (AlgebraTensorModule.cancelBaseChange R (R â§¸ P) P.ResidueField ..).symm.comp_bijective]
  convert ((b' âŸ¨P, â€¹_â€ºâŸ©).repr.lTensor _ â‰ªâ‰«â‚— finsuppScalarRight _ _ P.ResidueField _).symm.bijective
  refine funext fun r â†¦ Finsupp.induction_linear r (by simp) (by simp +contextual) fun _ _ â†¦ ?_
  simp [smul_tmul', â† funext_iff.mp (hb _)]
","    (n : â„•) (rk : âˆ€ P : MaximalSpectrum R, finrank (R â§¸ P.1) ((R â§¸ P.1) âŠ—[R] M) = n) :
    Nonempty (Basis (Fin n) R M) ","Proof.\n      Omitted. Hints: First show that $M/\\mathfrak m_ iM$ has the same dimension $d$ for all maximal ideal $\\mathfrak m_1, \\ldots , \\mathfrak m_ n$ of $R$ using the rank is constant. Next, show that there exist elements $x_1, \\ldots , x_ d \\in M$ which form a basis for each $M/\\mathfrak m_ iM$ by the Chinese remainder theorem. Finally show that $x_1, \\ldots , x_ d$ is a basis for $M$. \n      $\\square$\n    \n"
314,02M9,"    (n : â„•) (rk : âˆ€ P : MaximalSpectrum R, finrank (R â§¸ P.1) ((R â§¸ P.1) âŠ—[R] M) = n) :
    Free R M :=
  have âŸ¨bâŸ© := nonempty_basis_of_flat_of_finrank_eq R M n rk
  .of_basis b
",Formal Proof of Stacks Project Tag 02M9, theorem free_of_flat_of_finrank_eq [Module.Finite R M] [Flat R M,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/LocalRing/Module.lean#L419-L422,Q27041,,10.78.7,lemma,3.0,"['00NV', '00AO', '0ELQ']","\n  Lemma 10.78.7. Let $R$ be a semi-local ring. Let $M$ be a finite locally free module. If $M$ has constant rank, then $M$ is free. In particular, if $R$ has connected spectrum, then $M$ is free. \n\n    \n      Proof.\n      Omitted. Hints: First show that $M/\\mathfrak m_ iM$ has the same dimension $d$ for all maximal ideal $\\mathfrak m_1, \\ldots , \\mathfrak m_ n$ of $R$ using the rank is constant. Next, show that there exist elements $x_1, \\ldots , x_ d \\in M$ which form a basis for each $M/\\mathfrak m_ iM$ by the Chinese remainder theorem. Finally show that $x_1, \\ldots , x_ d$ is a basis for $M$. \n      $\\square$\n    \n","\n  Lemma 10.78.7. Let $R$ be a semi-local ring. Let $M$ be a finite locally free module. If $M$ has constant rank, then $M$ is free. In particular, if $R$ has connected spectrum, then $M$ is free. \n\n    \n","Proof.\n      Omitted. Hints: First show that $M/\\mathfrak m_ iM$ has the same dimension $d$ for all maximal ideal $\\mathfrak m_1, \\ldots , \\mathfrak m_ n$ of $R$ using the rank is constant. Next, show that there exist elements $x_1, \\ldots , x_ d \\in M$ which form a basis for each $M/\\mathfrak m_ iM$ by the Chinese remainder theorem. Finally show that $x_1, \\ldots , x_ d$ is a basis for $M$. \n      $\\square$\n    \n","
  have âŸ¨bâŸ© := nonempty_basis_of_flat_of_finrank_eq R M n rk
  .of_basis b
","    (n : â„•) (rk : âˆ€ P : MaximalSpectrum R, finrank (R â§¸ P.1) ((R â§¸ P.1) âŠ—[R] M) = n) :
    Free R M ","Proof.\n      Omitted. Hints: First show that $M/\\mathfrak m_ iM$ has the same dimension $d$ for all maximal ideal $\\mathfrak m_1, \\ldots , \\mathfrak m_ n$ of $R$ using the rank is constant. Next, show that there exist elements $x_1, \\ldots , x_ d \\in M$ which form a basis for each $M/\\mathfrak m_ iM$ by the Chinese remainder theorem. Finally show that $x_1, \\ldots , x_ d$ is a basis for $M$. \n      $\\square$\n    \n"
315,07BJ,"theorem local_hom_TFAE (f : R â†’+* S) :
    List.TFAE
      [IsLocalHom f, f '' maximalIdeal R âŠ† maximalIdeal S,
        (maximalIdeal R).map f â‰¤ maximalIdeal S, maximalIdeal R â‰¤ (maximalIdeal S).comap f,
        (maximalIdeal S).comap f = maximalIdeal R] := by
  tfae_have 1 â†’ 2
  | _, _, âŸ¨a, ha, rflâŸ© => map_nonunit f a ha
  tfae_have 2 â†’ 4 := Set.image_subset_iff.1
  tfae_have 3 â†” 4 := Ideal.map_le_iff_le_comap
  tfae_have 4 â†’ 1 := fun h â†¦ âŸ¨fun x => not_imp_not.1 (@h x)âŸ©
  tfae_have 1 â†’ 5
  | _ => by ext; exact not_iff_not.2 (isUnit_map_iff f _)
  tfae_have 5 â†’ 4 := fun h â†¦ le_of_eq h.symm
  tfae_finish
",Formal Proof of Stacks Project Tag 07BJ,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/LocalRing/RingHom/Basic.lean#L81-L94,Q27041,,10.18.4,lemma,3.0,"['07BH', '00AO', '0ELQ']","\n  Lemma 10.18.4. Let $\\varphi : R \\to S$ be a ring map. Assume $R$ and $S$ are local rings. The following are equivalent: \n  \n  \n$\\varphi $ is a local ring map, \n\n\n$\\varphi (\\mathfrak m_ R) \\subset \\mathfrak m_ S$, \n\n\n$\\varphi ^{-1}(\\mathfrak m_ S) = \\mathfrak m_ R$, and \n\n\nfor any $x \\in R$, if $\\varphi (x)$ is invertible in $S$, then $x$ is invertible in $R$. \n\n\n\n\n    \n      Proof.\n      Conditions (1) and (2) are equivalent by definition. If (3) holds then (2) holds. Conversely, if (2) holds, then $\\varphi ^{-1}(\\mathfrak m_ S)$ is a prime ideal containing the maximal ideal $\\mathfrak m_ R$, hence $\\varphi ^{-1}(\\mathfrak m_ S) = \\mathfrak m_ R$. Finally, (4) is the contrapositive of (2) by Lemma 10.18.3. \n      $\\square$\n    \n","\n  Lemma 10.18.4. Let $\\varphi : R \\to S$ be a ring map. Assume $R$ and $S$ are local rings. The following are equivalent: \n  \n  \n$\\varphi $ is a local ring map, \n\n\n$\\varphi (\\mathfrak m_ R) \\subset \\mathfrak m_ S$, \n\n\n$\\varphi ^{-1}(\\mathfrak m_ S) = \\mathfrak m_ R$, and \n\n\nfor any $x \\in R$, if $\\varphi (x)$ is invertible in $S$, then $x$ is invertible in $R$. \n\n\n\n\n    \n","Proof.\n      Conditions (1) and (2) are equivalent by definition. If (3) holds then (2) holds. Conversely, if (2) holds, then $\\varphi ^{-1}(\\mathfrak m_ S)$ is a prime ideal containing the maximal ideal $\\mathfrak m_ R$, hence $\\varphi ^{-1}(\\mathfrak m_ S) = \\mathfrak m_ R$. Finally, (4) is the contrapositive of (2) by Lemma 10.18.3. \n      $\\square$\n    \n"," by
  tfae_have 1 â†’ 2
  | _, _, âŸ¨a, ha, rflâŸ© => map_nonunit f a ha
  tfae_have 2 â†’ 4 := Set.image_subset_iff.1
  tfae_have 3 â†” 4 := Ideal.map_le_iff_le_comap
  tfae_have 4 â†’ 1 := fun h â†¦ âŸ¨fun x => not_imp_not.1 (@h x)âŸ©
  tfae_have 1 â†’ 5
  | _ => by ext; exact not_iff_not.2 (isUnit_map_iff f _)
  tfae_have 5 â†’ 4 := fun h â†¦ le_of_eq h.symm
  tfae_finish
","theorem local_hom_TFAE (f : R â†’+* S) :
    List.TFAE
      [IsLocalHom f, f '' maximalIdeal R âŠ† maximalIdeal S,
        (maximalIdeal R).map f â‰¤ maximalIdeal S, maximalIdeal R â‰¤ (maximalIdeal S).comap f,
        (maximalIdeal S).comap f = maximalIdeal R] ","Proof.\n      Conditions (1) and (2) are equivalent by definition. If (3) holds then (2) holds. Conversely, if (2) holds, then $\\varphi ^{-1}(\\mathfrak m_ S)$ is a prime ideal containing the maximal ideal $\\mathfrak m_ R$, hence $\\varphi ^{-1}(\\mathfrak m_ S) = \\mathfrak m_ R$. Finally, (4) is the contrapositive of (2) by Lemma 10.18.3 [[\n  Lemma 10.18.3. Let $R$ be a ring. The following are equivalent: \n  \n  \n$R$ is a local ring, \n\n\n$\\mathop{\\mathrm{Spec}}(R)$ has exactly one closed point, \n\n\n$R$ has a maximal ideal $\\mathfrak m$ and every element of $R \\setminus \\mathfrak m$ is a unit, and \n\n\n$R$ is not the zero ring and for every $x \\in R$ either $x$ or $1 - x$ is invertible or both. \n\n\n\n\n    \n]]. \n      $\\square$\n    \n"
316,030T,"theorem IsGeometricallyReduced.of_forall_fg
    (h : âˆ€ B : Subalgebra k A, B.FG â†’ IsGeometricallyReduced k B) :
    IsGeometricallyReduced k A := by
  simp_rw [isGeometricallyReduced_iff] at h
  exact âŸ¨IsReduced.tensorProduct_of_flat_of_forall_fg hâŸ©
",Formal Proof of Stacks Project Tag 030T,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Nilpotent/GeometricallyReduced.lean#L72-L76,Q27041,,10.43.2,lemma,3.0,"['05DS', '00AO', '0ELQ']","\n  Lemma 10.43.2. Elementary properties of geometrically reduced algebras. Let $k$ be a field. Let $S$ be a $k$-algebra. \n  \n  \nIf $S$ is geometrically reduced over $k$ so is every $k$-subalgebra. \n\n\nIf all finitely generated $k$-subalgebras of $S$ are geometrically reduced, then $S$ is geometrically reduced. \n\n\nA directed colimit of geometrically reduced $k$-algebras is geometrically reduced. \n\n\nIf $S$ is geometrically reduced over $k$, then any localization of $S$ is geometrically reduced over $k$. \n\n\n\n\n    \n      Proof.\n      Omitted. The second and third property follow from the fact that tensor product commutes with colimits. \n      $\\square$\n    \n","\n  Lemma 10.43.2. Elementary properties of geometrically reduced algebras. Let $k$ be a field. Let $S$ be a $k$-algebra. \n  \n  \nIf $S$ is geometrically reduced over $k$ so is every $k$-subalgebra. \n\n\nIf all finitely generated $k$-subalgebras of $S$ are geometrically reduced, then $S$ is geometrically reduced. \n\n\nA directed colimit of geometrically reduced $k$-algebras is geometrically reduced. \n\n\nIf $S$ is geometrically reduced over $k$, then any localization of $S$ is geometrically reduced over $k$. \n\n\n\n\n    \n",Proof.\n      Omitted. The second and third property follow from the fact that tensor product commutes with colimits. \n      $\\square$\n    \n," by
  simp_rw [isGeometricallyReduced_iff] at h
  exact âŸ¨IsReduced.tensorProduct_of_flat_of_forall_fg hâŸ©
","theorem IsGeometricallyReduced.of_forall_fg
    (h : âˆ€ B : Subalgebra k A, B.FG â†’ IsGeometricallyReduced k B) :
    IsGeometricallyReduced k A ",Proof.\n      Omitted. The second and third property follow from the fact that tensor product commutes with colimits. \n      $\\square$\n    \n
317,0BIF,"noncomputable def norm : S â†’* R :=
  LinearMap.det.comp (lmul R S).toRingHom.toMonoidHom
",Formal Proof of Stacks Project Tag 0BIF,Norm,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Norm/Defs.lean#L61-L62,Q27041,,9.20.1,definition,3.0,"['0BIE', '09FA', '0ELQ']",\n  Definition 9.20.1. Let $L/K$ be a finite extension of fields. For $\\alpha \\in L$ we define the trace $\\text{Trace}_{L/K}(\\alpha ) = \\text{Trace}_ K(\\alpha : L \\to L)$ and the norm $\\text{Norm}_{L/K}(\\alpha ) = \\det _ K(\\alpha : L \\to L)$. \n,\n  Definition 9.20.1. Let $L/K$ be a finite extension of fields. For $\\alpha \\in L$ we define the trace $\\text{Trace}_{L/K}(\\alpha ) = \\text{Trace}_ K(\\alpha : L \\to L)$ and the norm $\\text{Norm}_{L/K}(\\alpha ) = \\det _ K(\\alpha : L \\to L)$. \n,,"
  LinearMap.det.comp (lmul R S).toRingHom.toMonoidHom
",noncomputable def norm : S â†’* R ,
318,00H6,"lemma isIntegral_coeff_of_dvd (p : R[X]) (q : S[X]) (hp : p.Monic) (hq : q.Monic)
    (H : q âˆ£ p.map (algebraMap R S)) (i : â„•) : IsIntegral R (q.coeff i) := by
  nontriviality S
  obtain âŸ¨T, _, _, _, _, _, hqTâŸ© := hq.exists_splits_map
  algebraize [(algebraMap S T).comp (algebraMap R S)]
  refine (isIntegral_algHom_iff (IsScalarTower.toAlgHom R S T)
    (FaithfulSMul.algebraMap_injective S _)).mp ?_
  rw [IsScalarTower.coe_toAlgHom', â† coeff_map]
  refine Polynomial.isIntegral_coeff_of_factors _ (by simp [hq.map, isIntegral_one]) hqT ?_ i
  intro x hx
  exact âŸ¨p, hp, by simpa using aeval_eq_zero_of_dvd_aeval_eq_zero (a := x) H (by simp_all)âŸ©
",Formal Proof of Stacks Project Tag 00H6,(1),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Polynomial/IsIntegral.lean#L62-L72,Q27041,,10.38.5,lemma,3.0,"['037E', '00AO', '0ELQ']","\n  Lemma 10.38.5. Let $K$ be a field. Let $n, m \\in \\mathbf{N}$ and $a_0, \\ldots , a_{n - 1}, b_0, \\ldots , b_{m - 1} \\in K$. If the polynomial $x^ n + a_{n - 1}x^{n - 1} + \\ldots + a_0$ divides the polynomial $x^ m + b_{m - 1} x^{m - 1} + \\ldots + b_0$ in $K[x]$ then \n  \n  \n$a_0, \\ldots , a_{n - 1}$ are integral over any subring $R_0$ of $K$ containing the elements $b_0, \\ldots , b_{m - 1}$, and \n\n\neach $a_ i$ lies in $\\sqrt{(b_0, \\ldots , b_{m-1})R}$ for any subring $R \\subset K$ containing the elements $a_0, \\ldots , a_{n - 1}, b_0, \\ldots , b_{m - 1}$. \n\n\n\n\n    \n      Proof.\n      Let $L/K$ be a field extension such that we can write $x^ m + b_{m - 1} x^{m - 1} + \\ldots + b_0 = \\prod _{i = 1}^ m (x - \\beta _ i)$ with $\\beta _ i \\in L$. See Fields, Section 9.16. Each $\\beta _ i$ is integral over $R_0$. Since each $a_ i$ is a homogeneous polynomial in $\\beta _1, \\ldots , \\beta _ m$ we deduce the same for the $a_ i$ (use Lemma 10.36.7). \n    \n      Choose $c_0, \\ldots , c_{m - n - 1} \\in K$ such that \n    \n      \n  \\[  \\begin{matrix}  x^ m + b_{m - 1} x^{m - 1} + \\ldots + b_0 = \n\n\\\\  (x^ n + a_{n - 1}x^{n - 1} + \\ldots + a_0) (x^{m - n} + c_{m - n - 1}x^{m - n - 1}+ \\ldots + c_0). \n\n\\end{matrix}  \\]\n\n    \n       By part (1) the elements $c_ i$ are integral over $R$. Consider the integral extension \n    \n      \n  \\[  R \\subset R\' = R[c_0, \\ldots , c_{m - n - 1}] \\subset K  \\]\n\n    \n       By Lemmas 10.36.17 and 10.30.3 we see that $R \\cap \\sqrt{(b_0, \\ldots , b_{m - 1})R\'} = \\sqrt{(b_0, \\ldots , b_{m - 1})R}$. Thus we may replace $R$ by $R\'$ and assume $c_ i \\in R$. Dividing out the radical $\\sqrt{(b_0, \\ldots , b_{m - 1})}$ we get a reduced ring $\\overline{R}$. We have to show that the images $\\overline{a}_ i \\in \\overline{R}$ are zero. And in $\\overline{R}[x]$ we have the relation \n    \n      \n  \\[  \\begin{matrix}  x^ m = x^ m + \\overline{b}_{m - 1} x^{m - 1} + \\ldots + \\overline{b}_0 = \n\n\\\\  (x^ n + \\overline{a}_{n - 1}x^{n - 1} + \\ldots + \\overline{a}_0) (x^{m - n} + \\overline{c}_{m - n - 1}x^{m - n - 1}+ \\ldots + \\overline{c}_0). \n\n\\end{matrix}  \\]\n\n    \n       It is easy to see that this implies $\\overline{a}_ i = 0$ for all $i$. Indeed by Lemma 10.25.1 the localization of $\\overline{R}$ at a minimal prime $\\mathfrak {p}$ is a field and $\\overline{R}_{\\mathfrak p}[x]$ a UFD. Thus $f = x^ n + \\sum \\overline{a}_ i x^ i$ is associated to $x^ n$ and since $f$ is monic $f = x^ n$ in $\\overline{R}_{\\mathfrak p}[x]$. Then there exists an $s \\in \\overline{R}$, $s \\not\\in \\mathfrak p$ such that $s(f - x^ n) = 0$. Therefore all $\\overline{a}_ i$ lie in $\\mathfrak p$ and we conclude by Lemma 10.25.2. \n      $\\square$\n    \n","\n  Lemma 10.38.5. Let $K$ be a field. Let $n, m \\in \\mathbf{N}$ and $a_0, \\ldots , a_{n - 1}, b_0, \\ldots , b_{m - 1} \\in K$. If the polynomial $x^ n + a_{n - 1}x^{n - 1} + \\ldots + a_0$ divides the polynomial $x^ m + b_{m - 1} x^{m - 1} + \\ldots + b_0$ in $K[x]$ then \n  \n  \n$a_0, \\ldots , a_{n - 1}$ are integral over any subring $R_0$ of $K$ containing the elements $b_0, \\ldots , b_{m - 1}$, and \n\n\neach $a_ i$ lies in $\\sqrt{(b_0, \\ldots , b_{m-1})R}$ for any subring $R \\subset K$ containing the elements $a_0, \\ldots , a_{n - 1}, b_0, \\ldots , b_{m - 1}$. \n\n\n\n\n    \n","Proof.\n      Let $L/K$ be a field extension such that we can write $x^ m + b_{m - 1} x^{m - 1} + \\ldots + b_0 = \\prod _{i = 1}^ m (x - \\beta _ i)$ with $\\beta _ i \\in L$. See Fields, Section 9.16. Each $\\beta _ i$ is integral over $R_0$. Since each $a_ i$ is a homogeneous polynomial in $\\beta _1, \\ldots , \\beta _ m$ we deduce the same for the $a_ i$ (use Lemma 10.36.7). \n    \n      Choose $c_0, \\ldots , c_{m - n - 1} \\in K$ such that \n    \n      \n  \\[  \\begin{matrix}  x^ m + b_{m - 1} x^{m - 1} + \\ldots + b_0 = \n\n\\\\  (x^ n + a_{n - 1}x^{n - 1} + \\ldots + a_0) (x^{m - n} + c_{m - n - 1}x^{m - n - 1}+ \\ldots + c_0). \n\n\\end{matrix}  \\]\n\n    \n       By part (1) the elements $c_ i$ are integral over $R$. Consider the integral extension \n    \n      \n  \\[  R \\subset R\' = R[c_0, \\ldots , c_{m - n - 1}] \\subset K  \\]\n\n    \n       By Lemmas 10.36.17 and 10.30.3 we see that $R \\cap \\sqrt{(b_0, \\ldots , b_{m - 1})R\'} = \\sqrt{(b_0, \\ldots , b_{m - 1})R}$. Thus we may replace $R$ by $R\'$ and assume $c_ i \\in R$. Dividing out the radical $\\sqrt{(b_0, \\ldots , b_{m - 1})}$ we get a reduced ring $\\overline{R}$. We have to show that the images $\\overline{a}_ i \\in \\overline{R}$ are zero. And in $\\overline{R}[x]$ we have the relation \n    \n      \n  \\[  \\begin{matrix}  x^ m = x^ m + \\overline{b}_{m - 1} x^{m - 1} + \\ldots + \\overline{b}_0 = \n\n\\\\  (x^ n + \\overline{a}_{n - 1}x^{n - 1} + \\ldots + \\overline{a}_0) (x^{m - n} + \\overline{c}_{m - n - 1}x^{m - n - 1}+ \\ldots + \\overline{c}_0). \n\n\\end{matrix}  \\]\n\n    \n       It is easy to see that this implies $\\overline{a}_ i = 0$ for all $i$. Indeed by Lemma 10.25.1 the localization of $\\overline{R}$ at a minimal prime $\\mathfrak {p}$ is a field and $\\overline{R}_{\\mathfrak p}[x]$ a UFD. Thus $f = x^ n + \\sum \\overline{a}_ i x^ i$ is associated to $x^ n$ and since $f$ is monic $f = x^ n$ in $\\overline{R}_{\\mathfrak p}[x]$. Then there exists an $s \\in \\overline{R}$, $s \\not\\in \\mathfrak p$ such that $s(f - x^ n) = 0$. Therefore all $\\overline{a}_ i$ lie in $\\mathfrak p$ and we conclude by Lemma 10.25.2. \n      $\\square$\n    \n"," by
  nontriviality S
  obtain âŸ¨T, _, _, _, _, _, hqTâŸ© := hq.exists_splits_map
  algebraize [(algebraMap S T).comp (algebraMap R S)]
  refine (isIntegral_algHom_iff (IsScalarTower.toAlgHom R S T)
    (FaithfulSMul.algebraMap_injective S _)).mp ?_
  rw [IsScalarTower.coe_toAlgHom', â† coeff_map]
  refine Polynomial.isIntegral_coeff_of_factors _ (by simp [hq.map, isIntegral_one]) hqT ?_ i
  intro x hx
  exact âŸ¨p, hp, by simpa using aeval_eq_zero_of_dvd_aeval_eq_zero (a := x) H (by simp_all)âŸ©
","lemma isIntegral_coeff_of_dvd (p : R[X]) (q : S[X]) (hp : p.Monic) (hq : q.Monic)
    (H : q âˆ£ p.map (algebraMap R S)) (i : â„•) : IsIntegral R (q.coeff i) ","Proof.\n      Let $L/K$ be a field extension such that we can write $x^ m + b_{m - 1} x^{m - 1} + \\ldots + b_0 = \\prod _{i = 1}^ m (x - \\beta _ i)$ with $\\beta _ i \\in L$. See Fields, Section 9.16 [[9.16 Splitting fields\n\n\nThe following lemma is a useful tool for constructing normal field extensions. \n\n\n\n  Lemma 9.16.1. Let $F$ be a field. Let $P \\in F[x]$ be a nonconstant polynomial. There exists a smallest field extension $E/F$ such that $P$ splits completely over $E$. Moreover, the field extension $E/F$ is normal and unique up to (nonunique) isomorphism. \n \n\n\n    \n]]. Each $\\beta _ i$ is integral over $R_0$. Since each $a_ i$ is a homogeneous polynomial in $\\beta _1, \\ldots , \\beta _ m$ we deduce the same for the $a_ i$ (use Lemma 10.36.7 [[\n  Lemma 10.36.7. Let $R \\to S$ be a ring homomorphism. The set \n  \n  \\[  S\' = \\{ s \\in S \\mid s\\text{ is integral over }R\\}   \\]\n\n   is an $R$-subalgebra of $S$. \n\n    \n]]). \n    \n      Choose $c_0, \\ldots , c_{m - n - 1} \\in K$ such that \n    \n      \n  \\[  \\begin{matrix}  x^ m + b_{m - 1} x^{m - 1} + \\ldots + b_0 = \n\n\\\\  (x^ n + a_{n - 1}x^{n - 1} + \\ldots + a_0) (x^{m - n} + c_{m - n - 1}x^{m - n - 1}+ \\ldots + c_0). \n\n\\end{matrix}  \\]\n\n    \n       By part (1) the elements $c_ i$ are integral over $R$. Consider the integral extension \n    \n      \n  \\[  R \\subset R\' = R[c_0, \\ldots , c_{m - n - 1}] \\subset K  \\]\n\n    \n       By Lemmas 10.36.17 [[\n  Lemma 10.36.17. Suppose that $R \\to S$ is an integral ring extension with $R \\subset S$. Then $\\varphi : \\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R)$ is surjective. \n\n    \n]] and 10.30.3 [[\n  Lemma 10.30.3. Let $\\varphi : R \\to S$ be a ring map. The following are equivalent: \n  \n  \nThe map $\\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R)$ is surjective. \n\n\nFor any ideal $I \\subset R$ the inverse image of $\\sqrt{IS}$ in $R$ is equal to $\\sqrt{I}$. \n\n\nFor any radical ideal $I \\subset R$ the inverse image of $IS$ in $R$ is equal to $I$. \n\n\nFor every prime $\\mathfrak p$ of $R$ the inverse image of $\\mathfrak p S$ in $R$ is $\\mathfrak p$. \n\n\n\n   In this case the same is true after any base change: Given a ring map $R \\to R\'$ the ring map $R\' \\to R\' \\otimes _ R S$ has the equivalent properties (1), (2), (3) as well. \n\n    \n]] we see that $R \\cap \\sqrt{(b_0, \\ldots , b_{m - 1})R\'} = \\sqrt{(b_0, \\ldots , b_{m - 1})R}$. Thus we may replace $R$ by $R\'$ and assume $c_ i \\in R$. Dividing out the radical $\\sqrt{(b_0, \\ldots , b_{m - 1})}$ we get a reduced ring $\\overline{R}$. We have to show that the images $\\overline{a}_ i \\in \\overline{R}$ are zero. And in $\\overline{R}[x]$ we have the relation \n    \n      \n  \\[  \\begin{matrix}  x^ m = x^ m + \\overline{b}_{m - 1} x^{m - 1} + \\ldots + \\overline{b}_0 = \n\n\\\\  (x^ n + \\overline{a}_{n - 1}x^{n - 1} + \\ldots + \\overline{a}_0) (x^{m - n} + \\overline{c}_{m - n - 1}x^{m - n - 1}+ \\ldots + \\overline{c}_0). \n\n\\end{matrix}  \\]\n\n    \n       It is easy to see that this implies $\\overline{a}_ i = 0$ for all $i$. Indeed by Lemma 10.25.1 [[\n  Lemma 10.25.1. Let $\\mathfrak p$ be a minimal prime of a ring $R$. Every element of the maximal ideal of $R_{\\mathfrak p}$ is nilpotent. If $R$ is reduced then $R_{\\mathfrak p}$ is a field. \n\n    \n]] the localization of $\\overline{R}$ at a minimal prime $\\mathfrak {p}$ is a field and $\\overline{R}_{\\mathfrak p}[x]$ a UFD. Thus $f = x^ n + \\sum \\overline{a}_ i x^ i$ is associated to $x^ n$ and since $f$ is monic $f = x^ n$ in $\\overline{R}_{\\mathfrak p}[x]$. Then there exists an $s \\in \\overline{R}$, $s \\not\\in \\mathfrak p$ such that $s(f - x^ n) = 0$. Therefore all $\\overline{a}_ i$ lie in $\\mathfrak p$ and we conclude by Lemma 10.25.2 [[\n  Lemma 10.25.2. Let $R$ be a reduced ring. Then \n  \n  \n$R$ is a subring of a product of fields, \n\n\n$R \\to \\prod _{\\mathfrak p\\text{ minimal}} R_{\\mathfrak p}$ is an embedding into a product of fields, \n\n\n$\\bigcup _{\\mathfrak p\\text{ minimal}} \\mathfrak p$ is the set of zerodivisors of $R$. \n\n\n\n\n    \n]]. \n      $\\square$\n    \n"
319,00H0,"lemma IsAlmostIntegral.coeff [IsDomain R] [FaithfulSMul R S]
    {p : S[X]} (hp : IsAlmostIntegral R[X] p) (i : â„•) :
    IsAlmostIntegral R (p.coeff i) := by
  have H {q : S[X]} (hq : IsAlmostIntegral R[X] q) : IsAlmostIntegral R q.leadingCoeff := by
    obtain âŸ¨p, hp, hp'âŸ© := hq
    refine âŸ¨p.leadingCoeff, by simpa using hp, fun n â†¦ ?_âŸ©
    obtain âŸ¨r, hrâŸ© := hp' n
    simp only [Algebra.smul_def, algebraMap_def, coe_mapRingHom] at hr âŠ¢
    by_cases h : algebraMap R S p.leadingCoeff * q.leadingCoeff ^ n = 0
    Â· simp [h]
    have h' : q.leadingCoeff ^ n â‰  0 := by aesop
    use r.leadingCoeff
    simp only [â† leadingCoeff_map_of_injective (FaithfulSMul.algebraMap_injective R S), hr] at h âŠ¢
    rw [â† leadingCoeff_pow' h'] at h âŠ¢
    rw [leadingCoeff_mul' h]
  induction hn : p.natDegree using Nat.strong_induction_on generalizing p with | h n IH =>
  by_cases hp' : p.natDegree = 0
  Â· obtain âŸ¨p, rflâŸ© := natDegree_eq_zero.mp hp'
    simp only [coeff_C]
    split_ifs with h
    Â· simpa using H hp
    Â· exact (completeIntegralClosure R S).zero_mem
  by_cases hi : i = p.natDegree
  Â· simp [hi, H hp]
  have : IsAlmostIntegral R[X] p.eraseLead := by
    rw [â† self_sub_monomial_natDegree_leadingCoeff, â† mem_completeIntegralClosure,
      â† C_mul_X_pow_eq_monomial, â† map_X (algebraMap R S), â† Polynomial.map_pow]
    refine sub_mem hp (mul_mem ?_ (algebraMap_mem (R := R[X]) _ _))
    obtain âŸ¨r, hr, hr'âŸ© := H hp
    refine âŸ¨C r, by simpa using hr, fun n â†¦ ?_âŸ©
    obtain âŸ¨s, hsâŸ© := hr' n
    exact âŸ¨C s, by simp [Algebra.smul_def, hs]âŸ©
  simpa [hi, eraseLead_coeff_of_ne] using
    IH (p := p.eraseLead) _ (p.eraseLead_natDegree_le.trans_lt (by lia)) this rfl
",Formal Proof of Stacks Project Tag 00H0,(1),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Polynomial/IsIntegral.lean#L85-L118,Q27041,,10.37.7,lemma,3.0,"['037B', '00AO', '0ELQ']","\n  Lemma 10.37.7. Let $R$ be a domain with fraction field $K$. Suppose $f = \\sum \\alpha _ i x^ i$ is an element of $K[x]$. \n  \n  \nIf $f$ is integral over $R[x]$ then all $\\alpha _ i$ are integral over $R$, and \n\n\nIf $f$ is almost integral over $R[x]$ then all $\\alpha _ i$ are almost integral over $R$. \n\n\n\n\n    \n      Proof.\n      We first prove the second statement. Write $f = \\alpha _0 + \\alpha _1 x + \\ldots + \\alpha _ r x^ r$ with $\\alpha _ r \\not= 0$. By assumption there exists $h = b_0 + b_1 x + \\ldots + b_ s x^ s \\in R[x]$, $b_ s \\not= 0$ such that $f^ n h \\in R[x]$ for all $n \\geq 0$. This implies that $b_ s \\alpha _ r^ n \\in R$ for all $n \\geq 0$. Hence $\\alpha _ r$ is almost integral over $R$. Since the set of almost integral elements form a subring (Lemma 10.37.4) we deduce that $f - \\alpha _ r x^ r = \\alpha _0 + \\alpha _1 x + \\ldots + \\alpha _{r - 1} x^{r - 1}$ is almost integral over $R[x]$. By induction on $r$ we win. \n    \n      In order to prove the first statement we will use absolute Noetherian reduction. Namely, write $\\alpha _ i = a_ i / b_ i$ and let $P(t) = t^ d + \\sum _{j < d} f_ j t^ j$ be a polynomial with coefficients $f_ j \\in R[x]$ such that $P(f) = 0$. Let $f_ j = \\sum f_{ji}x^ i$. Consider the subring $R_0 \\subset R$ generated by the finite list of elements $a_ i, b_ i, f_{ji}$ of $R$. It is a domain; let $K_0$ be its field of fractions. Since $R_0$ is a finite type $\\mathbf{Z}$-algebra it is Noetherian, see Lemma 10.31.3. It is still the case that $f \\in K_0[x]$ is integral over $R_0[x]$, because all the identities in $R$ among the elements $a_ i, b_ i, f_{ji}$ also hold in $R_0$. By Lemma 10.37.4 the element $f$ is almost integral over $R_0[x]$. By the second statement of the lemma, the elements $\\alpha _ i$ are almost integral over $R_0$. And since $R_0$ is Noetherian, they are integral over $R_0$, see Lemma 10.37.4. Of course, then they are integral over $R$. \n      $\\square$\n    \n","\n  Lemma 10.37.7. Let $R$ be a domain with fraction field $K$. Suppose $f = \\sum \\alpha _ i x^ i$ is an element of $K[x]$. \n  \n  \nIf $f$ is integral over $R[x]$ then all $\\alpha _ i$ are integral over $R$, and \n\n\nIf $f$ is almost integral over $R[x]$ then all $\\alpha _ i$ are almost integral over $R$. \n\n\n\n\n    \n","Proof.\n      We first prove the second statement. Write $f = \\alpha _0 + \\alpha _1 x + \\ldots + \\alpha _ r x^ r$ with $\\alpha _ r \\not= 0$. By assumption there exists $h = b_0 + b_1 x + \\ldots + b_ s x^ s \\in R[x]$, $b_ s \\not= 0$ such that $f^ n h \\in R[x]$ for all $n \\geq 0$. This implies that $b_ s \\alpha _ r^ n \\in R$ for all $n \\geq 0$. Hence $\\alpha _ r$ is almost integral over $R$. Since the set of almost integral elements form a subring (Lemma 10.37.4) we deduce that $f - \\alpha _ r x^ r = \\alpha _0 + \\alpha _1 x + \\ldots + \\alpha _{r - 1} x^{r - 1}$ is almost integral over $R[x]$. By induction on $r$ we win. \n    \n      In order to prove the first statement we will use absolute Noetherian reduction. Namely, write $\\alpha _ i = a_ i / b_ i$ and let $P(t) = t^ d + \\sum _{j < d} f_ j t^ j$ be a polynomial with coefficients $f_ j \\in R[x]$ such that $P(f) = 0$. Let $f_ j = \\sum f_{ji}x^ i$. Consider the subring $R_0 \\subset R$ generated by the finite list of elements $a_ i, b_ i, f_{ji}$ of $R$. It is a domain; let $K_0$ be its field of fractions. Since $R_0$ is a finite type $\\mathbf{Z}$-algebra it is Noetherian, see Lemma 10.31.3. It is still the case that $f \\in K_0[x]$ is integral over $R_0[x]$, because all the identities in $R$ among the elements $a_ i, b_ i, f_{ji}$ also hold in $R_0$. By Lemma 10.37.4 the element $f$ is almost integral over $R_0[x]$. By the second statement of the lemma, the elements $\\alpha _ i$ are almost integral over $R_0$. And since $R_0$ is Noetherian, they are integral over $R_0$, see Lemma 10.37.4. Of course, then they are integral over $R$. \n      $\\square$\n    \n"," by
  have H {q : S[X]} (hq : IsAlmostIntegral R[X] q) : IsAlmostIntegral R q.leadingCoeff := by
    obtain âŸ¨p, hp, hp'âŸ© := hq
    refine âŸ¨p.leadingCoeff, by simpa using hp, fun n â†¦ ?_âŸ©
    obtain âŸ¨r, hrâŸ© := hp' n
    simp only [Algebra.smul_def, algebraMap_def, coe_mapRingHom] at hr âŠ¢
    by_cases h : algebraMap R S p.leadingCoeff * q.leadingCoeff ^ n = 0
    Â· simp [h]
    have h' : q.leadingCoeff ^ n â‰  0 := by aesop
    use r.leadingCoeff
    simp only [â† leadingCoeff_map_of_injective (FaithfulSMul.algebraMap_injective R S), hr] at h âŠ¢
    rw [â† leadingCoeff_pow' h'] at h âŠ¢
    rw [leadingCoeff_mul' h]
  induction hn : p.natDegree using Nat.strong_induction_on generalizing p with | h n IH =>
  by_cases hp' : p.natDegree = 0
  Â· obtain âŸ¨p, rflâŸ© := natDegree_eq_zero.mp hp'
    simp only [coeff_C]
    split_ifs with h
    Â· simpa using H hp
    Â· exact (completeIntegralClosure R S).zero_mem
  by_cases hi : i = p.natDegree
  Â· simp [hi, H hp]
  have : IsAlmostIntegral R[X] p.eraseLead := by
    rw [â† self_sub_monomial_natDegree_leadingCoeff, â† mem_completeIntegralClosure,
      â† C_mul_X_pow_eq_monomial, â† map_X (algebraMap R S), â† Polynomial.map_pow]
    refine sub_mem hp (mul_mem ?_ (algebraMap_mem (R := R[X]) _ _))
    obtain âŸ¨r, hr, hr'âŸ© := H hp
    refine âŸ¨C r, by simpa using hr, fun n â†¦ ?_âŸ©
    obtain âŸ¨s, hsâŸ© := hr' n
    exact âŸ¨C s, by simp [Algebra.smul_def, hs]âŸ©
  simpa [hi, eraseLead_coeff_of_ne] using
    IH (p := p.eraseLead) _ (p.eraseLead_natDegree_le.trans_lt (by lia)) this rfl
","lemma IsAlmostIntegral.coeff [IsDomain R] [FaithfulSMul R S]
    {p : S[X]} (hp : IsAlmostIntegral R[X] p) (i : â„•) :
    IsAlmostIntegral R (p.coeff i) ","Proof.\n      We first prove the second statement. Write $f = \\alpha _0 + \\alpha _1 x + \\ldots + \\alpha _ r x^ r$ with $\\alpha _ r \\not= 0$. By assumption there exists $h = b_0 + b_1 x + \\ldots + b_ s x^ s \\in R[x]$, $b_ s \\not= 0$ such that $f^ n h \\in R[x]$ for all $n \\geq 0$. This implies that $b_ s \\alpha _ r^ n \\in R$ for all $n \\geq 0$. Hence $\\alpha _ r$ is almost integral over $R$. Since the set of almost integral elements form a subring (Lemma 10.37.4 [[\n  Lemma 10.37.4. Let $R$ be a domain with fraction field $K$. If $u, v \\in K$ are almost integral over $R$, then so are $u + v$ and $uv$. Any element $g \\in K$ which is integral over $R$ is almost integral over $R$. If $R$ is Noetherian then the converse holds as well. \n\n    \n]]) we deduce that $f - \\alpha _ r x^ r = \\alpha _0 + \\alpha _1 x + \\ldots + \\alpha _{r - 1} x^{r - 1}$ is almost integral over $R[x]$. By induction on $r$ we win. \n    \n      In order to prove the first statement we will use absolute Noetherian reduction. Namely, write $\\alpha _ i = a_ i / b_ i$ and let $P(t) = t^ d + \\sum _{j < d} f_ j t^ j$ be a polynomial with coefficients $f_ j \\in R[x]$ such that $P(f) = 0$. Let $f_ j = \\sum f_{ji}x^ i$. Consider the subring $R_0 \\subset R$ generated by the finite list of elements $a_ i, b_ i, f_{ji}$ of $R$. It is a domain; let $K_0$ be its field of fractions. Since $R_0$ is a finite type $\\mathbf{Z}$-algebra it is Noetherian, see Lemma 10.31.3 [[\n  Lemma 10.31.3. Any finite type algebra over a field is Noetherian. Any finite type algebra over $\\mathbf{Z}$ is Noetherian. \n\n    \n]]. It is still the case that $f \\in K_0[x]$ is integral over $R_0[x]$, because all the identities in $R$ among the elements $a_ i, b_ i, f_{ji}$ also hold in $R_0$. By Lemma 10.37.4 [[\n  Lemma 10.37.4. Let $R$ be a domain with fraction field $K$. If $u, v \\in K$ are almost integral over $R$, then so are $u + v$ and $uv$. Any element $g \\in K$ which is integral over $R$ is almost integral over $R$. If $R$ is Noetherian then the converse holds as well. \n\n    \n]] the element $f$ is almost integral over $R_0[x]$. By the second statement of the lemma, the elements $\\alpha _ i$ are almost integral over $R_0$. And since $R_0$ is Noetherian, they are integral over $R_0$, see Lemma 10.37.4 [[\n  Lemma 10.37.4. Let $R$ be a domain with fraction field $K$. If $u, v \\in K$ are almost integral over $R$, then so are $u + v$ and $uv$. Any element $g \\in K$ which is integral over $R$ is almost integral over $R$. If $R$ is Noetherian then the converse holds as well. \n\n    \n]]. Of course, then they are integral over $R$. \n      $\\square$\n    \n"
320,00H0,"protected lemma IsIntegral.coeff
    {p : S[X]} (hp : IsIntegral R[X] p) (i : â„•) : IsIntegral R (p.coeff i) := by
  nontriviality R
  nontriviality S
  obtain rfl | hp0 := eq_or_ne p 0; Â· simp [isIntegral_zero]
  let q := minpoly R[X] p
  let m := (q.support.sup fun i â†¦ (q.coeff i).natDegree) + p.natDegree + 1
  have hmâ‚ (i) : (q.coeff i).natDegree < m := by
    by_cases hi : i âˆˆ q.support
    Â· exact (Finset.le_sup (f := fun i â†¦ (q.coeff i).natDegree) hi).trans_lt (by lia)
    Â· simp_all [m]
  have hmâ‚' : (q.eval (X ^ m)).Monic := by
    rw [eval_eq_sum_range, Finset.sum_range_succ]
    refine .add_of_right (by simp [q, minpoly.monic hp, â† pow_mul]) (degree_lt_degree ?_)
    refine lt_of_lt_of_eq (b := m * q.natDegree) ?_ (by simp [q, minpoly.monic hp, â† pow_mul])
    refine (natDegree_sum_le ..).trans_lt ((Finset.fold_max_lt _).mpr
      âŸ¨by simpa using âŸ¨by lia, minpoly.natDegree_pos hpâŸ©, fun i hi â†¦ ?_âŸ©)
    dsimp
    simp only [Finset.mem_range] at hi
    grw [â† pow_mul, natDegree_mul_le, natDegree_X_pow, â† Nat.add_one_le_iff.mpr hi]
    have := hmâ‚ i
    lia
  have hmâ‚‚ : p.natDegree < m := by grind
  have hâ‚€ : algebraMap R[X] S[X] X = X := by simp
  have : (((taylor (X ^ m)) q).map (algebraMap R[X] S[X])).IsRoot (p - X ^ m) := by
    simpa [-algebraMap_def, q, hâ‚€] using
      ((q.map (algebraMap _ _)).taylor_eval (X ^ m) (p - X ^ m) :)
  have : X ^ m - p âˆ£ (eval (X ^ m) q).map (algebraMap _ _) := by
    change X ^ m - p âˆ£ Algebra.ofId R[X] S[X] _
    rw [â† coe_aeval_eq_eval, â† aeval_algHom_apply, â† neg_dvd, neg_sub]
    simpa [Polynomial.taylor_coeff_zero, -algebraMap_def, hâ‚€] using this.dvd_coeff_zero
  have := (isIntegral_coeff_of_dvd _ _ hmâ‚'
    ((monic_X_pow _).sub_of_left (by simpa [â† natDegree_lt_iff_degree_lt, hp0])) this i).neg
  obtain hi | hi := le_or_gt i p.natDegree
  Â· simpa [show i â‰  m by lia] using this
  Â· simp [coeff_eq_zero_of_natDegree_lt hi, isIntegral_zero]
",Formal Proof of Stacks Project Tag 00H0,(2),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Polynomial/IsIntegral.lean#L121-L156,Q27041,,10.37.7,lemma,3.0,"['037B', '00AO', '0ELQ']","\n  Lemma 10.37.7. Let $R$ be a domain with fraction field $K$. Suppose $f = \\sum \\alpha _ i x^ i$ is an element of $K[x]$. \n  \n  \nIf $f$ is integral over $R[x]$ then all $\\alpha _ i$ are integral over $R$, and \n\n\nIf $f$ is almost integral over $R[x]$ then all $\\alpha _ i$ are almost integral over $R$. \n\n\n\n\n    \n      Proof.\n      We first prove the second statement. Write $f = \\alpha _0 + \\alpha _1 x + \\ldots + \\alpha _ r x^ r$ with $\\alpha _ r \\not= 0$. By assumption there exists $h = b_0 + b_1 x + \\ldots + b_ s x^ s \\in R[x]$, $b_ s \\not= 0$ such that $f^ n h \\in R[x]$ for all $n \\geq 0$. This implies that $b_ s \\alpha _ r^ n \\in R$ for all $n \\geq 0$. Hence $\\alpha _ r$ is almost integral over $R$. Since the set of almost integral elements form a subring (Lemma 10.37.4) we deduce that $f - \\alpha _ r x^ r = \\alpha _0 + \\alpha _1 x + \\ldots + \\alpha _{r - 1} x^{r - 1}$ is almost integral over $R[x]$. By induction on $r$ we win. \n    \n      In order to prove the first statement we will use absolute Noetherian reduction. Namely, write $\\alpha _ i = a_ i / b_ i$ and let $P(t) = t^ d + \\sum _{j < d} f_ j t^ j$ be a polynomial with coefficients $f_ j \\in R[x]$ such that $P(f) = 0$. Let $f_ j = \\sum f_{ji}x^ i$. Consider the subring $R_0 \\subset R$ generated by the finite list of elements $a_ i, b_ i, f_{ji}$ of $R$. It is a domain; let $K_0$ be its field of fractions. Since $R_0$ is a finite type $\\mathbf{Z}$-algebra it is Noetherian, see Lemma 10.31.3. It is still the case that $f \\in K_0[x]$ is integral over $R_0[x]$, because all the identities in $R$ among the elements $a_ i, b_ i, f_{ji}$ also hold in $R_0$. By Lemma 10.37.4 the element $f$ is almost integral over $R_0[x]$. By the second statement of the lemma, the elements $\\alpha _ i$ are almost integral over $R_0$. And since $R_0$ is Noetherian, they are integral over $R_0$, see Lemma 10.37.4. Of course, then they are integral over $R$. \n      $\\square$\n    \n","\n  Lemma 10.37.7. Let $R$ be a domain with fraction field $K$. Suppose $f = \\sum \\alpha _ i x^ i$ is an element of $K[x]$. \n  \n  \nIf $f$ is integral over $R[x]$ then all $\\alpha _ i$ are integral over $R$, and \n\n\nIf $f$ is almost integral over $R[x]$ then all $\\alpha _ i$ are almost integral over $R$. \n\n\n\n\n    \n","Proof.\n      We first prove the second statement. Write $f = \\alpha _0 + \\alpha _1 x + \\ldots + \\alpha _ r x^ r$ with $\\alpha _ r \\not= 0$. By assumption there exists $h = b_0 + b_1 x + \\ldots + b_ s x^ s \\in R[x]$, $b_ s \\not= 0$ such that $f^ n h \\in R[x]$ for all $n \\geq 0$. This implies that $b_ s \\alpha _ r^ n \\in R$ for all $n \\geq 0$. Hence $\\alpha _ r$ is almost integral over $R$. Since the set of almost integral elements form a subring (Lemma 10.37.4) we deduce that $f - \\alpha _ r x^ r = \\alpha _0 + \\alpha _1 x + \\ldots + \\alpha _{r - 1} x^{r - 1}$ is almost integral over $R[x]$. By induction on $r$ we win. \n    \n      In order to prove the first statement we will use absolute Noetherian reduction. Namely, write $\\alpha _ i = a_ i / b_ i$ and let $P(t) = t^ d + \\sum _{j < d} f_ j t^ j$ be a polynomial with coefficients $f_ j \\in R[x]$ such that $P(f) = 0$. Let $f_ j = \\sum f_{ji}x^ i$. Consider the subring $R_0 \\subset R$ generated by the finite list of elements $a_ i, b_ i, f_{ji}$ of $R$. It is a domain; let $K_0$ be its field of fractions. Since $R_0$ is a finite type $\\mathbf{Z}$-algebra it is Noetherian, see Lemma 10.31.3. It is still the case that $f \\in K_0[x]$ is integral over $R_0[x]$, because all the identities in $R$ among the elements $a_ i, b_ i, f_{ji}$ also hold in $R_0$. By Lemma 10.37.4 the element $f$ is almost integral over $R_0[x]$. By the second statement of the lemma, the elements $\\alpha _ i$ are almost integral over $R_0$. And since $R_0$ is Noetherian, they are integral over $R_0$, see Lemma 10.37.4. Of course, then they are integral over $R$. \n      $\\square$\n    \n"," by
  nontriviality R
  nontriviality S
  obtain rfl | hp0 := eq_or_ne p 0; Â· simp [isIntegral_zero]
  let q := minpoly R[X] p
  let m := (q.support.sup fun i â†¦ (q.coeff i).natDegree) + p.natDegree + 1
  have hmâ‚ (i) : (q.coeff i).natDegree < m := by
    by_cases hi : i âˆˆ q.support
    Â· exact (Finset.le_sup (f := fun i â†¦ (q.coeff i).natDegree) hi).trans_lt (by lia)
    Â· simp_all [m]
  have hmâ‚' : (q.eval (X ^ m)).Monic := by
    rw [eval_eq_sum_range, Finset.sum_range_succ]
    refine .add_of_right (by simp [q, minpoly.monic hp, â† pow_mul]) (degree_lt_degree ?_)
    refine lt_of_lt_of_eq (b := m * q.natDegree) ?_ (by simp [q, minpoly.monic hp, â† pow_mul])
    refine (natDegree_sum_le ..).trans_lt ((Finset.fold_max_lt _).mpr
      âŸ¨by simpa using âŸ¨by lia, minpoly.natDegree_pos hpâŸ©, fun i hi â†¦ ?_âŸ©)
    dsimp
    simp only [Finset.mem_range] at hi
    grw [â† pow_mul, natDegree_mul_le, natDegree_X_pow, â† Nat.add_one_le_iff.mpr hi]
    have := hmâ‚ i
    lia
  have hmâ‚‚ : p.natDegree < m := by grind
  have hâ‚€ : algebraMap R[X] S[X] X = X := by simp
  have : (((taylor (X ^ m)) q).map (algebraMap R[X] S[X])).IsRoot (p - X ^ m) := by
    simpa [-algebraMap_def, q, hâ‚€] using
      ((q.map (algebraMap _ _)).taylor_eval (X ^ m) (p - X ^ m) :)
  have : X ^ m - p âˆ£ (eval (X ^ m) q).map (algebraMap _ _) := by
    change X ^ m - p âˆ£ Algebra.ofId R[X] S[X] _
    rw [â† coe_aeval_eq_eval, â† aeval_algHom_apply, â† neg_dvd, neg_sub]
    simpa [Polynomial.taylor_coeff_zero, -algebraMap_def, hâ‚€] using this.dvd_coeff_zero
  have := (isIntegral_coeff_of_dvd _ _ hmâ‚'
    ((monic_X_pow _).sub_of_left (by simpa [â† natDegree_lt_iff_degree_lt, hp0])) this i).neg
  obtain hi | hi := le_or_gt i p.natDegree
  Â· simpa [show i â‰  m by lia] using this
  Â· simp [coeff_eq_zero_of_natDegree_lt hi, isIntegral_zero]
","protected lemma IsIntegral.coeff
    {p : S[X]} (hp : IsIntegral R[X] p) (i : â„•) : IsIntegral R (p.coeff i) ","Proof.\n      We first prove the second statement. Write $f = \\alpha _0 + \\alpha _1 x + \\ldots + \\alpha _ r x^ r$ with $\\alpha _ r \\not= 0$. By assumption there exists $h = b_0 + b_1 x + \\ldots + b_ s x^ s \\in R[x]$, $b_ s \\not= 0$ such that $f^ n h \\in R[x]$ for all $n \\geq 0$. This implies that $b_ s \\alpha _ r^ n \\in R$ for all $n \\geq 0$. Hence $\\alpha _ r$ is almost integral over $R$. Since the set of almost integral elements form a subring (Lemma 10.37.4 [[\n  Lemma 10.37.4. Let $R$ be a domain with fraction field $K$. If $u, v \\in K$ are almost integral over $R$, then so are $u + v$ and $uv$. Any element $g \\in K$ which is integral over $R$ is almost integral over $R$. If $R$ is Noetherian then the converse holds as well. \n\n    \n]]) we deduce that $f - \\alpha _ r x^ r = \\alpha _0 + \\alpha _1 x + \\ldots + \\alpha _{r - 1} x^{r - 1}$ is almost integral over $R[x]$. By induction on $r$ we win. \n    \n      In order to prove the first statement we will use absolute Noetherian reduction. Namely, write $\\alpha _ i = a_ i / b_ i$ and let $P(t) = t^ d + \\sum _{j < d} f_ j t^ j$ be a polynomial with coefficients $f_ j \\in R[x]$ such that $P(f) = 0$. Let $f_ j = \\sum f_{ji}x^ i$. Consider the subring $R_0 \\subset R$ generated by the finite list of elements $a_ i, b_ i, f_{ji}$ of $R$. It is a domain; let $K_0$ be its field of fractions. Since $R_0$ is a finite type $\\mathbf{Z}$-algebra it is Noetherian, see Lemma 10.31.3 [[\n  Lemma 10.31.3. Any finite type algebra over a field is Noetherian. Any finite type algebra over $\\mathbf{Z}$ is Noetherian. \n\n    \n]]. It is still the case that $f \\in K_0[x]$ is integral over $R_0[x]$, because all the identities in $R$ among the elements $a_ i, b_ i, f_{ji}$ also hold in $R_0$. By Lemma 10.37.4 [[\n  Lemma 10.37.4. Let $R$ be a domain with fraction field $K$. If $u, v \\in K$ are almost integral over $R$, then so are $u + v$ and $uv$. Any element $g \\in K$ which is integral over $R$ is almost integral over $R$. If $R$ is Noetherian then the converse holds as well. \n\n    \n]] the element $f$ is almost integral over $R_0[x]$. By the second statement of the lemma, the elements $\\alpha _ i$ are almost integral over $R_0$. And since $R_0$ is Noetherian, they are integral over $R_0$, see Lemma 10.37.4 [[\n  Lemma 10.37.4. Let $R$ be a domain with fraction field $K$. If $u, v \\in K$ are almost integral over $R$, then so are $u + v$ and $uv$. Any element $g \\in K$ which is integral over $R$ is almost integral over $R$. If $R$ is Noetherian then the converse holds as well. \n\n    \n]]. Of course, then they are integral over $R$. \n      $\\square$\n    \n"
321,030A,"instance {R : Type*} [CommRing R] [IsDomain R] [IsIntegrallyClosed R] :
    IsIntegrallyClosed R[X] := by
  let K := FractionRing R
  have : IsIntegrallyClosed K[X] := UniqueFactorizationMonoid.instIsIntegrallyClosed
  suffices IsIntegrallyClosedIn R[X] K[X] from .of_isIntegrallyClosed_of_isIntegrallyClosedIn _ K[X]
  refine isIntegrallyClosedIn_iff.mpr âŸ¨map_injective _ (IsFractionRing.injective _ _), ?_âŸ©
  refine fun {p} hp â†¦ (lifts_iff_coeff_lifts _).mpr fun n â†¦ ?_
  exact IsIntegrallyClosed.isIntegral_iff.mp (hp.coeff _)
",Formal Proof of Stacks Project Tag 030A,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Polynomial/IsIntegral.lean#L180-L187,Q27041,,10.37.8,lemma,3.0,"['037B', '00AO', '0ELQ']",\n  Lemma 10.37.8. Let $R$ be a normal domain. Then $R[x]$ is a normal domain. \n\n    \n      Proof.\n      The result is true if $R$ is a field $K$ because $K[x]$ is a euclidean domain and hence a principal ideal domain and hence normal by Lemma 10.37.6. Let $g$ be an element of the fraction field of $R[x]$ which is integral over $R[x]$. Because $g$ is integral over $K[x]$ where $K$ is the fraction field of $R$ we may write $g = \\alpha _ d x^ d + \\alpha _{d-1}x^{d-1} + \\ldots + \\alpha _0$ with $\\alpha _ i \\in K$. By Lemma 10.37.7 the elements $\\alpha _ i$ are integral over $R$ and hence are in $R$. \n      $\\square$\n    \n,\n  Lemma 10.37.8. Let $R$ be a normal domain. Then $R[x]$ is a normal domain. \n\n    \n,Proof.\n      The result is true if $R$ is a field $K$ because $K[x]$ is a euclidean domain and hence a principal ideal domain and hence normal by Lemma 10.37.6. Let $g$ be an element of the fraction field of $R[x]$ which is integral over $R[x]$. Because $g$ is integral over $K[x]$ where $K$ is the fraction field of $R$ we may write $g = \\alpha _ d x^ d + \\alpha _{d-1}x^{d-1} + \\ldots + \\alpha _0$ with $\\alpha _ i \\in K$. By Lemma 10.37.7 the elements $\\alpha _ i$ are integral over $R$ and hence are in $R$. \n      $\\square$\n    \n," by
  let K := FractionRing R
  have : IsIntegrallyClosed K[X] := UniqueFactorizationMonoid.instIsIntegrallyClosed
  suffices IsIntegrallyClosedIn R[X] K[X] from .of_isIntegrallyClosed_of_isIntegrallyClosedIn _ K[X]
  refine isIntegrallyClosedIn_iff.mpr âŸ¨map_injective _ (IsFractionRing.injective _ _), ?_âŸ©
  refine fun {p} hp â†¦ (lifts_iff_coeff_lifts _).mpr fun n â†¦ ?_
  exact IsIntegrallyClosed.isIntegral_iff.mp (hp.coeff _)
","instance {R : Type*} [CommRing R] [IsDomain R] [IsIntegrallyClosed R] :
    IsIntegrallyClosed R[X] ","Proof.\n      The result is true if $R$ is a field $K$ because $K[x]$ is a euclidean domain and hence a principal ideal domain and hence normal by Lemma 10.37.6 [[\n  Lemma 10.37.6. A principal ideal domain is normal. \n\n    \n]]. Let $g$ be an element of the fraction field of $R[x]$ which is integral over $R[x]$. Because $g$ is integral over $K[x]$ where $K$ is the fraction field of $R$ we may write $g = \\alpha _ d x^ d + \\alpha _{d-1}x^{d-1} + \\ldots + \\alpha _0$ with $\\alpha _ i \\in K$. By Lemma 10.37.7 [[\n  Lemma 10.37.7. Let $R$ be a domain with fraction field $K$. Suppose $f = \\sum \\alpha _ i x^ i$ is an element of $K[x]$. \n  \n  \nIf $f$ is integral over $R[x]$ then all $\\alpha _ i$ are integral over $R$, and \n\n\nIf $f$ is almost integral over $R[x]$ then all $\\alpha _ i$ are almost integral over $R$. \n\n\n\n\n    \n]] the elements $\\alpha _ i$ are integral over $R$ and hence are in $R$. \n      $\\square$\n    \n"
322,09H0,"theorem _root_.Irreducible.hasSeparableContraction (q : â„•) [hF : ExpChar F q] {f : F[X]}
    (irred : Irreducible f) : HasSeparableContraction q f := by
  cases hF
  Â· exact âŸ¨f, irred.separable, âŸ¨0, by rw [pow_zero, expand_one]âŸ©âŸ©
  Â· rcases exists_separable_of_irreducible q irred â€¹q.Primeâ€º.ne_zero with âŸ¨n, g, hgs, hgeâŸ©
    exact âŸ¨g, hgs, n, hgeâŸ©
",Formal Proof of Stacks Project Tag 09H0,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Polynomial/SeparableDegree.lean#L103-L108,Q27041,,9.12.1,lemma,3.0,"['09GZ', '09FA', '0ELQ']","\n  Lemma 9.12.1. Let $F$ be a field. Let $P \\in F[x]$ be an irreducible polynomial over $F$. Let $P\' = \\text{d}P/\\text{d}x$ be the derivative of $P$ with respect to $x$. Then one of the following two cases happens \n  \n  \n$P$ and $P\'$ are relatively prime, or \n\n\n$P\'$ is the zero polynomial. \n\n\n\n   The second case can only happen if $F$ has characteristic $p > 0$. In this case $P(x) = Q(x^ q)$ where $q = p^ f$ is a power of $p$ and $Q \\in F[x]$ is an irreducible polynomial such that $Q$ and $Q\'$ are relatively prime. \n\n    \n      Proof.\n      Note that $P\'$ has degree $< \\deg (P)$. Hence if $P$ and $P\'$ are not relatively prime, then $(P, P\') = (R)$ where $R$ is a polynomial of degree $< \\deg (P)$ contradicting the irreducibility of $P$. This proves we have the dichotomy between (1) and (2). \n    \n      Assume we are in case (2) and $P = a_ d x^ d + \\ldots + a_0$. Then $P\' = da_ d x^{d - 1} + \\ldots + a_1$. In characteristic $0$ we see that this forces $a_ d, \\ldots , a_1 = 0$ which would mean $P$ is constant a contradiction. Thus we conclude that the characteristic $p$ is positive. In this case the condition $P\' = 0$ forces $a_ i = 0$ whenever $p$ does not divide $i$. In other words, $P(x) = P_1(x^ p)$ for some nonconstant polynomial $P_1$. Clearly, $P_1$ is irreducible as well. By induction on the degree we see that $P_1(x) = Q(x^ q)$ as in the statement of the lemma, hence $P(x) = Q(x^{pq})$ and the lemma is proved. \n      $\\square$\n    \n","\n  Lemma 9.12.1. Let $F$ be a field. Let $P \\in F[x]$ be an irreducible polynomial over $F$. Let $P\' = \\text{d}P/\\text{d}x$ be the derivative of $P$ with respect to $x$. Then one of the following two cases happens \n  \n  \n$P$ and $P\'$ are relatively prime, or \n\n\n$P\'$ is the zero polynomial. \n\n\n\n   The second case can only happen if $F$ has characteristic $p > 0$. In this case $P(x) = Q(x^ q)$ where $q = p^ f$ is a power of $p$ and $Q \\in F[x]$ is an irreducible polynomial such that $Q$ and $Q\'$ are relatively prime. \n\n    \n","Proof.\n      Note that $P\'$ has degree $< \\deg (P)$. Hence if $P$ and $P\'$ are not relatively prime, then $(P, P\') = (R)$ where $R$ is a polynomial of degree $< \\deg (P)$ contradicting the irreducibility of $P$. This proves we have the dichotomy between (1) and (2). \n    \n      Assume we are in case (2) and $P = a_ d x^ d + \\ldots + a_0$. Then $P\' = da_ d x^{d - 1} + \\ldots + a_1$. In characteristic $0$ we see that this forces $a_ d, \\ldots , a_1 = 0$ which would mean $P$ is constant a contradiction. Thus we conclude that the characteristic $p$ is positive. In this case the condition $P\' = 0$ forces $a_ i = 0$ whenever $p$ does not divide $i$. In other words, $P(x) = P_1(x^ p)$ for some nonconstant polynomial $P_1$. Clearly, $P_1$ is irreducible as well. By induction on the degree we see that $P_1(x) = Q(x^ q)$ as in the statement of the lemma, hence $P(x) = Q(x^{pq})$ and the lemma is proved. \n      $\\square$\n    \n"," by
  cases hF
  Â· exact âŸ¨f, irred.separable, âŸ¨0, by rw [pow_zero, expand_one]âŸ©âŸ©
  Â· rcases exists_separable_of_irreducible q irred â€¹q.Primeâ€º.ne_zero with âŸ¨n, g, hgs, hgeâŸ©
    exact âŸ¨g, hgs, n, hgeâŸ©
","theorem _root_.Irreducible.hasSeparableContraction (q : â„•) [hF : ExpChar F q] {f : F[X]}
    (irred : Irreducible f) : HasSeparableContraction q f ","Proof.\n      Note that $P\'$ has degree $< \\deg (P)$. Hence if $P$ and $P\'$ are not relatively prime, then $(P, P\') = (R)$ where $R$ is a polynomial of degree $< \\deg (P)$ contradicting the irreducibility of $P$. This proves we have the dichotomy between (1) and (2). \n    \n      Assume we are in case (2) and $P = a_ d x^ d + \\ldots + a_0$. Then $P\' = da_ d x^{d - 1} + \\ldots + a_1$. In characteristic $0$ we see that this forces $a_ d, \\ldots , a_1 = 0$ which would mean $P$ is constant a contradiction. Thus we conclude that the characteristic $p$ is positive. In this case the condition $P\' = 0$ forces $a_ i = 0$ whenever $p$ does not divide $i$. In other words, $P(x) = P_1(x^ p)$ for some nonconstant polynomial $P_1$. Clearly, $P_1$ is irreducible as well. By induction on the degree we see that $P_1(x) = Q(x^ q)$ as in the statement of the lemma, hence $P(x) = Q(x^{pq})$ and the lemma is proved. \n      $\\square$\n    \n"
323,00UH,"lemma _root_.Algebra.exists_etale_bijective_residueFieldMap_and_map_eq_mul_and_isCoprime.{u}
    {R : Type u} [CommRing R]
    (P : Ideal R) [P.IsPrime] (p : R[X])
    (f g : P.ResidueField[X]) (hp : p.Monic) (hf : f.Monic) (hg : g.Monic)
    (H : p.map (algebraMap R _) = f * g) (Hpq : IsCoprime f g) :
    âˆƒ (R' : Type u) (_ : CommRing R') (_ : Algebra R R') (_ : Algebra.Etale R R')
      (Q : Ideal R') (_ : Q.IsPrime) (_ : Q.LiesOver P) (f' g' : R'[X]),
    Function.Bijective (Ideal.ResidueField.mapâ‚ P Q (Algebra.ofId _ _) (Ideal.over_def Q P)) âˆ§
    f'.Monic âˆ§ g'.Monic âˆ§ p.map (algebraMap R R') = f' * g' âˆ§ IsCoprime f' g' âˆ§
    f.map (Ideal.ResidueField.mapâ‚ P Q (Algebra.ofId _ _) (Ideal.over_def Q P)).toRingHom =
      f'.map (algebraMap _ _) âˆ§
    g.map (Ideal.ResidueField.mapâ‚ P Q (Algebra.ofId _ _) (Ideal.over_def Q P)).toRingHom =
      g'.map (algebraMap _ _) := by
  obtain âŸ¨Q, _, _, hâ‚, hâ‚‚, hâ‚ƒâŸ© :=
    exists_liesOver_residueFieldMap_bijective f.natDegree g.natDegree
    (by simpa [hf.natDegree_mul hg, hp.natDegree_map] using congr(($H).natDegree)) (.mk p hp rfl)
    P (.mk f hf rfl) (.mk g hg rfl) H Hpq
  exact âŸ¨_, _, _, inferInstance, Q, â€¹_â€º, â€¹_â€º, (factorâ‚ ..).1, (factorâ‚‚ ..).1, hâ‚,
    (factorâ‚ ..).monic, (factorâ‚‚ ..).monic, (factorâ‚_mul_factorâ‚‚ ..).symm,
    isCoprime_factorâ‚_factorâ‚‚ .., congr(($hâ‚‚).1), congr(($hâ‚ƒ).1)âŸ©
",Formal Proof of Stacks Project Tag 00UH,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Polynomial/UniversalFactorizationRing.lean#L682-L701,Q27041,,10.143.13,lemma,3.0,"['00U0', '00AO', '0ELQ']","\n  Lemma 10.143.13. Let $R$ be a ring. Let $f \\in R[x]$ be a monic polynomial. Let $\\mathfrak p$ be a prime of $R$. Let $f \\bmod \\mathfrak p = \\overline{g} \\overline{h}$ be a factorization of the image of $f$ in $\\kappa (\\mathfrak p)[x]$. If $\\gcd (\\overline{g}, \\overline{h}) = 1$, then there exist \n  \n  \nan \xc3\xa9tale ring map $R \\to R\'$, \n\n\na prime $\\mathfrak p\' \\subset R\'$ lying over $\\mathfrak p$, and \n\n\na factorization $f = g h$ in $R\'[x]$ \n\n\n\n   such that \n  \n  \n$\\kappa (\\mathfrak p) = \\kappa (\\mathfrak p\')$, \n\n\n$\\overline{g} = g \\bmod \\mathfrak p\'$, $\\overline{h} = h \\bmod \\mathfrak p\'$, and \n\n\nthe polynomials $g, h$ generate the unit ideal in $R\'[x]$. \n\n\n\n\n    \n      Proof.\n      Suppose $\\overline{g} = \\overline{b}_0 x^ n + \\overline{b}_1 x^{n - 1} + \\ldots + \\overline{b}_ n$, and $\\overline{h} = \\overline{c}_0 x^ m + \\overline{c}_1 x^{m - 1} + \\ldots + \\overline{c}_ m$ with $\\overline{b}_0, \\overline{c}_0 \\in \\kappa (\\mathfrak p)$ nonzero. After localizing $R$ at some element of $R$ not contained in $\\mathfrak p$ we may assume $\\overline{b}_0$ is the image of an invertible element $b_0 \\in R$. Replacing $\\overline{g}$ by $\\overline{g}/b_0$ and $\\overline{h}$ by $b_0\\overline{h}$ we reduce to the case where $\\overline{g}$, $\\overline{h}$ are monic (verification omitted). Say $\\overline{g} = x^ n + \\overline{b}_1 x^{n - 1} + \\ldots + \\overline{b}_ n$, and $\\overline{h} = x^ m + \\overline{c}_1 x^{m - 1} + \\ldots + \\overline{c}_ m$. Write $f = x^{n + m} + a_1 x^{n + m - 1} + \\ldots + a_{n + m}$. Consider the fibre product \n    \n      \n  \\[  R\' = R \\otimes _{\\mathbf{Z}[a_1, \\ldots , a_{n + m}]} \\mathbf{Z}[b_1, \\ldots , b_ n, c_1, \\ldots , c_ m]  \\]\n\n    \n       where the map $\\mathbf{Z}[a_ k] \\to \\mathbf{Z}[b_ i, c_ j]$ is as in Examples 10.136.7 and 10.143.12. By construction there is an $R$-algebra map \n    \n      \n  \\[  R\' = R \\otimes _{\\mathbf{Z}[a_1, \\ldots , a_{n + m}]} \\mathbf{Z}[b_1, \\ldots , b_ n, c_1, \\ldots , c_ m] \\longrightarrow \\kappa (\\mathfrak p)  \\]\n\n    \n       which maps $b_ i$ to $\\overline{b}_ i$ and $c_ j$ to $\\overline{c}_ j$. Denote $\\mathfrak p\' \\subset R\'$ the kernel of this map. Since by assumption the polynomials $\\overline{g}, \\overline{h}$ are relatively prime we see that the element $\\Delta = \\text{Res}_ x(g, h) \\in \\mathbf{Z}[b_ i, c_ j]$ (see Example 10.143.12) does not map to zero in $\\kappa (\\mathfrak p)$ under the displayed map. We conclude that $R \\to R\'$ is \xc3\xa9tale at $\\mathfrak p\'$. In fact a solution to the problem posed in the lemma is the ring map $R \\to R\'[1/\\Delta ]$ and the prime $\\mathfrak p\' R\'[1/\\Delta ]$. Because $\\text{Res}_ x(f, g)$ is invertible in this ring the Sylvester matrix is invertible over $R\'[1/\\Delta ]$ and hence $1 = a g + b h$ for some $a, b \\in R\'[1/\\Delta ][x]$ see Example 10.143.12. \n      $\\square$\n    \n","\n  Lemma 10.143.13. Let $R$ be a ring. Let $f \\in R[x]$ be a monic polynomial. Let $\\mathfrak p$ be a prime of $R$. Let $f \\bmod \\mathfrak p = \\overline{g} \\overline{h}$ be a factorization of the image of $f$ in $\\kappa (\\mathfrak p)[x]$. If $\\gcd (\\overline{g}, \\overline{h}) = 1$, then there exist \n  \n  \nan \xc3\xa9tale ring map $R \\to R\'$, \n\n\na prime $\\mathfrak p\' \\subset R\'$ lying over $\\mathfrak p$, and \n\n\na factorization $f = g h$ in $R\'[x]$ \n\n\n\n   such that \n  \n  \n$\\kappa (\\mathfrak p) = \\kappa (\\mathfrak p\')$, \n\n\n$\\overline{g} = g \\bmod \\mathfrak p\'$, $\\overline{h} = h \\bmod \\mathfrak p\'$, and \n\n\nthe polynomials $g, h$ generate the unit ideal in $R\'[x]$. \n\n\n\n\n    \n","Proof.\n      Suppose $\\overline{g} = \\overline{b}_0 x^ n + \\overline{b}_1 x^{n - 1} + \\ldots + \\overline{b}_ n$, and $\\overline{h} = \\overline{c}_0 x^ m + \\overline{c}_1 x^{m - 1} + \\ldots + \\overline{c}_ m$ with $\\overline{b}_0, \\overline{c}_0 \\in \\kappa (\\mathfrak p)$ nonzero. After localizing $R$ at some element of $R$ not contained in $\\mathfrak p$ we may assume $\\overline{b}_0$ is the image of an invertible element $b_0 \\in R$. Replacing $\\overline{g}$ by $\\overline{g}/b_0$ and $\\overline{h}$ by $b_0\\overline{h}$ we reduce to the case where $\\overline{g}$, $\\overline{h}$ are monic (verification omitted). Say $\\overline{g} = x^ n + \\overline{b}_1 x^{n - 1} + \\ldots + \\overline{b}_ n$, and $\\overline{h} = x^ m + \\overline{c}_1 x^{m - 1} + \\ldots + \\overline{c}_ m$. Write $f = x^{n + m} + a_1 x^{n + m - 1} + \\ldots + a_{n + m}$. Consider the fibre product \n    \n      \n  \\[  R\' = R \\otimes _{\\mathbf{Z}[a_1, \\ldots , a_{n + m}]} \\mathbf{Z}[b_1, \\ldots , b_ n, c_1, \\ldots , c_ m]  \\]\n\n    \n       where the map $\\mathbf{Z}[a_ k] \\to \\mathbf{Z}[b_ i, c_ j]$ is as in Examples 10.136.7 and 10.143.12. By construction there is an $R$-algebra map \n    \n      \n  \\[  R\' = R \\otimes _{\\mathbf{Z}[a_1, \\ldots , a_{n + m}]} \\mathbf{Z}[b_1, \\ldots , b_ n, c_1, \\ldots , c_ m] \\longrightarrow \\kappa (\\mathfrak p)  \\]\n\n    \n       which maps $b_ i$ to $\\overline{b}_ i$ and $c_ j$ to $\\overline{c}_ j$. Denote $\\mathfrak p\' \\subset R\'$ the kernel of this map. Since by assumption the polynomials $\\overline{g}, \\overline{h}$ are relatively prime we see that the element $\\Delta = \\text{Res}_ x(g, h) \\in \\mathbf{Z}[b_ i, c_ j]$ (see Example 10.143.12) does not map to zero in $\\kappa (\\mathfrak p)$ under the displayed map. We conclude that $R \\to R\'$ is \xc3\xa9tale at $\\mathfrak p\'$. In fact a solution to the problem posed in the lemma is the ring map $R \\to R\'[1/\\Delta ]$ and the prime $\\mathfrak p\' R\'[1/\\Delta ]$. Because $\\text{Res}_ x(f, g)$ is invertible in this ring the Sylvester matrix is invertible over $R\'[1/\\Delta ]$ and hence $1 = a g + b h$ for some $a, b \\in R\'[1/\\Delta ][x]$ see Example 10.143.12. \n      $\\square$\n    \n"," by
  obtain âŸ¨Q, _, _, hâ‚, hâ‚‚, hâ‚ƒâŸ© :=
    exists_liesOver_residueFieldMap_bijective f.natDegree g.natDegree
    (by simpa [hf.natDegree_mul hg, hp.natDegree_map] using congr(($H).natDegree)) (.mk p hp rfl)
    P (.mk f hf rfl) (.mk g hg rfl) H Hpq
  exact âŸ¨_, _, _, inferInstance, Q, â€¹_â€º, â€¹_â€º, (factorâ‚ ..).1, (factorâ‚‚ ..).1, hâ‚,
    (factorâ‚ ..).monic, (factorâ‚‚ ..).monic, (factorâ‚_mul_factorâ‚‚ ..).symm,
    isCoprime_factorâ‚_factorâ‚‚ .., congr(($hâ‚‚).1), congr(($hâ‚ƒ).1)âŸ©
","lemma _root_.Algebra.exists_etale_bijective_residueFieldMap_and_map_eq_mul_and_isCoprime.{u}
    {R : Type u} [CommRing R]
    (P : Ideal R) [P.IsPrime] (p : R[X])
    (f g : P.ResidueField[X]) (hp : p.Monic) (hf : f.Monic) (hg : g.Monic)
    (H : p.map (algebraMap R _) = f * g) (Hpq : IsCoprime f g) :
    âˆƒ (R' : Type u) (_ : CommRing R') (_ : Algebra R R') (_ : Algebra.Etale R R')
      (Q : Ideal R') (_ : Q.IsPrime) (_ : Q.LiesOver P) (f' g' : R'[X]),
    Function.Bijective (Ideal.ResidueField.mapâ‚ P Q (Algebra.ofId _ _) (Ideal.over_def Q P)) âˆ§
    f'.Monic âˆ§ g'.Monic âˆ§ p.map (algebraMap R R') = f' * g' âˆ§ IsCoprime f' g' âˆ§
    f.map (Ideal.ResidueField.mapâ‚ P Q (Algebra.ofId _ _) (Ideal.over_def Q P)).toRingHom =
      f'.map (algebraMap _ _) âˆ§
    g.map (Ideal.ResidueField.mapâ‚ P Q (Algebra.ofId _ _) (Ideal.over_def Q P)).toRingHom =
      g'.map (algebraMap _ _) ","Proof.\n      Suppose $\\overline{g} = \\overline{b}_0 x^ n + \\overline{b}_1 x^{n - 1} + \\ldots + \\overline{b}_ n$, and $\\overline{h} = \\overline{c}_0 x^ m + \\overline{c}_1 x^{m - 1} + \\ldots + \\overline{c}_ m$ with $\\overline{b}_0, \\overline{c}_0 \\in \\kappa (\\mathfrak p)$ nonzero. After localizing $R$ at some element of $R$ not contained in $\\mathfrak p$ we may assume $\\overline{b}_0$ is the image of an invertible element $b_0 \\in R$. Replacing $\\overline{g}$ by $\\overline{g}/b_0$ and $\\overline{h}$ by $b_0\\overline{h}$ we reduce to the case where $\\overline{g}$, $\\overline{h}$ are monic (verification omitted). Say $\\overline{g} = x^ n + \\overline{b}_1 x^{n - 1} + \\ldots + \\overline{b}_ n$, and $\\overline{h} = x^ m + \\overline{c}_1 x^{m - 1} + \\ldots + \\overline{c}_ m$. Write $f = x^{n + m} + a_1 x^{n + m - 1} + \\ldots + a_{n + m}$. Consider the fibre product \n    \n      \n  \\[  R\' = R \\otimes _{\\mathbf{Z}[a_1, \\ldots , a_{n + m}]} \\mathbf{Z}[b_1, \\ldots , b_ n, c_1, \\ldots , c_ m]  \\]\n\n    \n       where the map $\\mathbf{Z}[a_ k] \\to \\mathbf{Z}[b_ i, c_ j]$ is as in Examples 10.136.7 [[\n  Example 10.136.7. Let $n , m \\geq 1$ be integers. Consider the ring map \n  \n  \\begin{eqnarray*}  R = \\mathbf{Z}[a_1, \\ldots , a_{n + m}] &  \\longrightarrow &  S = \\mathbf{Z}[b_1, \\ldots , b_ n, c_1, \\ldots , c_ m] \\\\  a_1 &  \\longmapsto &  b_1 + c_1 \\\\  a_2 &  \\longmapsto &  b_2 + b_1 c_1 + c_2 \\\\  \\ldots &  \\ldots &  \\ldots \\\\  a_{n + m} &  \\longmapsto &  b_ n c_ m \\end{eqnarray*}\n\n   In other words, this is the unique ring map of polynomial rings as indicated such that the polynomial factorization \n  \n  \\[  x^{n + m} + a_1 x^{n + m - 1} + \\ldots + a_{n + m} = (x^ n + b_1 x^{n - 1} + \\ldots + b_ n) (x^ m + c_1 x^{m - 1} + \\ldots + c_ m)  \\]\n\n   holds. Note that $S$ is generated by $n + m$ elements over $R$ (namely, $b_ i, c_ j$) and that there are $n + m$ equations (namely $a_ k = a_ k(b_ i, c_ j)$). In order to show that $S$ is a relative global complete intersection over $R$ it suffices to prove that all fibres have dimension $0$. \n  To prove this, let $R \\to k$ be a ring map into a field $k$. Say $a_ i$ maps to $\\alpha _ i \\in k$. Consider the fibre ring $S_ k = k \\otimes _ R S$. Let $k \\to K$ be a field extension. A $k$-algebra map of $S_ k \\to K$ is the same thing as finding $\\beta _1, \\ldots , \\beta _ n, \\gamma _1, \\ldots , \\gamma _ m \\in K$ such that \n  \n  \\[  x^{n + m} + \\alpha _1 x^{n + m - 1} + \\ldots + \\alpha _{n + m} = (x^ n + \\beta _1 x^{n - 1} + \\ldots + \\beta _ n) (x^ m + \\gamma _1 x^{m - 1} + \\ldots + \\gamma _ m).  \\]\n\n   Hence we see there are at most finitely many choices of such $n + m$-tuples in $K$. This proves that all fibres have finitely many closed points (use Hilbert\'s Nullstellensatz to see they all correspond to solutions in $\\overline{k}$ for example) and hence that $R \\to S$ is a relative global complete intersection. \n  Another way to argue this is to show $\\mathbf{Z}[a_1, \\ldots , a_{n + m}] \\to \\mathbf{Z}[b_1, \\ldots , b_ n, c_1, \\ldots , c_ m]$ is actually also a finite ring map. Namely, by Lemma 10.38.5 each of $b_ i, c_ j$ is integral over $R$, and hence $R \\to S$ is finite by Lemma 10.36.4. \n]] and 10.143.12 [[\n  Example 10.143.12. Let $n , m \\geq 1$ be integers. Consider the ring map \n  \n  \\begin{eqnarray*}  R = \\mathbf{Z}[a_1, \\ldots , a_{n + m}] &  \\longrightarrow &  S = \\mathbf{Z}[b_1, \\ldots , b_ n, c_1, \\ldots , c_ m] \\\\  a_1 &  \\longmapsto &  b_1 + c_1 \\\\  a_2 &  \\longmapsto &  b_2 + b_1 c_1 + c_2 \\\\  \\ldots &  \\ldots &  \\ldots \\\\  a_{n + m} &  \\longmapsto &  b_ n c_ m \\end{eqnarray*}\n\n   of Example 10.136.7. Write symbolically \n  \n  \\[  S = R[b_1, \\ldots , c_ m]/(\\{ a_ k(b_ i, c_ j) - a_ k\\} _{k = 1, \\ldots , n + m})  \\]\n\n   where for example $a_1(b_ i, c_ j) = b_1 + c_1$. The matrix of partial derivatives is \n  \n  \\[  \\left( \\begin{matrix}  1 \n\n&  c_1 \n\n&  \\ldots \n\n&  c_ m \n\n&  0 \n\n&  \\ldots \n\n&  \\ldots \n\n&  0 \n\n\\\\  0 \n\n&  1 \n\n&  c_1 \n\n&  \\ldots \n\n&  c_ m \n\n&  0 \n\n&  \\ldots \n\n&  0 \n\n\\\\  \\ldots \n\n&  \\ldots \n\n&  \\ldots \n\n&  \\ldots \n\n&  \\ldots \n\n&  \\ldots \n\n&  \\ldots \n\n&  \\ldots \n\n\\\\  0 \n\n&  \\ldots \n\n&  0 \n\n&  1 \n\n&  c_1 \n\n&  c_2 \n\n&  \\ldots \n\n&  c_ m \n\n\\\\  1 \n\n&  b_1 \n\n&  \\ldots \n\n&  b_{n - 1} \n\n&  b_ n \n\n&  0 \n\n&  \\ldots \n\n&  0 \n\n\\\\  0 \n\n&  1 \n\n&  b_1 \n\n&  \\ldots \n\n&  b_{n - 1} \n\n&  b_ n \n\n&  \\ldots \n\n&  0 \n\n\\\\  \\ldots \n\n&  \\ldots \n\n&  \\ldots \n\n&  \\ldots \n\n&  \\ldots \n\n&  \\ldots \n\n&  \\ldots \n\n&  \\ldots \n\n\\\\  0 \n\n&  \\ldots \n\n&  \\ldots \n\n&  0 \n\n&  1 \n\n&  b_1 \n\n&  \\ldots \n\n&  b_ n \n\n\\end{matrix} \\right)  \\]\n\n   The determinant $\\Delta $ of this matrix is better known as the resultant of the polynomials $g = x^ n + b_1 x^{n - 1} + \\ldots + b_ n$ and $h = x^ m + c_1 x^{m - 1} + \\ldots + c_ m$, and the matrix above is known as the Sylvester matrix associated to $g, h$. In a formula $\\Delta = \\text{Res}_ x(g, h)$. The Sylvester matrix is the transpose of the matrix of the linear map \n  \n  \\begin{eqnarray*}  S[x]_{< m} \\oplus S[x]_{< n} &  \\longrightarrow &  S[x]_{< n + m} \\\\  a \\oplus b &  \\longmapsto &  ag + bh \\end{eqnarray*}\n\n   Let $\\mathfrak q \\subset S$ be any prime. By the above the following are equivalent: \n  \n  \n$R \\to S$ is \xc3\xa9tale at $\\mathfrak q$, \n\n\n$\\Delta = \\text{Res}_ x(g, h) \\not\\in \\mathfrak q$, \n\n\nthe images $\\overline{g}, \\overline{h} \\in \\kappa (\\mathfrak q)[x]$ of the polynomials $g, h$ are relatively prime in $\\kappa (\\mathfrak q)[x]$. \n\n\n\n   The equivalence of (2) and (3) holds because the image of the Sylvester matrix in $\\text{Mat}(n + m, \\kappa (\\mathfrak q))$ has a kernel if and only if the polynomials $\\overline{g}, \\overline{h}$ have a factor in common. We conclude that the ring map \n  \n  \\[  R \\longrightarrow S[\\frac{1}{\\Delta }] = S[\\frac{1}{\\text{Res}_ x(g, h)}]  \\]\n\n   is \xc3\xa9tale. \n]]. By construction there is an $R$-algebra map \n    \n      \n  \\[  R\' = R \\otimes _{\\mathbf{Z}[a_1, \\ldots , a_{n + m}]} \\mathbf{Z}[b_1, \\ldots , b_ n, c_1, \\ldots , c_ m] \\longrightarrow \\kappa (\\mathfrak p)  \\]\n\n    \n       which maps $b_ i$ to $\\overline{b}_ i$ and $c_ j$ to $\\overline{c}_ j$. Denote $\\mathfrak p\' \\subset R\'$ the kernel of this map. Since by assumption the polynomials $\\overline{g}, \\overline{h}$ are relatively prime we see that the element $\\Delta = \\text{Res}_ x(g, h) \\in \\mathbf{Z}[b_ i, c_ j]$ (see Example 10.143.12 [[\n  Example 10.143.12. Let $n , m \\geq 1$ be integers. Consider the ring map \n  \n  \\begin{eqnarray*}  R = \\mathbf{Z}[a_1, \\ldots , a_{n + m}] &  \\longrightarrow &  S = \\mathbf{Z}[b_1, \\ldots , b_ n, c_1, \\ldots , c_ m] \\\\  a_1 &  \\longmapsto &  b_1 + c_1 \\\\  a_2 &  \\longmapsto &  b_2 + b_1 c_1 + c_2 \\\\  \\ldots &  \\ldots &  \\ldots \\\\  a_{n + m} &  \\longmapsto &  b_ n c_ m \\end{eqnarray*}\n\n   of Example 10.136.7. Write symbolically \n  \n  \\[  S = R[b_1, \\ldots , c_ m]/(\\{ a_ k(b_ i, c_ j) - a_ k\\} _{k = 1, \\ldots , n + m})  \\]\n\n   where for example $a_1(b_ i, c_ j) = b_1 + c_1$. The matrix of partial derivatives is \n  \n  \\[  \\left( \\begin{matrix}  1 \n\n&  c_1 \n\n&  \\ldots \n\n&  c_ m \n\n&  0 \n\n&  \\ldots \n\n&  \\ldots \n\n&  0 \n\n\\\\  0 \n\n&  1 \n\n&  c_1 \n\n&  \\ldots \n\n&  c_ m \n\n&  0 \n\n&  \\ldots \n\n&  0 \n\n\\\\  \\ldots \n\n&  \\ldots \n\n&  \\ldots \n\n&  \\ldots \n\n&  \\ldots \n\n&  \\ldots \n\n&  \\ldots \n\n&  \\ldots \n\n\\\\  0 \n\n&  \\ldots \n\n&  0 \n\n&  1 \n\n&  c_1 \n\n&  c_2 \n\n&  \\ldots \n\n&  c_ m \n\n\\\\  1 \n\n&  b_1 \n\n&  \\ldots \n\n&  b_{n - 1} \n\n&  b_ n \n\n&  0 \n\n&  \\ldots \n\n&  0 \n\n\\\\  0 \n\n&  1 \n\n&  b_1 \n\n&  \\ldots \n\n&  b_{n - 1} \n\n&  b_ n \n\n&  \\ldots \n\n&  0 \n\n\\\\  \\ldots \n\n&  \\ldots \n\n&  \\ldots \n\n&  \\ldots \n\n&  \\ldots \n\n&  \\ldots \n\n&  \\ldots \n\n&  \\ldots \n\n\\\\  0 \n\n&  \\ldots \n\n&  \\ldots \n\n&  0 \n\n&  1 \n\n&  b_1 \n\n&  \\ldots \n\n&  b_ n \n\n\\end{matrix} \\right)  \\]\n\n   The determinant $\\Delta $ of this matrix is better known as the resultant of the polynomials $g = x^ n + b_1 x^{n - 1} + \\ldots + b_ n$ and $h = x^ m + c_1 x^{m - 1} + \\ldots + c_ m$, and the matrix above is known as the Sylvester matrix associated to $g, h$. In a formula $\\Delta = \\text{Res}_ x(g, h)$. The Sylvester matrix is the transpose of the matrix of the linear map \n  \n  \\begin{eqnarray*}  S[x]_{< m} \\oplus S[x]_{< n} &  \\longrightarrow &  S[x]_{< n + m} \\\\  a \\oplus b &  \\longmapsto &  ag + bh \\end{eqnarray*}\n\n   Let $\\mathfrak q \\subset S$ be any prime. By the above the following are equivalent: \n  \n  \n$R \\to S$ is \xc3\xa9tale at $\\mathfrak q$, \n\n\n$\\Delta = \\text{Res}_ x(g, h) \\not\\in \\mathfrak q$, \n\n\nthe images $\\overline{g}, \\overline{h} \\in \\kappa (\\mathfrak q)[x]$ of the polynomials $g, h$ are relatively prime in $\\kappa (\\mathfrak q)[x]$. \n\n\n\n   The equivalence of (2) and (3) holds because the image of the Sylvester matrix in $\\text{Mat}(n + m, \\kappa (\\mathfrak q))$ has a kernel if and only if the polynomials $\\overline{g}, \\overline{h}$ have a factor in common. We conclude that the ring map \n  \n  \\[  R \\longrightarrow S[\\frac{1}{\\Delta }] = S[\\frac{1}{\\text{Res}_ x(g, h)}]  \\]\n\n   is \xc3\xa9tale. \n]]) does not map to zero in $\\kappa (\\mathfrak p)$ under the displayed map. We conclude that $R \\to R\'$ is \xc3\xa9tale at $\\mathfrak p\'$. In fact a solution to the problem posed in the lemma is the ring map $R \\to R\'[1/\\Delta ]$ and the prime $\\mathfrak p\' R\'[1/\\Delta ]$. Because $\\text{Res}_ x(f, g)$ is invertible in this ring the Sylvester matrix is invertible over $R\'[1/\\Delta ]$ and hence $1 = a g + b h$ for some $a, b \\in R\'[1/\\Delta ][x]$ see Example 10.143.12 [[\n  Example 10.143.12. Let $n , m \\geq 1$ be integers. Consider the ring map \n  \n  \\begin{eqnarray*}  R = \\mathbf{Z}[a_1, \\ldots , a_{n + m}] &  \\longrightarrow &  S = \\mathbf{Z}[b_1, \\ldots , b_ n, c_1, \\ldots , c_ m] \\\\  a_1 &  \\longmapsto &  b_1 + c_1 \\\\  a_2 &  \\longmapsto &  b_2 + b_1 c_1 + c_2 \\\\  \\ldots &  \\ldots &  \\ldots \\\\  a_{n + m} &  \\longmapsto &  b_ n c_ m \\end{eqnarray*}\n\n   of Example 10.136.7. Write symbolically \n  \n  \\[  S = R[b_1, \\ldots , c_ m]/(\\{ a_ k(b_ i, c_ j) - a_ k\\} _{k = 1, \\ldots , n + m})  \\]\n\n   where for example $a_1(b_ i, c_ j) = b_1 + c_1$. The matrix of partial derivatives is \n  \n  \\[  \\left( \\begin{matrix}  1 \n\n&  c_1 \n\n&  \\ldots \n\n&  c_ m \n\n&  0 \n\n&  \\ldots \n\n&  \\ldots \n\n&  0 \n\n\\\\  0 \n\n&  1 \n\n&  c_1 \n\n&  \\ldots \n\n&  c_ m \n\n&  0 \n\n&  \\ldots \n\n&  0 \n\n\\\\  \\ldots \n\n&  \\ldots \n\n&  \\ldots \n\n&  \\ldots \n\n&  \\ldots \n\n&  \\ldots \n\n&  \\ldots \n\n&  \\ldots \n\n\\\\  0 \n\n&  \\ldots \n\n&  0 \n\n&  1 \n\n&  c_1 \n\n&  c_2 \n\n&  \\ldots \n\n&  c_ m \n\n\\\\  1 \n\n&  b_1 \n\n&  \\ldots \n\n&  b_{n - 1} \n\n&  b_ n \n\n&  0 \n\n&  \\ldots \n\n&  0 \n\n\\\\  0 \n\n&  1 \n\n&  b_1 \n\n&  \\ldots \n\n&  b_{n - 1} \n\n&  b_ n \n\n&  \\ldots \n\n&  0 \n\n\\\\  \\ldots \n\n&  \\ldots \n\n&  \\ldots \n\n&  \\ldots \n\n&  \\ldots \n\n&  \\ldots \n\n&  \\ldots \n\n&  \\ldots \n\n\\\\  0 \n\n&  \\ldots \n\n&  \\ldots \n\n&  0 \n\n&  1 \n\n&  b_1 \n\n&  \\ldots \n\n&  b_ n \n\n\\end{matrix} \\right)  \\]\n\n   The determinant $\\Delta $ of this matrix is better known as the resultant of the polynomials $g = x^ n + b_1 x^{n - 1} + \\ldots + b_ n$ and $h = x^ m + c_1 x^{m - 1} + \\ldots + c_ m$, and the matrix above is known as the Sylvester matrix associated to $g, h$. In a formula $\\Delta = \\text{Res}_ x(g, h)$. The Sylvester matrix is the transpose of the matrix of the linear map \n  \n  \\begin{eqnarray*}  S[x]_{< m} \\oplus S[x]_{< n} &  \\longrightarrow &  S[x]_{< n + m} \\\\  a \\oplus b &  \\longmapsto &  ag + bh \\end{eqnarray*}\n\n   Let $\\mathfrak q \\subset S$ be any prime. By the above the following are equivalent: \n  \n  \n$R \\to S$ is \xc3\xa9tale at $\\mathfrak q$, \n\n\n$\\Delta = \\text{Res}_ x(g, h) \\not\\in \\mathfrak q$, \n\n\nthe images $\\overline{g}, \\overline{h} \\in \\kappa (\\mathfrak q)[x]$ of the polynomials $g, h$ are relatively prime in $\\kappa (\\mathfrak q)[x]$. \n\n\n\n   The equivalence of (2) and (3) holds because the image of the Sylvester matrix in $\\text{Mat}(n + m, \\kappa (\\mathfrak q))$ has a kernel if and only if the polynomials $\\overline{g}, \\overline{h}$ have a factor in common. We conclude that the ring map \n  \n  \\[  R \\longrightarrow S[\\frac{1}{\\Delta }] = S[\\frac{1}{\\text{Res}_ x(g, h)}]  \\]\n\n   is \xc3\xa9tale. \n]]. \n      $\\square$\n    \n"
324,00PP,"instance baseChange [QuasiFinite R S] {A : Type*} [CommRing A] [Algebra R A] :
    QuasiFinite A (A âŠ—[R] S) := by
  refine âŸ¨fun P hP â†¦ ?_âŸ©
  let p := P.under R
  let e : P.Fiber (A âŠ—[R] S) â‰ƒâ‚[P.ResidueField] P.ResidueField âŠ—[p.ResidueField] (p.Fiber S) :=
    (Algebra.TensorProduct.cancelBaseChange _ _ _ _ _).trans
      (Algebra.TensorProduct.cancelBaseChange _ _ _ _ _).symm
  exact .of_surjective e.symm.toLinearMap e.symm.surjective
",Formal Proof of Stacks Project Tag 00PP,(3),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/QuasiFinite/Basic.lean#L104-L111,Q27041,,10.122.9,lemma,3.0,"['02MK', '00AO', '0ELQ']","\n  Lemma 10.122.9. Let $R \\to S$ be a ring map of finite type. Let $R \\to R\'$ be any ring map. Set $S\' = R\' \\otimes _ R S$. \n  \n  \nThe set $\\{ \\mathfrak q\' \\mid R\' \\to S\' \\text{ quasi-finite at }\\mathfrak q\'\\} $ is the inverse image of the corresponding set of $\\mathop{\\mathrm{Spec}}(S)$ under the canonical map $\\mathop{\\mathrm{Spec}}(S\') \\to \\mathop{\\mathrm{Spec}}(S)$. \n\n\nIf $\\mathop{\\mathrm{Spec}}(R\') \\to \\mathop{\\mathrm{Spec}}(R)$ is surjective, then $R \\to S$ is quasi-finite if and only if $R\' \\to S\'$ is quasi-finite. \n\n\nAny base change of a quasi-finite ring map is quasi-finite. \n\n\n\n\n    \n      Proof.\n      Let $\\mathfrak p\' \\subset R\'$ be a prime lying over $\\mathfrak p \\subset R$. Then the fibre ring $S\' \\otimes _{R\'} \\kappa (\\mathfrak p\')$ is the base change of the fibre ring $S \\otimes _ R \\kappa (\\mathfrak p)$ by the field extension $\\kappa (\\mathfrak p) \\to \\kappa (\\mathfrak p\')$. Hence the first assertion follows from the invariance of dimension under field extension (Lemma 10.116.6) and Lemma 10.122.1. The stability of quasi-finite maps under base change follows from this and the stability of finite type property under base change. The second assertion follows since the assumption implies that given a prime $\\mathfrak q \\subset S$ we can find a prime $\\mathfrak q\' \\subset S\'$ lying over it. \n      $\\square$\n    \n","\n  Lemma 10.122.9. Let $R \\to S$ be a ring map of finite type. Let $R \\to R\'$ be any ring map. Set $S\' = R\' \\otimes _ R S$. \n  \n  \nThe set $\\{ \\mathfrak q\' \\mid R\' \\to S\' \\text{ quasi-finite at }\\mathfrak q\'\\} $ is the inverse image of the corresponding set of $\\mathop{\\mathrm{Spec}}(S)$ under the canonical map $\\mathop{\\mathrm{Spec}}(S\') \\to \\mathop{\\mathrm{Spec}}(S)$. \n\n\nIf $\\mathop{\\mathrm{Spec}}(R\') \\to \\mathop{\\mathrm{Spec}}(R)$ is surjective, then $R \\to S$ is quasi-finite if and only if $R\' \\to S\'$ is quasi-finite. \n\n\nAny base change of a quasi-finite ring map is quasi-finite. \n\n\n\n\n    \n",Proof.\n      Let $\\mathfrak p\' \\subset R\'$ be a prime lying over $\\mathfrak p \\subset R$. Then the fibre ring $S\' \\otimes _{R\'} \\kappa (\\mathfrak p\')$ is the base change of the fibre ring $S \\otimes _ R \\kappa (\\mathfrak p)$ by the field extension $\\kappa (\\mathfrak p) \\to \\kappa (\\mathfrak p\')$. Hence the first assertion follows from the invariance of dimension under field extension (Lemma 10.116.6) and Lemma 10.122.1. The stability of quasi-finite maps under base change follows from this and the stability of finite type property under base change. The second assertion follows since the assumption implies that given a prime $\\mathfrak q \\subset S$ we can find a prime $\\mathfrak q\' \\subset S\'$ lying over it. \n      $\\square$\n    \n," by
  refine âŸ¨fun P hP â†¦ ?_âŸ©
  let p := P.under R
  let e : P.Fiber (A âŠ—[R] S) â‰ƒâ‚[P.ResidueField] P.ResidueField âŠ—[p.ResidueField] (p.Fiber S) :=
    (Algebra.TensorProduct.cancelBaseChange _ _ _ _ _).trans
      (Algebra.TensorProduct.cancelBaseChange _ _ _ _ _).symm
  exact .of_surjective e.symm.toLinearMap e.symm.surjective
","instance baseChange [QuasiFinite R S] {A : Type*} [CommRing A] [Algebra R A] :
    QuasiFinite A (A âŠ—[R] S) ","Proof.\n      Let $\\mathfrak p\' \\subset R\'$ be a prime lying over $\\mathfrak p \\subset R$. Then the fibre ring $S\' \\otimes _{R\'} \\kappa (\\mathfrak p\')$ is the base change of the fibre ring $S \\otimes _ R \\kappa (\\mathfrak p)$ by the field extension $\\kappa (\\mathfrak p) \\to \\kappa (\\mathfrak p\')$. Hence the first assertion follows from the invariance of dimension under field extension (Lemma 10.116.6 [[\n  Lemma 10.116.6. Let $k$ be a field. Let $S$ be a finite type $k$-algebra. Set $X = \\mathop{\\mathrm{Spec}}(S)$. Let $K/k$ be a field extension. Set $S_ K = K \\otimes _ k S$, and $X_ K = \\mathop{\\mathrm{Spec}}(S_ K)$. Let $\\mathfrak q \\subset S$ be a prime corresponding to $x \\in X$ and let $\\mathfrak q_ K \\subset S_ K$ be a prime corresponding to $x_ K \\in X_ K$ lying over $\\mathfrak q$. Then $\\dim _ x X = \\dim _{x_ K} X_ K$. \n\n    \n]]) and Lemma 10.122.1 [[\n  Lemma 10.122.1. Let $k$ be a field. Let $S$ be a finite type $k$-algebra. Let $\\mathfrak q$ be a prime of $S$. The following are equivalent: \n  \n  \n$\\mathfrak q$ is an isolated point of $\\mathop{\\mathrm{Spec}}(S)$, \n\n\n$S_{\\mathfrak q}$ is finite over $k$, \n\n\nthere exists a $g \\in S$, $g \\not\\in \\mathfrak q$ such that $D(g) = \\{  \\mathfrak q \\} $, \n\n\n$\\dim _{\\mathfrak q} \\mathop{\\mathrm{Spec}}(S) = 0$, \n\n\n$\\mathfrak q$ is a closed point of $\\mathop{\\mathrm{Spec}}(S)$ and $\\dim (S_{\\mathfrak q}) = 0$, and \n\n\nthe field extension $\\kappa (\\mathfrak q)/k$ is finite and $\\dim (S_{\\mathfrak q}) = 0$. \n\n\n\n   In this case $S = S_{\\mathfrak q} \\times S\'$ for some finite type $k$-algebra $S\'$. Also, the element $g$ as in (3) has the property $S_{\\mathfrak q} = S_ g$. \n\n    \n]]. The stability of quasi-finite maps under base change follows from this and the stability of finite type property under base change. The second assertion follows since the assumption implies that given a prime $\\mathfrak q \\subset S$ we can find a prime $\\mathfrak q\' \\subset S\'$ lying over it. \n      $\\square$\n    \n"
325,00PO,"lemma trans [QuasiFinite R S] [QuasiFinite S T] : QuasiFinite R T := by
  refine âŸ¨fun P hP â†¦ ?_âŸ©
  have : Module.Finite (P.Fiber S) ((P.Fiber S) âŠ—[S] T) :=
    iff_of_isArtinianRing.mp inferInstance
  have : Module.Finite P.ResidueField ((P.Fiber S) âŠ—[S] T) :=
    .trans (P.Fiber S) _
  let e : P.Fiber S â‰ƒâ‚[S] S âŠ—[R] P.ResidueField :=
    { __ := Algebra.TensorProduct.comm _ _ _, commutes' _ := rfl }
  let e' : (P.Fiber S) âŠ—[S] T â‰ƒâ‚[R] P.Fiber T :=
    ((Algebra.TensorProduct.congr e .refl).restrictScalars R).trans <|
    ((Algebra.TensorProduct.comm _ _ _).restrictScalars R).trans <|
    ((Algebra.TensorProduct.cancelBaseChange _ _ T _ _).restrictScalars R).trans
    (Algebra.TensorProduct.comm _ _ _)
  let e'' : (P.Fiber S) âŠ—[S] T â‰ƒâ‚[P.ResidueField] P.Fiber T :=
    { __ := e', commutes' _ := by simp [e', e] }
  exact .of_surjective e''.toLinearMap e''.surjective
",Formal Proof of Stacks Project Tag 00PO,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/QuasiFinite/Basic.lean#L161-L176,Q27041,,10.122.8,lemma,3.0,"['02MK', '00AO', '0ELQ']","\n  Lemma 10.122.8. A composition of quasi-finite ring maps is quasi-finite. \n\n    \n      Proof.\n      Suppose $A \\to B$ and $B \\to C$ are quasi-finite ring maps. By Lemma 10.6.2 we see that $A \\to C$ is of finite type. Let $\\mathfrak r \\subset C$ be a prime of $C$ lying over $\\mathfrak q \\subset B$ and $\\mathfrak p \\subset A$. Since $A \\to B$ and $B \\to C$ are quasi-finite at $\\mathfrak q$ and $\\mathfrak r$ respectively, then there exist $b \\in B$ and $c \\in C$ such that $\\mathfrak q$ is the only prime of $D(b)$ which maps to $\\mathfrak p$ and similarly $\\mathfrak r$ is the only prime of $D(c)$ which maps to $\\mathfrak q$. If $c\' \\in C$ is the image of $b \\in B$, then $\\mathfrak r$ is the only prime of $D(cc\')$ which maps to $\\mathfrak p$. Therefore $A \\to C$ is quasi-finite at $\\mathfrak r$. \n      $\\square$\n    \n",\n  Lemma 10.122.8. A composition of quasi-finite ring maps is quasi-finite. \n\n    \n,"Proof.\n      Suppose $A \\to B$ and $B \\to C$ are quasi-finite ring maps. By Lemma 10.6.2 we see that $A \\to C$ is of finite type. Let $\\mathfrak r \\subset C$ be a prime of $C$ lying over $\\mathfrak q \\subset B$ and $\\mathfrak p \\subset A$. Since $A \\to B$ and $B \\to C$ are quasi-finite at $\\mathfrak q$ and $\\mathfrak r$ respectively, then there exist $b \\in B$ and $c \\in C$ such that $\\mathfrak q$ is the only prime of $D(b)$ which maps to $\\mathfrak p$ and similarly $\\mathfrak r$ is the only prime of $D(c)$ which maps to $\\mathfrak q$. If $c\' \\in C$ is the image of $b \\in B$, then $\\mathfrak r$ is the only prime of $D(cc\')$ which maps to $\\mathfrak p$. Therefore $A \\to C$ is quasi-finite at $\\mathfrak r$. \n      $\\square$\n    \n"," by
  refine âŸ¨fun P hP â†¦ ?_âŸ©
  have : Module.Finite (P.Fiber S) ((P.Fiber S) âŠ—[S] T) :=
    iff_of_isArtinianRing.mp inferInstance
  have : Module.Finite P.ResidueField ((P.Fiber S) âŠ—[S] T) :=
    .trans (P.Fiber S) _
  let e : P.Fiber S â‰ƒâ‚[S] S âŠ—[R] P.ResidueField :=
    { __ := Algebra.TensorProduct.comm _ _ _, commutes' _ := rfl }
  let e' : (P.Fiber S) âŠ—[S] T â‰ƒâ‚[R] P.Fiber T :=
    ((Algebra.TensorProduct.congr e .refl).restrictScalars R).trans <|
    ((Algebra.TensorProduct.comm _ _ _).restrictScalars R).trans <|
    ((Algebra.TensorProduct.cancelBaseChange _ _ T _ _).restrictScalars R).trans
    (Algebra.TensorProduct.comm _ _ _)
  let e'' : (P.Fiber S) âŠ—[S] T â‰ƒâ‚[P.ResidueField] P.Fiber T :=
    { __ := e', commutes' _ := by simp [e', e] }
  exact .of_surjective e''.toLinearMap e''.surjective
",lemma trans [QuasiFinite R S] [QuasiFinite S T] : QuasiFinite R T ,"Proof.\n      Suppose $A \\to B$ and $B \\to C$ are quasi-finite ring maps. By Lemma 10.6.2 [[\n  Lemma 10.6.2. The notions finite type and finite presentation have the following permanence properties. \n  \n  \nA composition of ring maps of finite type is of finite type. \n\n\nA composition of ring maps of finite presentation is of finite presentation. \n\n\nGiven $R \\to S\' \\to S$ with $R \\to S$ of finite type, then $S\' \\to S$ is of finite type. \n\n\nGiven $R \\to S\' \\to S$, with $R \\to S$ of finite presentation, and $R \\to S\'$ of finite type, then $S\' \\to S$ is of finite presentation. \n\n\n\n\n    \n]] we see that $A \\to C$ is of finite type. Let $\\mathfrak r \\subset C$ be a prime of $C$ lying over $\\mathfrak q \\subset B$ and $\\mathfrak p \\subset A$. Since $A \\to B$ and $B \\to C$ are quasi-finite at $\\mathfrak q$ and $\\mathfrak r$ respectively, then there exist $b \\in B$ and $c \\in C$ such that $\\mathfrak q$ is the only prime of $D(b)$ which maps to $\\mathfrak p$ and similarly $\\mathfrak r$ is the only prime of $D(c)$ which maps to $\\mathfrak q$. If $c\' \\in C$ is the image of $b \\in B$, then $\\mathfrak r$ is the only prime of $D(cc\')$ which maps to $\\mathfrak p$. Therefore $A \\to C$ is quasi-finite at $\\mathfrak r$. \n      $\\square$\n    \n"
326,00HB,"def FaithfullyFlat {R S : Type*} [CommRing R] [CommRing S] (f : R â†’+* S) : Prop :=
  letI : Algebra R S := f.toAlgebra
  Module.FaithfullyFlat R S
",Formal Proof of Stacks Project Tag 00HB,"Part (4), algebraize Module.FaithfullyFlat",https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/RingHom/FaithfullyFlat.lean#L25-L27,Q27041,,10.39.1,definition,3.0,"['00H9', '00AO', '0ELQ']",\n  Definition 10.39.1. Let $R$ be a ring. \n  \n  \nAn $R$-module $M$ is called flat if whenever $N_1 \\to N_2 \\to N_3$ is an exact sequence of $R$-modules the sequence $M \\otimes _ R N_1 \\to M \\otimes _ R N_2 \\to M \\otimes _ R N_3$ is exact as well. \n\n\nAn $R$-module $M$ is called faithfully flat if the complex of $R$-modules $N_1 \\to N_2 \\to N_3$ is exact if and only if the sequence $M \\otimes _ R N_1 \\to M \\otimes _ R N_2 \\to M \\otimes _ R N_3$ is exact. \n\n\nA ring map $R \\to S$ is called flat if $S$ is flat as an $R$-module. \n\n\nA ring map $R \\to S$ is called faithfully flat if $S$ is faithfully flat as an $R$-module. \n\n\n\n,\n  Definition 10.39.1. Let $R$ be a ring. \n  \n  \nAn $R$-module $M$ is called flat if whenever $N_1 \\to N_2 \\to N_3$ is an exact sequence of $R$-modules the sequence $M \\otimes _ R N_1 \\to M \\otimes _ R N_2 \\to M \\otimes _ R N_3$ is exact as well. \n\n\nAn $R$-module $M$ is called faithfully flat if the complex of $R$-modules $N_1 \\to N_2 \\to N_3$ is exact if and only if the sequence $M \\otimes _ R N_1 \\to M \\otimes _ R N_2 \\to M \\otimes _ R N_3$ is exact. \n\n\nA ring map $R \\to S$ is called flat if $S$ is flat as an $R$-module. \n\n\nA ring map $R \\to S$ is called faithfully flat if $S$ is faithfully flat as an $R$-module. \n\n\n\n,,"
  letI : Algebra R S := f.toAlgebra
  Module.FaithfullyFlat R S
",def FaithfullyFlat {R S : Type*} [CommRing R] [CommRing S] (f : R â†’+* S) : Prop ,
327,00TI,"class FormallySmooth : Prop where
  projective_kaehlerDifferential : Module.Projective A Î©[Aâ„R]
  subsingleton_h1Cotangent : Subsingleton (H1Cotangent R A)
",Formal Proof of Stacks Project Tag 00TI,"Also see 031J (6) for the equivalence with the definition given here., mk_iff",https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Smooth/Basic.lean#L70-L72,Q27041,,10.138.1,definition,3.0,"['00TH', '00AO', '0ELQ']","\n  Definition 10.138.1. Let $R \\to S$ be a ring map. We say $S$ is formally smooth over $R$ if for every commutative solid diagram \n  \n  \\[  \\xymatrix{ S \\ar[r] \\ar@{-->}[rd] &  A/I \\\\  R \\ar[r] \\ar[u] &  A \\ar[u] }  \\]\n\n   where $I \\subset A$ is an ideal of square zero, a dotted arrow exists which makes the diagram commute. \n","\n  Definition 10.138.1. Let $R \\to S$ be a ring map. We say $S$ is formally smooth over $R$ if for every commutative solid diagram \n  \n  \\[  \\xymatrix{ S \\ar[r] \\ar@{-->}[rd] &  A/I \\\\  R \\ar[r] \\ar[u] &  A \\ar[u] }  \\]\n\n   where $I \\subset A$ is an ideal of square zero, a dotted arrow exists which makes the diagram commute. \n",,,"class FormallySmooth : Prop where
  projective_kaehlerDifferential : Module.Projective A Î©[Aâ„R]
  subsingleton_h1Cotangent : Subsingleton (H1Cotangent R A)
",
328,031I,"theorem _root_.Algebra.Extension.formallySmooth_iff_split_injection
    (P : Algebra.Extension.{w} R A) [FormallySmooth R P.Ring] :
    Algebra.FormallySmooth R A â†” âˆƒ l, l âˆ˜â‚— P.cotangentComplex = LinearMap.id := by
  refine (Algebra.FormallySmooth.iff_split_injection P.algebraMap_surjective).trans ?_
  let e : P.ker.Cotangent â‰ƒâ‚—[P.Ring] P.Cotangent :=
    { __ := AddEquiv.refl _, map_smul' r m := by ext1; simp; rfl }
  constructor
  Â· intro âŸ¨l, hlâŸ©
    exact âŸ¨(e.comp l).extendScalarsOfSurjective P.algebraMap_surjective,
      LinearMap.ext (DFunLike.congr_fun hl : _)âŸ©
  Â· intro âŸ¨l, hlâŸ©
    exact âŸ¨e.symm.toLinearMap âˆ˜â‚— l.restrictScalars P.Ring,
      LinearMap.ext (DFunLike.congr_fun hl : _)âŸ©
",Formal Proof of Stacks Project Tag 031I,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Smooth/Basic.lean#L306-L318,Q27041,,10.138.7,lemma,3.0,"['00TH', '00AO', '0ELQ']","\n  Lemma 10.138.7. Let $R \\to S$ be a ring map. Let $P \\to S$ be a surjective $R$-algebra map from a polynomial ring $P$ onto $S$. Denote $J \\subset P$ the kernel. Then $R \\to S$ is formally smooth if and only if the sequence \n  \n  \\[  0 \\to J/J^2 \\to \\Omega _{P/R} \\otimes _ P S \\to \\Omega _{S/R} \\to 0  \\]\n\n   of Lemma 10.131.9 is a split exact sequence. \n\n    \n      Proof.\n      Assume $S$ is formally smooth over $R$. By Lemma 10.138.5 this means there exists an $R$-algebra map $S \\to P/J^2$ which is a right inverse to the canonical map $P/J^2 \\to S$. By Lemma 10.131.11 we have $\\Omega _{P/R} \\otimes _ P S = \\Omega _{(P/J^2)/R} \\otimes _{P/J^2} S$. By Lemma 10.131.10 the sequence is split. \n    \n      Assume the exact sequence of the lemma is split exact. Choose a splitting $\\sigma : \\Omega _{S/R} \\to \\Omega _{P/R} \\otimes _ P S$. For each $\\lambda \\in S$ choose $x_\\lambda \\in P$ which maps to $\\lambda $. Next, for each $\\lambda \\in S$ choose $f_\\lambda \\in J$ such that \n    \n      \n  \\[  \\text{d}f_\\lambda = \\text{d}x_\\lambda - \\sigma (\\text{d}\\lambda )  \\]\n\n    \n       in the middle term of the exact sequence. We claim that $s : \\lambda \\mapsto x_\\lambda - f_\\lambda \\mod J^2$ is an $R$-algebra homomorphism $s : S \\to P/J^2$. To prove this we will repeatedly use that if $h \\in J$ and $\\text{d}h = 0$ in $\\Omega _{P/R} \\otimes _ R S$, then $h \\in J^2$. Let $\\lambda , \\mu \\in S$. Then $\\sigma (\\text{d}\\lambda + \\text{d}\\mu - \\text{d}(\\lambda + \\mu )) = 0$. This implies \n    \n      \n  \\[  \\text{d}(x_\\lambda + x_\\mu - x_{\\lambda + \\mu } - f_\\lambda - f_\\mu + f_{\\lambda + \\mu }) = 0  \\]\n\n    \n       which means that $x_\\lambda + x_\\mu - x_{\\lambda + \\mu } - f_\\lambda - f_\\mu + f_{\\lambda + \\mu } \\in J^2$, which in turn means that $s(\\lambda ) + s(\\mu ) = s(\\lambda + \\mu )$. Similarly, we have $\\sigma (\\lambda \\text{d}\\mu + \\mu \\text{d}\\lambda - \\text{d}\\lambda \\mu ) = 0$ which implies that \n    \n      \n  \\[  \\mu (\\text{d}x_\\lambda - \\text{d}f_\\lambda ) + \\lambda (\\text{d}x_\\mu - \\text{d}f_\\mu ) - \\text{d}x_{\\lambda \\mu } + \\text{d}f_{\\lambda \\mu } = 0  \\]\n\n    \n       in the middle term of the exact sequence. Moreover we have \n    \n      \n  \\[  \\text{d}(x_\\lambda x_\\mu ) = x_\\lambda \\text{d}x_\\mu + x_\\mu \\text{d}x_\\lambda = \\lambda \\text{d}x_\\mu + \\mu \\text{d} x_\\lambda  \\]\n\n    \n       in the middle term again. Combined these equations mean that $x_\\lambda x_\\mu - x_{\\lambda \\mu } - \\mu f_\\lambda - \\lambda f_\\mu + f_{\\lambda \\mu } \\in J^2$, hence $(x_\\lambda - f_\\lambda )(x_\\mu - f_\\mu ) - (x_{\\lambda \\mu } - f_{\\lambda \\mu }) \\in J^2$ as $f_\\lambda f_\\mu \\in J^2$, which means that $s(\\lambda )s(\\mu ) = s(\\lambda \\mu )$. If $\\lambda \\in R$, then $\\text{d}\\lambda = 0$ and we see that $\\text{d}f_\\lambda = \\text{d}x_\\lambda $, hence $\\lambda - x_\\lambda + f_\\lambda \\in J^2$ and hence $s(\\lambda ) = \\lambda $ as desired. At this point we can apply Lemma 10.138.5 to conclude that $S/R$ is formally smooth. \n      $\\square$\n    \n",\n  Lemma 10.138.7. Let $R \\to S$ be a ring map. Let $P \\to S$ be a surjective $R$-algebra map from a polynomial ring $P$ onto $S$. Denote $J \\subset P$ the kernel. Then $R \\to S$ is formally smooth if and only if the sequence \n  \n  \\[  0 \\to J/J^2 \\to \\Omega _{P/R} \\otimes _ P S \\to \\Omega _{S/R} \\to 0  \\]\n\n   of Lemma 10.131.9 is a split exact sequence. \n\n    \n,"Proof.\n      Assume $S$ is formally smooth over $R$. By Lemma 10.138.5 this means there exists an $R$-algebra map $S \\to P/J^2$ which is a right inverse to the canonical map $P/J^2 \\to S$. By Lemma 10.131.11 we have $\\Omega _{P/R} \\otimes _ P S = \\Omega _{(P/J^2)/R} \\otimes _{P/J^2} S$. By Lemma 10.131.10 the sequence is split. \n    \n      Assume the exact sequence of the lemma is split exact. Choose a splitting $\\sigma : \\Omega _{S/R} \\to \\Omega _{P/R} \\otimes _ P S$. For each $\\lambda \\in S$ choose $x_\\lambda \\in P$ which maps to $\\lambda $. Next, for each $\\lambda \\in S$ choose $f_\\lambda \\in J$ such that \n    \n      \n  \\[  \\text{d}f_\\lambda = \\text{d}x_\\lambda - \\sigma (\\text{d}\\lambda )  \\]\n\n    \n       in the middle term of the exact sequence. We claim that $s : \\lambda \\mapsto x_\\lambda - f_\\lambda \\mod J^2$ is an $R$-algebra homomorphism $s : S \\to P/J^2$. To prove this we will repeatedly use that if $h \\in J$ and $\\text{d}h = 0$ in $\\Omega _{P/R} \\otimes _ R S$, then $h \\in J^2$. Let $\\lambda , \\mu \\in S$. Then $\\sigma (\\text{d}\\lambda + \\text{d}\\mu - \\text{d}(\\lambda + \\mu )) = 0$. This implies \n    \n      \n  \\[  \\text{d}(x_\\lambda + x_\\mu - x_{\\lambda + \\mu } - f_\\lambda - f_\\mu + f_{\\lambda + \\mu }) = 0  \\]\n\n    \n       which means that $x_\\lambda + x_\\mu - x_{\\lambda + \\mu } - f_\\lambda - f_\\mu + f_{\\lambda + \\mu } \\in J^2$, which in turn means that $s(\\lambda ) + s(\\mu ) = s(\\lambda + \\mu )$. Similarly, we have $\\sigma (\\lambda \\text{d}\\mu + \\mu \\text{d}\\lambda - \\text{d}\\lambda \\mu ) = 0$ which implies that \n    \n      \n  \\[  \\mu (\\text{d}x_\\lambda - \\text{d}f_\\lambda ) + \\lambda (\\text{d}x_\\mu - \\text{d}f_\\mu ) - \\text{d}x_{\\lambda \\mu } + \\text{d}f_{\\lambda \\mu } = 0  \\]\n\n    \n       in the middle term of the exact sequence. Moreover we have \n    \n      \n  \\[  \\text{d}(x_\\lambda x_\\mu ) = x_\\lambda \\text{d}x_\\mu + x_\\mu \\text{d}x_\\lambda = \\lambda \\text{d}x_\\mu + \\mu \\text{d} x_\\lambda  \\]\n\n    \n       in the middle term again. Combined these equations mean that $x_\\lambda x_\\mu - x_{\\lambda \\mu } - \\mu f_\\lambda - \\lambda f_\\mu + f_{\\lambda \\mu } \\in J^2$, hence $(x_\\lambda - f_\\lambda )(x_\\mu - f_\\mu ) - (x_{\\lambda \\mu } - f_{\\lambda \\mu }) \\in J^2$ as $f_\\lambda f_\\mu \\in J^2$, which means that $s(\\lambda )s(\\mu ) = s(\\lambda \\mu )$. If $\\lambda \\in R$, then $\\text{d}\\lambda = 0$ and we see that $\\text{d}f_\\lambda = \\text{d}x_\\lambda $, hence $\\lambda - x_\\lambda + f_\\lambda \\in J^2$ and hence $s(\\lambda ) = \\lambda $ as desired. At this point we can apply Lemma 10.138.5 to conclude that $S/R$ is formally smooth. \n      $\\square$\n    \n"," by
  refine (Algebra.FormallySmooth.iff_split_injection P.algebraMap_surjective).trans ?_
  let e : P.ker.Cotangent â‰ƒâ‚—[P.Ring] P.Cotangent :=
    { __ := AddEquiv.refl _, map_smul' r m := by ext1; simp; rfl }
  constructor
  Â· intro âŸ¨l, hlâŸ©
    exact âŸ¨(e.comp l).extendScalarsOfSurjective P.algebraMap_surjective,
      LinearMap.ext (DFunLike.congr_fun hl : _)âŸ©
  Â· intro âŸ¨l, hlâŸ©
    exact âŸ¨e.symm.toLinearMap âˆ˜â‚— l.restrictScalars P.Ring,
      LinearMap.ext (DFunLike.congr_fun hl : _)âŸ©
","theorem _root_.Algebra.Extension.formallySmooth_iff_split_injection
    (P : Algebra.Extension.{w} R A) [FormallySmooth R P.Ring] :
    Algebra.FormallySmooth R A â†” âˆƒ l, l âˆ˜â‚— P.cotangentComplex = LinearMap.id ","Proof.\n      Assume $S$ is formally smooth over $R$. By Lemma 10.138.5 [[\n  Lemma 10.138.5. Let $R \\to S$ be a ring map. Let $P \\to S$ be a surjective $R$-algebra map from a polynomial ring $P$ onto $S$. Denote $J \\subset P$ the kernel. Then $R \\to S$ is formally smooth if and only if there exists an $R$-algebra map $\\sigma : S \\to P/J^2$ which is a right inverse to the surjection $P/J^2 \\to S$. \n\n    \n]] this means there exists an $R$-algebra map $S \\to P/J^2$ which is a right inverse to the canonical map $P/J^2 \\to S$. By Lemma 10.131.11 [[\n  Lemma 10.131.11. Let $R \\to S$ be a ring map. Let $I \\subset S$ be an ideal. Let $n \\geq 1$ be an integer. Set $S\' = S/I^{n + 1}$. The map $\\Omega _{S/R} \\to \\Omega _{S\'/R}$ induces an isomorphism \n  \n  \\[  \\Omega _{S/R} \\otimes _ S S/I^ n \\longrightarrow \\Omega _{S\'/R} \\otimes _{S\'} S/I^ n.  \\]\n\n\n    \n]] we have $\\Omega _{P/R} \\otimes _ P S = \\Omega _{(P/J^2)/R} \\otimes _{P/J^2} S$. By Lemma 10.131.10 [[\n  Lemma 10.131.10. In diagram (10.131.4.1), suppose that $S \\to S\'$ is surjective with kernel $I \\subset S$, and assume that $R\' = R$. Moreover, assume that there exists an $R$-algebra map $S\' \\to S$ which is a right inverse to $S \\to S\'$. Then the exact sequence of $S\'$-modules of Lemma 10.131.9 turns into a short exact sequence \n  \n  \\[  0 \\longrightarrow I/I^2 \\longrightarrow \\Omega _{S/R} \\otimes _ S S\' \\longrightarrow \\Omega _{S\'/R} \\longrightarrow 0  \\]\n\n   which is even a split short exact sequence. \n\n    \n]] the sequence is split. \n    \n      Assume the exact sequence of the lemma is split exact. Choose a splitting $\\sigma : \\Omega _{S/R} \\to \\Omega _{P/R} \\otimes _ P S$. For each $\\lambda \\in S$ choose $x_\\lambda \\in P$ which maps to $\\lambda $. Next, for each $\\lambda \\in S$ choose $f_\\lambda \\in J$ such that \n    \n      \n  \\[  \\text{d}f_\\lambda = \\text{d}x_\\lambda - \\sigma (\\text{d}\\lambda )  \\]\n\n    \n       in the middle term of the exact sequence. We claim that $s : \\lambda \\mapsto x_\\lambda - f_\\lambda \\mod J^2$ is an $R$-algebra homomorphism $s : S \\to P/J^2$. To prove this we will repeatedly use that if $h \\in J$ and $\\text{d}h = 0$ in $\\Omega _{P/R} \\otimes _ R S$, then $h \\in J^2$. Let $\\lambda , \\mu \\in S$. Then $\\sigma (\\text{d}\\lambda + \\text{d}\\mu - \\text{d}(\\lambda + \\mu )) = 0$. This implies \n    \n      \n  \\[  \\text{d}(x_\\lambda + x_\\mu - x_{\\lambda + \\mu } - f_\\lambda - f_\\mu + f_{\\lambda + \\mu }) = 0  \\]\n\n    \n       which means that $x_\\lambda + x_\\mu - x_{\\lambda + \\mu } - f_\\lambda - f_\\mu + f_{\\lambda + \\mu } \\in J^2$, which in turn means that $s(\\lambda ) + s(\\mu ) = s(\\lambda + \\mu )$. Similarly, we have $\\sigma (\\lambda \\text{d}\\mu + \\mu \\text{d}\\lambda - \\text{d}\\lambda \\mu ) = 0$ which implies that \n    \n      \n  \\[  \\mu (\\text{d}x_\\lambda - \\text{d}f_\\lambda ) + \\lambda (\\text{d}x_\\mu - \\text{d}f_\\mu ) - \\text{d}x_{\\lambda \\mu } + \\text{d}f_{\\lambda \\mu } = 0  \\]\n\n    \n       in the middle term of the exact sequence. Moreover we have \n    \n      \n  \\[  \\text{d}(x_\\lambda x_\\mu ) = x_\\lambda \\text{d}x_\\mu + x_\\mu \\text{d}x_\\lambda = \\lambda \\text{d}x_\\mu + \\mu \\text{d} x_\\lambda  \\]\n\n    \n       in the middle term again. Combined these equations mean that $x_\\lambda x_\\mu - x_{\\lambda \\mu } - \\mu f_\\lambda - \\lambda f_\\mu + f_{\\lambda \\mu } \\in J^2$, hence $(x_\\lambda - f_\\lambda )(x_\\mu - f_\\mu ) - (x_{\\lambda \\mu } - f_{\\lambda \\mu }) \\in J^2$ as $f_\\lambda f_\\mu \\in J^2$, which means that $s(\\lambda )s(\\mu ) = s(\\lambda \\mu )$. If $\\lambda \\in R$, then $\\text{d}\\lambda = 0$ and we see that $\\text{d}f_\\lambda = \\text{d}x_\\lambda $, hence $\\lambda - x_\\lambda + f_\\lambda \\in J^2$ and hence $s(\\lambda ) = \\lambda $ as desired. At this point we can apply Lemma 10.138.5 [[\n  Lemma 10.138.5. Let $R \\to S$ be a ring map. Let $P \\to S$ be a surjective $R$-algebra map from a polynomial ring $P$ onto $S$. Denote $J \\subset P$ the kernel. Then $R \\to S$ is formally smooth if and only if there exists an $R$-algebra map $\\sigma : S \\to P/J^2$ which is a right inverse to the surjection $P/J^2 \\to S$. \n\n    \n]] to conclude that $S/R$ is formally smooth. \n      $\\square$\n    \n"
329,00T2,"<https://stacks.math.columbia.edu/tag/00TN> proves that their definition is equivalent to this."",
mk_iff]
class Smooth [CommRing R] (A : Type u) [CommRing A] [Algebra R A] : Prop where
  formallySmooth : FormallySmooth R A := by infer_instance
  finitePresentation : FinitePresentation R A := by infer_instance
",Formal Proof of Stacks Project Tag 00T2,"In the stacks project, the definition of smooth is completely different, and ta",https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Smooth/Basic.lean#L530-L534,Q27041,,10.137.1,definition,3.0,"['00T1', '00AO', '0ELQ']",\n  Definition 10.137.1. A ring map $R \\to S$ is smooth if it is of finite presentation and the naive cotangent complex $\\mathop{N\\! L}\\nolimits _{S/R}$ is quasi-isomorphic to a finite projective $S$-module placed in degree $0$: this means that $H_1(\\mathop{N\\! L}\\nolimits _{S/R}) = 0$ and that $\\Omega _{S/R}$ is a finite projective $S$-module. \n,\n  Definition 10.137.1. A ring map $R \\to S$ is smooth if it is of finite presentation and the naive cotangent complex $\\mathop{N\\! L}\\nolimits _{S/R}$ is quasi-isomorphic to a finite projective $S$-module placed in degree $0$: this means that $H_1(\\mathop{N\\! L}\\nolimits _{S/R}) = 0$ and that $\\Omega _{S/R}$ is a finite projective $S$-module. \n,," by infer_instance
  finitePresentation : FinitePresentation R A := by infer_instance
","<https://stacks.math.columbia.edu/tag/00TN> proves that their definition is equivalent to this."",
mk_iff]
class Smooth [CommRing R] (A : Type u) [CommRing A] [Algebra R A] : Prop where
  formallySmooth : FormallySmooth R A ",
330,00TB,"abbrev IsSmoothAt (p : Ideal A) [p.IsPrime] : Prop :=
  Algebra.FormallySmooth R (Localization.AtPrime p)
",Formal Proof of Stacks Project Tag 00TB,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Smooth/Locus.lean#L46-L47,Q27041,,10.137.10,definition,3.0,"['00T1', '00AO', '0ELQ']","\n  Definition 10.137.10. Let $R \\to S$ be a ring map. Let $\\mathfrak q$ be a prime of $S$. We say $R \\to S$ is smooth at $\\mathfrak q$ if there exists a $g \\in S$, $g \\not\\in \\mathfrak q$ such that $R \\to S_ g$ is smooth. \n","\n  Definition 10.137.10. Let $R \\to S$ be a ring map. Let $\\mathfrak q$ be a prime of $S$. We say $R \\to S$ is smooth at $\\mathfrak q$ if there exists a $g \\in S$, $g \\not\\in \\mathfrak q$ such that $R \\to S_ g$ is smooth. \n",,"
  Algebra.FormallySmooth R (Localization.AtPrime p)
",abbrev IsSmoothAt (p : Ideal A) [p.IsPrime] : Prop ,
331,00TP,"public theorem exists_finiteType [Smooth A B] :
    âˆƒ (Aâ‚€ : Type u) (Bâ‚€ : Type u) (_ : CommRing Aâ‚€) (_ : CommRing Bâ‚€)
      (_ : Algebra R Aâ‚€) (_ : Algebra Aâ‚€ A) (_ : Algebra Aâ‚€ Bâ‚€),
      Function.Injective (algebraMap Aâ‚€ A) âˆ§ FiniteType R Aâ‚€ âˆ§ Smooth Aâ‚€ Bâ‚€ âˆ§
      Nonempty (B â‰ƒâ‚[A] A âŠ—[Aâ‚€] Bâ‚€) := by
  obtain âŸ¨Aâ‚€, Bâ‚€, _, _, hAâ‚€, _, _âŸ© := exists_subalgebra_fg R A B
  use Aâ‚€, Bâ‚€, inferInstance, inferInstance, inferInstance, inferInstance, inferInstance,
    Subtype.val_injective, âŸ¨Aâ‚€.fg_top.mpr hAâ‚€âŸ©, inferInstance
",Formal Proof of Stacks Project Tag 00TP,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Smooth/NoetherianDescent.lean#L218-L225,Q27041,,10.138.14,lemma,3.0,"['00TH', '00AO', '0ELQ']","\n  Lemma 10.138.14. Let $R \\to S$ be a smooth ring map. Then there exists a subring $R_0 \\subset R$ of finite type over $\\mathbf{Z}$ and a smooth ring map $R_0 \\to S_0$ such that $S \\cong R \\otimes _{R_0} S_0$. \n\n    \n      Proof.\n      We are going to use that smooth is equivalent to finite presentation and formally smooth, see Proposition 10.138.13. Write $S = R[x_1, \\ldots , x_ n]/(f_1, \\ldots , f_ m)$ and denote $I = (f_1, \\ldots , f_ m)$. Choose a right inverse $\\sigma : S \\to R[x_1, \\ldots , x_ n]/I^2$ to the projection to $S$ as in Lemma 10.138.5. Choose $h_ i \\in R[x_1, \\ldots , x_ n]$ such that $\\sigma (x_ i \\bmod I) = h_ i \\bmod I^2$. Since $x_ i - h_ i \\in I$, there exist $b_{ij} \\in R[x_1, \\ldots , x_ n]$ such that \n    \n      \n  \\[  x_ i - h_ i = \\sum \\nolimits _ j b_{ij} f_ j  \\]\n\n    \n       The fact that $\\sigma $ is an $R$-algebra homomorphism $R[x_1, \\ldots , x_ n]/I \\to R[x_1, \\ldots , x_ n]/I^2$ is equivalent to the condition that \n    \n      \n  \\[  f_ j(h_1, \\ldots , h_ n) = \\sum \\nolimits _{j_1 j_2} a_{j_1 j_2} f_{j_1} f_{j_2}  \\]\n\n    \n       for certain $a_{kl} \\in R[x_1, \\ldots , x_ n]$. Let $R_0 \\subset R$ be the subring generated over $\\mathbf{Z}$ by all the coefficients of the polynomials $f_ j, h_ i, a_{kl}, b_{ij}$. Set $S_0 = R_0[x_1, \\ldots , x_ n]/(f_1, \\ldots , f_ m)$, with $I_0 = (f_1, \\ldots , f_ m)$. Since the second displayed equation holds in $R_0[x_1, \\ldots , x_ n]$ we can let $\\sigma _0 : S_0 \\to R_0[x_1, \\ldots , x_ n]/I_0^2$ be the $R_0$-algebra map defined by the rule $x_ i \\mapsto h_ i \\bmod I_0^2$. Since the first displayed equation holds in $R_0[x_1, \\ldots , x_ n]$ we see that $\\sigma _0$ is a right inverse to the projection $R_0[x_1, \\ldots , x_ n] / I_0^2 \\to R_0[x_1, \\ldots , x_ n] / I_0 = S_0$. Thus by Lemma 10.138.5 the ring $S_0$ is formally smooth over $R_0$. \n      $\\square$\n    \n",\n  Lemma 10.138.14. Let $R \\to S$ be a smooth ring map. Then there exists a subring $R_0 \\subset R$ of finite type over $\\mathbf{Z}$ and a smooth ring map $R_0 \\to S_0$ such that $S \\cong R \\otimes _{R_0} S_0$. \n\n    \n,"Proof.\n      We are going to use that smooth is equivalent to finite presentation and formally smooth, see Proposition 10.138.13. Write $S = R[x_1, \\ldots , x_ n]/(f_1, \\ldots , f_ m)$ and denote $I = (f_1, \\ldots , f_ m)$. Choose a right inverse $\\sigma : S \\to R[x_1, \\ldots , x_ n]/I^2$ to the projection to $S$ as in Lemma 10.138.5. Choose $h_ i \\in R[x_1, \\ldots , x_ n]$ such that $\\sigma (x_ i \\bmod I) = h_ i \\bmod I^2$. Since $x_ i - h_ i \\in I$, there exist $b_{ij} \\in R[x_1, \\ldots , x_ n]$ such that \n    \n      \n  \\[  x_ i - h_ i = \\sum \\nolimits _ j b_{ij} f_ j  \\]\n\n    \n       The fact that $\\sigma $ is an $R$-algebra homomorphism $R[x_1, \\ldots , x_ n]/I \\to R[x_1, \\ldots , x_ n]/I^2$ is equivalent to the condition that \n    \n      \n  \\[  f_ j(h_1, \\ldots , h_ n) = \\sum \\nolimits _{j_1 j_2} a_{j_1 j_2} f_{j_1} f_{j_2}  \\]\n\n    \n       for certain $a_{kl} \\in R[x_1, \\ldots , x_ n]$. Let $R_0 \\subset R$ be the subring generated over $\\mathbf{Z}$ by all the coefficients of the polynomials $f_ j, h_ i, a_{kl}, b_{ij}$. Set $S_0 = R_0[x_1, \\ldots , x_ n]/(f_1, \\ldots , f_ m)$, with $I_0 = (f_1, \\ldots , f_ m)$. Since the second displayed equation holds in $R_0[x_1, \\ldots , x_ n]$ we can let $\\sigma _0 : S_0 \\to R_0[x_1, \\ldots , x_ n]/I_0^2$ be the $R_0$-algebra map defined by the rule $x_ i \\mapsto h_ i \\bmod I_0^2$. Since the first displayed equation holds in $R_0[x_1, \\ldots , x_ n]$ we see that $\\sigma _0$ is a right inverse to the projection $R_0[x_1, \\ldots , x_ n] / I_0^2 \\to R_0[x_1, \\ldots , x_ n] / I_0 = S_0$. Thus by Lemma 10.138.5 the ring $S_0$ is formally smooth over $R_0$. \n      $\\square$\n    \n"," by
  obtain âŸ¨Aâ‚€, Bâ‚€, _, _, hAâ‚€, _, _âŸ© := exists_subalgebra_fg R A B
  use Aâ‚€, Bâ‚€, inferInstance, inferInstance, inferInstance, inferInstance, inferInstance,
    Subtype.val_injective, âŸ¨Aâ‚€.fg_top.mpr hAâ‚€âŸ©, inferInstance
","public theorem exists_finiteType [Smooth A B] :
    âˆƒ (Aâ‚€ : Type u) (Bâ‚€ : Type u) (_ : CommRing Aâ‚€) (_ : CommRing Bâ‚€)
      (_ : Algebra R Aâ‚€) (_ : Algebra Aâ‚€ A) (_ : Algebra Aâ‚€ Bâ‚€),
      Function.Injective (algebraMap Aâ‚€ A) âˆ§ FiniteType R Aâ‚€ âˆ§ Smooth Aâ‚€ Bâ‚€ âˆ§
      Nonempty (B â‰ƒâ‚[A] A âŠ—[Aâ‚€] Bâ‚€) ","Proof.\n      We are going to use that smooth is equivalent to finite presentation and formally smooth, see Proposition 10.138.13 [[\n  Proposition 10.138.13. Let $R \\to S$ be a ring map. The following are equivalent \n  \n  \n$R \\to S$ is of finite presentation and formally smooth, \n\n\n$R \\to S$ is smooth. \n\n\n\n\n    \n]]. Write $S = R[x_1, \\ldots , x_ n]/(f_1, \\ldots , f_ m)$ and denote $I = (f_1, \\ldots , f_ m)$. Choose a right inverse $\\sigma : S \\to R[x_1, \\ldots , x_ n]/I^2$ to the projection to $S$ as in Lemma 10.138.5 [[\n  Lemma 10.138.5. Let $R \\to S$ be a ring map. Let $P \\to S$ be a surjective $R$-algebra map from a polynomial ring $P$ onto $S$. Denote $J \\subset P$ the kernel. Then $R \\to S$ is formally smooth if and only if there exists an $R$-algebra map $\\sigma : S \\to P/J^2$ which is a right inverse to the surjection $P/J^2 \\to S$. \n\n    \n]]. Choose $h_ i \\in R[x_1, \\ldots , x_ n]$ such that $\\sigma (x_ i \\bmod I) = h_ i \\bmod I^2$. Since $x_ i - h_ i \\in I$, there exist $b_{ij} \\in R[x_1, \\ldots , x_ n]$ such that \n    \n      \n  \\[  x_ i - h_ i = \\sum \\nolimits _ j b_{ij} f_ j  \\]\n\n    \n       The fact that $\\sigma $ is an $R$-algebra homomorphism $R[x_1, \\ldots , x_ n]/I \\to R[x_1, \\ldots , x_ n]/I^2$ is equivalent to the condition that \n    \n      \n  \\[  f_ j(h_1, \\ldots , h_ n) = \\sum \\nolimits _{j_1 j_2} a_{j_1 j_2} f_{j_1} f_{j_2}  \\]\n\n    \n       for certain $a_{kl} \\in R[x_1, \\ldots , x_ n]$. Let $R_0 \\subset R$ be the subring generated over $\\mathbf{Z}$ by all the coefficients of the polynomials $f_ j, h_ i, a_{kl}, b_{ij}$. Set $S_0 = R_0[x_1, \\ldots , x_ n]/(f_1, \\ldots , f_ m)$, with $I_0 = (f_1, \\ldots , f_ m)$. Since the second displayed equation holds in $R_0[x_1, \\ldots , x_ n]$ we can let $\\sigma _0 : S_0 \\to R_0[x_1, \\ldots , x_ n]/I_0^2$ be the $R_0$-algebra map defined by the rule $x_ i \\mapsto h_ i \\bmod I_0^2$. Since the first displayed equation holds in $R_0[x_1, \\ldots , x_ n]$ we see that $\\sigma _0$ is a right inverse to the projection $R_0[x_1, \\ldots , x_ n] / I_0^2 \\to R_0[x_1, \\ldots , x_ n] / I_0 = S_0$. Thus by Lemma 10.138.5 [[\n  Lemma 10.138.5. Let $R \\to S$ be a ring map. Let $P \\to S$ be a surjective $R$-algebra map from a polynomial ring $P$ onto $S$. Denote $J \\subset P$ the kernel. Then $R \\to S$ is formally smooth if and only if there exists an $R$-algebra map $\\sigma : S \\to P/J^2$ which is a right inverse to the surjection $P/J^2 \\to S$. \n\n    \n]] the ring $S_0$ is formally smooth over $R_0$. \n      $\\square$\n    \n"
332,00U2,"public theorem _root_.Algebra.Etale.exists_subalgebra_fg [Etale A B] :
    âˆƒ (Aâ‚€ : Subalgebra R A) (Bâ‚€ : Type u) (_ : CommRing Bâ‚€) (_ : Algebra Aâ‚€ Bâ‚€),
      Aâ‚€.FG âˆ§ Etale Aâ‚€ Bâ‚€ âˆ§ Nonempty (B â‰ƒâ‚[A] A âŠ—[Aâ‚€] Bâ‚€) := by
  simp only [Etale.iff_isStandardSmoothOfRelativeDimension_zero] at *
  exact IsStandardSmoothOfRelativeDimension.exists_subalgebra_fg ..
",Formal Proof of Stacks Project Tag 00U2,(8),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Smooth/NoetherianDescent.lean#L244-L248,Q27041,,10.143.3,lemma,3.0,"['00U0', '00AO', '0ELQ']","\n  Lemma 10.143.3. Results on \xc3\xa9tale ring maps. \n  \n  \nThe ring map $R \\to R_ f$ is \xc3\xa9tale for any ring $R$ and any $f \\in R$. \n\n\nCompositions of \xc3\xa9tale ring maps are \xc3\xa9tale. \n\n\nA base change of an \xc3\xa9tale ring map is \xc3\xa9tale. \n\n\nThe property of being \xc3\xa9tale is local: Given a ring map $R \\to S$ and elements $g_1, \\ldots , g_ m \\in S$ which generate the unit ideal such that $R \\to S_{g_ j}$ is \xc3\xa9tale for $j = 1, \\ldots , m$ then $R \\to S$ is \xc3\xa9tale. \n\n\nGiven $R \\to S$ of finite presentation, and a flat ring map $R \\to R\'$, set $S\' = R\' \\otimes _ R S$. The set of primes where $R\' \\to S\'$ is \xc3\xa9tale is the inverse image via $\\mathop{\\mathrm{Spec}}(S\') \\to \\mathop{\\mathrm{Spec}}(S)$ of the set of primes where $R \\to S$ is \xc3\xa9tale. \n\n\nAn \xc3\xa9tale ring map is syntomic, in particular flat. \n\n\nIf $S$ is finite type over a field $k$, then $S$ is \xc3\xa9tale over $k$ if and only if $\\Omega _{S/k} = 0$. \n\n\nAny \xc3\xa9tale ring map $R \\to S$ is the base change of an \xc3\xa9tale ring map $R_0 \\to S_0$ with $R_0$ of finite type over $\\mathbf{Z}$. \n\n\nLet $A = \\mathop{\\mathrm{colim}}\\nolimits A_ i$ be a filtered colimit of rings. Let $A \\to B$ be an \xc3\xa9tale ring map. Then there exists an \xc3\xa9tale ring map $A_ i \\to B_ i$ for some $i$ such that $B \\cong A \\otimes _{A_ i} B_ i$. \n\n\nLet $A$ be a ring. Let $S$ be a multiplicative subset of $A$. Let $S^{-1}A \\to B\'$ be \xc3\xa9tale. Then there exists an \xc3\xa9tale ring map $A \\to B$ such that $B\' \\cong S^{-1}B$. \n\n\nLet $A$ be a ring. Let $B = B\' \\times B\'\'$ be a product of $A$-algebras. Then $B$ is \xc3\xa9tale over $A$ if and only if both $B\'$ and $B\'\'$ are \xc3\xa9tale over $A$. \n\n\n\n\n    \n      Proof.\n      In each case we use the corresponding result for smooth ring maps with a small argument added to show that $\\Omega _{S/R}$ is zero. \n    \n      Proof of (1). The ring map $R \\to R_ f$ is smooth and $\\Omega _{R_ f/R} = 0$. \n    \n      Proof of (2). The composition $A \\to C$ of smooth maps $A \\to B$ and $B \\to C$ is smooth, see Lemma 10.137.13. By Lemma 10.131.7 we see that $\\Omega _{C/A}$ is zero as both $\\Omega _{C/B}$ and $\\Omega _{B/A}$ are zero. \n    \n      Proof of (3). Let $R \\to S$ be \xc3\xa9tale and $R \\to R\'$ be arbitrary. Then $R\' \\to S\' = R\' \\otimes _ R S$ is smooth, see Lemma 10.137.3. Since $\\Omega _{S\'/R\'} = S\' \\otimes _ S \\Omega _{S/R}$ by Lemma 10.131.12 we conclude that $\\Omega _{S\'/R\'} = 0$. Hence $R\' \\to S\'$ is \xc3\xa9tale. \n    \n      Proof of (4). Assume the hypotheses of (4). By Lemma 10.137.12 we see that $R \\to S$ is smooth. We are also given that $\\Omega _{S_{g_ i}/R} = (\\Omega _{S/R})_{g_ i} = 0$ for all $i$. Then $\\Omega _{S/R} = 0$, see Lemma 10.23.2. \n    \n      Proof of (5). The result for smooth maps is Lemma 10.137.17. In the proof of that lemma we used that $\\mathop{N\\! L}\\nolimits _{S/R} \\otimes _ S S\'$ is homotopy equivalent to $\\mathop{N\\! L}\\nolimits _{S\'/R\'}$. This reduces us to showing that if $M$ is a finitely presented $S$-module the set of primes $\\mathfrak q\'$ of $S\'$ such that $(M \\otimes _ S S\')_{\\mathfrak q\'} = 0$ is the inverse image of the set of primes $\\mathfrak q$ of $S$ such that $M_{\\mathfrak q} = 0$. This follows from Lemma 10.40.6. \n    \n      Proof of (6). Follows directly from the corresponding result for smooth ring maps (Lemma 10.137.9). \n    \n      Proof of (7). Follows from Lemma 10.140.3 and the definitions. \n    \n      Proof of (8). Lemma 10.138.14 gives the result for smooth ring maps. The resulting smooth ring map $R_0 \\to S_0$ satisfies the hypotheses of Lemma 10.130.8, and hence we may replace $S_0$ by the factor of relative dimension $0$ over $R_0$. \n    \n      Proof of (9). Follows from (8) since $R_0 \\to A$ will factor through $A_ i$ for some $i$ by Lemma 10.127.3. \n    \n      Proof of (10). Follows from (9), (1), and (2) since $S^{-1}A$ is a filtered colimit of principal localizations of $A$. \n    \n      Proof of (11). Use Lemma 10.137.14 to see the result for smoothness and then use that $\\Omega _{B/A}$ is zero if and only if both $\\Omega _{B\'/A}$ and $\\Omega _{B\'\'/A}$ are zero. \n      $\\square$\n    \n","\n  Lemma 10.143.3. Results on \xc3\xa9tale ring maps. \n  \n  \nThe ring map $R \\to R_ f$ is \xc3\xa9tale for any ring $R$ and any $f \\in R$. \n\n\nCompositions of \xc3\xa9tale ring maps are \xc3\xa9tale. \n\n\nA base change of an \xc3\xa9tale ring map is \xc3\xa9tale. \n\n\nThe property of being \xc3\xa9tale is local: Given a ring map $R \\to S$ and elements $g_1, \\ldots , g_ m \\in S$ which generate the unit ideal such that $R \\to S_{g_ j}$ is \xc3\xa9tale for $j = 1, \\ldots , m$ then $R \\to S$ is \xc3\xa9tale. \n\n\nGiven $R \\to S$ of finite presentation, and a flat ring map $R \\to R\'$, set $S\' = R\' \\otimes _ R S$. The set of primes where $R\' \\to S\'$ is \xc3\xa9tale is the inverse image via $\\mathop{\\mathrm{Spec}}(S\') \\to \\mathop{\\mathrm{Spec}}(S)$ of the set of primes where $R \\to S$ is \xc3\xa9tale. \n\n\nAn \xc3\xa9tale ring map is syntomic, in particular flat. \n\n\nIf $S$ is finite type over a field $k$, then $S$ is \xc3\xa9tale over $k$ if and only if $\\Omega _{S/k} = 0$. \n\n\nAny \xc3\xa9tale ring map $R \\to S$ is the base change of an \xc3\xa9tale ring map $R_0 \\to S_0$ with $R_0$ of finite type over $\\mathbf{Z}$. \n\n\nLet $A = \\mathop{\\mathrm{colim}}\\nolimits A_ i$ be a filtered colimit of rings. Let $A \\to B$ be an \xc3\xa9tale ring map. Then there exists an \xc3\xa9tale ring map $A_ i \\to B_ i$ for some $i$ such that $B \\cong A \\otimes _{A_ i} B_ i$. \n\n\nLet $A$ be a ring. Let $S$ be a multiplicative subset of $A$. Let $S^{-1}A \\to B\'$ be \xc3\xa9tale. Then there exists an \xc3\xa9tale ring map $A \\to B$ such that $B\' \\cong S^{-1}B$. \n\n\nLet $A$ be a ring. Let $B = B\' \\times B\'\'$ be a product of $A$-algebras. Then $B$ is \xc3\xa9tale over $A$ if and only if both $B\'$ and $B\'\'$ are \xc3\xa9tale over $A$. \n\n\n\n\n    \n","Proof.\n      In each case we use the corresponding result for smooth ring maps with a small argument added to show that $\\Omega _{S/R}$ is zero. \n    \n      Proof of (1). The ring map $R \\to R_ f$ is smooth and $\\Omega _{R_ f/R} = 0$. \n    \n      Proof of (2). The composition $A \\to C$ of smooth maps $A \\to B$ and $B \\to C$ is smooth, see Lemma 10.137.13. By Lemma 10.131.7 we see that $\\Omega _{C/A}$ is zero as both $\\Omega _{C/B}$ and $\\Omega _{B/A}$ are zero. \n    \n      Proof of (3). Let $R \\to S$ be \xc3\xa9tale and $R \\to R\'$ be arbitrary. Then $R\' \\to S\' = R\' \\otimes _ R S$ is smooth, see Lemma 10.137.3. Since $\\Omega _{S\'/R\'} = S\' \\otimes _ S \\Omega _{S/R}$ by Lemma 10.131.12 we conclude that $\\Omega _{S\'/R\'} = 0$. Hence $R\' \\to S\'$ is \xc3\xa9tale. \n    \n      Proof of (4). Assume the hypotheses of (4). By Lemma 10.137.12 we see that $R \\to S$ is smooth. We are also given that $\\Omega _{S_{g_ i}/R} = (\\Omega _{S/R})_{g_ i} = 0$ for all $i$. Then $\\Omega _{S/R} = 0$, see Lemma 10.23.2. \n    \n      Proof of (5). The result for smooth maps is Lemma 10.137.17. In the proof of that lemma we used that $\\mathop{N\\! L}\\nolimits _{S/R} \\otimes _ S S\'$ is homotopy equivalent to $\\mathop{N\\! L}\\nolimits _{S\'/R\'}$. This reduces us to showing that if $M$ is a finitely presented $S$-module the set of primes $\\mathfrak q\'$ of $S\'$ such that $(M \\otimes _ S S\')_{\\mathfrak q\'} = 0$ is the inverse image of the set of primes $\\mathfrak q$ of $S$ such that $M_{\\mathfrak q} = 0$. This follows from Lemma 10.40.6. \n    \n      Proof of (6). Follows directly from the corresponding result for smooth ring maps (Lemma 10.137.9). \n    \n      Proof of (7). Follows from Lemma 10.140.3 and the definitions. \n    \n      Proof of (8). Lemma 10.138.14 gives the result for smooth ring maps. The resulting smooth ring map $R_0 \\to S_0$ satisfies the hypotheses of Lemma 10.130.8, and hence we may replace $S_0$ by the factor of relative dimension $0$ over $R_0$. \n    \n      Proof of (9). Follows from (8) since $R_0 \\to A$ will factor through $A_ i$ for some $i$ by Lemma 10.127.3. \n    \n      Proof of (10). Follows from (9), (1), and (2) since $S^{-1}A$ is a filtered colimit of principal localizations of $A$. \n    \n      Proof of (11). Use Lemma 10.137.14 to see the result for smoothness and then use that $\\Omega _{B/A}$ is zero if and only if both $\\Omega _{B\'/A}$ and $\\Omega _{B\'\'/A}$ are zero. \n      $\\square$\n    \n"," by
  simp only [Etale.iff_isStandardSmoothOfRelativeDimension_zero] at *
  exact IsStandardSmoothOfRelativeDimension.exists_subalgebra_fg ..
","public theorem _root_.Algebra.Etale.exists_subalgebra_fg [Etale A B] :
    âˆƒ (Aâ‚€ : Subalgebra R A) (Bâ‚€ : Type u) (_ : CommRing Bâ‚€) (_ : Algebra Aâ‚€ Bâ‚€),
      Aâ‚€.FG âˆ§ Etale Aâ‚€ Bâ‚€ âˆ§ Nonempty (B â‰ƒâ‚[A] A âŠ—[Aâ‚€] Bâ‚€) ","Proof.\n      In each case we use the corresponding result for smooth ring maps with a small argument added to show that $\\Omega _{S/R}$ is zero. \n    \n      Proof of (1). The ring map $R \\to R_ f$ is smooth and $\\Omega _{R_ f/R} = 0$. \n    \n      Proof of (2). The composition $A \\to C$ of smooth maps $A \\to B$ and $B \\to C$ is smooth, see Lemma 10.137.13 [[\n  Lemma 10.137.13. A composition of smooth ring maps is smooth. \n\n    \n]]. By Lemma 10.131.7 [[\n  Lemma 10.131.7. Let $A \\to B \\to C$ be ring maps. Then there is a canonical exact sequence \n  \n  \\[  C \\otimes _ B \\Omega _{B/A} \\to \\Omega _{C/A} \\to \\Omega _{C/B} \\to 0  \\]\n\n   of $C$-modules. \n\n    \n]] we see that $\\Omega _{C/A}$ is zero as both $\\Omega _{C/B}$ and $\\Omega _{B/A}$ are zero. \n    \n      Proof of (3). Let $R \\to S$ be \xc3\xa9tale and $R \\to R\'$ be arbitrary. Then $R\' \\to S\' = R\' \\otimes _ R S$ is smooth, see Lemma 10.137.3 [[\n       \n      \n  Lemma 10.137.3. Let $R \\to S$ be a smooth ring map. Let $R \\to R\'$ be any ring map. Then the base change $R\' \\to S\' = R\' \\otimes _ R S$ is smooth. \n\n    \n]]. Since $\\Omega _{S\'/R\'} = S\' \\otimes _ S \\Omega _{S/R}$ by Lemma 10.131.12 [[\n  Lemma 10.131.12. Suppose that we have ring maps $R \\to R\'$ and $R \\to S$. Set $S\' = S \\otimes _ R R\'$, so that we obtain a diagram (10.131.4.1). Then the canonical map defined above induces an isomorphism $\\Omega _{S/R} \\otimes _ R R\' = \\Omega _{S\'/R\'}$. \n\n    \n]] we conclude that $\\Omega _{S\'/R\'} = 0$. Hence $R\' \\to S\'$ is \xc3\xa9tale. \n    \n      Proof of (4). Assume the hypotheses of (4). By Lemma 10.137.12 [[\n       \n      \n  Lemma 10.137.12. Let $R \\to S$ be a ring map. Then $R \\to S$ is smooth if and only if $R \\to S$ is smooth at every prime $\\mathfrak q$ of $S$. \n\n    \n]] we see that $R \\to S$ is smooth. We are also given that $\\Omega _{S_{g_ i}/R} = (\\Omega _{S/R})_{g_ i} = 0$ for all $i$. Then $\\Omega _{S/R} = 0$, see Lemma 10.23.2 [[\n       \n      \n  Lemma 10.23.2. Let $R$ be a ring. Let $M$ be an $R$-module. Let $S$ be an $R$-algebra. Suppose that $f_1, \\ldots , f_ n$ is a finite list of elements of $R$ such that $\\bigcup D(f_ i) = \\mathop{\\mathrm{Spec}}(R)$, in other words $(f_1, \\ldots , f_ n) = R$. \n  \n  \nIf each $M_{f_ i} = 0$ then $M = 0$. \n\n\nIf each $M_{f_ i}$ is a finite $R_{f_ i}$-module, then $M$ is a finite $R$-module. \n\n\nIf each $M_{f_ i}$ is a finitely presented $R_{f_ i}$-module, then $M$ is a finitely presented $R$-module. \n\n\nLet $M \\to N$ be a map of $R$-modules. If $M_{f_ i} \\to N_{f_ i}$ is an isomorphism for each $i$ then $M \\to N$ is an isomorphism. \n\n\nLet $0 \\to M\'\' \\to M \\to M\' \\to 0$ be a complex of $R$-modules. If $0 \\to M\'\'_{f_ i} \\to M_{f_ i} \\to M\'_{f_ i} \\to 0$ is exact for each $i$, then $0 \\to M\'\' \\to M \\to M\' \\to 0$ is exact. \n\n\nIf each $R_{f_ i}$ is Noetherian, then $R$ is Noetherian. \n\n\nIf each $S_{f_ i}$ is a finite type $R_{f_ i}$-algebra, then $S$ is a finite type $R$-algebra. \n\n\nIf each $S_{f_ i}$ is of finite presentation over $R_{f_ i}$, then $S$ is a finitely presented $R$-algebra. \n\n\n\n\n    \n]]. \n    \n      Proof of (5). The result for smooth maps is Lemma 10.137.17 [[\n  Lemma 10.137.17. Let $R \\to S$ be a ring map of finite presentation. Let $R \\to R\'$ be a flat ring map. Denote $S\' = R\' \\otimes _ R S$ the base change. Let $U \\subset \\mathop{\\mathrm{Spec}}(S)$ be the set of primes at which $R \\to S$ is smooth. Let $V \\subset \\mathop{\\mathrm{Spec}}(S\')$ the set of primes at which $R\' \\to S\'$ is smooth. Then $V$ is the inverse image of $U$ under the map $f : \\mathop{\\mathrm{Spec}}(S\') \\to \\mathop{\\mathrm{Spec}}(S)$. \n\n    \n]]. In the proof of that lemma we used that $\\mathop{N\\! L}\\nolimits _{S/R} \\otimes _ S S\'$ is homotopy equivalent to $\\mathop{N\\! L}\\nolimits _{S\'/R\'}$. This reduces us to showing that if $M$ is a finitely presented $S$-module the set of primes $\\mathfrak q\'$ of $S\'$ such that $(M \\otimes _ S S\')_{\\mathfrak q\'} = 0$ is the inverse image of the set of primes $\\mathfrak q$ of $S$ such that $M_{\\mathfrak q} = 0$. This follows from Lemma 10.40.6 [[\n  Lemma 10.40.6. Let $R \\to R\'$ be a ring map and let $M$ be a finite $R$-module. Then $\\text{Supp}(M \\otimes _ R R\')$ is the inverse image of $\\text{Supp}(M)$. \n\n    \n]]. \n    \n      Proof of (6). Follows directly from the corresponding result for smooth ring maps (Lemma 10.137.9 [[\n  Lemma 10.137.9. Let $R \\to S$ be a smooth ring map. There exists an open covering of $\\mathop{\\mathrm{Spec}}(S)$ by standard opens $D(g)$ such that each $S_ g$ is standard smooth over $R$. In particular $R \\to S$ is syntomic. \n\n    \n]]). \n    \n      Proof of (7). Follows from Lemma 10.140.3 [[\n  Lemma 10.140.3. Let $k$ be any field. Let $S$ be a finite type $k$-algebra. Let $X = \\mathop{\\mathrm{Spec}}(S)$. Let $\\mathfrak q \\subset S$ be a prime corresponding to $x \\in X$. The following are equivalent: \n  \n  \nThe $k$-algebra $S$ is smooth at $\\mathfrak q$ over $k$. \n\n\nWe have $\\dim _{\\kappa (\\mathfrak q)} \\Omega _{S/k} \\otimes _ S \\kappa (\\mathfrak q) \\leq \\dim _ x X$. \n\n\nWe have $\\dim _{\\kappa (\\mathfrak q)} \\Omega _{S/k} \\otimes _ S \\kappa (\\mathfrak q) = \\dim _ x X$. \n\n\n\n   Moreover, in this case the local ring $S_{\\mathfrak q}$ is regular. \n\n    \n]] and the definitions. \n    \n      Proof of (8). Lemma 10.138.14 [[\n  Lemma 10.138.14. Let $R \\to S$ be a smooth ring map. Then there exists a subring $R_0 \\subset R$ of finite type over $\\mathbf{Z}$ and a smooth ring map $R_0 \\to S_0$ such that $S \\cong R \\otimes _{R_0} S_0$. \n\n    \n]] gives the result for smooth ring maps. The resulting smooth ring map $R_0 \\to S_0$ satisfies the hypotheses of Lemma 10.130.8 [[\n  Lemma 10.130.8. Let $R$ be a ring. Let $R \\to S$ be a ring map which is (a) flat, (b) of finite presentation, (c) has Cohen-Macaulay fibres. Then we can write $S = S_0 \\times \\ldots \\times S_ n$ as a product of $R$-algebras $S_ d$ such that each $S_ d$ satisfies (a), (b), (c) and has all fibres equidimensional of dimension $d$. \n\n    \n]], and hence we may replace $S_0$ by the factor of relative dimension $0$ over $R_0$. \n    \n      Proof of (9). Follows from (8) since $R_0 \\to A$ will factor through $A_ i$ for some $i$ by Lemma 10.127.3 [[\n  Lemma 10.127.3. Let $\\varphi : R \\to S$ be a ring map. The following are equivalent \n  \n  \n$\\varphi $ is of finite presentation, \n\n\nfor every directed system $A_\\lambda $ of $R$-algebras the map \n\n\n  \\[  \\mathop{\\mathrm{colim}}\\nolimits _\\lambda \\mathop{\\mathrm{Hom}}\\nolimits _ R(S, A_\\lambda ) \\longrightarrow \\mathop{\\mathrm{Hom}}\\nolimits _ R(S, \\mathop{\\mathrm{colim}}\\nolimits _\\lambda A_\\lambda )  \\]\n\n\n is bijective, and \n\n\nfor every directed system $A_\\lambda $ of $R$-algebras the map \n\n\n  \\[  \\mathop{\\mathrm{colim}}\\nolimits _\\lambda \\mathop{\\mathrm{Hom}}\\nolimits _ R(S, A_\\lambda ) \\longrightarrow \\mathop{\\mathrm{Hom}}\\nolimits _ R(S, \\mathop{\\mathrm{colim}}\\nolimits _\\lambda A_\\lambda )  \\]\n\n\n is surjective. \n\n\n\n\n    \n]]. \n    \n      Proof of (10). Follows from (9), (1), and (2) since $S^{-1}A$ is a filtered colimit of principal localizations of $A$. \n    \n      Proof of (11). Use Lemma 10.137.14 [[\n  Lemma 10.137.14. Let $R$ be a ring. Let $S = S\' \\times S\'\'$ be a product of $R$-algebras. Then $S$ is smooth over $R$ if and only if both $S\'$ and $S\'\'$ are smooth over $R$. \n\n    \n]] to see the result for smoothness and then use that $\\Omega _{B/A}$ is zero if and only if both $\\Omega _{B\'/A}$ and $\\Omega _{B\'\'/A}$ are zero. \n      $\\square$\n    \n"
333,00T7,"instance free_cotangent : Module.Free S P.toExtension.Cotangent :=
  Module.Free.of_basis P.basisCotangent
",Formal Proof of Stacks Project Tag 00T7,(3),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Smooth/StandardSmoothCotangent.lean#L153-L154,Q27041,,10.137.6,lemma,3.0,"['00T1', '00AO', '0ELQ']","\n  Lemma 10.137.6. Let $S = R[x_1, \\ldots , x_ n]/(f_1, \\ldots , f_ c) = R[x_1, \\ldots , x_ n]/I$ be a standard smooth algebra. Then \n  \n  \nthe ring map $R \\to S$ is smooth, \n\n\nthe $S$-module $\\Omega _{S/R}$ is free on $\\text{d}x_{c + 1}, \\ldots , \\text{d}x_ n$, \n\n\nthe $S$-module $I/I^2$ is free on the classes of $f_1, \\ldots , f_ c$, \n\n\nfor any $g \\in S$ the ring map $R \\to S_ g$ is standard smooth, \n\n\nfor any ring map $R \\to R\'$ the base change $R\' \\to R\'\\otimes _ R S$ is standard smooth, \n\n\nif $f \\in R$ maps to an invertible element in $S$, then $R_ f \\to S$ is standard smooth, and \n\n\nthe ring $S$ is a relative global complete intersection over $R$. \n\n\n\n\n    \n      Proof.\n      Consider the naive cotangent complex of the given presentation \n    \n      \n  \\[  (f_1, \\ldots , f_ c)/(f_1, \\ldots , f_ c)^2 \\longrightarrow \\bigoplus \\nolimits _{i = 1}^ n S \\text{d}x_ i  \\]\n\n    \n       Let us compose this map with the projection onto the first $c$ direct summands of the direct sum. According to the definition of a standard smooth algebra the classes $f_ i \\bmod (f_1, \\ldots , f_ c)^2$ map to a basis of $\\bigoplus _{i = 1}^ c S\\text{d}x_ i$. We conclude that $(f_1, \\ldots , f_ c)/(f_1, \\ldots , f_ c)^2$ is free of rank $c$ with a basis given by the elements $f_ i \\bmod (f_1, \\ldots , f_ c)^2$, and that the homology in degree $0$, i.e., $\\Omega _{S/R}$, of the naive cotangent complex is a free $S$-module with basis the images of $\\text{d}x_{c + j}$, $j = 1, \\ldots , n - c$. In particular, this proves $R \\to S$ is smooth. \n    \n      The proofs of (4) and (6) are omitted. But see the example below and the proof of Lemma 10.136.9. \n    \n      Let $\\varphi : R \\to R\'$ be any ring map. Denote $S\' = R\'[x_1, \\ldots , x_ n]/(f_1^\\varphi , \\ldots , f_ c^\\varphi )$ where $f^\\varphi $ is the polynomial obtained from $f \\in R[x_1, \\ldots , x_ n]$ by applying $\\varphi $ to all the coefficients. Then $S\' \\cong R\' \\otimes _ R S$. Moreover, the determinant of Definition 10.137.5 for $S\'/R\'$ is equal to $g^\\varphi $. Its image in $S\'$ is therefore the image of $g$ via $R[x_1, \\ldots , x_ n] \\to S \\to S\'$ and hence invertible. This proves (5). \n    \n      To prove (7) it suffices to show that $S \\otimes _ R \\kappa (\\mathfrak p)$ has dimension $n - c$ for every prime $\\mathfrak p \\subset R$. By (5) it suffices to prove that any standard smooth algebra $k[x_1, \\ldots , x_ n]/(f_1, \\ldots , f_ c)$ over a field $k$ has dimension $n - c$. We already know that $k[x_1, \\ldots , x_ n]/(f_1, \\ldots , f_ c)$ is a local complete intersection by Lemma 10.137.4. Hence, since $I/I^2$ is free of rank $c$ we see that $k[x_1, \\ldots , x_ n]/(f_1, \\ldots , f_ c)$ has dimension $n - c$, by Lemma 10.135.4 for example. \n      $\\square$\n    \n","\n  Lemma 10.137.6. Let $S = R[x_1, \\ldots , x_ n]/(f_1, \\ldots , f_ c) = R[x_1, \\ldots , x_ n]/I$ be a standard smooth algebra. Then \n  \n  \nthe ring map $R \\to S$ is smooth, \n\n\nthe $S$-module $\\Omega _{S/R}$ is free on $\\text{d}x_{c + 1}, \\ldots , \\text{d}x_ n$, \n\n\nthe $S$-module $I/I^2$ is free on the classes of $f_1, \\ldots , f_ c$, \n\n\nfor any $g \\in S$ the ring map $R \\to S_ g$ is standard smooth, \n\n\nfor any ring map $R \\to R\'$ the base change $R\' \\to R\'\\otimes _ R S$ is standard smooth, \n\n\nif $f \\in R$ maps to an invertible element in $S$, then $R_ f \\to S$ is standard smooth, and \n\n\nthe ring $S$ is a relative global complete intersection over $R$. \n\n\n\n\n    \n","Proof.\n      Consider the naive cotangent complex of the given presentation \n    \n      \n  \\[  (f_1, \\ldots , f_ c)/(f_1, \\ldots , f_ c)^2 \\longrightarrow \\bigoplus \\nolimits _{i = 1}^ n S \\text{d}x_ i  \\]\n\n    \n       Let us compose this map with the projection onto the first $c$ direct summands of the direct sum. According to the definition of a standard smooth algebra the classes $f_ i \\bmod (f_1, \\ldots , f_ c)^2$ map to a basis of $\\bigoplus _{i = 1}^ c S\\text{d}x_ i$. We conclude that $(f_1, \\ldots , f_ c)/(f_1, \\ldots , f_ c)^2$ is free of rank $c$ with a basis given by the elements $f_ i \\bmod (f_1, \\ldots , f_ c)^2$, and that the homology in degree $0$, i.e., $\\Omega _{S/R}$, of the naive cotangent complex is a free $S$-module with basis the images of $\\text{d}x_{c + j}$, $j = 1, \\ldots , n - c$. In particular, this proves $R \\to S$ is smooth. \n    \n      The proofs of (4) and (6) are omitted. But see the example below and the proof of Lemma 10.136.9. \n    \n      Let $\\varphi : R \\to R\'$ be any ring map. Denote $S\' = R\'[x_1, \\ldots , x_ n]/(f_1^\\varphi , \\ldots , f_ c^\\varphi )$ where $f^\\varphi $ is the polynomial obtained from $f \\in R[x_1, \\ldots , x_ n]$ by applying $\\varphi $ to all the coefficients. Then $S\' \\cong R\' \\otimes _ R S$. Moreover, the determinant of Definition 10.137.5 for $S\'/R\'$ is equal to $g^\\varphi $. Its image in $S\'$ is therefore the image of $g$ via $R[x_1, \\ldots , x_ n] \\to S \\to S\'$ and hence invertible. This proves (5). \n    \n      To prove (7) it suffices to show that $S \\otimes _ R \\kappa (\\mathfrak p)$ has dimension $n - c$ for every prime $\\mathfrak p \\subset R$. By (5) it suffices to prove that any standard smooth algebra $k[x_1, \\ldots , x_ n]/(f_1, \\ldots , f_ c)$ over a field $k$ has dimension $n - c$. We already know that $k[x_1, \\ldots , x_ n]/(f_1, \\ldots , f_ c)$ is a local complete intersection by Lemma 10.137.4. Hence, since $I/I^2$ is free of rank $c$ we see that $k[x_1, \\ldots , x_ n]/(f_1, \\ldots , f_ c)$ has dimension $n - c$, by Lemma 10.135.4 for example. \n      $\\square$\n    \n","
  Module.Free.of_basis P.basisCotangent
",instance free_cotangent : Module.Free S P.toExtension.Cotangent ,"Proof.\n      Consider the naive cotangent complex of the given presentation \n    \n      \n  \\[  (f_1, \\ldots , f_ c)/(f_1, \\ldots , f_ c)^2 \\longrightarrow \\bigoplus \\nolimits _{i = 1}^ n S \\text{d}x_ i  \\]\n\n    \n       Let us compose this map with the projection onto the first $c$ direct summands of the direct sum. According to the definition of a standard smooth algebra the classes $f_ i \\bmod (f_1, \\ldots , f_ c)^2$ map to a basis of $\\bigoplus _{i = 1}^ c S\\text{d}x_ i$. We conclude that $(f_1, \\ldots , f_ c)/(f_1, \\ldots , f_ c)^2$ is free of rank $c$ with a basis given by the elements $f_ i \\bmod (f_1, \\ldots , f_ c)^2$, and that the homology in degree $0$, i.e., $\\Omega _{S/R}$, of the naive cotangent complex is a free $S$-module with basis the images of $\\text{d}x_{c + j}$, $j = 1, \\ldots , n - c$. In particular, this proves $R \\to S$ is smooth. \n    \n      The proofs of (4) and (6) are omitted. But see the example below and the proof of Lemma 10.136.9 [[\n  Lemma 10.136.9. Let $S = R[x_1, \\ldots , x_ n]/(f_1, \\ldots , f_ c)$ be a relative global complete intersection (Definition 10.136.5) \n  \n  \nFor any $R \\to R\'$ the base change $R\' \\otimes _ R S = R\'[x_1, \\ldots , x_ n]/(f_1, \\ldots , f_ c)$ is a relative global complete intersection. \n\n\nFor any $g \\in S$ which is the image of $h \\in R[x_1, \\ldots , x_ n]$ the ring $S_ g = R[x_1, \\ldots , x_ n, x_{n + 1}]/(f_1, \\ldots , f_ c, hx_{n + 1} - 1)$ is a relative global complete intersection. \n\n\nIf $R \\to S$ factors as $R \\to R_ f \\to S$ for some $f \\in R$. Then the ring $S = R_ f[x_1, \\ldots , x_ n]/(f_1, \\ldots , f_ c)$ is a relative global complete intersection over $R_ f$. \n\n\n\n\n    \n]]. \n    \n      Let $\\varphi : R \\to R\'$ be any ring map. Denote $S\' = R\'[x_1, \\ldots , x_ n]/(f_1^\\varphi , \\ldots , f_ c^\\varphi )$ where $f^\\varphi $ is the polynomial obtained from $f \\in R[x_1, \\ldots , x_ n]$ by applying $\\varphi $ to all the coefficients. Then $S\' \\cong R\' \\otimes _ R S$. Moreover, the determinant of Definition 10.137.5 [[\n  Definition 10.137.5. Let $R$ be a ring. Given integers $n \\geq c \\geq 0$ and $f_1, \\ldots , f_ c \\in R[x_1, \\ldots , x_ n]$ we say \n  \n  \\[  R[x_1, \\ldots , x_ n]/(f_1, \\ldots , f_ c)  \\]\n\n   is a standard smooth algebra over $R$ if the polynomial \n  \n  \\[  g = \\det \\left( \\begin{matrix}  \\partial f_1/\\partial x_1 \n\n&  \\partial f_2/\\partial x_1 \n\n&  \\ldots \n\n&  \\partial f_ c/\\partial x_1 \n\n\\\\  \\partial f_1/\\partial x_2 \n\n&  \\partial f_2/\\partial x_2 \n\n&  \\ldots \n\n&  \\partial f_ c/\\partial x_2 \n\n\\\\  \\ldots \n\n&  \\ldots \n\n&  \\ldots \n\n&  \\ldots \n\n\\\\  \\partial f_1/\\partial x_ c \n\n&  \\partial f_2/\\partial x_ c \n\n&  \\ldots \n\n&  \\partial f_ c/\\partial x_ c \n\n\\end{matrix} \\right)  \\]\n\n   maps to an invertible element in $R[x_1, \\ldots , x_ n]/(f_1, \\ldots , f_ c)$. We say an $R$-algebra $S$ is standard smooth or that the ring map $R \\to S$ is standard smooth if there exist $n \\geq c \\geq 0$ and $f_1, \\ldots , f_ c \\in R[x_1, \\ldots , x_ n]$ such that $R[x_1, \\ldots , x_ n]/(f_1, \\ldots , f_ c)$ is a standard smooth algebra over $R$ and $S$ is isomorphic to $R[x_1, \\ldots , x_ n]/(f_1, \\ldots , f_ c)$ as an $R$-algebra. \n]] for $S\'/R\'$ is equal to $g^\\varphi $. Its image in $S\'$ is therefore the image of $g$ via $R[x_1, \\ldots , x_ n] \\to S \\to S\'$ and hence invertible. This proves (5). \n    \n      To prove (7) it suffices to show that $S \\otimes _ R \\kappa (\\mathfrak p)$ has dimension $n - c$ for every prime $\\mathfrak p \\subset R$. By (5) it suffices to prove that any standard smooth algebra $k[x_1, \\ldots , x_ n]/(f_1, \\ldots , f_ c)$ over a field $k$ has dimension $n - c$. We already know that $k[x_1, \\ldots , x_ n]/(f_1, \\ldots , f_ c)$ is a local complete intersection by Lemma 10.137.4 [[\n  Lemma 10.137.4. Let $k$ be a field. Let $S$ be a smooth $k$-algebra. Then $S$ is a local complete intersection. \n\n    \n]]. Hence, since $I/I^2$ is free of rank $c$ we see that $k[x_1, \\ldots , x_ n]/(f_1, \\ldots , f_ c)$ has dimension $n - c$, by Lemma 10.135.4 [[\n  Lemma 10.135.4. Let $k$ be a field. Let $S$ be a finite type $k$-algebra. Let $\\mathfrak q$ be a prime of $S$. Choose any presentation $S = k[x_1, \\ldots , x_ n]/I$. Let $\\mathfrak q\'$ be the prime of $k[x_1, \\ldots , x_ n]$ corresponding to $\\mathfrak q$. Set $c = \\text{height}(\\mathfrak q\') - \\text{height}(\\mathfrak q)$, in other words $\\dim _{\\mathfrak q}(S) = n - c$ (see Lemma 10.116.4). The following are equivalent \n  \n  \nThere exists a $g \\in S$, $g \\not\\in \\mathfrak q$ such that $S_ g$ is a global complete intersection over $k$. \n\n\nThe ideal $I_{\\mathfrak q\'} \\subset k[x_1, \\ldots , x_ n]_{\\mathfrak q\'}$ can be generated by $c$ elements. \n\n\nThe conormal module $(I/I^2)_{\\mathfrak q}$ can be generated by $c$ elements over $S_{\\mathfrak q}$. \n\n\nThe conormal module $(I/I^2)_{\\mathfrak q}$ is a free $S_{\\mathfrak q}$-module of rank $c$. \n\n\nThe ideal $I_{\\mathfrak q\'}$ can be generated by a regular sequence in the regular local ring $k[x_1, \\ldots , x_ n]_{\\mathfrak q\'}$. \n\n\n\n   In this case any $c$ elements of $I_{\\mathfrak q\'}$ which generate $I_{\\mathfrak q\'}/\\mathfrak q\'I_{\\mathfrak q\'}$ form a regular sequence in the local ring $k[x_1, \\ldots , x_ n]_{\\mathfrak q\'}$. \n\n    \n]] for example. \n      $\\square$\n    \n"
334,00T7,"theorem free_kaehlerDifferential (P : SubmersivePresentation R S Î¹ Ïƒ) :
    Module.Free S Î©[Sâ„R] :=
  Module.Free.of_basis P.basisKaehler
",Formal Proof of Stacks Project Tag 00T7,(2),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Smooth/StandardSmoothCotangent.lean#L236-L238,Q27041,,10.137.6,lemma,3.0,"['00T1', '00AO', '0ELQ']","\n  Lemma 10.137.6. Let $S = R[x_1, \\ldots , x_ n]/(f_1, \\ldots , f_ c) = R[x_1, \\ldots , x_ n]/I$ be a standard smooth algebra. Then \n  \n  \nthe ring map $R \\to S$ is smooth, \n\n\nthe $S$-module $\\Omega _{S/R}$ is free on $\\text{d}x_{c + 1}, \\ldots , \\text{d}x_ n$, \n\n\nthe $S$-module $I/I^2$ is free on the classes of $f_1, \\ldots , f_ c$, \n\n\nfor any $g \\in S$ the ring map $R \\to S_ g$ is standard smooth, \n\n\nfor any ring map $R \\to R\'$ the base change $R\' \\to R\'\\otimes _ R S$ is standard smooth, \n\n\nif $f \\in R$ maps to an invertible element in $S$, then $R_ f \\to S$ is standard smooth, and \n\n\nthe ring $S$ is a relative global complete intersection over $R$. \n\n\n\n\n    \n      Proof.\n      Consider the naive cotangent complex of the given presentation \n    \n      \n  \\[  (f_1, \\ldots , f_ c)/(f_1, \\ldots , f_ c)^2 \\longrightarrow \\bigoplus \\nolimits _{i = 1}^ n S \\text{d}x_ i  \\]\n\n    \n       Let us compose this map with the projection onto the first $c$ direct summands of the direct sum. According to the definition of a standard smooth algebra the classes $f_ i \\bmod (f_1, \\ldots , f_ c)^2$ map to a basis of $\\bigoplus _{i = 1}^ c S\\text{d}x_ i$. We conclude that $(f_1, \\ldots , f_ c)/(f_1, \\ldots , f_ c)^2$ is free of rank $c$ with a basis given by the elements $f_ i \\bmod (f_1, \\ldots , f_ c)^2$, and that the homology in degree $0$, i.e., $\\Omega _{S/R}$, of the naive cotangent complex is a free $S$-module with basis the images of $\\text{d}x_{c + j}$, $j = 1, \\ldots , n - c$. In particular, this proves $R \\to S$ is smooth. \n    \n      The proofs of (4) and (6) are omitted. But see the example below and the proof of Lemma 10.136.9. \n    \n      Let $\\varphi : R \\to R\'$ be any ring map. Denote $S\' = R\'[x_1, \\ldots , x_ n]/(f_1^\\varphi , \\ldots , f_ c^\\varphi )$ where $f^\\varphi $ is the polynomial obtained from $f \\in R[x_1, \\ldots , x_ n]$ by applying $\\varphi $ to all the coefficients. Then $S\' \\cong R\' \\otimes _ R S$. Moreover, the determinant of Definition 10.137.5 for $S\'/R\'$ is equal to $g^\\varphi $. Its image in $S\'$ is therefore the image of $g$ via $R[x_1, \\ldots , x_ n] \\to S \\to S\'$ and hence invertible. This proves (5). \n    \n      To prove (7) it suffices to show that $S \\otimes _ R \\kappa (\\mathfrak p)$ has dimension $n - c$ for every prime $\\mathfrak p \\subset R$. By (5) it suffices to prove that any standard smooth algebra $k[x_1, \\ldots , x_ n]/(f_1, \\ldots , f_ c)$ over a field $k$ has dimension $n - c$. We already know that $k[x_1, \\ldots , x_ n]/(f_1, \\ldots , f_ c)$ is a local complete intersection by Lemma 10.137.4. Hence, since $I/I^2$ is free of rank $c$ we see that $k[x_1, \\ldots , x_ n]/(f_1, \\ldots , f_ c)$ has dimension $n - c$, by Lemma 10.135.4 for example. \n      $\\square$\n    \n","\n  Lemma 10.137.6. Let $S = R[x_1, \\ldots , x_ n]/(f_1, \\ldots , f_ c) = R[x_1, \\ldots , x_ n]/I$ be a standard smooth algebra. Then \n  \n  \nthe ring map $R \\to S$ is smooth, \n\n\nthe $S$-module $\\Omega _{S/R}$ is free on $\\text{d}x_{c + 1}, \\ldots , \\text{d}x_ n$, \n\n\nthe $S$-module $I/I^2$ is free on the classes of $f_1, \\ldots , f_ c$, \n\n\nfor any $g \\in S$ the ring map $R \\to S_ g$ is standard smooth, \n\n\nfor any ring map $R \\to R\'$ the base change $R\' \\to R\'\\otimes _ R S$ is standard smooth, \n\n\nif $f \\in R$ maps to an invertible element in $S$, then $R_ f \\to S$ is standard smooth, and \n\n\nthe ring $S$ is a relative global complete intersection over $R$. \n\n\n\n\n    \n","Proof.\n      Consider the naive cotangent complex of the given presentation \n    \n      \n  \\[  (f_1, \\ldots , f_ c)/(f_1, \\ldots , f_ c)^2 \\longrightarrow \\bigoplus \\nolimits _{i = 1}^ n S \\text{d}x_ i  \\]\n\n    \n       Let us compose this map with the projection onto the first $c$ direct summands of the direct sum. According to the definition of a standard smooth algebra the classes $f_ i \\bmod (f_1, \\ldots , f_ c)^2$ map to a basis of $\\bigoplus _{i = 1}^ c S\\text{d}x_ i$. We conclude that $(f_1, \\ldots , f_ c)/(f_1, \\ldots , f_ c)^2$ is free of rank $c$ with a basis given by the elements $f_ i \\bmod (f_1, \\ldots , f_ c)^2$, and that the homology in degree $0$, i.e., $\\Omega _{S/R}$, of the naive cotangent complex is a free $S$-module with basis the images of $\\text{d}x_{c + j}$, $j = 1, \\ldots , n - c$. In particular, this proves $R \\to S$ is smooth. \n    \n      The proofs of (4) and (6) are omitted. But see the example below and the proof of Lemma 10.136.9. \n    \n      Let $\\varphi : R \\to R\'$ be any ring map. Denote $S\' = R\'[x_1, \\ldots , x_ n]/(f_1^\\varphi , \\ldots , f_ c^\\varphi )$ where $f^\\varphi $ is the polynomial obtained from $f \\in R[x_1, \\ldots , x_ n]$ by applying $\\varphi $ to all the coefficients. Then $S\' \\cong R\' \\otimes _ R S$. Moreover, the determinant of Definition 10.137.5 for $S\'/R\'$ is equal to $g^\\varphi $. Its image in $S\'$ is therefore the image of $g$ via $R[x_1, \\ldots , x_ n] \\to S \\to S\'$ and hence invertible. This proves (5). \n    \n      To prove (7) it suffices to show that $S \\otimes _ R \\kappa (\\mathfrak p)$ has dimension $n - c$ for every prime $\\mathfrak p \\subset R$. By (5) it suffices to prove that any standard smooth algebra $k[x_1, \\ldots , x_ n]/(f_1, \\ldots , f_ c)$ over a field $k$ has dimension $n - c$. We already know that $k[x_1, \\ldots , x_ n]/(f_1, \\ldots , f_ c)$ is a local complete intersection by Lemma 10.137.4. Hence, since $I/I^2$ is free of rank $c$ we see that $k[x_1, \\ldots , x_ n]/(f_1, \\ldots , f_ c)$ has dimension $n - c$, by Lemma 10.135.4 for example. \n      $\\square$\n    \n","
  Module.Free.of_basis P.basisKaehler
","theorem free_kaehlerDifferential (P : SubmersivePresentation R S Î¹ Ïƒ) :
    Module.Free S Î©[Sâ„R] ","Proof.\n      Consider the naive cotangent complex of the given presentation \n    \n      \n  \\[  (f_1, \\ldots , f_ c)/(f_1, \\ldots , f_ c)^2 \\longrightarrow \\bigoplus \\nolimits _{i = 1}^ n S \\text{d}x_ i  \\]\n\n    \n       Let us compose this map with the projection onto the first $c$ direct summands of the direct sum. According to the definition of a standard smooth algebra the classes $f_ i \\bmod (f_1, \\ldots , f_ c)^2$ map to a basis of $\\bigoplus _{i = 1}^ c S\\text{d}x_ i$. We conclude that $(f_1, \\ldots , f_ c)/(f_1, \\ldots , f_ c)^2$ is free of rank $c$ with a basis given by the elements $f_ i \\bmod (f_1, \\ldots , f_ c)^2$, and that the homology in degree $0$, i.e., $\\Omega _{S/R}$, of the naive cotangent complex is a free $S$-module with basis the images of $\\text{d}x_{c + j}$, $j = 1, \\ldots , n - c$. In particular, this proves $R \\to S$ is smooth. \n    \n      The proofs of (4) and (6) are omitted. But see the example below and the proof of Lemma 10.136.9 [[\n  Lemma 10.136.9. Let $S = R[x_1, \\ldots , x_ n]/(f_1, \\ldots , f_ c)$ be a relative global complete intersection (Definition 10.136.5) \n  \n  \nFor any $R \\to R\'$ the base change $R\' \\otimes _ R S = R\'[x_1, \\ldots , x_ n]/(f_1, \\ldots , f_ c)$ is a relative global complete intersection. \n\n\nFor any $g \\in S$ which is the image of $h \\in R[x_1, \\ldots , x_ n]$ the ring $S_ g = R[x_1, \\ldots , x_ n, x_{n + 1}]/(f_1, \\ldots , f_ c, hx_{n + 1} - 1)$ is a relative global complete intersection. \n\n\nIf $R \\to S$ factors as $R \\to R_ f \\to S$ for some $f \\in R$. Then the ring $S = R_ f[x_1, \\ldots , x_ n]/(f_1, \\ldots , f_ c)$ is a relative global complete intersection over $R_ f$. \n\n\n\n\n    \n]]. \n    \n      Let $\\varphi : R \\to R\'$ be any ring map. Denote $S\' = R\'[x_1, \\ldots , x_ n]/(f_1^\\varphi , \\ldots , f_ c^\\varphi )$ where $f^\\varphi $ is the polynomial obtained from $f \\in R[x_1, \\ldots , x_ n]$ by applying $\\varphi $ to all the coefficients. Then $S\' \\cong R\' \\otimes _ R S$. Moreover, the determinant of Definition 10.137.5 [[\n  Definition 10.137.5. Let $R$ be a ring. Given integers $n \\geq c \\geq 0$ and $f_1, \\ldots , f_ c \\in R[x_1, \\ldots , x_ n]$ we say \n  \n  \\[  R[x_1, \\ldots , x_ n]/(f_1, \\ldots , f_ c)  \\]\n\n   is a standard smooth algebra over $R$ if the polynomial \n  \n  \\[  g = \\det \\left( \\begin{matrix}  \\partial f_1/\\partial x_1 \n\n&  \\partial f_2/\\partial x_1 \n\n&  \\ldots \n\n&  \\partial f_ c/\\partial x_1 \n\n\\\\  \\partial f_1/\\partial x_2 \n\n&  \\partial f_2/\\partial x_2 \n\n&  \\ldots \n\n&  \\partial f_ c/\\partial x_2 \n\n\\\\  \\ldots \n\n&  \\ldots \n\n&  \\ldots \n\n&  \\ldots \n\n\\\\  \\partial f_1/\\partial x_ c \n\n&  \\partial f_2/\\partial x_ c \n\n&  \\ldots \n\n&  \\partial f_ c/\\partial x_ c \n\n\\end{matrix} \\right)  \\]\n\n   maps to an invertible element in $R[x_1, \\ldots , x_ n]/(f_1, \\ldots , f_ c)$. We say an $R$-algebra $S$ is standard smooth or that the ring map $R \\to S$ is standard smooth if there exist $n \\geq c \\geq 0$ and $f_1, \\ldots , f_ c \\in R[x_1, \\ldots , x_ n]$ such that $R[x_1, \\ldots , x_ n]/(f_1, \\ldots , f_ c)$ is a standard smooth algebra over $R$ and $S$ is isomorphic to $R[x_1, \\ldots , x_ n]/(f_1, \\ldots , f_ c)$ as an $R$-algebra. \n]] for $S\'/R\'$ is equal to $g^\\varphi $. Its image in $S\'$ is therefore the image of $g$ via $R[x_1, \\ldots , x_ n] \\to S \\to S\'$ and hence invertible. This proves (5). \n    \n      To prove (7) it suffices to show that $S \\otimes _ R \\kappa (\\mathfrak p)$ has dimension $n - c$ for every prime $\\mathfrak p \\subset R$. By (5) it suffices to prove that any standard smooth algebra $k[x_1, \\ldots , x_ n]/(f_1, \\ldots , f_ c)$ over a field $k$ has dimension $n - c$. We already know that $k[x_1, \\ldots , x_ n]/(f_1, \\ldots , f_ c)$ is a local complete intersection by Lemma 10.137.4 [[\n  Lemma 10.137.4. Let $k$ be a field. Let $S$ be a smooth $k$-algebra. Then $S$ is a local complete intersection. \n\n    \n]]. Hence, since $I/I^2$ is free of rank $c$ we see that $k[x_1, \\ldots , x_ n]/(f_1, \\ldots , f_ c)$ has dimension $n - c$, by Lemma 10.135.4 [[\n  Lemma 10.135.4. Let $k$ be a field. Let $S$ be a finite type $k$-algebra. Let $\\mathfrak q$ be a prime of $S$. Choose any presentation $S = k[x_1, \\ldots , x_ n]/I$. Let $\\mathfrak q\'$ be the prime of $k[x_1, \\ldots , x_ n]$ corresponding to $\\mathfrak q$. Set $c = \\text{height}(\\mathfrak q\') - \\text{height}(\\mathfrak q)$, in other words $\\dim _{\\mathfrak q}(S) = n - c$ (see Lemma 10.116.4). The following are equivalent \n  \n  \nThere exists a $g \\in S$, $g \\not\\in \\mathfrak q$ such that $S_ g$ is a global complete intersection over $k$. \n\n\nThe ideal $I_{\\mathfrak q\'} \\subset k[x_1, \\ldots , x_ n]_{\\mathfrak q\'}$ can be generated by $c$ elements. \n\n\nThe conormal module $(I/I^2)_{\\mathfrak q}$ can be generated by $c$ elements over $S_{\\mathfrak q}$. \n\n\nThe conormal module $(I/I^2)_{\\mathfrak q}$ is a free $S_{\\mathfrak q}$-module of rank $c$. \n\n\nThe ideal $I_{\\mathfrak q\'}$ can be generated by a regular sequence in the regular local ring $k[x_1, \\ldots , x_ n]_{\\mathfrak q\'}$. \n\n\n\n   In this case any $c$ elements of $I_{\\mathfrak q\'}$ which generate $I_{\\mathfrak q\'}/\\mathfrak q\'I_{\\mathfrak q\'}$ form a regular sequence in the local ring $k[x_1, \\ldots , x_ n]_{\\mathfrak q\'}$. \n\n    \n]] for example. \n      $\\square$\n    \n"
335,00I1,"lemma isOpenMap_comap_of_hasGoingDown_of_finitePresentation
    [Algebra R S] [Algebra.HasGoingDown R S] [Algebra.FinitePresentation R S] :
    IsOpenMap (comap (algebraMap R S)) := by
  rw [isBasis_basic_opens.isOpenMap_iff]
  rintro _ âŸ¨_, âŸ¨f, rflâŸ©, rflâŸ©
  exact isOpen_of_stableUnderGeneralization_of_isConstructible
    ((basicOpen f).2.stableUnderGeneralization.image
      (Algebra.HasGoingDown.iff_generalizingMap_primeSpectrumComap.mp â€¹_â€º))
    (isConstructible_comap_image (RingHom.finitePresentation_algebraMap.mpr â€¹_â€º)
      isConstructible_basicOpen)
",Formal Proof of Stacks Project Tag 00I1,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Spectrum/Prime/Chevalley.lean#L58-L67,Q27041,,10.41.8,proposition,3.0,"['00HU', '00AO', '0ELQ']","\n  Proposition 10.41.8. Let $R \\to S$ be flat and of finite presentation. Then $\\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R)$ is open. More generally this holds for any ring map $R \\to S$ of finite presentation which satisfies going down. \n\n    \n      Proof.\n      If $R \\to S$ is flat, then $R \\to S$ satisfies going down by Lemma 10.39.19. Thus to prove the lemma we may assume that $R \\to S$ has finite presentation and satisfies going down. \n    \n      Since the standard opens $D(g) \\subset \\mathop{\\mathrm{Spec}}(S)$, $g \\in S$ form a basis for the topology, it suffices to prove that the image of $D(g)$ is open. Recall that $\\mathop{\\mathrm{Spec}}(S_ g) \\to \\mathop{\\mathrm{Spec}}(S)$ is a homeomorphism of $\\mathop{\\mathrm{Spec}}(S_ g)$ onto $D(g)$ (Lemma 10.17.6). Since $S \\to S_ g$ satisfies going down (see above), we see that $R \\to S_ g$ satisfies going down by Lemma 10.41.4. Thus after replacing $S$ by $S_ g$ we see it suffices to prove the image is open. By Chevalley\'s theorem (Theorem 10.29.10) the image is a constructible set $E$. And $E$ is stable under generalization because $R \\to S$ satisfies going down, see Topology, Lemmas 5.19.2 and 5.19.6. Hence $E$ is open by Lemma 10.41.7. \n      $\\square$\n    \n",\n  Proposition 10.41.8. Let $R \\to S$ be flat and of finite presentation. Then $\\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R)$ is open. More generally this holds for any ring map $R \\to S$ of finite presentation which satisfies going down. \n\n    \n,"Proof.\n      If $R \\to S$ is flat, then $R \\to S$ satisfies going down by Lemma 10.39.19. Thus to prove the lemma we may assume that $R \\to S$ has finite presentation and satisfies going down. \n    \n      Since the standard opens $D(g) \\subset \\mathop{\\mathrm{Spec}}(S)$, $g \\in S$ form a basis for the topology, it suffices to prove that the image of $D(g)$ is open. Recall that $\\mathop{\\mathrm{Spec}}(S_ g) \\to \\mathop{\\mathrm{Spec}}(S)$ is a homeomorphism of $\\mathop{\\mathrm{Spec}}(S_ g)$ onto $D(g)$ (Lemma 10.17.6). Since $S \\to S_ g$ satisfies going down (see above), we see that $R \\to S_ g$ satisfies going down by Lemma 10.41.4. Thus after replacing $S$ by $S_ g$ we see it suffices to prove the image is open. By Chevalley\'s theorem (Theorem 10.29.10) the image is a constructible set $E$. And $E$ is stable under generalization because $R \\to S$ satisfies going down, see Topology, Lemmas 5.19.2 and 5.19.6. Hence $E$ is open by Lemma 10.41.7. \n      $\\square$\n    \n"," by
  rw [isBasis_basic_opens.isOpenMap_iff]
  rintro _ âŸ¨_, âŸ¨f, rflâŸ©, rflâŸ©
  exact isOpen_of_stableUnderGeneralization_of_isConstructible
    ((basicOpen f).2.stableUnderGeneralization.image
      (Algebra.HasGoingDown.iff_generalizingMap_primeSpectrumComap.mp â€¹_â€º))
    (isConstructible_comap_image (RingHom.finitePresentation_algebraMap.mpr â€¹_â€º)
      isConstructible_basicOpen)
","lemma isOpenMap_comap_of_hasGoingDown_of_finitePresentation
    [Algebra R S] [Algebra.HasGoingDown R S] [Algebra.FinitePresentation R S] :
    IsOpenMap (comap (algebraMap R S)) ","Proof.\n      If $R \\to S$ is flat, then $R \\to S$ satisfies going down by Lemma 10.39.19 [[\n  Lemma 10.39.19. Let $R \\to S$ be flat. Let $\\mathfrak p \\subset \\mathfrak p\'$ be primes of $R$. Let $\\mathfrak q\' \\subset S$ be a prime of $S$ mapping to $\\mathfrak p\'$. Then there exists a prime $\\mathfrak q \\subset \\mathfrak q\'$ mapping to $\\mathfrak p$. \n\n    \n]]. Thus to prove the lemma we may assume that $R \\to S$ has finite presentation and satisfies going down. \n    \n      Since the standard opens $D(g) \\subset \\mathop{\\mathrm{Spec}}(S)$, $g \\in S$ form a basis for the topology, it suffices to prove that the image of $D(g)$ is open. Recall that $\\mathop{\\mathrm{Spec}}(S_ g) \\to \\mathop{\\mathrm{Spec}}(S)$ is a homeomorphism of $\\mathop{\\mathrm{Spec}}(S_ g)$ onto $D(g)$ (Lemma 10.17.6 [[\n  Lemma 10.17.6. Let $R$ be a ring. Let $f \\in R$. The map $R \\to R_ f$ induces via the functoriality of $\\mathop{\\mathrm{Spec}}$ a homeomorphism \n  \n  \\[  \\mathop{\\mathrm{Spec}}(R_ f) \\longrightarrow D(f) \\subset \\mathop{\\mathrm{Spec}}(R).  \\]\n\n   The inverse is given by $\\mathfrak p \\mapsto \\mathfrak p \\cdot R_ f$. \n\n    \n]]). Since $S \\to S_ g$ satisfies going down (see above), we see that $R \\to S_ g$ satisfies going down by Lemma 10.41.4 [[\n  Lemma 10.41.4. Suppose $R \\to S$ and $S \\to T$ are ring maps satisfying going down. Then so does $R \\to T$. Similarly for going up. \n\n    \n]]. Thus after replacing $S$ by $S_ g$ we see it suffices to prove the image is open. By Chevalley\'s theorem (Theorem 10.29.10 [[\n  Theorem 10.29.10 (Chevalley\'s Theorem).  Suppose that $R \\to S$ is of finite presentation. The image of a constructible subset of $\\mathop{\\mathrm{Spec}}(S)$ in $\\mathop{\\mathrm{Spec}}(R)$ is constructible. \n\n    \n]]) the image is a constructible set $E$. And $E$ is stable under generalization because $R \\to S$ satisfies going down, see Topology, Lemmas 5.19.2 [[\n  Lemma 5.19.2. Let $X$ be a topological space. \n  \n  \nAny closed subset of $X$ is stable under specialization. \n\n\nAny open subset of $X$ is stable under generalization. \n\n\nA subset $T \\subset X$ is stable under specialization if and only if the complement $T^ c$ is stable under generalization. \n\n\n\n\n    \n]] and 5.19.6 [[\n  Lemma 5.19.6. Let $f : X \\to Y$ be a continuous map of topological spaces. \n  \n  \nIf specializations lift along $f$, and if $T \\subset X$ is stable under specialization, then $f(T) \\subset Y$ is stable under specialization. \n\n\nIf generalizations lift along $f$, and if $T \\subset X$ is stable under generalization, then $f(T) \\subset Y$ is stable under generalization. \n\n\n\n\n    \n]]. Hence $E$ is open by Lemma 10.41.7 [[\n  Lemma 10.41.7. Let $R$ be a ring. Let $E \\subset \\mathop{\\mathrm{Spec}}(R)$ be a constructible subset. \n  \n  \nIf $E$ is stable under specialization, then $E$ is closed. \n\n\nIf $E$ is stable under generalization, then $E$ is open. \n\n\n\n\n    \n]]. \n      $\\square$\n    \n"
336,00F8,"-- TODO: show that the constructed `f` is of finite presentation
lemma exists_range_eq_of_isConstructible {R : Type u} [CommRing R]
    {s : Set (PrimeSpectrum R)} (hs : IsConstructible s) :
    âˆƒ (S : Type u) (_ : CommRing S) (f : R â†’+* S), Set.range (comap f) = s := by
  obtain âŸ¨s, rflâŸ© := exists_constructibleSetData_iff.mpr hs
  refine âŸ¨Î  i : s, Localization.Away (Ideal.Quotient.mk (Ideal.span (Set.range i.1.g)) i.1.f),
    inferInstance, algebraMap _ _, ?_âŸ©
  rw [â† iUnion_range_comap_comp_evalRingHom, ConstructibleSetData.toSet]
  simp_rw [â† Finset.mem_coe, Set.biUnion_eq_iUnion]
  congr! with _ _ C
  let I := Ideal.span (Set.range C.1.g)
  let f := Ideal.Quotient.mk I C.1.f
  trans comap (Ideal.Quotient.mk I) '' (Set.range (comap (algebraMap _ (Localization.Away f))))
  Â· rw [â† Set.range_comp]; rfl
  Â· rw [localization_away_comap_range _ f, â† comap_basicOpen, TopologicalSpace.Opens.coe_comap,
      ContinuousMap.coe_mk, Set.image_preimage_eq_inter_range,
      range_comap_of_surjective _ _ Ideal.Quotient.mk_surjective, BasicConstructibleSetData.toSet,
      Set.diff_eq_compl_inter, basicOpen_eq_zeroLocus_compl, Ideal.mk_ker, zeroLocus_span]
",Formal Proof of Stacks Project Tag 00F8,without the finite presentation part,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Spectrum/Prime/ConstructibleSet.lean#L141-L158,Q27041,,10.29.4,lemma,3.0,"['00F5', '00AO', '0ELQ']","\n  Lemma 10.29.4. Let $R$ be a ring and let $T \\subset \\mathop{\\mathrm{Spec}}(R)$ be constructible. Then there exists a ring map $R \\to S$ of finite presentation such that $T$ is the image of $\\mathop{\\mathrm{Spec}}(S)$ in $\\mathop{\\mathrm{Spec}}(R)$. \n\n    \n      Proof.\n      The spectrum of a finite product of rings is the disjoint union of the spectra, see Lemma 10.21.2. Hence if $T = T_1 \\cup T_2$ and the result holds for $T_1$ and $T_2$, then the result holds for $T$. By Lemma 10.29.3 we may assume that $T = D(f) \\cap V(g_1, \\ldots , g_ m)$. In this case $T$ is the image of the map $\\mathop{\\mathrm{Spec}}((R/(g_1, \\ldots , g_ m))_ f) \\to \\mathop{\\mathrm{Spec}}(R)$, see Lemmas 10.17.6 and 10.17.7. \n      $\\square$\n    \n",\n  Lemma 10.29.4. Let $R$ be a ring and let $T \\subset \\mathop{\\mathrm{Spec}}(R)$ be constructible. Then there exists a ring map $R \\to S$ of finite presentation such that $T$ is the image of $\\mathop{\\mathrm{Spec}}(S)$ in $\\mathop{\\mathrm{Spec}}(R)$. \n\n    \n,"Proof.\n      The spectrum of a finite product of rings is the disjoint union of the spectra, see Lemma 10.21.2. Hence if $T = T_1 \\cup T_2$ and the result holds for $T_1$ and $T_2$, then the result holds for $T$. By Lemma 10.29.3 we may assume that $T = D(f) \\cap V(g_1, \\ldots , g_ m)$. In this case $T$ is the image of the map $\\mathop{\\mathrm{Spec}}((R/(g_1, \\ldots , g_ m))_ f) \\to \\mathop{\\mathrm{Spec}}(R)$, see Lemmas 10.17.6 and 10.17.7. \n      $\\square$\n    \n"," by
  obtain âŸ¨s, rflâŸ© := exists_constructibleSetData_iff.mpr hs
  refine âŸ¨Î  i : s, Localization.Away (Ideal.Quotient.mk (Ideal.span (Set.range i.1.g)) i.1.f),
    inferInstance, algebraMap _ _, ?_âŸ©
  rw [â† iUnion_range_comap_comp_evalRingHom, ConstructibleSetData.toSet]
  simp_rw [â† Finset.mem_coe, Set.biUnion_eq_iUnion]
  congr! with _ _ C
  let I := Ideal.span (Set.range C.1.g)
  let f := Ideal.Quotient.mk I C.1.f
  trans comap (Ideal.Quotient.mk I) '' (Set.range (comap (algebraMap _ (Localization.Away f))))
  Â· rw [â† Set.range_comp]; rfl
  Â· rw [localization_away_comap_range _ f, â† comap_basicOpen, TopologicalSpace.Opens.coe_comap,
      ContinuousMap.coe_mk, Set.image_preimage_eq_inter_range,
      range_comap_of_surjective _ _ Ideal.Quotient.mk_surjective, BasicConstructibleSetData.toSet,
      Set.diff_eq_compl_inter, basicOpen_eq_zeroLocus_compl, Ideal.mk_ker, zeroLocus_span]
","-- TODO: show that the constructed `f` is of finite presentation
lemma exists_range_eq_of_isConstructible {R : Type u} [CommRing R]
    {s : Set (PrimeSpectrum R)} (hs : IsConstructible s) :
    âˆƒ (S : Type u) (_ : CommRing S) (f : R â†’+* S), Set.range (comap f) = s ","Proof.\n      The spectrum of a finite product of rings is the disjoint union of the spectra, see Lemma 10.21.2 [[\n  Lemma 10.21.2. Let $R_1$ and $R_2$ be rings. Let $R = R_1 \\times R_2$. The maps $R \\to R_1$, $(x, y) \\mapsto x$ and $R \\to R_2$, $(x, y) \\mapsto y$ induce continuous maps $\\mathop{\\mathrm{Spec}}(R_1) \\to \\mathop{\\mathrm{Spec}}(R)$ and $\\mathop{\\mathrm{Spec}}(R_2) \\to \\mathop{\\mathrm{Spec}}(R)$. The induced map \n  \n  \\[  \\mathop{\\mathrm{Spec}}(R_1) \\amalg \\mathop{\\mathrm{Spec}}(R_2) \\longrightarrow \\mathop{\\mathrm{Spec}}(R)  \\]\n\n   is a homeomorphism. In other words, the spectrum of $R = R_1\\times R_2$ is the disjoint union of the spectrum of $R_1$ and the spectrum of $R_2$. \n\n    \n]]. Hence if $T = T_1 \\cup T_2$ and the result holds for $T_1$ and $T_2$, then the result holds for $T$. By Lemma 10.29.3 [[\n  Lemma 10.29.3. Let $R$ be a ring. A subset of $\\mathop{\\mathrm{Spec}}(R)$ is constructible if and only if it can be written as a finite union of subsets of the form $D(f) \\cap V(g_1, \\ldots , g_ m)$ for $f, g_1, \\ldots , g_ m \\in R$. \n\n    \n]] we may assume that $T = D(f) \\cap V(g_1, \\ldots , g_ m)$. In this case $T$ is the image of the map $\\mathop{\\mathrm{Spec}}((R/(g_1, \\ldots , g_ m))_ f) \\to \\mathop{\\mathrm{Spec}}(R)$, see Lemmas 10.17.6 [[\n  Lemma 10.17.6. Let $R$ be a ring. Let $f \\in R$. The map $R \\to R_ f$ induces via the functoriality of $\\mathop{\\mathrm{Spec}}$ a homeomorphism \n  \n  \\[  \\mathop{\\mathrm{Spec}}(R_ f) \\longrightarrow D(f) \\subset \\mathop{\\mathrm{Spec}}(R).  \\]\n\n   The inverse is given by $\\mathfrak p \\mapsto \\mathfrak p \\cdot R_ f$. \n\n    \n]] and 10.17.7 [[\n  Lemma 10.17.7. Let $R$ be a ring. Let $I \\subset R$ be an ideal. The map $R \\to R/I$ induces via the functoriality of $\\mathop{\\mathrm{Spec}}$ a homeomorphism \n  \n  \\[  \\mathop{\\mathrm{Spec}}(R/I) \\longrightarrow V(I) \\subset \\mathop{\\mathrm{Spec}}(R).  \\]\n\n   The inverse is given by $\\mathfrak p \\mapsto \\mathfrak p / I$. \n\n    \n]]. \n      $\\square$\n    \n"
337,00I0,"lemma isOpen_of_stableUnderGeneralization_of_isConstructible {R : Type*} [CommRing R]
    {s : Set (PrimeSpectrum R)} (hs : StableUnderGeneralization s) (hs' : IsConstructible s) :
    IsOpen s := by
  rw [â† isClosed_compl_iff]
  exact isClosed_of_stableUnderSpecialization_of_isConstructible hs.compl hs'.compl
",Formal Proof of Stacks Project Tag 00I0,(1),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Spectrum/Prime/ConstructibleSet.lean#L168-L172,Q27041,,10.41.7,lemma,3.0,"['00HU', '00AO', '0ELQ']","\n  Lemma 10.41.7. Let $R$ be a ring. Let $E \\subset \\mathop{\\mathrm{Spec}}(R)$ be a constructible subset. \n  \n  \nIf $E$ is stable under specialization, then $E$ is closed. \n\n\nIf $E$ is stable under generalization, then $E$ is open. \n\n\n\n\n    \n      Proof.\n      First proof. The first assertion follows from Lemma 10.41.5 combined with Lemma 10.29.4. The second follows because the complement of a constructible set is constructible (see Topology, Lemma 5.15.2), the first part of the lemma and Topology, Lemma 5.19.2. \n    \n      Second proof. Since $\\mathop{\\mathrm{Spec}}(R)$ is a spectral space by Lemma 10.26.2 this is a special case of Topology, Lemma 5.23.6. \n      $\\square$\n    \n","\n  Lemma 10.41.7. Let $R$ be a ring. Let $E \\subset \\mathop{\\mathrm{Spec}}(R)$ be a constructible subset. \n  \n  \nIf $E$ is stable under specialization, then $E$ is closed. \n\n\nIf $E$ is stable under generalization, then $E$ is open. \n\n\n\n\n    \n","Proof.\n      First proof. The first assertion follows from Lemma 10.41.5 combined with Lemma 10.29.4. The second follows because the complement of a constructible set is constructible (see Topology, Lemma 5.15.2), the first part of the lemma and Topology, Lemma 5.19.2. \n    \n      Second proof. Since $\\mathop{\\mathrm{Spec}}(R)$ is a spectral space by Lemma 10.26.2 this is a special case of Topology, Lemma 5.23.6. \n      $\\square$\n    \n"," by
  rw [â† isClosed_compl_iff]
  exact isClosed_of_stableUnderSpecialization_of_isConstructible hs.compl hs'.compl
","lemma isOpen_of_stableUnderGeneralization_of_isConstructible {R : Type*} [CommRing R]
    {s : Set (PrimeSpectrum R)} (hs : StableUnderGeneralization s) (hs' : IsConstructible s) :
    IsOpen s ","Proof.\n      First proof. The first assertion follows from Lemma 10.41.5 [[\n  Lemma 10.41.5. Let $R \\to S$ be a ring map. Let $T \\subset \\mathop{\\mathrm{Spec}}(R)$ be the image of $\\mathop{\\mathrm{Spec}}(S)$. If $T$ is stable under specialization, then $T$ is closed. \n\n    \n]] combined with Lemma 10.29.4 [[\n  Lemma 10.29.4. Let $R$ be a ring and let $T \\subset \\mathop{\\mathrm{Spec}}(R)$ be constructible. Then there exists a ring map $R \\to S$ of finite presentation such that $T$ is the image of $\\mathop{\\mathrm{Spec}}(S)$ in $\\mathop{\\mathrm{Spec}}(R)$. \n\n    \n]]. The second follows because the complement of a constructible set is constructible (see Topology, Lemma 5.15.2 [[\n  Lemma 5.15.2. The collection of constructible sets is closed under finite intersections, finite unions and complements. \n\n    \n]]), the first part of the lemma and Topology, Lemma 5.19.2 [[\n  Lemma 5.19.2. Let $X$ be a topological space. \n  \n  \nAny closed subset of $X$ is stable under specialization. \n\n\nAny open subset of $X$ is stable under generalization. \n\n\nA subset $T \\subset X$ is stable under specialization if and only if the complement $T^ c$ is stable under generalization. \n\n\n\n\n    \n]]. \n    \n      Second proof. Since $\\mathop{\\mathrm{Spec}}(R)$ is a spectral space by Lemma 10.26.2 [[\n  Lemma 10.26.2. The spectrum of a ring is a spectral space, see Topology, Definition 5.23.1. \n\n    \n]] this is a special case of Topology, Lemma 5.23.6 [[\n  Lemma 5.23.6. Let $X$ be a spectral space. Let $E \\subset X$ be a subset closed in the constructible topology (for example constructible). \n  \n  \nIf $x \\in \\overline{E}$, then $x$ is the specialization of a point of $E$. \n\n\nIf $E$ is stable under specialization, then $E$ is closed. \n\n\nIf $E\' \\subset X$ is open in the constructible topology (for example constructible) and stable under generalization, then $E\'$ is open. \n\n\n\n\n    \n]]. \n      $\\square$\n    \n"
338,0BR8,"lemma PrimeSpectrum.isHomeomorph_comap (f : R â†’+* S) (H : âˆ€ (x : S), âˆƒ n > 0, x ^ n âˆˆ f.range)
    (hker : RingHom.ker f â‰¤ nilradical R) : IsHomeomorph (comap f) := by
  have h1 : Function.Injective (comap f) := by
    intro q q' hqq'
    ext x
    obtain âŸ¨n, hn, y, hyâŸ© := H x
    rw [â† q.2.pow_mem_iff_mem _ hn, â† q'.2.pow_mem_iff_mem _ hn, â† hy]
    rw [PrimeSpectrum.ext_iff, SetLike.ext_iff] at hqq'
    apply hqq'
  have hint : f.kerLift.IsIntegral := fun x â†¦
    have âŸ¨n, hn, y, hyâŸ© := H x
    let _ := f.kerLift.toAlgebra
    IsIntegral.of_pow hn (hy â–¸ f.kerLift.isIntegralElem_map (x := âŸ¦yâŸ§))
  have hbij : Function.Bijective (comap f) :=
    âŸ¨h1, (comap_quotientMk_bijective_of_le_nilradical hker).2.comp <|
      hint.comap_surjective f.kerLift_injectiveâŸ©
  refine âŸ¨continuous_comap f, ?_, h1, hbij.2âŸ©
  rw [isTopologicalBasis_basic_opens.isOpenMap_iff]
  rintro - âŸ¨s, rflâŸ©
  obtain âŸ¨n, hn, r, hrâŸ© := H s
  have : (comap f) '' (basicOpen s) = basicOpen r :=
    (Set.eq_preimage_iff_image_eq hbij).mp <| by rw [â† basicOpen_pow _ n hn, â† hr]; rfl
  exact this â–¸ isOpen_basicOpen
",Formal Proof of Stacks Project Tag 0BR8,Homeomorphism part,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Spectrum/Prime/Homeomorph.lean#L39-L61,Q27041,,10.46.3,lemma,3.0,"['0BR5', '00AO', '0ELQ']","\n  Lemma 10.46.3. Let $\\varphi : R \\to S$ be a ring map. If \n  \n  \nfor any $x \\in S$ there exists $n > 0$ such that $x^ n$ is in the image of $\\varphi $, and \n\n\n$\\mathop{\\mathrm{Ker}}(\\varphi )$ is locally nilpotent, \n\n\n\n   then $\\varphi $ induces a homeomorphism on spectra and induces residue field extensions satisfying the equivalent conditions of Lemma 10.46.2. \n\n    \n      Proof.\n      Assume (1) and (2). Let $\\mathfrak q, \\mathfrak q\'$ be primes of $S$ lying over the same prime ideal $\\mathfrak p$ of $R$. Suppose $x \\in S$ with $x \\in \\mathfrak q$, $x \\not\\in \\mathfrak q\'$. Then $x^ n \\in \\mathfrak q$ and $x^ n \\not\\in \\mathfrak q\'$ for all $n > 0$. If $x^ n = \\varphi (y)$ with $y \\in R$ for some $n > 0$ then \n    \n      \n  \\[  x^ n \\in \\mathfrak q \\Rightarrow y \\in \\mathfrak p \\Rightarrow x^ n \\in \\mathfrak q\'  \\]\n\n    \n       which is a contradiction. Hence there does not exist an $x$ as above and we conclude that $\\mathfrak q = \\mathfrak q\'$, i.e., the map on spectra is injective. By assumption (2) the kernel $I = \\mathop{\\mathrm{Ker}}(\\varphi )$ is contained in every prime, hence $\\mathop{\\mathrm{Spec}}(R) = \\mathop{\\mathrm{Spec}}(R/I)$ as topological spaces. As the induced map $R/I \\to S$ is integral by assumption (1) Lemma 10.36.17 shows that $\\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R/I)$ is surjective. Combining the above we see that $\\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R)$ is bijective. If $x \\in S$ is arbitrary, and we pick $y \\in R$ such that $\\varphi (y) = x^ n$ for some $n > 0$, then we see that the open $D(x) \\subset \\mathop{\\mathrm{Spec}}(S)$ corresponds to the open $D(y) \\subset \\mathop{\\mathrm{Spec}}(R)$ via the bijection above. Hence we see that the map $\\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R)$ is a homeomorphism. \n    \n      To see the statement on residue fields, let $\\mathfrak q \\subset S$ be a prime lying over a prime ideal $\\mathfrak p \\subset R$. Let $x \\in \\kappa (\\mathfrak q)$. If we think of $\\kappa (\\mathfrak q)$ as the residue field of the local ring $S_\\mathfrak q$, then we see that $x$ is the image of some $y/z \\in S_\\mathfrak q$ with $y \\in S$, $z \\in S$, $z \\not\\in \\mathfrak q$. Choose $n, m > 0$ such that $y^ n, z^ m$ are in the image of $\\varphi $. Then $x^{nm}$ is the residue of $(y/z)^{nm} = (y^ n)^ m/(z^ m)^ n$ which is in the image of $R_\\mathfrak p \\to S_\\mathfrak q$. Hence $x^{nm}$ is in the image of $\\kappa (\\mathfrak p) \\to \\kappa (\\mathfrak q)$. \n      $\\square$\n    \n","\n  Lemma 10.46.3. Let $\\varphi : R \\to S$ be a ring map. If \n  \n  \nfor any $x \\in S$ there exists $n > 0$ such that $x^ n$ is in the image of $\\varphi $, and \n\n\n$\\mathop{\\mathrm{Ker}}(\\varphi )$ is locally nilpotent, \n\n\n\n   then $\\varphi $ induces a homeomorphism on spectra and induces residue field extensions satisfying the equivalent conditions of Lemma 10.46.2. \n\n    \n","Proof.\n      Assume (1) and (2). Let $\\mathfrak q, \\mathfrak q\'$ be primes of $S$ lying over the same prime ideal $\\mathfrak p$ of $R$. Suppose $x \\in S$ with $x \\in \\mathfrak q$, $x \\not\\in \\mathfrak q\'$. Then $x^ n \\in \\mathfrak q$ and $x^ n \\not\\in \\mathfrak q\'$ for all $n > 0$. If $x^ n = \\varphi (y)$ with $y \\in R$ for some $n > 0$ then \n    \n      \n  \\[  x^ n \\in \\mathfrak q \\Rightarrow y \\in \\mathfrak p \\Rightarrow x^ n \\in \\mathfrak q\'  \\]\n\n    \n       which is a contradiction. Hence there does not exist an $x$ as above and we conclude that $\\mathfrak q = \\mathfrak q\'$, i.e., the map on spectra is injective. By assumption (2) the kernel $I = \\mathop{\\mathrm{Ker}}(\\varphi )$ is contained in every prime, hence $\\mathop{\\mathrm{Spec}}(R) = \\mathop{\\mathrm{Spec}}(R/I)$ as topological spaces. As the induced map $R/I \\to S$ is integral by assumption (1) Lemma 10.36.17 shows that $\\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R/I)$ is surjective. Combining the above we see that $\\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R)$ is bijective. If $x \\in S$ is arbitrary, and we pick $y \\in R$ such that $\\varphi (y) = x^ n$ for some $n > 0$, then we see that the open $D(x) \\subset \\mathop{\\mathrm{Spec}}(S)$ corresponds to the open $D(y) \\subset \\mathop{\\mathrm{Spec}}(R)$ via the bijection above. Hence we see that the map $\\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R)$ is a homeomorphism. \n    \n      To see the statement on residue fields, let $\\mathfrak q \\subset S$ be a prime lying over a prime ideal $\\mathfrak p \\subset R$. Let $x \\in \\kappa (\\mathfrak q)$. If we think of $\\kappa (\\mathfrak q)$ as the residue field of the local ring $S_\\mathfrak q$, then we see that $x$ is the image of some $y/z \\in S_\\mathfrak q$ with $y \\in S$, $z \\in S$, $z \\not\\in \\mathfrak q$. Choose $n, m > 0$ such that $y^ n, z^ m$ are in the image of $\\varphi $. Then $x^{nm}$ is the residue of $(y/z)^{nm} = (y^ n)^ m/(z^ m)^ n$ which is in the image of $R_\\mathfrak p \\to S_\\mathfrak q$. Hence $x^{nm}$ is in the image of $\\kappa (\\mathfrak p) \\to \\kappa (\\mathfrak q)$. \n      $\\square$\n    \n"," by
  have h1 : Function.Injective (comap f) := by
    intro q q' hqq'
    ext x
    obtain âŸ¨n, hn, y, hyâŸ© := H x
    rw [â† q.2.pow_mem_iff_mem _ hn, â† q'.2.pow_mem_iff_mem _ hn, â† hy]
    rw [PrimeSpectrum.ext_iff, SetLike.ext_iff] at hqq'
    apply hqq'
  have hint : f.kerLift.IsIntegral := fun x â†¦
    have âŸ¨n, hn, y, hyâŸ© := H x
    let _ := f.kerLift.toAlgebra
    IsIntegral.of_pow hn (hy â–¸ f.kerLift.isIntegralElem_map (x := âŸ¦yâŸ§))
  have hbij : Function.Bijective (comap f) :=
    âŸ¨h1, (comap_quotientMk_bijective_of_le_nilradical hker).2.comp <|
      hint.comap_surjective f.kerLift_injectiveâŸ©
  refine âŸ¨continuous_comap f, ?_, h1, hbij.2âŸ©
  rw [isTopologicalBasis_basic_opens.isOpenMap_iff]
  rintro - âŸ¨s, rflâŸ©
  obtain âŸ¨n, hn, r, hrâŸ© := H s
  have : (comap f) '' (basicOpen s) = basicOpen r :=
    (Set.eq_preimage_iff_image_eq hbij).mp <| by rw [â† basicOpen_pow _ n hn, â† hr]; rfl
  exact this â–¸ isOpen_basicOpen
","lemma PrimeSpectrum.isHomeomorph_comap (f : R â†’+* S) (H : âˆ€ (x : S), âˆƒ n > 0, x ^ n âˆˆ f.range)
    (hker : RingHom.ker f â‰¤ nilradical R) : IsHomeomorph (comap f) ","Proof.\n      Assume (1) and (2). Let $\\mathfrak q, \\mathfrak q\'$ be primes of $S$ lying over the same prime ideal $\\mathfrak p$ of $R$. Suppose $x \\in S$ with $x \\in \\mathfrak q$, $x \\not\\in \\mathfrak q\'$. Then $x^ n \\in \\mathfrak q$ and $x^ n \\not\\in \\mathfrak q\'$ for all $n > 0$. If $x^ n = \\varphi (y)$ with $y \\in R$ for some $n > 0$ then \n    \n      \n  \\[  x^ n \\in \\mathfrak q \\Rightarrow y \\in \\mathfrak p \\Rightarrow x^ n \\in \\mathfrak q\'  \\]\n\n    \n       which is a contradiction. Hence there does not exist an $x$ as above and we conclude that $\\mathfrak q = \\mathfrak q\'$, i.e., the map on spectra is injective. By assumption (2) the kernel $I = \\mathop{\\mathrm{Ker}}(\\varphi )$ is contained in every prime, hence $\\mathop{\\mathrm{Spec}}(R) = \\mathop{\\mathrm{Spec}}(R/I)$ as topological spaces. As the induced map $R/I \\to S$ is integral by assumption (1) Lemma 10.36.17 [[\n  Lemma 10.36.17. Suppose that $R \\to S$ is an integral ring extension with $R \\subset S$. Then $\\varphi : \\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R)$ is surjective. \n\n    \n]] shows that $\\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R/I)$ is surjective. Combining the above we see that $\\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R)$ is bijective. If $x \\in S$ is arbitrary, and we pick $y \\in R$ such that $\\varphi (y) = x^ n$ for some $n > 0$, then we see that the open $D(x) \\subset \\mathop{\\mathrm{Spec}}(S)$ corresponds to the open $D(y) \\subset \\mathop{\\mathrm{Spec}}(R)$ via the bijection above. Hence we see that the map $\\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R)$ is a homeomorphism. \n    \n      To see the statement on residue fields, let $\\mathfrak q \\subset S$ be a prime lying over a prime ideal $\\mathfrak p \\subset R$. Let $x \\in \\kappa (\\mathfrak q)$. If we think of $\\kappa (\\mathfrak q)$ as the residue field of the local ring $S_\\mathfrak q$, then we see that $x$ is the image of some $y/z \\in S_\\mathfrak q$ with $y \\in S$, $z \\in S$, $z \\not\\in \\mathfrak q$. Choose $n, m > 0$ such that $y^ n, z^ m$ are in the image of $\\varphi $. Then $x^{nm}$ is the residue of $(y/z)^{nm} = (y^ n)^ m/(z^ m)^ n$ which is in the image of $R_\\mathfrak p \\to S_\\mathfrak q$. Hence $x^{nm}$ is in the image of $\\kappa (\\mathfrak p) \\to \\kappa (\\mathfrak q)$. \n      $\\square$\n    \n"
339,0BRA,"lemma PrimeSpectrum.isHomeomorph_comap_of_isPurelyInseparable [IsPurelyInseparable k K] :
    IsHomeomorph (comap <| algebraMap R (R âŠ—[k] K)) := by
  let q := ringExpChar k
  refine isHomeomorph_comap _ (IsPurelyInseparable.exists_pow_mem_range_tensorProduct) ?_
  convert bot_le
  rw [â† RingHom.injective_iff_ker_eq_bot]
  exact Algebra.TensorProduct.includeLeft_injective (S := R) (algebraMap k K).injective
",Formal Proof of Stacks Project Tag 0BRA,Special case for purely inseparable field extensions,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Spectrum/Prime/Homeomorph.lean#L65-L71,Q27041,,10.46.7,lemma,3.0,"['0BR5', '00AO', '0ELQ']","\n  Lemma 10.46.7. Let $\\varphi : R \\to S$ be a ring map. Let $p$ be a prime number. Assume \n  \n  \n$S$ is generated as an $R$-algebra by elements $x$ such that there exists an $n > 0$ with $x^{p^ n} \\in \\varphi (R)$ and $p^ nx \\in \\varphi (R)$, and \n\n\n$\\mathop{\\mathrm{Ker}}(\\varphi )$ is locally nilpotent, \n\n\n\n   Then $\\varphi $ induces a homeomorphism of spectra and induces residue field extensions satisfying the equivalent conditions of Lemma 10.46.6. For any ring map $R \\to R\'$ the ring map $R\' \\to R\' \\otimes _ R S$ also satisfies (a) and (b). \n\n    \n      Proof.\n      Assume (a) and (b). Note that (b) is equivalent to condition (2) of Lemma 10.46.3. Let $T \\subset S$ be the set of elements $x \\in S$ such that there exists an integer $n > 0$ such that $x^{p^ n} , p^ n x \\in \\varphi (R)$. We claim that $T = S$. This will prove that condition (1) of Lemma 10.46.3 holds and hence $\\varphi $ induces a homeomorphism on spectra. By assumption (a) it suffices to show that $T \\subset S$ is an $R$-sub algebra. If $x \\in T$ and $y \\in R$, then it is clear that $yx \\in T$. Suppose $x, y \\in T$ and $n, m > 0$ such that $x^{p^ n}, y^{p^ m}, p^ n x, p^ m y \\in \\varphi (R)$. Then $(xy)^{p^{n + m}}, p^{n + m}xy \\in \\varphi (R)$ hence $xy \\in T$. We have $x + y \\in T$ by Lemma 10.46.5 and the claim is proved. \n    \n      Since $\\varphi $ induces a homeomorphism on spectra, it is in particular surjective on spectra which is a property preserved under any base change, see Lemma 10.30.3. Therefore for any $R \\to R\'$ the kernel of the ring map $R\' \\to R\' \\otimes _ R S$ consists of nilpotent elements, see Lemma 10.30.6, in other words (b) holds for $R\' \\to R\' \\otimes _ R S$. It is clear that (a) is preserved under base change. Finally, the condition on residue fields follows from (a) as generators for $S$ as an $R$-algebra map to generators for the residue field extensions. \n      $\\square$\n    \n","\n  Lemma 10.46.7. Let $\\varphi : R \\to S$ be a ring map. Let $p$ be a prime number. Assume \n  \n  \n$S$ is generated as an $R$-algebra by elements $x$ such that there exists an $n > 0$ with $x^{p^ n} \\in \\varphi (R)$ and $p^ nx \\in \\varphi (R)$, and \n\n\n$\\mathop{\\mathrm{Ker}}(\\varphi )$ is locally nilpotent, \n\n\n\n   Then $\\varphi $ induces a homeomorphism of spectra and induces residue field extensions satisfying the equivalent conditions of Lemma 10.46.6. For any ring map $R \\to R\'$ the ring map $R\' \\to R\' \\otimes _ R S$ also satisfies (a) and (b). \n\n    \n","Proof.\n      Assume (a) and (b). Note that (b) is equivalent to condition (2) of Lemma 10.46.3. Let $T \\subset S$ be the set of elements $x \\in S$ such that there exists an integer $n > 0$ such that $x^{p^ n} , p^ n x \\in \\varphi (R)$. We claim that $T = S$. This will prove that condition (1) of Lemma 10.46.3 holds and hence $\\varphi $ induces a homeomorphism on spectra. By assumption (a) it suffices to show that $T \\subset S$ is an $R$-sub algebra. If $x \\in T$ and $y \\in R$, then it is clear that $yx \\in T$. Suppose $x, y \\in T$ and $n, m > 0$ such that $x^{p^ n}, y^{p^ m}, p^ n x, p^ m y \\in \\varphi (R)$. Then $(xy)^{p^{n + m}}, p^{n + m}xy \\in \\varphi (R)$ hence $xy \\in T$. We have $x + y \\in T$ by Lemma 10.46.5 and the claim is proved. \n    \n      Since $\\varphi $ induces a homeomorphism on spectra, it is in particular surjective on spectra which is a property preserved under any base change, see Lemma 10.30.3. Therefore for any $R \\to R\'$ the kernel of the ring map $R\' \\to R\' \\otimes _ R S$ consists of nilpotent elements, see Lemma 10.30.6, in other words (b) holds for $R\' \\to R\' \\otimes _ R S$. It is clear that (a) is preserved under base change. Finally, the condition on residue fields follows from (a) as generators for $S$ as an $R$-algebra map to generators for the residue field extensions. \n      $\\square$\n    \n"," by
  let q := ringExpChar k
  refine isHomeomorph_comap _ (IsPurelyInseparable.exists_pow_mem_range_tensorProduct) ?_
  convert bot_le
  rw [â† RingHom.injective_iff_ker_eq_bot]
  exact Algebra.TensorProduct.includeLeft_injective (S := R) (algebraMap k K).injective
","lemma PrimeSpectrum.isHomeomorph_comap_of_isPurelyInseparable [IsPurelyInseparable k K] :
    IsHomeomorph (comap <| algebraMap R (R âŠ—[k] K)) ","Proof.\n      Assume (a) and (b). Note that (b) is equivalent to condition (2) of Lemma 10.46.3 [[\n  Lemma 10.46.3. Let $\\varphi : R \\to S$ be a ring map. If \n  \n  \nfor any $x \\in S$ there exists $n > 0$ such that $x^ n$ is in the image of $\\varphi $, and \n\n\n$\\mathop{\\mathrm{Ker}}(\\varphi )$ is locally nilpotent, \n\n\n\n   then $\\varphi $ induces a homeomorphism on spectra and induces residue field extensions satisfying the equivalent conditions of Lemma 10.46.2. \n\n    \n]]. Let $T \\subset S$ be the set of elements $x \\in S$ such that there exists an integer $n > 0$ such that $x^{p^ n} , p^ n x \\in \\varphi (R)$. We claim that $T = S$. This will prove that condition (1) of Lemma 10.46.3 [[\n  Lemma 10.46.3. Let $\\varphi : R \\to S$ be a ring map. If \n  \n  \nfor any $x \\in S$ there exists $n > 0$ such that $x^ n$ is in the image of $\\varphi $, and \n\n\n$\\mathop{\\mathrm{Ker}}(\\varphi )$ is locally nilpotent, \n\n\n\n   then $\\varphi $ induces a homeomorphism on spectra and induces residue field extensions satisfying the equivalent conditions of Lemma 10.46.2. \n\n    \n]] holds and hence $\\varphi $ induces a homeomorphism on spectra. By assumption (a) it suffices to show that $T \\subset S$ is an $R$-sub algebra. If $x \\in T$ and $y \\in R$, then it is clear that $yx \\in T$. Suppose $x, y \\in T$ and $n, m > 0$ such that $x^{p^ n}, y^{p^ m}, p^ n x, p^ m y \\in \\varphi (R)$. Then $(xy)^{p^{n + m}}, p^{n + m}xy \\in \\varphi (R)$ hence $xy \\in T$. We have $x + y \\in T$ by Lemma 10.46.5 [[\n  Lemma 10.46.5. Let $p$ be a prime number. Let $n, m > 0$ be two integers. There exists an integer $a$ such that $(x + y)^{p^ a}, p^ a(x + y) \\in \\mathbf{Z}[x^{p^ n}, p^ nx, y^{p^ m}, p^ my]$. \n\n    \n]] and the claim is proved. \n    \n      Since $\\varphi $ induces a homeomorphism on spectra, it is in particular surjective on spectra which is a property preserved under any base change, see Lemma 10.30.3 [[\n  Lemma 10.30.3. Let $\\varphi : R \\to S$ be a ring map. The following are equivalent: \n  \n  \nThe map $\\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R)$ is surjective. \n\n\nFor any ideal $I \\subset R$ the inverse image of $\\sqrt{IS}$ in $R$ is equal to $\\sqrt{I}$. \n\n\nFor any radical ideal $I \\subset R$ the inverse image of $IS$ in $R$ is equal to $I$. \n\n\nFor every prime $\\mathfrak p$ of $R$ the inverse image of $\\mathfrak p S$ in $R$ is $\\mathfrak p$. \n\n\n\n   In this case the same is true after any base change: Given a ring map $R \\to R\'$ the ring map $R\' \\to R\' \\otimes _ R S$ has the equivalent properties (1), (2), (3) as well. \n\n    \n]]. Therefore for any $R \\to R\'$ the kernel of the ring map $R\' \\to R\' \\otimes _ R S$ consists of nilpotent elements, see Lemma 10.30.6 [[\n  Lemma 10.30.6. Let $R \\to S$ be a ring map. The following are equivalent: \n  \n  \nThe kernel of $R \\to S$ consists of nilpotent elements. \n\n\nThe minimal primes of $R$ are in the image of $\\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R)$. \n\n\nThe image of $\\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R)$ is dense in $\\mathop{\\mathrm{Spec}}(R)$. \n\n\n\n\n    \n]], in other words (b) holds for $R\' \\to R\' \\otimes _ R S$. It is clear that (a) is preserved under base change. Finally, the condition on residue fields follows from (a) as generators for $S$ as an $R$-algebra map to generators for the residue field extensions. \n      $\\square$\n    \n"
340,00FB,"theorem isOpenMap_comap_C : IsOpenMap (PrimeSpectrum.comap (C : R â†’+* R[X])) := by
  rintro U âŸ¨s, zâŸ©
  rw [â† compl_compl U, â† z, â† iUnion_of_singleton_coe s, zeroLocus_iUnion, compl_iInter,
    image_iUnion]
  simp_rw [â† imageOfDf_eq_comap_C_compl_zeroLocus]
  exact isOpen_iUnion fun f => isOpen_imageOfDf
",Formal Proof of Stacks Project Tag 00FB,First part,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Spectrum/Prime/IsOpenComapC.lean#L68-L73,Q27041,,10.29.7,lemma,3.0,"['00F5', '00AO', '0ELQ']","\n  Lemma 10.29.7. Let $R$ be a ring. The map $\\mathop{\\mathrm{Spec}}(R[x]) \\to \\mathop{\\mathrm{Spec}}(R)$ is open, and the image of any standard open is a quasi-compact open. \n\n    \n      Proof.\n      It suffices to show that the image of a standard open $D(f)$, $f\\in R[x]$ is quasi-compact open. The image of $D(f)$ is the image of $\\mathop{\\mathrm{Spec}}(R[x]_ f) \\to \\mathop{\\mathrm{Spec}}(R)$. Let $\\mathfrak p \\subset R$ be a prime ideal. Let $\\overline{f}$ be the image of $f$ in $\\kappa (\\mathfrak p)[x]$. Recall, see Lemma 10.18.6, that $\\mathfrak p$ is in the image if and only if $R[x]_ f \\otimes _ R \\kappa (\\mathfrak p) = \\kappa (\\mathfrak p)[x]_{\\overline{f}}$ is not the zero ring. This is exactly the condition that $f$ does not map to zero in $\\kappa (\\mathfrak p)[x]$, in other words, that some coefficient of $f$ is not in $\\mathfrak p$. Hence we see: if $f = a_ d x^ d + \\ldots + a_0$, then the image of $D(f)$ is $D(a_ d) \\cup \\ldots \\cup D(a_0)$. \n      $\\square$\n    \n","\n  Lemma 10.29.7. Let $R$ be a ring. The map $\\mathop{\\mathrm{Spec}}(R[x]) \\to \\mathop{\\mathrm{Spec}}(R)$ is open, and the image of any standard open is a quasi-compact open. \n\n    \n","Proof.\n      It suffices to show that the image of a standard open $D(f)$, $f\\in R[x]$ is quasi-compact open. The image of $D(f)$ is the image of $\\mathop{\\mathrm{Spec}}(R[x]_ f) \\to \\mathop{\\mathrm{Spec}}(R)$. Let $\\mathfrak p \\subset R$ be a prime ideal. Let $\\overline{f}$ be the image of $f$ in $\\kappa (\\mathfrak p)[x]$. Recall, see Lemma 10.18.6, that $\\mathfrak p$ is in the image if and only if $R[x]_ f \\otimes _ R \\kappa (\\mathfrak p) = \\kappa (\\mathfrak p)[x]_{\\overline{f}}$ is not the zero ring. This is exactly the condition that $f$ does not map to zero in $\\kappa (\\mathfrak p)[x]$, in other words, that some coefficient of $f$ is not in $\\mathfrak p$. Hence we see: if $f = a_ d x^ d + \\ldots + a_0$, then the image of $D(f)$ is $D(a_ d) \\cup \\ldots \\cup D(a_0)$. \n      $\\square$\n    \n"," by
  rintro U âŸ¨s, zâŸ©
  rw [â† compl_compl U, â† z, â† iUnion_of_singleton_coe s, zeroLocus_iUnion, compl_iInter,
    image_iUnion]
  simp_rw [â† imageOfDf_eq_comap_C_compl_zeroLocus]
  exact isOpen_iUnion fun f => isOpen_imageOfDf
",theorem isOpenMap_comap_C : IsOpenMap (PrimeSpectrum.comap (C : R â†’+* R[X])) ,"Proof.\n      It suffices to show that the image of a standard open $D(f)$, $f\\in R[x]$ is quasi-compact open. The image of $D(f)$ is the image of $\\mathop{\\mathrm{Spec}}(R[x]_ f) \\to \\mathop{\\mathrm{Spec}}(R)$. Let $\\mathfrak p \\subset R$ be a prime ideal. Let $\\overline{f}$ be the image of $f$ in $\\kappa (\\mathfrak p)[x]$. Recall, see Lemma 10.18.6 [[\n  Lemma 10.18.6. Let $\\varphi : R \\to S$ be a ring map. Let $\\mathfrak p$ be a prime of $R$. The following are equivalent \n  \n  \n$\\mathfrak p$ is in the image of $\\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R)$, \n\n\n$S \\otimes _ R \\kappa (\\mathfrak p) \\not= 0$, \n\n\n$S_{\\mathfrak p}/\\mathfrak p S_{\\mathfrak p} \\not= 0$, \n\n\n$(S/\\mathfrak pS)_{\\mathfrak p} \\not= 0$, and \n\n\n$\\mathfrak p = \\varphi ^{-1}(\\mathfrak pS)$. \n\n\n\n\n    \n]], that $\\mathfrak p$ is in the image if and only if $R[x]_ f \\otimes _ R \\kappa (\\mathfrak p) = \\kappa (\\mathfrak p)[x]_{\\overline{f}}$ is not the zero ring. This is exactly the condition that $f$ does not map to zero in $\\kappa (\\mathfrak p)[x]$, in other words, that some coefficient of $f$ is not in $\\mathfrak p$. Hence we see: if $f = a_ d x^ d + \\ldots + a_0$, then the image of $D(f)$ is $D(a_ d) \\cup \\ldots \\cup D(a_0)$. \n      $\\square$\n    \n"
341,00JA,"""See also `PrimeSpectrum.discreteTopology_iff_finite_isMaximal_and_sInf_le_nilradical`.""]
def _root_.MaximalSpectrum.toPiLocalizationEquiv :
    R â‰ƒ+* MaximalSpectrum.PiLocalization R :=
  .ofBijective _ âŸ¨MaximalSpectrum.toPiLocalization_injective R,
    maximalSpectrumToPiLocalization_surjective_of_discreteTopology RâŸ©
",Formal Proof of Stacks Project Tag 00JA,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Spectrum/Prime/Topology.lean#L713-L717,Q27041,,10.53.5,lemma,3.0,"['00J4', '00AO', '0ELQ']","\n  Lemma 10.53.5. Any ring with finitely many maximal ideals and locally nilpotent Jacobson radical is the product of its localizations at its maximal ideals. Also, all primes are maximal. \n\n    \n      Proof.\n      Let $R$ be a ring with finitely many maximal ideals $\\mathfrak m_1, \\ldots , \\mathfrak m_ n$. Let $I = \\bigcap _{i = 1}^ n \\mathfrak m_ i$ be the Jacobson radical of $R$. Assume $I$ is locally nilpotent. Let $\\mathfrak p$ be a prime ideal of $R$. Since every prime contains every nilpotent element of $R$ we see $ \\mathfrak p \\supset \\mathfrak m_1 \\cap \\ldots \\cap \\mathfrak m_ n$. Since $\\mathfrak m_1 \\cap \\ldots \\cap \\mathfrak m_ n \\supset \\mathfrak m_1 \\ldots \\mathfrak m_ n$ we conclude $\\mathfrak p \\supset \\mathfrak m_1 \\ldots \\mathfrak m_ n$. Hence $\\mathfrak p \\supset \\mathfrak m_ i$ for some $i$, and so $\\mathfrak p = \\mathfrak m_ i$. Thus the spectrum of $R$ is the discrete topological space $\\{ \\mathfrak m_1, \\ldots , \\mathfrak m_ n\\} $. By Lemma 10.24.3 applied $n - 1$ times we find that $R = R_1 \\times \\ldots \\times R_ n$ where the spectrum of $R_ i$ is a singleton for each $i$. Thus $R_ i$ is a local ring and since it is a localization of $R$ (by the lemma), it is one of the local rings of $R$ as desired. \n      $\\square$\n    \n","\n  Lemma 10.53.5. Any ring with finitely many maximal ideals and locally nilpotent Jacobson radical is the product of its localizations at its maximal ideals. Also, all primes are maximal. \n\n    \n","Proof.\n      Let $R$ be a ring with finitely many maximal ideals $\\mathfrak m_1, \\ldots , \\mathfrak m_ n$. Let $I = \\bigcap _{i = 1}^ n \\mathfrak m_ i$ be the Jacobson radical of $R$. Assume $I$ is locally nilpotent. Let $\\mathfrak p$ be a prime ideal of $R$. Since every prime contains every nilpotent element of $R$ we see $ \\mathfrak p \\supset \\mathfrak m_1 \\cap \\ldots \\cap \\mathfrak m_ n$. Since $\\mathfrak m_1 \\cap \\ldots \\cap \\mathfrak m_ n \\supset \\mathfrak m_1 \\ldots \\mathfrak m_ n$ we conclude $\\mathfrak p \\supset \\mathfrak m_1 \\ldots \\mathfrak m_ n$. Hence $\\mathfrak p \\supset \\mathfrak m_ i$ for some $i$, and so $\\mathfrak p = \\mathfrak m_ i$. Thus the spectrum of $R$ is the discrete topological space $\\{ \\mathfrak m_1, \\ldots , \\mathfrak m_ n\\} $. By Lemma 10.24.3 applied $n - 1$ times we find that $R = R_1 \\times \\ldots \\times R_ n$ where the spectrum of $R_ i$ is a singleton for each $i$. Thus $R_ i$ is a local ring and since it is a localization of $R$ (by the lemma), it is one of the local rings of $R$ as desired. \n      $\\square$\n    \n","
  .ofBijective _ âŸ¨MaximalSpectrum.toPiLocalization_injective R,
    maximalSpectrumToPiLocalization_surjective_of_discreteTopology RâŸ©
","""See also `PrimeSpectrum.discreteTopology_iff_finite_isMaximal_and_sInf_le_nilradical`.""]
def _root_.MaximalSpectrum.toPiLocalizationEquiv :
    R â‰ƒ+* MaximalSpectrum.PiLocalization R ","Proof.\n      Let $R$ be a ring with finitely many maximal ideals $\\mathfrak m_1, \\ldots , \\mathfrak m_ n$. Let $I = \\bigcap _{i = 1}^ n \\mathfrak m_ i$ be the Jacobson radical of $R$. Assume $I$ is locally nilpotent. Let $\\mathfrak p$ be a prime ideal of $R$. Since every prime contains every nilpotent element of $R$ we see $ \\mathfrak p \\supset \\mathfrak m_1 \\cap \\ldots \\cap \\mathfrak m_ n$. Since $\\mathfrak m_1 \\cap \\ldots \\cap \\mathfrak m_ n \\supset \\mathfrak m_1 \\ldots \\mathfrak m_ n$ we conclude $\\mathfrak p \\supset \\mathfrak m_1 \\ldots \\mathfrak m_ n$. Hence $\\mathfrak p \\supset \\mathfrak m_ i$ for some $i$, and so $\\mathfrak p = \\mathfrak m_ i$. Thus the spectrum of $R$ is the discrete topological space $\\{ \\mathfrak m_1, \\ldots , \\mathfrak m_ n\\} $. By Lemma 10.24.3 [[\n  Lemma 10.24.3. Let $R$ be a ring. If $\\mathop{\\mathrm{Spec}}(R) = U \\amalg V$ with both $U$ and $V$ open then $R \\cong R_1 \\times R_2$ with $U \\cong \\mathop{\\mathrm{Spec}}(R_1)$ and $V \\cong \\mathop{\\mathrm{Spec}}(R_2)$ via the maps in Lemma 10.21.2. Moreover, both $R_1$ and $R_2$ are localizations as well as quotients of the ring $R$. \n\n    \n]] applied $n - 1$ times we find that $R = R_1 \\times \\ldots \\times R_ n$ where the spectrum of $R_ i$ is a singleton for each $i$. Thus $R_ i$ is a local ring and since it is a localization of $R$ (by the lemma), it is one of the local rings of $R$ as desired. \n      $\\square$\n    \n"
342,00HY,"lemma stableUnderSpecialization_range_iff :
    StableUnderSpecialization (Set.range (comap f)) â†” IsClosed (Set.range (comap f)) :=
  âŸ¨isClosed_range_of_stableUnderSpecialization f, fun h â†¦ h.stableUnderSpecializationâŸ©
",Formal Proof of Stacks Project Tag 00HY,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Spectrum/Prime/Topology.lean#L803-L805,Q27041,,10.41.5,lemma,3.0,"['00HU', '00AO', '0ELQ']","\n  Lemma 10.41.5. Let $R \\to S$ be a ring map. Let $T \\subset \\mathop{\\mathrm{Spec}}(R)$ be the image of $\\mathop{\\mathrm{Spec}}(S)$. If $T$ is stable under specialization, then $T$ is closed. \n\n    \n      Proof.\n      We give two proofs. \n    \n      First proof. Let $\\mathfrak p \\subset R$ be a prime ideal such that the corresponding point of $\\mathop{\\mathrm{Spec}}(R)$ is in the closure of $T$. This means that for every $f \\in R$, $f \\not\\in \\mathfrak p$ we have $D(f) \\cap T \\not= \\emptyset $. Note that $D(f) \\cap T$ is the image of $\\mathop{\\mathrm{Spec}}(S_ f)$ in $\\mathop{\\mathrm{Spec}}(R)$. Hence we conclude that $S_ f \\not= 0$. In other words, $1 \\not= 0$ in the ring $S_ f$. Since $S_{\\mathfrak p}$ is the directed colimit of the rings $S_ f$ we conclude that $1 \\not= 0$ in $S_{\\mathfrak p}$. In other words, $S_{\\mathfrak p} \\not= 0$ and considering the image of $\\mathop{\\mathrm{Spec}}(S_{\\mathfrak p}) \\to \\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R)$ we see there exists a $\\mathfrak p\' \\in T$ with $\\mathfrak p\' \\subset \\mathfrak p$. As we assumed $T$ closed under specialization we conclude $\\mathfrak p$ is a point of $T$ as desired. \n    \n      Second proof. Let $I = \\mathop{\\mathrm{Ker}}(R \\to S)$. We may replace $R$ by $R/I$. In this case the ring map $R \\to S$ is injective. By Lemma 10.30.5 all the minimal primes of $R$ are contained in the image $T$. Hence if $T$ is stable under specialization then it contains all primes. \n      $\\square$\n    \n","\n  Lemma 10.41.5. Let $R \\to S$ be a ring map. Let $T \\subset \\mathop{\\mathrm{Spec}}(R)$ be the image of $\\mathop{\\mathrm{Spec}}(S)$. If $T$ is stable under specialization, then $T$ is closed. \n\n    \n","Proof.\n      We give two proofs. \n    \n      First proof. Let $\\mathfrak p \\subset R$ be a prime ideal such that the corresponding point of $\\mathop{\\mathrm{Spec}}(R)$ is in the closure of $T$. This means that for every $f \\in R$, $f \\not\\in \\mathfrak p$ we have $D(f) \\cap T \\not= \\emptyset $. Note that $D(f) \\cap T$ is the image of $\\mathop{\\mathrm{Spec}}(S_ f)$ in $\\mathop{\\mathrm{Spec}}(R)$. Hence we conclude that $S_ f \\not= 0$. In other words, $1 \\not= 0$ in the ring $S_ f$. Since $S_{\\mathfrak p}$ is the directed colimit of the rings $S_ f$ we conclude that $1 \\not= 0$ in $S_{\\mathfrak p}$. In other words, $S_{\\mathfrak p} \\not= 0$ and considering the image of $\\mathop{\\mathrm{Spec}}(S_{\\mathfrak p}) \\to \\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R)$ we see there exists a $\\mathfrak p\' \\in T$ with $\\mathfrak p\' \\subset \\mathfrak p$. As we assumed $T$ closed under specialization we conclude $\\mathfrak p$ is a point of $T$ as desired. \n    \n      Second proof. Let $I = \\mathop{\\mathrm{Ker}}(R \\to S)$. We may replace $R$ by $R/I$. In this case the ring map $R \\to S$ is injective. By Lemma 10.30.5 all the minimal primes of $R$ are contained in the image $T$. Hence if $T$ is stable under specialization then it contains all primes. \n      $\\square$\n    \n","
  âŸ¨isClosed_range_of_stableUnderSpecialization f, fun h â†¦ h.stableUnderSpecializationâŸ©
","lemma stableUnderSpecialization_range_iff :
    StableUnderSpecialization (Set.range (comap f)) â†” IsClosed (Set.range (comap f)) ","Proof.\n      We give two proofs. \n    \n      First proof. Let $\\mathfrak p \\subset R$ be a prime ideal such that the corresponding point of $\\mathop{\\mathrm{Spec}}(R)$ is in the closure of $T$. This means that for every $f \\in R$, $f \\not\\in \\mathfrak p$ we have $D(f) \\cap T \\not= \\emptyset $. Note that $D(f) \\cap T$ is the image of $\\mathop{\\mathrm{Spec}}(S_ f)$ in $\\mathop{\\mathrm{Spec}}(R)$. Hence we conclude that $S_ f \\not= 0$. In other words, $1 \\not= 0$ in the ring $S_ f$. Since $S_{\\mathfrak p}$ is the directed colimit of the rings $S_ f$ we conclude that $1 \\not= 0$ in $S_{\\mathfrak p}$. In other words, $S_{\\mathfrak p} \\not= 0$ and considering the image of $\\mathop{\\mathrm{Spec}}(S_{\\mathfrak p}) \\to \\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R)$ we see there exists a $\\mathfrak p\' \\in T$ with $\\mathfrak p\' \\subset \\mathfrak p$. As we assumed $T$ closed under specialization we conclude $\\mathfrak p$ is a point of $T$ as desired. \n    \n      Second proof. Let $I = \\mathop{\\mathrm{Ker}}(R \\to S)$. We may replace $R$ by $R/I$. In this case the ring map $R \\to S$ is injective. By Lemma 10.30.5 [[\n  Lemma 10.30.5. Let $R \\subset S$ be an injective ring map. Then $\\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R)$ hits all the minimal primes. \n\n    \n]] all the minimal primes of $R$ are contained in the image $T$. Hence if $T$ is stable under specialization then it contains all primes. \n      $\\square$\n    \n"
343,00FL,"lemma denseRange_comap_iff_minimalPrimes :
    DenseRange (comap f) â†” âˆ€ I (h : I âˆˆ minimalPrimes R), âŸ¨I, h.1.1âŸ© âˆˆ Set.range (comap f) := by
  constructor
  Â· intro H I hI
    have : I âˆˆ (RingHom.ker f).minimalPrimes := by
      rw [denseRange_comap_iff_ker_le_nilRadical] at H
      simp only [minimalPrimes, Ideal.minimalPrimes, Set.mem_setOf] at hI âŠ¢
      convert hI using 2 with p
      exact âŸ¨fun h â†¦ âŸ¨h.1, bot_leâŸ©, fun h â†¦ âŸ¨h.1, H.trans (h.1.radical_le_iff.mpr bot_le)âŸ©âŸ©
    obtain âŸ¨p, hp, _, rflâŸ© := Ideal.exists_comap_eq_of_mem_minimalPrimes f (I := âŠ¥) I this
    exact âŸ¨âŸ¨p, hpâŸ©, rflâŸ©
  Â· intro H p
    obtain âŸ¨q, hq, hq'âŸ© := Ideal.exists_minimalPrimes_le (J := p.asIdeal) bot_le
    exact ((le_iff_specializes âŸ¨q, hq.1.1âŸ© p).mp hq').mem_closed isClosed_closure
      (subset_closure (H q hq))
",Formal Proof of Stacks Project Tag 00FL,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Spectrum/Prime/Topology.lean#L866-L880,Q27041,,10.30.6,lemma,3.0,"['00FF', '00AO', '0ELQ']","\n  Lemma 10.30.6. Let $R \\to S$ be a ring map. The following are equivalent: \n  \n  \nThe kernel of $R \\to S$ consists of nilpotent elements. \n\n\nThe minimal primes of $R$ are in the image of $\\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R)$. \n\n\nThe image of $\\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R)$ is dense in $\\mathop{\\mathrm{Spec}}(R)$. \n\n\n\n\n    \n      Proof.\n      Let $I = \\mathop{\\mathrm{Ker}}(R \\to S)$. Note that $\\sqrt{(0)} = \\bigcap _{\\mathfrak q \\subset S} \\mathfrak q$, see Lemma 10.17.2. Hence $\\sqrt{I} = \\bigcap _{\\mathfrak q \\subset S} R \\cap \\mathfrak q$. Thus $V(I) = V(\\sqrt{I})$ is the closure of the image of $\\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R)$. This shows that (1) is equivalent to (3). It is clear that (2) implies (3). Finally, assume (1). We may replace $R$ by $R/I$ and $S$ by $S/IS$ without affecting the topology of the spectra and the map. Hence the implication (1) $\\Rightarrow $ (2) follows from Lemma 10.30.5. \n      $\\square$\n    \n",\n  Lemma 10.30.6. Let $R \\to S$ be a ring map. The following are equivalent: \n  \n  \nThe kernel of $R \\to S$ consists of nilpotent elements. \n\n\nThe minimal primes of $R$ are in the image of $\\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R)$. \n\n\nThe image of $\\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R)$ is dense in $\\mathop{\\mathrm{Spec}}(R)$. \n\n\n\n\n    \n,"Proof.\n      Let $I = \\mathop{\\mathrm{Ker}}(R \\to S)$. Note that $\\sqrt{(0)} = \\bigcap _{\\mathfrak q \\subset S} \\mathfrak q$, see Lemma 10.17.2. Hence $\\sqrt{I} = \\bigcap _{\\mathfrak q \\subset S} R \\cap \\mathfrak q$. Thus $V(I) = V(\\sqrt{I})$ is the closure of the image of $\\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R)$. This shows that (1) is equivalent to (3). It is clear that (2) implies (3). Finally, assume (1). We may replace $R$ by $R/I$ and $S$ by $S/IS$ without affecting the topology of the spectra and the map. Hence the implication (1) $\\Rightarrow $ (2) follows from Lemma 10.30.5. \n      $\\square$\n    \n"," by
  constructor
  Â· intro H I hI
    have : I âˆˆ (RingHom.ker f).minimalPrimes := by
      rw [denseRange_comap_iff_ker_le_nilRadical] at H
      simp only [minimalPrimes, Ideal.minimalPrimes, Set.mem_setOf] at hI âŠ¢
      convert hI using 2 with p
      exact âŸ¨fun h â†¦ âŸ¨h.1, bot_leâŸ©, fun h â†¦ âŸ¨h.1, H.trans (h.1.radical_le_iff.mpr bot_le)âŸ©âŸ©
    obtain âŸ¨p, hp, _, rflâŸ© := Ideal.exists_comap_eq_of_mem_minimalPrimes f (I := âŠ¥) I this
    exact âŸ¨âŸ¨p, hpâŸ©, rflâŸ©
  Â· intro H p
    obtain âŸ¨q, hq, hq'âŸ© := Ideal.exists_minimalPrimes_le (J := p.asIdeal) bot_le
    exact ((le_iff_specializes âŸ¨q, hq.1.1âŸ© p).mp hq').mem_closed isClosed_closure
      (subset_closure (H q hq))
","lemma denseRange_comap_iff_minimalPrimes :
    DenseRange (comap f) â†” âˆ€ I (h : I âˆˆ minimalPrimes R), âŸ¨I, h.1.1âŸ© âˆˆ Set.range (comap f) ","Proof.\n      Let $I = \\mathop{\\mathrm{Ker}}(R \\to S)$. Note that $\\sqrt{(0)} = \\bigcap _{\\mathfrak q \\subset S} \\mathfrak q$, see Lemma 10.17.2 [[\n  Lemma 10.17.2. Let $R$ be a ring. \n  \n  \nThe spectrum of a ring $R$ is empty if and only if $R$ is the zero ring. \n\n\nEvery nonzero ring has a maximal ideal. \n\n\nEvery nonzero ring has a minimal prime ideal. \n\n\nGiven an ideal $I \\subset R$ and a prime ideal $I \\subset \\mathfrak p$ there exists a prime $I \\subset \\mathfrak q \\subset \\mathfrak p$ such that $\\mathfrak q$ is minimal over $I$. \n\n\nIf $T \\subset R$, and if $(T)$ is the ideal generated by $T$ in $R$, then $V((T)) = V(T)$. \n\n\nIf $I$ is an ideal and $\\sqrt{I}$ is its radical, see basic notion (27), then $V(I) = V(\\sqrt{I})$. \n\n\nGiven an ideal $I$ of $R$ we have $\\sqrt{I} = \\bigcap _{I \\subset \\mathfrak p} \\mathfrak p$. \n\n\nIf $I$ is an ideal then $V(I) = \\emptyset $ if and only if $I$ is the unit ideal. \n\n\nIf $I$, $J$ are ideals of $R$ then $V(I) \\cup V(J) = V(I \\cap J)$. \n\n\nIf $(I_ a)_{a\\in A}$ is a set of ideals of $R$ then $\\bigcap _{a\\in A} V(I_ a) = V(\\bigcup _{a\\in A} I_ a)$. \n\n\nIf $f \\in R$, then $D(f) \\amalg V(f) = \\mathop{\\mathrm{Spec}}(R)$. \n\n\nIf $f \\in R$ then $D(f) = \\emptyset $ if and only if $f$ is nilpotent. \n\n\nIf $f = u f\'$ for some unit $u \\in R$, then $D(f) = D(f\')$. \n\n\nIf $I \\subset R$ is an ideal, and $\\mathfrak p$ is a prime of $R$ with $\\mathfrak p \\not\\in V(I)$, then there exists an $f \\in R$ such that $\\mathfrak p \\in D(f)$, and $D(f) \\cap V(I) = \\emptyset $. \n\n\nIf $f, g \\in R$, then $D(fg) = D(f) \\cap D(g)$. \n\n\nIf $f_ i \\in R$ for $i \\in I$, then $\\bigcup _{i\\in I} D(f_ i)$ is the complement of $V(\\{ f_ i \\} _{i\\in I})$ in $\\mathop{\\mathrm{Spec}}(R)$. \n\n\nIf $f \\in R$ and $D(f) = \\mathop{\\mathrm{Spec}}(R)$, then $f$ is a unit. \n\n\n\n\n    \n]]. Hence $\\sqrt{I} = \\bigcap _{\\mathfrak q \\subset S} R \\cap \\mathfrak q$. Thus $V(I) = V(\\sqrt{I})$ is the closure of the image of $\\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R)$. This shows that (1) is equivalent to (3). It is clear that (2) implies (3). Finally, assume (1). We may replace $R$ by $R/I$ and $S$ by $S/IS$ without affecting the topology of the spectra and the map. Hence the implication (1) $\\Rightarrow $ (2) follows from Lemma 10.30.5 [[\n  Lemma 10.30.5. Let $R \\subset S$ be an injective ring map. Then $\\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R)$ hits all the minimal primes. \n\n    \n]]. \n      $\\square$\n    \n"
344,00EE,"def isIdempotentElemEquivClopens :
    {e : R // IsIdempotentElem e} â‰ƒo Clopens (PrimeSpectrum R) :=
  .trans .isIdempotentElemMulZeroAddOne mulZeroAddOneEquivClopens
",Formal Proof of Stacks Project Tag 00EE,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Spectrum/Prime/Topology.lean#L1312-L1314,Q27041,,10.21.3,lemma,3.0,"['04PN', '00AO', '0ELQ']","\n  Lemma 10.21.3. Let $R$ be a ring. For each $U \\subset \\mathop{\\mathrm{Spec}}(R)$ which is open and closed there exists a unique idempotent $e \\in R$ such that $U = D(e)$. This induces a 1-1 correspondence between open and closed subsets $U \\subset \\mathop{\\mathrm{Spec}}(R)$ and idempotents $e \\in R$. \n\n    \n      Proof.\n      Let $U \\subset \\mathop{\\mathrm{Spec}}(R)$ be open and closed. Since $U$ is closed it is quasi-compact by Lemma 10.17.8, and similarly for its complement. Write $U = \\bigcup _{i = 1}^ n D(f_ i)$ as a finite union of standard opens. Similarly, write $\\mathop{\\mathrm{Spec}}(R) \\setminus U = \\bigcup _{j = 1}^ m D(g_ j)$ as a finite union of standard opens. Since $\\emptyset = D(f_ i) \\cap D(g_ j) = D(f_ i g_ j)$ we see that $f_ i g_ j$ is nilpotent by Lemma 10.17.2. Let $I = (f_1, \\ldots , f_ n) \\subset R$ and let $J = (g_1, \\ldots , g_ m) \\subset R$. Note that $V(J)$ equals $U$, that $V(I)$ equals the complement of $U$, so $\\mathop{\\mathrm{Spec}}(R) = V(I) \\amalg V(J)$. By the remark on nilpotency above, we see that $(IJ)^ N = (0)$ for some sufficiently large integer $N$. Since $\\bigcup D(f_ i) \\cup \\bigcup D(g_ j) = \\mathop{\\mathrm{Spec}}(R)$ we see that $I + J = R$, see Lemma 10.17.2. By raising this equation to the $2N$th power we conclude that $I^ N + J^ N = R$. Write $1 = x + y$ with $x \\in I^ N$ and $y \\in J^ N$. Then $0 = xy = x(1 - x)$ as $I^ N J^ N = (0)$. Thus $x = x^2$ is idempotent and contained in $I^ N \\subset I$. The idempotent $y = 1 - x$ is contained in $J^ N \\subset J$. This shows that the idempotent $x$ maps to $1$ in every residue field $\\kappa (\\mathfrak p)$ for $\\mathfrak p \\in V(J)$ and that $x$ maps to $0$ in $\\kappa (\\mathfrak p)$ for every $\\mathfrak p \\in V(I)$. \n    \n      To see uniqueness suppose that $e_1, e_2$ are distinct idempotents in $R$. We have to show there exists a prime $\\mathfrak p$ such that $e_1 \\in \\mathfrak p$ and $e_2 \\not\\in \\mathfrak p$, or conversely. Write $e_ i\' = 1 - e_ i$. If $e_1 \\not= e_2$, then $0 \\not= e_1 - e_2 = e_1(e_2 + e_2\') - (e_1 + e_1\')e_2 = e_1 e_2\' - e_1\' e_2$. Hence either the idempotent $e_1 e_2\' \\not= 0$ or $e_1\' e_2 \\not= 0$. An idempotent is not nilpotent, and hence we find a prime $\\mathfrak p$ such that either $e_1e_2\' \\not\\in \\mathfrak p$ or $e_1\'e_2 \\not\\in \\mathfrak p$, by Lemma 10.17.2. It is easy to see this gives the desired prime. \n      $\\square$\n    \n",\n  Lemma 10.21.3. Let $R$ be a ring. For each $U \\subset \\mathop{\\mathrm{Spec}}(R)$ which is open and closed there exists a unique idempotent $e \\in R$ such that $U = D(e)$. This induces a 1-1 correspondence between open and closed subsets $U \\subset \\mathop{\\mathrm{Spec}}(R)$ and idempotents $e \\in R$. \n\n    \n,"Proof.\n      Let $U \\subset \\mathop{\\mathrm{Spec}}(R)$ be open and closed. Since $U$ is closed it is quasi-compact by Lemma 10.17.8, and similarly for its complement. Write $U = \\bigcup _{i = 1}^ n D(f_ i)$ as a finite union of standard opens. Similarly, write $\\mathop{\\mathrm{Spec}}(R) \\setminus U = \\bigcup _{j = 1}^ m D(g_ j)$ as a finite union of standard opens. Since $\\emptyset = D(f_ i) \\cap D(g_ j) = D(f_ i g_ j)$ we see that $f_ i g_ j$ is nilpotent by Lemma 10.17.2. Let $I = (f_1, \\ldots , f_ n) \\subset R$ and let $J = (g_1, \\ldots , g_ m) \\subset R$. Note that $V(J)$ equals $U$, that $V(I)$ equals the complement of $U$, so $\\mathop{\\mathrm{Spec}}(R) = V(I) \\amalg V(J)$. By the remark on nilpotency above, we see that $(IJ)^ N = (0)$ for some sufficiently large integer $N$. Since $\\bigcup D(f_ i) \\cup \\bigcup D(g_ j) = \\mathop{\\mathrm{Spec}}(R)$ we see that $I + J = R$, see Lemma 10.17.2. By raising this equation to the $2N$th power we conclude that $I^ N + J^ N = R$. Write $1 = x + y$ with $x \\in I^ N$ and $y \\in J^ N$. Then $0 = xy = x(1 - x)$ as $I^ N J^ N = (0)$. Thus $x = x^2$ is idempotent and contained in $I^ N \\subset I$. The idempotent $y = 1 - x$ is contained in $J^ N \\subset J$. This shows that the idempotent $x$ maps to $1$ in every residue field $\\kappa (\\mathfrak p)$ for $\\mathfrak p \\in V(J)$ and that $x$ maps to $0$ in $\\kappa (\\mathfrak p)$ for every $\\mathfrak p \\in V(I)$. \n    \n      To see uniqueness suppose that $e_1, e_2$ are distinct idempotents in $R$. We have to show there exists a prime $\\mathfrak p$ such that $e_1 \\in \\mathfrak p$ and $e_2 \\not\\in \\mathfrak p$, or conversely. Write $e_ i\' = 1 - e_ i$. If $e_1 \\not= e_2$, then $0 \\not= e_1 - e_2 = e_1(e_2 + e_2\') - (e_1 + e_1\')e_2 = e_1 e_2\' - e_1\' e_2$. Hence either the idempotent $e_1 e_2\' \\not= 0$ or $e_1\' e_2 \\not= 0$. An idempotent is not nilpotent, and hence we find a prime $\\mathfrak p$ such that either $e_1e_2\' \\not\\in \\mathfrak p$ or $e_1\'e_2 \\not\\in \\mathfrak p$, by Lemma 10.17.2. It is easy to see this gives the desired prime. \n      $\\square$\n    \n","
  .trans .isIdempotentElemMulZeroAddOne mulZeroAddOneEquivClopens
","def isIdempotentElemEquivClopens :
    {e : R // IsIdempotentElem e} â‰ƒo Clopens (PrimeSpectrum R) ","Proof.\n      Let $U \\subset \\mathop{\\mathrm{Spec}}(R)$ be open and closed. Since $U$ is closed it is quasi-compact by Lemma 10.17.8 [[\n       \n      \n  Lemma 10.17.8. Let $R$ be a ring. The space $\\mathop{\\mathrm{Spec}}(R)$ is quasi-compact. \n\n    \n]], and similarly for its complement. Write $U = \\bigcup _{i = 1}^ n D(f_ i)$ as a finite union of standard opens. Similarly, write $\\mathop{\\mathrm{Spec}}(R) \\setminus U = \\bigcup _{j = 1}^ m D(g_ j)$ as a finite union of standard opens. Since $\\emptyset = D(f_ i) \\cap D(g_ j) = D(f_ i g_ j)$ we see that $f_ i g_ j$ is nilpotent by Lemma 10.17.2 [[\n  Lemma 10.17.2. Let $R$ be a ring. \n  \n  \nThe spectrum of a ring $R$ is empty if and only if $R$ is the zero ring. \n\n\nEvery nonzero ring has a maximal ideal. \n\n\nEvery nonzero ring has a minimal prime ideal. \n\n\nGiven an ideal $I \\subset R$ and a prime ideal $I \\subset \\mathfrak p$ there exists a prime $I \\subset \\mathfrak q \\subset \\mathfrak p$ such that $\\mathfrak q$ is minimal over $I$. \n\n\nIf $T \\subset R$, and if $(T)$ is the ideal generated by $T$ in $R$, then $V((T)) = V(T)$. \n\n\nIf $I$ is an ideal and $\\sqrt{I}$ is its radical, see basic notion (27), then $V(I) = V(\\sqrt{I})$. \n\n\nGiven an ideal $I$ of $R$ we have $\\sqrt{I} = \\bigcap _{I \\subset \\mathfrak p} \\mathfrak p$. \n\n\nIf $I$ is an ideal then $V(I) = \\emptyset $ if and only if $I$ is the unit ideal. \n\n\nIf $I$, $J$ are ideals of $R$ then $V(I) \\cup V(J) = V(I \\cap J)$. \n\n\nIf $(I_ a)_{a\\in A}$ is a set of ideals of $R$ then $\\bigcap _{a\\in A} V(I_ a) = V(\\bigcup _{a\\in A} I_ a)$. \n\n\nIf $f \\in R$, then $D(f) \\amalg V(f) = \\mathop{\\mathrm{Spec}}(R)$. \n\n\nIf $f \\in R$ then $D(f) = \\emptyset $ if and only if $f$ is nilpotent. \n\n\nIf $f = u f\'$ for some unit $u \\in R$, then $D(f) = D(f\')$. \n\n\nIf $I \\subset R$ is an ideal, and $\\mathfrak p$ is a prime of $R$ with $\\mathfrak p \\not\\in V(I)$, then there exists an $f \\in R$ such that $\\mathfrak p \\in D(f)$, and $D(f) \\cap V(I) = \\emptyset $. \n\n\nIf $f, g \\in R$, then $D(fg) = D(f) \\cap D(g)$. \n\n\nIf $f_ i \\in R$ for $i \\in I$, then $\\bigcup _{i\\in I} D(f_ i)$ is the complement of $V(\\{ f_ i \\} _{i\\in I})$ in $\\mathop{\\mathrm{Spec}}(R)$. \n\n\nIf $f \\in R$ and $D(f) = \\mathop{\\mathrm{Spec}}(R)$, then $f$ is a unit. \n\n\n\n\n    \n]]. Let $I = (f_1, \\ldots , f_ n) \\subset R$ and let $J = (g_1, \\ldots , g_ m) \\subset R$. Note that $V(J)$ equals $U$, that $V(I)$ equals the complement of $U$, so $\\mathop{\\mathrm{Spec}}(R) = V(I) \\amalg V(J)$. By the remark on nilpotency above, we see that $(IJ)^ N = (0)$ for some sufficiently large integer $N$. Since $\\bigcup D(f_ i) \\cup \\bigcup D(g_ j) = \\mathop{\\mathrm{Spec}}(R)$ we see that $I + J = R$, see Lemma 10.17.2 [[\n  Lemma 10.17.2. Let $R$ be a ring. \n  \n  \nThe spectrum of a ring $R$ is empty if and only if $R$ is the zero ring. \n\n\nEvery nonzero ring has a maximal ideal. \n\n\nEvery nonzero ring has a minimal prime ideal. \n\n\nGiven an ideal $I \\subset R$ and a prime ideal $I \\subset \\mathfrak p$ there exists a prime $I \\subset \\mathfrak q \\subset \\mathfrak p$ such that $\\mathfrak q$ is minimal over $I$. \n\n\nIf $T \\subset R$, and if $(T)$ is the ideal generated by $T$ in $R$, then $V((T)) = V(T)$. \n\n\nIf $I$ is an ideal and $\\sqrt{I}$ is its radical, see basic notion (27), then $V(I) = V(\\sqrt{I})$. \n\n\nGiven an ideal $I$ of $R$ we have $\\sqrt{I} = \\bigcap _{I \\subset \\mathfrak p} \\mathfrak p$. \n\n\nIf $I$ is an ideal then $V(I) = \\emptyset $ if and only if $I$ is the unit ideal. \n\n\nIf $I$, $J$ are ideals of $R$ then $V(I) \\cup V(J) = V(I \\cap J)$. \n\n\nIf $(I_ a)_{a\\in A}$ is a set of ideals of $R$ then $\\bigcap _{a\\in A} V(I_ a) = V(\\bigcup _{a\\in A} I_ a)$. \n\n\nIf $f \\in R$, then $D(f) \\amalg V(f) = \\mathop{\\mathrm{Spec}}(R)$. \n\n\nIf $f \\in R$ then $D(f) = \\emptyset $ if and only if $f$ is nilpotent. \n\n\nIf $f = u f\'$ for some unit $u \\in R$, then $D(f) = D(f\')$. \n\n\nIf $I \\subset R$ is an ideal, and $\\mathfrak p$ is a prime of $R$ with $\\mathfrak p \\not\\in V(I)$, then there exists an $f \\in R$ such that $\\mathfrak p \\in D(f)$, and $D(f) \\cap V(I) = \\emptyset $. \n\n\nIf $f, g \\in R$, then $D(fg) = D(f) \\cap D(g)$. \n\n\nIf $f_ i \\in R$ for $i \\in I$, then $\\bigcup _{i\\in I} D(f_ i)$ is the complement of $V(\\{ f_ i \\} _{i\\in I})$ in $\\mathop{\\mathrm{Spec}}(R)$. \n\n\nIf $f \\in R$ and $D(f) = \\mathop{\\mathrm{Spec}}(R)$, then $f$ is a unit. \n\n\n\n\n    \n]]. By raising this equation to the $2N$th power we conclude that $I^ N + J^ N = R$. Write $1 = x + y$ with $x \\in I^ N$ and $y \\in J^ N$. Then $0 = xy = x(1 - x)$ as $I^ N J^ N = (0)$. Thus $x = x^2$ is idempotent and contained in $I^ N \\subset I$. The idempotent $y = 1 - x$ is contained in $J^ N \\subset J$. This shows that the idempotent $x$ maps to $1$ in every residue field $\\kappa (\\mathfrak p)$ for $\\mathfrak p \\in V(J)$ and that $x$ maps to $0$ in $\\kappa (\\mathfrak p)$ for every $\\mathfrak p \\in V(I)$. \n    \n      To see uniqueness suppose that $e_1, e_2$ are distinct idempotents in $R$. We have to show there exists a prime $\\mathfrak p$ such that $e_1 \\in \\mathfrak p$ and $e_2 \\not\\in \\mathfrak p$, or conversely. Write $e_ i\' = 1 - e_ i$. If $e_1 \\not= e_2$, then $0 \\not= e_1 - e_2 = e_1(e_2 + e_2\') - (e_1 + e_1\')e_2 = e_1 e_2\' - e_1\' e_2$. Hence either the idempotent $e_1 e_2\' \\not= 0$ or $e_1\' e_2 \\not= 0$. An idempotent is not nilpotent, and hence we find a prime $\\mathfrak p$ such that either $e_1e_2\' \\not\\in \\mathfrak p$ or $e_1\'e_2 \\not\\in \\mathfrak p$, by Lemma 10.17.2 [[\n  Lemma 10.17.2. Let $R$ be a ring. \n  \n  \nThe spectrum of a ring $R$ is empty if and only if $R$ is the zero ring. \n\n\nEvery nonzero ring has a maximal ideal. \n\n\nEvery nonzero ring has a minimal prime ideal. \n\n\nGiven an ideal $I \\subset R$ and a prime ideal $I \\subset \\mathfrak p$ there exists a prime $I \\subset \\mathfrak q \\subset \\mathfrak p$ such that $\\mathfrak q$ is minimal over $I$. \n\n\nIf $T \\subset R$, and if $(T)$ is the ideal generated by $T$ in $R$, then $V((T)) = V(T)$. \n\n\nIf $I$ is an ideal and $\\sqrt{I}$ is its radical, see basic notion (27), then $V(I) = V(\\sqrt{I})$. \n\n\nGiven an ideal $I$ of $R$ we have $\\sqrt{I} = \\bigcap _{I \\subset \\mathfrak p} \\mathfrak p$. \n\n\nIf $I$ is an ideal then $V(I) = \\emptyset $ if and only if $I$ is the unit ideal. \n\n\nIf $I$, $J$ are ideals of $R$ then $V(I) \\cup V(J) = V(I \\cap J)$. \n\n\nIf $(I_ a)_{a\\in A}$ is a set of ideals of $R$ then $\\bigcap _{a\\in A} V(I_ a) = V(\\bigcup _{a\\in A} I_ a)$. \n\n\nIf $f \\in R$, then $D(f) \\amalg V(f) = \\mathop{\\mathrm{Spec}}(R)$. \n\n\nIf $f \\in R$ then $D(f) = \\emptyset $ if and only if $f$ is nilpotent. \n\n\nIf $f = u f\'$ for some unit $u \\in R$, then $D(f) = D(f\')$. \n\n\nIf $I \\subset R$ is an ideal, and $\\mathfrak p$ is a prime of $R$ with $\\mathfrak p \\not\\in V(I)$, then there exists an $f \\in R$ such that $\\mathfrak p \\in D(f)$, and $D(f) \\cap V(I) = \\emptyset $. \n\n\nIf $f, g \\in R$, then $D(fg) = D(f) \\cap D(g)$. \n\n\nIf $f_ i \\in R$ for $i \\in I$, then $\\bigcup _{i\\in I} D(f_ i)$ is the complement of $V(\\{ f_ i \\} _{i\\in I})$ in $\\mathop{\\mathrm{Spec}}(R)$. \n\n\nIf $f \\in R$ and $D(f) = \\mathop{\\mathrm{Spec}}(R)$, then $f$ is a unit. \n\n\n\n\n    \n]]. It is easy to see this gives the desired prime. \n      $\\square$\n    \n"
345,00ES,"protected def _root_.minimalPrimes.equivIrreducibleComponents :
    minimalPrimes R â‰ƒo (irreducibleComponents <| PrimeSpectrum R)áµ’áµˆ := by
  let e : {p : Ideal R | p.IsPrime âˆ§ âŠ¥ â‰¤ p} â‰ƒo PrimeSpectrum R :=
    âŸ¨âŸ¨fun x â†¦ âŸ¨x.1, x.2.1âŸ©, fun x â†¦ âŸ¨x.1, x.2, bot_leâŸ©, fun _ â†¦ rfl, fun _ â†¦ rflâŸ©, Iff.rflâŸ©
  rw [irreducibleComponents_eq_maximals_closed]
  exact OrderIso.setOfMinimalIsoSetOfMaximal
    (e.trans ((PrimeSpectrum.pointsEquivIrreducibleCloseds R).trans
    (TopologicalSpace.IrreducibleCloseds.orderIsoSubtype' (PrimeSpectrum R)).dual))
",Formal Proof of Stacks Project Tag 00ES,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Spectrum/Prime/Topology.lean#L1164-L1171,Q27041,,10.26.1,lemma,3.0,"['00ER', '00AO', '0ELQ']","\n  Lemma 10.26.1. Let $R$ be a ring. \n  \n  \nFor a prime $\\mathfrak p \\subset R$ the closure of $\\{ \\mathfrak p\\} $ in the Zariski topology is $V(\\mathfrak p)$. In a formula $\\overline{\\{ \\mathfrak p\\} } = V(\\mathfrak p)$. \n\n\nThe irreducible closed subsets of $\\mathop{\\mathrm{Spec}}(R)$ are exactly the subsets $V(\\mathfrak p)$, with $\\mathfrak p \\subset R$ a prime. \n\n\nThe irreducible components (see Topology, Definition 5.8.1) of $\\mathop{\\mathrm{Spec}}(R)$ are exactly the subsets $V(\\mathfrak p)$, with $\\mathfrak p \\subset R$ a minimal prime. \n\n\n\n\n    \n      Proof.\n      Note that if $ \\mathfrak p \\in V(I)$, then $I \\subset \\mathfrak p$. Hence, clearly $\\overline{\\{ \\mathfrak p\\} } = V(\\mathfrak p)$. In particular $V(\\mathfrak p)$ is the closure of a singleton and hence irreducible. The second assertion implies the third. To show the second, let $V(I) \\subset \\mathop{\\mathrm{Spec}}(R)$ with $I$ a radical ideal. If $I$ is not prime, then choose $a, b\\in R$, $a, b\\not\\in I$ with $ab\\in I$. In this case $V(I, a) \\cup V(I, b) = V(I)$, but neither $V(I, b) = V(I)$ nor $V(I, a) = V(I)$, by Lemma 10.17.2. Hence $V(I)$ is not irreducible. \n      $\\square$\n    \n","\n  Lemma 10.26.1. Let $R$ be a ring. \n  \n  \nFor a prime $\\mathfrak p \\subset R$ the closure of $\\{ \\mathfrak p\\} $ in the Zariski topology is $V(\\mathfrak p)$. In a formula $\\overline{\\{ \\mathfrak p\\} } = V(\\mathfrak p)$. \n\n\nThe irreducible closed subsets of $\\mathop{\\mathrm{Spec}}(R)$ are exactly the subsets $V(\\mathfrak p)$, with $\\mathfrak p \\subset R$ a prime. \n\n\nThe irreducible components (see Topology, Definition 5.8.1) of $\\mathop{\\mathrm{Spec}}(R)$ are exactly the subsets $V(\\mathfrak p)$, with $\\mathfrak p \\subset R$ a minimal prime. \n\n\n\n\n    \n","Proof.\n      Note that if $ \\mathfrak p \\in V(I)$, then $I \\subset \\mathfrak p$. Hence, clearly $\\overline{\\{ \\mathfrak p\\} } = V(\\mathfrak p)$. In particular $V(\\mathfrak p)$ is the closure of a singleton and hence irreducible. The second assertion implies the third. To show the second, let $V(I) \\subset \\mathop{\\mathrm{Spec}}(R)$ with $I$ a radical ideal. If $I$ is not prime, then choose $a, b\\in R$, $a, b\\not\\in I$ with $ab\\in I$. In this case $V(I, a) \\cup V(I, b) = V(I)$, but neither $V(I, b) = V(I)$ nor $V(I, a) = V(I)$, by Lemma 10.17.2. Hence $V(I)$ is not irreducible. \n      $\\square$\n    \n"," by
  let e : {p : Ideal R | p.IsPrime âˆ§ âŠ¥ â‰¤ p} â‰ƒo PrimeSpectrum R :=
    âŸ¨âŸ¨fun x â†¦ âŸ¨x.1, x.2.1âŸ©, fun x â†¦ âŸ¨x.1, x.2, bot_leâŸ©, fun _ â†¦ rfl, fun _ â†¦ rflâŸ©, Iff.rflâŸ©
  rw [irreducibleComponents_eq_maximals_closed]
  exact OrderIso.setOfMinimalIsoSetOfMaximal
    (e.trans ((PrimeSpectrum.pointsEquivIrreducibleCloseds R).trans
    (TopologicalSpace.IrreducibleCloseds.orderIsoSubtype' (PrimeSpectrum R)).dual))
","protected def _root_.minimalPrimes.equivIrreducibleComponents :
    minimalPrimes R â‰ƒo (irreducibleComponents <| PrimeSpectrum R)áµ’áµˆ ","Proof.\n      Note that if $ \\mathfrak p \\in V(I)$, then $I \\subset \\mathfrak p$. Hence, clearly $\\overline{\\{ \\mathfrak p\\} } = V(\\mathfrak p)$. In particular $V(\\mathfrak p)$ is the closure of a singleton and hence irreducible. The second assertion implies the third. To show the second, let $V(I) \\subset \\mathop{\\mathrm{Spec}}(R)$ with $I$ a radical ideal. If $I$ is not prime, then choose $a, b\\in R$, $a, b\\not\\in I$ with $ab\\in I$. In this case $V(I, a) \\cup V(I, b) = V(I)$, but neither $V(I, b) = V(I)$ nor $V(I, a) = V(I)$, by Lemma 10.17.2 [[\n  Lemma 10.17.2. Let $R$ be a ring. \n  \n  \nThe spectrum of a ring $R$ is empty if and only if $R$ is the zero ring. \n\n\nEvery nonzero ring has a maximal ideal. \n\n\nEvery nonzero ring has a minimal prime ideal. \n\n\nGiven an ideal $I \\subset R$ and a prime ideal $I \\subset \\mathfrak p$ there exists a prime $I \\subset \\mathfrak q \\subset \\mathfrak p$ such that $\\mathfrak q$ is minimal over $I$. \n\n\nIf $T \\subset R$, and if $(T)$ is the ideal generated by $T$ in $R$, then $V((T)) = V(T)$. \n\n\nIf $I$ is an ideal and $\\sqrt{I}$ is its radical, see basic notion (27), then $V(I) = V(\\sqrt{I})$. \n\n\nGiven an ideal $I$ of $R$ we have $\\sqrt{I} = \\bigcap _{I \\subset \\mathfrak p} \\mathfrak p$. \n\n\nIf $I$ is an ideal then $V(I) = \\emptyset $ if and only if $I$ is the unit ideal. \n\n\nIf $I$, $J$ are ideals of $R$ then $V(I) \\cup V(J) = V(I \\cap J)$. \n\n\nIf $(I_ a)_{a\\in A}$ is a set of ideals of $R$ then $\\bigcap _{a\\in A} V(I_ a) = V(\\bigcup _{a\\in A} I_ a)$. \n\n\nIf $f \\in R$, then $D(f) \\amalg V(f) = \\mathop{\\mathrm{Spec}}(R)$. \n\n\nIf $f \\in R$ then $D(f) = \\emptyset $ if and only if $f$ is nilpotent. \n\n\nIf $f = u f\'$ for some unit $u \\in R$, then $D(f) = D(f\')$. \n\n\nIf $I \\subset R$ is an ideal, and $\\mathfrak p$ is a prime of $R$ with $\\mathfrak p \\not\\in V(I)$, then there exists an $f \\in R$ such that $\\mathfrak p \\in D(f)$, and $D(f) \\cap V(I) = \\emptyset $. \n\n\nIf $f, g \\in R$, then $D(fg) = D(f) \\cap D(g)$. \n\n\nIf $f_ i \\in R$ for $i \\in I$, then $\\bigcup _{i\\in I} D(f_ i)$ is the complement of $V(\\{ f_ i \\} _{i\\in I})$ in $\\mathop{\\mathrm{Spec}}(R)$. \n\n\nIf $f \\in R$ and $D(f) = \\mathop{\\mathrm{Spec}}(R)$, then $f$ is a unit. \n\n\n\n\n    \n]]. Hence $V(I)$ is not irreducible. \n      $\\square$\n    \n"
346,00EC,"lemma zeroLocus_eq_basicOpen_of_isIdempotentElem
    (e : R) (he : IsIdempotentElem e) :
    zeroLocus {e} = basicOpen (1 - e) := by
  rw [basicOpen_eq_zeroLocus_of_isIdempotentElem _ he.one_sub, sub_sub_cancel]
",Formal Proof of Stacks Project Tag 00EC,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Spectrum/Prime/Topology.lean#L1288-L1291,Q27041,,10.21.1,lemma,3.0,"['04PN', '00AO', '0ELQ']",\n  Lemma 10.21.1. Let $R$ be a ring. Let $e \\in R$ be an idempotent. In this case \n  \n  \\[  \\mathop{\\mathrm{Spec}}(R) = D(e) \\amalg D(1-e).  \\]\n\n\n    \n      Proof.\n      Note that an idempotent $e$ of a domain is either $1$ or $0$. Hence we see that \n    \n      \n  \\begin{eqnarray*}  D(e) &  = &  \\{  \\mathfrak p \\in \\mathop{\\mathrm{Spec}}(R) \\mid e \\not\\in \\mathfrak p \\}  \\\\ &  = &  \\{  \\mathfrak p \\in \\mathop{\\mathrm{Spec}}(R) \\mid e \\not= 0\\text{ in }\\kappa (\\mathfrak p) \\}  \\\\ &  = &  \\{  \\mathfrak p \\in \\mathop{\\mathrm{Spec}}(R) \\mid e = 1\\text{ in }\\kappa (\\mathfrak p) \\}  \\end{eqnarray*}\n\n    \n       Similarly we have \n    \n      \n  \\begin{eqnarray*}  D(1-e) &  = &  \\{  \\mathfrak p \\in \\mathop{\\mathrm{Spec}}(R) \\mid 1 - e \\not\\in \\mathfrak p \\}  \\\\ &  = &  \\{  \\mathfrak p \\in \\mathop{\\mathrm{Spec}}(R) \\mid e \\not= 1\\text{ in }\\kappa (\\mathfrak p) \\}  \\\\ &  = &  \\{  \\mathfrak p \\in \\mathop{\\mathrm{Spec}}(R) \\mid e = 0\\text{ in }\\kappa (\\mathfrak p) \\}  \\end{eqnarray*}\n\n    \n       Since the image of $e$ in any residue field is either $1$ or $0$ we deduce that $D(e)$ and $D(1-e)$ cover all of $\\mathop{\\mathrm{Spec}}(R)$. \n      $\\square$\n    \n,\n  Lemma 10.21.1. Let $R$ be a ring. Let $e \\in R$ be an idempotent. In this case \n  \n  \\[  \\mathop{\\mathrm{Spec}}(R) = D(e) \\amalg D(1-e).  \\]\n\n\n    \n,Proof.\n      Note that an idempotent $e$ of a domain is either $1$ or $0$. Hence we see that \n    \n      \n  \\begin{eqnarray*}  D(e) &  = &  \\{  \\mathfrak p \\in \\mathop{\\mathrm{Spec}}(R) \\mid e \\not\\in \\mathfrak p \\}  \\\\ &  = &  \\{  \\mathfrak p \\in \\mathop{\\mathrm{Spec}}(R) \\mid e \\not= 0\\text{ in }\\kappa (\\mathfrak p) \\}  \\\\ &  = &  \\{  \\mathfrak p \\in \\mathop{\\mathrm{Spec}}(R) \\mid e = 1\\text{ in }\\kappa (\\mathfrak p) \\}  \\end{eqnarray*}\n\n    \n       Similarly we have \n    \n      \n  \\begin{eqnarray*}  D(1-e) &  = &  \\{  \\mathfrak p \\in \\mathop{\\mathrm{Spec}}(R) \\mid 1 - e \\not\\in \\mathfrak p \\}  \\\\ &  = &  \\{  \\mathfrak p \\in \\mathop{\\mathrm{Spec}}(R) \\mid e \\not= 1\\text{ in }\\kappa (\\mathfrak p) \\}  \\\\ &  = &  \\{  \\mathfrak p \\in \\mathop{\\mathrm{Spec}}(R) \\mid e = 0\\text{ in }\\kappa (\\mathfrak p) \\}  \\end{eqnarray*}\n\n    \n       Since the image of $e$ in any residue field is either $1$ or $0$ we deduce that $D(e)$ and $D(1-e)$ cover all of $\\mathop{\\mathrm{Spec}}(R)$. \n      $\\square$\n    \n," by
  rw [basicOpen_eq_zeroLocus_of_isIdempotentElem _ he.one_sub, sub_sub_cancel]
","lemma zeroLocus_eq_basicOpen_of_isIdempotentElem
    (e : R) (he : IsIdempotentElem e) :
    zeroLocus {e} = basicOpen (1 - e) ",Proof.\n      Note that an idempotent $e$ of a domain is either $1$ or $0$. Hence we see that \n    \n      \n  \\begin{eqnarray*}  D(e) &  = &  \\{  \\mathfrak p \\in \\mathop{\\mathrm{Spec}}(R) \\mid e \\not\\in \\mathfrak p \\}  \\\\ &  = &  \\{  \\mathfrak p \\in \\mathop{\\mathrm{Spec}}(R) \\mid e \\not= 0\\text{ in }\\kappa (\\mathfrak p) \\}  \\\\ &  = &  \\{  \\mathfrak p \\in \\mathop{\\mathrm{Spec}}(R) \\mid e = 1\\text{ in }\\kappa (\\mathfrak p) \\}  \\end{eqnarray*}\n\n    \n       Similarly we have \n    \n      \n  \\begin{eqnarray*}  D(1-e) &  = &  \\{  \\mathfrak p \\in \\mathop{\\mathrm{Spec}}(R) \\mid 1 - e \\not\\in \\mathfrak p \\}  \\\\ &  = &  \\{  \\mathfrak p \\in \\mathop{\\mathrm{Spec}}(R) \\mid e \\not= 1\\text{ in }\\kappa (\\mathfrak p) \\}  \\\\ &  = &  \\{  \\mathfrak p \\in \\mathop{\\mathrm{Spec}}(R) \\mid e = 0\\text{ in }\\kappa (\\mathfrak p) \\}  \\end{eqnarray*}\n\n    \n       Since the image of $e$ in any residue field is either $1$ or $0$ we deduce that $D(e)$ and $D(1-e)$ cover all of $\\mathop{\\mathrm{Spec}}(R)$. \n      $\\square$\n    \n
347,0BIL,"theorem traceForm_nondegenerate [FiniteDimensional K L] [Algebra.IsSeparable K L] :
    (traceForm K L).Nondegenerate :=
  BilinForm.nondegenerate_of_det_ne_zero (traceForm K L) _
    (det_traceForm_ne_zero (Module.finBasis K L))
",Formal Proof of Stacks Project Tag 0BIL,(1) => (3),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Trace/Basic.lean#L503-L506,Q27041,,9.20.7,lemma,3.0,"['0BIE', '09FA', '0ELQ']","\n  Lemma 9.20.7. Let $L/K$ be a finite extension of fields. The following are equivalent: \n  \n  \n$L/K$ is separable, \n\n\n$\\text{Trace}_{L/K}$ is not identically zero, and \n\n\nthe trace pairing $Q_{L/K}$ is nondegenerate. \n\n\n\n\n    \n      Proof.\n      It is clear that (3) implies (2). If (2) holds, then pick $\\gamma \\in L$ with $\\text{Trace}_{L/K}(\\gamma ) \\not= 0$. Then if $\\alpha \\in L$ is nonzero, we see that $Q_{L/K}(\\alpha , \\gamma /\\alpha ) \\not= 0$. Hence $Q_{L/K}$ is nondegenerate. This proves the equivalence of (2) and (3). \n    \n      Suppose that $K$ has characteristic $p$ and $L = K(\\alpha )$ with $\\alpha \\not\\in K$ and $\\alpha ^ p \\in K$. Then $\\text{Trace}_{L/K}(1) = p = 0$. For $i = 1, \\ldots , p - 1$ we see that $x^ p - \\alpha ^{pi}$ is the minimal polynomial for $\\alpha ^ i$ over $K$ and we find $\\text{Trace}_{L/K}(\\alpha ^ i) = 0$ by Lemma 9.20.3. Hence for this kind of purely inseparable degree $p$ extension we see that $\\text{Trace}_{L/K}$ is identically zero. \n    \n      Assume that $L/K$ is not separable. Then there exists a subfield $L/K\'/K$ such that $L/K\'$ is a purely inseparable degree $p$ extension as in the previous paragraph, see Lemmas 9.14.6 and 9.14.5. Hence by Lemma 9.20.5 we see that $\\text{Trace}_{L/K}$ is identically zero. \n    \n      Assume on the other hand that $L/K$ is separable. By induction on the degree we will show that $\\text{Trace}_{L/K}$ is not identically zero. Thus by Lemma 9.20.5 we may assume that $L/K$ is generated by a single element $\\alpha $ (use that if the trace is nonzero then it is surjective). We have to show that $\\text{Trace}_{L/K}(\\alpha ^ e)$ is nonzero for some $e \\geq 0$. Let $P = x^ d + a_1 x^{d - 1} + \\ldots + a_ d$ be the minimal polynomial of $\\alpha $ over $K$. Then $P$ is also the characteristic polynomial of the linear maps $\\alpha : L \\to L$, see Lemma 9.20.2. Since $L/k$ is separable we see from Lemma 9.12.4 that $P$ has $d$ pairwise distinct roots $\\alpha _1, \\ldots , \\alpha _ d$ in an algebraic closure $\\overline{K}$ of $K$. Thus these are the eigenvalues of $\\alpha : L \\to L$. By linear algebra, the trace of $\\alpha ^ e$ is equal to $\\alpha _1^ e + \\ldots + \\alpha _ d^ e$. Thus we conclude by Lemma 9.13.2. \n      $\\square$\n    \n","\n  Lemma 9.20.7. Let $L/K$ be a finite extension of fields. The following are equivalent: \n  \n  \n$L/K$ is separable, \n\n\n$\\text{Trace}_{L/K}$ is not identically zero, and \n\n\nthe trace pairing $Q_{L/K}$ is nondegenerate. \n\n\n\n\n    \n","Proof.\n      It is clear that (3) implies (2). If (2) holds, then pick $\\gamma \\in L$ with $\\text{Trace}_{L/K}(\\gamma ) \\not= 0$. Then if $\\alpha \\in L$ is nonzero, we see that $Q_{L/K}(\\alpha , \\gamma /\\alpha ) \\not= 0$. Hence $Q_{L/K}$ is nondegenerate. This proves the equivalence of (2) and (3). \n    \n      Suppose that $K$ has characteristic $p$ and $L = K(\\alpha )$ with $\\alpha \\not\\in K$ and $\\alpha ^ p \\in K$. Then $\\text{Trace}_{L/K}(1) = p = 0$. For $i = 1, \\ldots , p - 1$ we see that $x^ p - \\alpha ^{pi}$ is the minimal polynomial for $\\alpha ^ i$ over $K$ and we find $\\text{Trace}_{L/K}(\\alpha ^ i) = 0$ by Lemma 9.20.3. Hence for this kind of purely inseparable degree $p$ extension we see that $\\text{Trace}_{L/K}$ is identically zero. \n    \n      Assume that $L/K$ is not separable. Then there exists a subfield $L/K\'/K$ such that $L/K\'$ is a purely inseparable degree $p$ extension as in the previous paragraph, see Lemmas 9.14.6 and 9.14.5. Hence by Lemma 9.20.5 we see that $\\text{Trace}_{L/K}$ is identically zero. \n    \n      Assume on the other hand that $L/K$ is separable. By induction on the degree we will show that $\\text{Trace}_{L/K}$ is not identically zero. Thus by Lemma 9.20.5 we may assume that $L/K$ is generated by a single element $\\alpha $ (use that if the trace is nonzero then it is surjective). We have to show that $\\text{Trace}_{L/K}(\\alpha ^ e)$ is nonzero for some $e \\geq 0$. Let $P = x^ d + a_1 x^{d - 1} + \\ldots + a_ d$ be the minimal polynomial of $\\alpha $ over $K$. Then $P$ is also the characteristic polynomial of the linear maps $\\alpha : L \\to L$, see Lemma 9.20.2. Since $L/k$ is separable we see from Lemma 9.12.4 that $P$ has $d$ pairwise distinct roots $\\alpha _1, \\ldots , \\alpha _ d$ in an algebraic closure $\\overline{K}$ of $K$. Thus these are the eigenvalues of $\\alpha : L \\to L$. By linear algebra, the trace of $\\alpha ^ e$ is equal to $\\alpha _1^ e + \\ldots + \\alpha _ d^ e$. Thus we conclude by Lemma 9.13.2. \n      $\\square$\n    \n","
  BilinForm.nondegenerate_of_det_ne_zero (traceForm K L) _
    (det_traceForm_ne_zero (Module.finBasis K L))
","theorem traceForm_nondegenerate [FiniteDimensional K L] [Algebra.IsSeparable K L] :
    (traceForm K L).Nondegenerate ","Proof.\n      It is clear that (3) implies (2). If (2) holds, then pick $\\gamma \\in L$ with $\\text{Trace}_{L/K}(\\gamma ) \\not= 0$. Then if $\\alpha \\in L$ is nonzero, we see that $Q_{L/K}(\\alpha , \\gamma /\\alpha ) \\not= 0$. Hence $Q_{L/K}$ is nondegenerate. This proves the equivalence of (2) and (3). \n    \n      Suppose that $K$ has characteristic $p$ and $L = K(\\alpha )$ with $\\alpha \\not\\in K$ and $\\alpha ^ p \\in K$. Then $\\text{Trace}_{L/K}(1) = p = 0$. For $i = 1, \\ldots , p - 1$ we see that $x^ p - \\alpha ^{pi}$ is the minimal polynomial for $\\alpha ^ i$ over $K$ and we find $\\text{Trace}_{L/K}(\\alpha ^ i) = 0$ by Lemma 9.20.3 [[\n  Lemma 9.20.3. Let $L/K$ be a finite extension of fields. Let $\\alpha \\in L$ and let $P = x^ d + a_1 x^{d - 1} + \\ldots + a_ d$ be the minimal polynomial of $\\alpha $ over $K$. Then \n  \n  \\[  \\text{Norm}_{L/K}(\\alpha ) = (-1)^{[L : K]} a_ d^ e \\quad \\text{and}\\quad \\text{Trace}_{L/K}(\\alpha ) = - e a_1  \\]\n\n   where $e d = [L : K]$. \n\n    \n]]. Hence for this kind of purely inseparable degree $p$ extension we see that $\\text{Trace}_{L/K}$ is identically zero. \n    \n      Assume that $L/K$ is not separable. Then there exists a subfield $L/K\'/K$ such that $L/K\'$ is a purely inseparable degree $p$ extension as in the previous paragraph, see Lemmas 9.14.6 [[\n       \n      \n  Lemma 9.14.6. Let $E/F$ be an algebraic field extension. There exists a unique subextension $E/E_{sep}/F$ such that $E_{sep}/F$ is separable and $E/E_{sep}$ is purely inseparable. \n\n    \n]] and 9.14.5 [[\n  Lemma 9.14.5. Let $E/F$ be a finite purely inseparable field extension of characteristic $p > 0$. Then there exists a sequence of elements $\\alpha _1, \\ldots , \\alpha _ n \\in E$ such that we obtain a tower of fields \n  \n  \\[  E = F(\\alpha _1, \\ldots , \\alpha _ n) \\supset F(\\alpha _1, \\ldots , \\alpha _{n - 1}) \\supset \\ldots \\supset F(\\alpha _1) \\supset F  \\]\n\n   such that each intermediate extension is of degree $p$ and comes from adjoining a $p$th root. Namely, $\\alpha _ i^ p \\in F(\\alpha _1, \\ldots , \\alpha _{i - 1})$ is an element which does not have a $p$th root in $F(\\alpha _1, \\ldots , \\alpha _{i - 1})$ for $i = 1, \\ldots , n$. \n\n    \n]]. Hence by Lemma 9.20.5 [[\n  Lemma 9.20.5. Let $M/L/K$ be a tower of finite extensions of fields. Then \n  \n  \\[  \\text{Trace}_{M/K} = \\text{Trace}_{L/K} \\circ \\text{Trace}_{M/L} \\quad \\text{and}\\quad \\text{Norm}_{M/K} = \\text{Norm}_{L/K} \\circ \\text{Norm}_{M/L}  \\]\n\n\n    \n]] we see that $\\text{Trace}_{L/K}$ is identically zero. \n    \n      Assume on the other hand that $L/K$ is separable. By induction on the degree we will show that $\\text{Trace}_{L/K}$ is not identically zero. Thus by Lemma 9.20.5 [[\n  Lemma 9.20.5. Let $M/L/K$ be a tower of finite extensions of fields. Then \n  \n  \\[  \\text{Trace}_{M/K} = \\text{Trace}_{L/K} \\circ \\text{Trace}_{M/L} \\quad \\text{and}\\quad \\text{Norm}_{M/K} = \\text{Norm}_{L/K} \\circ \\text{Norm}_{M/L}  \\]\n\n\n    \n]] we may assume that $L/K$ is generated by a single element $\\alpha $ (use that if the trace is nonzero then it is surjective). We have to show that $\\text{Trace}_{L/K}(\\alpha ^ e)$ is nonzero for some $e \\geq 0$. Let $P = x^ d + a_1 x^{d - 1} + \\ldots + a_ d$ be the minimal polynomial of $\\alpha $ over $K$. Then $P$ is also the characteristic polynomial of the linear maps $\\alpha : L \\to L$, see Lemma 9.20.2 [[\n  Lemma 9.20.2. Let $L/K$ be a finite extension of fields. Let $\\alpha \\in L$ and let $P$ be the minimal polynomial of $\\alpha $ over $K$. Then the characteristic polynomial of the $K$-linear map $\\alpha : L \\to L$ is equal to $P^ e$ with $e \\deg (P) = [L : K]$. \n\n    \n]]. Since $L/k$ is separable we see from Lemma 9.12.4 [[\n  Lemma 9.12.4. Let $F$ be a field. An irreducible polynomial $P$ over $F$ is separable if and only if $P$ has pairwise distinct roots in an algebraic closure of $F$. \n\n    \n]] that $P$ has $d$ pairwise distinct roots $\\alpha _1, \\ldots , \\alpha _ d$ in an algebraic closure $\\overline{K}$ of $K$. Thus these are the eigenvalues of $\\alpha : L \\to L$. By linear algebra, the trace of $\\alpha ^ e$ is equal to $\\alpha _1^ e + \\ldots + \\alpha _ d^ e$. Thus we conclude by Lemma 9.13.2 [[\n  Lemma 9.13.2. Let $L$ be a field. Let $n \\geq 1$ and $\\alpha _1, \\ldots , \\alpha _ n \\in L$ pairwise distinct elements of $L$. Then there exists an $e \\geq 0$ such that $\\sum _{i = 1, \\ldots , n} \\alpha _ i^ e \\not= 0$. \n\n    \n]]. \n      $\\square$\n    \n"
348,0BIL,"theorem traceForm_nondegenerate_tfae [FiniteDimensional K L] :
    [Algebra.IsSeparable K L, Algebra.trace K L â‰  0, (traceForm K L).Nondegenerate].TFAE := by
  tfae_have 1 â†’ 3 := fun _ â†¦ traceForm_nondegenerate K L
  tfae_have 3 â†’ 2 := fun Hâ‚ Hâ‚‚ â†¦ Hâ‚.ne_zero (by ext; simp [Hâ‚‚])
  tfae_have 2 â†’ 1 := not_imp_comm.mp Algebra.trace_eq_zero_of_not_isSeparable
  tfae_finish
",Formal Proof of Stacks Project Tag 0BIL,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Trace/Basic.lean#L509-L514,Q27041,,9.20.7,lemma,3.0,"['0BIE', '09FA', '0ELQ']","\n  Lemma 9.20.7. Let $L/K$ be a finite extension of fields. The following are equivalent: \n  \n  \n$L/K$ is separable, \n\n\n$\\text{Trace}_{L/K}$ is not identically zero, and \n\n\nthe trace pairing $Q_{L/K}$ is nondegenerate. \n\n\n\n\n    \n      Proof.\n      It is clear that (3) implies (2). If (2) holds, then pick $\\gamma \\in L$ with $\\text{Trace}_{L/K}(\\gamma ) \\not= 0$. Then if $\\alpha \\in L$ is nonzero, we see that $Q_{L/K}(\\alpha , \\gamma /\\alpha ) \\not= 0$. Hence $Q_{L/K}$ is nondegenerate. This proves the equivalence of (2) and (3). \n    \n      Suppose that $K$ has characteristic $p$ and $L = K(\\alpha )$ with $\\alpha \\not\\in K$ and $\\alpha ^ p \\in K$. Then $\\text{Trace}_{L/K}(1) = p = 0$. For $i = 1, \\ldots , p - 1$ we see that $x^ p - \\alpha ^{pi}$ is the minimal polynomial for $\\alpha ^ i$ over $K$ and we find $\\text{Trace}_{L/K}(\\alpha ^ i) = 0$ by Lemma 9.20.3. Hence for this kind of purely inseparable degree $p$ extension we see that $\\text{Trace}_{L/K}$ is identically zero. \n    \n      Assume that $L/K$ is not separable. Then there exists a subfield $L/K\'/K$ such that $L/K\'$ is a purely inseparable degree $p$ extension as in the previous paragraph, see Lemmas 9.14.6 and 9.14.5. Hence by Lemma 9.20.5 we see that $\\text{Trace}_{L/K}$ is identically zero. \n    \n      Assume on the other hand that $L/K$ is separable. By induction on the degree we will show that $\\text{Trace}_{L/K}$ is not identically zero. Thus by Lemma 9.20.5 we may assume that $L/K$ is generated by a single element $\\alpha $ (use that if the trace is nonzero then it is surjective). We have to show that $\\text{Trace}_{L/K}(\\alpha ^ e)$ is nonzero for some $e \\geq 0$. Let $P = x^ d + a_1 x^{d - 1} + \\ldots + a_ d$ be the minimal polynomial of $\\alpha $ over $K$. Then $P$ is also the characteristic polynomial of the linear maps $\\alpha : L \\to L$, see Lemma 9.20.2. Since $L/k$ is separable we see from Lemma 9.12.4 that $P$ has $d$ pairwise distinct roots $\\alpha _1, \\ldots , \\alpha _ d$ in an algebraic closure $\\overline{K}$ of $K$. Thus these are the eigenvalues of $\\alpha : L \\to L$. By linear algebra, the trace of $\\alpha ^ e$ is equal to $\\alpha _1^ e + \\ldots + \\alpha _ d^ e$. Thus we conclude by Lemma 9.13.2. \n      $\\square$\n    \n","\n  Lemma 9.20.7. Let $L/K$ be a finite extension of fields. The following are equivalent: \n  \n  \n$L/K$ is separable, \n\n\n$\\text{Trace}_{L/K}$ is not identically zero, and \n\n\nthe trace pairing $Q_{L/K}$ is nondegenerate. \n\n\n\n\n    \n","Proof.\n      It is clear that (3) implies (2). If (2) holds, then pick $\\gamma \\in L$ with $\\text{Trace}_{L/K}(\\gamma ) \\not= 0$. Then if $\\alpha \\in L$ is nonzero, we see that $Q_{L/K}(\\alpha , \\gamma /\\alpha ) \\not= 0$. Hence $Q_{L/K}$ is nondegenerate. This proves the equivalence of (2) and (3). \n    \n      Suppose that $K$ has characteristic $p$ and $L = K(\\alpha )$ with $\\alpha \\not\\in K$ and $\\alpha ^ p \\in K$. Then $\\text{Trace}_{L/K}(1) = p = 0$. For $i = 1, \\ldots , p - 1$ we see that $x^ p - \\alpha ^{pi}$ is the minimal polynomial for $\\alpha ^ i$ over $K$ and we find $\\text{Trace}_{L/K}(\\alpha ^ i) = 0$ by Lemma 9.20.3. Hence for this kind of purely inseparable degree $p$ extension we see that $\\text{Trace}_{L/K}$ is identically zero. \n    \n      Assume that $L/K$ is not separable. Then there exists a subfield $L/K\'/K$ such that $L/K\'$ is a purely inseparable degree $p$ extension as in the previous paragraph, see Lemmas 9.14.6 and 9.14.5. Hence by Lemma 9.20.5 we see that $\\text{Trace}_{L/K}$ is identically zero. \n    \n      Assume on the other hand that $L/K$ is separable. By induction on the degree we will show that $\\text{Trace}_{L/K}$ is not identically zero. Thus by Lemma 9.20.5 we may assume that $L/K$ is generated by a single element $\\alpha $ (use that if the trace is nonzero then it is surjective). We have to show that $\\text{Trace}_{L/K}(\\alpha ^ e)$ is nonzero for some $e \\geq 0$. Let $P = x^ d + a_1 x^{d - 1} + \\ldots + a_ d$ be the minimal polynomial of $\\alpha $ over $K$. Then $P$ is also the characteristic polynomial of the linear maps $\\alpha : L \\to L$, see Lemma 9.20.2. Since $L/k$ is separable we see from Lemma 9.12.4 that $P$ has $d$ pairwise distinct roots $\\alpha _1, \\ldots , \\alpha _ d$ in an algebraic closure $\\overline{K}$ of $K$. Thus these are the eigenvalues of $\\alpha : L \\to L$. By linear algebra, the trace of $\\alpha ^ e$ is equal to $\\alpha _1^ e + \\ldots + \\alpha _ d^ e$. Thus we conclude by Lemma 9.13.2. \n      $\\square$\n    \n"," by
  tfae_have 1 â†’ 3 := fun _ â†¦ traceForm_nondegenerate K L
  tfae_have 3 â†’ 2 := fun Hâ‚ Hâ‚‚ â†¦ Hâ‚.ne_zero (by ext; simp [Hâ‚‚])
  tfae_have 2 â†’ 1 := not_imp_comm.mp Algebra.trace_eq_zero_of_not_isSeparable
  tfae_finish
","theorem traceForm_nondegenerate_tfae [FiniteDimensional K L] :
    [Algebra.IsSeparable K L, Algebra.trace K L â‰  0, (traceForm K L).Nondegenerate].TFAE ","Proof.\n      It is clear that (3) implies (2). If (2) holds, then pick $\\gamma \\in L$ with $\\text{Trace}_{L/K}(\\gamma ) \\not= 0$. Then if $\\alpha \\in L$ is nonzero, we see that $Q_{L/K}(\\alpha , \\gamma /\\alpha ) \\not= 0$. Hence $Q_{L/K}$ is nondegenerate. This proves the equivalence of (2) and (3). \n    \n      Suppose that $K$ has characteristic $p$ and $L = K(\\alpha )$ with $\\alpha \\not\\in K$ and $\\alpha ^ p \\in K$. Then $\\text{Trace}_{L/K}(1) = p = 0$. For $i = 1, \\ldots , p - 1$ we see that $x^ p - \\alpha ^{pi}$ is the minimal polynomial for $\\alpha ^ i$ over $K$ and we find $\\text{Trace}_{L/K}(\\alpha ^ i) = 0$ by Lemma 9.20.3 [[\n  Lemma 9.20.3. Let $L/K$ be a finite extension of fields. Let $\\alpha \\in L$ and let $P = x^ d + a_1 x^{d - 1} + \\ldots + a_ d$ be the minimal polynomial of $\\alpha $ over $K$. Then \n  \n  \\[  \\text{Norm}_{L/K}(\\alpha ) = (-1)^{[L : K]} a_ d^ e \\quad \\text{and}\\quad \\text{Trace}_{L/K}(\\alpha ) = - e a_1  \\]\n\n   where $e d = [L : K]$. \n\n    \n]]. Hence for this kind of purely inseparable degree $p$ extension we see that $\\text{Trace}_{L/K}$ is identically zero. \n    \n      Assume that $L/K$ is not separable. Then there exists a subfield $L/K\'/K$ such that $L/K\'$ is a purely inseparable degree $p$ extension as in the previous paragraph, see Lemmas 9.14.6 [[\n       \n      \n  Lemma 9.14.6. Let $E/F$ be an algebraic field extension. There exists a unique subextension $E/E_{sep}/F$ such that $E_{sep}/F$ is separable and $E/E_{sep}$ is purely inseparable. \n\n    \n]] and 9.14.5 [[\n  Lemma 9.14.5. Let $E/F$ be a finite purely inseparable field extension of characteristic $p > 0$. Then there exists a sequence of elements $\\alpha _1, \\ldots , \\alpha _ n \\in E$ such that we obtain a tower of fields \n  \n  \\[  E = F(\\alpha _1, \\ldots , \\alpha _ n) \\supset F(\\alpha _1, \\ldots , \\alpha _{n - 1}) \\supset \\ldots \\supset F(\\alpha _1) \\supset F  \\]\n\n   such that each intermediate extension is of degree $p$ and comes from adjoining a $p$th root. Namely, $\\alpha _ i^ p \\in F(\\alpha _1, \\ldots , \\alpha _{i - 1})$ is an element which does not have a $p$th root in $F(\\alpha _1, \\ldots , \\alpha _{i - 1})$ for $i = 1, \\ldots , n$. \n\n    \n]]. Hence by Lemma 9.20.5 [[\n  Lemma 9.20.5. Let $M/L/K$ be a tower of finite extensions of fields. Then \n  \n  \\[  \\text{Trace}_{M/K} = \\text{Trace}_{L/K} \\circ \\text{Trace}_{M/L} \\quad \\text{and}\\quad \\text{Norm}_{M/K} = \\text{Norm}_{L/K} \\circ \\text{Norm}_{M/L}  \\]\n\n\n    \n]] we see that $\\text{Trace}_{L/K}$ is identically zero. \n    \n      Assume on the other hand that $L/K$ is separable. By induction on the degree we will show that $\\text{Trace}_{L/K}$ is not identically zero. Thus by Lemma 9.20.5 [[\n  Lemma 9.20.5. Let $M/L/K$ be a tower of finite extensions of fields. Then \n  \n  \\[  \\text{Trace}_{M/K} = \\text{Trace}_{L/K} \\circ \\text{Trace}_{M/L} \\quad \\text{and}\\quad \\text{Norm}_{M/K} = \\text{Norm}_{L/K} \\circ \\text{Norm}_{M/L}  \\]\n\n\n    \n]] we may assume that $L/K$ is generated by a single element $\\alpha $ (use that if the trace is nonzero then it is surjective). We have to show that $\\text{Trace}_{L/K}(\\alpha ^ e)$ is nonzero for some $e \\geq 0$. Let $P = x^ d + a_1 x^{d - 1} + \\ldots + a_ d$ be the minimal polynomial of $\\alpha $ over $K$. Then $P$ is also the characteristic polynomial of the linear maps $\\alpha : L \\to L$, see Lemma 9.20.2 [[\n  Lemma 9.20.2. Let $L/K$ be a finite extension of fields. Let $\\alpha \\in L$ and let $P$ be the minimal polynomial of $\\alpha $ over $K$. Then the characteristic polynomial of the $K$-linear map $\\alpha : L \\to L$ is equal to $P^ e$ with $e \\deg (P) = [L : K]$. \n\n    \n]]. Since $L/k$ is separable we see from Lemma 9.12.4 [[\n  Lemma 9.12.4. Let $F$ be a field. An irreducible polynomial $P$ over $F$ is separable if and only if $P$ has pairwise distinct roots in an algebraic closure of $F$. \n\n    \n]] that $P$ has $d$ pairwise distinct roots $\\alpha _1, \\ldots , \\alpha _ d$ in an algebraic closure $\\overline{K}$ of $K$. Thus these are the eigenvalues of $\\alpha : L \\to L$. By linear algebra, the trace of $\\alpha ^ e$ is equal to $\\alpha _1^ e + \\ldots + \\alpha _ d^ e$. Thus we conclude by Lemma 9.13.2 [[\n  Lemma 9.13.2. Let $L$ be a field. Let $n \\geq 1$ and $\\alpha _1, \\ldots , \\alpha _ n \\in L$ pairwise distinct elements of $L$. Then there exists an $e \\geq 0$ such that $\\sum _{i = 1, \\ldots , n} \\alpha _ i^ e \\not= 0$. \n\n    \n]]. \n      $\\square$\n    \n"
349,0BIF,"noncomputable def trace : S â†’â‚—[R] R :=
  (LinearMap.trace R S).comp (lmul R S).toLinearMap
",Formal Proof of Stacks Project Tag 0BIF,Trace,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Trace/Defs.lean#L71-L72,Q27041,,9.20.1,definition,3.0,"['0BIE', '09FA', '0ELQ']",\n  Definition 9.20.1. Let $L/K$ be a finite extension of fields. For $\\alpha \\in L$ we define the trace $\\text{Trace}_{L/K}(\\alpha ) = \\text{Trace}_ K(\\alpha : L \\to L)$ and the norm $\\text{Norm}_{L/K}(\\alpha ) = \\det _ K(\\alpha : L \\to L)$. \n,\n  Definition 9.20.1. Let $L/K$ be a finite extension of fields. For $\\alpha \\in L$ we define the trace $\\text{Trace}_{L/K}(\\alpha ) = \\text{Trace}_ K(\\alpha : L \\to L)$ and the norm $\\text{Norm}_{L/K}(\\alpha ) = \\det _ K(\\alpha : L \\to L)$. \n,,"
  (LinearMap.trace R S).comp (lmul R S).toLinearMap
",noncomputable def trace : S â†’â‚—[R] R ,
350,0BIK,"noncomputable def traceForm : BilinForm R S :=
  LinearMap.comprâ‚‚ (lmul R S).toLinearMap (trace R S)
",Formal Proof of Stacks Project Tag 0BIK,Trace pairing,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Trace/Defs.lean#L170-L171,Q27041,,9.20.6,definition,3.0,"['0BIE', '09FA', '0ELQ']","\n  Definition 9.20.6. Let $L/K$ be a finite extension of fields. The trace pairing for $L/K$ is the symmetric $K$-bilinear form \n  \n  \\[  Q_{L/K} : L \\times L \\longrightarrow K,\\quad (\\alpha , \\beta ) \\longmapsto \\text{Trace}_{L/K}(\\alpha \\beta )  \\]\n\n","\n  Definition 9.20.6. Let $L/K$ be a finite extension of fields. The trace pairing for $L/K$ is the symmetric $K$-bilinear form \n  \n  \\[  Q_{L/K} : L \\times L \\longrightarrow K,\\quad (\\alpha , \\beta ) \\longmapsto \\text{Trace}_{L/K}(\\alpha \\beta )  \\]\n\n",,"
  LinearMap.comprâ‚‚ (lmul R S).toLinearMap (trace R S)
",noncomputable def traceForm : BilinForm R S ,
351,00UT,"<https://stacks.math.columbia.edu/tag/00UU> shows that their definition is the same as this one.""]
class Unramified : Prop where
  formallyUnramified : FormallyUnramified R A := by infer_instance
  finiteType : FiniteType R A := by infer_instance
",Formal Proof of Stacks Project Tag 00UT,"Note that the Stacks project has a different definition of unramified, and ta",https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Unramified/Basic.lean#L337-L340,Q27041,,10.151.1,definition,3.0,"['00US', '00AO', '0ELQ']","\n  Definition 10.151.1. Let $R \\to S$ be a ring map. \n  \n  \nWe say $R \\to S$ is unramified if $R \\to S$ is of finite type and $\\Omega _{S/R} = 0$. \n\n\nWe say $R \\to S$ is G-unramified if $R \\to S$ is of finite presentation and $\\Omega _{S/R} = 0$. \n\n\nGiven a prime $\\mathfrak q$ of $S$ we say that $S$ is unramified at $\\mathfrak q$ if there exists a $g \\in S$, $g \\not\\in \\mathfrak q$ such that $R \\to S_ g$ is unramified. \n\n\nGiven a prime $\\mathfrak q$ of $S$ we say that $S$ is G-unramified at $\\mathfrak q$ if there exists a $g \\in S$, $g \\not\\in \\mathfrak q$ such that $R \\to S_ g$ is G-unramified. \n\n\n\n","\n  Definition 10.151.1. Let $R \\to S$ be a ring map. \n  \n  \nWe say $R \\to S$ is unramified if $R \\to S$ is of finite type and $\\Omega _{S/R} = 0$. \n\n\nWe say $R \\to S$ is G-unramified if $R \\to S$ is of finite presentation and $\\Omega _{S/R} = 0$. \n\n\nGiven a prime $\\mathfrak q$ of $S$ we say that $S$ is unramified at $\\mathfrak q$ if there exists a $g \\in S$, $g \\not\\in \\mathfrak q$ such that $R \\to S_ g$ is unramified. \n\n\nGiven a prime $\\mathfrak q$ of $S$ we say that $S$ is G-unramified at $\\mathfrak q$ if there exists a $g \\in S$, $g \\not\\in \\mathfrak q$ such that $R \\to S_ g$ is G-unramified. \n\n\n\n",," by infer_instance
  finiteType : FiniteType R A := by infer_instance
","<https://stacks.math.columbia.edu/tag/00UU> shows that their definition is the same as this one.""]
class Unramified : Prop where
  formallyUnramified : FormallyUnramified R A ",
352,00UW,"instance [FormallyUnramified R S] :
    Algebra.IsSeparable (ResidueField R) (ResidueField S) :=
  FormallyUnramified.isSeparable _ _
",Formal Proof of Stacks Project Tag 00UW,(2),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Unramified/LocalRing.lean#L53-L55,Q27041,,10.151.5,lemma,3.0,"['00US', '00AO', '0ELQ']","\n  Lemma 10.151.5. Let $R \\to S$ be a ring map. Let $\\mathfrak q \\subset S$ be a prime lying over $\\mathfrak p$ in $R$. If $S/R$ is unramified at $\\mathfrak q$ then \n  \n  \nwe have $\\mathfrak p S_{\\mathfrak q} = \\mathfrak qS_{\\mathfrak q}$ is the maximal ideal of the local ring $S_{\\mathfrak q}$, and \n\n\nthe field extension $\\kappa (\\mathfrak q)/\\kappa (\\mathfrak p)$ is finite separable. \n\n\n\n\n    \n      Proof.\n      We may first replace $S$ by $S_ g$ for some $g \\in S$, $g \\not\\in \\mathfrak q$ and assume that $R \\to S$ is unramified. The base change $S \\otimes _ R \\kappa (\\mathfrak p)$ is unramified over $\\kappa (\\mathfrak p)$ by Lemma 10.151.3. By Lemma 10.140.3 it is smooth hence \xc3\xa9tale over $\\kappa (\\mathfrak p)$. Hence we see that $S \\otimes _ R \\kappa (\\mathfrak p) = (R \\setminus \\mathfrak p)^{-1} S/\\mathfrak pS$ is a product of finite separable field extensions of $\\kappa (\\mathfrak p)$ by Lemma 10.143.4. This implies the lemma. \n      $\\square$\n    \n","\n  Lemma 10.151.5. Let $R \\to S$ be a ring map. Let $\\mathfrak q \\subset S$ be a prime lying over $\\mathfrak p$ in $R$. If $S/R$ is unramified at $\\mathfrak q$ then \n  \n  \nwe have $\\mathfrak p S_{\\mathfrak q} = \\mathfrak qS_{\\mathfrak q}$ is the maximal ideal of the local ring $S_{\\mathfrak q}$, and \n\n\nthe field extension $\\kappa (\\mathfrak q)/\\kappa (\\mathfrak p)$ is finite separable. \n\n\n\n\n    \n","Proof.\n      We may first replace $S$ by $S_ g$ for some $g \\in S$, $g \\not\\in \\mathfrak q$ and assume that $R \\to S$ is unramified. The base change $S \\otimes _ R \\kappa (\\mathfrak p)$ is unramified over $\\kappa (\\mathfrak p)$ by Lemma 10.151.3. By Lemma 10.140.3 it is smooth hence \xc3\xa9tale over $\\kappa (\\mathfrak p)$. Hence we see that $S \\otimes _ R \\kappa (\\mathfrak p) = (R \\setminus \\mathfrak p)^{-1} S/\\mathfrak pS$ is a product of finite separable field extensions of $\\kappa (\\mathfrak p)$ by Lemma 10.143.4. This implies the lemma. \n      $\\square$\n    \n","
  FormallyUnramified.isSeparable _ _
","instance [FormallyUnramified R S] :
    Algebra.IsSeparable (ResidueField R) (ResidueField S) ","Proof.\n      We may first replace $S$ by $S_ g$ for some $g \\in S$, $g \\not\\in \\mathfrak q$ and assume that $R \\to S$ is unramified. The base change $S \\otimes _ R \\kappa (\\mathfrak p)$ is unramified over $\\kappa (\\mathfrak p)$ by Lemma 10.151.3 [[\n  Lemma 10.151.3. Properties of unramified and G-unramified ring maps. \n  \n  \nThe base change of an unramified ring map is unramified. The base change of a G-unramified ring map is G-unramified. \n\n\nThe composition of unramified ring maps is unramified. The composition of G-unramified ring maps is G-unramified. \n\n\nAny principal localization $R \\to R_ f$ is G-unramified and unramified. \n\n\nIf $I \\subset R$ is an ideal, then $R \\to R/I$ is unramified. If $I \\subset R$ is a finitely generated ideal, then $R \\to R/I$ is G-unramified. \n\n\nAn \xc3\xa9tale ring map is G-unramified and unramified. \n\n\nIf $R \\to S$ is of finite type (resp. finite presentation), $\\mathfrak q \\subset S$ is a prime and $(\\Omega _{S/R})_{\\mathfrak q} = 0$, then $R \\to S$ is unramified (resp. G-unramified) at $\\mathfrak q$. \n\n\nIf $R \\to S$ is of finite type (resp. finite presentation), $\\mathfrak q \\subset S$ is a prime and $\\Omega _{S/R} \\otimes _ S \\kappa (\\mathfrak q) = 0$, then $R \\to S$ is unramified (resp. G-unramified) at $\\mathfrak q$. \n\n\nIf $R \\to S$ is of finite type (resp. finite presentation), $\\mathfrak q \\subset S$ is a prime lying over $\\mathfrak p \\subset R$ and $(\\Omega _{S \\otimes _ R \\kappa (\\mathfrak p)/\\kappa (\\mathfrak p)})_{\\mathfrak q} = 0$, then $R \\to S$ is unramified (resp. G-unramified) at $\\mathfrak q$. \n\n\nIf $R \\to S$ is of finite type (resp. presentation), $\\mathfrak q \\subset S$ is a prime lying over $\\mathfrak p \\subset R$ and $(\\Omega _{S \\otimes _ R \\kappa (\\mathfrak p)/\\kappa (\\mathfrak p)}) \\otimes _{S \\otimes _ R \\kappa (\\mathfrak p)} \\kappa (\\mathfrak q) = 0$, then $R \\to S$ is unramified (resp. G-unramified) at $\\mathfrak q$. \n\n\nIf $R \\to S$ is a ring map, $g_1, \\ldots , g_ m \\in S$ generate the unit ideal and $R \\to S_{g_ j}$ is unramified (resp. G-unramified) for $j = 1, \\ldots , m$, then $R \\to S$ is unramified (resp. G-unramified). \n\n\nIf $R \\to S$ is a ring map which is unramified (resp. G-unramified) at every prime of $S$, then $R \\to S$ is unramified (resp. G-unramified). \n\n\nIf $R \\to S$ is G-unramified, then there exists a finite type $\\mathbf{Z}$-algebra $R_0$ and a G-unramified ring map $R_0 \\to S_0$ and a ring map $R_0 \\to R$ such that $S = R \\otimes _{R_0} S_0$. \n\n\nIf $R \\to S$ is unramified, then there exists a finite type $\\mathbf{Z}$-algebra $R_0$ and an unramified ring map $R_0 \\to S_0$ and a ring map $R_0 \\to R$ such that $S$ is a quotient of $R \\otimes _{R_0} S_0$. \n\n\n\n\n    \n]]. By Lemma 10.140.3 [[\n  Lemma 10.140.3. Let $k$ be any field. Let $S$ be a finite type $k$-algebra. Let $X = \\mathop{\\mathrm{Spec}}(S)$. Let $\\mathfrak q \\subset S$ be a prime corresponding to $x \\in X$. The following are equivalent: \n  \n  \nThe $k$-algebra $S$ is smooth at $\\mathfrak q$ over $k$. \n\n\nWe have $\\dim _{\\kappa (\\mathfrak q)} \\Omega _{S/k} \\otimes _ S \\kappa (\\mathfrak q) \\leq \\dim _ x X$. \n\n\nWe have $\\dim _{\\kappa (\\mathfrak q)} \\Omega _{S/k} \\otimes _ S \\kappa (\\mathfrak q) = \\dim _ x X$. \n\n\n\n   Moreover, in this case the local ring $S_{\\mathfrak q}$ is regular. \n\n    \n]] it is smooth hence \xc3\xa9tale over $\\kappa (\\mathfrak p)$. Hence we see that $S \\otimes _ R \\kappa (\\mathfrak p) = (R \\setminus \\mathfrak p)^{-1} S/\\mathfrak pS$ is a product of finite separable field extensions of $\\kappa (\\mathfrak p)$ by Lemma 10.143.4 [[\n  Lemma 10.143.4. Let $k$ be a field. A ring map $k \\to S$ is \xc3\xa9tale if and only if $S$ is isomorphic as a $k$-algebra to a finite product of finite separable extensions of $k$. \n\n    \n]]. This implies the lemma. \n      $\\square$\n    \n"
353,00UW,"lemma FormallyUnramified.map_maximalIdeal [FormallyUnramified R S] :
    (maximalIdeal R).map (algebraMap R S) = maximalIdeal S := by
  apply eq_maximalIdeal
  rw [Ideal.Quotient.maximal_ideal_iff_isField_quotient]
  exact isField_quotient_map_maximalIdeal
",Formal Proof of Stacks Project Tag 00UW,(1),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Unramified/LocalRing.lean#L77-L81,Q27041,,10.151.5,lemma,3.0,"['00US', '00AO', '0ELQ']","\n  Lemma 10.151.5. Let $R \\to S$ be a ring map. Let $\\mathfrak q \\subset S$ be a prime lying over $\\mathfrak p$ in $R$. If $S/R$ is unramified at $\\mathfrak q$ then \n  \n  \nwe have $\\mathfrak p S_{\\mathfrak q} = \\mathfrak qS_{\\mathfrak q}$ is the maximal ideal of the local ring $S_{\\mathfrak q}$, and \n\n\nthe field extension $\\kappa (\\mathfrak q)/\\kappa (\\mathfrak p)$ is finite separable. \n\n\n\n\n    \n      Proof.\n      We may first replace $S$ by $S_ g$ for some $g \\in S$, $g \\not\\in \\mathfrak q$ and assume that $R \\to S$ is unramified. The base change $S \\otimes _ R \\kappa (\\mathfrak p)$ is unramified over $\\kappa (\\mathfrak p)$ by Lemma 10.151.3. By Lemma 10.140.3 it is smooth hence \xc3\xa9tale over $\\kappa (\\mathfrak p)$. Hence we see that $S \\otimes _ R \\kappa (\\mathfrak p) = (R \\setminus \\mathfrak p)^{-1} S/\\mathfrak pS$ is a product of finite separable field extensions of $\\kappa (\\mathfrak p)$ by Lemma 10.143.4. This implies the lemma. \n      $\\square$\n    \n","\n  Lemma 10.151.5. Let $R \\to S$ be a ring map. Let $\\mathfrak q \\subset S$ be a prime lying over $\\mathfrak p$ in $R$. If $S/R$ is unramified at $\\mathfrak q$ then \n  \n  \nwe have $\\mathfrak p S_{\\mathfrak q} = \\mathfrak qS_{\\mathfrak q}$ is the maximal ideal of the local ring $S_{\\mathfrak q}$, and \n\n\nthe field extension $\\kappa (\\mathfrak q)/\\kappa (\\mathfrak p)$ is finite separable. \n\n\n\n\n    \n","Proof.\n      We may first replace $S$ by $S_ g$ for some $g \\in S$, $g \\not\\in \\mathfrak q$ and assume that $R \\to S$ is unramified. The base change $S \\otimes _ R \\kappa (\\mathfrak p)$ is unramified over $\\kappa (\\mathfrak p)$ by Lemma 10.151.3. By Lemma 10.140.3 it is smooth hence \xc3\xa9tale over $\\kappa (\\mathfrak p)$. Hence we see that $S \\otimes _ R \\kappa (\\mathfrak p) = (R \\setminus \\mathfrak p)^{-1} S/\\mathfrak pS$ is a product of finite separable field extensions of $\\kappa (\\mathfrak p)$ by Lemma 10.143.4. This implies the lemma. \n      $\\square$\n    \n"," by
  apply eq_maximalIdeal
  rw [Ideal.Quotient.maximal_ideal_iff_isField_quotient]
  exact isField_quotient_map_maximalIdeal
","lemma FormallyUnramified.map_maximalIdeal [FormallyUnramified R S] :
    (maximalIdeal R).map (algebraMap R S) = maximalIdeal S ","Proof.\n      We may first replace $S$ by $S_ g$ for some $g \\in S$, $g \\not\\in \\mathfrak q$ and assume that $R \\to S$ is unramified. The base change $S \\otimes _ R \\kappa (\\mathfrak p)$ is unramified over $\\kappa (\\mathfrak p)$ by Lemma 10.151.3 [[\n  Lemma 10.151.3. Properties of unramified and G-unramified ring maps. \n  \n  \nThe base change of an unramified ring map is unramified. The base change of a G-unramified ring map is G-unramified. \n\n\nThe composition of unramified ring maps is unramified. The composition of G-unramified ring maps is G-unramified. \n\n\nAny principal localization $R \\to R_ f$ is G-unramified and unramified. \n\n\nIf $I \\subset R$ is an ideal, then $R \\to R/I$ is unramified. If $I \\subset R$ is a finitely generated ideal, then $R \\to R/I$ is G-unramified. \n\n\nAn \xc3\xa9tale ring map is G-unramified and unramified. \n\n\nIf $R \\to S$ is of finite type (resp. finite presentation), $\\mathfrak q \\subset S$ is a prime and $(\\Omega _{S/R})_{\\mathfrak q} = 0$, then $R \\to S$ is unramified (resp. G-unramified) at $\\mathfrak q$. \n\n\nIf $R \\to S$ is of finite type (resp. finite presentation), $\\mathfrak q \\subset S$ is a prime and $\\Omega _{S/R} \\otimes _ S \\kappa (\\mathfrak q) = 0$, then $R \\to S$ is unramified (resp. G-unramified) at $\\mathfrak q$. \n\n\nIf $R \\to S$ is of finite type (resp. finite presentation), $\\mathfrak q \\subset S$ is a prime lying over $\\mathfrak p \\subset R$ and $(\\Omega _{S \\otimes _ R \\kappa (\\mathfrak p)/\\kappa (\\mathfrak p)})_{\\mathfrak q} = 0$, then $R \\to S$ is unramified (resp. G-unramified) at $\\mathfrak q$. \n\n\nIf $R \\to S$ is of finite type (resp. presentation), $\\mathfrak q \\subset S$ is a prime lying over $\\mathfrak p \\subset R$ and $(\\Omega _{S \\otimes _ R \\kappa (\\mathfrak p)/\\kappa (\\mathfrak p)}) \\otimes _{S \\otimes _ R \\kappa (\\mathfrak p)} \\kappa (\\mathfrak q) = 0$, then $R \\to S$ is unramified (resp. G-unramified) at $\\mathfrak q$. \n\n\nIf $R \\to S$ is a ring map, $g_1, \\ldots , g_ m \\in S$ generate the unit ideal and $R \\to S_{g_ j}$ is unramified (resp. G-unramified) for $j = 1, \\ldots , m$, then $R \\to S$ is unramified (resp. G-unramified). \n\n\nIf $R \\to S$ is a ring map which is unramified (resp. G-unramified) at every prime of $S$, then $R \\to S$ is unramified (resp. G-unramified). \n\n\nIf $R \\to S$ is G-unramified, then there exists a finite type $\\mathbf{Z}$-algebra $R_0$ and a G-unramified ring map $R_0 \\to S_0$ and a ring map $R_0 \\to R$ such that $S = R \\otimes _{R_0} S_0$. \n\n\nIf $R \\to S$ is unramified, then there exists a finite type $\\mathbf{Z}$-algebra $R_0$ and an unramified ring map $R_0 \\to S_0$ and a ring map $R_0 \\to R$ such that $S$ is a quotient of $R \\otimes _{R_0} S_0$. \n\n\n\n\n    \n]]. By Lemma 10.140.3 [[\n  Lemma 10.140.3. Let $k$ be any field. Let $S$ be a finite type $k$-algebra. Let $X = \\mathop{\\mathrm{Spec}}(S)$. Let $\\mathfrak q \\subset S$ be a prime corresponding to $x \\in X$. The following are equivalent: \n  \n  \nThe $k$-algebra $S$ is smooth at $\\mathfrak q$ over $k$. \n\n\nWe have $\\dim _{\\kappa (\\mathfrak q)} \\Omega _{S/k} \\otimes _ S \\kappa (\\mathfrak q) \\leq \\dim _ x X$. \n\n\nWe have $\\dim _{\\kappa (\\mathfrak q)} \\Omega _{S/k} \\otimes _ S \\kappa (\\mathfrak q) = \\dim _ x X$. \n\n\n\n   Moreover, in this case the local ring $S_{\\mathfrak q}$ is regular. \n\n    \n]] it is smooth hence \xc3\xa9tale over $\\kappa (\\mathfrak p)$. Hence we see that $S \\otimes _ R \\kappa (\\mathfrak p) = (R \\setminus \\mathfrak p)^{-1} S/\\mathfrak pS$ is a product of finite separable field extensions of $\\kappa (\\mathfrak p)$ by Lemma 10.143.4 [[\n  Lemma 10.143.4. Let $k$ be a field. A ring map $k \\to S$ is \xc3\xa9tale if and only if $S$ is isomorphic as a $k$-algebra to a finite product of finite separable extensions of $k$. \n\n    \n]]. This implies the lemma. \n      $\\square$\n    \n"
354,02FM,"lemma FormallyUnramified.of_map_maximalIdeal
    [Algebra.IsSeparable (ResidueField R) (ResidueField S)]
    (H : (maximalIdeal R).map (algebraMap R S) = maximalIdeal S) :
    Algebra.FormallyUnramified R S := by
  constructor
  have : FormallyUnramified (ResidueField R) (ResidueField S) := .of_isSeparable _ _
  have : FormallyUnramified R (ResidueField S) := .comp _ (ResidueField R) _
  rw [â† subsingleton_tensorProduct (R := S)]
  refine subsingleton_of_forall_eq 0 fun x â†¦ ?_
  obtain âŸ¨x, rflâŸ© := (KaehlerDifferential.exact_kerCotangentToTensor_mapBaseChange R S
    (ResidueField S) Ideal.Quotient.mk_surjective x).mp (Subsingleton.elim _ _)
  obtain âŸ¨âŸ¨x, hxâŸ©, rflâŸ© := Ideal.toCotangent_surjective _ x
  simp only [KaehlerDifferential.kerCotangentToTensor_toCotangent]
  replace hx : x âˆˆ Ideal.map (algebraMap R S) (maximalIdeal R) := by simpa [H] using hx
  induction hx using Submodule.span_induction with
  | zero => simp
  | mem x h => obtain âŸ¨x, hx, rflâŸ© := h; simp
  | add x y hx hy _ _ => simp [*, TensorProduct.tmul_add]
  | smul a x hx _ =>
    have : residue S x = 0 := by rwa [residue_eq_zero_iff, â† H]
    simp [*, TensorProduct.tmul_add, TensorProduct.smul_tmul', â† Algebra.algebraMap_eq_smul_one]
",Formal Proof of Stacks Project Tag 02FM,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Unramified/LocalRing.lean#L84-L104,Q27041,,10.151.7,lemma,3.0,"['00US', '00AO', '0ELQ']","\n  Lemma 10.151.7. Let $R \\to S$ be a ring map. Let $\\mathfrak q$ be a prime of $S$ lying over a prime $\\mathfrak p$ of $R$. If \n  \n  \n$R \\to S$ is of finite type, \n\n\n$\\mathfrak p S_{\\mathfrak q}$ is the maximal ideal of the local ring $S_{\\mathfrak q}$, and \n\n\nthe field extension $\\kappa (\\mathfrak q)/\\kappa (\\mathfrak p)$ is finite separable, \n\n\n\n   then $R \\to S$ is unramified at $\\mathfrak q$. \n\n    \n      Proof.\n      By Lemma 10.151.3 (8) it suffices to show that $\\Omega _{S \\otimes _ R \\kappa (\\mathfrak p) / \\kappa (\\mathfrak p)}$ is zero when localized at $\\mathfrak q$. Hence we may replace $S$ by $S \\otimes _ R \\kappa (\\mathfrak p)$ and $R$ by $\\kappa (\\mathfrak p)$. In other words, we may assume that $R = k$ is a field and $S$ is a finite type $k$-algebra. In this case the hypotheses imply that $S_{\\mathfrak q} \\cong \\kappa (\\mathfrak q)$. Thus $(\\Omega _{S/k})_{\\mathfrak q} = \\Omega _{S_\\mathfrak q/k} = \\Omega _{\\kappa (\\mathfrak q)/k}$ is zero as desired (the first equality is Lemma 10.131.8). \n      $\\square$\n    \n","\n  Lemma 10.151.7. Let $R \\to S$ be a ring map. Let $\\mathfrak q$ be a prime of $S$ lying over a prime $\\mathfrak p$ of $R$. If \n  \n  \n$R \\to S$ is of finite type, \n\n\n$\\mathfrak p S_{\\mathfrak q}$ is the maximal ideal of the local ring $S_{\\mathfrak q}$, and \n\n\nthe field extension $\\kappa (\\mathfrak q)/\\kappa (\\mathfrak p)$ is finite separable, \n\n\n\n   then $R \\to S$ is unramified at $\\mathfrak q$. \n\n    \n","Proof.\n      By Lemma 10.151.3 (8) it suffices to show that $\\Omega _{S \\otimes _ R \\kappa (\\mathfrak p) / \\kappa (\\mathfrak p)}$ is zero when localized at $\\mathfrak q$. Hence we may replace $S$ by $S \\otimes _ R \\kappa (\\mathfrak p)$ and $R$ by $\\kappa (\\mathfrak p)$. In other words, we may assume that $R = k$ is a field and $S$ is a finite type $k$-algebra. In this case the hypotheses imply that $S_{\\mathfrak q} \\cong \\kappa (\\mathfrak q)$. Thus $(\\Omega _{S/k})_{\\mathfrak q} = \\Omega _{S_\\mathfrak q/k} = \\Omega _{\\kappa (\\mathfrak q)/k}$ is zero as desired (the first equality is Lemma 10.131.8). \n      $\\square$\n    \n"," by
  constructor
  have : FormallyUnramified (ResidueField R) (ResidueField S) := .of_isSeparable _ _
  have : FormallyUnramified R (ResidueField S) := .comp _ (ResidueField R) _
  rw [â† subsingleton_tensorProduct (R := S)]
  refine subsingleton_of_forall_eq 0 fun x â†¦ ?_
  obtain âŸ¨x, rflâŸ© := (KaehlerDifferential.exact_kerCotangentToTensor_mapBaseChange R S
    (ResidueField S) Ideal.Quotient.mk_surjective x).mp (Subsingleton.elim _ _)
  obtain âŸ¨âŸ¨x, hxâŸ©, rflâŸ© := Ideal.toCotangent_surjective _ x
  simp only [KaehlerDifferential.kerCotangentToTensor_toCotangent]
  replace hx : x âˆˆ Ideal.map (algebraMap R S) (maximalIdeal R) := by simpa [H] using hx
  induction hx using Submodule.span_induction with
  | zero => simp
  | mem x h => obtain âŸ¨x, hx, rflâŸ© := h; simp
  | add x y hx hy _ _ => simp [*, TensorProduct.tmul_add]
  | smul a x hx _ =>
    have : residue S x = 0 := by rwa [residue_eq_zero_iff, â† H]
    simp [*, TensorProduct.tmul_add, TensorProduct.smul_tmul', â† Algebra.algebraMap_eq_smul_one]
","lemma FormallyUnramified.of_map_maximalIdeal
    [Algebra.IsSeparable (ResidueField R) (ResidueField S)]
    (H : (maximalIdeal R).map (algebraMap R S) = maximalIdeal S) :
    Algebra.FormallyUnramified R S ","Proof.\n      By Lemma 10.151.3 [[\n  Lemma 10.151.3. Properties of unramified and G-unramified ring maps. \n  \n  \nThe base change of an unramified ring map is unramified. The base change of a G-unramified ring map is G-unramified. \n\n\nThe composition of unramified ring maps is unramified. The composition of G-unramified ring maps is G-unramified. \n\n\nAny principal localization $R \\to R_ f$ is G-unramified and unramified. \n\n\nIf $I \\subset R$ is an ideal, then $R \\to R/I$ is unramified. If $I \\subset R$ is a finitely generated ideal, then $R \\to R/I$ is G-unramified. \n\n\nAn \xc3\xa9tale ring map is G-unramified and unramified. \n\n\nIf $R \\to S$ is of finite type (resp. finite presentation), $\\mathfrak q \\subset S$ is a prime and $(\\Omega _{S/R})_{\\mathfrak q} = 0$, then $R \\to S$ is unramified (resp. G-unramified) at $\\mathfrak q$. \n\n\nIf $R \\to S$ is of finite type (resp. finite presentation), $\\mathfrak q \\subset S$ is a prime and $\\Omega _{S/R} \\otimes _ S \\kappa (\\mathfrak q) = 0$, then $R \\to S$ is unramified (resp. G-unramified) at $\\mathfrak q$. \n\n\nIf $R \\to S$ is of finite type (resp. finite presentation), $\\mathfrak q \\subset S$ is a prime lying over $\\mathfrak p \\subset R$ and $(\\Omega _{S \\otimes _ R \\kappa (\\mathfrak p)/\\kappa (\\mathfrak p)})_{\\mathfrak q} = 0$, then $R \\to S$ is unramified (resp. G-unramified) at $\\mathfrak q$. \n\n\nIf $R \\to S$ is of finite type (resp. presentation), $\\mathfrak q \\subset S$ is a prime lying over $\\mathfrak p \\subset R$ and $(\\Omega _{S \\otimes _ R \\kappa (\\mathfrak p)/\\kappa (\\mathfrak p)}) \\otimes _{S \\otimes _ R \\kappa (\\mathfrak p)} \\kappa (\\mathfrak q) = 0$, then $R \\to S$ is unramified (resp. G-unramified) at $\\mathfrak q$. \n\n\nIf $R \\to S$ is a ring map, $g_1, \\ldots , g_ m \\in S$ generate the unit ideal and $R \\to S_{g_ j}$ is unramified (resp. G-unramified) for $j = 1, \\ldots , m$, then $R \\to S$ is unramified (resp. G-unramified). \n\n\nIf $R \\to S$ is a ring map which is unramified (resp. G-unramified) at every prime of $S$, then $R \\to S$ is unramified (resp. G-unramified). \n\n\nIf $R \\to S$ is G-unramified, then there exists a finite type $\\mathbf{Z}$-algebra $R_0$ and a G-unramified ring map $R_0 \\to S_0$ and a ring map $R_0 \\to R$ such that $S = R \\otimes _{R_0} S_0$. \n\n\nIf $R \\to S$ is unramified, then there exists a finite type $\\mathbf{Z}$-algebra $R_0$ and an unramified ring map $R_0 \\to S_0$ and a ring map $R_0 \\to R$ such that $S$ is a quotient of $R \\otimes _{R_0} S_0$. \n\n\n\n\n    \n]] (8) it suffices to show that $\\Omega _{S \\otimes _ R \\kappa (\\mathfrak p) / \\kappa (\\mathfrak p)}$ is zero when localized at $\\mathfrak q$. Hence we may replace $S$ by $S \\otimes _ R \\kappa (\\mathfrak p)$ and $R$ by $\\kappa (\\mathfrak p)$. In other words, we may assume that $R = k$ is a field and $S$ is a finite type $k$-algebra. In this case the hypotheses imply that $S_{\\mathfrak q} \\cong \\kappa (\\mathfrak q)$. Thus $(\\Omega _{S/k})_{\\mathfrak q} = \\Omega _{S_\\mathfrak q/k} = \\Omega _{\\kappa (\\mathfrak q)/k}$ is zero as desired (the first equality is Lemma 10.131.8 [[\n  Lemma 10.131.8. Let $\\varphi : A \\to B$ be a ring map. \n  \n  \nIf $S \\subset A$ is a multiplicative subset mapping to invertible elements of $B$, then $\\Omega _{B/A} = \\Omega _{B/S^{-1}A}$. \n\n\nIf $S \\subset B$ is a multiplicative subset then $S^{-1}\\Omega _{B/A} = \\Omega _{S^{-1}B/A}$. \n\n\n\n\n    \n]]). \n      $\\square$\n    \n"
355,00IC,"-- the conclusion could be `IsIntegrallyClosedIn R.toSubring K`, which has slightly worse defeq.
lemma LocalSubring.mem_of_isMax_of_isIntegral {R : LocalSubring K}
    (hR : IsMax R) {x : K} (hx : IsIntegral R.toSubring x) : x âˆˆ R.toSubring := by
  let S := Algebra.adjoin R.toSubring {x}
  have : Algebra.IsIntegral R.toSubring S := Algebra.IsIntegral.adjoin (by simpa)
  obtain âŸ¨Q : Ideal S.toSubring, hQ, eâŸ© := Ideal.exists_ideal_over_maximal_of_isIntegral
    (S := S) (maximalIdeal R.toSubring) (le_maximalIdeal (by simp))
  have : R = .ofPrime S.toSubring Q := by
    have hRS : R.toSubring â‰¤ S.toSubring := fun r hr â†¦ algebraMap_mem S âŸ¨r, hrâŸ©
    refine hR.eq_of_le âŸ¨hRS.trans (LocalSubring.le_ofPrime _ _), ((local_hom_TFAE _).out 2 0).mp ?_âŸ©
    conv_rhs => rw [â† IsLocalization.AtPrime.map_eq_maximalIdeal Q]
    refine .trans ?_ (Ideal.map_mono <| Ideal.map_le_iff_le_comap.mpr e.ge)
    rw [Ideal.map_map]; rfl
  rw [this]
  exact LocalSubring.le_ofPrime _ _ (Algebra.self_mem_adjoin_singleton _ _)
",Formal Proof of Stacks Project Tag 00IC,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Valuation/LocalSubring.lean#L60-L74,Q27041,,10.50.3,lemma,3.0,"['00I8', '00AO', '0ELQ']","\n  Lemma 10.50.3. Let $A$ be a valuation ring. Then $A$ is a normal domain. \n\n    \n      Proof.\n      Suppose $x$ is in the field of fractions of $A$ and integral over $A$. Let $A\'$ denote the subring of $K$ generated by $A$ and $x$. Since $A\\subset A\'$ is an integral extension, we see by Lemma 10.36.17 that there is a prime ideal $\\mathfrak m\' \\subset A\'$ lying over $\\mathfrak m$. Then $A\'_{\\mathfrak m\'}$ dominates $A$. Since $A$ is a valuation ring we conclude that $A=A\'_{\\mathfrak m\'}$ and therefore that $x\\in A$. \n      $\\square$\n    \n",\n  Lemma 10.50.3. Let $A$ be a valuation ring. Then $A$ is a normal domain. \n\n    \n,"Proof.\n      Suppose $x$ is in the field of fractions of $A$ and integral over $A$. Let $A\'$ denote the subring of $K$ generated by $A$ and $x$. Since $A\\subset A\'$ is an integral extension, we see by Lemma 10.36.17 that there is a prime ideal $\\mathfrak m\' \\subset A\'$ lying over $\\mathfrak m$. Then $A\'_{\\mathfrak m\'}$ dominates $A$. Since $A$ is a valuation ring we conclude that $A=A\'_{\\mathfrak m\'}$ and therefore that $x\\in A$. \n      $\\square$\n    \n"," by
  let S := Algebra.adjoin R.toSubring {x}
  have : Algebra.IsIntegral R.toSubring S := Algebra.IsIntegral.adjoin (by simpa)
  obtain âŸ¨Q : Ideal S.toSubring, hQ, eâŸ© := Ideal.exists_ideal_over_maximal_of_isIntegral
    (S := S) (maximalIdeal R.toSubring) (le_maximalIdeal (by simp))
  have : R = .ofPrime S.toSubring Q := by
    have hRS : R.toSubring â‰¤ S.toSubring := fun r hr â†¦ algebraMap_mem S âŸ¨r, hrâŸ©
    refine hR.eq_of_le âŸ¨hRS.trans (LocalSubring.le_ofPrime _ _), ((local_hom_TFAE _).out 2 0).mp ?_âŸ©
    conv_rhs => rw [â† IsLocalization.AtPrime.map_eq_maximalIdeal Q]
    refine .trans ?_ (Ideal.map_mono <| Ideal.map_le_iff_le_comap.mpr e.ge)
    rw [Ideal.map_map]; rfl
  rw [this]
  exact LocalSubring.le_ofPrime _ _ (Algebra.self_mem_adjoin_singleton _ _)
","-- the conclusion could be `IsIntegrallyClosedIn R.toSubring K`, which has slightly worse defeq.
lemma LocalSubring.mem_of_isMax_of_isIntegral {R : LocalSubring K}
    (hR : IsMax R) {x : K} (hx : IsIntegral R.toSubring x) : x âˆˆ R.toSubring ","Proof.\n      Suppose $x$ is in the field of fractions of $A$ and integral over $A$. Let $A\'$ denote the subring of $K$ generated by $A$ and $x$. Since $A\\subset A\'$ is an integral extension, we see by Lemma 10.36.17 [[\n  Lemma 10.36.17. Suppose that $R \\to S$ is an integral ring extension with $R \\subset S$. Then $\\varphi : \\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R)$ is surjective. \n\n    \n]] that there is a prime ideal $\\mathfrak m\' \\subset A\'$ lying over $\\mathfrak m$. Then $A\'_{\\mathfrak m\'}$ dominates $A$. Since $A$ is a valuation ring we conclude that $A=A\'_{\\mathfrak m\'}$ and therefore that $x\\in A$. \n      $\\square$\n    \n"
356,052K,"lemma ValuationSubring.isMax_toLocalSubring (R : ValuationSubring K) :
    IsMax R.toLocalSubring := by
  intro S hS
  refine (LocalSubring.toSubring_injective (hS.1.antisymm fun x hx â†¦ (R.2 x).elim id fun h â†¦ ?_)).ge
  by_contra h'
  have hx0 : x â‰  0 := by rintro rfl; exact h' R.zero_mem
  have : IsUnit (Subring.inclusion hS.1 âŸ¨xâ»Â¹, hâŸ©) :=
    isUnit_iff_exists_inv.mpr âŸ¨âŸ¨x, hxâŸ©, Subtype.ext (inv_mul_cancelâ‚€ hx0)âŸ©
  obtain âŸ¨x', hx'âŸ© := isUnit_iff_exists_inv.mp (hS.2.1 _ this)
  have : x' = x := by simpa [Subtype.ext_iff, inv_mul_eq_iff_eq_mulâ‚€ hx0] using hx'
  exact h' (this â–¸ x'.2)
",Formal Proof of Stacks Project Tag 052K,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Valuation/LocalSubring.lean#L77-L87,Q27041,,10.50.5,lemma,3.0,"['00I8', '00AO', '0ELQ']","\n  Lemma 10.50.5. Let $A \\subset K$ be a subring of a field $K$ such that for all $x \\in K$ either $x \\in A$ or $x^{-1} \\in A$ or both. Then $A$ is a valuation ring with fraction field $K$. \n\n    \n      Proof.\n      If $A$ is not $K$, then $A$ is not a field and there is a nonzero maximal ideal $\\mathfrak m$. If $\\mathfrak m\'$ is a second maximal ideal, then choose $x, y \\in A$ with $x \\in \\mathfrak m$, $y \\not\\in \\mathfrak m$, $x \\not\\in \\mathfrak m\'$, and $y \\in \\mathfrak m\'$. Then neither $x/y \\in A$ nor $y/x \\in A$ contradicting the assumption of the lemma. Thus we see that $A$ is a local ring. Suppose that $A\'$ is a local ring contained in $K$ which dominates $A$. Let $x \\in A\'$. We have to show that $x \\in A$. If not, then $x^{-1} \\in A$, and of course $x^{-1} \\in \\mathfrak m_ A$. But then $x^{-1} \\in \\mathfrak m_{A\'}$ which contradicts $x \\in A\'$. \n      $\\square$\n    \n",\n  Lemma 10.50.5. Let $A \\subset K$ be a subring of a field $K$ such that for all $x \\in K$ either $x \\in A$ or $x^{-1} \\in A$ or both. Then $A$ is a valuation ring with fraction field $K$. \n\n    \n,"Proof.\n      If $A$ is not $K$, then $A$ is not a field and there is a nonzero maximal ideal $\\mathfrak m$. If $\\mathfrak m\'$ is a second maximal ideal, then choose $x, y \\in A$ with $x \\in \\mathfrak m$, $y \\not\\in \\mathfrak m$, $x \\not\\in \\mathfrak m\'$, and $y \\in \\mathfrak m\'$. Then neither $x/y \\in A$ nor $y/x \\in A$ contradicting the assumption of the lemma. Thus we see that $A$ is a local ring. Suppose that $A\'$ is a local ring contained in $K$ which dominates $A$. Let $x \\in A\'$. We have to show that $x \\in A$. If not, then $x^{-1} \\in A$, and of course $x^{-1} \\in \\mathfrak m_ A$. But then $x^{-1} \\in \\mathfrak m_{A\'}$ which contradicts $x \\in A\'$. \n      $\\square$\n    \n"," by
  intro S hS
  refine (LocalSubring.toSubring_injective (hS.1.antisymm fun x hx â†¦ (R.2 x).elim id fun h â†¦ ?_)).ge
  by_contra h'
  have hx0 : x â‰  0 := by rintro rfl; exact h' R.zero_mem
  have : IsUnit (Subring.inclusion hS.1 âŸ¨xâ»Â¹, hâŸ©) :=
    isUnit_iff_exists_inv.mpr âŸ¨âŸ¨x, hxâŸ©, Subtype.ext (inv_mul_cancelâ‚€ hx0)âŸ©
  obtain âŸ¨x', hx'âŸ© := isUnit_iff_exists_inv.mp (hS.2.1 _ this)
  have : x' = x := by simpa [Subtype.ext_iff, inv_mul_eq_iff_eq_mulâ‚€ hx0] using hx'
  exact h' (this â–¸ x'.2)
","lemma ValuationSubring.isMax_toLocalSubring (R : ValuationSubring K) :
    IsMax R.toLocalSubring ","Proof.\n      If $A$ is not $K$, then $A$ is not a field and there is a nonzero maximal ideal $\\mathfrak m$. If $\\mathfrak m\'$ is a second maximal ideal, then choose $x, y \\in A$ with $x \\in \\mathfrak m$, $y \\not\\in \\mathfrak m$, $x \\not\\in \\mathfrak m\'$, and $y \\in \\mathfrak m\'$. Then neither $x/y \\in A$ nor $y/x \\in A$ contradicting the assumption of the lemma. Thus we see that $A$ is a local ring. Suppose that $A\'$ is a local ring contained in $K$ which dominates $A$. Let $x \\in A\'$. We have to show that $x \\in A$. If not, then $x^{-1} \\in A$, and of course $x^{-1} \\in \\mathfrak m_ A$. But then $x^{-1} \\in \\mathfrak m_{A\'}$ which contradicts $x \\in A\'$. \n      $\\square$\n    \n"
357,00IB,"lemma LocalSubring.exists_valuationRing_of_isMax {R : LocalSubring K} (hR : IsMax R) :
    âˆƒ R' : ValuationSubring K, R'.toLocalSubring = R := by
  suffices âˆ€ x âˆ‰ R.toSubring, xâ»Â¹ âˆˆ R.toSubring from
    âŸ¨âŸ¨R.toSubring, fun x â†¦ or_iff_not_imp_left.mpr (this x)âŸ©, rflâŸ©
  refine fun x hx â†¦ mem_of_isMax_of_isIntegral hR ?_
  have hx0 : x â‰  0 := fun e â†¦ hx (e â–¸ zero_mem _)
  let := invertibleOfNonzero hx0
  let S := Algebra.adjoin R.toSubring {x}
  have : R.toSubring < S.toSubring := SetLike.lt_iff_le_and_exists.mpr
    âŸ¨fun r hr â†¦ algebraMap_mem S âŸ¨r, hrâŸ©, âŸ¨x, Algebra.self_mem_adjoin_singleton _ _, hxâŸ©âŸ©
  have âŸ¨p, hp, hpxâŸ© := Algebra.exists_aeval_invOf_eq_zero_of_idealMap_adjoin_sup_span_eq_top x _
    (maximalIdeal.isMaximal R.toSubring).ne_top
    (top_unique <| (map_maximalIdeal_eq_top_of_isMax hR this).ge.trans le_self_add)
  have H : IsUnit p.leadingCoeff := of_not_not fun h â†¦ by simpa using sub_mem h hp
  exact âŸ¨.C H.unitâ»Â¹.1 * p, by simp [Polynomial.Monic], by simpa using .inr hpxâŸ©
",Formal Proof of Stacks Project Tag 00IB,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Valuation/LocalSubring.lean#L90-L104,Q27041,,10.50.4,lemma,3.0,"['00I8', '00AO', '0ELQ']","\n  Lemma 10.50.4. Let $A$ be a valuation ring with maximal ideal $\\mathfrak m$ and fraction field $K$. Let $x \\in K$. Then either $x \\in A$ or $x^{-1} \\in A$ or both. \n\n    \n      Proof.\n      Assume that $x$ is not in $A$. Let $A\'$ denote the subring of $K$ generated by $A$ and $x$. Since $A$ is a valuation ring we see that there is no prime of $A\'$ lying over $\\mathfrak m$. Since $\\mathfrak m$ is maximal we see that $V(\\mathfrak m A\') = \\emptyset $. Then $\\mathfrak m A\' = A\'$ by Lemma 10.17.2. Hence we can write $1 = \\sum _{i = 0}^ d t_ i x^ i$ with $t_ i \\in \\mathfrak m$. This implies that $(1 - t_0) (x^{-1})^ d - \\sum t_ i (x^{-1})^{d - i} = 0$. In particular we see that $x^{-1}$ is integral over $A$, and hence $x^{-1} \\in A$ by Lemma 10.50.3. \n      $\\square$\n    \n",\n  Lemma 10.50.4. Let $A$ be a valuation ring with maximal ideal $\\mathfrak m$ and fraction field $K$. Let $x \\in K$. Then either $x \\in A$ or $x^{-1} \\in A$ or both. \n\n    \n,"Proof.\n      Assume that $x$ is not in $A$. Let $A\'$ denote the subring of $K$ generated by $A$ and $x$. Since $A$ is a valuation ring we see that there is no prime of $A\'$ lying over $\\mathfrak m$. Since $\\mathfrak m$ is maximal we see that $V(\\mathfrak m A\') = \\emptyset $. Then $\\mathfrak m A\' = A\'$ by Lemma 10.17.2. Hence we can write $1 = \\sum _{i = 0}^ d t_ i x^ i$ with $t_ i \\in \\mathfrak m$. This implies that $(1 - t_0) (x^{-1})^ d - \\sum t_ i (x^{-1})^{d - i} = 0$. In particular we see that $x^{-1}$ is integral over $A$, and hence $x^{-1} \\in A$ by Lemma 10.50.3. \n      $\\square$\n    \n"," by
  suffices âˆ€ x âˆ‰ R.toSubring, xâ»Â¹ âˆˆ R.toSubring from
    âŸ¨âŸ¨R.toSubring, fun x â†¦ or_iff_not_imp_left.mpr (this x)âŸ©, rflâŸ©
  refine fun x hx â†¦ mem_of_isMax_of_isIntegral hR ?_
  have hx0 : x â‰  0 := fun e â†¦ hx (e â–¸ zero_mem _)
  let := invertibleOfNonzero hx0
  let S := Algebra.adjoin R.toSubring {x}
  have : R.toSubring < S.toSubring := SetLike.lt_iff_le_and_exists.mpr
    âŸ¨fun r hr â†¦ algebraMap_mem S âŸ¨r, hrâŸ©, âŸ¨x, Algebra.self_mem_adjoin_singleton _ _, hxâŸ©âŸ©
  have âŸ¨p, hp, hpxâŸ© := Algebra.exists_aeval_invOf_eq_zero_of_idealMap_adjoin_sup_span_eq_top x _
    (maximalIdeal.isMaximal R.toSubring).ne_top
    (top_unique <| (map_maximalIdeal_eq_top_of_isMax hR this).ge.trans le_self_add)
  have H : IsUnit p.leadingCoeff := of_not_not fun h â†¦ by simpa using sub_mem h hp
  exact âŸ¨.C H.unitâ»Â¹.1 * p, by simp [Polynomial.Monic], by simpa using .inr hpxâŸ©
","lemma LocalSubring.exists_valuationRing_of_isMax {R : LocalSubring K} (hR : IsMax R) :
    âˆƒ R' : ValuationSubring K, R'.toLocalSubring = R ","Proof.\n      Assume that $x$ is not in $A$. Let $A\'$ denote the subring of $K$ generated by $A$ and $x$. Since $A$ is a valuation ring we see that there is no prime of $A\'$ lying over $\\mathfrak m$. Since $\\mathfrak m$ is maximal we see that $V(\\mathfrak m A\') = \\emptyset $. Then $\\mathfrak m A\' = A\'$ by Lemma 10.17.2 [[\n  Lemma 10.17.2. Let $R$ be a ring. \n  \n  \nThe spectrum of a ring $R$ is empty if and only if $R$ is the zero ring. \n\n\nEvery nonzero ring has a maximal ideal. \n\n\nEvery nonzero ring has a minimal prime ideal. \n\n\nGiven an ideal $I \\subset R$ and a prime ideal $I \\subset \\mathfrak p$ there exists a prime $I \\subset \\mathfrak q \\subset \\mathfrak p$ such that $\\mathfrak q$ is minimal over $I$. \n\n\nIf $T \\subset R$, and if $(T)$ is the ideal generated by $T$ in $R$, then $V((T)) = V(T)$. \n\n\nIf $I$ is an ideal and $\\sqrt{I}$ is its radical, see basic notion (27), then $V(I) = V(\\sqrt{I})$. \n\n\nGiven an ideal $I$ of $R$ we have $\\sqrt{I} = \\bigcap _{I \\subset \\mathfrak p} \\mathfrak p$. \n\n\nIf $I$ is an ideal then $V(I) = \\emptyset $ if and only if $I$ is the unit ideal. \n\n\nIf $I$, $J$ are ideals of $R$ then $V(I) \\cup V(J) = V(I \\cap J)$. \n\n\nIf $(I_ a)_{a\\in A}$ is a set of ideals of $R$ then $\\bigcap _{a\\in A} V(I_ a) = V(\\bigcup _{a\\in A} I_ a)$. \n\n\nIf $f \\in R$, then $D(f) \\amalg V(f) = \\mathop{\\mathrm{Spec}}(R)$. \n\n\nIf $f \\in R$ then $D(f) = \\emptyset $ if and only if $f$ is nilpotent. \n\n\nIf $f = u f\'$ for some unit $u \\in R$, then $D(f) = D(f\')$. \n\n\nIf $I \\subset R$ is an ideal, and $\\mathfrak p$ is a prime of $R$ with $\\mathfrak p \\not\\in V(I)$, then there exists an $f \\in R$ such that $\\mathfrak p \\in D(f)$, and $D(f) \\cap V(I) = \\emptyset $. \n\n\nIf $f, g \\in R$, then $D(fg) = D(f) \\cap D(g)$. \n\n\nIf $f_ i \\in R$ for $i \\in I$, then $\\bigcup _{i\\in I} D(f_ i)$ is the complement of $V(\\{ f_ i \\} _{i\\in I})$ in $\\mathop{\\mathrm{Spec}}(R)$. \n\n\nIf $f \\in R$ and $D(f) = \\mathop{\\mathrm{Spec}}(R)$, then $f$ is a unit. \n\n\n\n\n    \n]]. Hence we can write $1 = \\sum _{i = 0}^ d t_ i x^ i$ with $t_ i \\in \\mathfrak m$. This implies that $(1 - t_0) (x^{-1})^ d - \\sum t_ i (x^{-1})^{d - i} = 0$. In particular we see that $x^{-1}$ is integral over $A$, and hence $x^{-1} \\in A$ by Lemma 10.50.3 [[\n  Lemma 10.50.3. Let $A$ be a valuation ring. Then $A$ is a normal domain. \n\n    \n]]. \n      $\\square$\n    \n"
358,00IA,"lemma LocalSubring.exists_le_valuationSubring (A : LocalSubring K) :
    âˆƒ B : ValuationSubring K, A â‰¤ B.toLocalSubring := by
  suffices âˆƒ B, A â‰¤ B âˆ§ IsMax B by
    obtain âŸ¨B, hB, hB'âŸ© := this
    obtain âŸ¨B, rflâŸ© := B.exists_valuationRing_of_isMax hB'
    exact âŸ¨B, hBâŸ©
  refine zorn_le_nonempty_Iciâ‚€ _ ?_ _ le_rfl
  intro s hs H y hys
  have inst : Nonempty s := âŸ¨âŸ¨y, hysâŸ©âŸ©
  have hdir := H.directed.mono_comp _ LocalSubring.toSubring_mono
  refine âŸ¨@LocalSubring.mk _ _ (â¨† i : s, i.1.toSubring) âŸ¨?_âŸ©, ?_âŸ©
  Â· intro âŸ¨a, haâŸ© âŸ¨b, hbâŸ© e
    obtain âŸ¨A, haA : a âˆˆ A.1.toSubringâŸ© := (Subring.mem_iSup_of_directed hdir).mp ha
    obtain âŸ¨B, hbB : b âˆˆ B.1.toSubringâŸ© := (Subring.mem_iSup_of_directed hdir).mp hb
    obtain âŸ¨C, hCA, hCBâŸ© := hdir A B
    refine (C.1.2.2 (a := âŸ¨a, hCA haAâŸ©) (b := âŸ¨b, hCB hbBâŸ©) (Subtype.ext congr(($e).1))).imp ?_ ?_
    Â· exact fun h â†¦ h.map (Subring.inclusion (le_iSup (fun i : s â†¦ i.1.toSubring) C))
    Â· exact fun h â†¦ h.map (Subring.inclusion (le_iSup (fun i : s â†¦ i.1.toSubring) C))
  Â· intro A hA
    refine âŸ¨le_iSup (fun i : s â†¦ i.1.toSubring) âŸ¨A, hAâŸ©, âŸ¨?_âŸ©âŸ©
    rintro âŸ¨a, haAâŸ© h
    obtain âŸ¨âŸ¨b, hbâŸ©, eâŸ© := isUnit_iff_exists_inv.mp h
    obtain âŸ¨B, hbB : b âˆˆ B.1.toSubringâŸ© := (Subring.mem_iSup_of_directed hdir).mp hb
    obtain âŸ¨C, hCA, hCBâŸ© := H.directed âŸ¨A, hAâŸ© B
    apply hCA.2.1
    exact isUnit_iff_exists_inv.mpr âŸ¨âŸ¨b, hCB.1 hbBâŸ©, Subtype.ext congr(($e).1)âŸ©
",Formal Proof of Stacks Project Tag 00IA,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Valuation/LocalSubring.lean#L113-L138,Q27041,,10.50.2,lemma,3.0,"['00I8', '00AO', '0ELQ']","\n  Lemma 10.50.2. Let $K$ be a field. Let $A \\subset K$ be a local subring. Then there exists a valuation ring with fraction field $K$ dominating $A$. \n\n    \n      Proof.\n      We consider the collection of local subrings of $K$ as a partially ordered set using the relation of domination. Suppose that $\\{ A_ i\\} _{i \\in I}$ is a totally ordered collection of local subrings of $K$. Then $B = \\bigcup A_ i$ is a local subring which dominates all of the $A_ i$. Hence by Zorn\'s Lemma, it suffices to show that if $A \\subset K$ is a local ring whose fraction field is not $K$, then there exists a local ring $B \\subset K$, $B \\not= A$ dominating $A$. \n    \n      Pick $t \\in K$ which is not in the fraction field of $A$. If $t$ is transcendental over $A$, then $A[t] \\subset K$ and hence $A[t]_{(t, \\mathfrak m)} \\subset K$ is a local ring distinct from $A$ dominating $A$. Suppose $t$ is algebraic over $A$. Then for some nonzero $a \\in A$ the element $at$ is integral over $A$. In this case the subring $A\' \\subset K$ generated by $A$ and $ta$ is finite over $A$. By Lemma 10.36.17 there exists a prime ideal $\\mathfrak m\' \\subset A\'$ lying over $\\mathfrak m$. Then $A\'_{\\mathfrak m\'}$ dominates $A$. If $A = A\'_{\\mathfrak m\'}$, then $t$ is in the fraction field of $A$ which we assumed not to be the case. Thus $A \\not= A\'_{\\mathfrak m\'}$ as desired. \n      $\\square$\n    \n",\n  Lemma 10.50.2. Let $K$ be a field. Let $A \\subset K$ be a local subring. Then there exists a valuation ring with fraction field $K$ dominating $A$. \n\n    \n,"Proof.\n      We consider the collection of local subrings of $K$ as a partially ordered set using the relation of domination. Suppose that $\\{ A_ i\\} _{i \\in I}$ is a totally ordered collection of local subrings of $K$. Then $B = \\bigcup A_ i$ is a local subring which dominates all of the $A_ i$. Hence by Zorn\'s Lemma, it suffices to show that if $A \\subset K$ is a local ring whose fraction field is not $K$, then there exists a local ring $B \\subset K$, $B \\not= A$ dominating $A$. \n    \n      Pick $t \\in K$ which is not in the fraction field of $A$. If $t$ is transcendental over $A$, then $A[t] \\subset K$ and hence $A[t]_{(t, \\mathfrak m)} \\subset K$ is a local ring distinct from $A$ dominating $A$. Suppose $t$ is algebraic over $A$. Then for some nonzero $a \\in A$ the element $at$ is integral over $A$. In this case the subring $A\' \\subset K$ generated by $A$ and $ta$ is finite over $A$. By Lemma 10.36.17 there exists a prime ideal $\\mathfrak m\' \\subset A\'$ lying over $\\mathfrak m$. Then $A\'_{\\mathfrak m\'}$ dominates $A$. If $A = A\'_{\\mathfrak m\'}$, then $t$ is in the fraction field of $A$ which we assumed not to be the case. Thus $A \\not= A\'_{\\mathfrak m\'}$ as desired. \n      $\\square$\n    \n"," by
  suffices âˆƒ B, A â‰¤ B âˆ§ IsMax B by
    obtain âŸ¨B, hB, hB'âŸ© := this
    obtain âŸ¨B, rflâŸ© := B.exists_valuationRing_of_isMax hB'
    exact âŸ¨B, hBâŸ©
  refine zorn_le_nonempty_Iciâ‚€ _ ?_ _ le_rfl
  intro s hs H y hys
  have inst : Nonempty s := âŸ¨âŸ¨y, hysâŸ©âŸ©
  have hdir := H.directed.mono_comp _ LocalSubring.toSubring_mono
  refine âŸ¨@LocalSubring.mk _ _ (â¨† i : s, i.1.toSubring) âŸ¨?_âŸ©, ?_âŸ©
  Â· intro âŸ¨a, haâŸ© âŸ¨b, hbâŸ© e
    obtain âŸ¨A, haA : a âˆˆ A.1.toSubringâŸ© := (Subring.mem_iSup_of_directed hdir).mp ha
    obtain âŸ¨B, hbB : b âˆˆ B.1.toSubringâŸ© := (Subring.mem_iSup_of_directed hdir).mp hb
    obtain âŸ¨C, hCA, hCBâŸ© := hdir A B
    refine (C.1.2.2 (a := âŸ¨a, hCA haAâŸ©) (b := âŸ¨b, hCB hbBâŸ©) (Subtype.ext congr(($e).1))).imp ?_ ?_
    Â· exact fun h â†¦ h.map (Subring.inclusion (le_iSup (fun i : s â†¦ i.1.toSubring) C))
    Â· exact fun h â†¦ h.map (Subring.inclusion (le_iSup (fun i : s â†¦ i.1.toSubring) C))
  Â· intro A hA
    refine âŸ¨le_iSup (fun i : s â†¦ i.1.toSubring) âŸ¨A, hAâŸ©, âŸ¨?_âŸ©âŸ©
    rintro âŸ¨a, haAâŸ© h
    obtain âŸ¨âŸ¨b, hbâŸ©, eâŸ© := isUnit_iff_exists_inv.mp h
    obtain âŸ¨B, hbB : b âˆˆ B.1.toSubringâŸ© := (Subring.mem_iSup_of_directed hdir).mp hb
    obtain âŸ¨C, hCA, hCBâŸ© := H.directed âŸ¨A, hAâŸ© B
    apply hCA.2.1
    exact isUnit_iff_exists_inv.mpr âŸ¨âŸ¨b, hCB.1 hbBâŸ©, Subtype.ext congr(($e).1)âŸ©
","lemma LocalSubring.exists_le_valuationSubring (A : LocalSubring K) :
    âˆƒ B : ValuationSubring K, A â‰¤ B.toLocalSubring ","Proof.\n      We consider the collection of local subrings of $K$ as a partially ordered set using the relation of domination. Suppose that $\\{ A_ i\\} _{i \\in I}$ is a totally ordered collection of local subrings of $K$. Then $B = \\bigcup A_ i$ is a local subring which dominates all of the $A_ i$. Hence by Zorn\'s Lemma, it suffices to show that if $A \\subset K$ is a local ring whose fraction field is not $K$, then there exists a local ring $B \\subset K$, $B \\not= A$ dominating $A$. \n    \n      Pick $t \\in K$ which is not in the fraction field of $A$. If $t$ is transcendental over $A$, then $A[t] \\subset K$ and hence $A[t]_{(t, \\mathfrak m)} \\subset K$ is a local ring distinct from $A$ dominating $A$. Suppose $t$ is algebraic over $A$. Then for some nonzero $a \\in A$ the element $at$ is integral over $A$. In this case the subring $A\' \\subset K$ generated by $A$ and $ta$ is finite over $A$. By Lemma 10.36.17 [[\n  Lemma 10.36.17. Suppose that $R \\to S$ is an integral ring extension with $R \\subset S$. Then $\\varphi : \\mathop{\\mathrm{Spec}}(S) \\to \\mathop{\\mathrm{Spec}}(R)$ is surjective. \n\n    \n]] there exists a prime ideal $\\mathfrak m\' \\subset A\'$ lying over $\\mathfrak m$. Then $A\'_{\\mathfrak m\'}$ dominates $A$. If $A = A\'_{\\mathfrak m\'}$, then $t$ is in the fraction field of $A$ which we assumed not to be the case. Thus $A \\not= A\'_{\\mathfrak m\'}$ as desired. \n      $\\square$\n    \n"
359,090P,"    {x : K} {R : Subring K} (hxR : x âˆ‰ R) [IsIntegrallyClosedIn R K] :
    âˆƒ V : ValuationSubring K, R â‰¤ V.toSubring âˆ§ x âˆ‰ V := by
  obtain rfl | hx0 := eq_or_ne x 0
  Â· exact (hxR R.zero_mem).elim
  let := invertibleOfNonzero hx0
  let B := Algebra.adjoin R {xâ»Â¹}
  let xinv : B.toSubring := âŸ¨xâ»Â¹, Algebra.subset_adjoin rflâŸ©
  have : Ideal.span {xinv} â‰  âŠ¤ := fun eq â†¦ hxR <|
    have âŸ¨p, hp, hpxâŸ© := Algebra.exists_aeval_invOf_eq_zero_of_idealMap_adjoin_sup_span_eq_top _
      (âŠ¥ : Ideal R) bot_ne_top (top_unique <| eq.ge.trans le_add_self)
    (Subring.isIntegrallyClosedIn_iff).mp â€¹_â€º âŸ¨p, by simpa [Monic, sub_eq_zero] using hp, hpxâŸ©
  have âŸ¨V, hVâŸ© := Ideal.image_subset_nonunits_valuationSubring _ this
  exact âŸ¨V, fun r hr â†¦ hV.1 (B.algebraMap_mem âŸ¨r, hrâŸ©),
    (V.inv_mem_nonunits_iff.mp <| hV.2 âŸ¨_, Ideal.subset_span rfl, rflâŸ©).resolve_left hx0âŸ©
",Formal Proof of Stacks Project Tag 090P,part (1)] lemma Subring.exists_le_valuationSubring_of_isIntegrallyClosedI,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Valuation/LocalSubring.lean#L154-L167,Q27041,,10.50.11,lemma,3.0,"['00I8', '00AO', '0ELQ']","\n  Lemma 10.50.11. Let $A$ be a normal domain with fraction field $K$. \n  \n  \nFor every $x \\in K$, $x \\not\\in A$ there exists a valuation ring $A \\subset V \\subset K$ with fraction field $K$ such that $x \\not\\in V$. \n\n\nIf $A$ is local, we can moreover choose $V$ which dominates $A$. \n\n\n\n   In other words, $A$ is the intersection of all valuation rings in $K$ containing $A$ and if $A$ is local, then $A$ is the intersection of all valuation rings in $K$ dominating $A$. \n\n    \n      Proof.\n      Suppose $x \\in K$, $x \\not\\in A$. Consider $B = A[x^{-1}]$. Then $x \\not\\in B$. Namely, if $x = a_0 + a_1x^{-1} + \\ldots + a_ d x^{-d}$ then $x^{d + 1} - a_0x^ d - \\ldots - a_ d = 0$ and $x$ is integral over $A$ in contradiction with the fact that $A$ is normal. Thus $x^{-1}$ is not a unit in $B$. Thus $V(x^{-1}) \\subset \\mathop{\\mathrm{Spec}}(B)$ is not empty (Lemma 10.17.2), and we can choose a prime $\\mathfrak p \\subset B$ with $x^{-1} \\in \\mathfrak p$. Choose a valuation ring $V \\subset K$ dominating $B_\\mathfrak p$ (Lemma 10.50.2). Then $x \\not\\in V$ as $x^{-1} \\in \\mathfrak m_ V$. \n    \n      If $A$ is local, then we claim that $x^{-1} B + \\mathfrak m_ A B \\not= B$. Namely, if $1 = (a_0 + a_1x^{-1} + \\ldots + a_ d x^{-d})x^{-1} + a\'_0 + \\ldots + a\'_ d x^{-d}$ with $a_ i \\in A$ and $a\'_ i \\in \\mathfrak m_ A$, then we\'d get \n    \n      \n  \\[  (1 - a\'_0) x^{d + 1} - (a_0 + a\'_1) x^ d - \\ldots - a_ d = 0  \\]\n\n    \n       Since $a\'_0 \\in \\mathfrak m_ A$ we see that $1 - a\'_0$ is a unit in $A$ and we conclude that $x$ would be integral over $A$, a contradiction as before. Then choose the prime $\\mathfrak p \\supset x^{-1} B + \\mathfrak m_ A B$ we find $V$ dominating $A$. \n      $\\square$\n    \n","\n  Lemma 10.50.11. Let $A$ be a normal domain with fraction field $K$. \n  \n  \nFor every $x \\in K$, $x \\not\\in A$ there exists a valuation ring $A \\subset V \\subset K$ with fraction field $K$ such that $x \\not\\in V$. \n\n\nIf $A$ is local, we can moreover choose $V$ which dominates $A$. \n\n\n\n   In other words, $A$ is the intersection of all valuation rings in $K$ containing $A$ and if $A$ is local, then $A$ is the intersection of all valuation rings in $K$ dominating $A$. \n\n    \n","Proof.\n      Suppose $x \\in K$, $x \\not\\in A$. Consider $B = A[x^{-1}]$. Then $x \\not\\in B$. Namely, if $x = a_0 + a_1x^{-1} + \\ldots + a_ d x^{-d}$ then $x^{d + 1} - a_0x^ d - \\ldots - a_ d = 0$ and $x$ is integral over $A$ in contradiction with the fact that $A$ is normal. Thus $x^{-1}$ is not a unit in $B$. Thus $V(x^{-1}) \\subset \\mathop{\\mathrm{Spec}}(B)$ is not empty (Lemma 10.17.2), and we can choose a prime $\\mathfrak p \\subset B$ with $x^{-1} \\in \\mathfrak p$. Choose a valuation ring $V \\subset K$ dominating $B_\\mathfrak p$ (Lemma 10.50.2). Then $x \\not\\in V$ as $x^{-1} \\in \\mathfrak m_ V$. \n    \n      If $A$ is local, then we claim that $x^{-1} B + \\mathfrak m_ A B \\not= B$. Namely, if $1 = (a_0 + a_1x^{-1} + \\ldots + a_ d x^{-d})x^{-1} + a\'_0 + \\ldots + a\'_ d x^{-d}$ with $a_ i \\in A$ and $a\'_ i \\in \\mathfrak m_ A$, then we\'d get \n    \n      \n  \\[  (1 - a\'_0) x^{d + 1} - (a_0 + a\'_1) x^ d - \\ldots - a_ d = 0  \\]\n\n    \n       Since $a\'_0 \\in \\mathfrak m_ A$ we see that $1 - a\'_0$ is a unit in $A$ and we conclude that $x$ would be integral over $A$, a contradiction as before. Then choose the prime $\\mathfrak p \\supset x^{-1} B + \\mathfrak m_ A B$ we find $V$ dominating $A$. \n      $\\square$\n    \n"," by
  obtain rfl | hx0 := eq_or_ne x 0
  Â· exact (hxR R.zero_mem).elim
  let := invertibleOfNonzero hx0
  let B := Algebra.adjoin R {xâ»Â¹}
  let xinv : B.toSubring := âŸ¨xâ»Â¹, Algebra.subset_adjoin rflâŸ©
  have : Ideal.span {xinv} â‰  âŠ¤ := fun eq â†¦ hxR <|
    have âŸ¨p, hp, hpxâŸ© := Algebra.exists_aeval_invOf_eq_zero_of_idealMap_adjoin_sup_span_eq_top _
      (âŠ¥ : Ideal R) bot_ne_top (top_unique <| eq.ge.trans le_add_self)
    (Subring.isIntegrallyClosedIn_iff).mp â€¹_â€º âŸ¨p, by simpa [Monic, sub_eq_zero] using hp, hpxâŸ©
  have âŸ¨V, hVâŸ© := Ideal.image_subset_nonunits_valuationSubring _ this
  exact âŸ¨V, fun r hr â†¦ hV.1 (B.algebraMap_mem âŸ¨r, hrâŸ©),
    (V.inv_mem_nonunits_iff.mp <| hV.2 âŸ¨_, Ideal.subset_span rfl, rflâŸ©).resolve_left hx0âŸ©
","    {x : K} {R : Subring K} (hxR : x âˆ‰ R) [IsIntegrallyClosedIn R K] :
    âˆƒ V : ValuationSubring K, R â‰¤ V.toSubring âˆ§ x âˆ‰ V ","Proof.\n      Suppose $x \\in K$, $x \\not\\in A$. Consider $B = A[x^{-1}]$. Then $x \\not\\in B$. Namely, if $x = a_0 + a_1x^{-1} + \\ldots + a_ d x^{-d}$ then $x^{d + 1} - a_0x^ d - \\ldots - a_ d = 0$ and $x$ is integral over $A$ in contradiction with the fact that $A$ is normal. Thus $x^{-1}$ is not a unit in $B$. Thus $V(x^{-1}) \\subset \\mathop{\\mathrm{Spec}}(B)$ is not empty (Lemma 10.17.2 [[\n  Lemma 10.17.2. Let $R$ be a ring. \n  \n  \nThe spectrum of a ring $R$ is empty if and only if $R$ is the zero ring. \n\n\nEvery nonzero ring has a maximal ideal. \n\n\nEvery nonzero ring has a minimal prime ideal. \n\n\nGiven an ideal $I \\subset R$ and a prime ideal $I \\subset \\mathfrak p$ there exists a prime $I \\subset \\mathfrak q \\subset \\mathfrak p$ such that $\\mathfrak q$ is minimal over $I$. \n\n\nIf $T \\subset R$, and if $(T)$ is the ideal generated by $T$ in $R$, then $V((T)) = V(T)$. \n\n\nIf $I$ is an ideal and $\\sqrt{I}$ is its radical, see basic notion (27), then $V(I) = V(\\sqrt{I})$. \n\n\nGiven an ideal $I$ of $R$ we have $\\sqrt{I} = \\bigcap _{I \\subset \\mathfrak p} \\mathfrak p$. \n\n\nIf $I$ is an ideal then $V(I) = \\emptyset $ if and only if $I$ is the unit ideal. \n\n\nIf $I$, $J$ are ideals of $R$ then $V(I) \\cup V(J) = V(I \\cap J)$. \n\n\nIf $(I_ a)_{a\\in A}$ is a set of ideals of $R$ then $\\bigcap _{a\\in A} V(I_ a) = V(\\bigcup _{a\\in A} I_ a)$. \n\n\nIf $f \\in R$, then $D(f) \\amalg V(f) = \\mathop{\\mathrm{Spec}}(R)$. \n\n\nIf $f \\in R$ then $D(f) = \\emptyset $ if and only if $f$ is nilpotent. \n\n\nIf $f = u f\'$ for some unit $u \\in R$, then $D(f) = D(f\')$. \n\n\nIf $I \\subset R$ is an ideal, and $\\mathfrak p$ is a prime of $R$ with $\\mathfrak p \\not\\in V(I)$, then there exists an $f \\in R$ such that $\\mathfrak p \\in D(f)$, and $D(f) \\cap V(I) = \\emptyset $. \n\n\nIf $f, g \\in R$, then $D(fg) = D(f) \\cap D(g)$. \n\n\nIf $f_ i \\in R$ for $i \\in I$, then $\\bigcup _{i\\in I} D(f_ i)$ is the complement of $V(\\{ f_ i \\} _{i\\in I})$ in $\\mathop{\\mathrm{Spec}}(R)$. \n\n\nIf $f \\in R$ and $D(f) = \\mathop{\\mathrm{Spec}}(R)$, then $f$ is a unit. \n\n\n\n\n    \n]]), and we can choose a prime $\\mathfrak p \\subset B$ with $x^{-1} \\in \\mathfrak p$. Choose a valuation ring $V \\subset K$ dominating $B_\\mathfrak p$ (Lemma 10.50.2 [[\n  Lemma 10.50.2. Let $K$ be a field. Let $A \\subset K$ be a local subring. Then there exists a valuation ring with fraction field $K$ dominating $A$. \n\n    \n]]). Then $x \\not\\in V$ as $x^{-1} \\in \\mathfrak m_ V$. \n    \n      If $A$ is local, then we claim that $x^{-1} B + \\mathfrak m_ A B \\not= B$. Namely, if $1 = (a_0 + a_1x^{-1} + \\ldots + a_ d x^{-d})x^{-1} + a\'_0 + \\ldots + a\'_ d x^{-d}$ with $a_ i \\in A$ and $a\'_ i \\in \\mathfrak m_ A$, then we\'d get \n    \n      \n  \\[  (1 - a\'_0) x^{d + 1} - (a_0 + a\'_1) x^ d - \\ldots - a_ d = 0  \\]\n\n    \n       Since $a\'_0 \\in \\mathfrak m_ A$ we see that $1 - a\'_0$ is a unit in $A$ and we conclude that $x$ would be integral over $A$, a contradiction as before. Then choose the prime $\\mathfrak p \\supset x^{-1} B + \\mathfrak m_ A B$ we find $V$ dominating $A$. \n      $\\square$\n    \n"
360,090P,"    {x : K} {R : LocalSubring K} (hxR : x âˆ‰ R.toSubring) [IsIntegrallyClosedIn R.toSubring K] :
    âˆƒ V : ValuationSubring K, R â‰¤ V.toLocalSubring âˆ§ x âˆ‰ V := by
  obtain rfl | hx0 := eq_or_ne x 0
  Â· exact (hxR R.toSubring.zero_mem).elim
  let := invertibleOfNonzero hx0
  let B := Algebra.adjoin R.toSubring {xâ»Â¹}
  let xinv : B.toSubring := âŸ¨xâ»Â¹, Algebra.subset_adjoin rflâŸ©
  have : (maximalIdeal R.toSubring).map (algebraMap _ B) + .span {xinv} â‰  âŠ¤ := fun eq â†¦ hxR <|
    have âŸ¨p, hp, hpxâŸ© := Algebra.exists_aeval_invOf_eq_zero_of_idealMap_adjoin_sup_span_eq_top _ _
      (maximalIdeal.isMaximal R.toSubring).ne_top eq
    have H : IsUnit p.leadingCoeff := of_not_not fun h â†¦ by simpa using sub_mem h hp
    (Subring.isIntegrallyClosedIn_iff).mp â€¹_â€º
      âŸ¨.C H.unitâ»Â¹.1 * p, by simp [Polynomial.Monic], by simpa using .inr hpxâŸ©
  have âŸ¨V, hVâŸ© := Ideal.image_subset_nonunits_valuationSubring (A := B.toSubring) _ this
  refine âŸ¨V, âŸ¨fun r hr â†¦ hV.1 (B.algebraMap_mem âŸ¨r, hrâŸ©),
    ((local_hom_TFAE _).out 3 0).mp fun r hr â†¦ ?_âŸ©, (V.inv_mem_nonunits_iff.mp <|
      hV.2 âŸ¨_, le_add_self (Î± := Ideal B) (Ideal.subset_span rfl), rflâŸ©).resolve_left hx0âŸ©
  rw [â† V.image_maximalIdeal] at hV
  obtain âŸ¨âŸ¨r, _âŸ©, hr, rflâŸ© := hV.2 âŸ¨_, le_self_add (Î± := Ideal B) (Ideal.mem_map_of_mem _ hr), rflâŸ©
  exact hr
",Formal Proof of Stacks Project Tag 090P,part (2)] lemma LocalSubring.exists_le_valuationSubring_of_isIntegrallyClosedI,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/RingTheory/Valuation/LocalSubring.lean#L171-L190,Q27041,,10.50.11,lemma,3.0,"['00I8', '00AO', '0ELQ']","\n  Lemma 10.50.11. Let $A$ be a normal domain with fraction field $K$. \n  \n  \nFor every $x \\in K$, $x \\not\\in A$ there exists a valuation ring $A \\subset V \\subset K$ with fraction field $K$ such that $x \\not\\in V$. \n\n\nIf $A$ is local, we can moreover choose $V$ which dominates $A$. \n\n\n\n   In other words, $A$ is the intersection of all valuation rings in $K$ containing $A$ and if $A$ is local, then $A$ is the intersection of all valuation rings in $K$ dominating $A$. \n\n    \n      Proof.\n      Suppose $x \\in K$, $x \\not\\in A$. Consider $B = A[x^{-1}]$. Then $x \\not\\in B$. Namely, if $x = a_0 + a_1x^{-1} + \\ldots + a_ d x^{-d}$ then $x^{d + 1} - a_0x^ d - \\ldots - a_ d = 0$ and $x$ is integral over $A$ in contradiction with the fact that $A$ is normal. Thus $x^{-1}$ is not a unit in $B$. Thus $V(x^{-1}) \\subset \\mathop{\\mathrm{Spec}}(B)$ is not empty (Lemma 10.17.2), and we can choose a prime $\\mathfrak p \\subset B$ with $x^{-1} \\in \\mathfrak p$. Choose a valuation ring $V \\subset K$ dominating $B_\\mathfrak p$ (Lemma 10.50.2). Then $x \\not\\in V$ as $x^{-1} \\in \\mathfrak m_ V$. \n    \n      If $A$ is local, then we claim that $x^{-1} B + \\mathfrak m_ A B \\not= B$. Namely, if $1 = (a_0 + a_1x^{-1} + \\ldots + a_ d x^{-d})x^{-1} + a\'_0 + \\ldots + a\'_ d x^{-d}$ with $a_ i \\in A$ and $a\'_ i \\in \\mathfrak m_ A$, then we\'d get \n    \n      \n  \\[  (1 - a\'_0) x^{d + 1} - (a_0 + a\'_1) x^ d - \\ldots - a_ d = 0  \\]\n\n    \n       Since $a\'_0 \\in \\mathfrak m_ A$ we see that $1 - a\'_0$ is a unit in $A$ and we conclude that $x$ would be integral over $A$, a contradiction as before. Then choose the prime $\\mathfrak p \\supset x^{-1} B + \\mathfrak m_ A B$ we find $V$ dominating $A$. \n      $\\square$\n    \n","\n  Lemma 10.50.11. Let $A$ be a normal domain with fraction field $K$. \n  \n  \nFor every $x \\in K$, $x \\not\\in A$ there exists a valuation ring $A \\subset V \\subset K$ with fraction field $K$ such that $x \\not\\in V$. \n\n\nIf $A$ is local, we can moreover choose $V$ which dominates $A$. \n\n\n\n   In other words, $A$ is the intersection of all valuation rings in $K$ containing $A$ and if $A$ is local, then $A$ is the intersection of all valuation rings in $K$ dominating $A$. \n\n    \n","Proof.\n      Suppose $x \\in K$, $x \\not\\in A$. Consider $B = A[x^{-1}]$. Then $x \\not\\in B$. Namely, if $x = a_0 + a_1x^{-1} + \\ldots + a_ d x^{-d}$ then $x^{d + 1} - a_0x^ d - \\ldots - a_ d = 0$ and $x$ is integral over $A$ in contradiction with the fact that $A$ is normal. Thus $x^{-1}$ is not a unit in $B$. Thus $V(x^{-1}) \\subset \\mathop{\\mathrm{Spec}}(B)$ is not empty (Lemma 10.17.2), and we can choose a prime $\\mathfrak p \\subset B$ with $x^{-1} \\in \\mathfrak p$. Choose a valuation ring $V \\subset K$ dominating $B_\\mathfrak p$ (Lemma 10.50.2). Then $x \\not\\in V$ as $x^{-1} \\in \\mathfrak m_ V$. \n    \n      If $A$ is local, then we claim that $x^{-1} B + \\mathfrak m_ A B \\not= B$. Namely, if $1 = (a_0 + a_1x^{-1} + \\ldots + a_ d x^{-d})x^{-1} + a\'_0 + \\ldots + a\'_ d x^{-d}$ with $a_ i \\in A$ and $a\'_ i \\in \\mathfrak m_ A$, then we\'d get \n    \n      \n  \\[  (1 - a\'_0) x^{d + 1} - (a_0 + a\'_1) x^ d - \\ldots - a_ d = 0  \\]\n\n    \n       Since $a\'_0 \\in \\mathfrak m_ A$ we see that $1 - a\'_0$ is a unit in $A$ and we conclude that $x$ would be integral over $A$, a contradiction as before. Then choose the prime $\\mathfrak p \\supset x^{-1} B + \\mathfrak m_ A B$ we find $V$ dominating $A$. \n      $\\square$\n    \n"," by
  obtain rfl | hx0 := eq_or_ne x 0
  Â· exact (hxR R.toSubring.zero_mem).elim
  let := invertibleOfNonzero hx0
  let B := Algebra.adjoin R.toSubring {xâ»Â¹}
  let xinv : B.toSubring := âŸ¨xâ»Â¹, Algebra.subset_adjoin rflâŸ©
  have : (maximalIdeal R.toSubring).map (algebraMap _ B) + .span {xinv} â‰  âŠ¤ := fun eq â†¦ hxR <|
    have âŸ¨p, hp, hpxâŸ© := Algebra.exists_aeval_invOf_eq_zero_of_idealMap_adjoin_sup_span_eq_top _ _
      (maximalIdeal.isMaximal R.toSubring).ne_top eq
    have H : IsUnit p.leadingCoeff := of_not_not fun h â†¦ by simpa using sub_mem h hp
    (Subring.isIntegrallyClosedIn_iff).mp â€¹_â€º
      âŸ¨.C H.unitâ»Â¹.1 * p, by simp [Polynomial.Monic], by simpa using .inr hpxâŸ©
  have âŸ¨V, hVâŸ© := Ideal.image_subset_nonunits_valuationSubring (A := B.toSubring) _ this
  refine âŸ¨V, âŸ¨fun r hr â†¦ hV.1 (B.algebraMap_mem âŸ¨r, hrâŸ©),
    ((local_hom_TFAE _).out 3 0).mp fun r hr â†¦ ?_âŸ©, (V.inv_mem_nonunits_iff.mp <|
      hV.2 âŸ¨_, le_add_self (Î± := Ideal B) (Ideal.subset_span rfl), rflâŸ©).resolve_left hx0âŸ©
  rw [â† V.image_maximalIdeal] at hV
  obtain âŸ¨âŸ¨r, _âŸ©, hr, rflâŸ© := hV.2 âŸ¨_, le_self_add (Î± := Ideal B) (Ideal.mem_map_of_mem _ hr), rflâŸ©
  exact hr
","    {x : K} {R : LocalSubring K} (hxR : x âˆ‰ R.toSubring) [IsIntegrallyClosedIn R.toSubring K] :
    âˆƒ V : ValuationSubring K, R â‰¤ V.toLocalSubring âˆ§ x âˆ‰ V ","Proof.\n      Suppose $x \\in K$, $x \\not\\in A$. Consider $B = A[x^{-1}]$. Then $x \\not\\in B$. Namely, if $x = a_0 + a_1x^{-1} + \\ldots + a_ d x^{-d}$ then $x^{d + 1} - a_0x^ d - \\ldots - a_ d = 0$ and $x$ is integral over $A$ in contradiction with the fact that $A$ is normal. Thus $x^{-1}$ is not a unit in $B$. Thus $V(x^{-1}) \\subset \\mathop{\\mathrm{Spec}}(B)$ is not empty (Lemma 10.17.2 [[\n  Lemma 10.17.2. Let $R$ be a ring. \n  \n  \nThe spectrum of a ring $R$ is empty if and only if $R$ is the zero ring. \n\n\nEvery nonzero ring has a maximal ideal. \n\n\nEvery nonzero ring has a minimal prime ideal. \n\n\nGiven an ideal $I \\subset R$ and a prime ideal $I \\subset \\mathfrak p$ there exists a prime $I \\subset \\mathfrak q \\subset \\mathfrak p$ such that $\\mathfrak q$ is minimal over $I$. \n\n\nIf $T \\subset R$, and if $(T)$ is the ideal generated by $T$ in $R$, then $V((T)) = V(T)$. \n\n\nIf $I$ is an ideal and $\\sqrt{I}$ is its radical, see basic notion (27), then $V(I) = V(\\sqrt{I})$. \n\n\nGiven an ideal $I$ of $R$ we have $\\sqrt{I} = \\bigcap _{I \\subset \\mathfrak p} \\mathfrak p$. \n\n\nIf $I$ is an ideal then $V(I) = \\emptyset $ if and only if $I$ is the unit ideal. \n\n\nIf $I$, $J$ are ideals of $R$ then $V(I) \\cup V(J) = V(I \\cap J)$. \n\n\nIf $(I_ a)_{a\\in A}$ is a set of ideals of $R$ then $\\bigcap _{a\\in A} V(I_ a) = V(\\bigcup _{a\\in A} I_ a)$. \n\n\nIf $f \\in R$, then $D(f) \\amalg V(f) = \\mathop{\\mathrm{Spec}}(R)$. \n\n\nIf $f \\in R$ then $D(f) = \\emptyset $ if and only if $f$ is nilpotent. \n\n\nIf $f = u f\'$ for some unit $u \\in R$, then $D(f) = D(f\')$. \n\n\nIf $I \\subset R$ is an ideal, and $\\mathfrak p$ is a prime of $R$ with $\\mathfrak p \\not\\in V(I)$, then there exists an $f \\in R$ such that $\\mathfrak p \\in D(f)$, and $D(f) \\cap V(I) = \\emptyset $. \n\n\nIf $f, g \\in R$, then $D(fg) = D(f) \\cap D(g)$. \n\n\nIf $f_ i \\in R$ for $i \\in I$, then $\\bigcup _{i\\in I} D(f_ i)$ is the complement of $V(\\{ f_ i \\} _{i\\in I})$ in $\\mathop{\\mathrm{Spec}}(R)$. \n\n\nIf $f \\in R$ and $D(f) = \\mathop{\\mathrm{Spec}}(R)$, then $f$ is a unit. \n\n\n\n\n    \n]]), and we can choose a prime $\\mathfrak p \\subset B$ with $x^{-1} \\in \\mathfrak p$. Choose a valuation ring $V \\subset K$ dominating $B_\\mathfrak p$ (Lemma 10.50.2 [[\n  Lemma 10.50.2. Let $K$ be a field. Let $A \\subset K$ be a local subring. Then there exists a valuation ring with fraction field $K$ dominating $A$. \n\n    \n]]). Then $x \\not\\in V$ as $x^{-1} \\in \\mathfrak m_ V$. \n    \n      If $A$ is local, then we claim that $x^{-1} B + \\mathfrak m_ A B \\not= B$. Namely, if $1 = (a_0 + a_1x^{-1} + \\ldots + a_ d x^{-d})x^{-1} + a\'_0 + \\ldots + a\'_ d x^{-d}$ with $a_ i \\in A$ and $a\'_ i \\in \\mathfrak m_ A$, then we\'d get \n    \n      \n  \\[  (1 - a\'_0) x^{d + 1} - (a_0 + a\'_1) x^ d - \\ldots - a_ d = 0  \\]\n\n    \n       Since $a\'_0 \\in \\mathfrak m_ A$ we see that $1 - a\'_0$ is a unit in $A$ and we conclude that $x$ would be integral over $A$, a contradiction as before. Then choose the prime $\\mathfrak p \\supset x^{-1} B + \\mathfrak m_ A B$ we find $V$ dominating $A$. \n      $\\square$\n    \n"
361,005A,"def IsRetrocompact (s : Set X) : Prop := âˆ€ â¦ƒUâ¦„, IsCompact U â†’ IsOpen U â†’ IsCompact (s âˆ© U)
",Formal Proof of Stacks Project Tag 005A,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/Topology/Constructible.lean#L52-L52,Q27041,,5.12.1,definition,3.0,"['0059', '004C', '0ELQ']",\n  Definition 5.12.1. Quasi-compactness. \n  \n  \nWe say that a topological space $X$ is quasi-compact if every open covering of $X$ has a finite subcover. \n\n\nWe say that a continuous map $f : X \\to Y$ is quasi-compact if the inverse image $f^{-1}(V)$ of every quasi-compact open $V \\subset Y$ is quasi-compact. \n\n\nWe say a subset $Z \\subset X$ is retrocompact if the inclusion map $Z \\to X$ is quasi-compact. \n\n\n\n,\n  Definition 5.12.1. Quasi-compactness. \n  \n  \nWe say that a topological space $X$ is quasi-compact if every open covering of $X$ has a finite subcover. \n\n\nWe say that a continuous map $f : X \\to Y$ is quasi-compact if the inverse image $f^{-1}(V)$ of every quasi-compact open $V \\subset Y$ is quasi-compact. \n\n\nWe say a subset $Z \\subset X$ is retrocompact if the inclusion map $Z \\to X$ is quasi-compact. \n\n\n\n,," âˆ€ â¦ƒUâ¦„, IsCompact U â†’ IsOpen U â†’ IsCompact (s âˆ© U)
",def IsRetrocompact (s : Set X) : Prop ,
362,005B,"theorem IsSpectralMap.comp {f : Î² â†’ Î³} {g : Î± â†’ Î²} (hf : IsSpectralMap f) (hg : IsSpectralMap g) :
    IsSpectralMap (f âˆ˜ g) :=
  âŸ¨hf.continuous.comp hg.continuous, fun _s hsâ‚€ hsâ‚ =>
    ((hsâ‚.preimage_of_isOpen hf hsâ‚€).preimage_of_isOpen hg) (hsâ‚€.preimage hf.continuous)âŸ©
",Formal Proof of Stacks Project Tag 005B,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/Topology/Spectral/Hom.lean#L59-L62,Q27041,,5.12.2,lemma,3.0,"['0059', '004C', '0ELQ']",\n  Lemma 5.12.2. A composition of quasi-compact maps is quasi-compact. \n\n    \n      Proof.\n      This is immediate from the definition. \n      $\\square$\n    \n,\n  Lemma 5.12.2. A composition of quasi-compact maps is quasi-compact. \n\n    \n,Proof.\n      This is immediate from the definition. \n      $\\square$\n    \n,"
  âŸ¨hf.continuous.comp hg.continuous, fun _s hsâ‚€ hsâ‚ =>
    ((hsâ‚.preimage_of_isOpen hf hsâ‚€).preimage_of_isOpen hg) (hsâ‚€.preimage hf.continuous)âŸ©
","theorem IsSpectralMap.comp {f : Î² â†’ Î³} {g : Î± â†’ Î²} (hf : IsSpectralMap f) (hg : IsSpectralMap g) :
    IsSpectralMap (f âˆ˜ g) ",Proof.\n      This is immediate from the definition. \n      $\\square$\n    \n
363,005J,"lemma IsRetrocompact.preimage_of_isOpenEmbedding {s : Set Y} (hf : IsOpenEmbedding f)
    (hs : IsRetrocompact s) : IsRetrocompact (f â»Â¹' s) := by
  rintro U hUcomp hUopen
  rw [hf.isCompact_iff, image_preimage_inter]
  exact hs (hUcomp.image hf.continuous) <| hf.isOpenMap _ hUopen
",Formal Proof of Stacks Project Tag 005J,Extracted from the proof,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/Topology/Constructible.lean#L152-L156,Q27041,,5.15.4,lemma,3.0,"['04ZC', '004C', '0ELQ']",\n  Lemma 5.15.4. Let $U \\subset X$ be open. For a constructible set $E \\subset X$ the intersection $E \\cap U$ is constructible in $U$. \n\n    \n      Proof.\n      Suppose that $V \\subset X$ is retrocompact open in $X$. It suffices to show that $V \\cap U$ is retrocompact in $U$ by Lemma 5.15.3. To show this let $W \\subset U$ be open and quasi-compact. Then $W$ is open and quasi-compact in $X$. Hence $V \\cap W = V \\cap U \\cap W$ is quasi-compact as $V$ is retrocompact in $X$. \n      $\\square$\n    \n,\n  Lemma 5.15.4. Let $U \\subset X$ be open. For a constructible set $E \\subset X$ the intersection $E \\cap U$ is constructible in $U$. \n\n    \n,Proof.\n      Suppose that $V \\subset X$ is retrocompact open in $X$. It suffices to show that $V \\cap U$ is retrocompact in $U$ by Lemma 5.15.3. To show this let $W \\subset U$ be open and quasi-compact. Then $W$ is open and quasi-compact in $X$. Hence $V \\cap W = V \\cap U \\cap W$ is quasi-compact as $V$ is retrocompact in $X$. \n      $\\square$\n    \n," by
  rintro U hUcomp hUopen
  rw [hf.isCompact_iff, image_preimage_inter]
  exact hs (hUcomp.image hf.continuous) <| hf.isOpenMap _ hUopen
","lemma IsRetrocompact.preimage_of_isOpenEmbedding {s : Set Y} (hf : IsOpenEmbedding f)
    (hs : IsRetrocompact s) : IsRetrocompact (f â»Â¹' s) ","Proof.\n      Suppose that $V \\subset X$ is retrocompact open in $X$. It suffices to show that $V \\cap U$ is retrocompact in $U$ by Lemma 5.15.3 [[\n  Lemma 5.15.3. Let $f : X \\to Y$ be a continuous map of topological spaces. If the inverse image of every retrocompact open subset of $Y$ is retrocompact in $X$, then inverse images of constructible sets are constructible. \n\n    \n]]. To show this let $W \\subset U$ be open and quasi-compact. Then $W$ is open and quasi-compact in $X$. Hence $V \\cap W = V \\cap U \\cap W$ is quasi-compact as $V$ is retrocompact in $X$. \n      $\\square$\n    \n"
364,09YE,"lemma IsRetrocompact.preimage_of_isClosedEmbedding {s : Set Y} (hf : IsClosedEmbedding f)
    (hf' : IsCompact (range f)á¶œ) (hs : IsRetrocompact s) : IsRetrocompact (f â»Â¹' s) := by
  rintro U hUcomp hUopen
  have hfUopen : IsOpen (f '' U âˆª (range f)á¶œ) := by
    simpa [â† range_diff_image hf.injective, sdiff_eq, compl_inter, union_comm]
      using (hf.isClosedMap _ hUopen.isClosed_compl).isOpen_compl
  have hfUcomp : IsCompact (f '' U âˆª (range f)á¶œ) := (hUcomp.image hf.continuous).union hf'
  simpa [inter_union_distrib_left, inter_left_comm, inter_eq_right.2 (image_subset_range ..),
    hf.isCompact_iff, image_preimage_inter] using (hs hfUcomp hfUopen).inter_left hf.isClosed_range
",Formal Proof of Stacks Project Tag 09YE,Extracted from the proof,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/Topology/Constructible.lean#L159-L167,Q27041,,5.15.7,lemma,3.0,"['04ZC', '004C', '0ELQ']","\n  Lemma 5.15.7. Let $X$ be a topological space. Let $Z \\subset X$ be a closed subset such that $X \\setminus Z$ is quasi-compact. Then for a constructible set $E \\subset X$ the intersection $E \\cap Z$ is constructible in $Z$. \n\n    \n      Proof.\n      Suppose that $V \\subset X$ is retrocompact open in $X$. It suffices to show that $V \\cap Z$ is retrocompact in $Z$ by Lemma 5.15.3. To show this let $W \\subset Z$ be open and quasi-compact. The subset $W\' = W \\cup (X \\setminus Z)$ is quasi-compact, open, and $W = Z \\cap W\'$. Hence $V \\cap Z \\cap W = V \\cap Z \\cap W\'$ is a closed subset of the quasi-compact open $V \\cap W\'$ as $V$ is retrocompact in $X$. Thus $V \\cap Z \\cap W$ is quasi-compact by Lemma 5.12.3. \n      $\\square$\n    \n",\n  Lemma 5.15.7. Let $X$ be a topological space. Let $Z \\subset X$ be a closed subset such that $X \\setminus Z$ is quasi-compact. Then for a constructible set $E \\subset X$ the intersection $E \\cap Z$ is constructible in $Z$. \n\n    \n,"Proof.\n      Suppose that $V \\subset X$ is retrocompact open in $X$. It suffices to show that $V \\cap Z$ is retrocompact in $Z$ by Lemma 5.15.3. To show this let $W \\subset Z$ be open and quasi-compact. The subset $W\' = W \\cup (X \\setminus Z)$ is quasi-compact, open, and $W = Z \\cap W\'$. Hence $V \\cap Z \\cap W = V \\cap Z \\cap W\'$ is a closed subset of the quasi-compact open $V \\cap W\'$ as $V$ is retrocompact in $X$. Thus $V \\cap Z \\cap W$ is quasi-compact by Lemma 5.12.3. \n      $\\square$\n    \n"," by
  rintro U hUcomp hUopen
  have hfUopen : IsOpen (f '' U âˆª (range f)á¶œ) := by
    simpa [â† range_diff_image hf.injective, sdiff_eq, compl_inter, union_comm]
      using (hf.isClosedMap _ hUopen.isClosed_compl).isOpen_compl
  have hfUcomp : IsCompact (f '' U âˆª (range f)á¶œ) := (hUcomp.image hf.continuous).union hf'
  simpa [inter_union_distrib_left, inter_left_comm, inter_eq_right.2 (image_subset_range ..),
    hf.isCompact_iff, image_preimage_inter] using (hs hfUcomp hfUopen).inter_left hf.isClosed_range
","lemma IsRetrocompact.preimage_of_isClosedEmbedding {s : Set Y} (hf : IsClosedEmbedding f)
    (hf' : IsCompact (range f)á¶œ) (hs : IsRetrocompact s) : IsRetrocompact (f â»Â¹' s) ","Proof.\n      Suppose that $V \\subset X$ is retrocompact open in $X$. It suffices to show that $V \\cap Z$ is retrocompact in $Z$ by Lemma 5.15.3 [[\n  Lemma 5.15.3. Let $f : X \\to Y$ be a continuous map of topological spaces. If the inverse image of every retrocompact open subset of $Y$ is retrocompact in $X$, then inverse images of constructible sets are constructible. \n\n    \n]]. To show this let $W \\subset Z$ be open and quasi-compact. The subset $W\' = W \\cup (X \\setminus Z)$ is quasi-compact, open, and $W = Z \\cap W\'$. Hence $V \\cap Z \\cap W = V \\cap Z \\cap W\'$ is a closed subset of the quasi-compact open $V \\cap W\'$ as $V$ is retrocompact in $X$. Thus $V \\cap Z \\cap W$ is quasi-compact by Lemma 5.12.3 [[\n  Lemma 5.12.3. A closed subset of a quasi-compact topological space is quasi-compact. \n\n    \n]]. \n      $\\square$\n    \n"
365,005I,"lemma IsConstructible.preimage {s : Set Y} (hfcont : Continuous f)
    (hf : âˆ€ s, IsOpen s â†’ IsRetrocompact s â†’ IsRetrocompact (f â»Â¹' s)) (hs : IsConstructible s) :
    IsConstructible (f â»Â¹' s) := by
  induction hs using IsConstructible.empty_union_induction with
  | open_retrocompact U hUopen hUcomp =>
    exact (hf _ hUopen hUcomp).isConstructible <| hUopen.preimage hfcont
  | union s hs t ht hs' ht' => rw [preimage_union]; exact hs'.union ht'
  | compl s hs hs' => rw [preimage_compl]; exact hs'.compl
",Formal Proof of Stacks Project Tag 005I,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/Topology/Constructible.lean#L244-L251,Q27041,,5.15.3,lemma,3.0,"['04ZC', '004C', '0ELQ']","\n  Lemma 5.15.3. Let $f : X \\to Y$ be a continuous map of topological spaces. If the inverse image of every retrocompact open subset of $Y$ is retrocompact in $X$, then inverse images of constructible sets are constructible. \n\n    \n      Proof.\n      This is true because $f^{-1}(U \\cap V^ c) = f^{-1}(U) \\cap f^{-1}(V)^ c$, combined with the definition of constructible sets. \n      $\\square$\n    \n","\n  Lemma 5.15.3. Let $f : X \\to Y$ be a continuous map of topological spaces. If the inverse image of every retrocompact open subset of $Y$ is retrocompact in $X$, then inverse images of constructible sets are constructible. \n\n    \n","Proof.\n      This is true because $f^{-1}(U \\cap V^ c) = f^{-1}(U) \\cap f^{-1}(V)^ c$, combined with the definition of constructible sets. \n      $\\square$\n    \n"," by
  induction hs using IsConstructible.empty_union_induction with
  | open_retrocompact U hUopen hUcomp =>
    exact (hf _ hUopen hUcomp).isConstructible <| hUopen.preimage hfcont
  | union s hs t ht hs' ht' => rw [preimage_union]; exact hs'.union ht'
  | compl s hs hs' => rw [preimage_compl]; exact hs'.compl
","lemma IsConstructible.preimage {s : Set Y} (hfcont : Continuous f)
    (hf : âˆ€ s, IsOpen s â†’ IsRetrocompact s â†’ IsRetrocompact (f â»Â¹' s)) (hs : IsConstructible s) :
    IsConstructible (f â»Â¹' s) ","Proof.\n      This is true because $f^{-1}(U \\cap V^ c) = f^{-1}(U) \\cap f^{-1}(V)^ c$, combined with the definition of constructible sets. \n      $\\square$\n    \n"
366,005J,"lemma IsConstructible.preimage_of_isOpenEmbedding {s : Set Y} (hf : IsOpenEmbedding f)
    (hs : IsConstructible s) : IsConstructible (f â»Â¹' s) :=
  hs.preimage hf.continuous fun _t _ ht â†¦ ht.preimage_of_isOpenEmbedding hf
",Formal Proof of Stacks Project Tag 005J,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/Topology/Constructible.lean#L254-L256,Q27041,,5.15.4,lemma,3.0,"['04ZC', '004C', '0ELQ']",\n  Lemma 5.15.4. Let $U \\subset X$ be open. For a constructible set $E \\subset X$ the intersection $E \\cap U$ is constructible in $U$. \n\n    \n      Proof.\n      Suppose that $V \\subset X$ is retrocompact open in $X$. It suffices to show that $V \\cap U$ is retrocompact in $U$ by Lemma 5.15.3. To show this let $W \\subset U$ be open and quasi-compact. Then $W$ is open and quasi-compact in $X$. Hence $V \\cap W = V \\cap U \\cap W$ is quasi-compact as $V$ is retrocompact in $X$. \n      $\\square$\n    \n,\n  Lemma 5.15.4. Let $U \\subset X$ be open. For a constructible set $E \\subset X$ the intersection $E \\cap U$ is constructible in $U$. \n\n    \n,Proof.\n      Suppose that $V \\subset X$ is retrocompact open in $X$. It suffices to show that $V \\cap U$ is retrocompact in $U$ by Lemma 5.15.3. To show this let $W \\subset U$ be open and quasi-compact. Then $W$ is open and quasi-compact in $X$. Hence $V \\cap W = V \\cap U \\cap W$ is quasi-compact as $V$ is retrocompact in $X$. \n      $\\square$\n    \n,"
  hs.preimage hf.continuous fun _t _ ht â†¦ ht.preimage_of_isOpenEmbedding hf
","lemma IsConstructible.preimage_of_isOpenEmbedding {s : Set Y} (hf : IsOpenEmbedding f)
    (hs : IsConstructible s) : IsConstructible (f â»Â¹' s) ","Proof.\n      Suppose that $V \\subset X$ is retrocompact open in $X$. It suffices to show that $V \\cap U$ is retrocompact in $U$ by Lemma 5.15.3 [[\n  Lemma 5.15.3. Let $f : X \\to Y$ be a continuous map of topological spaces. If the inverse image of every retrocompact open subset of $Y$ is retrocompact in $X$, then inverse images of constructible sets are constructible. \n\n    \n]]. To show this let $W \\subset U$ be open and quasi-compact. Then $W$ is open and quasi-compact in $X$. Hence $V \\cap W = V \\cap U \\cap W$ is quasi-compact as $V$ is retrocompact in $X$. \n      $\\square$\n    \n"
367,09YE,"lemma IsConstructible.preimage_of_isClosedEmbedding {s : Set Y} (hf : IsClosedEmbedding f)
    (hf' : IsCompact (range f)á¶œ) (hs : IsConstructible s) : IsConstructible (f â»Â¹' s) :=
  hs.preimage hf.continuous fun _t _ ht â†¦ ht.preimage_of_isClosedEmbedding hf hf'
",Formal Proof of Stacks Project Tag 09YE,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/Topology/Constructible.lean#L259-L261,Q27041,,5.15.7,lemma,3.0,"['04ZC', '004C', '0ELQ']","\n  Lemma 5.15.7. Let $X$ be a topological space. Let $Z \\subset X$ be a closed subset such that $X \\setminus Z$ is quasi-compact. Then for a constructible set $E \\subset X$ the intersection $E \\cap Z$ is constructible in $Z$. \n\n    \n      Proof.\n      Suppose that $V \\subset X$ is retrocompact open in $X$. It suffices to show that $V \\cap Z$ is retrocompact in $Z$ by Lemma 5.15.3. To show this let $W \\subset Z$ be open and quasi-compact. The subset $W\' = W \\cup (X \\setminus Z)$ is quasi-compact, open, and $W = Z \\cap W\'$. Hence $V \\cap Z \\cap W = V \\cap Z \\cap W\'$ is a closed subset of the quasi-compact open $V \\cap W\'$ as $V$ is retrocompact in $X$. Thus $V \\cap Z \\cap W$ is quasi-compact by Lemma 5.12.3. \n      $\\square$\n    \n",\n  Lemma 5.15.7. Let $X$ be a topological space. Let $Z \\subset X$ be a closed subset such that $X \\setminus Z$ is quasi-compact. Then for a constructible set $E \\subset X$ the intersection $E \\cap Z$ is constructible in $Z$. \n\n    \n,"Proof.\n      Suppose that $V \\subset X$ is retrocompact open in $X$. It suffices to show that $V \\cap Z$ is retrocompact in $Z$ by Lemma 5.15.3. To show this let $W \\subset Z$ be open and quasi-compact. The subset $W\' = W \\cup (X \\setminus Z)$ is quasi-compact, open, and $W = Z \\cap W\'$. Hence $V \\cap Z \\cap W = V \\cap Z \\cap W\'$ is a closed subset of the quasi-compact open $V \\cap W\'$ as $V$ is retrocompact in $X$. Thus $V \\cap Z \\cap W$ is quasi-compact by Lemma 5.12.3. \n      $\\square$\n    \n","
  hs.preimage hf.continuous fun _t _ ht â†¦ ht.preimage_of_isClosedEmbedding hf hf'
","lemma IsConstructible.preimage_of_isClosedEmbedding {s : Set Y} (hf : IsClosedEmbedding f)
    (hf' : IsCompact (range f)á¶œ) (hs : IsConstructible s) : IsConstructible (f â»Â¹' s) ","Proof.\n      Suppose that $V \\subset X$ is retrocompact open in $X$. It suffices to show that $V \\cap Z$ is retrocompact in $Z$ by Lemma 5.15.3 [[\n  Lemma 5.15.3. Let $f : X \\to Y$ be a continuous map of topological spaces. If the inverse image of every retrocompact open subset of $Y$ is retrocompact in $X$, then inverse images of constructible sets are constructible. \n\n    \n]]. To show this let $W \\subset Z$ be open and quasi-compact. The subset $W\' = W \\cup (X \\setminus Z)$ is quasi-compact, open, and $W = Z \\cap W\'$. Hence $V \\cap Z \\cap W = V \\cap Z \\cap W\'$ is a closed subset of the quasi-compact open $V \\cap W\'$ as $V$ is retrocompact in $X$. Thus $V \\cap Z \\cap W$ is quasi-compact by Lemma 5.12.3 [[\n  Lemma 5.12.3. A closed subset of a quasi-compact topological space is quasi-compact. \n\n    \n]]. \n      $\\square$\n    \n"
368,09YD,"lemma IsConstructible.image_of_isOpenEmbedding (hfopen : IsOpenEmbedding f)
    (hfcomp : IsRetrocompact (range f)) (hs : IsConstructible s) : IsConstructible (f '' s) := by
  induction hs using IsConstructible.empty_union_induction with
  | open_retrocompact U hUopen hUcomp =>
    exact (hUcomp.image_of_isEmbedding hfopen.isEmbedding hfcomp).isConstructible <|
      hfopen.isOpenMap _ hUopen
  | union s hs t ht hs' ht' => rw [image_union]; exact hs'.union ht'
  | compl s hs hs' =>
    rw [â† range_diff_image hfopen.injective]
    exact (hfcomp.isConstructible hfopen.isOpen_range).sdiff hs'
",Formal Proof of Stacks Project Tag 09YD,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/Topology/Constructible.lean#L264-L273,Q27041,,5.15.5,lemma,3.0,"['04ZC', '004C', '0ELQ']","\n  Lemma 5.15.5. Let $U \\subset X$ be a retrocompact open. Let $E \\subset U$. If $E$ is constructible in $U$, then $E$ is constructible in $X$. \n\n    \n      Proof.\n      Suppose that $V, W \\subset U$ are retrocompact open in $U$. Then $V, W$ are retrocompact open in $X$ (Lemma 5.12.2). Hence $V \\cap (U \\setminus W) = V \\cap (X \\setminus W)$ is constructible in $X$. We conclude since every constructible subset of $U$ is a finite union of subsets of the form $V \\cap (U \\setminus W)$. \n      $\\square$\n    \n","\n  Lemma 5.15.5. Let $U \\subset X$ be a retrocompact open. Let $E \\subset U$. If $E$ is constructible in $U$, then $E$ is constructible in $X$. \n\n    \n","Proof.\n      Suppose that $V, W \\subset U$ are retrocompact open in $U$. Then $V, W$ are retrocompact open in $X$ (Lemma 5.12.2). Hence $V \\cap (U \\setminus W) = V \\cap (X \\setminus W)$ is constructible in $X$. We conclude since every constructible subset of $U$ is a finite union of subsets of the form $V \\cap (U \\setminus W)$. \n      $\\square$\n    \n"," by
  induction hs using IsConstructible.empty_union_induction with
  | open_retrocompact U hUopen hUcomp =>
    exact (hUcomp.image_of_isEmbedding hfopen.isEmbedding hfcomp).isConstructible <|
      hfopen.isOpenMap _ hUopen
  | union s hs t ht hs' ht' => rw [image_union]; exact hs'.union ht'
  | compl s hs hs' =>
    rw [â† range_diff_image hfopen.injective]
    exact (hfcomp.isConstructible hfopen.isOpen_range).sdiff hs'
","lemma IsConstructible.image_of_isOpenEmbedding (hfopen : IsOpenEmbedding f)
    (hfcomp : IsRetrocompact (range f)) (hs : IsConstructible s) : IsConstructible (f '' s) ","Proof.\n      Suppose that $V, W \\subset U$ are retrocompact open in $U$. Then $V, W$ are retrocompact open in $X$ (Lemma 5.12.2 [[\n  Lemma 5.12.2. A composition of quasi-compact maps is quasi-compact. \n\n    \n]]). Hence $V \\cap (U \\setminus W) = V \\cap (X \\setminus W)$ is constructible in $X$. We conclude since every constructible subset of $U$ is a finite union of subsets of the form $V \\cap (U \\setminus W)$. \n      $\\square$\n    \n"
369,09YG,"lemma IsConstructible.image_of_isClosedEmbedding (hf : IsClosedEmbedding f)
    (hfcomp : IsRetrocompact (range f)á¶œ) (hs : IsConstructible s) : IsConstructible (f '' s) := by
  induction hs using IsConstructible.empty_union_induction with
  | open_retrocompact U hUopen hUcomp =>
    have hfU : IsOpen (f '' U âˆª (range f)á¶œ) := by
      simpa [â† range_diff_image hf.injective, sdiff_eq, compl_inter, union_comm]
        using (hf.isClosedMap _ hUopen.isClosed_compl).isOpen_compl
    suffices h : IsRetrocompact (f '' U âˆª (range f)á¶œ) by
      simpa [union_inter_distrib_right, inter_eq_left.2 (image_subset_range ..)]
        using (h.isConstructible hfU).sdiff (hfcomp.isConstructible hf.isClosed_range.isOpen_compl)
    rintro V hVcomp hVopen
    rw [union_inter_distrib_right, â† image_inter_preimage]
    exact ((hUcomp (hf.isCompact_preimage hVcomp) (hVopen.preimage hf.continuous)).image
      hf.continuous).union <| hfcomp hVcomp hVopen
  | union s hs t ht hs' ht' => rw [image_union]; exact hs'.union ht'
  | compl s hs hs' =>
    rw [â† range_diff_image hf.injective]
    exact (hfcomp.isConstructible hf.isClosed_range.isOpen_compl).of_compl.sdiff hs'
",Formal Proof of Stacks Project Tag 09YG,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/Topology/Constructible.lean#L276-L293,Q27041,,5.15.9,lemma,3.0,"['04ZC', '004C', '0ELQ']","\n  Lemma 5.15.9. Let $Z \\subset X$ be a closed subset whose complement is retrocompact open. Let $E \\subset Z$. If $E$ is constructible in $Z$, then $E$ is constructible in $X$. \n\n    \n      Proof.\n      Suppose that $V \\subset Z$ is retrocompact open in $Z$. Consider the open subset $\\tilde V = V \\cup (X \\setminus Z)$ of $X$. Let $W \\subset X$ be quasi-compact open. Then \n    \n      \n  \\[  W \\cap \\tilde V = \\left(V \\cap W\\right) \\cup \\left((X \\setminus Z) \\cap W\\right).  \\]\n\n    \n       The first part is quasi-compact as $V \\cap W = V \\cap (Z \\cap W)$ and $(Z \\cap W)$ is quasi-compact open in $Z$ (Lemma 5.12.3) and $V$ is retrocompact in $Z$. The second part is quasi-compact as $(X \\setminus Z)$ is retrocompact in $X$. In this way we see that $\\tilde V$ is retrocompact in $X$. Thus if $V_1, V_2 \\subset Z$ are retrocompact open, then \n    \n      \n  \\[  V_1 \\cap (Z \\setminus V_2) = \\tilde V_1 \\cap (X \\setminus \\tilde V_2)  \\]\n\n    \n       is constructible in $X$. We conclude since every constructible subset of $Z$ is a finite union of subsets of the form $V_1 \\cap (Z \\setminus V_2)$. \n      $\\square$\n    \n","\n  Lemma 5.15.9. Let $Z \\subset X$ be a closed subset whose complement is retrocompact open. Let $E \\subset Z$. If $E$ is constructible in $Z$, then $E$ is constructible in $X$. \n\n    \n","Proof.\n      Suppose that $V \\subset Z$ is retrocompact open in $Z$. Consider the open subset $\\tilde V = V \\cup (X \\setminus Z)$ of $X$. Let $W \\subset X$ be quasi-compact open. Then \n    \n      \n  \\[  W \\cap \\tilde V = \\left(V \\cap W\\right) \\cup \\left((X \\setminus Z) \\cap W\\right).  \\]\n\n    \n       The first part is quasi-compact as $V \\cap W = V \\cap (Z \\cap W)$ and $(Z \\cap W)$ is quasi-compact open in $Z$ (Lemma 5.12.3) and $V$ is retrocompact in $Z$. The second part is quasi-compact as $(X \\setminus Z)$ is retrocompact in $X$. In this way we see that $\\tilde V$ is retrocompact in $X$. Thus if $V_1, V_2 \\subset Z$ are retrocompact open, then \n    \n      \n  \\[  V_1 \\cap (Z \\setminus V_2) = \\tilde V_1 \\cap (X \\setminus \\tilde V_2)  \\]\n\n    \n       is constructible in $X$. We conclude since every constructible subset of $Z$ is a finite union of subsets of the form $V_1 \\cap (Z \\setminus V_2)$. \n      $\\square$\n    \n"," by
  induction hs using IsConstructible.empty_union_induction with
  | open_retrocompact U hUopen hUcomp =>
    have hfU : IsOpen (f '' U âˆª (range f)á¶œ) := by
      simpa [â† range_diff_image hf.injective, sdiff_eq, compl_inter, union_comm]
        using (hf.isClosedMap _ hUopen.isClosed_compl).isOpen_compl
    suffices h : IsRetrocompact (f '' U âˆª (range f)á¶œ) by
      simpa [union_inter_distrib_right, inter_eq_left.2 (image_subset_range ..)]
        using (h.isConstructible hfU).sdiff (hfcomp.isConstructible hf.isClosed_range.isOpen_compl)
    rintro V hVcomp hVopen
    rw [union_inter_distrib_right, â† image_inter_preimage]
    exact ((hUcomp (hf.isCompact_preimage hVcomp) (hVopen.preimage hf.continuous)).image
      hf.continuous).union <| hfcomp hVcomp hVopen
  | union s hs t ht hs' ht' => rw [image_union]; exact hs'.union ht'
  | compl s hs hs' =>
    rw [â† range_diff_image hf.injective]
    exact (hfcomp.isConstructible hf.isClosed_range.isOpen_compl).of_compl.sdiff hs'
","lemma IsConstructible.image_of_isClosedEmbedding (hf : IsClosedEmbedding f)
    (hfcomp : IsRetrocompact (range f)á¶œ) (hs : IsConstructible s) : IsConstructible (f '' s) ","Proof.\n      Suppose that $V \\subset Z$ is retrocompact open in $Z$. Consider the open subset $\\tilde V = V \\cup (X \\setminus Z)$ of $X$. Let $W \\subset X$ be quasi-compact open. Then \n    \n      \n  \\[  W \\cap \\tilde V = \\left(V \\cap W\\right) \\cup \\left((X \\setminus Z) \\cap W\\right).  \\]\n\n    \n       The first part is quasi-compact as $V \\cap W = V \\cap (Z \\cap W)$ and $(Z \\cap W)$ is quasi-compact open in $Z$ (Lemma 5.12.3 [[\n  Lemma 5.12.3. A closed subset of a quasi-compact topological space is quasi-compact. \n\n    \n]]) and $V$ is retrocompact in $Z$. The second part is quasi-compact as $(X \\setminus Z)$ is retrocompact in $X$. In this way we see that $\\tilde V$ is retrocompact in $X$. Thus if $V_1, V_2 \\subset Z$ are retrocompact open, then \n    \n      \n  \\[  V_1 \\cap (Z \\setminus V_2) = \\tilde V_1 \\cap (X \\setminus \\tilde V_2)  \\]\n\n    \n       is constructible in $X$. We conclude since every constructible subset of $Z$ is a finite union of subsets of the form $V_1 \\cap (Z \\setminus V_2)$. \n      $\\square$\n    \n"
370,0069,"lemma _root_.QuasiSeparatedSpace.isRetrocompact_iff_isCompact
    (hU : IsOpen U) : IsRetrocompact U â†” IsCompact U :=
  âŸ¨IsRetrocompact.isCompact, (IsCompact.isRetrocompact Â· hU)âŸ©
",Formal Proof of Stacks Project Tag 0069,Iff form of (2). Note that Stacks doesn't define quasi-separated spaces.,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/Topology/Constructible.lean#L334-L336,Q27041,,5.27.1,lemma,3.0,"['0067', '004C', '0ELQ']","\n  Lemma 5.27.1. Let $X$ be a topological space which \n  \n  \nhas a basis of the topology consisting of quasi-compact opens, and \n\n\nhas the property that the intersection of any two quasi-compact opens is quasi-compact. \n\n\n\n   Then \n  \n  \n$X$ is locally quasi-compact, \n\n\na quasi-compact open $U \\subset X$ is retrocompact, \n\n\nany quasi-compact open $U \\subset X$ has a cofinal system of open coverings $\\mathcal{U} : U = \\bigcup _{j\\in J} U_ j$ with $J$ finite and all $U_ j$ and $U_ j \\cap U_{j\'}$ quasi-compact, \n\n\nadd more here. \n\n\n\n\n    \n      Proof.\n      Omitted. \n      $\\square$\n    \n","\n  Lemma 5.27.1. Let $X$ be a topological space which \n  \n  \nhas a basis of the topology consisting of quasi-compact opens, and \n\n\nhas the property that the intersection of any two quasi-compact opens is quasi-compact. \n\n\n\n   Then \n  \n  \n$X$ is locally quasi-compact, \n\n\na quasi-compact open $U \\subset X$ is retrocompact, \n\n\nany quasi-compact open $U \\subset X$ has a cofinal system of open coverings $\\mathcal{U} : U = \\bigcup _{j\\in J} U_ j$ with $J$ finite and all $U_ j$ and $U_ j \\cap U_{j\'}$ quasi-compact, \n\n\nadd more here. \n\n\n\n\n    \n",Proof.\n      Omitted. \n      $\\square$\n    \n,"
  âŸ¨IsRetrocompact.isCompact, (IsCompact.isRetrocompact Â· hU)âŸ©
","lemma _root_.QuasiSeparatedSpace.isRetrocompact_iff_isCompact
    (hU : IsOpen U) : IsRetrocompact U â†” IsCompact U ",Proof.\n      Omitted. \n      $\\square$\n    \n
371,005G,"def IsLocallyConstructible (s : Set X) : Prop := âˆ€ x, âˆƒ U âˆˆ ð“ x, IsOpen U âˆ§ IsConstructible (U â†“âˆ© s)
",Formal Proof of Stacks Project Tag 005G,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/Topology/Constructible.lean#L376-L376,Q27041,,5.15.1,definition,3.0,"['04ZC', '004C', '0ELQ']","\n  Definition 5.15.1. Let $X$ be a topological space. Let $E \\subset X$ be a subset of $X$. \n  \n  \nWe say $E$ is constructible1 in $X$ if $E$ is a finite union of subsets of the form $U \\cap V^ c$ where $U, V \\subset X$ are open and retrocompact in $X$. \n\n\nWe say $E$ is locally constructible in $X$ if there exists an open covering $X = \\bigcup V_ i$ such that each $E \\cap V_ i$ is constructible in $V_ i$. \n\n\n\n","\n  Definition 5.15.1. Let $X$ be a topological space. Let $E \\subset X$ be a subset of $X$. \n  \n  \nWe say $E$ is constructible1 in $X$ if $E$ is a finite union of subsets of the form $U \\cap V^ c$ where $U, V \\subset X$ are open and retrocompact in $X$. \n\n\nWe say $E$ is locally constructible in $X$ if there exists an open covering $X = \\bigcup V_ i$ such that each $E \\cap V_ i$ is constructible in $V_ i$. \n\n\n\n",," âˆ€ x, âˆƒ U âˆˆ ð“ x, IsOpen U âˆ§ IsConstructible (U â†“âˆ© s)
",def IsLocallyConstructible (s : Set X) : Prop ,
372,004V,"def IsIrreducible (s : Set X) : Prop :=
  s.Nonempty âˆ§ IsPreirreducible s
",Formal Proof of Stacks Project Tag 004V,(1) as predicate on subsets of a space,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/Topology/Irreducible.lean#L51-L52,Q27041,,5.8.1,definition,3.0,"['004U', '004C', '0ELQ']","\n  Definition 5.8.1. Let $X$ be a topological space. \n  \n  \nWe say $X$ is irreducible, if $X$ is not empty, and whenever $X = Z_1 \\cup Z_2$ with $Z_ i$ closed, we have $X = Z_1$ or $X = Z_2$. \n\n\nWe say $Z \\subset X$ is an irreducible component of $X$ if $Z$ is a maximal irreducible subset of $X$. \n\n\n\n","\n  Definition 5.8.1. Let $X$ be a topological space. \n  \n  \nWe say $X$ is irreducible, if $X$ is not empty, and whenever $X = Z_1 \\cup Z_2$ with $Z_ i$ closed, we have $X = Z_1$ or $X = Z_2$. \n\n\nWe say $Z \\subset X$ is an irreducible component of $X$ if $Z$ is a maximal irreducible subset of $X$. \n\n\n\n",,"
  s.Nonempty âˆ§ IsPreirreducible s
",def IsIrreducible (s : Set X) : Prop ,
373,004W,"theorem isIrreducible_iff_closure : IsIrreducible (closure s) â†” IsIrreducible s :=
  and_congr closure_nonempty_iff isPreirreducible_iff_closure
",Formal Proof of Stacks Project Tag 004W,(1),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/Topology/Irreducible.lean#L78-L79,Q27041,,5.8.3,lemma,3.0,"['004U', '004C', '0ELQ']","\n  Lemma 5.8.3. Let $X$ be a topological space. \n  \n  \nIf $T \\subset X$ is irreducible so is its closure in $X$. \n\n\nAny irreducible component of $X$ is closed. \n\n\nAny irreducible subset of $X$ is contained in an irreducible component of $X$. \n\n\nEvery point of $X$ is contained in some irreducible component of $X$, in other words, $X$ is the union of its irreducible components. \n\n\n\n\n    \n      Proof.\n      Let $\\overline{T}$ be the closure of the irreducible subset $T$. If $\\overline{T} = Z_1 \\cup Z_2$ with $Z_ i \\subset \\overline{T}$ closed, then $T = (T\\cap Z_1) \\cup (T \\cap Z_2)$ and hence $T$ equals one of the two, say $T = Z_1 \\cap T$. Thus clearly $\\overline{T} \\subset Z_1$. This proves (1). Part (2) follows immediately from (1) and the definition of irreducible components. \n    \n      Let $T \\subset X$ be irreducible. Consider the set $A$ of irreducible subsets $T \\subset T\' \\subset X$. Note that $A$ is nonempty since $T \\in A$. There is a partial ordering on $A$ coming from inclusion: $T\' \\leq T\'\' \\Leftrightarrow T\' \\subset T\'\'$. Choose a maximal totally ordered subset $A\' \\subset A$, and let $E = \\bigcup _{T\' \\in A\'} T\'$. We claim that $E$ is irreducible. Namely, suppose that $E = Z_1 \\cup Z_2$ is a union of two closed subsets of $E$. For each $T\' \\in A\'$ we have either $T\' \\subset Z_1$ or $T\' \\subset Z_2$, by irreducibility of $T\'$. Suppose that for some $T\'_0 \\in A\'$ we have $T\'_0 \\not\\subset Z_1$ (say, if not we\'re done anyway). Then, since $A\'$ is totally ordered we see immediately that $T\' \\subset Z_2$ for all $T\' \\in A\'$. Hence $E = Z_2$. This proves (3). Part (4) is an immediate consequence of (3) as a singleton space is irreducible. \n      $\\square$\n    \n","\n  Lemma 5.8.3. Let $X$ be a topological space. \n  \n  \nIf $T \\subset X$ is irreducible so is its closure in $X$. \n\n\nAny irreducible component of $X$ is closed. \n\n\nAny irreducible subset of $X$ is contained in an irreducible component of $X$. \n\n\nEvery point of $X$ is contained in some irreducible component of $X$, in other words, $X$ is the union of its irreducible components. \n\n\n\n\n    \n","Proof.\n      Let $\\overline{T}$ be the closure of the irreducible subset $T$. If $\\overline{T} = Z_1 \\cup Z_2$ with $Z_ i \\subset \\overline{T}$ closed, then $T = (T\\cap Z_1) \\cup (T \\cap Z_2)$ and hence $T$ equals one of the two, say $T = Z_1 \\cap T$. Thus clearly $\\overline{T} \\subset Z_1$. This proves (1). Part (2) follows immediately from (1) and the definition of irreducible components. \n    \n      Let $T \\subset X$ be irreducible. Consider the set $A$ of irreducible subsets $T \\subset T\' \\subset X$. Note that $A$ is nonempty since $T \\in A$. There is a partial ordering on $A$ coming from inclusion: $T\' \\leq T\'\' \\Leftrightarrow T\' \\subset T\'\'$. Choose a maximal totally ordered subset $A\' \\subset A$, and let $E = \\bigcup _{T\' \\in A\'} T\'$. We claim that $E$ is irreducible. Namely, suppose that $E = Z_1 \\cup Z_2$ is a union of two closed subsets of $E$. For each $T\' \\in A\'$ we have either $T\' \\subset Z_1$ or $T\' \\subset Z_2$, by irreducibility of $T\'$. Suppose that for some $T\'_0 \\in A\'$ we have $T\'_0 \\not\\subset Z_1$ (say, if not we\'re done anyway). Then, since $A\'$ is totally ordered we see immediately that $T\' \\subset Z_2$ for all $T\' \\in A\'$. Hence $E = Z_2$. This proves (3). Part (4) is an immediate consequence of (3) as a singleton space is irreducible. \n      $\\square$\n    \n","
  and_congr closure_nonempty_iff isPreirreducible_iff_closure
",theorem isIrreducible_iff_closure : IsIrreducible (closure s) â†” IsIrreducible s ,"Proof.\n      Let $\\overline{T}$ be the closure of the irreducible subset $T$. If $\\overline{T} = Z_1 \\cup Z_2$ with $Z_ i \\subset \\overline{T}$ closed, then $T = (T\\cap Z_1) \\cup (T \\cap Z_2)$ and hence $T$ equals one of the two, say $T = Z_1 \\cap T$. Thus clearly $\\overline{T} \\subset Z_1$. This proves (1). Part (2) follows immediately from (1) and the definition of irreducible components. \n    \n      Let $T \\subset X$ be irreducible. Consider the set $A$ of irreducible subsets $T \\subset T\' \\subset X$. Note that $A$ is nonempty since $T \\in A$. There is a partial ordering on $A$ coming from inclusion: $T\' \\leq T\'\' \\Leftrightarrow T\' \\subset T\'\'$. Choose a maximal totally ordered subset $A\' \\subset A$, and let $E = \\bigcup _{T\' \\in A\'} T\'$. We claim that $E$ is irreducible. Namely, suppose that $E = Z_1 \\cup Z_2$ is a union of two closed subsets of $E$. For each $T\' \\in A\'$ we have either $T\' \\subset Z_1$ or $T\' \\subset Z_2$, by irreducibility of $T\'$. Suppose that for some $T\'_0 \\in A\'$ we have $T\'_0 \\not\\subset Z_1$ (say, if not we\'re done anyway). Then, since $A\'$ is totally ordered we see immediately that $T\' \\subset Z_2$ for all $T\' \\in A\'$. Hence $E = Z_2$. This proves (3). Part (4) is an immediate consequence of (3) as a singleton space is irreducible. \n      $\\square$\n    \n"
374,004V,"def irreducibleComponents (X : Type*) [TopologicalSpace X] : Set (Set X) :=
  {s | Maximal IsIrreducible s}
",Formal Proof of Stacks Project Tag 004V,(2),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/Topology/Irreducible.lean#L106-L107,Q27041,,5.8.1,definition,3.0,"['004U', '004C', '0ELQ']","\n  Definition 5.8.1. Let $X$ be a topological space. \n  \n  \nWe say $X$ is irreducible, if $X$ is not empty, and whenever $X = Z_1 \\cup Z_2$ with $Z_ i$ closed, we have $X = Z_1$ or $X = Z_2$. \n\n\nWe say $Z \\subset X$ is an irreducible component of $X$ if $Z$ is a maximal irreducible subset of $X$. \n\n\n\n","\n  Definition 5.8.1. Let $X$ be a topological space. \n  \n  \nWe say $X$ is irreducible, if $X$ is not empty, and whenever $X = Z_1 \\cup Z_2$ with $Z_ i$ closed, we have $X = Z_1$ or $X = Z_2$. \n\n\nWe say $Z \\subset X$ is an irreducible component of $X$ if $Z$ is a maximal irreducible subset of $X$. \n\n\n\n",,"
  {s | Maximal IsIrreducible s}
",def irreducibleComponents (X : Type*) [TopologicalSpace X] : Set (Set X) ,
375,004W,"theorem isClosed_of_mem_irreducibleComponents (s) (H : s âˆˆ irreducibleComponents X) :
    IsClosed s := by
  rw [â† closure_eq_iff_isClosed, eq_comm]
  exact subset_closure.antisymm (H.2 H.1.closure subset_closure)
",Formal Proof of Stacks Project Tag 004W,(2),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/Topology/Irreducible.lean#L110-L113,Q27041,,5.8.3,lemma,3.0,"['004U', '004C', '0ELQ']","\n  Lemma 5.8.3. Let $X$ be a topological space. \n  \n  \nIf $T \\subset X$ is irreducible so is its closure in $X$. \n\n\nAny irreducible component of $X$ is closed. \n\n\nAny irreducible subset of $X$ is contained in an irreducible component of $X$. \n\n\nEvery point of $X$ is contained in some irreducible component of $X$, in other words, $X$ is the union of its irreducible components. \n\n\n\n\n    \n      Proof.\n      Let $\\overline{T}$ be the closure of the irreducible subset $T$. If $\\overline{T} = Z_1 \\cup Z_2$ with $Z_ i \\subset \\overline{T}$ closed, then $T = (T\\cap Z_1) \\cup (T \\cap Z_2)$ and hence $T$ equals one of the two, say $T = Z_1 \\cap T$. Thus clearly $\\overline{T} \\subset Z_1$. This proves (1). Part (2) follows immediately from (1) and the definition of irreducible components. \n    \n      Let $T \\subset X$ be irreducible. Consider the set $A$ of irreducible subsets $T \\subset T\' \\subset X$. Note that $A$ is nonempty since $T \\in A$. There is a partial ordering on $A$ coming from inclusion: $T\' \\leq T\'\' \\Leftrightarrow T\' \\subset T\'\'$. Choose a maximal totally ordered subset $A\' \\subset A$, and let $E = \\bigcup _{T\' \\in A\'} T\'$. We claim that $E$ is irreducible. Namely, suppose that $E = Z_1 \\cup Z_2$ is a union of two closed subsets of $E$. For each $T\' \\in A\'$ we have either $T\' \\subset Z_1$ or $T\' \\subset Z_2$, by irreducibility of $T\'$. Suppose that for some $T\'_0 \\in A\'$ we have $T\'_0 \\not\\subset Z_1$ (say, if not we\'re done anyway). Then, since $A\'$ is totally ordered we see immediately that $T\' \\subset Z_2$ for all $T\' \\in A\'$. Hence $E = Z_2$. This proves (3). Part (4) is an immediate consequence of (3) as a singleton space is irreducible. \n      $\\square$\n    \n","\n  Lemma 5.8.3. Let $X$ be a topological space. \n  \n  \nIf $T \\subset X$ is irreducible so is its closure in $X$. \n\n\nAny irreducible component of $X$ is closed. \n\n\nAny irreducible subset of $X$ is contained in an irreducible component of $X$. \n\n\nEvery point of $X$ is contained in some irreducible component of $X$, in other words, $X$ is the union of its irreducible components. \n\n\n\n\n    \n","Proof.\n      Let $\\overline{T}$ be the closure of the irreducible subset $T$. If $\\overline{T} = Z_1 \\cup Z_2$ with $Z_ i \\subset \\overline{T}$ closed, then $T = (T\\cap Z_1) \\cup (T \\cap Z_2)$ and hence $T$ equals one of the two, say $T = Z_1 \\cap T$. Thus clearly $\\overline{T} \\subset Z_1$. This proves (1). Part (2) follows immediately from (1) and the definition of irreducible components. \n    \n      Let $T \\subset X$ be irreducible. Consider the set $A$ of irreducible subsets $T \\subset T\' \\subset X$. Note that $A$ is nonempty since $T \\in A$. There is a partial ordering on $A$ coming from inclusion: $T\' \\leq T\'\' \\Leftrightarrow T\' \\subset T\'\'$. Choose a maximal totally ordered subset $A\' \\subset A$, and let $E = \\bigcup _{T\' \\in A\'} T\'$. We claim that $E$ is irreducible. Namely, suppose that $E = Z_1 \\cup Z_2$ is a union of two closed subsets of $E$. For each $T\' \\in A\'$ we have either $T\' \\subset Z_1$ or $T\' \\subset Z_2$, by irreducibility of $T\'$. Suppose that for some $T\'_0 \\in A\'$ we have $T\'_0 \\not\\subset Z_1$ (say, if not we\'re done anyway). Then, since $A\'$ is totally ordered we see immediately that $T\' \\subset Z_2$ for all $T\' \\in A\'$. Hence $E = Z_2$. This proves (3). Part (4) is an immediate consequence of (3) as a singleton space is irreducible. \n      $\\square$\n    \n"," by
  rw [â† closure_eq_iff_isClosed, eq_comm]
  exact subset_closure.antisymm (H.2 H.1.closure subset_closure)
","theorem isClosed_of_mem_irreducibleComponents (s) (H : s âˆˆ irreducibleComponents X) :
    IsClosed s ","Proof.\n      Let $\\overline{T}$ be the closure of the irreducible subset $T$. If $\\overline{T} = Z_1 \\cup Z_2$ with $Z_ i \\subset \\overline{T}$ closed, then $T = (T\\cap Z_1) \\cup (T \\cap Z_2)$ and hence $T$ equals one of the two, say $T = Z_1 \\cap T$. Thus clearly $\\overline{T} \\subset Z_1$. This proves (1). Part (2) follows immediately from (1) and the definition of irreducible components. \n    \n      Let $T \\subset X$ be irreducible. Consider the set $A$ of irreducible subsets $T \\subset T\' \\subset X$. Note that $A$ is nonempty since $T \\in A$. There is a partial ordering on $A$ coming from inclusion: $T\' \\leq T\'\' \\Leftrightarrow T\' \\subset T\'\'$. Choose a maximal totally ordered subset $A\' \\subset A$, and let $E = \\bigcup _{T\' \\in A\'} T\'$. We claim that $E$ is irreducible. Namely, suppose that $E = Z_1 \\cup Z_2$ is a union of two closed subsets of $E$. For each $T\' \\in A\'$ we have either $T\' \\subset Z_1$ or $T\' \\subset Z_2$, by irreducibility of $T\'$. Suppose that for some $T\'_0 \\in A\'$ we have $T\'_0 \\not\\subset Z_1$ (say, if not we\'re done anyway). Then, since $A\'$ is totally ordered we see immediately that $T\' \\subset Z_2$ for all $T\' \\in A\'$. Hence $E = Z_2$. This proves (3). Part (4) is an immediate consequence of (3) as a singleton space is irreducible. \n      $\\square$\n    \n"
376,004W,"lemma exists_mem_irreducibleComponents_subset_of_isIrreducible (s : Set X) (hs : IsIrreducible s) :
    âˆƒ u âˆˆ irreducibleComponents X, s âŠ† u := by
  obtain âŸ¨u, huâŸ© := exists_preirreducible s hs.isPreirreducible
  use u, âŸ¨âŸ¨hs.left.mono hu.right.left,hu.leftâŸ©,fun _ h hl => (hu.right.right _ h.right hl).leâŸ©
  exact hu.right.left
",Formal Proof of Stacks Project Tag 004W,(3),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/Topology/Irreducible.lean#L127-L131,Q27041,,5.8.3,lemma,3.0,"['004U', '004C', '0ELQ']","\n  Lemma 5.8.3. Let $X$ be a topological space. \n  \n  \nIf $T \\subset X$ is irreducible so is its closure in $X$. \n\n\nAny irreducible component of $X$ is closed. \n\n\nAny irreducible subset of $X$ is contained in an irreducible component of $X$. \n\n\nEvery point of $X$ is contained in some irreducible component of $X$, in other words, $X$ is the union of its irreducible components. \n\n\n\n\n    \n      Proof.\n      Let $\\overline{T}$ be the closure of the irreducible subset $T$. If $\\overline{T} = Z_1 \\cup Z_2$ with $Z_ i \\subset \\overline{T}$ closed, then $T = (T\\cap Z_1) \\cup (T \\cap Z_2)$ and hence $T$ equals one of the two, say $T = Z_1 \\cap T$. Thus clearly $\\overline{T} \\subset Z_1$. This proves (1). Part (2) follows immediately from (1) and the definition of irreducible components. \n    \n      Let $T \\subset X$ be irreducible. Consider the set $A$ of irreducible subsets $T \\subset T\' \\subset X$. Note that $A$ is nonempty since $T \\in A$. There is a partial ordering on $A$ coming from inclusion: $T\' \\leq T\'\' \\Leftrightarrow T\' \\subset T\'\'$. Choose a maximal totally ordered subset $A\' \\subset A$, and let $E = \\bigcup _{T\' \\in A\'} T\'$. We claim that $E$ is irreducible. Namely, suppose that $E = Z_1 \\cup Z_2$ is a union of two closed subsets of $E$. For each $T\' \\in A\'$ we have either $T\' \\subset Z_1$ or $T\' \\subset Z_2$, by irreducibility of $T\'$. Suppose that for some $T\'_0 \\in A\'$ we have $T\'_0 \\not\\subset Z_1$ (say, if not we\'re done anyway). Then, since $A\'$ is totally ordered we see immediately that $T\' \\subset Z_2$ for all $T\' \\in A\'$. Hence $E = Z_2$. This proves (3). Part (4) is an immediate consequence of (3) as a singleton space is irreducible. \n      $\\square$\n    \n","\n  Lemma 5.8.3. Let $X$ be a topological space. \n  \n  \nIf $T \\subset X$ is irreducible so is its closure in $X$. \n\n\nAny irreducible component of $X$ is closed. \n\n\nAny irreducible subset of $X$ is contained in an irreducible component of $X$. \n\n\nEvery point of $X$ is contained in some irreducible component of $X$, in other words, $X$ is the union of its irreducible components. \n\n\n\n\n    \n","Proof.\n      Let $\\overline{T}$ be the closure of the irreducible subset $T$. If $\\overline{T} = Z_1 \\cup Z_2$ with $Z_ i \\subset \\overline{T}$ closed, then $T = (T\\cap Z_1) \\cup (T \\cap Z_2)$ and hence $T$ equals one of the two, say $T = Z_1 \\cap T$. Thus clearly $\\overline{T} \\subset Z_1$. This proves (1). Part (2) follows immediately from (1) and the definition of irreducible components. \n    \n      Let $T \\subset X$ be irreducible. Consider the set $A$ of irreducible subsets $T \\subset T\' \\subset X$. Note that $A$ is nonempty since $T \\in A$. There is a partial ordering on $A$ coming from inclusion: $T\' \\leq T\'\' \\Leftrightarrow T\' \\subset T\'\'$. Choose a maximal totally ordered subset $A\' \\subset A$, and let $E = \\bigcup _{T\' \\in A\'} T\'$. We claim that $E$ is irreducible. Namely, suppose that $E = Z_1 \\cup Z_2$ is a union of two closed subsets of $E$. For each $T\' \\in A\'$ we have either $T\' \\subset Z_1$ or $T\' \\subset Z_2$, by irreducibility of $T\'$. Suppose that for some $T\'_0 \\in A\'$ we have $T\'_0 \\not\\subset Z_1$ (say, if not we\'re done anyway). Then, since $A\'$ is totally ordered we see immediately that $T\' \\subset Z_2$ for all $T\' \\in A\'$. Hence $E = Z_2$. This proves (3). Part (4) is an immediate consequence of (3) as a singleton space is irreducible. \n      $\\square$\n    \n"," by
  obtain âŸ¨u, huâŸ© := exists_preirreducible s hs.isPreirreducible
  use u, âŸ¨âŸ¨hs.left.mono hu.right.left,hu.leftâŸ©,fun _ h hl => (hu.right.right _ h.right hl).leâŸ©
  exact hu.right.left
","lemma exists_mem_irreducibleComponents_subset_of_isIrreducible (s : Set X) (hs : IsIrreducible s) :
    âˆƒ u âˆˆ irreducibleComponents X, s âŠ† u ","Proof.\n      Let $\\overline{T}$ be the closure of the irreducible subset $T$. If $\\overline{T} = Z_1 \\cup Z_2$ with $Z_ i \\subset \\overline{T}$ closed, then $T = (T\\cap Z_1) \\cup (T \\cap Z_2)$ and hence $T$ equals one of the two, say $T = Z_1 \\cap T$. Thus clearly $\\overline{T} \\subset Z_1$. This proves (1). Part (2) follows immediately from (1) and the definition of irreducible components. \n    \n      Let $T \\subset X$ be irreducible. Consider the set $A$ of irreducible subsets $T \\subset T\' \\subset X$. Note that $A$ is nonempty since $T \\in A$. There is a partial ordering on $A$ coming from inclusion: $T\' \\leq T\'\' \\Leftrightarrow T\' \\subset T\'\'$. Choose a maximal totally ordered subset $A\' \\subset A$, and let $E = \\bigcup _{T\' \\in A\'} T\'$. We claim that $E$ is irreducible. Namely, suppose that $E = Z_1 \\cup Z_2$ is a union of two closed subsets of $E$. For each $T\' \\in A\'$ we have either $T\' \\subset Z_1$ or $T\' \\subset Z_2$, by irreducibility of $T\'$. Suppose that for some $T\'_0 \\in A\'$ we have $T\'_0 \\not\\subset Z_1$ (say, if not we\'re done anyway). Then, since $A\'$ is totally ordered we see immediately that $T\' \\subset Z_2$ for all $T\' \\in A\'$. Hence $E = Z_2$. This proves (3). Part (4) is an immediate consequence of (3) as a singleton space is irreducible. \n      $\\square$\n    \n"
377,004W,"theorem mem_irreducibleComponent {x : X} : x âˆˆ irreducibleComponent x :=
  singleton_subset_iff.1 (irreducibleComponent_property x).2.1
",Formal Proof of Stacks Project Tag 004W,(4),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/Topology/Irreducible.lean#L145-L146,Q27041,,5.8.3,lemma,3.0,"['004U', '004C', '0ELQ']","\n  Lemma 5.8.3. Let $X$ be a topological space. \n  \n  \nIf $T \\subset X$ is irreducible so is its closure in $X$. \n\n\nAny irreducible component of $X$ is closed. \n\n\nAny irreducible subset of $X$ is contained in an irreducible component of $X$. \n\n\nEvery point of $X$ is contained in some irreducible component of $X$, in other words, $X$ is the union of its irreducible components. \n\n\n\n\n    \n      Proof.\n      Let $\\overline{T}$ be the closure of the irreducible subset $T$. If $\\overline{T} = Z_1 \\cup Z_2$ with $Z_ i \\subset \\overline{T}$ closed, then $T = (T\\cap Z_1) \\cup (T \\cap Z_2)$ and hence $T$ equals one of the two, say $T = Z_1 \\cap T$. Thus clearly $\\overline{T} \\subset Z_1$. This proves (1). Part (2) follows immediately from (1) and the definition of irreducible components. \n    \n      Let $T \\subset X$ be irreducible. Consider the set $A$ of irreducible subsets $T \\subset T\' \\subset X$. Note that $A$ is nonempty since $T \\in A$. There is a partial ordering on $A$ coming from inclusion: $T\' \\leq T\'\' \\Leftrightarrow T\' \\subset T\'\'$. Choose a maximal totally ordered subset $A\' \\subset A$, and let $E = \\bigcup _{T\' \\in A\'} T\'$. We claim that $E$ is irreducible. Namely, suppose that $E = Z_1 \\cup Z_2$ is a union of two closed subsets of $E$. For each $T\' \\in A\'$ we have either $T\' \\subset Z_1$ or $T\' \\subset Z_2$, by irreducibility of $T\'$. Suppose that for some $T\'_0 \\in A\'$ we have $T\'_0 \\not\\subset Z_1$ (say, if not we\'re done anyway). Then, since $A\'$ is totally ordered we see immediately that $T\' \\subset Z_2$ for all $T\' \\in A\'$. Hence $E = Z_2$. This proves (3). Part (4) is an immediate consequence of (3) as a singleton space is irreducible. \n      $\\square$\n    \n","\n  Lemma 5.8.3. Let $X$ be a topological space. \n  \n  \nIf $T \\subset X$ is irreducible so is its closure in $X$. \n\n\nAny irreducible component of $X$ is closed. \n\n\nAny irreducible subset of $X$ is contained in an irreducible component of $X$. \n\n\nEvery point of $X$ is contained in some irreducible component of $X$, in other words, $X$ is the union of its irreducible components. \n\n\n\n\n    \n","Proof.\n      Let $\\overline{T}$ be the closure of the irreducible subset $T$. If $\\overline{T} = Z_1 \\cup Z_2$ with $Z_ i \\subset \\overline{T}$ closed, then $T = (T\\cap Z_1) \\cup (T \\cap Z_2)$ and hence $T$ equals one of the two, say $T = Z_1 \\cap T$. Thus clearly $\\overline{T} \\subset Z_1$. This proves (1). Part (2) follows immediately from (1) and the definition of irreducible components. \n    \n      Let $T \\subset X$ be irreducible. Consider the set $A$ of irreducible subsets $T \\subset T\' \\subset X$. Note that $A$ is nonempty since $T \\in A$. There is a partial ordering on $A$ coming from inclusion: $T\' \\leq T\'\' \\Leftrightarrow T\' \\subset T\'\'$. Choose a maximal totally ordered subset $A\' \\subset A$, and let $E = \\bigcup _{T\' \\in A\'} T\'$. We claim that $E$ is irreducible. Namely, suppose that $E = Z_1 \\cup Z_2$ is a union of two closed subsets of $E$. For each $T\' \\in A\'$ we have either $T\' \\subset Z_1$ or $T\' \\subset Z_2$, by irreducibility of $T\'$. Suppose that for some $T\'_0 \\in A\'$ we have $T\'_0 \\not\\subset Z_1$ (say, if not we\'re done anyway). Then, since $A\'$ is totally ordered we see immediately that $T\' \\subset Z_2$ for all $T\' \\in A\'$. Hence $E = Z_2$. This proves (3). Part (4) is an immediate consequence of (3) as a singleton space is irreducible. \n      $\\square$\n    \n","
  singleton_subset_iff.1 (irreducibleComponent_property x).2.1
",theorem mem_irreducibleComponent {x : X} : x âˆˆ irreducibleComponent x ,"Proof.\n      Let $\\overline{T}$ be the closure of the irreducible subset $T$. If $\\overline{T} = Z_1 \\cup Z_2$ with $Z_ i \\subset \\overline{T}$ closed, then $T = (T\\cap Z_1) \\cup (T \\cap Z_2)$ and hence $T$ equals one of the two, say $T = Z_1 \\cap T$. Thus clearly $\\overline{T} \\subset Z_1$. This proves (1). Part (2) follows immediately from (1) and the definition of irreducible components. \n    \n      Let $T \\subset X$ be irreducible. Consider the set $A$ of irreducible subsets $T \\subset T\' \\subset X$. Note that $A$ is nonempty since $T \\in A$. There is a partial ordering on $A$ coming from inclusion: $T\' \\leq T\'\' \\Leftrightarrow T\' \\subset T\'\'$. Choose a maximal totally ordered subset $A\' \\subset A$, and let $E = \\bigcup _{T\' \\in A\'} T\'$. We claim that $E$ is irreducible. Namely, suppose that $E = Z_1 \\cup Z_2$ is a union of two closed subsets of $E$. For each $T\' \\in A\'$ we have either $T\' \\subset Z_1$ or $T\' \\subset Z_2$, by irreducibility of $T\'$. Suppose that for some $T\'_0 \\in A\'$ we have $T\'_0 \\not\\subset Z_1$ (say, if not we\'re done anyway). Then, since $A\'$ is totally ordered we see immediately that $T\' \\subset Z_2$ for all $T\' \\in A\'$. Hence $E = Z_2$. This proves (3). Part (4) is an immediate consequence of (3) as a singleton space is irreducible. \n      $\\square$\n    \n"
378,004V,"class IrreducibleSpace (X : Type*) [TopologicalSpace X] : Prop extends PreirreducibleSpace X where
  toNonempty : Nonempty X
",Formal Proof of Stacks Project Tag 004V,(1) as predicate on a space,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/Topology/Irreducible.lean#L170-L171,Q27041,,5.8.1,definition,3.0,"['004U', '004C', '0ELQ']","\n  Definition 5.8.1. Let $X$ be a topological space. \n  \n  \nWe say $X$ is irreducible, if $X$ is not empty, and whenever $X = Z_1 \\cup Z_2$ with $Z_ i$ closed, we have $X = Z_1$ or $X = Z_2$. \n\n\nWe say $Z \\subset X$ is an irreducible component of $X$ if $Z$ is a maximal irreducible subset of $X$. \n\n\n\n","\n  Definition 5.8.1. Let $X$ be a topological space. \n  \n  \nWe say $X$ is irreducible, if $X$ is not empty, and whenever $X = Z_1 \\cup Z_2$ with $Z_ i$ closed, we have $X = Z_1$ or $X = Z_2$. \n\n\nWe say $Z \\subset X$ is an irreducible component of $X$ if $Z$ is a maximal irreducible subset of $X$. \n\n\n\n",,,"class IrreducibleSpace (X : Type*) [TopologicalSpace X] : Prop extends PreirreducibleSpace X where
  toNonempty : Nonempty X
",
379,0379,"theorem IsIrreducible.image (H : IsIrreducible s) (f : X â†’ Y) (hf : ContinuousOn f s) :
    IsIrreducible (f '' s) :=
  âŸ¨H.nonempty.image _, H.isPreirreducible.image f hfâŸ©
",Formal Proof of Stacks Project Tag 0379,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/Topology/Irreducible.lean#L214-L216,Q27041,,5.8.2,lemma,3.0,"['004U', '004C', '0ELQ']","\n  Lemma 5.8.2. Let $f : X \\to Y$ be a continuous map of topological spaces. If $E \\subset X$ is an irreducible subset, then $f(E) \\subset Y$ is irreducible as well. \n\n    \n      Proof.\n      Clearly we may assume $E = X$ (i.e., $X$ irreducible) and $f(E) = Y$ (i.e., $f$ surjective). First, $Y \\not= \\emptyset $ since $X \\not= \\emptyset $. Next, assume $Y = Y_1 \\cup Y_2$ with $Y_1$, $Y_2$ closed. Then $X = X_1 \\cup X_2$ with $X_ i = f^{-1}(Y_ i)$ closed in $X$. By assumption on $X$, we must have $X = X_1$ or $X = X_2$, hence $Y = Y_1$ or $Y = Y_2$ since $f$ is surjective. \n      $\\square$\n    \n","\n  Lemma 5.8.2. Let $f : X \\to Y$ be a continuous map of topological spaces. If $E \\subset X$ is an irreducible subset, then $f(E) \\subset Y$ is irreducible as well. \n\n    \n","Proof.\n      Clearly we may assume $E = X$ (i.e., $X$ irreducible) and $f(E) = Y$ (i.e., $f$ surjective). First, $Y \\not= \\emptyset $ since $X \\not= \\emptyset $. Next, assume $Y = Y_1 \\cup Y_2$ with $Y_1$, $Y_2$ closed. Then $X = X_1 \\cup X_2$ with $X_ i = f^{-1}(Y_ i)$ closed in $X$. By assumption on $X$, we must have $X = X_1$ or $X = X_2$, hence $Y = Y_1$ or $Y = Y_2$ since $f$ is surjective. \n      $\\square$\n    \n","
  âŸ¨H.nonempty.image _, H.isPreirreducible.image f hfâŸ©
","theorem IsIrreducible.image (H : IsIrreducible s) (f : X â†’ Y) (hf : ContinuousOn f s) :
    IsIrreducible (f '' s) ","Proof.\n      Clearly we may assume $E = X$ (i.e., $X$ irreducible) and $f(E) = Y$ (i.e., $f$ surjective). First, $Y \\not= \\emptyset $ since $X \\not= \\emptyset $. Next, assume $Y = Y_1 \\cup Y_2$ with $Y_1$, $Y_2$ closed. Then $X = X_1 \\cup X_2$ with $X_ i = f^{-1}(Y_ i)$ closed in $X$. By assumption on $X$, we must have $X = X_1$ or $X = X_2$, hence $Y = Y_1$ or $Y = Y_2$ since $f$ is surjective. \n      $\\square$\n    \n"
380,004Z,"lemma IsPreirreducible.preimage_of_dense_isPreirreducible_fiber
    {V : Set Y} (hV : IsPreirreducible V) (f : X â†’ Y) (hf' : IsOpenMap f)
    (hf'' : V âŠ† closure (V âˆ© { x | IsPreirreducible (f â»Â¹' {x}) })) :
    IsPreirreducible (f â»Â¹' V) := by
  rintro Uâ‚ Uâ‚‚ hUâ‚ hUâ‚‚ âŸ¨x, hxV, hxUâ‚âŸ© âŸ¨y, hyV, hyUâ‚‚âŸ©
  obtain âŸ¨z, hzV, hzâ‚, hzâ‚‚âŸ© :=
    hV _ _ (hf' _ hUâ‚) (hf' _ hUâ‚‚) âŸ¨f x, hxV, x, hxUâ‚, rflâŸ© âŸ¨f y, hyV, y, hyUâ‚‚, rflâŸ©
  obtain âŸ¨z, âŸ¨âŸ¨zâ‚, hzâ‚, eâ‚âŸ©, âŸ¨zâ‚‚, hzâ‚‚, eâ‚‚âŸ©âŸ©, hzV, hzâŸ© :=
    mem_closure_iff.mp (hf'' hzV) _ ((hf' _ hUâ‚).inter (hf' _ hUâ‚‚)) âŸ¨hzâ‚, hzâ‚‚âŸ©
  obtain âŸ¨zâ‚ƒ, hzâ‚ƒ, hzâ‚ƒ'âŸ© := hz _ _ hUâ‚ hUâ‚‚ âŸ¨zâ‚, eâ‚, hzâ‚âŸ© âŸ¨zâ‚‚, eâ‚‚, hzâ‚‚âŸ©
  refine âŸ¨zâ‚ƒ, show f zâ‚ƒ âˆˆ _ from (show f zâ‚ƒ = z from hzâ‚ƒ) â–¸ hzV, hzâ‚ƒ'âŸ©
",Formal Proof of Stacks Project Tag 004Z,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/Topology/Irreducible.lean#L355-L365,Q27041,,5.8.14,lemma,3.0,"['004U', '004C', '0ELQ']","\n  Lemma 5.8.14. Let $f : X \\to Y$ be a continuous map of topological spaces. Assume that (a) $Y$ is irreducible, (b) $f$ is open, and (c) there exists a dense collection of points $y \\in Y$ such that $f^{-1}(y)$ is irreducible. Then $X$ is irreducible. \n\n    \n      Proof.\n      Suppose $X = Z_1 \\cup Z_2$ with $Z_ i$ closed. Consider the open sets $U_1 = Z_1 \\setminus Z_2 = X \\setminus Z_2$ and $U_2 = Z_2 \\setminus Z_1 = X \\setminus Z_1$. To get a contradiction assume that $U_1$ and $U_2$ are both nonempty. By (b) we see that $f(U_ i)$ is open. By (a) we have $Y$ irreducible and hence $f(U_1) \\cap f(U_2) \\not= \\emptyset $. By (c) there is a point $y$ which corresponds to a point of this intersection such that the fibre $X_ y = f^{-1}(y)$ is irreducible. Then $X_ y \\cap U_1$ and $X_ y \\cap U_2$ are nonempty disjoint open subsets of $X_ y$ which is a contradiction. \n      $\\square$\n    \n","\n  Lemma 5.8.14. Let $f : X \\to Y$ be a continuous map of topological spaces. Assume that (a) $Y$ is irreducible, (b) $f$ is open, and (c) there exists a dense collection of points $y \\in Y$ such that $f^{-1}(y)$ is irreducible. Then $X$ is irreducible. \n\n    \n",Proof.\n      Suppose $X = Z_1 \\cup Z_2$ with $Z_ i$ closed. Consider the open sets $U_1 = Z_1 \\setminus Z_2 = X \\setminus Z_2$ and $U_2 = Z_2 \\setminus Z_1 = X \\setminus Z_1$. To get a contradiction assume that $U_1$ and $U_2$ are both nonempty. By (b) we see that $f(U_ i)$ is open. By (a) we have $Y$ irreducible and hence $f(U_1) \\cap f(U_2) \\not= \\emptyset $. By (c) there is a point $y$ which corresponds to a point of this intersection such that the fibre $X_ y = f^{-1}(y)$ is irreducible. Then $X_ y \\cap U_1$ and $X_ y \\cap U_2$ are nonempty disjoint open subsets of $X_ y$ which is a contradiction. \n      $\\square$\n    \n," by
  rintro Uâ‚ Uâ‚‚ hUâ‚ hUâ‚‚ âŸ¨x, hxV, hxUâ‚âŸ© âŸ¨y, hyV, hyUâ‚‚âŸ©
  obtain âŸ¨z, hzV, hzâ‚, hzâ‚‚âŸ© :=
    hV _ _ (hf' _ hUâ‚) (hf' _ hUâ‚‚) âŸ¨f x, hxV, x, hxUâ‚, rflâŸ© âŸ¨f y, hyV, y, hyUâ‚‚, rflâŸ©
  obtain âŸ¨z, âŸ¨âŸ¨zâ‚, hzâ‚, eâ‚âŸ©, âŸ¨zâ‚‚, hzâ‚‚, eâ‚‚âŸ©âŸ©, hzV, hzâŸ© :=
    mem_closure_iff.mp (hf'' hzV) _ ((hf' _ hUâ‚).inter (hf' _ hUâ‚‚)) âŸ¨hzâ‚, hzâ‚‚âŸ©
  obtain âŸ¨zâ‚ƒ, hzâ‚ƒ, hzâ‚ƒ'âŸ© := hz _ _ hUâ‚ hUâ‚‚ âŸ¨zâ‚, eâ‚, hzâ‚âŸ© âŸ¨zâ‚‚, eâ‚‚, hzâ‚‚âŸ©
  refine âŸ¨zâ‚ƒ, show f zâ‚ƒ âˆˆ _ from (show f zâ‚ƒ = z from hzâ‚ƒ) â–¸ hzV, hzâ‚ƒ'âŸ©
","lemma IsPreirreducible.preimage_of_dense_isPreirreducible_fiber
    {V : Set Y} (hV : IsPreirreducible V) (f : X â†’ Y) (hf' : IsOpenMap f)
    (hf'' : V âŠ† closure (V âˆ© { x | IsPreirreducible (f â»Â¹' {x}) })) :
    IsPreirreducible (f â»Â¹' V) ",Proof.\n      Suppose $X = Z_1 \\cup Z_2$ with $Z_ i$ closed. Consider the open sets $U_1 = Z_1 \\setminus Z_2 = X \\setminus Z_2$ and $U_2 = Z_2 \\setminus Z_1 = X \\setminus Z_1$. To get a contradiction assume that $U_1$ and $U_2$ are both nonempty. By (b) we see that $f(U_ i)$ is open. By (a) we have $Y$ irreducible and hence $f(U_1) \\cap f(U_2) \\not= \\emptyset $. By (c) there is a point $y$ which corresponds to a point of this intersection such that the fibre $X_ y = f^{-1}(y)$ is irreducible. Then $X_ y \\cap U_1$ and $X_ y \\cap U_2$ are nonempty disjoint open subsets of $X_ y$ which is a contradiction. \n      $\\square$\n    \n
381,037A,"def irreducibleComponentsEquivOfIsPreirreducibleFiber :
    irreducibleComponents Y â‰ƒo irreducibleComponents X where
  invFun W := âŸ¨f '' W.1,
    image_mem_irreducibleComponents_of_isPreirreducible_fiber f hfâ‚ hfâ‚‚ hfâ‚ƒ hfâ‚„ W.2âŸ©
  toFun W := âŸ¨f â»Â¹' W.1,
    preimage_mem_irreducibleComponents_of_isPreirreducible_fiber f hfâ‚ hfâ‚‚ hfâ‚ƒ hfâ‚„ W.2âŸ©
  right_inv W := Subtype.ext <| by
    refine (Set.subset_preimage_image _ _).antisymm' (W.2.2 ?_ (Set.subset_preimage_image _ _))
    refine âŸ¨?_, (W.2.1.image _ hfâ‚.continuousOn).2.preimage_of_isPreirreducible_fiber _ hfâ‚‚ hfâ‚ƒâŸ©
    obtain âŸ¨x, hxâŸ© := W.2.1.1
    exact âŸ¨_, x, hx, rflâŸ©
  left_inv _ := Subtype.ext <| Set.image_preimage_eq _ hfâ‚„
  map_rel_iff' {W Z} := by
    refine âŸ¨fun H â†¦ ?_, Set.preimage_monoâŸ©
    simpa only [Equiv.coe_fn_mk, Set.image_preimage_eq _ hfâ‚„] using Set.image_mono (f := f) H
",Formal Proof of Stacks Project Tag 037A,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/Topology/Irreducible.lean#L407-L421,Q27041,,5.8.15,lemma,3.0,"['004U', '004C', '0ELQ']","\n  Lemma 5.8.15. Let $f : X \\to Y$ be a continuous map of topological spaces. Assume that (a) $f$ is open, and (b) for every $y \\in Y$ the fibre $f^{-1}(y)$ is irreducible. Then $f$ induces a bijection between irreducible components. \n\n    \n      Proof.\n      We point out that assumption (b) implies that $f$ is surjective (see Definition 5.8.1). Let $T \\subset Y$ be an irreducible component. Note that $T$ is closed, see Lemma 5.8.3. The lemma follows if we show that $f^{-1}(T)$ is irreducible because any irreducible subset of $X$ maps into an irreducible component of $Y$ by Lemma 5.8.2. Note that $f^{-1}(T) \\to T$ satisfies the assumptions of Lemma 5.8.14. Hence we win. \n      $\\square$\n    \n","\n  Lemma 5.8.15. Let $f : X \\to Y$ be a continuous map of topological spaces. Assume that (a) $f$ is open, and (b) for every $y \\in Y$ the fibre $f^{-1}(y)$ is irreducible. Then $f$ induces a bijection between irreducible components. \n\n    \n","Proof.\n      We point out that assumption (b) implies that $f$ is surjective (see Definition 5.8.1). Let $T \\subset Y$ be an irreducible component. Note that $T$ is closed, see Lemma 5.8.3. The lemma follows if we show that $f^{-1}(T)$ is irreducible because any irreducible subset of $X$ maps into an irreducible component of $Y$ by Lemma 5.8.2. Note that $f^{-1}(T) \\to T$ satisfies the assumptions of Lemma 5.8.14. Hence we win. \n      $\\square$\n    \n"," âŸ¨f '' W.1,
    image_mem_irreducibleComponents_of_isPreirreducible_fiber f hfâ‚ hfâ‚‚ hfâ‚ƒ hfâ‚„ W.2âŸ©
  toFun W := âŸ¨f â»Â¹' W.1,
    preimage_mem_irreducibleComponents_of_isPreirreducible_fiber f hfâ‚ hfâ‚‚ hfâ‚ƒ hfâ‚„ W.2âŸ©
  right_inv W := Subtype.ext <| by
    refine (Set.subset_preimage_image _ _).antisymm' (W.2.2 ?_ (Set.subset_preimage_image _ _))
    refine âŸ¨?_, (W.2.1.image _ hfâ‚.continuousOn).2.preimage_of_isPreirreducible_fiber _ hfâ‚‚ hfâ‚ƒâŸ©
    obtain âŸ¨x, hxâŸ© := W.2.1.1
    exact âŸ¨_, x, hx, rflâŸ©
  left_inv _ := Subtype.ext <| Set.image_preimage_eq _ hfâ‚„
  map_rel_iff' {W Z} := by
    refine âŸ¨fun H â†¦ ?_, Set.preimage_monoâŸ©
    simpa only [Equiv.coe_fn_mk, Set.image_preimage_eq _ hfâ‚„] using Set.image_mono (f := f) H
","def irreducibleComponentsEquivOfIsPreirreducibleFiber :
    irreducibleComponents Y â‰ƒo irreducibleComponents X where
  invFun W ","Proof.\n      We point out that assumption (b) implies that $f$ is surjective (see Definition 5.8.1 [[\n  Definition 5.8.1. Let $X$ be a topological space. \n  \n  \nWe say $X$ is irreducible, if $X$ is not empty, and whenever $X = Z_1 \\cup Z_2$ with $Z_ i$ closed, we have $X = Z_1$ or $X = Z_2$. \n\n\nWe say $Z \\subset X$ is an irreducible component of $X$ if $Z$ is a maximal irreducible subset of $X$. \n\n\n\n]]). Let $T \\subset Y$ be an irreducible component. Note that $T$ is closed, see Lemma 5.8.3 [[\n  Lemma 5.8.3. Let $X$ be a topological space. \n  \n  \nIf $T \\subset X$ is irreducible so is its closure in $X$. \n\n\nAny irreducible component of $X$ is closed. \n\n\nAny irreducible subset of $X$ is contained in an irreducible component of $X$. \n\n\nEvery point of $X$ is contained in some irreducible component of $X$, in other words, $X$ is the union of its irreducible components. \n\n\n\n\n    \n]]. The lemma follows if we show that $f^{-1}(T)$ is irreducible because any irreducible subset of $X$ maps into an irreducible component of $Y$ by Lemma 5.8.2 [[\n  Lemma 5.8.2. Let $f : X \\to Y$ be a continuous map of topological spaces. If $E \\subset X$ is an irreducible subset, then $f(E) \\subset Y$ is irreducible as well. \n\n    \n]]. Note that $f^{-1}(T) \\to T$ satisfies the assumptions of Lemma 5.8.14 [[\n  Lemma 5.8.14. Let $f : X \\to Y$ be a continuous map of topological spaces. Assume that (a) $Y$ is irreducible, (b) $f$ is open, and (c) there exists a dense collection of points $y \\in Y$ such that $f^{-1}(y)$ is irreducible. Then $X$ is irreducible. \n\n    \n]]. Hence we win. \n      $\\square$\n    \n"
382,0052,"instance NoetherianSpace.set [NoetherianSpace Î±] (s : Set Î±) : NoetherianSpace s :=
  IsInducing.subtypeVal.noetherianSpace
",Formal Proof of Stacks Project Tag 0052,(1),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/Topology/NoetherianSpace.lean#L76-L77,Q27041,,5.9.2,lemma,3.0,"['0050', '004C', '0ELQ']","\n  Lemma 5.9.2. Let $X$ be a Noetherian topological space. \n  \n  \nAny subset of $X$ with the induced topology is Noetherian. \n\n\nThe space $X$ has finitely many irreducible components. \n\n\nEach irreducible component of $X$ contains a nonempty open of $X$. \n\n\n\n\n    \n      Proof.\n      Let $T \\subset X$ be a subset of $X$. Let $T_1 \\supset T_2 \\supset \\ldots $ be a descending chain of closed subsets of $T$. Write $T_ i = T \\cap Z_ i$ with $Z_ i \\subset X$ closed. Consider the descending chain of closed subsets $Z_1 \\supset Z_1\\cap Z_2 \\supset Z_1 \\cap Z_2 \\cap Z_3 \\ldots $ This stabilizes by assumption and hence the original sequence of $T_ i$ stabilizes. Thus $T$ is Noetherian. \n    \n      Let $A$ be the set of closed subsets of $X$ which do not have finitely many irreducible components. Assume that $A$ is not empty to arrive at a contradiction. The set $A$ is partially ordered by inclusion: $\\alpha \\leq \\alpha \' \\Leftrightarrow Z_{\\alpha } \\subset Z_{\\alpha \'}$. By the descending chain condition we may find a smallest element of $A$, say $Z$. As $Z$ is not a finite union of irreducible components, it is not irreducible. Hence we can write $Z = Z\' \\cup Z\'\'$ and both are strictly smaller closed subsets. By construction $Z\' = \\bigcup Z\'_ i$ and $Z\'\' = \\bigcup Z\'\'_ j$ are finite unions of their irreducible components (Lemma 5.8.3). Hence $Z = \\bigcup Z\'_ i \\cup \\bigcup Z\'\'_ j$ is a finite union of irreducible closed subsets. After removing redundant members of this expression, this will be the decomposition of $Z$ into its irreducible components (Lemma 5.8.4), a contradiction. \n    \n      Let $Z \\subset X$ be an irreducible component of $X$. Let $Z_1, \\ldots , Z_ n$ be the other irreducible components of $X$. Consider $U = Z \\setminus (Z_1\\cup \\ldots \\cup Z_ n)$. This is not empty since otherwise the irreducible space $Z$ would be contained in one of the other $Z_ i$. Because $X = Z \\cup Z_1 \\cup \\ldots Z_ n$ (see Lemma 5.8.3), also $U = X \\setminus (Z_1\\cup \\ldots \\cup Z_ n)$ and hence open in $X$. Thus $Z$ contains a nonempty open of $X$. \n      $\\square$\n    \n",\n  Lemma 5.9.2. Let $X$ be a Noetherian topological space. \n  \n  \nAny subset of $X$ with the induced topology is Noetherian. \n\n\nThe space $X$ has finitely many irreducible components. \n\n\nEach irreducible component of $X$ contains a nonempty open of $X$. \n\n\n\n\n    \n,"Proof.\n      Let $T \\subset X$ be a subset of $X$. Let $T_1 \\supset T_2 \\supset \\ldots $ be a descending chain of closed subsets of $T$. Write $T_ i = T \\cap Z_ i$ with $Z_ i \\subset X$ closed. Consider the descending chain of closed subsets $Z_1 \\supset Z_1\\cap Z_2 \\supset Z_1 \\cap Z_2 \\cap Z_3 \\ldots $ This stabilizes by assumption and hence the original sequence of $T_ i$ stabilizes. Thus $T$ is Noetherian. \n    \n      Let $A$ be the set of closed subsets of $X$ which do not have finitely many irreducible components. Assume that $A$ is not empty to arrive at a contradiction. The set $A$ is partially ordered by inclusion: $\\alpha \\leq \\alpha \' \\Leftrightarrow Z_{\\alpha } \\subset Z_{\\alpha \'}$. By the descending chain condition we may find a smallest element of $A$, say $Z$. As $Z$ is not a finite union of irreducible components, it is not irreducible. Hence we can write $Z = Z\' \\cup Z\'\'$ and both are strictly smaller closed subsets. By construction $Z\' = \\bigcup Z\'_ i$ and $Z\'\' = \\bigcup Z\'\'_ j$ are finite unions of their irreducible components (Lemma 5.8.3). Hence $Z = \\bigcup Z\'_ i \\cup \\bigcup Z\'\'_ j$ is a finite union of irreducible closed subsets. After removing redundant members of this expression, this will be the decomposition of $Z$ into its irreducible components (Lemma 5.8.4), a contradiction. \n    \n      Let $Z \\subset X$ be an irreducible component of $X$. Let $Z_1, \\ldots , Z_ n$ be the other irreducible components of $X$. Consider $U = Z \\setminus (Z_1\\cup \\ldots \\cup Z_ n)$. This is not empty since otherwise the irreducible space $Z$ would be contained in one of the other $Z_ i$. Because $X = Z \\cup Z_1 \\cup \\ldots Z_ n$ (see Lemma 5.8.3), also $U = X \\setminus (Z_1\\cup \\ldots \\cup Z_ n)$ and hence open in $X$. Thus $Z$ contains a nonempty open of $X$. \n      $\\square$\n    \n","
  IsInducing.subtypeVal.noetherianSpace
",instance NoetherianSpace.set [NoetherianSpace Î±] (s : Set Î±) : NoetherianSpace s ,"Proof.\n      Let $T \\subset X$ be a subset of $X$. Let $T_1 \\supset T_2 \\supset \\ldots $ be a descending chain of closed subsets of $T$. Write $T_ i = T \\cap Z_ i$ with $Z_ i \\subset X$ closed. Consider the descending chain of closed subsets $Z_1 \\supset Z_1\\cap Z_2 \\supset Z_1 \\cap Z_2 \\cap Z_3 \\ldots $ This stabilizes by assumption and hence the original sequence of $T_ i$ stabilizes. Thus $T$ is Noetherian. \n    \n      Let $A$ be the set of closed subsets of $X$ which do not have finitely many irreducible components. Assume that $A$ is not empty to arrive at a contradiction. The set $A$ is partially ordered by inclusion: $\\alpha \\leq \\alpha \' \\Leftrightarrow Z_{\\alpha } \\subset Z_{\\alpha \'}$. By the descending chain condition we may find a smallest element of $A$, say $Z$. As $Z$ is not a finite union of irreducible components, it is not irreducible. Hence we can write $Z = Z\' \\cup Z\'\'$ and both are strictly smaller closed subsets. By construction $Z\' = \\bigcup Z\'_ i$ and $Z\'\' = \\bigcup Z\'\'_ j$ are finite unions of their irreducible components (Lemma 5.8.3 [[\n  Lemma 5.8.3. Let $X$ be a topological space. \n  \n  \nIf $T \\subset X$ is irreducible so is its closure in $X$. \n\n\nAny irreducible component of $X$ is closed. \n\n\nAny irreducible subset of $X$ is contained in an irreducible component of $X$. \n\n\nEvery point of $X$ is contained in some irreducible component of $X$, in other words, $X$ is the union of its irreducible components. \n\n\n\n\n    \n]]). Hence $Z = \\bigcup Z\'_ i \\cup \\bigcup Z\'\'_ j$ is a finite union of irreducible closed subsets. After removing redundant members of this expression, this will be the decomposition of $Z$ into its irreducible components (Lemma 5.8.4 [[\n  Lemma 5.8.4. Let $X$ be a topological space and suppose $X = \\bigcup _{i = 1, \\ldots , n} X_ i$ where each $X_ i$ is an irreducible closed subset of $X$ and no $X_ i$ is contained in the union of the other members. Then each $X_ i$ is an irreducible component of $X$ and each irreducible component of $X$ is one of the $X_ i$. \n\n    \n]]), a contradiction. \n    \n      Let $Z \\subset X$ be an irreducible component of $X$. Let $Z_1, \\ldots , Z_ n$ be the other irreducible components of $X$. Consider $U = Z \\setminus (Z_1\\cup \\ldots \\cup Z_ n)$. This is not empty since otherwise the irreducible space $Z$ would be contained in one of the other $Z_ i$. Because $X = Z \\cup Z_1 \\cup \\ldots Z_ n$ (see Lemma 5.8.3 [[\n  Lemma 5.8.3. Let $X$ be a topological space. \n  \n  \nIf $T \\subset X$ is irreducible so is its closure in $X$. \n\n\nAny irreducible component of $X$ is closed. \n\n\nAny irreducible subset of $X$ is contained in an irreducible component of $X$. \n\n\nEvery point of $X$ is contained in some irreducible component of $X$, in other words, $X$ is the union of its irreducible components. \n\n\n\n\n    \n]]), also $U = X \\setminus (Z_1\\cup \\ldots \\cup Z_ n)$ and hence open in $X$. Thus $Z$ contains a nonempty open of $X$. \n      $\\square$\n    \n"
383,0052,"theorem NoetherianSpace.finite_irreducibleComponents [NoetherianSpace Î±] :
    (irreducibleComponents Î±).Finite := by
  obtain âŸ¨S : Set (Set Î±), hSf, hSc, hSi, hSUâŸ© :=
    NoetherianSpace.exists_finite_set_isClosed_irreducible isClosed_univ (Î± := Î±)
  refine hSf.subset fun s hs => ?_
  lift S to Finset (Set Î±) using hSf
  rcases isIrreducible_iff_sUnion_isClosed.1 hs.1 S hSc (hSU â–¸ Set.subset_univ _) with âŸ¨t, htS, htâŸ©
  rwa [ht.antisymm (hs.2 (hSi _ htS) ht)]
",Formal Proof of Stacks Project Tag 0052,(2),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/Topology/NoetherianSpace.lean#L189-L196,Q27041,,5.9.2,lemma,3.0,"['0050', '004C', '0ELQ']","\n  Lemma 5.9.2. Let $X$ be a Noetherian topological space. \n  \n  \nAny subset of $X$ with the induced topology is Noetherian. \n\n\nThe space $X$ has finitely many irreducible components. \n\n\nEach irreducible component of $X$ contains a nonempty open of $X$. \n\n\n\n\n    \n      Proof.\n      Let $T \\subset X$ be a subset of $X$. Let $T_1 \\supset T_2 \\supset \\ldots $ be a descending chain of closed subsets of $T$. Write $T_ i = T \\cap Z_ i$ with $Z_ i \\subset X$ closed. Consider the descending chain of closed subsets $Z_1 \\supset Z_1\\cap Z_2 \\supset Z_1 \\cap Z_2 \\cap Z_3 \\ldots $ This stabilizes by assumption and hence the original sequence of $T_ i$ stabilizes. Thus $T$ is Noetherian. \n    \n      Let $A$ be the set of closed subsets of $X$ which do not have finitely many irreducible components. Assume that $A$ is not empty to arrive at a contradiction. The set $A$ is partially ordered by inclusion: $\\alpha \\leq \\alpha \' \\Leftrightarrow Z_{\\alpha } \\subset Z_{\\alpha \'}$. By the descending chain condition we may find a smallest element of $A$, say $Z$. As $Z$ is not a finite union of irreducible components, it is not irreducible. Hence we can write $Z = Z\' \\cup Z\'\'$ and both are strictly smaller closed subsets. By construction $Z\' = \\bigcup Z\'_ i$ and $Z\'\' = \\bigcup Z\'\'_ j$ are finite unions of their irreducible components (Lemma 5.8.3). Hence $Z = \\bigcup Z\'_ i \\cup \\bigcup Z\'\'_ j$ is a finite union of irreducible closed subsets. After removing redundant members of this expression, this will be the decomposition of $Z$ into its irreducible components (Lemma 5.8.4), a contradiction. \n    \n      Let $Z \\subset X$ be an irreducible component of $X$. Let $Z_1, \\ldots , Z_ n$ be the other irreducible components of $X$. Consider $U = Z \\setminus (Z_1\\cup \\ldots \\cup Z_ n)$. This is not empty since otherwise the irreducible space $Z$ would be contained in one of the other $Z_ i$. Because $X = Z \\cup Z_1 \\cup \\ldots Z_ n$ (see Lemma 5.8.3), also $U = X \\setminus (Z_1\\cup \\ldots \\cup Z_ n)$ and hence open in $X$. Thus $Z$ contains a nonempty open of $X$. \n      $\\square$\n    \n",\n  Lemma 5.9.2. Let $X$ be a Noetherian topological space. \n  \n  \nAny subset of $X$ with the induced topology is Noetherian. \n\n\nThe space $X$ has finitely many irreducible components. \n\n\nEach irreducible component of $X$ contains a nonempty open of $X$. \n\n\n\n\n    \n,"Proof.\n      Let $T \\subset X$ be a subset of $X$. Let $T_1 \\supset T_2 \\supset \\ldots $ be a descending chain of closed subsets of $T$. Write $T_ i = T \\cap Z_ i$ with $Z_ i \\subset X$ closed. Consider the descending chain of closed subsets $Z_1 \\supset Z_1\\cap Z_2 \\supset Z_1 \\cap Z_2 \\cap Z_3 \\ldots $ This stabilizes by assumption and hence the original sequence of $T_ i$ stabilizes. Thus $T$ is Noetherian. \n    \n      Let $A$ be the set of closed subsets of $X$ which do not have finitely many irreducible components. Assume that $A$ is not empty to arrive at a contradiction. The set $A$ is partially ordered by inclusion: $\\alpha \\leq \\alpha \' \\Leftrightarrow Z_{\\alpha } \\subset Z_{\\alpha \'}$. By the descending chain condition we may find a smallest element of $A$, say $Z$. As $Z$ is not a finite union of irreducible components, it is not irreducible. Hence we can write $Z = Z\' \\cup Z\'\'$ and both are strictly smaller closed subsets. By construction $Z\' = \\bigcup Z\'_ i$ and $Z\'\' = \\bigcup Z\'\'_ j$ are finite unions of their irreducible components (Lemma 5.8.3). Hence $Z = \\bigcup Z\'_ i \\cup \\bigcup Z\'\'_ j$ is a finite union of irreducible closed subsets. After removing redundant members of this expression, this will be the decomposition of $Z$ into its irreducible components (Lemma 5.8.4), a contradiction. \n    \n      Let $Z \\subset X$ be an irreducible component of $X$. Let $Z_1, \\ldots , Z_ n$ be the other irreducible components of $X$. Consider $U = Z \\setminus (Z_1\\cup \\ldots \\cup Z_ n)$. This is not empty since otherwise the irreducible space $Z$ would be contained in one of the other $Z_ i$. Because $X = Z \\cup Z_1 \\cup \\ldots Z_ n$ (see Lemma 5.8.3), also $U = X \\setminus (Z_1\\cup \\ldots \\cup Z_ n)$ and hence open in $X$. Thus $Z$ contains a nonempty open of $X$. \n      $\\square$\n    \n"," by
  obtain âŸ¨S : Set (Set Î±), hSf, hSc, hSi, hSUâŸ© :=
    NoetherianSpace.exists_finite_set_isClosed_irreducible isClosed_univ (Î± := Î±)
  refine hSf.subset fun s hs => ?_
  lift S to Finset (Set Î±) using hSf
  rcases isIrreducible_iff_sUnion_isClosed.1 hs.1 S hSc (hSU â–¸ Set.subset_univ _) with âŸ¨t, htS, htâŸ©
  rwa [ht.antisymm (hs.2 (hSi _ htS) ht)]
","theorem NoetherianSpace.finite_irreducibleComponents [NoetherianSpace Î±] :
    (irreducibleComponents Î±).Finite ","Proof.\n      Let $T \\subset X$ be a subset of $X$. Let $T_1 \\supset T_2 \\supset \\ldots $ be a descending chain of closed subsets of $T$. Write $T_ i = T \\cap Z_ i$ with $Z_ i \\subset X$ closed. Consider the descending chain of closed subsets $Z_1 \\supset Z_1\\cap Z_2 \\supset Z_1 \\cap Z_2 \\cap Z_3 \\ldots $ This stabilizes by assumption and hence the original sequence of $T_ i$ stabilizes. Thus $T$ is Noetherian. \n    \n      Let $A$ be the set of closed subsets of $X$ which do not have finitely many irreducible components. Assume that $A$ is not empty to arrive at a contradiction. The set $A$ is partially ordered by inclusion: $\\alpha \\leq \\alpha \' \\Leftrightarrow Z_{\\alpha } \\subset Z_{\\alpha \'}$. By the descending chain condition we may find a smallest element of $A$, say $Z$. As $Z$ is not a finite union of irreducible components, it is not irreducible. Hence we can write $Z = Z\' \\cup Z\'\'$ and both are strictly smaller closed subsets. By construction $Z\' = \\bigcup Z\'_ i$ and $Z\'\' = \\bigcup Z\'\'_ j$ are finite unions of their irreducible components (Lemma 5.8.3 [[\n  Lemma 5.8.3. Let $X$ be a topological space. \n  \n  \nIf $T \\subset X$ is irreducible so is its closure in $X$. \n\n\nAny irreducible component of $X$ is closed. \n\n\nAny irreducible subset of $X$ is contained in an irreducible component of $X$. \n\n\nEvery point of $X$ is contained in some irreducible component of $X$, in other words, $X$ is the union of its irreducible components. \n\n\n\n\n    \n]]). Hence $Z = \\bigcup Z\'_ i \\cup \\bigcup Z\'\'_ j$ is a finite union of irreducible closed subsets. After removing redundant members of this expression, this will be the decomposition of $Z$ into its irreducible components (Lemma 5.8.4 [[\n  Lemma 5.8.4. Let $X$ be a topological space and suppose $X = \\bigcup _{i = 1, \\ldots , n} X_ i$ where each $X_ i$ is an irreducible closed subset of $X$ and no $X_ i$ is contained in the union of the other members. Then each $X_ i$ is an irreducible component of $X$ and each irreducible component of $X$ is one of the $X_ i$. \n\n    \n]]), a contradiction. \n    \n      Let $Z \\subset X$ be an irreducible component of $X$. Let $Z_1, \\ldots , Z_ n$ be the other irreducible components of $X$. Consider $U = Z \\setminus (Z_1\\cup \\ldots \\cup Z_ n)$. This is not empty since otherwise the irreducible space $Z$ would be contained in one of the other $Z_ i$. Because $X = Z \\cup Z_1 \\cup \\ldots Z_ n$ (see Lemma 5.8.3 [[\n  Lemma 5.8.3. Let $X$ be a topological space. \n  \n  \nIf $T \\subset X$ is irreducible so is its closure in $X$. \n\n\nAny irreducible component of $X$ is closed. \n\n\nAny irreducible subset of $X$ is contained in an irreducible component of $X$. \n\n\nEvery point of $X$ is contained in some irreducible component of $X$, in other words, $X$ is the union of its irreducible components. \n\n\n\n\n    \n]]), also $U = X \\setminus (Z_1\\cup \\ldots \\cup Z_ n)$ and hence open in $X$. Thus $Z$ contains a nonempty open of $X$. \n      $\\square$\n    \n"
384,0052,"theorem NoetherianSpace.exists_isOpen_nonempty_subset_irreducibleComponent [NoetherianSpace Î±]
    (Z : Set Î±) (H : Z âˆˆ irreducibleComponents Î±) :
    âˆƒ o : Set Î±, IsOpen o âˆ§ o.Nonempty âˆ§ o âŠ† Z := by
  classical
  let Î¹ : Set (Set Î±) := irreducibleComponents Î± \ {Z}
  have hÎ¹ : Î¹.Finite := NoetherianSpace.finite_irreducibleComponents.subset Set.diff_subset
  have hÎ¹' : Finite Î¹ := hÎ¹
  let U := Z \ â‹ƒ x : Î¹, x
  have hU0 : U.Nonempty := Set.diff_nonempty.mpr fun r â†¦ by
    obtain âŸ¨Z', hZ'âŸ© := isIrreducible_iff_sUnion_isClosed.mp H.1 hÎ¹.toFinset
      (fun z hz â†¦ isClosed_of_mem_irreducibleComponents _ (hÎ¹.mem_toFinset.mp hz).1)
      (by rwa [hÎ¹.coe_toFinset, Set.sUnion_eq_iUnion])
    rw [Set.Finite.mem_toFinset] at hZ'
    exact hZ'.1.2 <| le_antisymm (H.2 hZ'.1.1.1 hZ'.2) hZ'.2
  have hU1 : U = (â‹ƒ x : Î¹, x)á¶œ := by
    rw [Set.compl_eq_univ_diff]
    refine le_antisymm (Set.diff_subset_diff le_top subset_rfl) ?_
    rw [â† Set.compl_eq_univ_diff]
    refine Set.compl_subset_iff_union.mpr (le_antisymm le_top ?_)
    rw [Set.union_comm, â† Set.sUnion_eq_iUnion, â† Set.sUnion_insert]
    rintro a -
    by_cases h : a âˆˆ U
    Â· exact âŸ¨U, Set.mem_insert _ _, hâŸ©
    Â· rw [Set.mem_diff, Decidable.not_and_iff_not_or_not, not_not, Set.mem_iUnion] at h
      rcases h with (h | âŸ¨i, hiâŸ©)
      Â· refine âŸ¨irreducibleComponent a, Or.inr ?_, mem_irreducibleComponentâŸ©
        simp only [Î¹, Set.mem_diff, Set.mem_singleton_iff]
        refine âŸ¨irreducibleComponent_mem_irreducibleComponents _, ?_âŸ©
        rintro rfl
        exact h mem_irreducibleComponent
      Â· exact âŸ¨i, Or.inr i.2, hiâŸ©
  refine âŸ¨U, hU1 â–¸ isOpen_compl_iff.mpr ?_, hU0, sdiff_leâŸ©
  exact isClosed_iUnion_of_finite fun i â†¦ isClosed_of_mem_irreducibleComponents i.1 i.2.1
",Formal Proof of Stacks Project Tag 0052,(3),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/Topology/NoetherianSpace.lean#L199-L231,Q27041,,5.9.2,lemma,3.0,"['0050', '004C', '0ELQ']","\n  Lemma 5.9.2. Let $X$ be a Noetherian topological space. \n  \n  \nAny subset of $X$ with the induced topology is Noetherian. \n\n\nThe space $X$ has finitely many irreducible components. \n\n\nEach irreducible component of $X$ contains a nonempty open of $X$. \n\n\n\n\n    \n      Proof.\n      Let $T \\subset X$ be a subset of $X$. Let $T_1 \\supset T_2 \\supset \\ldots $ be a descending chain of closed subsets of $T$. Write $T_ i = T \\cap Z_ i$ with $Z_ i \\subset X$ closed. Consider the descending chain of closed subsets $Z_1 \\supset Z_1\\cap Z_2 \\supset Z_1 \\cap Z_2 \\cap Z_3 \\ldots $ This stabilizes by assumption and hence the original sequence of $T_ i$ stabilizes. Thus $T$ is Noetherian. \n    \n      Let $A$ be the set of closed subsets of $X$ which do not have finitely many irreducible components. Assume that $A$ is not empty to arrive at a contradiction. The set $A$ is partially ordered by inclusion: $\\alpha \\leq \\alpha \' \\Leftrightarrow Z_{\\alpha } \\subset Z_{\\alpha \'}$. By the descending chain condition we may find a smallest element of $A$, say $Z$. As $Z$ is not a finite union of irreducible components, it is not irreducible. Hence we can write $Z = Z\' \\cup Z\'\'$ and both are strictly smaller closed subsets. By construction $Z\' = \\bigcup Z\'_ i$ and $Z\'\' = \\bigcup Z\'\'_ j$ are finite unions of their irreducible components (Lemma 5.8.3). Hence $Z = \\bigcup Z\'_ i \\cup \\bigcup Z\'\'_ j$ is a finite union of irreducible closed subsets. After removing redundant members of this expression, this will be the decomposition of $Z$ into its irreducible components (Lemma 5.8.4), a contradiction. \n    \n      Let $Z \\subset X$ be an irreducible component of $X$. Let $Z_1, \\ldots , Z_ n$ be the other irreducible components of $X$. Consider $U = Z \\setminus (Z_1\\cup \\ldots \\cup Z_ n)$. This is not empty since otherwise the irreducible space $Z$ would be contained in one of the other $Z_ i$. Because $X = Z \\cup Z_1 \\cup \\ldots Z_ n$ (see Lemma 5.8.3), also $U = X \\setminus (Z_1\\cup \\ldots \\cup Z_ n)$ and hence open in $X$. Thus $Z$ contains a nonempty open of $X$. \n      $\\square$\n    \n",\n  Lemma 5.9.2. Let $X$ be a Noetherian topological space. \n  \n  \nAny subset of $X$ with the induced topology is Noetherian. \n\n\nThe space $X$ has finitely many irreducible components. \n\n\nEach irreducible component of $X$ contains a nonempty open of $X$. \n\n\n\n\n    \n,"Proof.\n      Let $T \\subset X$ be a subset of $X$. Let $T_1 \\supset T_2 \\supset \\ldots $ be a descending chain of closed subsets of $T$. Write $T_ i = T \\cap Z_ i$ with $Z_ i \\subset X$ closed. Consider the descending chain of closed subsets $Z_1 \\supset Z_1\\cap Z_2 \\supset Z_1 \\cap Z_2 \\cap Z_3 \\ldots $ This stabilizes by assumption and hence the original sequence of $T_ i$ stabilizes. Thus $T$ is Noetherian. \n    \n      Let $A$ be the set of closed subsets of $X$ which do not have finitely many irreducible components. Assume that $A$ is not empty to arrive at a contradiction. The set $A$ is partially ordered by inclusion: $\\alpha \\leq \\alpha \' \\Leftrightarrow Z_{\\alpha } \\subset Z_{\\alpha \'}$. By the descending chain condition we may find a smallest element of $A$, say $Z$. As $Z$ is not a finite union of irreducible components, it is not irreducible. Hence we can write $Z = Z\' \\cup Z\'\'$ and both are strictly smaller closed subsets. By construction $Z\' = \\bigcup Z\'_ i$ and $Z\'\' = \\bigcup Z\'\'_ j$ are finite unions of their irreducible components (Lemma 5.8.3). Hence $Z = \\bigcup Z\'_ i \\cup \\bigcup Z\'\'_ j$ is a finite union of irreducible closed subsets. After removing redundant members of this expression, this will be the decomposition of $Z$ into its irreducible components (Lemma 5.8.4), a contradiction. \n    \n      Let $Z \\subset X$ be an irreducible component of $X$. Let $Z_1, \\ldots , Z_ n$ be the other irreducible components of $X$. Consider $U = Z \\setminus (Z_1\\cup \\ldots \\cup Z_ n)$. This is not empty since otherwise the irreducible space $Z$ would be contained in one of the other $Z_ i$. Because $X = Z \\cup Z_1 \\cup \\ldots Z_ n$ (see Lemma 5.8.3), also $U = X \\setminus (Z_1\\cup \\ldots \\cup Z_ n)$ and hence open in $X$. Thus $Z$ contains a nonempty open of $X$. \n      $\\square$\n    \n"," by
  classical
  let Î¹ : Set (Set Î±) := irreducibleComponents Î± \ {Z}
  have hÎ¹ : Î¹.Finite := NoetherianSpace.finite_irreducibleComponents.subset Set.diff_subset
  have hÎ¹' : Finite Î¹ := hÎ¹
  let U := Z \ â‹ƒ x : Î¹, x
  have hU0 : U.Nonempty := Set.diff_nonempty.mpr fun r â†¦ by
    obtain âŸ¨Z', hZ'âŸ© := isIrreducible_iff_sUnion_isClosed.mp H.1 hÎ¹.toFinset
      (fun z hz â†¦ isClosed_of_mem_irreducibleComponents _ (hÎ¹.mem_toFinset.mp hz).1)
      (by rwa [hÎ¹.coe_toFinset, Set.sUnion_eq_iUnion])
    rw [Set.Finite.mem_toFinset] at hZ'
    exact hZ'.1.2 <| le_antisymm (H.2 hZ'.1.1.1 hZ'.2) hZ'.2
  have hU1 : U = (â‹ƒ x : Î¹, x)á¶œ := by
    rw [Set.compl_eq_univ_diff]
    refine le_antisymm (Set.diff_subset_diff le_top subset_rfl) ?_
    rw [â† Set.compl_eq_univ_diff]
    refine Set.compl_subset_iff_union.mpr (le_antisymm le_top ?_)
    rw [Set.union_comm, â† Set.sUnion_eq_iUnion, â† Set.sUnion_insert]
    rintro a -
    by_cases h : a âˆˆ U
    Â· exact âŸ¨U, Set.mem_insert _ _, hâŸ©
    Â· rw [Set.mem_diff, Decidable.not_and_iff_not_or_not, not_not, Set.mem_iUnion] at h
      rcases h with (h | âŸ¨i, hiâŸ©)
      Â· refine âŸ¨irreducibleComponent a, Or.inr ?_, mem_irreducibleComponentâŸ©
        simp only [Î¹, Set.mem_diff, Set.mem_singleton_iff]
        refine âŸ¨irreducibleComponent_mem_irreducibleComponents _, ?_âŸ©
        rintro rfl
        exact h mem_irreducibleComponent
      Â· exact âŸ¨i, Or.inr i.2, hiâŸ©
  refine âŸ¨U, hU1 â–¸ isOpen_compl_iff.mpr ?_, hU0, sdiff_leâŸ©
  exact isClosed_iUnion_of_finite fun i â†¦ isClosed_of_mem_irreducibleComponents i.1 i.2.1
","theorem NoetherianSpace.exists_isOpen_nonempty_subset_irreducibleComponent [NoetherianSpace Î±]
    (Z : Set Î±) (H : Z âˆˆ irreducibleComponents Î±) :
    âˆƒ o : Set Î±, IsOpen o âˆ§ o.Nonempty âˆ§ o âŠ† Z ","Proof.\n      Let $T \\subset X$ be a subset of $X$. Let $T_1 \\supset T_2 \\supset \\ldots $ be a descending chain of closed subsets of $T$. Write $T_ i = T \\cap Z_ i$ with $Z_ i \\subset X$ closed. Consider the descending chain of closed subsets $Z_1 \\supset Z_1\\cap Z_2 \\supset Z_1 \\cap Z_2 \\cap Z_3 \\ldots $ This stabilizes by assumption and hence the original sequence of $T_ i$ stabilizes. Thus $T$ is Noetherian. \n    \n      Let $A$ be the set of closed subsets of $X$ which do not have finitely many irreducible components. Assume that $A$ is not empty to arrive at a contradiction. The set $A$ is partially ordered by inclusion: $\\alpha \\leq \\alpha \' \\Leftrightarrow Z_{\\alpha } \\subset Z_{\\alpha \'}$. By the descending chain condition we may find a smallest element of $A$, say $Z$. As $Z$ is not a finite union of irreducible components, it is not irreducible. Hence we can write $Z = Z\' \\cup Z\'\'$ and both are strictly smaller closed subsets. By construction $Z\' = \\bigcup Z\'_ i$ and $Z\'\' = \\bigcup Z\'\'_ j$ are finite unions of their irreducible components (Lemma 5.8.3 [[\n  Lemma 5.8.3. Let $X$ be a topological space. \n  \n  \nIf $T \\subset X$ is irreducible so is its closure in $X$. \n\n\nAny irreducible component of $X$ is closed. \n\n\nAny irreducible subset of $X$ is contained in an irreducible component of $X$. \n\n\nEvery point of $X$ is contained in some irreducible component of $X$, in other words, $X$ is the union of its irreducible components. \n\n\n\n\n    \n]]). Hence $Z = \\bigcup Z\'_ i \\cup \\bigcup Z\'\'_ j$ is a finite union of irreducible closed subsets. After removing redundant members of this expression, this will be the decomposition of $Z$ into its irreducible components (Lemma 5.8.4 [[\n  Lemma 5.8.4. Let $X$ be a topological space and suppose $X = \\bigcup _{i = 1, \\ldots , n} X_ i$ where each $X_ i$ is an irreducible closed subset of $X$ and no $X_ i$ is contained in the union of the other members. Then each $X_ i$ is an irreducible component of $X$ and each irreducible component of $X$ is one of the $X_ i$. \n\n    \n]]), a contradiction. \n    \n      Let $Z \\subset X$ be an irreducible component of $X$. Let $Z_1, \\ldots , Z_ n$ be the other irreducible components of $X$. Consider $U = Z \\setminus (Z_1\\cup \\ldots \\cup Z_ n)$. This is not empty since otherwise the irreducible space $Z$ would be contained in one of the other $Z_ i$. Because $X = Z \\cup Z_1 \\cup \\ldots Z_ n$ (see Lemma 5.8.3 [[\n  Lemma 5.8.3. Let $X$ be a topological space. \n  \n  \nIf $T \\subset X$ is irreducible so is its closure in $X$. \n\n\nAny irreducible component of $X$ is closed. \n\n\nAny irreducible subset of $X$ is contained in an irreducible component of $X$. \n\n\nEvery point of $X$ is contained in some irreducible component of $X$, in other words, $X$ is the union of its irreducible components. \n\n\n\n\n    \n]]), also $U = X \\setminus (Z_1\\cup \\ldots \\cup Z_ n)$ and hence open in $X$. Thus $Z$ contains a nonempty open of $X$. \n      $\\square$\n    \n"
385,004X,"def IsGenericPoint (x : Î±) (S : Set Î±) : Prop :=
  closure ({x} : Set Î±) = S
",Formal Proof of Stacks Project Tag 004X,(1),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/Topology/Sober.lean#L39-L40,Q27041,,5.8.6,definition,3.0,"['004U', '004C', '0ELQ']","\n  Definition 5.8.6. Let $X$ be a topological space. \n  \n  \nLet $Z \\subset X$ be an irreducible closed subset. A generic point of $Z$ is a point $\\xi \\in Z$ such that $Z = \\overline{\\{ \\xi \\} }$. \n\n\nThe space $X$ is called Kolmogorov, if for every $x, x\' \\in X$, $x \\not= x\'$ there exists a closed subset of $X$ which contains exactly one of the two points. \n\n\nThe space $X$ is called quasi-sober if every irreducible closed subset has a generic point. \n\n\nThe space $X$ is called sober if every irreducible closed subset has a unique generic point. \n\n\n\n","\n  Definition 5.8.6. Let $X$ be a topological space. \n  \n  \nLet $Z \\subset X$ be an irreducible closed subset. A generic point of $Z$ is a point $\\xi \\in Z$ such that $Z = \\overline{\\{ \\xi \\} }$. \n\n\nThe space $X$ is called Kolmogorov, if for every $x, x\' \\in X$, $x \\not= x\'$ there exists a closed subset of $X$ which contains exactly one of the two points. \n\n\nThe space $X$ is called quasi-sober if every irreducible closed subset has a generic point. \n\n\nThe space $X$ is called sober if every irreducible closed subset has a unique generic point. \n\n\n\n",,"
  closure ({x} : Set Î±) = S
",def IsGenericPoint (x : Î±) (S : Set Î±) : Prop ,
386,0900,"def CompHaus.toProfiniteObj (X : CompHaus.{u}) : Profinite.{u} where
  toTop := TopCat.of (ConnectedComponents X)
  is_compact := Quotient.compactSpace
  is_hausdorff := ConnectedComponents.t2
  prop := ConnectedComponents.totallyDisconnectedSpace
",Formal Proof of Stacks Project Tag 0900,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/Topology/Category/Profinite/Basic.lean#L97-L101,Q27041,,5.22.5,lemma,3.0,"['08ZW', '004C', '0ELQ']","\n  Lemma 5.22.5. Let $X$ be a topological space. If $X$ is quasi-compact and every connected component of $X$ is the intersection of the open and closed subsets containing it, then $\\pi _0(X)$ is a profinite space. \n\n    \n      Proof.\n      We will use Lemma 5.22.2 to prove this. Since $\\pi _0(X)$ is the image of a quasi-compact space it is quasi-compact (Lemma 5.12.7). It is totally disconnected by construction (Lemma 5.7.9). Let $C, D \\subset X$ be distinct connected components of $X$. Write $C = \\bigcap U_\\alpha $ as the intersection of the open and closed subsets of $X$ containing $C$. Any finite intersection of $U_\\alpha $\'s is another. Since $\\bigcap U_\\alpha \\cap D = \\emptyset $ we conclude that $U_\\alpha \\cap D = \\emptyset $ for some $\\alpha $ (use Lemmas 5.7.3, 5.12.3 and 5.12.6) Since $U_\\alpha $ is open and closed, it is the union of the connected components it contains, i.e., $U_\\alpha $ is the inverse image of some open and closed subset $V_\\alpha \\subset \\pi _0(X)$. This proves that the points corresponding to $C$ and $D$ are contained in disjoint open subsets, i.e., $\\pi _0(X)$ is Hausdorff. \n      $\\square$\n    \n","\n  Lemma 5.22.5. Let $X$ be a topological space. If $X$ is quasi-compact and every connected component of $X$ is the intersection of the open and closed subsets containing it, then $\\pi _0(X)$ is a profinite space. \n\n    \n","Proof.\n      We will use Lemma 5.22.2 to prove this. Since $\\pi _0(X)$ is the image of a quasi-compact space it is quasi-compact (Lemma 5.12.7). It is totally disconnected by construction (Lemma 5.7.9). Let $C, D \\subset X$ be distinct connected components of $X$. Write $C = \\bigcap U_\\alpha $ as the intersection of the open and closed subsets of $X$ containing $C$. Any finite intersection of $U_\\alpha $\'s is another. Since $\\bigcap U_\\alpha \\cap D = \\emptyset $ we conclude that $U_\\alpha \\cap D = \\emptyset $ for some $\\alpha $ (use Lemmas 5.7.3, 5.12.3 and 5.12.6) Since $U_\\alpha $ is open and closed, it is the union of the connected components it contains, i.e., $U_\\alpha $ is the inverse image of some open and closed subset $V_\\alpha \\subset \\pi _0(X)$. This proves that the points corresponding to $C$ and $D$ are contained in disjoint open subsets, i.e., $\\pi _0(X)$ is Hausdorff. \n      $\\square$\n    \n"," TopCat.of (ConnectedComponents X)
  is_compact := Quotient.compactSpace
  is_hausdorff := ConnectedComponents.t2
  prop := ConnectedComponents.totallyDisconnectedSpace
","def CompHaus.toProfiniteObj (X : CompHaus.{u}) : Profinite.{u} where
  toTop ","Proof.\n      We will use Lemma 5.22.2 [[\n  Lemma 5.22.2. Let $X$ be a topological space. The following are equivalent \n  \n  \n$X$ is a profinite space, and \n\n\n$X$ is Hausdorff, quasi-compact, and totally disconnected. \n\n\n\n   If this is true, then $X$ is a cofiltered limit of finite discrete spaces. \n\n    \n]] to prove this. Since $\\pi _0(X)$ is the image of a quasi-compact space it is quasi-compact (Lemma 5.12.7 [[\n  Lemma 5.12.7. Let $f : X \\to Y$ be a continuous map of topological spaces. \n  \n  \nIf $X$ is quasi-compact, then $f(X)$ is quasi-compact. \n\n\nIf $f$ is quasi-compact, then $f(X)$ is retrocompact. \n\n\n\n\n    \n]]). It is totally disconnected by construction (Lemma 5.7.9 [[\n  Lemma 5.7.9. Let $X$ be a topological space. Let $\\pi _0(X)$ be the set of connected components of $X$. Let $X \\to \\pi _0(X)$ be the map which sends $x \\in X$ to the connected component of $X$ passing through $x$. Endow $\\pi _0(X)$ with the quotient topology. Then $\\pi _0(X)$ is a totally disconnected space and any continuous map $X \\to Y$ from $X$ to a totally disconnected space $Y$ factors through $\\pi _0(X)$. \n\n    \n]]). Let $C, D \\subset X$ be distinct connected components of $X$. Write $C = \\bigcap U_\\alpha $ as the intersection of the open and closed subsets of $X$ containing $C$. Any finite intersection of $U_\\alpha $\'s is another. Since $\\bigcap U_\\alpha \\cap D = \\emptyset $ we conclude that $U_\\alpha \\cap D = \\emptyset $ for some $\\alpha $ (use Lemmas 5.7.3 [[\n  Lemma 5.7.3. Let $X$ be a topological space. \n  \n  \nIf $T \\subset X$ is connected, then so is its closure. \n\n\nAny connected component of $X$ is closed (but not necessarily open). \n\n\nEvery connected subset of $X$ is contained in a unique connected component of $X$. \n\n\nEvery point of $X$ is contained in a unique connected component, in other words, $X$ is the disjoint union of its connected components. \n\n\n\n\n    \n]], 5.12.3 [[\n  Lemma 5.12.3. A closed subset of a quasi-compact topological space is quasi-compact. \n\n    \n]] and 5.12.6 [[\n  Lemma 5.12.6. Let $X$ be a quasi-compact topological space. If $\\{ Z_\\alpha \\} _{\\alpha \\in A}$ is a collection of closed subsets such that the intersection of each finite subcollection is nonempty, then $\\bigcap _{\\alpha \\in A} Z_\\alpha $ is nonempty. \n\n    \n]]) Since $U_\\alpha $ is open and closed, it is the union of the connected components it contains, i.e., $U_\\alpha $ is the inverse image of some open and closed subset $V_\\alpha \\subset \\pi _0(X)$. This proves that the points corresponding to $C$ and $D$ are contained in disjoint open subsets, i.e., $\\pi _0(X)$ is Hausdorff. \n      $\\square$\n    \n"
387,004X,"class T0Space (X : Type u) [TopologicalSpace X] : Prop where
  /-- Two inseparable points in a Tâ‚€ space are equal. -/
  t0 : âˆ€ â¦ƒx y : Xâ¦„, Inseparable x y â†’ x = y
",Formal Proof of Stacks Project Tag 004X,(2),https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/Topology/Separation/Basic.lean#L77-L79,Q27041,,5.8.6,definition,3.0,"['004U', '004C', '0ELQ']","\n  Definition 5.8.6. Let $X$ be a topological space. \n  \n  \nLet $Z \\subset X$ be an irreducible closed subset. A generic point of $Z$ is a point $\\xi \\in Z$ such that $Z = \\overline{\\{ \\xi \\} }$. \n\n\nThe space $X$ is called Kolmogorov, if for every $x, x\' \\in X$, $x \\not= x\'$ there exists a closed subset of $X$ which contains exactly one of the two points. \n\n\nThe space $X$ is called quasi-sober if every irreducible closed subset has a generic point. \n\n\nThe space $X$ is called sober if every irreducible closed subset has a unique generic point. \n\n\n\n","\n  Definition 5.8.6. Let $X$ be a topological space. \n  \n  \nLet $Z \\subset X$ be an irreducible closed subset. A generic point of $Z$ is a point $\\xi \\in Z$ such that $Z = \\overline{\\{ \\xi \\} }$. \n\n\nThe space $X$ is called Kolmogorov, if for every $x, x\' \\in X$, $x \\not= x\'$ there exists a closed subset of $X$ which contains exactly one of the two points. \n\n\nThe space $X$ is called quasi-sober if every irreducible closed subset has a generic point. \n\n\nThe space $X$ is called sober if every irreducible closed subset has a unique generic point. \n\n\n\n",,,"class T0Space (X : Type u) [TopologicalSpace X] : Prop where
  /-- Two inseparable points in a Tâ‚€ space are equal. -/
  t0 : âˆ€ â¦ƒx y : Xâ¦„, Inseparable x y â†’ x = y
",
388,0B31,"instance Subtype.t0Space [T0Space X] {p : X â†’ Prop} : T0Space (Subtype p) :=
  IsEmbedding.subtypeVal.t0Space
",Formal Proof of Stacks Project Tag 0B31,part 1,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/Topology/Separation/Basic.lean#L225-L226,Q27041,,5.8.7,lemma,3.0,"['004U', '004C', '0ELQ']","\n  Lemma 5.8.7. Let $X$ be a topological space and let $Y\\subset X$. \n  \n  \nIf $X$ is Kolmogorov then so is $Y$. \n\n\nSuppose $Y$ is locally closed in $X$. If $X$ is quasi-sober then so is $Y$. \n\n\nSuppose $Y$ is locally closed in $X$. If $X$ is sober then so is $Y$. \n\n\n\n\n    \n      Proof.\n      Proof of (1). Suppose $X$ is Kolmogorov. Let $x,y\\in Y$ with $x\\neq y$. Then $\\overline{\\overline{\\{ x\\} }\\cap Y}=\\overline{\\{ x\\} }\\neq \\overline{\\{ y\\} }= \\overline{\\overline{\\{ y\\} }\\cap Y}$. Hence $\\overline{\\{ x\\} }\\cap Y\\neq \\overline{\\{ y\\} }\\cap Y$. This shows that $Y$ is Kolmogorov. \n    \n      Proof of (2). Suppose $X$ is quasi-sober. It suffices to consider the cases $Y$ is closed and $Y$ is open. First, suppose $Y$ is closed. Let $Z$ be an irreducible closed subset of $Y$. Then $Z$ is an irreducible closed subset of $X$. Hence there exists $x \\in Z$ with $\\overline{\\{ x\\} } = Z$. It follows $\\overline{\\{ x\\} } \\cap Y = Z$. This shows $Y$ is quasi-sober. Second, suppose $Y$ is open. Let $Z$ be an irreducible closed subset of $Y$. Then $\\overline{Z}$ is an irreducible closed subset of $X$. Hence there exists $x \\in \\overline{Z}$ with $\\overline{\\{ x\\} }=\\overline{Z}$. If $x\\notin Y$ we get the contradiction $Z=Z\\cap Y\\subset \\overline{Z}\\cap Y=\\overline{\\{ x\\} }\\cap Y=\\emptyset $. Therefore $x\\in Y$. It follows $Z=\\overline{Z}\\cap Y=\\overline{\\{ x\\} }\\cap Y$. This shows $Y$ is quasi-sober. \n    \n      Proof of (3). Immediately from (1) and (2). \n      $\\square$\n    \n",\n  Lemma 5.8.7. Let $X$ be a topological space and let $Y\\subset X$. \n  \n  \nIf $X$ is Kolmogorov then so is $Y$. \n\n\nSuppose $Y$ is locally closed in $X$. If $X$ is quasi-sober then so is $Y$. \n\n\nSuppose $Y$ is locally closed in $X$. If $X$ is sober then so is $Y$. \n\n\n\n\n    \n,"Proof.\n      Proof of (1). Suppose $X$ is Kolmogorov. Let $x,y\\in Y$ with $x\\neq y$. Then $\\overline{\\overline{\\{ x\\} }\\cap Y}=\\overline{\\{ x\\} }\\neq \\overline{\\{ y\\} }= \\overline{\\overline{\\{ y\\} }\\cap Y}$. Hence $\\overline{\\{ x\\} }\\cap Y\\neq \\overline{\\{ y\\} }\\cap Y$. This shows that $Y$ is Kolmogorov. \n    \n      Proof of (2). Suppose $X$ is quasi-sober. It suffices to consider the cases $Y$ is closed and $Y$ is open. First, suppose $Y$ is closed. Let $Z$ be an irreducible closed subset of $Y$. Then $Z$ is an irreducible closed subset of $X$. Hence there exists $x \\in Z$ with $\\overline{\\{ x\\} } = Z$. It follows $\\overline{\\{ x\\} } \\cap Y = Z$. This shows $Y$ is quasi-sober. Second, suppose $Y$ is open. Let $Z$ be an irreducible closed subset of $Y$. Then $\\overline{Z}$ is an irreducible closed subset of $X$. Hence there exists $x \\in \\overline{Z}$ with $\\overline{\\{ x\\} }=\\overline{Z}$. If $x\\notin Y$ we get the contradiction $Z=Z\\cap Y\\subset \\overline{Z}\\cap Y=\\overline{\\{ x\\} }\\cap Y=\\emptyset $. Therefore $x\\in Y$. It follows $Z=\\overline{Z}\\cap Y=\\overline{\\{ x\\} }\\cap Y$. This shows $Y$ is quasi-sober. \n    \n      Proof of (3). Immediately from (1) and (2). \n      $\\square$\n    \n","
  IsEmbedding.subtypeVal.t0Space
",instance Subtype.t0Space [T0Space X] {p : X â†’ Prop} : T0Space (Subtype p) ,"Proof.\n      Proof of (1). Suppose $X$ is Kolmogorov. Let $x,y\\in Y$ with $x\\neq y$. Then $\\overline{\\overline{\\{ x\\} }\\cap Y}=\\overline{\\{ x\\} }\\neq \\overline{\\{ y\\} }= \\overline{\\overline{\\{ y\\} }\\cap Y}$. Hence $\\overline{\\{ x\\} }\\cap Y\\neq \\overline{\\{ y\\} }\\cap Y$. This shows that $Y$ is Kolmogorov. \n    \n      Proof of (2). Suppose $X$ is quasi-sober. It suffices to consider the cases $Y$ is closed and $Y$ is open. First, suppose $Y$ is closed. Let $Z$ be an irreducible closed subset of $Y$. Then $Z$ is an irreducible closed subset of $X$. Hence there exists $x \\in Z$ with $\\overline{\\{ x\\} } = Z$. It follows $\\overline{\\{ x\\} } \\cap Y = Z$. This shows $Y$ is quasi-sober. Second, suppose $Y$ is open. Let $Z$ be an irreducible closed subset of $Y$. Then $\\overline{Z}$ is an irreducible closed subset of $X$. Hence there exists $x \\in \\overline{Z}$ with $\\overline{\\{ x\\} }=\\overline{Z}$. If $x\\notin Y$ we get the contradiction $Z=Z\\cap Y\\subset \\overline{Z}\\cap Y=\\overline{\\{ x\\} }\\cap Y=\\emptyset $. Therefore $x\\in Y$. It follows $Z=\\overline{Z}\\cap Y=\\overline{\\{ x\\} }\\cap Y$. This shows $Y$ is quasi-sober. \n    \n      Proof of (3). Immediately from (1) and (2). \n      $\\square$\n    \n"
389,0900,"instance ConnectedComponents.t2 [T2Space X] [CompactSpace X] : T2Space (ConnectedComponents X) := by
  -- Fix 2 distinct connected components, with points a and b
  refine âŸ¨ConnectedComponents.surjective_coe.forallâ‚‚.2 fun a b ne => ?_âŸ©
  rw [ConnectedComponents.coe_ne_coe] at ne
  have h := connectedComponent_disjoint ne
  -- write â†‘b as the intersection of all clopen subsets containing it
  rw [connectedComponent_eq_iInter_isClopen b, disjoint_iff_inter_eq_empty] at h
  -- Now we show that this can be reduced to some clopen containing `â†‘b` being disjoint to `â†‘a`
  obtain âŸ¨U, V, hU, ha, hb, rflâŸ© : âˆƒ (U : Set X) (V : Set (ConnectedComponents X)),
      IsClopen U âˆ§ connectedComponent a âˆ© U = âˆ… âˆ§ connectedComponent b âŠ† U âˆ§ (â†‘) â»Â¹' V = U := by
    have h :=
      (isClosed_connectedComponent (Î± := X)).isCompact.elim_finite_subfamily_closed
        _ (fun s : { s : Set X // IsClopen s âˆ§ b âˆˆ s } => s.2.1.1) h
    obtain âŸ¨fin_a, haâŸ© := h
    -- This clopen and its complement will separate the connected components of `a` and `b`
    set U : Set X := â‹‚ (i : { s // IsClopen s âˆ§ b âˆˆ s }) (_ : i âˆˆ fin_a), i
    have hU : IsClopen U := isClopen_biInter_finset fun i _ => i.2.1
    exact âŸ¨U, (â†‘) '' U, hU, ha, subset_iInterâ‚‚ fun s _ => s.2.1.connectedComponent_subset s.2.2,
      (connectedComponents_preimage_image U).symm â–¸ hU.biUnion_connectedComponent_eqâŸ©
  rw [ConnectedComponents.isQuotientMap_coe.isClopen_preimage] at hU
  refine âŸ¨Vá¶œ, V, hU.compl.isOpen, hU.isOpen, ?_, hb mem_connectedComponent, disjoint_compl_leftâŸ©
  exact fun h => flip Set.Nonempty.ne_empty ha âŸ¨a, mem_connectedComponent, hâŸ©
",Formal Proof of Stacks Project Tag 0900,The Stacks entry proves profiniteness.,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/Topology/Separation/Regular.lean#L758,Q27041,,5.22.5,lemma,3.0,"['08ZW', '004C', '0ELQ']","\n  Lemma 5.22.5. Let $X$ be a topological space. If $X$ is quasi-compact and every connected component of $X$ is the intersection of the open and closed subsets containing it, then $\\pi _0(X)$ is a profinite space. \n\n    \n      Proof.\n      We will use Lemma 5.22.2 to prove this. Since $\\pi _0(X)$ is the image of a quasi-compact space it is quasi-compact (Lemma 5.12.7). It is totally disconnected by construction (Lemma 5.7.9). Let $C, D \\subset X$ be distinct connected components of $X$. Write $C = \\bigcap U_\\alpha $ as the intersection of the open and closed subsets of $X$ containing $C$. Any finite intersection of $U_\\alpha $\'s is another. Since $\\bigcap U_\\alpha \\cap D = \\emptyset $ we conclude that $U_\\alpha \\cap D = \\emptyset $ for some $\\alpha $ (use Lemmas 5.7.3, 5.12.3 and 5.12.6) Since $U_\\alpha $ is open and closed, it is the union of the connected components it contains, i.e., $U_\\alpha $ is the inverse image of some open and closed subset $V_\\alpha \\subset \\pi _0(X)$. This proves that the points corresponding to $C$ and $D$ are contained in disjoint open subsets, i.e., $\\pi _0(X)$ is Hausdorff. \n      $\\square$\n    \n","\n  Lemma 5.22.5. Let $X$ be a topological space. If $X$ is quasi-compact and every connected component of $X$ is the intersection of the open and closed subsets containing it, then $\\pi _0(X)$ is a profinite space. \n\n    \n","Proof.\n      We will use Lemma 5.22.2 to prove this. Since $\\pi _0(X)$ is the image of a quasi-compact space it is quasi-compact (Lemma 5.12.7). It is totally disconnected by construction (Lemma 5.7.9). Let $C, D \\subset X$ be distinct connected components of $X$. Write $C = \\bigcap U_\\alpha $ as the intersection of the open and closed subsets of $X$ containing $C$. Any finite intersection of $U_\\alpha $\'s is another. Since $\\bigcap U_\\alpha \\cap D = \\emptyset $ we conclude that $U_\\alpha \\cap D = \\emptyset $ for some $\\alpha $ (use Lemmas 5.7.3, 5.12.3 and 5.12.6) Since $U_\\alpha $ is open and closed, it is the union of the connected components it contains, i.e., $U_\\alpha $ is the inverse image of some open and closed subset $V_\\alpha \\subset \\pi _0(X)$. This proves that the points corresponding to $C$ and $D$ are contained in disjoint open subsets, i.e., $\\pi _0(X)$ is Hausdorff. \n      $\\square$\n    \n"," by
  -- Fix 2 distinct connected components, with points a and b
  refine âŸ¨ConnectedComponents.surjective_coe.forallâ‚‚.2 fun a b ne => ?_âŸ©
  rw [ConnectedComponents.coe_ne_coe] at ne
  have h := connectedComponent_disjoint ne
  -- write â†‘b as the intersection of all clopen subsets containing it
  rw [connectedComponent_eq_iInter_isClopen b, disjoint_iff_inter_eq_empty] at h
  -- Now we show that this can be reduced to some clopen containing `â†‘b` being disjoint to `â†‘a`
  obtain âŸ¨U, V, hU, ha, hb, rflâŸ© : âˆƒ (U : Set X) (V : Set (ConnectedComponents X)),
      IsClopen U âˆ§ connectedComponent a âˆ© U = âˆ… âˆ§ connectedComponent b âŠ† U âˆ§ (â†‘) â»Â¹' V = U := by
    have h :=
      (isClosed_connectedComponent (Î± := X)).isCompact.elim_finite_subfamily_closed
        _ (fun s : { s : Set X // IsClopen s âˆ§ b âˆˆ s } => s.2.1.1) h
    obtain âŸ¨fin_a, haâŸ© := h
    -- This clopen and its complement will separate the connected components of `a` and `b`
    set U : Set X := â‹‚ (i : { s // IsClopen s âˆ§ b âˆˆ s }) (_ : i âˆˆ fin_a), i
    have hU : IsClopen U := isClopen_biInter_finset fun i _ => i.2.1
    exact âŸ¨U, (â†‘) '' U, hU, ha, subset_iInterâ‚‚ fun s _ => s.2.1.connectedComponent_subset s.2.2,
      (connectedComponents_preimage_image U).symm â–¸ hU.biUnion_connectedComponent_eqâŸ©
  rw [ConnectedComponents.isQuotientMap_coe.isClopen_preimage] at hU
  refine âŸ¨Vá¶œ, V, hU.compl.isOpen, hU.isOpen, ?_, hb mem_connectedComponent, disjoint_compl_leftâŸ©
  exact fun h => flip Set.Nonempty.ne_empty ha âŸ¨a, mem_connectedComponent, hâŸ©
",instance ConnectedComponents.t2 [T2Space X] [CompactSpace X] : T2Space (ConnectedComponents X) ,"Proof.\n      We will use Lemma 5.22.2 [[\n  Lemma 5.22.2. Let $X$ be a topological space. The following are equivalent \n  \n  \n$X$ is a profinite space, and \n\n\n$X$ is Hausdorff, quasi-compact, and totally disconnected. \n\n\n\n   If this is true, then $X$ is a cofiltered limit of finite discrete spaces. \n\n    \n]] to prove this. Since $\\pi _0(X)$ is the image of a quasi-compact space it is quasi-compact (Lemma 5.12.7 [[\n  Lemma 5.12.7. Let $f : X \\to Y$ be a continuous map of topological spaces. \n  \n  \nIf $X$ is quasi-compact, then $f(X)$ is quasi-compact. \n\n\nIf $f$ is quasi-compact, then $f(X)$ is retrocompact. \n\n\n\n\n    \n]]). It is totally disconnected by construction (Lemma 5.7.9 [[\n  Lemma 5.7.9. Let $X$ be a topological space. Let $\\pi _0(X)$ be the set of connected components of $X$. Let $X \\to \\pi _0(X)$ be the map which sends $x \\in X$ to the connected component of $X$ passing through $x$. Endow $\\pi _0(X)$ with the quotient topology. Then $\\pi _0(X)$ is a totally disconnected space and any continuous map $X \\to Y$ from $X$ to a totally disconnected space $Y$ factors through $\\pi _0(X)$. \n\n    \n]]). Let $C, D \\subset X$ be distinct connected components of $X$. Write $C = \\bigcap U_\\alpha $ as the intersection of the open and closed subsets of $X$ containing $C$. Any finite intersection of $U_\\alpha $\'s is another. Since $\\bigcap U_\\alpha \\cap D = \\emptyset $ we conclude that $U_\\alpha \\cap D = \\emptyset $ for some $\\alpha $ (use Lemmas 5.7.3 [[\n  Lemma 5.7.3. Let $X$ be a topological space. \n  \n  \nIf $T \\subset X$ is connected, then so is its closure. \n\n\nAny connected component of $X$ is closed (but not necessarily open). \n\n\nEvery connected subset of $X$ is contained in a unique connected component of $X$. \n\n\nEvery point of $X$ is contained in a unique connected component, in other words, $X$ is the disjoint union of its connected components. \n\n\n\n\n    \n]], 5.12.3 [[\n  Lemma 5.12.3. A closed subset of a quasi-compact topological space is quasi-compact. \n\n    \n]] and 5.12.6 [[\n  Lemma 5.12.6. Let $X$ be a quasi-compact topological space. If $\\{ Z_\\alpha \\} _{\\alpha \\in A}$ is a collection of closed subsets such that the intersection of each finite subcollection is nonempty, then $\\bigcap _{\\alpha \\in A} Z_\\alpha $ is nonempty. \n\n    \n]]) Since $U_\\alpha $ is open and closed, it is the union of the connected components it contains, i.e., $U_\\alpha $ is the inverse image of some open and closed subset $V_\\alpha \\subset \\pi _0(X)$. This proves that the points corresponding to $C$ and $D$ are contained in disjoint open subsets, i.e., $\\pi _0(X)$ is Hausdorff. \n      $\\square$\n    \n"
390,0073,"theorem isSheaf_iff_isSheaf_comp' {C : Type uâ‚} [Category.{vâ‚} C] {D : Type uâ‚‚} [Category.{vâ‚‚} D]
    (G : C â¥¤ D) [G.ReflectsIsomorphisms] [HasLimitsOfSize.{v, v} C] [PreservesLimitsOfSize.{v, v} G]
    {X : TopCat.{v}} (F : Presheaf C X) : Presheaf.IsSheaf F â†” Presheaf.IsSheaf (F â‹™ G) :=
  Presheaf.isSheaf_iff_isSheaf_comp _ F G
",Formal Proof of Stacks Project Tag 0073,In fact we prove a stronger version with arbitrary target category.,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/Topology/Sheaves/Forget.lean#L50-L53,Q27041,,6.9.2,lemma,3.0,"['0071', '006A', '0ELQ']","\n  Lemma 6.9.2. Suppose the category $\\mathcal{C}$ and the functor $F : \\mathcal{C} \\to \\textit{Sets}$ have the following properties: \n  \n  \n$F$ is faithful, \n\n\n$\\mathcal{C}$ has limits and $F$ commutes with them, and \n\n\nthe functor $F$ reflects isomorphisms. \n\n\n\n   Let $X$ be a topological space. Let $\\mathcal{F}$ be a presheaf with values in $\\mathcal{C}$. Then $\\mathcal{F}$ is a sheaf if and only if the underlying presheaf of sets is a sheaf. \n\n    \n      Proof.\n      Assume that $\\mathcal{F}$ is a sheaf. Then $\\mathcal{F}(U)$ is the equalizer of the diagram above and by assumption we see $F(\\mathcal{F}(U))$ is the equalizer of the corresponding diagram of sets. Hence $F(\\mathcal{F})$ is a sheaf of sets. \n    \n      Assume that $F(\\mathcal{F})$ is a sheaf. Let $E \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{C})$ be the equalizer of the two parallel arrows in Definition 6.9.1. We get a canonical morphism $\\mathcal{F}(U) \\to E$, simply because $\\mathcal{F}$ is a presheaf. By assumption, the induced map $F(\\mathcal{F}(U)) \\to F(E)$ is an isomorphism, because $F(E)$ is the equalizer of the corresponding diagram of sets. Hence we see $\\mathcal{F}(U) \\to E$ is an isomorphism by condition (3) of the lemma. \n      $\\square$\n    \n","\n  Lemma 6.9.2. Suppose the category $\\mathcal{C}$ and the functor $F : \\mathcal{C} \\to \\textit{Sets}$ have the following properties: \n  \n  \n$F$ is faithful, \n\n\n$\\mathcal{C}$ has limits and $F$ commutes with them, and \n\n\nthe functor $F$ reflects isomorphisms. \n\n\n\n   Let $X$ be a topological space. Let $\\mathcal{F}$ be a presheaf with values in $\\mathcal{C}$. Then $\\mathcal{F}$ is a sheaf if and only if the underlying presheaf of sets is a sheaf. \n\n    \n","Proof.\n      Assume that $\\mathcal{F}$ is a sheaf. Then $\\mathcal{F}(U)$ is the equalizer of the diagram above and by assumption we see $F(\\mathcal{F}(U))$ is the equalizer of the corresponding diagram of sets. Hence $F(\\mathcal{F})$ is a sheaf of sets. \n    \n      Assume that $F(\\mathcal{F})$ is a sheaf. Let $E \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{C})$ be the equalizer of the two parallel arrows in Definition 6.9.1. We get a canonical morphism $\\mathcal{F}(U) \\to E$, simply because $\\mathcal{F}$ is a presheaf. By assumption, the induced map $F(\\mathcal{F}(U)) \\to F(E)$ is an isomorphism, because $F(E)$ is the equalizer of the corresponding diagram of sets. Hence we see $\\mathcal{F}(U) \\to E$ is an isomorphism by condition (3) of the lemma. \n      $\\square$\n    \n","
  Presheaf.isSheaf_iff_isSheaf_comp _ F G
","theorem isSheaf_iff_isSheaf_comp' {C : Type uâ‚} [Category.{vâ‚} C] {D : Type uâ‚‚} [Category.{vâ‚‚} D]
    (G : C â¥¤ D) [G.ReflectsIsomorphisms] [HasLimitsOfSize.{v, v} C] [PreservesLimitsOfSize.{v, v} G]
    {X : TopCat.{v}} (F : Presheaf C X) : Presheaf.IsSheaf F â†” Presheaf.IsSheaf (F â‹™ G) ","Proof.\n      Assume that $\\mathcal{F}$ is a sheaf. Then $\\mathcal{F}(U)$ is the equalizer of the diagram above and by assumption we see $F(\\mathcal{F}(U))$ is the equalizer of the corresponding diagram of sets. Hence $F(\\mathcal{F})$ is a sheaf of sets. \n    \n      Assume that $F(\\mathcal{F})$ is a sheaf. Let $E \\in \\mathop{\\mathrm{Ob}}\\nolimits (\\mathcal{C})$ be the equalizer of the two parallel arrows in Definition 6.9.1 [[\n  Definition 6.9.1. Let $X$ be a topological space. Let $\\mathcal{C}$ be a category with products. A presheaf $\\mathcal{F}$ with values in $\\mathcal{C}$ on $X$ is a sheaf if for every open covering the diagram \n  \n  \\[  \\xymatrix{ \\mathcal{F}(U) \\ar[r] &  \\prod \\nolimits _{i\\in I} \\mathcal{F}(U_ i) \\ar@<1ex>[r] \\ar@<-1ex>[r] &  \\prod \\nolimits _{(i_0, i_1) \\in I \\times I} \\mathcal{F}(U_{i_0} \\cap U_{i_1}) }  \\]\n\n   is an equalizer diagram in the category $\\mathcal{C}$. \n]]. We get a canonical morphism $\\mathcal{F}(U) \\to E$, simply because $\\mathcal{F}$ is a presheaf. By assumption, the induced map $F(\\mathcal{F}(U)) \\to F(E)$ is an isomorphism, because $F(E)$ is the equalizer of the corresponding diagram of sets. Hence we see $\\mathcal{F}(U) \\to E$ is an isomorphism by condition (3) of the lemma. \n      $\\square$\n    \n"
391,08YG,"class SpectralSpace (X : Type*) [TopologicalSpace X] : Prop extends
  T0Space X, CompactSpace X, QuasiSober X, QuasiSeparatedSpace X, PrespectralSpace X
",Formal Proof of Stacks Project Tag 08YG,,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/Topology/Spectral/Basic.lean#L38-L39,Q27041,,5.23.1,definition,3.0,"['08YF', '004C', '0ELQ']","\n  Definition 5.23.1. A topological space $X$ is called spectral if it is sober, quasi-compact, the intersection of two quasi-compact opens is quasi-compact, and the collection of quasi-compact opens forms a basis for the topology. A continuous map $f : X \\to Y$ of spectral spaces is called spectral if the inverse image of a quasi-compact open is quasi-compact. \n","\n  Definition 5.23.1. A topological space $X$ is called spectral if it is sober, quasi-compact, the intersection of two quasi-compact opens is quasi-compact, and the collection of quasi-compact opens forms a basis for the topology. A continuous map $f : X \\to Y$ of spectral spaces is called spectral if the inverse image of a quasi-compact open is quasi-compact. \n",,,"class SpectralSpace (X : Type*) [TopologicalSpace X] : Prop extends
  T0Space X, CompactSpace X, QuasiSober X, QuasiSeparatedSpace X, PrespectralSpace X
",
392,005A,"structure IsSpectralMap (f : Î± â†’ Î²) : Prop extends Continuous f where
  /-- A function between topological spaces is spectral if it is continuous and the preimage of
  every compact open set is compact open. -/
  isCompact_preimage_of_isOpen â¦ƒs : Set Î²â¦„ : IsOpen s â†’ IsCompact s â†’ IsCompact (f â»Â¹' s)
",Formal Proof of Stacks Project Tag 005A, stacks 08YG,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/Topology/Spectral/Hom.lean#L43-L46,Q27041,,5.12.1,definition,3.0,"['0059', '004C', '0ELQ']",\n  Definition 5.12.1. Quasi-compactness. \n  \n  \nWe say that a topological space $X$ is quasi-compact if every open covering of $X$ has a finite subcover. \n\n\nWe say that a continuous map $f : X \\to Y$ is quasi-compact if the inverse image $f^{-1}(V)$ of every quasi-compact open $V \\subset Y$ is quasi-compact. \n\n\nWe say a subset $Z \\subset X$ is retrocompact if the inclusion map $Z \\to X$ is quasi-compact. \n\n\n\n,\n  Definition 5.12.1. Quasi-compactness. \n  \n  \nWe say that a topological space $X$ is quasi-compact if every open covering of $X$ has a finite subcover. \n\n\nWe say that a continuous map $f : X \\to Y$ is quasi-compact if the inverse image $f^{-1}(V)$ of every quasi-compact open $V \\subset Y$ is quasi-compact. \n\n\nWe say a subset $Z \\subset X$ is retrocompact if the inclusion map $Z \\to X$ is quasi-compact. \n\n\n\n,,,"structure IsSpectralMap (f : Î± â†’ Î²) : Prop extends Continuous f where
  /-- A function between topological spaces is spectral if it is continuous and the preimage of
  every compact open set is compact open. -/
  isCompact_preimage_of_isOpen â¦ƒs : Set Î²â¦„ : IsOpen s â†’ IsCompact s â†’ IsCompact (f â»Â¹' s)
",
393,08YG,"class PrespectralSpace (X : Type*) [TopologicalSpace X] : Prop where
  isTopologicalBasis : IsTopologicalBasis { U : Set X | IsOpen U âˆ§ IsCompact U }
",Formal Proof of Stacks Project Tag 08YG,"The last condition for spectral spaces, mk_iff",https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/Mathlib/Topology/Spectral/Prespectral.lean#L29-L30,Q27041,,5.23.1,definition,3.0,"['08YF', '004C', '0ELQ']","\n  Definition 5.23.1. A topological space $X$ is called spectral if it is sober, quasi-compact, the intersection of two quasi-compact opens is quasi-compact, and the collection of quasi-compact opens forms a basis for the topology. A continuous map $f : X \\to Y$ of spectral spaces is called spectral if the inverse image of a quasi-compact open is quasi-compact. \n","\n  Definition 5.23.1. A topological space $X$ is called spectral if it is sober, quasi-compact, the intersection of two quasi-compact opens is quasi-compact, and the collection of quasi-compact opens forms a basis for the topology. A continuous map $f : X \\to Y$ of spectral spaces is called spectral if the inverse image of a quasi-compact open is quasi-compact. \n",,,"class PrespectralSpace (X : Type*) [TopologicalSpace X] : Prop where
  isTopologicalBasis : IsTopologicalBasis { U : Set X | IsOpen U âˆ§ IsCompact U }
",
395,0BR2,"example : True := .intro
",Formal Proof of Stacks Project Tag 0BR2, kerodon 0X12,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/MathlibTest/StacksAttribute.lean#L26-L26,Q27041,,5.30.5,definition,3.0,"['0B1Y', '004C', '0ELQ']",\n  Definition 5.30.5. A topological group is called a profinite group if it satisfies the equivalent conditions of Lemma 5.30.4. \n,\n  Definition 5.30.5. A topological group is called a profinite group if it satisfies the equivalent conditions of Lemma 5.30.4. \n,," .intro
",example : True ,
396,0BR2,"example : True := .intro
",Formal Proof of Stacks Project Tag 0BR2, stacks 0X14 I can also have a comment,https://github.com/leanprover-community/mathlib4/tree/ed96f50f75b1f89c4561f2ba2d837eb169052094/MathlibTest/StacksAttribute.lean#L35-L35,Q27041,,5.30.5,definition,3.0,"['0B1Y', '004C', '0ELQ']",\n  Definition 5.30.5. A topological group is called a profinite group if it satisfies the equivalent conditions of Lemma 5.30.4. \n,\n  Definition 5.30.5. A topological group is called a profinite group if it satisfies the equivalent conditions of Lemma 5.30.4. \n,," .intro
",example : True ,
